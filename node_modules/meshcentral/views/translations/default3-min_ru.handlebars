<!doctypehtml><html lang=ru dir=ltr xmlns=http://www.w3.org/1999/xhtml><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Content-Type content="text/html;charset=utf-8"><meta name=viewport content="user-scalable=1,initial-scale=1,minimum-scale=1,maximum-scale=1"><meta name=apple-mobile-web-app-capable content=yes><meta name=format-detection content="telephone=no"><meta name=robots content=noindex,nofollow><link rel=manifest href={{{domainurl}}}manifest.json><link type=image/x-icon href={{{domainurl}}}favicon.ico rel="shortcut icon"><link keeplink=1 type=text/css href=styles/style-bootstrap.css media=screen rel=stylesheet title=CSS><link type=text/css href=styles/ol.css media=screen rel=stylesheet title=CSS><link type=text/css href=styles/ol3-contextmenu.min.css media=screen rel=stylesheet title=CSS><link type=text/css href=styles/xterm.css media=screen rel=stylesheet title=CSS><link type=text/css href=styles/flatpickr.min.css media=screen rel=stylesheet title=CSS><link id=theme-stylesheet href=styles/bootstrap{{{min}}}.css rel=stylesheet title=CSS><link href=styles/select2.min.css rel=stylesheet title=CSS><link href=styles/select2-bootstrap-5-theme.min.css rel=stylesheet title=CSS><link type=text/css href=styles/custom.css media=screen rel=stylesheet title=CSS><link rel=apple-touch-icon href=/favicon-303x303.png><script src=scripts/common-0.0.1{{{min}}}.js></script><script src=scripts/meshcentral{{{min}}}.js></script><script src=scripts/amt-0.2.0{{{min}}}.js></script><script src=scripts/amt-wsman-0.2.0{{{min}}}.js></script><script src=scripts/amt-desktop-0.0.2{{{min}}}.js></script><script src=scripts/amt-terminal-0.0.2{{{min}}}.js></script><script src=scripts/zlib{{{min}}}.js></script><script src=scripts/zlib-inflate{{{min}}}.js></script><script src=scripts/zlib-adler32{{{min}}}.js></script><script src=scripts/zlib-crc32{{{min}}}.js></script><script src=scripts/amt-redir-ws-0.1.0{{{min}}}.js></script><script src=scripts/amt-wsman-ws-0.2.0{{{min}}}.js></script><script src=scripts/agent-redir-ws-0.1.1{{{min}}}.js></script><script src=scripts/agent-redir-rtc-0.1.0{{{min}}}.js></script><script src=scripts/agent-desktop-0.0.2{{{min}}}.js></script><script src=scripts/agent-rdp-0.0.1{{{min}}}.js></script><script src=scripts/qrcode.min.js></script><script src=scripts/xterm{{{min}}}.js></script><script src=scripts/xterm-addon-fit{{{min}}}.js></script><script src=scripts/flatpickr.js></script><script src=mstsc/mstsc.js></script><script src=mstsc/keyboard.js></script><script src=mstsc/rle.js></script><script src=mstsc/client.js></script><script src=mstsc/canvas.js></script><script src=scripts/jquery{{{min}}}.js></script><script src=scripts/bootstrap{{{min}}}.js></script><script src=scripts/fontawesome/all.min.js></script><script src=scripts/select2.full.min.js></script><script src=scripts/themes/theme-switcher.js></script><script keeplink=1 src=scripts/u2f-api{{{min}}}.js></script><script keeplink=1 src=scripts/charts{{{min}}}.js></script><script keeplink=1 src=scripts/moment{{min}}.js></script><script keeplink=1 src=scripts/chartjs-adapter-moment{{{min}}}.js></script><script keeplink=1 src=scripts/filesaver.min.js></script><script keeplink=1 src=scripts/ol{{{min}}}.js></script><script keeplink=1 src=scripts/ol3-contextmenu{{{min}}}.js></script><script keeplink=1 src=scripts/purify{{{min}}}.js></script><script keeplink=1 src=scripts/marked{{{min}}}.js></script><title>{{{title}}}</title><body id=body oncontextmenu=handleContextMenu(event) style=display:none;min-width:495px onload='"undefined"!=typeof startup&&startup()'><div id=contextMenu class="contextMenu noselect"style=display:none><div id=cxinfo class=cmtext onclick=cmaction(1,event)><b>Информация</b></div><div id=cxdesktop class=cmtext onclick=cmaction(3,event)>Рабочий стол</div><div id=cxterminal class=cmtext onclick=cmaction(2,event)>Терминал</div><div id=cxfiles class=cmtext onclick=cmaction(4,event)>Файлы</div><div id=cxevents class=cmtext onclick=cmaction(5,event)>События</div><div id=cxdetails class=cmtext onclick=cmaction(6,event)>Детали</div><div id=cxconsole class=cmtext onclick=cmaction(7,event)>Консоль</div><div id=cxwebrdp class=cmtext onclick=cmaction(11,event)>Web-RDP</div><div id=cxwebvnc class=cmtext onclick=cmaction(12,event)>Web-VNC</div><div id=cxwebssh class=cmtext onclick=cmaction(13,event)>Web-SSH</div><div id=cxrdp class=cmtext onclick=cmaction(14,event)>RDP</div><div id=cxplugins class=cmtext onclick=cmaction(8,event) style=display:none>Плагины</div><hr id=cxmgroupsplit><div id=cxstar class=cmtext onclick=cmaction(10,event) style=display:none>Доб/удал звезду</div><div id=cxmdesktop class=cmtext onclick=cmaction(9,event) style=display:none>Многоэкранный</div></div><div id=meshContextMenu class="contextMenu noselect"style=display:none;min-width:0><div id=cxselectall class=cmtext onclick=cmmeshaction(1,event)>Выбрать все</div><div id=cxselectnone class=cmtext onclick=cmmeshaction(2,event)>Очистить все</div></div><div id=altPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmaltportaction(1,event)>Поменять порт</div></div><div id=sshPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmsshportaction(1,event)>Поменять порт</div></div><div id=rfbPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmrfbportaction(1,event)>Поменять порт</div></div><div id=httpPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmhttpportaction(1,event)>Поменять порт</div></div><div id=httpsPortContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmhttpsportaction(1,event)>Поменять порт</div></div><div id=filesContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmfilesaction(1,event)>Переименовать</div><div class=cmtext onclick=cmfilesaction(2,event)>Редактировать</div><div class=cmtext onclick=cmfilesaction(3,event)>Удалить</div></div><div id=expandAllContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmexpandaction(1,event)>Развернуть все</div><div class=cmtext onclick=cmexpandaction(2,event)>Свернуть все</div></div><div id=deskPlayerContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmdeskplayeraction(1,event)>Открыть плеер ...</div></div><div id=deskKeyShortcutContextMenu class="contextMenu noselect"style=display:none;min-width:0><div class=cmtext onclick=cmdeskshortcutaction(1,event)>Настроить...</div></div><div id=deskPreConfigShortcutContextMenu class="contextMenu noselect"style="display:none;min-width:0;max-height:calc(80% - 50px);overflow-y:auto"><span id=deskPreConfigShortcutContextMenu1></span> <span id=deskPreConfigShortcutContextMenu2></span><div class=cmtext onclick=cmdeskpreconfigtypeaction(-1,event)>Настроить...</div></div><div id=deskPreConfigScriptContextMenu class="contextMenu noselect"style="display:none;min-width:0;max-height:calc(80% - 50px);overflow-y:auto"><span id=deskPreConfigScriptContextMenu1></span> <span id=deskPreConfigScriptContextMenu2></span></div><div id=container><div id=notifiyBox class=notifiyBox style=display:none></div><div id=masthead class=noselect><div style=float:left>{{{titlehtml}}}</div><div class=title onclick=go(1,event)>{{{title1}}}</div><div class=title2>{{{title2}}}</div><div style=float:right><div id=notificationCount onclick=clickNotificationIcon() class=unselectable style=display:none title="Нажмите для просмотра текущий уведомлений">0</div></div><p id=logoutControl><span id=logoutControlSpan class=logoncontrolspan></span><span id=idleTimeoutNotify style=color:#ff0></span></p><img id=topMenuIcon class=noselect style=position:absolute;right:0;top:10px;color:#c8c8c8;font-size:44px;margin-right:8px;cursor:pointer;display:none onclick=topMenu() src=/images/3bars-30.png width=30 height=30><div class=textnewui id=textnewui onmouseup=toggleBootstrapUIMode() onkeypress='"Enter"==event.key&&toggleBootstrapUIMode()'><b>Попробуйте новый сетчатый пользовательский интерфейс</b></div></div><div class="sidebar flex-column"id=page_leftbar><div style=height:24px></div><nav class="nav flex-column"><a class="nav-link active text-center text-white lbbuttonsel"id=LeftMenuMyDevices href=# data-target=general onmouseup=go(1,event) onkeypress='"Enter"==event.key&&go(1)'><i class="fa-solid fa-computer me-2"></i></a> <a class="nav-link text-center text-white"id=LeftMenuMyAccount href=# data-target=account onmouseup=go(2,event) onkeypress='"Enter"==event.key&&go(2)'><i class="fa-solid fa-user-gear me-2"></i></a> <a class="nav-link text-center text-white"id=LeftMenuMyEvents href=# data-target=events onmouseup=go(3,event) onkeypress='"Enter"==event.key&&go(3)'><i class="fa-solid fa-calendar-alt me-2"></i></a> <a class="nav-link text-center text-white"id=LeftMenuMyFiles href=# data-target=files onmouseup=go(5,event) onkeypress='"Enter"==event.key&&go(5)'><i class="fa-solid fa-folder-open me-2"></i></a> <a class="nav-link text-center text-white"id=LeftMenuMyUsers href=# data-target=users onmouseup=go(4,event) onkeypress='"Enter"==event.key&&go(4)'><i class="fa-solid fa-users me-2"></i></a> <a class="nav-link text-center text-white"id=LeftMenuMyServer href=# data-target=server onmouseup=go(6,event) onkeypress='"Enter"==event.key&&go(6)'><i class="fa-solid fa-server me-2"></i></a></nav></div><div id=topbar class=noselect><div><div style=position:relative><span id=logoutControlSpan2></span><div tabindex=0 id=uiMenuButton title="Выбор пользовательского интерфейса"onclick=showUserInterfaceSelectMenu() onkeypress='"Enter"==event.key&&showUserInterfaceSelectMenu()'>♦<div id=uiMenu style=display:none><table><tr><td><div tabindex=0 id=uiViewButton1 class=uiSelector onclick=userInterfaceSelectMenu(1) title="Панель инструментов слева"onkeypress='"Enter"==event.key&&userInterfaceSelectMenu(1)'><div class=uiSelector1></div></div><div tabindex=0 id=uiViewButton2 class=uiSelector onclick=userInterfaceSelectMenu(2) title="Панель инструментов сверху"onkeypress='"Enter"==event.key&&userInterfaceSelectMenu(2)'><div class=uiSelector2></div></div><div tabindex=0 id=uiViewButton3 class=uiSelector onclick=userInterfaceSelectMenu(3) title="Интерфейс с фиксированной шириной"onkeypress='"Enter"==event.key&&userInterfaceSelectMenu(3)'><div class=uiSelector3></div></div><div tabindex=0 id=uiViewButton7 class=uiSelector onclick=toggleBootstrapUIMode() title="Toggle Modern UI"onkeypress='"Enter"==event.key&&toggleBootstrapUIMode()'><div class=uiSelector7></div></div><td><div tabindex=0 id=uiViewButton6 class=uiSelector onclick=showNotes(!1) title="Личные заметки"onkeypress='"Enter"==event.key&&showNotes(!1)'><div class=uiSelector6></div></div><div tabindex=0 id=uiViewButton4 class=uiSelector onclick=toggleNightMode() title="Переключить ночной режим"onkeypress='"Enter"==event.key&&toggleNightMode()'><div class=uiSelector4></div></div><div tabindex=0 id=uiViewButton5 class=uiSelector onclick=toggleFooterBarMode() title="Переключить нижнюю панель"onkeypress='"Enter"==event.key&&toggleFooterBarMode()'><div class=uiSelector5></div></div><div class=uiSelector_end>&nbsp;</div></table></div></div><table id=MainMenuSpan cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=MainMenuMyDevices class="topbar_td style3x"onmouseup=go(1,event) onkeypress='"Enter"==event.key&&go(1)'>Мои устройства<td tabindex=0 id=MainMenuMyAccount class="topbar_td style3x"onmouseup=go(2,event) onkeypress='"Enter"==event.key&&go(2)'>Моя учетная запись<td tabindex=0 id=MainMenuMyEvents class="topbar_td style3x"onmouseup=go(3,event) onkeypress='"Enter"==event.key&&go(3)'>Мои события<td tabindex=0 id=MainMenuMyFiles class="topbar_td style3x"onmouseup=go(5,event) onkeypress='"Enter"==event.key&&go(5)'>Мои файлы<td tabindex=0 id=MainMenuMyUsers class="topbar_td style3x"onmouseup=go(4,event) onkeypress='"Enter"==event.key&&go(4)'>Мои пользователи<td tabindex=0 id=MainMenuMyServer class="topbar_td style3x"onmouseup=go(6,event) onkeypress='"Enter"==event.key&&go(6)'>Мой сервер<td class="topbar_td_end style3">&nbsp;</table><div id=MainSubMenuSpan style=display:none><table id=MainSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=MainDev class="topbar_td style3x"onmouseup=go(10,event) onkeypress='"Enter"==event.key&&go(10)'>Сводка<td tabindex=0 id=MainDevDesktop class="topbar_td style3x"onmouseup=go(11,event) onkeypress='"Enter"==event.key&&go(11)'>Рабочий стол<td tabindex=0 id=MainDevTerminal class="topbar_td style3x"onmouseup=go(12,event) onkeypress='"Enter"==event.key&&go(12)'>Терминал<td tabindex=0 id=MainDevFiles class="topbar_td style3x"onmouseup=go(13,event) onkeypress='"Enter"==event.key&&go(13)'>Файлы<td tabindex=0 id=MainDevEvents class="topbar_td style3x"onmouseup=go(16,event) onkeypress='"Enter"==event.key&&go(16)'>События<td tabindex=0 id=MainDevInfo class="topbar_td style3x"onmouseup=go(17,event) onkeypress='"Enter"==event.key&&go(17)'>Детали<td tabindex=0 id=MainDevAmt class="topbar_td style3x"onmouseup=go(14,event) onkeypress='"Enter"==event.key&&go(14)'>Intel®AMT<td tabindex=0 id=MainDevConsole class="topbar_td style3x"onmouseup=go(15,event) onkeypress='"Enter"==event.key&&go(15)'>Консоль<td tabindex=0 id=MainDevPlugins class="topbar_td style3x"onmouseup=go(19,event) onkeypress='"Enter"==event.key&&go(19)'>Плагины<td class="topbar_td_end style3">&nbsp;</table></div><div id=MeshSubMenuSpan style=display:none><table id=MeshSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=MeshGeneral class="topbar_td style3x"onmouseup=go(20,event) onkeypress='"Enter"==event.key&&go(20)'>Сводка<td tabindex=0 id=MeshSummary class="topbar_td style3x"onmouseup=go(21,event) onkeypress='"Enter"==event.key&&go(21)'>Резюме<td class="topbar_td_end style3">&nbsp;</table></div><div id=EventsSubMenuSpan style=display:none><div id=EventsSubMenu class=style1><div class="row d-flex"><div class="col flex-grow-0 flex-shrink-0"><div tabindex=0 id=EventsLive class="topbar_td style3x"onmouseup=go(3,event) onkeypress='"Enter"==event.key&&go(3)'>События</div></div><div class="col flex-grow-0 flex-shrink-0"><div tabindex=0 id=EventsReport class="topbar_td style3x"onmouseup=go(60,event) onkeypress='"Enter"==event.key&&go(60)'>Отчеты</div></div><div class="col flex-grow-0 flex-shrink-0"><div class=style3>&nbsp;</div></div></div></div></div><div id=UserSubMenuSpan style=display:none><table id=UserSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=UserGeneral class="topbar_td style3x"onmouseup=go(30,event) onkeypress='"Enter"==event.key&&go(30)'>Сводка<td tabindex=0 id=UserEvents class="topbar_td style3x"onmouseup=go(31,event) onkeypress='"Enter"==event.key&&go(31)'>События<td class="topbar_td_end style3">&nbsp;</table></div><div id=UsersSubMenuSpan style=display:none><table id=UsersSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=UsersGeneral class="topbar_td style3x"onmouseup=go(4,event) onkeypress='"Enter"==event.key&&go(4)'>Пользователи<td tabindex=0 id=UsersGroups class="topbar_td style3x"onmouseup=go(50,event) onkeypress='"Enter"==event.key&&go(50)'>Группы<td tabindex=0 id=UsersRecordings class="topbar_td style3x"onmouseup=go(52,event) onkeypress='"Enter"==event.key&&go(52)'>Записи<td class="topbar_td_end style3">&nbsp;</table></div><div id=ServerSubMenuSpan style=display:none><table id=ServerSubMenu cellpadding=0 cellspacing=0 class=style1><tr><td tabindex=0 id=ServerGeneral class="topbar_td style3x"onmouseup=go(6,event) onkeypress='"Enter"==event.key&&go(6)'>Сводка<td tabindex=0 id=ServerStats class="topbar_td style3x"onmouseup=go(40,event) onkeypress='"Enter"==event.key&&go(40)'>Статистика<td tabindex=0 id=ServerConsole class="topbar_td style3x"onmouseup=go(115,event) onkeypress='"Enter"==event.key&&go(115)'>Консоль<td tabindex=0 id=ServerTrace class="topbar_td style3x"onmouseup=go(41,event) onkeypress='"Enter"==event.key&&go(41)'>Трассировка<td tabindex=0 id=ServerPlugins class="topbar_td style3x"onmouseup=go(42,event) onkeypress='"Enter"==event.key&&go(42)'>Плагины<td class="topbar_td_end style3">&nbsp;</table></div><div id=UserDummyMenuSpan><table id=UserDummyMenu cellpadding=0 cellspacing=0 class=style1><tr><td class=style3>&nbsp;</table></div></div></div></div><div id=column_l class=pt-3><div id=p0 style=display:none><div id=p0message><span id=p0span>Сервер отключен</span>,<href onclick=reload() style=cursor:pointer><u>нажмите для переподключения</u></href>.</div></div><div id=p1 style=display:none><div id=p1title class="d-flex justify-content-between align-items-center"><div><h1>Мои устройства</h1></div><div style=display:none id=devListToolbarViewIcons><div id=devViewPageState style=float:left;line-height:32px;height:32px;font-size:16px;display:none></div><div tabindex=0 id=devViewPageButton1 class=viewSelector onclick=onDeviceViewPageChange(1) onkeypress='"Enter"==event.key&&onDeviceViewPageChange(1)'title="Go to first page"style=display:none><div class=viewSelector9></div></div><div tabindex=0 id=devViewPageButton2 class=viewSelector onclick=onDeviceViewPageChange(2) onkeypress='"Enter"==event.key&&onDeviceViewPageChange(2)'title="Go to previous page"style=display:none><div class=viewSelector10></div></div><div tabindex=0 id=devViewPageButton3 class=viewSelector onclick=onDeviceViewPageChange(3) onkeypress='"Enter"==event.key&&onDeviceViewPageChange(3)'title="Go to next page"style=display:none><div class=viewSelector11></div></div><div tabindex=0 id=devViewPageButton4 class=viewSelector onclick=onDeviceViewPageChange(4) onkeypress='"Enter"==event.key&&onDeviceViewPageChange(4)'title="Go to last page"style=display:none;margin-right:12px><div class=viewSelector8></div></div><span role=button tabindex=0 id=devViewButton1 class="fa-layers fa-fw fa-xl"onclick=onDeviceViewChange(1) onkeypress='"Enter"==event.key&&onDeviceViewChange(1)'title=Колонки><i class="fa-solid fa-bars"data-fa-transform="shrink-8 right-4 up-2"></i> <i class="fa-solid fa-bars"data-fa-transform="shrink-8 left-4 up-2"></i> <i class="fa-solid fa-bars"data-fa-transform="shrink-8 right-4 down-3"></i> <i class="fa-solid fa-bars"data-fa-transform="shrink-8 left-4 down-3"></i> </span><span role=button tabindex=0 id=devViewButton2 class="fa-layers fa-fw fa-xl"onclick=onDeviceViewChange(2) onkeypress='"Enter"==event.key&&onDeviceViewChange(2)'title=Список><i class="fa-solid fa-bars"></i> </span><span role=button tabindex=0 id=devViewButton3 class="fa-layers fa-fw fa-xl"onclick=onDeviceViewChange(3) onkeypress='"Enter"==event.key&&onDeviceViewChange(3)'title=Экраны><i class="fa-solid fa-square"data-fa-transform="shrink-9 up-4 left-4"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-9 up-4 right-4"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-9 down-4 left-4"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-9 down-4 right-4"></i> </span><span role=button tabindex=0 id=devViewButton5 class="fa-layers fa-fw fa-xl"onclick=onDeviceViewChange(5) onkeypress='"Enter"==event.key&&onDeviceViewChange(5)'title=Экраны><i class="fa-solid fa-square"data-fa-transform="shrink-10 up-4 left-6"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-10 up-4 right-1"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-10 up-4 right-5"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-10 down-4 left-1"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-10 down-4 left-5"></i> <i class="fa-solid fa-square"data-fa-transform="shrink-10 down-4 right-6"></i> </span><span role=button tabindex=0 id=devViewButton4 class="fa-layers fa-fw fa-xl"onclick=onDeviceViewChange(4) onkeypress='"Enter"==event.key&&onDeviceViewChange(4)'title=Карта style=display:none><i class="fa-solid fa-map-location-dot"></i></span></div></div><div id=devListToolbarSpan class="noselect d-flex align-items-center p-1"><div id=devListToolbar class="d-flex align-items-center visually-hidden"><span class="fa-layers fa-fw me-1"role=button style=display:none title="Свернуть все"id=CollapseAllButton onclick=cmexpandaction(2)><i class="fa-solid fa-chevron-up"data-fa-transform=down-6></i> <i class="fa-solid fa-chevron-down"data-fa-transform=up-6></i> </span><span class="fa-layers fa-fw me-1"role=button style=display:none title="Развернуть все"id=ExpandAllButton onclick=cmexpandaction(1)><i class="fa-solid fa-chevron-up"data-fa-transform=up-6></i> <i class="fa-solid fa-chevron-down"data-fa-transform=down-6></i> </span><input type=button class="btn btn-primary me-1 btn-sm"id=SelectAllButton onclick=selectallButtonFunction() value="Выбрать все"> <input type=button class="btn btn-primary me-1 btn-sm"id=GroupActionButton disabled value="Групповое действие"onclick=groupActionFunction()> <input type=button class="btn btn-primary me-1 btn-sm"id=ScrollToTopButton onclick=onDevicesScroll(!0) value="Scroll To Top"> <input id=SearchInput class="form-control-sm me-1 btn-sm"placeholder=Фильтр onchange=onDeviceSearchChanged(event) onclick=onDeviceSearchChanged(event) onkeyup=onDeviceSearchChanged(event) onfocus=onSearchFocus(1) onblur=onSearchFocus(0) title="Фильтр: user:xxx or u:xxx ip:xxx group:xxx or g:xxx tag:xxx or t: xxx atag:xxx or a:xxx os:xxx amt:xxx desc:xxx wsc:ok wsc:noav wsc:noupdate wsc:nofirewall wsc:any connectivity:xxx c:xxx"> <span id=SearchInputClearButton style=display:none;position:relative><span class="fa-layers fa-fw"role=button onclick=clearDeviceSearch() style=position:absolute;left:-25px;top:-15px><i class="fa-solid fa-circle"style=color:var(--bs-secondary-bg)></i> <i class="fa-solid fa-xmark"style=color:var(--bs-body-color)></i> </span></span><select class="form-select-sm me-1"id=DevFilterSelect onchange=onOnlineCheckBox(event) title="Фильтр устройств"><option value=0 selected>Все<option value=1>В сети<option value=5>Не в сети<option value=2>Сессии<option value=3>Звезда<option value=4>Intel® AMT<option value=6>Помощь<option value=7>Есть теги<option value=8>Без тегов</select><div class=form-check title="Показывать имя устройства, заданное в настройках операционной системы"><input class="form-check-input me-1"type=checkbox id=RealNameCheckBox onclick=onRealNameCheckBox()><label class=form-check-label for=RealNameCheckBox>Имя из ОС</label></div><label style=display:none><input type=checkbox id=OnlineCheckBox class="form-check-input me-2"onclick=onOnlineCheckBox(event)><span title="Показывать только устройства, которые подключены к сети">В сети</span></label> <span id=devsCustomUIBar></span></div><div id=kvmListToolbar class="d-flex align-items-center style14 visually-hidden"><span class="fa-layers fa-fw me-1"role=button style=display:none title="Свернуть все"id=CollapseAllButton2 onclick=cmexpandaction(2)><i class="fa-solid fa-chevron-up"data-fa-transform=down-6></i> <i class="fa-solid fa-chevron-down"data-fa-transform=up-6></i> </span><span class="fa-layers fa-fw me-1"role=button style=display:none title="Развернуть все"id=ExpandAllButton2 onclick=cmexpandaction(1)><i class="fa-solid fa-chevron-up"data-fa-transform=up-6></i> <i class="fa-solid fa-chevron-down"data-fa-transform=down-6></i> </span><input type=button class="btn btn-primary me-1 btn-sm"onclick=connectAllKvmFunction() value="Подключиться ко всем"> <input type=button class="btn btn-primary me-1 btn-sm"onclick=disconnectAllKvmFunction() value="Разъединить все"> <input type=button class="btn btn-primary me-1 btn-sm"onclick=onDevicesScroll(!0) value="Scroll To Top"><div class="form-check me-1"title="Автоматическое подключение"><input class="form-check-input me-1"type=checkbox id=autoConnectDesktopCheckbox onclick=autoConnectDesktops(event)><label class=form-check-label for=autoConnectDesktopCheckbox>Автоматически</label></div><input type=button class="btn btn-primary me-1 btn-sm"onclick=showMultiDesktopSettings() value=Настройки> <input id=KvmSearchInput class="form-control-sm me-1"placeholder=Фильтр onchange=onDeviceSearchChanged(event) onclick=onDeviceSearchChanged(event) onkeyup=onDeviceSearchChanged(event) onfocus=onSearchFocus(1) onblur=onSearchFocus(0) title="Фильтр: user:xxx or u:xxx ip:xxx group:xxx or g:xxx tag:xxx or t: xxx atag:xxx or a:xxx os:xxx amt:xxx desc:xxx wsc:ok wsc:noav wsc:noupdate wsc:nofirewall wsc:any connectivity:xxx c:xxx"> <span id=KvmSearchInputClearButton style=display:none;position:relative><span class="fa-layers fa-fw"role=button onclick=clearDeviceSearch() style=position:absolute;left:-25px;top:-15px><i class="fa-solid fa-circle"style=color:var(--bs-secondary-bg)></i> <i class="fa-solid fa-xmark"style=color:var(--bs-body-color)></i></span></span></div><div id=devMapToolbar class="d-flex align-items-center style14 visually-hidden"><input class="form-control-sm me-1"type=search id=mapSearchLocation placeholder="Поиск местоположения"onfocus=onMapSearchFocus(1) onblur=onMapSearchFocus(0)> <input class="btn btn-primary me-1 btn-sm"type=button value=Поиск title="Поиск местоположения"onclick=getSearchLocation()> <input class="btn btn-primary me-1 btn-sm"type=button id=refreshmap title="Сбросить вид карты"value=Перезагрузить onclick=refreshMap(!1,!0)></div><div class="d-flex align-items-center ms-auto"><div style=display:none id=devListToolbarView>Вид <select id=viewselect onchange=onDeviceViewChange()><option value=1>Колонки<option value=2>Список<option value=3>Экраны фиксированной ширины<option id=viewselectmapoption value=4 style=display:none>Карта<option value=5>Экраны</select></div><div style=display:none id=devListToolbarSize>Размер <select id=sizeselect class="form-select-sm me-2"onchange=onDeviceViewChange()><option value=0>Малый<option value=1>Средний<option value=2>Большой</select> &nbsp;</div><div style=display:none id=devListToolbarSort>Сортировка <select id=sortselect class="form-select-sm me-2"onchange=mainUpdate(6)><option>Группа<option>Питание<option>Устройство<option>Теги<option>Группа и теги<option>Последний визит</select> &nbsp;</div><i class="fa-solid fa-gear"role=button id=devListToolbarSettings onclick=onDeviceViewSettings()></i></div></div><div id=NoMeshesPanel style=display:none><table><tr><td valign=top style=width:50px><img src=images/info.png loading=lazy width=47 height=48><td><div id=getStarted1>Для начала, <a href=# onclick="return account_createMesh()"><strong>для создания группы устройств нажмите сюда</strong></a>.</div><div id=getStarted2>Нет групп устройств.</div></table></div><div id=xdevices class=noselect style=display:none onscroll=onDevicesScroll(!1)></div><div id=xdevicesmap style=display:none><div id=xmapSearchResultsDlg style=display:none><div id=xmapSearchResultsBck><div id=xmapSearchClose onclick=mapCloseSearchWindow()><b>X</b></div><div style=padding:5px>Результаты местонахождения</div><div style=width:100%;margin:6px></div></div><div id=xmapSearchResults style=margin:6px></div></div></div><div id=xmap-info-window></div></div><div id=p2 style=display:none><div id=p2title><h1>Моя учетная запись</h1></div><div id=p2info style=overflow-y:auto><div id=p2AccountImageFrame><img id=p2AccountImage alt=""loading=lazy width=128 height=128 onclick=account_manageImage(0) src=images/user-256.png><div><a href=# onclick=account_manageImage(0)>Сменить изображение</a></div></div><div id=p2AccountSecurity style=display:none><p><strong>Безопасность учетной записи</strong><div style=margin-left:25px><div id=managePhoneNumber1><div class=p2AccountActions><span id=authPhoneNumberCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_managePhone()">Управление номером телефона</a><br></span></div><div id=manageEmail2FA><div class=p2AccountActions><span id=authEmailSetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageAuthEmail()">Управление аутентификацией электронной почты</a><br></span></div><div id=manageAuthApp><div class=p2AccountActions><span id=authAppSetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageAuthApp()">Управление приложением для проверки подлинности</a><br></span></div><div id=manageDuoApp><div class=p2AccountActions><span id=authDuoSetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageAuthDuo()">Manage Duo authentication</a><br></span></div><div id=manageHardwareOtp><div class=p2AccountActions><span id=authKeySetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageHardwareOtp(0)">Управление ключами безопасности</a><br></span></div><div id=managePushAuthDev><div class=p2AccountActions><span id=authPushAuthDevCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_managePushAuthDev()">Управление push-аутентификацией</a><br></span></div><div id=manageMessaging1><div class=p2AccountActions><span id=authMessagingCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageMessaging()">Manage messaging</a><br></span></div><div id=manageOtp><div class=p2AccountActions><span id=authCodesSetupCheck><strong>✓</strong></span></div><span><a href=# onclick="return account_manageOtp(0)">Управление резервными кодами</a><br></span></div><div class=p2AccountActions></div><span><a href=# onclick="return account_viewPreviousLogins()">Посмотреть предыдущие входы в систему</a><br></span></div></div><div id=p2AccountActions><p><strong>Действия учетной записи</strong><p class=mL><span id=managePhoneNumber2 style=display:none><a href=# onclick="return account_managePhone()">Управление номером телефона</a><br></span><span id=manageMessaging2 style=display:none><a href=# onclick="return account_manageMessaging()">Manage messaging</a><br></span><span id=verifyEmailId style=display:none><a href=# onclick="return account_showVerifyEmail()">Подтвердить email</a><br></span><span id=accountEnableNotificationsSpan style=display:none><a href=# onclick="return account_enableNotifications()">Включить веб уведомления</a><br></span><a href=# onclick="return account_showLocalizationSettings()">Настройки локализации</a><br><a href=# onclick="return account_showAccountNotifySettings()">Настройки уведомлений</a><br><span id=p2AccountPassActions><span id=accountChangeEmailAddressSpan style=display:none><a href=# onclick="return account_showChangeEmail()">Смена email</a><br></span><a href=# onclick="return account_showChangePassword()">Смена пароля</a><span id=p2nextPasswordUpdateTime></span><br><a href=# onclick="return account_showDeleteAccount()">Удалить учетную запись</a><br></span><span id=accountCreateLoginTokenSpan style=display:none><a href=# onclick="return account_createLoginToken()">Создать токен входа</a><br></span><a href=# onclick="return account_showThemesSwitcher()">Сменить тему</a><br></p><br style=clear:both></div><div id=p2logintokens></div><strong>Группы устройств</strong> <span id=p2createMeshLink1>- <button class="btn btn-primary btn-sm"onclick="return account_createMesh()"><i class="fa-fw fa-solid fa-circle-plus"></i> Создать</button></span><br><br><div id=p2meshes></div><div id=p2noMeshFound style=display:none>Нет групп устройств.<span id=p2createMeshLink2> <a href=# onclick="return account_createMesh()"><strong>Начните здесь!</strong></a></span></div><br style=clear:both></div></div><div id=p3 style=display:none><div id=p3title><h1>Мои события</h1></div><table class=pTable><tr><td class="auto-style1 d-flex justify-content-end p-1"><div class="d-flex align-items-center"><label for=p3filterevents class=me-1>Фильтр</label> <select id=p3filterevents class="form-select-sm me-2"onchange=refreshEvents()><option notransval=1 value="">All Logs<option notransval=1 value=agentlog>Agent Logs<option notransval=1 value=relaylog>Relay Logs<option notransval=1 value=manual>Manual Logs<option notransval=1 value=runcommands>Run Command Logs<option notransval=1 value=batchupload>Batch Upload Logs<option notransval=1 value=changenode>Change Node Logs<option notransval=1 value=removenode>Remove Node Logs</select> <label for=p3limitdropdown class=me-1>Показать</label> <select id=p3limitdropdown class="form-select-sm me-2"onchange=refreshEvents()><option notransval=1 value=60>Последние 60<option notransval=1 value=120>Последние 120<option notransval=1 value=250>Последние 250<option notransval=1 value=500>Последние 500<option notransval=1 value=1000>Последние 1000<option notransval=1 value="">Нет ограничений</select> <a href=# onclick=p3showDownloadEventsDialog(2)><i class="fa-solid fa-download"title="Скачать события"></i></a></div></table><div id=p3events></div></div><div id=p4 style=display:none><div id=p4title><h1>Мои пользователи</h1></div><table class=pTable><tr><td class="style14 d-flex align-items-center flex-wrap p-1"><div class="d-flex align-items-center"><input type=button id=UsersSelectAllButton class="btn btn-primary btn-sm me-1"onclick=p3usersSelectallButtonFunction() value="Выбрать все"> <input type=button id=UsersGroupActionButton class="btn btn-primary btn-sm me-1"disabled value="Групповое действие"onclick=p3usersGroupActionFunction()> <input id=UserNewAccountButton class="btn btn-primary btn-sm me-1"type=button onclick=showCreateNewAccountDialog() value="Создать учетную запись..."><div class="d-inline-flex align-items-center"><input id=UserSearchInput type=search class="form-control-sm me-1"placeholder=Фильтр onchange=onUserSearchInputChanged() onkeyup=onUserSearchInputChanged() autocomplete=off onfocus=onUserSearchFocus(1) onblur=onUserSearchFocus(0)></div></div><div class="d-flex align-items-center ms-auto"><input type=button class="btn btn-primary btn-sm me-2"onclick=showUserBroadcastDialog() style=margin-right:6px value="Отправить сообщение"> <a href=# onclick=p4downloadUserInfo()><i role=button class="fa-solid fa-download me-2"title="Скачать информацию о пользователе"></i></a> <a href=# onclick=p4batchAccountCreate()><i role=button id=p4UserBatchCreate style=display:none title="Пакетное создание нескольких учетных записей пользователей"class="fa-solid fa-upload me-1"></i></a> <i style=cursor:pointer;margin-top:3px;margin-left:6px id=usersListToolbarSettings class="fa-solid fa-cog"title=Настройки onclick=onUsersViewSettings()></i></div></table><div id=p3users></div></div><div id=p5 style=display:none><div id=p5title><h1>Мои файлы</h1></div><table id=p5toolbar class=table cellpadding=0 cellspacing=0><tr><td id=p5filehead valign=bottom class="d-flex align-items-center"><div id=p5rightOfButtons class="d-flex align-items-center"></div><div class="m-1 d-flex align-items-center"><input type=button id=p5FolderUp class="btn btn-primary btn-sm me-1"disabled onclick="return p5folderup()"value=Up> <input type=button id=p5SelectAllButton class="btn btn-primary btn-sm me-1"disabled onclick=p5selectallfile() value="Выбрать все"> <input type=button id=p5RenameFileButton class="btn btn-primary btn-sm me-1"disabled value=Переименовать onclick=p5renamefile()> <input type=button id=p5DeleteFileButton class="btn btn-primary btn-sm me-1"disabled value=Удалить onclick=p5deletefile()> <input type=button id=p5ViewFileButton class="btn btn-primary btn-sm me-1"disabled value=Редактировать onclick=p5viewfile()> <input type=button id=p5NewFolderButton class="btn btn-primary btn-sm me-1"disabled value="Новая папка"onclick=p5createfolder()> <input type=button id=p5UploadButton class="btn btn-primary btn-sm me-1"disabled value=Загрузить onclick=p5uploadFile()> <input type=button id=p5DownloadButton class="btn btn-primary btn-sm me-1"disabled value=Скачать onclick=p5downloadButton()> <input type=button id=p5CutButton class="btn btn-primary btn-sm me-1"disabled value=Вырезать onclick=p5copyFile(1)> <input type=button id=p5CopyButton class="btn btn-primary btn-sm me-1"disabled value=Копировать onclick=p5copyFile(0)> <input type=button id=p5PasteButton class="btn btn-primary btn-sm me-1"disabled value=Вставить onclick=p5pasteFile()></div><tr><td id=p5filesubhead class="d-flex align-items-center"><div class="d-flex align-items-center">&nbsp;&nbsp;<span id=p5currentpath></span></div><div style=float:right class="d-flex align-items-center ms-auto"><select id=p5sortdropdown class="form-select-sm me-1"onchange=updateFiles()><option value=1 selected>Сортировать по имени<option value=2>Сортировать по размеру<option value=3>Сортировать по дате<option value=4>По имени по убыванию<option value=5>По размеру по убыванию<option value=6>По дате по убыванию</select></div></table><div id=p5filetable><div id=p5PublicShare><div>Эти файлы являются общедоступными, нажмите "ссылку", чтобы получить общедоступный URL.</div></div><div id=bigok style=display:none><b>✓</b></div><div id=bigfail style=display:none><b>✗</b></div><span id=p5files></span></div><table id=p5toolbarBottom class="table table-hover"style=width:100% cellpadding=0 cellspacing=0><tr><td class=style6>&nbsp;<span id=p5bottomstatus></span></table></div><div id=p6 style=display:none><div id=p6info style=overflow-y:auto><div id=p6title><img id=MainMeshImage src=serverpic.ashx><h1>Мой сервер</h1></div><div id=p2ServerActions><p><strong>Действия сервера</strong><div style=margin-left:25px><div id=p2ServerActionsBackup><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a id=p6backuplink href={{{domainurl}}}backup.zip rel="noreferrer noopener"target=_blank>Скачать резервную копию сервера</a></div><div id=p2ServerActionsRestore><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a href=# onclick="return server_showRestoreDlg()">Восстановить сервер из резервной копии</a></div><div id=p2ServerActionsGoogleBackup style=display:none><div class=p2AccountActions><span id=p2ServerActionsGoogleBackupCheck style=display:none><strong>✓</strong></span></div><span><a href=# onclick="return server_setupGoogleDriveBackup()">Резервное копирование на Google Диск</a><br></span></div><div id=p2ServerActionsVersion><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a href=# onclick="return server_showVersionDlg()">Проверить наличие обновлений</a></div><div id=p2ServerActionsErrors><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a href=# onclick="return server_showErrorsDlg()">Показать журнал ошибок сервера</a></div><div id=p2ServerActionsConfig><div class=p2AccountActions><span style=display:none><strong>✓</strong></span></div><a href=# onclick="return server_showConfigDlg()">Show server configuration</a></div></div><br></div><strong>Статистика сервера</strong><br><br><div id=serverStats><div id=serverCpuChartView style=display:none><div class=chartViewCanvas style=height:40px;text-align:center><canvas id=serverCpuChart style=display:inline-block></canvas></div><div class=chartViewText id=serverCpuChartText></div></div><div id=serverMemoryChartView style=display:none><div class=chartViewCanvas style=height:40px;text-align:center><canvas id=serverMemoryChart style=display:inline-block></canvas></div><div class=chartViewText id=serverMemoryChartText></div></div><br><br><div id=serverStatsTable></div></div><div id=serverWarningsDiv style=display:none><br><strong>Предупреждения сервера</strong><br><br><div id=serverCertWarnings></div><div id=serverWarnings></div></div></div></div><div id=p10 style=display:none><div id=p10title class="d-flex align-items-center"><div id=p10BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">Сводка - <span id=p10deviceName></span></div></div><div id=p10info style=overflow-y:auto class=pt-3><table style=width:100% cellpadding=0 cellspacing=0><tr><td style=width:auto valign=top><div id=p10html></div><td style=width:100px;display:none id=notesPanel valign=top><table><thead><tr><th>Примечания<tbody><tr><td><div id=notesPanelArea style=width:300px;height:200px;resize:none;overflow-y:scroll></div></table><td style=width:20px><td style=width:200px;vertical-align:top;position:relative valign=top><div class=deviceNotifyLargeDot><div id=p10deviceMsg onclick=showDeviceMessages(null,null,event) class=deviceNotifyDotSub></div><i title=Звезда role=button class="fa-solid fa-star"id=p10deviceStar onclick=showDeviceSessions(null,null,event) data-fa-transform=shrink-5 data-fa-mask="fa-solid fa-circle"></i> <i title="Список удаленных сеансов, активных на этом компьютере."role=button class="fa-solid fa-arrow-right-arrow-left"id=p10deviceNotify onclick=showDeviceSessions(null,null,event) data-fa-transform=shrink-5 data-fa-mask="fa-solid fa-circle"></i> <i title="Запрошена помощь"role=button class="fa-solid fa-question"id=p10deviceHelp onclick=showDeviceHelpRequests(null,null,event) data-fa-transform=shrink-5 data-fa-mask="fa-solid fa-circle"></i></div><div id=p10deviceBattery class="deviceBatteryLarge deviceBatteryLarge1"></div><a href=# onclick=p10showiconselector()><img id=MainComputerImage></a><div id=MainComputerState></div></table><br><div id=p10html2></div><div id=p10html3></div><div id=p10html4></div><div id=p10html5></div></div></div><div id=p11 class=noselect style=display:none><div id=p11title class="d-flex align-items-center"><div id=p11BackButton class=pe-2><i class="fa-solid fa-2xl fa-square-caret-left"role=button tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">Рабочий стол - <span id=p11deviceName></span></div><div id=devListToolbarViewIcons class=ms-auto><i class="fa-solid fa-xl fa-maximize fa-border"role=button onclick=deskToggleFull(event) title="Полноэкранный режим. Удерживайте shift для полноэкранного режима браузера."></i></div></div><div id=p11warning onclick=showFeaturesDlg()><div class=icon2></div><div class=warningbox>Redirection port or KVM feature is disabled<span id=p11warninga>, для включения нажмите сюда.</span></div></div><div id=p11warning2 onclick=showPowerActionDlg()><div class=icon2></div><div class=warningbox>Удаленный компьютер не включен, нажмите сюда, чтобы отправить команду включения питания.</div></div><div style=position:absolute;right:16px;margin-top:-14px;font-size:x-small;color:#000><div id=p11capslock style=display:inline-block;margin-left:1px;border-radius:5px;background-color:#a3ffb8;padding:2px>CAPS</div><div id=p11scrolllock style=display:inline-block;margin-left:1px;border-radius:5px;background-color:#a3ffb8;padding:2px>SCROLL</div><div id=p11numlock style=display:inline-block;margin-left:1px;border-radius:5px;background-color:#a3ffb8;padding:2px>NUM</div></div><div id=deskarea0 cellpadding=0 cellspacing=0><div id=deskarea1 class="areaHead d-flex flex-wrap"><div class="d-flex align-items-center"><input type=button class="btn btn-primary btn-sm me-1"id=autoconnectbutton1 value=Автоподключение onclick=autoConnectDesktop(event) onkeypress=return!1 onkeydown=return!1 style=display:none;margin-right:4px><div class="btn-group dropdown-center me-1"id=connectbutton1span><button type=button class="btn btn btn-primary btn-sm"id=connectbutton1 title="Подключиться к удаленному рабочему столу с помощью MeshAgent"onclick=connectDesktop(event,3) onkeypress=return!1 onkeydown=return!1 disabled>Подключиться</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=connectbutton1d data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmdeskaction(1,event)>Спросить согласия + панель-уведомление</a><li><a class=dropdown-item onclick=cmdeskaction(2,event)>Спросить согласия</a><li><a class=dropdown-item onclick=cmdeskaction(3,event)>Панель-уведомление</a></ul></div><div class="btn-group dropdown-center me-1"id=connectbutton1rspan><button type=button class="btn btn btn-primary btn-sm"id=connectbutton1r title="Подключиться используя RDP"onclick=askRdpCredentials() onkeypress=return!1 onkeydown=return!1 disabled>Подключиться по RDP</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=connectbutton1rd data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmaltportaction(1,event)>Поменять порт</a></ul></div><span id=connectbutton1hspan><button class="btn btn-primary btn-sm me-1"type=button id=connectbutton1h title="Connect using hardware KVM"onclick=connectDesktop(event,2) onkeypress=return!1 onkeydown=return!1 disabled>Аппаратное соединение</button></span><div class="btn-group dropdown-center me-1"id=disconnectbutton1span><button type=button class="btn btn btn-primary btn-sm"id=disconnectbutton1 title="Подключиться к удаленному рабочему столу с помощью MeshAgent"onclick=connectDesktop(event,0) onkeypress=return!1 onkeydown=return!1>Разъединить</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=diconnectbutton1d data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmdeskaction(10,event)>Разъединить и заблокировать</a><li><a class=dropdown-item onclick=cmdeskaction(11,event)>Разъединить</a></ul></div><span id=deskstatus style=line-height:22px>Отключен</span><span id=deskmetadata></span></div><div class="d-flex align-items-center ms-auto"><div id=desktopCustomUiButtons style=float:left></div><div id=desktopCustomUpperRight style=float:left;margin-right:6px></div><input type=button class="btn btn-primary btn-sm"title="Изменить состояние питания удаленного компьютера"onkeypress=return!1 onkeydown=return!1 value="Управление питанием..."onclick=showPowerActionDlg() style=display:none> <input id=deskActionsBtn type=button class="btn btn-primary btn-sm me-1"title="Управление питанием устройства"onkeypress=return!1 onkeydown=return!1 value=Действия onclick=deviceActionFunction()> <input id=deskActionsSettings type=button class="btn btn-primary btn-sm me-1"value=Настройки title="Редактировать настройки удаленного рабочего стола"onkeypress=return!1 onkeydown=return!1 onclick=showDesktopSettings()> <input id=deskFocusBtn type=button title="Вкл/Выкл режим фокусировки, когда включен обновляется только область вокруг мыши"onkeypress=return!1 onkeydown=return!1 value="Фокусировать все"onclick=deskToggleFocus() style=margin-right:3px;display:none><div id=deskRecordIcon class=deskareaicon title="Сервер проводит запись этой сессии"style=display:none;background-color:red;width:12px;height:12px;border-radius:6px;margin-top:5px></div><div class=deskareaicon title="Повернуть вправо"onclick=drotate(1)><i class="fa-solid fa-rotate-right"></i></div><div class=deskareaicon title="Повернуть влево"onclick=drotate(-1)><i class="fa-solid fa-rotate-left"></i></div><div class=deskareaicon title="Переключить вид"onclick=toggleAspectRatio(1)>⇲</div><div id=idx_deskFullBtn2 onclick=deskToggleFull(event) style=float:right>&nbsp;✖</div></div></div><div id=deskarea3x><div id=p11bigok style=display:none><b>✓</b></div><div id=p11bigfail style=display:none><b>✗</b></div><div id=DeskFocus oncontextmenu=return!1 onmousedown=dmousedown(event) onmouseup=dmouseup(event) onmousemove=dmousemove(event)></div><div id=DeskParent><canvas id=Desk width=640 height=480 oncontextmenu=return!1 onmousedown=dmousedown(event) onmouseup=dmouseup(event) onmousemove=dmousemove(event) onmousewheel=dmousewheel(event)></canvas></div><div id=DeskTools><div id=deskToolsAreaTop><a id=DeskToolsRefreshButton class=link-underline-primary style=right:2px onclick=refreshDeskTools()>Обновить</a><div id=deskToolsTopTabProcess class=deskToolsTopTab onclick=changeDeskToolTab(0) style=left:0;bottom:0>Процессы</div><div id=deskToolsTopTabService class=deskToolsTopTab onclick=changeDeskToolTab(1) style=display:none;left:90px;color:gray>Службы</div></div><div id=deskToolsArea><div id=DeskToolsProcessTab><div id=deskToolsHeader><a class=colmn1 title="Сортировать по id процесса"onclick=sortProcess(0)>PID</a> <a class=colmn2 title="Сортировать по имени"onclick=sortProcess(1)>Имя</a></div><div id=DeskToolsProcesses></div></div><div id=DeskToolsServiceTab style=display:none><div id=deskToolsServiceHeader><a class=colmn1 style=width:70px title="Сортировать по состоянию"onclick=sortService(0)>Состояние</a> <a class=colmn2 title="Сортировать по имени"onclick=sortService(1)>Имя</a></div><div id=DeskToolsServices></div></div></div></div><div id=p11DeskConsoleMsg style=display:none;text-align:left;cursor:pointer;position:absolute;left:30px;top:17px;color:#ff0;background-color:rgba(0,0,0,.6);padding:10px;border-radius:5px;text-align:left onclick=p11clearConsoleMsg()></div><div id=p11DeskSessionSelector style=display:none;position:absolute;left:30px;top:17px;right:30px;bottom:17px;overflow-y:auto></div></div><div id=deskarea4 class="areaFoot d-flex flex-wrap"><div class="d-flex align-items-center"><select id=deskkeys class="form-select-sm me-1"cmenu=deskKeyShortcutContextMenu></select> <input id=DeskWD type=button class="btn btn-primary btn-sm me-1"value=Отправить onkeypress=return!1 onkeydown=return!1 onclick=deskSendKeys()> <input id=DeskESC style=display:none type=button class="btn btn-primary btn-sm me-1"value=ESC onkeypress=return!1 onkeydown=return!1 onclick=sendDeskEsc()> <input id=DeskClip type=button class="btn btn-primary btn-sm me-1"value="Буфер обмена"onkeypress=return!1 onkeydown=return!1 onclick=showDeskClip()> <input id=DeskType class="btn btn-primary btn-sm me-1"cmenu=deskPreConfigShortcutContextMenu type=button value=Тип onkeypress=return!1 onkeydown=return!1 onclick=showDeskType()><div id=DeskControlSpan title="Разрешить мышь и ввод с клавиатуры"class=form-check><input id=DeskControl type=checkbox class=form-check-input onkeypress=return!1 onkeydown=return!1 onclick=toggleKvmControl()><label class=form-check-label for=DeskControl>Ввод</label></div>&nbsp;</div><div class="d-flex ms-auto align-items-center"><span id=DeskMonitorSelectionSpan></span> <span id=DeskLatency style=width:70px class=text-center title="Задержка сеанса рабочего стола"></span> <span id=DeskTimer style=width:70px class=text-center title="Время сессии"></span> <input id=DeskToolsButton type=button class="btn btn-primary btn-sm mx-1"value=Инструменты title="Переключить вид инструментов"onkeypress=return!1 onkeydown=return!1 onclick=toggleDeskTools()> <span id=DeskGuestShareButton title="Поделиться устройством с гостем"role=button><i class="fa-solid fa-fw fa-share-nodes"id=DeskInputUnLockedButtonImage onclick=showShareDevice()></i> </span><span id=DeskInputUnLockedButton title="Удаленный ввод разблокирован"role=button><i class="fa-solid fa-fw fa-keyboard"onclick=deskInputLockFunction(1)></i> </span><span id=DeskInputLockedButton title="Удаленный ввод заблокирован"role=button><i class="fa-solid fa-fw fa-keyboard"style=color:red onclick=deskInputLockFunction(0)></i> </span><span id=DeskRefreshButton title="Обновить рабочий стол"role=button><i class="fa-solid fa-fw fa-rotate"onclick=deskRefreshFunction()></i> </span><span id=DeskClipboardOutButton title="Загрузить локальный буфер обмена на удаленное устройство"role=button><i class="fa-solid fa-fw fa-up-long"data-fa-transform="shrink-9 down-4"data-fa-mask="fa-solid fa-clipboard"onclick=deskClipboardOutFunction()></i> </span><span id=DeskClipboardInButton title="Получить удаленный буфер обмена в локальный буфер обмена"style=display:none role=button><i class="fa-solid fa-fw fa-down-long"data-fa-transform="shrink-9 down-4"data-fa-mask="fa-solid fa-clipboard"onclick=deskClipboardInFunction()></i> </span><span id=DeskRecordButton cmenu=deskPlayerContextMenu title="Записать сеанс удаленного рабочего стола в файл"style=display:none role=button><i class="fa-solid fa-fw fa-video"onclick=deskRecordSession() id=DeskRecordButtonImage></i> </span><span id=DeskSaveImageButton title="Сохранить снимок экрана удаленного рабочего стола"role=button><i class="fa-solid fa-fw fa-camera"onclick=deskSaveImage()></i> </span><span id=DeskBackgroundButton title="Вкл/Выкл фон удаленного рабочего стола"role=button><i class="fa-solid fa-fw fa-image"onclick=deviceToggleBackground(event) id=DeskBackgroundButtonImage></i> </span><span id=DeskOpenWebButton title="Открыть ссылку на удаленном компьютере"role=button><i class="fa-solid fa-fw fa-globe"onclick=deviceUrlFunction()></i> </span><span id=DeskLockButton title="Заблокировать удаленный компьютер"role=button><i class="fa-solid fa-fw fa-lock"onclick=deviceLockFunction()></i> </span><span id=DeskNotifyButton title="Показать уведомление на удаленном компьютере"role=button><i class="fa-solid fa-fw fa-bell"onclick=deviceToastFunction()></i> </span><span id=DeskChatButton class=deskarea title="Открыть окно чата на этом компьютере"role=button><i class="fa-solid fa-fw fa-message"onclick=deviceChat(event)></i> </span><span id=DeskRunButton cmenu=deskPreConfigScriptContextMenu class=deskarea title="Run a script on this computer"role=button><i class="fa-solid fa-fw fa-play"onclick=runDeviceCmd()></i></span></div></div></div></div><div id=p12 style=display:none><div id=p12title class="d-flex align-items-center"><div id=p12BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">Терминал - <span id=p12deviceName></span></div><div id=devListToolbarViewIcons2 class=ms-auto><i class="fa-solid fa-xl fa-maximize fa-border"role=button onclick=deskToggleFull(event) title="Полноэкранный режим. Удерживайте shift для полноэкранного режима браузера."></i></div></div><div id=p12warning onclick=showFeaturesDlg()><div class=icon2></div><div class=warningbox>Redirection port or KVM feature is disabled<span id=p12warninga>, для включения нажмите сюда.</span></div></div><div id=p12warning2 onclick=showPowerActionDlg()><div class=icon2></div><div class=warningbox>Удаленный компьютер не включен, нажмите сюда, чтобы отправить команду включения питания.</div></div><div id=termTable style=position:relative><table style=width:100% cellpadding=0 cellspacing=0><tr><td class="areaHead d-flex flex-wrap"><div class="d-flex align-items-center"><button type=button id=autoconnectbutton2 class="btn btn-primary btn-sm me-1"onclick=autoConnectTerminal(event) onkeypress=return!1 onkeydown=return!1 style=display:none><i class="fa-solid fa-play"></i> Автоподключение</button><div class="btn-group dropdown-center me-1"id=connectbutton2span><button type=button class="btn btn btn-primary btn-sm"id=connectbutton2 title="Подключиться к удаленному рабочему столу с помощью MeshAgent"onclick=connectTerminal(event,1) onkeypress=return!1 onkeydown=return!1 disabled>Подключиться</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=connectbutton2d data-bs-toggle=dropdown aria-expanded=false onclick=newContextMenu(event,1)><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmtermaction(1,0,event)><b>Консоль от Админа</b></a><li><a class=dropdown-item onclick=cmtermaction(6,0,event)>PowerShell от Админа</a><li><a class=dropdown-item onclick=cmtermaction(8,0,event)>Консоль от Пользователя</a><li><a class=dropdown-item onclick=cmtermaction(9,0,event)>PowerShell от Пользователя</a><li><a class=dropdown-item onclick=cmtermaction(1,16,event)>Консоль от Админа, cпросить согласия</a><li><a class=dropdown-item onclick=cmtermaction(6,16,event)>PowerShell от Админа, cпросить согласия</a><li><a class=dropdown-item onclick=cmtermaction(8,16,event)>Консоль от Пользователя, cпросить согласия</a><li><a class=dropdown-item onclick=cmtermaction(9,16,event)>PowerShell от Пользователя, cпросить согласия</a><li class=ass><a class=dropdown-item onclick=cmtermaction(8,0,event)><b>Консоль от Пользователя</b></a><li class=ass><a class=dropdown-item onclick=cmtermaction(9,0,event)>PowerShell от Пользователя</a><li class=lin><a class=dropdown-item onclick=cmtermaction(1,0,event)><b>Консоль от Root</b></a><li class=lin><a class=dropdown-item onclick=cmtermaction(8,0,event)>Консоль от Пользователя</a><li class=lin><a class=dropdown-item onclick=cmtermaction(100,0,event)>Вход в оболочку</a></ul></div><div class="btn-group dropdown-center me-1"id=connectbutton2sspan><button type=button class="btn btn btn-primary btn-sm"id=connectbutton2s title="Подключиться к удаленному рабочему столу с помощью MeshAgent"onclick=connectTerminal(event,3) onkeypress=return!1 onkeydown=return!1 disabled>Подключиться по SSH</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=connectbutton2sd data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmsshportaction(1,event)>Поменять порт</a></ul></div><span id=connectbutton2hspan><button type=button class="btn btn-primary btn-sm me-1"id=connectbutton2h title="Подключиться  с помощью аппаратного KVM Intel® AMT"onclick=connectTerminal(event,2) onkeypress=return!1 onkeydown=return!1 disabled>Аппаратное соединение</button></span> <span id=disconnectbutton2span><button type=button class="btn btn-primary btn-sm me-1"id=disconnectbutton2 onclick=connectTerminal(event,0) onkeypress=return!1 onkeydown=return!1>Разъединить</button></span> <span id=termstatus style=line-height:22px>Отключен</span><span id=termtitle></span></div><div class="d-flex align-items-center ms-auto"><div id=idx_termFullBtn2 onclick=deskToggleFull(event) style=float:right>&nbsp;✖</div><div id=termRecordIcon class=deskareaicon title="Сервер проводит запись этой сессии"style=display:none;background-color:red;width:12px;height:12px;border-radius:6px;margin-top:5px;margin-left:5px></div><input id=termActionsBtn type=button title="Управление питанием устройства"onkeypress=return!1 onkeydown=return!1 value=Действия class="btn btn-primary me-1 btn-sm"onclick=deviceActionFunction()><div id=terminalCustomUpperRight style=float:left;margin-right:6px></div><div id=terminalCustomUiButtons style=float:left></div></div><tr><td id=termarea3x><div id=termarea3xdiv style=width:100%;height:100%;text-align:left></div><pre id=Term></pre><tr><td class="areaFoot d-flex flex-wrap"><div class="d-flex align-items-center"><input type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary btn-sm me-1"id=ctrlcbutton value=Ctl-C onclick='termSendKey(3,"ctrlcbutton")'> <input type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary btn-sm me-1"id=ctrlxbutton value=Ctl-X onclick='termSendKey(24,"ctrlxbutton")'> <input type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary me-1 btn-sm"id=escbutton value=ESC onclick='termSendKey(27,"escbutton")'> <input type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary me-1 btn-sm"id=bsbutton value=Backspace onclick='termSendKey(8,"bsbutton")'style=display:none> <input type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary me-1 btn-sm"id=pastebutton value=Вставить title="Вставить текст в терминал"onclick=showTermPasteDialog() style=display:none></div><div class="d-flex align-items-center ms-auto"><span id=TermTimer title="Время сессии"></span>&nbsp; <span id=terminalSettingsButtons style=display:none><input id=id_tcrbutton type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary me-1 btn-sm"value=CR+LF title="Поменять функцию клавиши ввода"onclick=termToggleCr()> <input id=id_tfxkeysbutton type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary me-1 btn-sm"value="Intel (F10 = ESC+[OM)"title="Переключить тип эмуляции клавиш F1 - F10"onclick=termToggleFx()> <input id=id_ttypebutton type=button onkeypress=return!1 onkeydown=return!1 class="btn btn-primary me-1 btn-sm"value="Расширенные Ascii"title="Переключить тип эмуляции терминала"onclick=termToggleType()> </span><span id=terminalSizeDropDown style=display:none><select id=termSizeList onkeypress=return!1 class="form-select-sm me-1"><option value=1>80x25<option value=2>100x30</select> </span><select id=specialkeylist class="form-select-sm me-1"onkeypress=return!1></select> <input id=specialkeylistinput type=button onkeypress=return!1 class="btn btn-primary btn-sm me-1"value=Отправить title="Отправить выбранную специальную клавишу"onclick=sendSpecialKey()></div></table><div id=p12TermConsoleMsg style=display:none;text-align:left;cursor:pointer;position:absolute;left:30px;top:45px;color:#ff0;background-color:rgba(0,0,0,.6);padding:10px;border-radius:5px onclick=p12clearConsoleMsg()></div></div></div><div id=p13 style=display:none><div id=p13title class="d-flex align-items-center"><div id=p13BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">Файлы - <span id=p13deviceName></span></div></div><table id=p13toolbar cellpadding=0 cellspacing=0><tr><td class="areaHead d-flex flex-wrap"><div class="d-flex align-items-center"><button id=p13AutoConnect onclick=autoConnectFiles(event) class="btn btn-primary btn-sm me-1"type=button style=display:none><i class="fa-solid fa-play"></i> Автоподключение</button><div class="btn-group dropdown-center me-1"id=p13Connectspan><button type=button class="btn btn btn-primary btn-sm"id=p13Connect title="Подключиться к удаленному рабочему столу с помощью MeshAgent"onclick=connectFiles(event,1) onkeypress=return!1 onkeydown=return!1 disabled>Подключиться</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=p13Connectdrop data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmconnectfilesaction()>Спросить согласия</a></ul></div><button id=p13Disconnect class="btn btn-primary btn-sm me-1"onclick=connectFiles(event) type=button>Разъединить</button><div class="btn-group dropdown-center me-1"id=p13Connectsspan><button type=button class="btn btn btn-primary btn-sm"id=p13Connects title="Подключиться к удаленному рабочему столу с помощью MeshAgent"onclick=connectFiles(event,2) onkeypress=return!1 onkeydown=return!1 disabled>Подключиться по SFTP</button> <button type=button class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"id=p13Connectsdrop data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span></button><ul class=dropdown-menu><li><a class=dropdown-item onclick=cmsshportaction(1,event)>Поменять порт</a></ul></div><span id=p13Status>Отключен</span></div><div class="d-flex align-items-center ms-auto"><input id=filesActionsBtn class="btn btn-primary me-1 btn-sm"type=button title="Управление питанием устройства"value=Действия onclick=deviceActionFunction()><div id=filesRecordIcon class=deskareaicon title="Сервер проводит запись этой сессии"style=display:none;background-color:red;width:12px;height:12px;border-radius:6px;margin-top:5px;margin-left:5px></div><div id=filesCustomUpperRight style=float:left;margin-right:6px></div><div id=filesCustomUiButtons style=float:left></div></div><tr><td class="areaHead2 d-flex align-items-center flex-wrap"valign=bottom><div id=p13rightOfButtons class="toright2 d-flex align-items-center"></div><div class="d-flex align-items-center"><input type=button disabled id=p13FolderUp class="btn btn-primary me-1 btn-sm"value=Up onclick=p13folderup()> <input type=button disabled id=p13SelectAllButton class="btn btn-primary me-1 btn-sm"value="Выбрать все"onclick=p13selectallfile()> <input type=button disabled id=p13RenameFileButton class="btn btn-primary me-1 btn-sm"value=Переименовать onclick=p13renamefile()> <input type=button disabled id=p13DeleteFileButton class="btn btn-primary me-1 btn-sm"value=Удалить onclick=p13deletefile()> <input type=button disabled id=p13ViewFileButton class="btn btn-primary me-1 btn-sm"value=Редактировать onclick=p13viewfile()> <input type=button disabled id=p13NewFolderButton class="btn btn-primary me-1 btn-sm"value="Новая папка"onclick=p13createfolder()> <input type=button disabled id=p13UploadButton class="btn btn-primary me-1 btn-sm"value=Загрузить onclick=p13uploadFile()> <input type=button disabled id=p13DownloadButton class="btn btn-primary me-1 btn-sm"value=Скачать onclick=p13downloadButton()> <input type=button disabled id=p13CutButton class="btn btn-primary me-1 btn-sm"value=Вырезать onclick=p13copyFile(1)> <input type=button disabled id=p13CopyButton class="btn btn-primary me-1 btn-sm"value=Копировать onclick=p13copyFile(0)> <input type=button disabled id=p13PasteButton class="btn btn-primary me-1 btn-sm"value=Вставить onclick=p13pasteFile()> <input type=button disabled id=p13ZipButton class="btn btn-primary me-1 btn-sm"value=Сжать onclick=p13zipFiles()> <input type=button disabled id=p13UnzipButton class="btn btn-primary me-1 btn-sm"value=Unzip onclick=p13unzipFile()> <input type=button disabled id=p13RefreshButton class="btn btn-primary me-1 btn-sm"value=Обновить onclick=p13folderup(9999)> <input type=button disabled id=p13FindButton class="btn btn-primary me-1 btn-sm"value=Найти onclick=p13findfile()> <input type=button disabled id=p13GoToFolderButton class="btn btn-primary me-1 btn-sm"value=GoTo onclick=p13gotofolder()> <input type=button disabled id=p13OpenButton class="btn btn-primary me-1 btn-sm"value=Open onclick=p13openfilefolder()></div><tr><td class=areaHead3><div class=toright2><select id=p13sizedropdown class="form-select-sm me-2"onchange=p13updateFiles()><option value=0 selected>Human Readable<option value=1 title=Bytes>Bytes<option value=10 title=KB>Kilobytes<option value=20 title=MB>Мегабайт<option value=30 title=GB>Gigabyte</select> <select id=p13sortdropdown class="form-select-sm me-2"onchange=p13updateFiles()><option value=1 selected>Сортировать по имени<option value=2>Сортировать по размеру<option value=3>Сортировать по дате<option value=4>По имени по убыванию<option value=5>По размеру по убыванию<option value=6>По дате по убыванию</select></div><div>&nbsp;&nbsp;<span id=p13currentpath></span></div></table><div id=p13FilesConsoleMsg style=display:none;text-align:left;cursor:pointer;position:absolute;left:30px;top:165px;color:#ff0;background-color:rgba(0,0,0,.6);padding:10px;border-radius:5px onclick=p13clearConsoleMsg()></div><div id=p13filetable><div id=p13bigok style=display:none><b>✓</b></div><div id=p13bigfail style=display:none><b>✗</b></div><span id=p13files></span></div><table id=p13toolbarBottom cellpadding=0 cellspacing=0><tr><td class=style6>&nbsp;<span id=p13bottomstatus></span></table></div><div id=p14 style=display:none><div id=p14title class="d-flex align-items-center"><div id=p14BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold"><span id=p14deviceNamePrefix>Intel® AMT</span> - <span id=p14deviceName></span></div><div id=devListToolbarViewIcons class=ms-auto><i class="fa-solid fa-xl fa-maximize fa-border"role=button onclick=deskToggleFull(event) title="Полноэкранный режим. Удерживайте shift для полноэкранного режима браузера."></i></div></div><iframe id=p14iframe src={{{domainurl}}}commander.ashx></iframe></div><div id=p15 style=display:none><div id=p15title class="d-flex align-items-center"><div id=p15BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold"><span id=p15deviceName></span></div></div><table id=consoleTable cellpadding=0 cellspacing=0><tr><td class="areaHead d-flex flex-wrap"><div id=p15statetext class="d-flex align-items-center"></div><div class="d-flex align-items-center ms-auto"><div id=p15coreName class=me-1 title="Информация о текущем ядре, работающем на этом агенте"></div><input type=button id=p15uploadCore class="btn btn-primary me-1 btn-sm"value="Управление агентом"onclick=p15uploadCore(event) title="Изменить модуль кода Java Script агента"> <i onclick=p15downloadConsoleText() title="Скачать текст из консоли"class="fa-solid fa-download me-1"></i></div><tr><td><div class=areaProgress><div id=consoleprogressbar></div></div><tr><td id=p15agentConsole><pre id=p15agentConsoleText></pre><tr><td class=areaFoot><table style=width:100%><tr><td style=width:99%><input id=p15consoleText class=form-control onkeyup=p15consoleSend(event) onfocus=onConsoleFocus(1) onblur=onConsoleFocus(0)><td>&nbsp;<td id=p15outputselecttd><select id=p15outputselect onchange=setupConsole()><option id=p15outputselect1 value=1>Агент<option id=p15outputselect3 value=3>Push<option id=p15outputselect2 value=2>MQTT</select><td style=width:1%><input id=id_p15consoleClear type=button class="btn btn-primary bottombutton"value=Очистить onclick=p15consoleClear()></table></table></div><div id=p16 style=display:none><div id=p16title class="d-flex align-items-center"><div id=p16BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">События - <span id=p16deviceName></span></div></div><table class=pTable><tr><td class="auto-style1 d-flex justify-content-end p-1"><div class="d-flex align-items-center"><label class=me-1 for=p16filterevents>Фильтр</label> <select id=p16filterevents class="form-control-sm me-2"onchange=refreshDeviceEvents()><option notransval=1 value="">All Logs<option notransval=1 value=agentlog>Agent Logs<option notransval=1 value=relaylog>Relay Logs<option notransval=1 value=manual>Manual Logs<option notransval=1 value=runcommands>Run Command Logs<option notransval=1 value=batchupload>Batch Upload Logs<option notransval=1 value=changenode>Change Node Logs<option notransval=1 value=removenode>Remove Node Logs</select> <label class=me-1 for=p16limitdropdown>Показать</label> <select id=p16limitdropdown class="form-control-sm me-2"onchange=refreshDeviceEvents()><option notransval=1 value=60>Последние 60<option notransval=1 value=120>Последние 120<option notransval=1 value=250>Последние 250<option notransval=1 value=500>Последние 500<option notransval=1 value=1000>Последние 1000</select> <i onclick=p3showDownloadEventsDialog(1) class="fa-solid fa-download"title="Скачать события"style=cursor:pointer></i></div></table><div id=p16events></div></div><div id=p17 style=display:none><div id=p17title class="d-flex align-items-center"><div id=p17BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">Детали - <span id=p17deviceName></span></div><div id=devListToolbarViewIcons3 class=ms-auto><i class="fa-solid fa-chart-line fa-xl fa-border"role=button onclick=deskToggleCpuGraph(event) title="Показать использование ЦП и памяти устройства."></i></div></div><div id=p17info class="ps-0 pb-5 overflow-y-auto container-fluid"><div id=p17graph style=width:100%><table style=width:100%><tr><td style=width:64px;vertical-align:top><img src=images/details/graph64.png border=0 width=64><td><div class=DevSt style=margin-bottom:3px;margin-left:16px><b>Живой график</b></div><div style="margin-bottom:10px;margin-left:16px;height:240px;width:calc(100% - 16px);position:relative"><canvas id=deviceDetailsStats style=position:absolute;top:0;left:0;right:0;bottom:0></canvas></div><div id=extraGraphValues style=display:none;margin-left:30px;margin-bottom:15px></div></table></div><div id=p17info2></div></div></div><div id=p19 style=display:none><div id=p19title><div id=p19BackButton style=float:left><div class=backButton tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'><div class=backButtonEx></div></div></div><h1>Плагины - <span id=p19deviceName></span></h1></div><div id=p19headers></div><div id=p19pages></div></div><div id=p20 style=display:none><div id=p20main style=overflow-y:auto><div id=p20title class="d-flex align-items-center"><div id=p20BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">Сводка - <span id=p20meshName></span></div></div><picture id=MainMeshImage style=border-width:0;height:200px;width:200px;float:right><source type=image/webp width=200 height=200 srcset=images/webp/mesh-256.webp><img alt=""width=200 height=200 src=images/mesh-256.png></picture><p id=p20info><p id=p20info2></div></div><div id=p21 style=display:none><div id=p21title class="d-flex align-items-center"><div id=p21BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">Резюме - <span id=p21meshName></span></div></div><div id=p21main style=overflow-y:auto><div style=width:100%><div style=display:table;width:93%><div id=meshPowerChartDiv style=width:23%;display:inline-block;text-align:center;max-width:250px><div style=margin:10px;font-size:16px>Состояния питания</div><canvas id=meshPowerChart style=width:250px;height:250px></canvas></div><div id=meshOsChartDiv style=width:23%;display:inline-block;text-align:center;max-width:250px><div style=margin:10px;font-size:16px>Типы агента</div><canvas id=meshOsChart style=width:250px;height:250px></canvas></div><div id=meshConnChartDiv style=width:23%;display:inline-block;text-align:center;max-width:250px><div style=margin:10px;font-size:16px>Соединение</div><canvas id=meshConnChart style=width:250px;height:250px></canvas></div><div id=meshSecurityChartDiv style=width:23%;display:inline-block;text-align:center;max-width:250px><div style=margin:10px;font-size:16px>Защита</div><canvas id=meshSecurityChart style=width:250px;height:250px></canvas></div></div></div><p id=p21info style=overflow-y:auto></div></div><div id=p30 style=display:none><div id=p30title class="d-flex align-items-center"><div id=p30BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">Сводка - <span id=p30userName></span></div></div><div id=p30info style=overflow-y:auto><div class=row><div class=col><div id=p30html></div></div><div class=col-auto style=width:20px></div><div class=col-auto style=width:200px;position:relative><img id=p30userAuthServiceLogo loading=lazy style=display:none class=userAuthStrategyLogo width=64 height=64><picture id=MainUserImage style=display:none;border-width:0;height:200px;width:200px;float:right onclick=account_manageImage(1)><source type=image/webp width=200 height=200 srcset=images/webp/user-256.webp><img alt=""width=200 height=200 src=images/user-256.png></picture><img id=MainUserImageEx alt=""width=200 height=200 src=images/user-256.png onclick=account_manageImage(1)><div style=width:100%;text-align:center><strong><span id=MainUserState></span></strong></div></div></div><br><div id=p30html2></div><div id=p30html3></div></div></div><div id=p31 style=display:none><div id=p31title class="d-flex align-items-center"><div id=p31BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">События - <span id=p31userName></span></div></div>{{!-- --}} {{!-- --}}<table class=pTable><tr><td class=h1><td class="auto-style1 d-flex justify-content-end p-1"><div class="d-flex align-items-center"><label for=p31filterevents class=me-1>Фильтр</label> <select id=p31filterevents class="form-select-sm me-2"onchange=refreshUsersEvents()><option notransval=1 value="">All Logs<option notransval=1 value=agentlog>Agent Logs<option notransval=1 value=relaylog>Relay Logs<option notransval=1 value=manual>Manual Logs<option notransval=1 value=runcommands>Run Command Logs<option notransval=1 value=batchupload>Batch Upload Logs<option notransval=1 value=changenode>Change Node Logs<option notransval=1 value=removenode>Remove Node Logs</select> <label for=p31limitdropdown class=me-1>Показать</label> <select id=p31limitdropdown class="form-select-sm me-2"onchange=refreshUsersEvents()><option notransval=1 value=60>Последние 60<option notransval=1 value=120>Последние 120<option notransval=1 value=250>Последние 250<option notransval=1 value=500>Последние 500<option notransval=1 value=1000>Последние 1000<option notransval=1 value="">Нет ограничений</select> <a href=# onclick=p3showDownloadEventsDialog(3)><i class="fa-solid fa-download"role=button title="Скачать события"></i></a></div><td class=h2></table><div id=p31events></div></div><div id=p40 style=display:none><div id=p40title><h1>Статистика моего сервера</h1></div><div class="areaHead d-flex align-items-center flex-wrap p-1"><div class="d-flex align-items-center"><input value=Обновить type=button class="btn btn-primary btn-sm me-2"onclick=refreshServerTimelineStats()><div class=form-check><input class="form-check-input me-1"type=checkbox id=p40log onclick=updateServerTimelineHours()><label class=form-check-label for=p40log>Log-X</label></div></div><div class="toright2 d-flex align-items-center ms-auto"><select id=p40server style=display:none onchange=updateServerTimelineStats()></select> <select id=p40type class="form-select-sm me-1"onchange=updateServerTimelineStats()><option value=0>Подключения<option value=1>ОЗУ<option value=5>CPU<option value=3>Входящий трафик<option value=4>Исходящий трафик</select> <select id=p40time class="form-select-sm me-1"onchange=updateServerTimelineHours()><option value=3>Последние 3 часа<option value=8>Последние 8 часов<option value=24>Последний день<option value=168>Последняя неделя<option value=720>Последние 30 дней</select> <i class="fa-solid fa-download"title="Скачать data points (.csv)"style=cursor:pointer onclick=p40downloadEvents()></i></div></div><canvas id=serverMainStats></canvas></div><div id=p41 style=display:none><div id=p41title><h1>Трассировка моего сервера</h1></div><div class="areaHead d-flex align-items-center flex-wrap p-1"><div class="d-flex align-items-center"><input value=Трассирование type=button class="btn btn-primary btn-sm me-1"onclick=setServerTracing()> <span id=p41traceStatus>Пусто</span></div><div class="toright2 d-flex align-items-center ms-auto"><label for=p41limitdropdown class=me-1>Показать</label> <select id=p41limitdropdown class="form-select-sm me-1"onchange=displayServerTrace()><option value=100>Последние 100<option value=250>Последние 250<option value=500>Последние 500<option value=1000>Последние 1000</select> <input value=Очистить type=button class="btn btn-primary btn-sm me-1"onclick=clearServerTracing()> <i class="fa-solid fa-download"title="Скачать трассировку (.csv)"style=cursor:pointer onclick=p41downloadServerTrace()></i></div></div><div id=p41events></div></div><div id=p42 style=display:none><h1>Плагины моего сервера</h1><div class=areaHead><div class=toright2></div><div><input value="Скачать плагин"type=button onclick="return pluginHandler.addPluginDlg()"></div></div><div id=pluginRestartNotice class=areaHead style=background-color:gold;display:none><div class=toright2><input value="Обновить ядра агентов"type=button onclick="return distributeCore(),!1"></div><div style=padding:2px><div style=padding:2px><b>Уведомление:</b> Плагины были изменены, это может потребовать обновление ядра агента.</div></div></div><table id=p42tbl><tr class=DevSt><th style=width:26px><th style=width:10px><th class=chName>Имя<th class=chDescription>Описание<th class=chSite style=text-align:center>Ссылка<th class=chVersion style=text-align:center>Версия<th class=chUpgradeAvail style=text-align:center>Последний<th class=chStatus style=text-align:center>Статус<th class=chAction style=text-align:center>Действиe<th style=width:10px></table><div id=pluginNoneNotice style=width:100%;text-align:center;padding-top:10px;display:none><i>Плагинов на сервере нет.</i></div></div><div id=p43 style=display:none><div id=p43BackButton><div class=backButton tabindex=0 onmouseup=go(42) title=Назад onkeypress='"Enter"==event.key&&go(42)'><div class=backButtonEx></div></div></div><h1>Плагины моего сервера - <span id=p43title></span></h1><iframe id=p43iframe frameborder=0 style="width:100%;height:calc(100vh - 245px);max-height:calc(100vh - 245px)"></iframe></div><div id=p50 style=display:none><div id=p50title><h1>Мои группы пользователей</h1></div><table class=pTable><tr><td class="style14 d-flex align-items-center flex-wrap p-1"><div id=p50userGroupOps class="d-flex align-items-center"><input type=button id=UsersGroupsSelectAllButton class="btn btn-primary btn-sm me-1"onclick=p50usersSelectallButtonFunction() value="Выбрать все"> <input type=button id=UsersGroupsGroupActionButton class="btn btn-primary btn-sm me-1"disabled value="Групповое действие"onclick=p50usersGroupActionFunction()> <input id=NewUserGroupButton type=button class="btn btn-primary btn-sm me-1"onclick=showCreateUserGroupDialog(1) value="Новая группа..."> <input id=DuplicateUserGroupButton type=button class="btn btn-primary btn-sm me-1"style=display:none onclick=showCreateUserGroupDialog(2) value="Скопировать группу..."></div></table><div id=p50groups></div></div><div id=p51 style=display:none><div id=p51title class="d-flex align-items-center"><div id=p51BackButton class=pe-2><i class="fa-solid fa-square-caret-left fa-2xl"role=button tabindex=0 onclick=goBack() title=Назад onkeypress='"Enter"==event.key&&goBack()'></i></div><div class="fs-4 fw-bold">Группа пользователей - <span id=p51groupName></span></div></div><div id=p51info style=overflow-y:auto><div class=row><div class=col><div id=p51group></div></div><div class=col-auto style=width:20px></div><div class=col-auto style=width:200px><picture id=MainUserImage style=border-width:0;height:200px;width:200px;float:right><source type=image/webp width=200 height=200 srcset=images/webp/group-256.webp><img alt=""width=200 height=200 src=images/group-256.png></picture><div style=width:100%;text-align:center><strong><span id=MainUserState></span></strong></div></div></div><div id=p51group2></div><br></div></div><div id=p52 style=display:none><div id=p52title><h1>Мои пользовательские записи</h1></div><table class=pTable><tr><td class="style14 d-flex align-items-center flex-wrap p-1"><div class="d-flex align-items-center"><input type=button class="btn btn-primary btn-sm"onclick=refreshRecodings() value=Обновить></div><div class="d-flex align-items-center ms-auto"><input type=button class="btn btn-primary btn-sm"onclick=openRecodringPlayer() value="Открыть плеер ..."></div></table><div id=p52recordings style=overflow-y:auto></div></div><div id=p60 style=display:none><div id=p60title><h1>Мои отчеты</h1></div>{{!-- --}} {{!-- --}}<table class=pTable><tr><td class=h1><td class=style14><div style=float:right;line-height:22px><a id=p60downloadReportDiv style=display:none href=# onclick=p60downloadReport()><i class="fa-solid fa-download"title="Скачать отчет"></i></a>&nbsp;</div><div><button class="btn btn-primary btn-sm me-2 m-1"onclick=generateReportDialog()><i class="fa-regular fa-file-alt"></i> Создать отчет...</button></div><td class=h2></table><div id=p60report style=overflow-y:auto></div></div><br id=column_l_bottomgap></div><div id=footer><div class=footer1>{{{footer}}}</div><div class=footer2 style=display:none><div class=row><div class="col-md-6 d-flex gap-2"></div><div class=col-md-6><a id=verifyEmailId2 style=display:none href=# onclick=account_showVerifyEmail()>Подтвердить email</a> &nbsp;<a id=termsLinkFooter href=terms>Условия и конфиденциальность</a></div></div></div></div><div class="modal fade"id=xxAddAgentModal tabindex=-1 aria-hidden=true><div class="modal-dialog modal-dialog-centered"id=xxAddAgentModalConf><div class=modal-content><div class=modal-header id=dialogHeader><h5 class="modal-title text-white"id=xxAddAgentTitle></h5><button type=button class=btn-close data-bs-dismiss=modal aria-label=Close></button></div><div class=modal-body id=xxAddAgentBody><div id=dialog1><div id=id_dialogMessage></div></div><div id=dialog2><div id=id_dialogOptions></div></div><div id=dialog3><div id=d3upload><div>Выбор файла</div><select id=d3uploadMode onchange=d3modechange()><option value=1>Локальная загрузка файлов<option value=2>Выбрать файл с сервера</select></div><div id=d3localmode style=display:none><div>Загрузить файл</div><form id=d3localmodeform method=post enctype=multipart/form-data action=uploadfile.ashx target=fileUploadFrame><input id=d3auth name=auth style=display:none> <input id=d3filter name=filter style=display:none> <input id=d3attrib name=attrib style=display:none> <input type=file id=d3localFile name=files onchange=d3setActions()> <input type=submit id=d3submit style=display:none></form></div><div id=d3servermode><div id=d3serveraction valign=bottom><input type=button id=p3FolderUp disabled onclick=d3folderup() value=Up>&nbsp;<span id=p3CurrentFolder></span></div><div id=d3serverfiles></div></div></div><div id=dialog4><input id=d4WrapButton class="btn btn-primary me-1 mb-1"type=button value="Wrap On"onclick=d4ToggleWrap()> <input id=d4SizeButton class="btn btn-primary me-1 mb-1"type=button value=Малый onclick=d4ToggleSize()> <input id=d4EncodingButton class="btn btn-primary me-1 mb-1"type=button value=Raw onclick=d4ToggleEncoding()> <input id=d4LineBreakButton class="btn btn-primary me-1 mb-1"type=button value=Windows onclick=d4ToggleLineBreak()> <textarea id=d4editorarea autocomplete=off style="height:calc(100vh - 286px);width:100%;overflow:scroll;resize:none;white-space:pre"></textarea></div><div id=dialog7><div class=dtab><button id=td7meshkvm class=tablinks onclick='changeDesktopSettingsTab(event,"d7meshkvm")'>Агент</button> <button id=td7rdpkvm class=tablinks onclick='changeDesktopSettingsTab(event,"d7rdpkvm")'>RDP</button> <button id=td7amtkvm class=tablinks onclick='changeDesktopSettingsTab(event,"d7amtkvm")'>Intel® AMT</button></div><div id=d7meshkvm class=tabcontent><div style=margin-top:8px><div>Качество</div><select id=d7bitmapquality dir=rtl></select></div><div><div>Маштабирование</div><select id=d7bitmapscaling dir=rtl><option selected value=1024>100%<option value=896>87.5%<option value=768>75%<option value=640>62.5%<option value=512>50%<option value=384>37.5%<option value=256>25%<option value=128>12.5%</select></div><div><div>Частота кадров</div><select id=d7framelimiter dir=rtl><option selected value=50>Быстро<option value=100>Средний<option value=400>Медленно<option value=1000>Очень медленно</select></div><div><div>Кодировка</div><select id=d7encoding dir=rtl><option value=1>JPEG<option value=2>PNG<option value=3>TIFF<option selected value=4>WEBP</select></div><div id=d7desktopOtherSettings><div>Другие настройки</div><div id=d7otherset2 style=display:block><label style=display:block><input type=checkbox id=d7deskSwapMouse>Поменять местами кнопки мыши</label> <label style=display:block><input type=checkbox id=d7deskrmw>Reverse Mouse Wheel</label> <label style=display:block><input type=checkbox id=d7deskRemoteKeyMap>Использовать карту удаленной клавиатуры</label> <label style=display:block id=d7deskAutoClipboardLabel><input type=checkbox id=d7deskAutoClipboard>Автоматический буфер обмена</label> <label style=display:block id=d7deskAutoLockLabel><input type=checkbox id=d7deskAutoLock>Заблокировать при отключении</label></div></div></div><div id=d7amtkvm class=tabcontent><div style=margin-top:8px><div>Кодировка изображения</div><select id=d7desktopmode><option value=1>RLE8, самая быстрая<option value=2>RLE16, рекомендуется<option value=3>RAW8, медленно<option value=4>RAW16, очень медленно</select></div><div><div>Другие настройки</div><div id=d7otherset style=display:block><label style=display:block><input type=checkbox id=d7showfocus>Показать инструмент фокусировки</label> <label style=display:block><input type=checkbox id=d7showcursor>Показать локальный курсор мыши</label> <label style=display:block><input type=checkbox id=d7localKeyMap>Раскладка локальной клавиатуры</label> <label style=display:block><input type=checkbox id=d7kvmrmw>Reverse Mouse Wheel</label></div></div></div><div id=d7rdpkvm class=tabcontent><div style=margin-top:8px><div>Размер дисплея</div><select id=d7rdpsize><option notransval=1 value=canvas>Размер холста<option notransval=1 value=browser>Размер браузера<option notransval=1 value=screen>Размер экрана<option notransval=1 value=640x480>640x480<option notransval=1 value=1024x768>1024x768<option notransval=1 value=1280x800>1280x800<option notransval=1 value=1440x900>1440x900<option notransval=1 value=1600x900>1600x900<option notransval=1 value=1680x1050>1680x1050<option notransval=1 value=1920x1080>1920x1080</select></div><div><div>Опции</div><div id=d7rdpflags style=display:block><label style=display:block><input type=checkbox id=d7rdp1>Отключить обои</label> <label style=display:block><input type=checkbox id=d7rdp2>Отключить содежимое окна при перетаскивании</label> <label style=display:block><input type=checkbox id=d7rdp3>Отключить анимации меню</label> <label style=display:block><input type=checkbox id=d7rdp4>Отключить тему</label> <label style=display:block><input type=checkbox id=d7rdp6>Отключить тень курсора</label> <label style=display:block><input type=checkbox id=d7rdp7>Отключить настройки курсора</label> <label style=display:block><input type=checkbox id=d7rdp8>Включить сглаживание шрифтов</label> <label style=display:block><input type=checkbox id=d7rdp9>Включить композицию рабочего стола</label> <label style=display:block><input type=checkbox id=d7rdpclip>Автоматический буфер обмена</label> <label style=display:block><input type=checkbox id=d7rdpsmb>Поменять местами кнопки мыши</label> <label style=display:block><input type=checkbox id=d7rdprmw>Reverse Mouse Wheel</label></div></div></div></div></div><div class=modal-footer><button type=button class="btn btn-primary"data-bs-dismiss=modal id=idx_dlgCancelButton>Отмена</button> <button type=button class="btn btn-outline-success"id=idx_dlgOkButton>OK</button> <button type=button class="btn btn-outline-danger"id=idx_dlgDeleteButton style=display:none>Удалить</button></div></div></div></div><iframe name=fileUploadFrame style=display:none></iframe><form style=display:none method=post action=uploadfile.ashx enctype=multipart/form-data target=fileUploadFrame><input id=p5fileDragName name=name><input id=p5fileDragAuthCookie name=auth><input id=p5fileDragSize name=size><input id=p5fileDragType name=type><input id=p5fileDragData name=data><input id=p5fileDragLink name=link class="btn btn-outline-success"><input type=submit id=p5loginSubmit2 style=display:none class="btn btn-outline-success"></form><form style=display:none method=post action=uploadnodefile.ashx enctype=multipart/form-data target=fileUploadFrame><input id=p13fileDragName name=name class="btn btn-outline-success"><input id=p13fileDragSize name=size class="btn btn-outline-success"><input id=p13fileDragType name=type class="btn btn-outline-success"><input id=p13fileDragData name=data class="btn btn-outline-success"><input id=p13fileDragLink name=link class="btn btn-outline-success"><input type=submit id=p13loginSubmit2 style=display:none class="btn btn-outline-success"></form><div id=topMenu style="z-index:1000;background-color:#fff;box-shadow:0 0 15px #666;font-family:Arial,Helvetica,sans-serif;border-radius:0 0 5px 5px;position:fixed;top:50px;right:5px;width:170px;display:none"><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer"onclick=topMenu(1)>Мои устройства</div><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer"onclick=topMenu(2)>Моя учетная запись</div><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer"onclick=topMenu(3)>Мои события</div><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer"onclick=topMenu(5)>Мои файлы</div><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer"onclick=topMenu(4)>Мои пользователи</div><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer"onclick=topMenu(6)>Мой сервер</div><div id=logoutMenuOption><a id=logoutMenuOptionRef href=/logout><div style="padding:12px;border-top:1px solid gray;color:#000;cursor:pointer">Выйти</div></a></div></div><audio id=chimes><source src=sounds/chimes.mp3 type=audio/mp3></audio><iframe style=display:none name=fileDownloadFrame></iframe></div><script>"use strict";var args,urlargs,random="{{{randomlength}}}",webState="{{{webstate}}}";for(var i in""!=webState&&(webState=JSON.parse(decodeURIComponent(webState))),null!=webState&&"object"==typeof webState||(webState={}),webState)if("desktopsettings"!=i)try{localStorage.setItem(i,webState[i])}catch(e){}if(!webState.loctag)try{localStorage.removeItem("loctag")}catch(e){}var desktop,terminal,files,autoReconnect=!0,powerStatetable=["","Включено","Отправить в сон","Отправить в сон","Отправить в сон","Гибернация","Выключить","Текущее состояние"],StatusStrs=["Отключен","Подключение...","Установка...","Подключено","Intel&reg; AMT подключен"],agentsStr=["Неизвестно","Консоль Windows 32bit","Консоль Windows 64bit","Служба Windows 32bit","Служба Windows 64bit","Linux 32bit","Linux 64bit","MIPS","XENx86","Android","Linux ARM","macOS x86-32bit","Android x86","PogoPlug ARM","Android","Linux Poky x86-32bit","macOS x86-64bit","ChromeOS","Linux Poky x86-64bit","Linux NoKVM x86-32bit","Linux NoKVM x86-64bit","Консоль Windows MinCore","Служба Windows MinCore","NodeJS","ARM-Linaro","ARMv6l / ARMv7l","ARMv8 64bit","ARMv6l / ARMv7l / NoKVM","MIPS24KC (OpenWRT)","Apple Silicon","FreeBSD x86-64","Неизвестно","Linux ARM 64 bit (glibc/2.24 NOKVM)","Alpine Linux x86 64 Bit (MUSL)","Ассистент (Windows)","Armada370 - ARM32 / HF (libc / 2.26)","OpenWRT x86-64","OpenBSD x86-64","Неизвестно","Неизвестно","MIPSEL24KC (OpenWRT)","ARMADA/CORTEX-A53/MUSL (OpenWRT)","Windows ARM 64bit console","Windows ARM 64bit service","ARMVIRT32 (OpenWRT)","RISC-V 64bit"],agentsStrNoAgent=["","","","","Windows","","Linux","","","","","","","","","","","","","","","","","","","","","","","Apple"],sort=0,searchFocus=0,mapSearchFocus=0,userSearchFocus=0,consoleFocus=0,showRealNames=!1,meshserver=null,meshes={},loginTokens={},meshcount=0,nodes=null,usergroups=null,filetree={},userinfo=null,serverinfo=null,events=[],users=null,wssessions=null,stars={},nodeShortIdent=0,desktopsettings={encoding:2,showfocus:!1,showmouse:!0,showcad:!0,quality:40,scaling:1024,framerate:50,localkeymap:!1,swapmouse:!1,remotekeymap:!1,autoclipboard:!1,autolock:!1,agentencoding:4},multidesktopsettings={quality:20,scaling:128,framerate:1e3,agentencoding:4},debugLevel=parseInt("{{{debuglevel}}}"),features=parseInt("{{{features}}}"),features2=parseInt("{{{features2}}}"),sessionTime=parseInt("{{{sessiontime}}}"),webRelayPort=parseInt("{{{webRelayPort}}}"),webRelayDns="{{{webRelayDns}}}",hidePowerTimeline="{{{hidePowerTimeline}}}",showNotesPanel="{{{showNotesPanel}}}",sessionRefreshTimer=null,domain="{{{domain}}}",domainUrl="{{{domainurl}}}",authCookie="{{{authCookie}}}",authRelayCookie="{{{authRelayCookie}}}",logoutControls=JSON.parse(decodeURIComponent("{{{logoutControls}}}")),authCookieRenewTimer=null,multiDesktop={},serverPublicNamePort="{{{serverDnsName}}}:{{{serverPublicPort}}}",amtScanResults=null,debugmode=0,windowsBrowser=detectWindowsBrowser(),attemptWebRTC=!!(128&features),webrtcconfiguration="{{{webrtcconfig}}}";if(""==webrtcconfiguration)webrtcconfiguration=null;else try{webrtcconfiguration=JSON.parse(decodeURIComponent(webrtcconfiguration))}catch(e){console.log('Invalid WebRTC config: "'+webrtcconfiguration+'".'),webrtcconfiguration=null}var passRequirements="{{{passRequirements}}}";""!=passRequirements&&(passRequirements=JSON.parse(decodeURIComponent(passRequirements)));var customui="{{{customui}}}";customui=""!=customui?JSON.parse(decodeURIComponent(customui)):null;var deskAspectRatio=0;try{deskAspectRatio=parseInt(getstore("deskAspectRatio","0"))}catch(e){}var uiMode=parseInt(getstore("uiMode",1)),webPageStackMenu=!1,webPageFullScreen=!0,nightMode=setNightMode(),footerBar="1"==getstore("footerBar","1"),sessionActivity=Date.now(),updateSessionTimer=null,pluginHandlerBuilder={{{pluginHandler}}},pluginHandler=null;null!=pluginHandlerBuilder&&(pluginHandler=new pluginHandlerBuilder);var installedPluginList=null,goBackStack=[],CollapsedGroups={};try{CollapsedGroups=JSON.parse(getstore("_collapse","{}"))}catch(e){}var deviceViewSettings={};try{deviceViewSettings=JSON.parse(getstore("_deviceViewSettings","{}"))}catch(e){}var userViewSettings={};try{userViewSettings=JSON.parse(getstore("_usersViewSettings","{}"))}catch(e){}var xterm=null,xtermfit=null,xtermResizeTimer=null,miscState={},checkedNodeids={},deskKeyboardShortcuts=[],deskKeyboardStrings=[],deskLastClipboardSent=null,requestedLastConnects=!1,devicePagingState=null,p11DeskConsoleMsgTimer=null,p12TermConsoleMsgTimer=null,p13FilesConsoleMsgTimer=null,webpSupport=!1;function startup(){if(!(32&features)){var e=null;try{e=top.location.toString().toLowerCase()}catch(e){}if(top!=self&&(null==e||0==top.active))return void(top.location=self.location)}(null!=(urlargs=parseUriArgs()).key&&(urlargs.key=""+urlargs.key),urlargs.key&&0==isAlphaNumeric(urlargs.key)&&delete urlargs.key,urlargs.locale&&0==isAlphaNumeric(urlargs.locale)&&delete urlargs.locale,delete urlargs.user,delete urlargs.pass,delete urlargs.viewmode,delete urlargs.gotonode,delete urlargs.gotodevicename,delete urlargs.gotodevicername,delete urlargs.gotodeviceip,delete urlargs.gotomesh,delete urlargs.gotouser,delete urlargs.gotougrp,urlargs.key&&(Q("termsLinkFooter").href+="?key="+urlargs.key),(args=parseUriArgs()).key&&0==isAlphaNumeric(args.key)&&delete args.key,args.locale&&0==isAlphaNumeric(args.locale)&&delete args.locale,args.locale)||null!=(s=getstore("loctag",0))&&"*"!=s&&(args.locale=s);debugmode=args.debug,null!=args.webrtc&&(attemptWebRTC=1==args.webrtc),QV("p13AutoConnect",debugmode),QV("autoconnectbutton2",debugmode),QV("autoconnectbutton1",debugmode),nightMode&&(document.documentElement.setAttribute("data-bs-theme","dark"),QC("body").add("night"),QS("body")["background-color"]="#000"),toggleFullScreen();try{stars=JSON.parse(getstore("stars","{}"))}catch(e){}var t=0,n=parseInt("{{{hide}}}");(n||args.hide)&&(args.hide&&(t=parseInt(args.hide)),n&&(t|=n)),args.hide=t,QV("uiViewButton5",!(4&args.hide)),adjustPanels();var o="";logoutControls&&(null!=logoutControls.name&&(o='<span onmouseup=go(2) CLASS="LogoffLinkColor" style="cursor:pointer">'+format("Добро пожаловать {0}.",logoutControls.name)+"</span>"),null!=logoutControls.logoutUrl&&(o+=format(' <a href="'+logoutControls.logoutUrl+'" CLASS="LogoffLinkColor">Выйти</a>'))),1&args.hide?QH("logoutControlSpan2",o):QH("logoutControlSpan",o),document.onclick=function(e){hideContextMenu()},document.onkeypress=ondockeypress,document.onkeydown=ondockeydown,document.onkeyup=ondockeyup,window.addEventListener("blur",ondocblur,!1),window.onresize=function(){hideContextMenu(),mainUpdate(512),browserfullscreen=isBrowserFullscreen(),QV("DeskESC",browserfullscreen),null!=xtermfit&&12==xxcurrentView&&xtermfit.fit()},setTimeout(function(){urlargs.filter&&(Q("SearchInput").value=urlargs.filter,Q("KvmSearchInput").value=urlargs.filter),mainUpdate(512)},200),DOMPurify&&DOMPurify.addHook("afterSanitizeAttributes",function(e){"target"in e&&(e.setAttribute("target","_blank"),e.setAttribute("rel","noopener noreferrer")),e.hasAttribute("target")||!e.hasAttribute("xlink:href")&&!e.hasAttribute("href")||e.setAttribute("xlink:show","new")}),QV("textnewui",!!(1073741824&features2)),(meshserver=MeshServerCreateControl(domainUrl)).onStateChanged=onStateChanged,meshserver.onMessage=onMessage,meshserver.trace=args.trace,meshserver.Start(),Q("sortselect").selectedIndex=sort=getstore("sort",0),Q("sizeselect").selectedIndex=getstore("viewsize",1),Q("KvmSearchInput").value=Q("SearchInput").value=getstore("_search",""),showRealNames=1==getstore("showRealNames",0),Q("RealNameCheckBox").checked=showRealNames,Q("DevFilterSelect").value=getstore("devFilterSelect",0),Q("viewselect").value=getstore("deviceView",1),Q("DeskControl").checked=1==getstore("DeskControl",1),QV("accountChangeEmailAddressSpan",!(2097152&features)),mainUpdate(3);for(var i=1;i<5;i++)Q("devViewButton"+i).classList.remove("viewSelectorSel");Q("devViewButton"+Q("viewselect").value).classList.add("viewSelectorSel"),Q("p5filetable").addEventListener("drop",p5fileDragDrop,!1),Q("p5filetable").addEventListener("dragover",p5fileDragOver,!1),Q("p5filetable").addEventListener("dragleave",p5fileDragLeave,!1),Q("deskarea0").addEventListener("drop",p11fileDragDrop,!1),Q("deskarea0").addEventListener("dragover",p11fileDragOver,!1),Q("deskarea0").addEventListener("dragleave",p11fileDragLeave,!1),Q("p13filetable").addEventListener("drop",p13fileDragDrop,!1),Q("p13filetable").addEventListener("dragover",p13fileDragOver,!1),Q("p13filetable").addEventListener("dragleave",p13fileDragLeave,!1),setInterval(updateDeviceTimeline,12e4);var a=null;try{a=localStorage.getItem("desktopsettings")}catch(e){}null!=a&&(desktopsettings=JSON.parse(a)),a=null;try{a=localStorage.getItem("multidesktopsettings")}catch(e){}null!=a&&(multidesktopsettings=JSON.parse(a)),applyDesktopSettings();for(var s="",r=1;r<27;r++)s+="<option value='"+r+"'>Ctrl-"+String.fromCharCode(64+r)+" ("+r+")</option>";QH("specialkeylist",s),setupGeneralServerStats(),setupServerTimelineStats(),userInterfaceSelectMenu(),setupMeshSummaryStats(),QV("p4UserBatchCreate",!(524288&features)),d4EditWrapVal=Number(getstore("editorWrap",0)),d4EditSizeVal=Number(getstore("editorSize",0)),d4EditEncodingVal=Number(getstore("editorEncoding",0)),d4EditLineBreakVal=Number(getstore("editorLineBreak",0)),d4ToggleWrap(!0),d4ToggleSize(!0),d4ToggleEncoding(!0),d4ToggleLineBreak(!0),null!=pluginHandler&&pluginHandler.callHook("onWebUIStartupEnd"),-1==["en","ko","ja","zh-chs","zh-cht"].indexOf("{{{lang}}}")&&""!="{{{lang}}}".toLowerCase()&&QC("body").add("nonenglish");var l=document.getElementsByClassName("topbar_td");for(var d in l)l[d].innerHTML&&(l[d].innerHTML=l[d].innerHTML.split(" ").join("&nbsp;"));if(null!=customui){if(customui.devicesbarbuttons){s="";for(var d in customui.devicesbarbuttons){var c="one"==customui.devicesbarbuttons[d].selection||"many"==customui.devicesbarbuttons[d].selection?"disabled":"";s+='<input id="cui:'+d+'" type="button" value="'+customui.devicesbarbuttons[d].name+'" '+c+' onclick=customUIAction(event,"devicesbarbuttons") />'}QH("devsCustomUIBar",s)}if(customui.desktopbuttons){s="";for(var d in customui.desktopbuttons)s+='<input id="cui:'+d+'" type="button" value="'+customui.desktopbuttons[d].name+'" style="float:left" onclick=customUIAction(event,"desktopbuttons") />';QH("desktopCustomUiButtons",s)}if(customui.terminalbuttons){s="";for(var d in customui.terminalbuttons)s+='<input id="cui:'+d+'" type="button" value="'+customui.terminalbuttons[d].name+'" style="float:left" onclick=customUIAction(event,"terminalbuttons") />';QH("terminalCustomUiButtons",s)}if(customui.filesbuttons){s="";for(var d in customui.filesbuttons)s+='<input id="cui:'+d+'" type="button" value="'+customui.filesbuttons[d].name+'" style="float:left" onclick=customUIAction(event,"filesbuttons") />';QH("filesCustomUiButtons",s)}}sessionTime>=10&&(sessionRefreshTimer=setTimeout(refreshCookieSession,Math.round(6e4*sessionTime*.8))),deskKeyboardShortcuts=[];var u=getstore("deskKeyShortcuts","0x0A002E,0x100000,0x100028,0x100026,0x10004C,0x10004D,0x11004D,0x100052,0x020073,0x080057,0x020009,0x100025,0x100027").split(",");for(var d in u)""!=u[d]&&deskKeyboardShortcuts.push(parseInt(u[d]));updateDeskShortcutKeys();try{deskKeyboardStrings=JSON.parse(getstore("deskStrings","[]"))}catch(e){}updateDesktopStrings(),updateCollapseAllButton(),dialogBoxDrag(),urlargs.key&&(Q("p6backuplink").href+="?key="+urlargs.key),QV("uiViewButton4",!(3145728&features2)),Q("DeskType").value=multiTranslate("[KeyboardTyping]|Удаленный ввод"),QV("ScrollToTopButton",!!(134217728&features2))}function refreshCookieSession(){var e=null;try{e=new XDomainRequest}catch(e){}e||(e=new XMLHttpRequest),e.open("GET",window.location.origin+domainUrl+"refresh.ashx"),e.timeout=15e3,e.onload=function(){sessionRefreshTimer=setTimeout(refreshCookieSession,Math.round(6e4*sessionTime*.8))},e.onerror=e.ontimeout=function(){sessionRefreshTimer=null},e.send()}function customUIAction(e,t){var n=e.srcElement.id;if(0!=n.startsWith("cui:")){var o=customui[t][n.substring(4)];if(null!=o){if("devicesbarbuttons"==t){for(var i=document.getElementsByClassName("DeviceCheckbox"),a=[],s=0;s<i.length;s++)!0===i[s].checked&&a.push(i[s].defaultValue.substring(6));if("string"==typeof o.action&&("event"==o.action&&meshserver.send({action:"uicustomevent",section:t,element:n.substring(4),selectedDevices:a,logmsg:o.logmsg}),o.action.startsWith("dialog:")&&showCustomUiDialog(o.action.substring(7),{section:t,element:n.substring(4),selectedDevices:a}),o.deselectdevices)){for(s=0;s<i.length;s++)i[s].checked=!1;checkedNodeids={},p1updateInfo()}}if("devicebuttons"==t||"desktopbuttons"==t||"terminalbuttons"==t||"filesbuttons"==t){a=[currentNode._id];"string"==typeof o.action&&("event"==o.action&&meshserver.send({action:"uicustomevent",section:t,element:n.substring(4),selectedDevices:a,logmsg:o.logmsg}),o.action.startsWith("dialog:")&&showCustomUiDialog(o.action.substring(7),{section:t,element:n.substring(4),selectedDevices:a}))}}}}function showCustomUiDialog(e,t){if(null!=customui&&null!=customui.dialogs&&"object"==typeof customui.dialogs[e]){var n="",o=customui.dialogs[e];if("string"==typeof o.text&&(n+="<div style=margin-bottom:8px>"+o.text+"</div>"),"number"==typeof o.buttons&&o.buttons,"object"==typeof o.elements)for(var i in o.elements){var a=o.elements[i];if("text"==a.type&&(n+=addHtmlFormFloating(a.name,"<input id=cui:"+i+" class=form-control autocomplete=off />")),"textarea"==a.type&&(null==a.name?n+="<textarea id=cui:"+i+" style=width:356px;resize:none;height:100px autocomplete=off></textarea>":n+=addHtmlFormFloating(a.name,"<textarea id=cui:"+i+" style=width:230px;resize:none;height:100px autocomplete=off></textarea>")),"droplist"==a.type){var s="";for(var r in a.options)s+='<option value="'+r+'">'+EscapeHtml(a.options[r])+"</option>";n+=addHtmlFormFloating(a.name,'<select id="cui:'+i+'" class=form-select autocomplete=off />'+s+"</select>")}}setModalContent("xxAddAgent",o.title,n),showModal("xxAddAgentModal","idx_dlgOkButton",{action:"uicustomevent",section:"dialogs",element:e,src:t,values:{},logmsg:o.logmsg})}}function showCustomUiDialogEx(e,t){if(1==e){var n=customui.dialogs[t.element];if("object"==typeof n.elements)for(var o in n.elements){var i=n.elements[o];"droplist"!=i.type&&"textarea"!=i.type&&"text"!=i.type||(t.values[o]=Q("cui:"+o).value)}if(meshserver.send(t),n.deselectdevices){var a=document.getElementsByClassName("DeviceCheckbox");for(o=0;o<a.length;o++)a[o].checked=!1;checkedNodeids={},p1updateInfo()}}}function adjustPanels(){var e=args.hide;0==footerBar&&(e|=4),QV("masthead",!(1&e)),QV("topbar",!(2&e)),QV("footer",!(4&e)),QV("p1title",!(8&e)),QV("p2title",!(8&e)),QV("p3title",!(8&e)),QV("p4title",!(8&e)),QV("p5title",!(8&e)),QV("p6title",!(8&e)),QV("p10title",!(8&e)),QV("p11title",!(8&e)),QV("p12title",!(8&e)),QV("p13title",!(8&e)),QV("p14title",!(8&e)),QV("p15title",!(8&e)),QV("p16title",!(8&e)),QV("p17title",!(8&e)),QV("p20title",!(8&e)),QV("p21title",!(8&e)),QV("p30title",!(8&e)),QV("p31title",!(8&e)),QV("p40title",!(8&e)),QV("p41title",!(8&e)),QV("p50title",!(8&e)),QV("p51title",!(8&e)),footerBar?QC("body").remove("nofooter"):QC("body").add("nofooter"),0!=args.hide&&(2==uiMode?(QS("container")["grid-template-rows"]=(1&e?"0":"66")+"px fit-content(48px) auto "+(4&e?"0":"45")+"px",QS("container")["-ms-grid-rows"]=(1&e?"0":"66")+"px fit-content(48px) auto "+(4&e?"0":"45")+"px"):(QS("container")["grid-template-rows"]=(1&e?"0":"66")+"px "+(2&e?"0":"24")+"px auto "+(4&e?"0":"45")+"px",QS("container")["-ms-grid-rows"]=(1&e?"0":"66")+"px "+(2&e?"0":"24")+"px auto "+(4&e?"0":"45")+"px"));var t=(1&e?0:66)+(2&e?0:24)+(4&e?0:45)+(8&e?0:60),n=uiMode>1?24:0;QS("p2info").height="calc(100vh - "+(20+t+n)+"px)",QS("p2info")["max-height"]="calc(100vh - "+(20+t+n)+"px)",QS("p3users")["max-height"]="calc(100vh - "+(50+t)+"px)",QS("p50groups")["max-height"]="calc(100vh - "+(50+t)+"px)",QS("p3events").height="calc(100vh - "+(50+t)+"px)",QS("p5filetable").height="calc(100vh - "+(99+t)+"px)",QS("p13filetable").height="calc(100vh - "+(127+t+n)+"px)",QS("serverMainStats").height="calc(100vh - "+(50+t+n)+"px)",QS("serverMainStats")["max-height"]="calc(100vh - "+(50+t+n)+"px)",QS("xdevices")["max-height"]="calc(100vh - "+(46+t)+"px)",QS("xdevicesmap")["max-height"]="calc(100vh - "+(46+t)+"px)",QS("p15agentConsole").height="calc(100vh - "+(84+t+n)+"px)",QS("p15agentConsole")["max-height"]="calc(100vh - "+(84+t+n)+"px)",QS("p15agentConsoleText").height="calc(100vh - "+(81+t+n)+"px)",QS("p15agentConsoleText")["max-height"]="calc(100vh - "+(81+t+n)+"px)";var o=!(0===args.xterm||null!=terminal&&null==xterm);fullscreen?(QS("deskarea3x").height=null,QS("deskarea3x")["max-height"]=null,QS("p14iframe").height=null,QS("p14iframe")["max-height"]=null,o&&(QS("termarea3x").height="calc(100vh - 55px)",QS("termarea3xdiv").height="calc(100vh - 55px)",QS("termarea3x")["max-width"]="calc(1px)")):(QS("deskarea3x").height="calc(100vh - "+(74+t+n)+"px)",QS("deskarea3x")["max-height"]="calc(100vh - "+(74+t+n)+"px)",QS("p14iframe").height="calc(100vh - "+(23+t+n)+"px)",QS("p14iframe")["max-height"]="calc(100vh - "+(23+t+n)+"px)",o&&(QS("termarea3x").height="calc(100vh - "+(74+t+n)+"px)",QS("termarea3xdiv").height="calc(100vh - "+(74+t+n)+"px)",QS("termarea3x")["max-width"]="calc(1px)")),QS("p43iframe").height="calc(100vh - "+(84+t)+"px)",QS("p43iframe")["max-height"]="calc(100vh - "+(84+t)+"px)",QS("p6info").height="calc(100vh - "+(-50+t+n)+"px)",QS("p6info")["max-height"]="calc(100vh - "+(-50+t+n)+"px)",QS("p10info").height="calc(100vh - "+(20+t+n)+"px)",QS("p10info")["max-height"]="calc(100vh - "+(20+t+n)+"px)",QS("p17info").height="calc(100vh - "+(20+t+n)+"px)",QS("p17info")["max-height"]="calc(100vh - "+(20+t+n)+"px)",QS("p20main").height="calc(100vh - "+(-50+t+n)+"px)",QS("p20main")["max-height"]="calc(100vh - "+(-50+t+n)+"px)",QS("p21main").height="calc(100vh - "+(20+t+n)+"px)",QS("p21main")["max-height"]="calc(100vh - "+(20+t+n)+"px)",QS("p30info").height="calc(100vh - "+(20+t+n)+"px)",QS("p30info")["max-height"]="calc(100vh - "+(20+t+n)+"px)",QS("p51info").height="calc(100vh - "+(20+t+n)+"px)",QS("p51info")["max-height"]="calc(100vh - "+(20+t+n)+"px)",QS("p16events").height="calc(100vh - "+(50+t+n)+"px)",QS("p16events")["max-height"]="calc(100vh - "+(50+t+n)+"px)",QS("p31events").height="calc(100vh - "+(50+t+n)+"px)",QS("p31events")["max-height"]="calc(100vh - "+(50+t+n)+"px)",QS("p41events").height="calc(100vh - "+(48+t+n)+"px)",QS("p41events")["max-height"]="calc(100vh - "+(48+t+n)+"px)",QS("p52recordings").height="calc(100vh - "+(48+t+n)+"px)",QS("p52recordings")["max-height"]="calc(100vh - "+(48+t+n)+"px)",QS("p60report").height="calc(100vh - "+(48+t+n)+"px)",QS("p60report")["max-height"]="calc(100vh - "+(48+t+n)+"px)",(32&args.hide||""!="{{currentNode}}".toLowerCase())&&(QV("p10BackButton",!1),QV("p11BackButton",!1),QV("p12BackButton",!1),QV("p13BackButton",!1),QV("p14BackButton",!1),QV("p15BackButton",!1),QV("p16BackButton",!1),QV("p17BackButton",!1)),p1updateInfo()}function toggleAspectRatio(e){1===e&&putstore("deskAspectRatio",deskAspectRatio=(deskAspectRatio+1)%3),deskAdjust()}function toggleStackMenu(e){1==webPageFullScreen&&(1===e&&putstore("webPageStackMenu",webPageStackMenu=!webPageStackMenu),0==webPageStackMenu?QC("body").remove("menu_stack"):(QC("body").add("menu_stack"),xxcurrentView>=10&&QC("column_l").remove("room4submenu")),deskAdjust())}function showUserInterfaceSelectMenu(){if(!xxdialogMode){Q("uiViewButton1").classList.remove("uiSelectorSel"),Q("uiViewButton2").classList.remove("uiSelectorSel"),Q("uiViewButton3").classList.remove("uiSelectorSel"),Q("uiViewButton4").classList.remove("uiSelectorSel"),Q("uiViewButton5").classList.remove("uiSelectorSel");try{Q("uiViewButton"+uiMode).classList.add("uiSelectorSel")}catch(e){}QV("uiMenu","none"==QS("uiMenu").display),nightMode&&Q("uiViewButton4").classList.add("uiSelectorSel"),footerBar&&Q("uiViewButton5").classList.add("uiSelectorSel")}}function userInterfaceSelectMenu(e){e&&putstore("uiMode",uiMode=e),webPageFullScreen=uiMode<3,webPageStackMenu=uiMode>1,toggleFullScreen(0),toggleStackMenu(0),webPageStackMenu&&xxcurrentView>=10?QC("column_l").add("room4submenu"):QC("column_l").remove("room4submenu"),adjustPanels()}function toggleNightMode(){if(!xxdialogMode){var e=getstore("nightMode","0"),t="<input type=radio id=night0 name=nightmoderadio value=0 "+(0==e?"checked":"")+"><label for=night0>Использовать предпочтения браузера</label><br>";t+="<input type=radio id=night2 name=nightmoderadio value=2 "+(2==e?"checked":"")+"><label for=night2>Легкий режим</label><br>",xxdialogButtons=3,setModalContent("xxAddAgent","Ночной режим",t+="<input type=radio id=night1 name=nightmoderadio value=1 "+(1==e?"checked":"")+"><label for=night1>Темный режим</label><br>"),showModal("xxAddAgentModal","idx_dlgOkButton",toggleNightModeEx),QV("uiMenu",!1)}}function toggleNightModeEx(){var e="0";Q("night1").checked&&(e="1"),Q("night2").checked&&(e="2"),putstore("nightMode",e),setNightMode()}function setNightMode(){var e=getstore("nightMode","0");return nightMode=!1,1048576&features2&&(e="1"),2097152&features2&&(e="2"),"1"==e?nightMode=!0:"0"==e&&window.matchMedia&&(nightMode=window.matchMedia("(prefers-color-scheme: dark)").matches),nightMode?(document.documentElement.setAttribute("data-bs-theme","dark"),QC("body").add("night"),QS("body")["background-color"]="#000"):(document.documentElement.setAttribute("data-bs-theme","light"),QC("body").remove("night"),QS("body")["background-color"]="#d3d9d6"),nightMode}function toggleFooterBarMode(){putstore("footerBar",(footerBar=!footerBar)?"1":"0"),QS("container")["grid-template-rows"]=null,QS("container")["-ms-grid-rows"]=null,adjustPanels()}function toggleFullScreen(e){const t=document.getElementById("page_leftbar");1===e&&putstore("webPageFullScreen",webPageFullScreen=!webPageFullScreen),0==webPageFullScreen?(QC("body").remove("menu_stack"),QC("body").remove("fullscreen"),QC("body").remove("arg_hide"),xxcurrentView>=10&&QC("column_l").add("room4submenu"),QV("UserDummyMenuSpan",!1),t.classList.add("d-none")):(QC("body").add("fullscreen"),16&args.hide&&QC("body").add("arg_hide"),QV("page_leftbar",!(16&args.hide)),QV("MainMenuSpan",!(16&args.hide)),xxcurrentView>=10&&QC("column_l").remove("room4submenu"),QV("UserDummyMenuSpan",xxcurrentView<10&&webPageFullScreen),t.classList.remove("d-none")),mainUpdate(512),QV("body",!0)}function saveUserInterfaceMode(){var e=3;if(Q("ui0").checked&&(e=2),getstore("uiViewMode",3)!=e){putstore("uiViewMode",e);var t=new URL(window.location.href);t.searchParams.has("sitestyle")&&(t.searchParams.delete("sitestyle"),window.history.replaceState({},document.title,t.toString())),reload()}}function toggleBootstrapUIMode(){if(!xxdialogMode){var e=getstore("uiViewMode",3),t="<div class=form-check><input type=radio class=form-check-input id=ui0 name=uiradio value=2 "+(2==e?"checked":"")+"><label class=form-check-label for=ui0>Classic</label></div>";setModalContent("xxAddAgent","User Interface",t+="<div class=form-check><input type=radio class=form-check-input id=ui1 name=uiradio value=3 "+(3==e?"checked":"")+"><label class=form-check-label for=ui1>Modern</label></div>"),showModal("xxAddAgentModal","idx_dlgOkButton",saveUserInterfaceMode),QV("uiMenu",!1)}}function getNodeFromId(e){if(null!=nodes)for(var t in nodes)if(nodes[t]._id==e)return nodes[t];return null}function reload(){var e=window.location.href;e.endsWith("/#")&&(e=e.substring(0,e.length-2)),e.endsWith("#")&&(e=e.substring(0,e.length-1)),window.location.href=e}function onStateChanged(e,t,n,o){if(0==t){if(setDialogMode(0),go(0),powerTimeline=null,powerTimelineReq=null,powerTimelineNode=null,powerTimelineUpdate=null,deviceShares=null,deleteAllNotifications(),hideContextMenu(),QV("verifyEmailId2",!1),QV("logoutControl",!1),"noauth"==o)return void QH("p0span","Невозможно выполнить аутентификацию");if("invalidorigin"==o)return void QH("p0span","Invalid origin in HTTP request");2==n?autoReconnect&&setTimeout(serverPoll,5e3):QH("p0span","Невозможно подключить веб-сокет"),null!=authCookieRenewTimer&&(clearInterval(authCookieRenewTimer),authCookieRenewTimer=null)}else 2==t&&(meshserver.send({action:"usergroups"}),meshserver.send({action:"meshes"}),meshserver.send({action:"nodes",id:"{{currentNode}}",skip:null==devicePagingState?0:devicePagingState.skip}),meshserver.send({action:"loginTokens"}),null!=pluginHandler&&meshserver.send({action:"plugins"}),""=="{{currentNode}}".toLowerCase()&&meshserver.send({action:"files"}),""=="{{viewmode}}".toLowerCase()&&go(1),authCookieRenewTimer=setInterval(function(){meshserver.send({action:"authcookie"})},18e5),40==xxcurrentView&&refreshServerTimelineStats())}function serverPoll(){var e=null;try{e=new XDomainRequest}catch(e){}e||(e=new XMLHttpRequest),e.open("HEAD",window.location.href),e.timeout=15e3,e.onload=function(){e.status<500?reload():setTimeout(serverPoll,1e4)},e.onerror=e.ontimeout=function(){setTimeout(serverPoll,1e4)},e.send()}function detectWindowsBrowser(){var e=window.navigator.userAgent.toUpperCase();return e.indexOf("WINDOWS")>=0||e.indexOf("WIN32")>=0||e.indexOf("WIN64")>=0}function updateSiteAdmin(){var e=parseInt("{{{serverfeatures}}}"),t=userinfo.siteadmin,n=4294967295!=t&&!!(1024&t)||!!(256&features2);QV("p2AccountSecurity",!(4&features||0!=serverinfo.domainauth||!(4096&features)||0!=n)),QV("p2AccountActions",!n),QV("managePhoneNumber1",33554432&features&&67108864&features&&1!=serverinfo.lock2factor),QV("managePhoneNumber2",33554432&features&&!(67108864&features)&&1!=serverinfo.lock2factor),QV("manageMessaging1",33554432&features2&&67108864&features2&&1!=serverinfo.lock2factor),QV("manageMessaging2",33554432&features2&&!(67108864&features2)&&1!=serverinfo.lock2factor),QV("manageEmail2FA",8388608&features&&1!=serverinfo.lock2factor),QV("p2AccountPassActions",!(4&features)&&0==serverinfo.domainauth&&null!=userinfo&&0==userinfo._id.split("/")[2].startsWith("~")),QV("accountCreateLoginTokenSpan",128&features2),QV("p2AccountImageFrame",!n),QV("p2ServerActions",21&t&&!!(143&e)),QV("LeftMenuMyServer",21&t&&!!(64&e)),QV("MainMenuMyServer",21&t),QV("p2ServerActionsBackup",1&t&&!!(1&e)),QV("p2ServerActionsRestore",4&t&&!!(2&e)),QV("p2ServerActionsVersion",16&t&&!!(4&e)),QV("p2ServerActionsErrors",16&t&&!!(8&e)),QV("p2ServerActionsConfig",16&t&&!!(128&e)),QV("MainMenuMyFiles",8&t),QV("LeftMenuMyFiles",8&t),8&t||5!=xxcurrentView||(setDialogMode(0),go(1)),null!=currentNode&&gotoDevice(currentNode._id,xxcurrentView,!0),null!=userinfo.flags&&1&userinfo.flags?(null==userinfo.accountImageRnd&&(userinfo.accountImageRnd=Math.floor(9999999999*Math.random())),Q("p2AccountImage").src="userimage.ashx?rnd="+userinfo.accountImageRnd):Q("p2AccountImage").src="images/user-256.png",2&userinfo.siteadmin?(null==users&&meshserver.send({action:"users"}),null==wssessions&&meshserver.send({action:"wssessioncount"}),mainUpdate(24576)):(users=null,wssessions=null,mainUpdate(16384),(4==xxcurrentView||xxcurrentView>=30&&xxcurrentView<40)&&(setDialogMode(0),go(1),currentUser=null)),meshserver.send({action:"events",limit:parseInt(p3limitdropdown.value)}),QV("ServerConsole",4294967295===userinfo.siteadmin&&!!(16&e)),QV("ServerTrace",4294967295===userinfo.siteadmin&&!!(32&e)),115==xxcurrentView&&4294967295!=userinfo.siteadmin&&go(6),6!=xxcurrentView||21&userinfo.siteadmin||go(1),21&t&&meshserver.send({action:"serverstats",interval:1e4})}check_webp_feature("lossy",function(e,t){webpSupport=t,t||(d7encoding.options[1].disabled=!0,d7encoding.value=1)}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",setNightMode);var updateNaggleTimer=null,updateNaggleFlags=0;function mainUpdate(e){updateNaggleFlags|=e,null==updateNaggleTimer&&(updateNaggleTimer=setTimeout(function(){512&updateNaggleFlags&&center(),1&updateNaggleFlags&&onSearchInputChanged(),2&updateNaggleFlags&&onSortSelectChange(!1),128&updateNaggleFlags&&updateMeshes(),4&updateNaggleFlags&&(updateDevices(),updateDeviceDetails(),21==xxcurrentView&&p21updateMesh()),8&updateNaggleFlags&&drawNotifications(),16&updateNaggleFlags&&32768&features&&updateMapMarkers(),32&updateNaggleFlags&&eventsUpdate(),64&updateNaggleFlags&&32768&features&&refreshMap(!1,!0),256&updateNaggleFlags&&drawDeviceTimeline(),1024&updateNaggleFlags&&deviceEventsUpdate(),2048&updateNaggleFlags&&userEventsUpdate(),4096&updateNaggleFlags&&p20updateMesh(),8192&updateNaggleFlags&&updateUserGroups(),16384&updateNaggleFlags&&updateUsers(),32768&updateNaggleFlags&&updateRecordings(),65536&updateNaggleFlags&&updateLoginTokens(),updateNaggleTimer=null,updateNaggleFlags=0,gotoStartViewPage()},150))}function count2factoraAuths(){if(null==userinfo)return-1;var e=0;return 1==userinfo.otpsecret&&e++,1==userinfo.otpduo&&e++,1==userinfo.otpdev&&e++,userinfo.otphkeys>0&&(e+=userinfo.otphkeys),8388608&features&&1==userinfo.otpekey&&e++,33554432&features&&67108864&features&&null!=userinfo.phone&&e++,33554432&features2&&67108864&features2&&null!=userinfo.msghandle&&e++,e>0&&userinfo.otpkeys>0&&!(262144&features2)&&e++,e}var backupCodesWarningDone=!1;function updateSelf(){var e=count2factoraAuths(),t=4294967295!=userinfo.siteadmin&&!!(1024&userinfo.siteadmin);QV("verifyEmailId",!0!==userinfo.emailVerified&&null!=userinfo.email&&1==serverinfo.emailcheck),QV("verifyEmailId2",!0!==userinfo.emailVerified&&null!=userinfo.email&&1==serverinfo.emailcheck&&0==t),QV("manageOtp",1!=serverinfo.lock2factor&&e>0&&!(262144&features2)),QV("authPhoneNumberCheck",null!=userinfo.phone),QV("authMessagingCheck",null!=userinfo.msghandle),QV("authEmailSetupCheck",1==userinfo.otpekey&&null!=userinfo.email&&1==userinfo.emailVerified),QV("authDuoSetupCheck",1==userinfo.otpduo&&!!(536870912&features2)),QV("authAppSetupCheck",1==userinfo.otpsecret),QV("manageAuthApp",!(1==serverinfo.lock2factor||1!=userinfo.otpsecret&&131072&features2)),QV("manageDuoApp",1!=serverinfo.lock2factor&&!!(536870912&features2)),QV("authKeySetupCheck",userinfo.otphkeys>0),QV("authPushAuthDevCheck",userinfo.otpdev>0&&!!(64&features2)),QV("authCodesSetupCheck",userinfo.otpkeys>0),QV("managePushAuthDev",1!=serverinfo.lock2factor&&64&features2&&e>0),QV("manageHardwareOtp",1!=serverinfo.lock2factor),mainUpdate(4228),0!=backupCodesWarningDone||1!=e||524288&features2||(addNotification({text:"Пожалуйста, добавьте двухфакторные резервные коды. Если текущий фактор потерян, восстановить эту учетную запись будет невозможно.",title:"Двухфакторная аутентификация",tag:"backupcodes"}),backupCodesWarningDone=!0);var n=4294967295==userinfo.siteadmin||!(64&userinfo.siteadmin);if(QV("p2createMeshLink1",n),QV("p2createMeshLink2",n),QV("getStarted1",n),QV("getStarted2",!n),"number"==typeof userinfo.passchange)if(-1==userinfo.passchange)QH("p2nextPasswordUpdateTime"," - Сброс при следующем входе.");else if(null!=passRequirements&&"number"==typeof passRequirements.reset){var o=userinfo.passchange+86400*passRequirements.reset-Math.floor(Date.now()/1e3);if(o<0)QH("p2nextPasswordUpdateTime"," - Сброс при следующем входе.");else if(o<3600){var i=Math.floor(o/60);QH("p2nextPasswordUpdateTime",format(1==i?" - Сброс через 1 минуту.":" - Сброс через {0} минут.",i))}else if(o<86400){var a=Math.floor(o/3600);QH("p2nextPasswordUpdateTime",format(1==a?" - Сброс через 1 час.":" - Сброс через {0} часов.",a))}else{var s=Math.floor(o/86400);QH("p2nextPasswordUpdateTime",format(1==a?" - Сброс через 1 день.":" - Сброс через {0} дней.",s))}}QV("MainMenuMyUsers",null!=users&&!(4&features)||!!(512&userinfo.siteadmin)&&!!(134217728&features)),QV("LeftMenuMyUsers",null!=users&&!(4&features)||!!(512&userinfo.siteadmin)&&!!(134217728&features)),QV("UsersGeneral",null!=users&&!(4&features)),QV("UsersGroups",null!=users&&!(4&features)),QV("UsersRecordings",!!(512&userinfo.siteadmin)&&!!(134217728&features))}function setSessionActivity(){sessionActivity=Date.now(),QH("idleTimeoutNotify","")}function checkIdleSessionTimeout(){var e=Date.now()-sessionActivity;if(e>serverinfo.timeout)null!=desktop&&(desktop.Stop(),webRtcDesktopReset(),desktopNode=desktop=null,null!=pluginHandler&&pluginHandler.callHook("onDesktopDisconnect")),null!=terminal&&(terminal.Stop(),terminal=null),null!=files&&(files.Stop(),files=null),serverinfo.logoutonidlesessiontimeout&&(window.location.href="logout");else{var t=Math.round((serverinfo.timeout-e)/1e3),n=null!=desktop||null!=terminal||null!=files,o=serverinfo.logoutonidlesessiontimeout||n,i=serverinfo.logoutonidlesessiontimeout,a="";t<=60?a=i?1==t?"1 секунда до выхода":"{0} секунды до выхода":1==t?"1 секунда до разъединения":"{0} секунд до разъединения":(t=Math.round(t/60))<=5&&(a=i?1==t?"1 минута до выхода":"{0} минут до выхода":1==t?"1 минута до разъединения":"{0} минут до разъединения"),QH("idleTimeoutNotify",o&&a?"<br />"+format(a,t):"")}}function onMessage(e,t){switch(t.action){case"trace":serverTrace.unshift(t),displayServerTrace();break;case"intersession":"removeNotify"==t.subaction&&notificationDelete(t.id);break;case"traceinfo":"object"==typeof t.traceSources&&(null!=t.traceSources&&t.traceSources.length>0?(serverTraceSources=t.traceSources,QH("p41traceStatus",EscapeHtml(t.traceSources.join(", ")))):(serverTraceSources=[],QH("p41traceStatus","Пусто")));break;case"serverstats":updateGeneralServerStats(t);break;case"serverwarnings":if(null!=t.warnings&&t.warnings.length>0){var n={1:"",2:"Отсутствуют параметры WebDAV.",3:'Неизвестный параметр конфигурации "{0}".',4:"Сжатие WebSocket отключено, эта функция не работает в NodeJS v11..с 11 по 12 версию.15 и v13.2",5:"Не удалось загрузить корневой сертификат Intel AMT TLS для домена по умолчанию.",6:"Не удалось загрузить корневой сертификат Intel AMT TLS для домена {0}.",7:"Локальные полные доменные имена CIRA игнорируются, когда сервер находится в режиме LAN-only или WAN-only.",8:"Локальных полных доменных имен CIRA не может быть более 4. Игнорируем значение.",9:"Проверка хэша агента пропущена, это небезопасно.",10:"Отсутствует адрес электронной почты Let's Encrypt.",11:"Недопустимые имена хостов Let's Encrypt.",12:"Недопустимые имена Let's Encrypt, имена не могут содержать *.",13:"Не удалось настроить модуль Let's Encrypt.",14:"Недопустимые имена Let's Encrypt, не удалось разрешить: {0}",15:"Недопустимый адрес электронной почты Let's Encrypt, не удалось разрешить: {0}",16:"Не удалось загрузить список IPv6 адресов доверенных прокси-серверов CloudFlare.",17:"Сервер SendGrid имеет ограниченное применение в LAN режиме.",18:"SMTP-сервер имеет ограниченное применение в LAN режиме.",19:"SMS-шлюз имеет ограниченное применение в LAN режиме.",20:'Некорректный "LoginCookieEncryptionKey" в config.json.',21:"Путь резервного копирования не может в папке meshcentral-data, параметры резервного копирования игнорируются.",22:"Failed to sign agent {0}: {1}",23:"Unable to load agent icon file: {0}.",24:"Unable to load agent logo file: {0}.",25:"This NodeJS version does not support OpenID.",26:"This NodeJS version does not support Discord.js.",27:"Firebase now requires a service account JSON file, Firebase disabled."},o="";for(var i in t.warnings){if("string"==typeof(s=t.warnings[i]))o+="<div style=color:red;padding-bottom:6px><b>ВНИМАНИЕ: "+s+"</b></div>";else null==(l=n[s.id])?l=s.msg:null!=s.args&&(l=format(l,...s.args)),o+="<div style=color:red;padding-bottom:6px><b>ВНИМАНИЕ: "+l+"</b></div>"}QH("serverWarnings",o),QV("serverWarningsDiv",!0)}break;case"servertimelinestats":setServerTimelineStats(t.events);break;case"authcookie":authCookie=t.cookie,authRelayCookie=t.rcookie;break;case"serverinfo":if((serverinfo=t.serverinfo).timeout&&(setInterval(checkIdleSessionTimeout,1e4),checkIdleSessionTimeout()),1==debugmode&&console.log("Server time: ",printDateTime(new Date(serverinfo.serverTime))),setupServiceWorker(),null!=serverinfo.certExpire){var a=Math.floor((serverinfo.certExpire-Date.now())/864e5);a>=0&&a<20&&(QH("serverCertWarnings","<div style=color:red;padding-bottom:6px><b>ВНИМАНИЕ: "+format("Срок действия сертификата истекает через {0} дн.",a)+"</b></div>"),QV("serverWarningsDiv",!0),addNotification({text:format("Срок действия сертификата истекает через {0} дн.",a)}))}if(serverinfo.preConfiguredRemoteInput){o="";for(var i in serverinfo.preConfiguredRemoteInput)o+='<div class="cmtext" onclick="cmdeskpreconfigtypeaction('+i+',event)">'+EscapeHtml(serverinfo.preConfiguredRemoteInput[i].name)+"</div>";""!=o&&(o+="<hr />"),QH("deskPreConfigShortcutContextMenu1",o)}if(serverinfo.preConfiguredScripts){o="";var s="";for(var i in serverinfo.preConfiguredScripts){var r=serverinfo.preConfiguredScripts[i],l='<div class="cmtext" onclick="cmdeskpreconfigscriptaction('+i+',event)">'+EscapeHtml(serverinfo.preConfiguredScripts[i].name)+"</div>";3!=r.type&&(o+=l),r.type>=3&&(s+=l)}QH("deskPreConfigScriptContextMenu1",o),QH("deskPreConfigScriptContextMenu2",s)}break;case"userinfo":userinfo=t.userinfo,updateSiteAdmin(),updateSelf();break;case"users":for(var d in users={},t.users)users[t.users[d]._id]=t.users[d];null!=currentUser&&(currentUser=users[currentUser._id]),mainUpdate(16384),updateSelf();break;case"wssessioncount":wssessions=t.wssessions,mainUpdate(16384);break;case"meshes":for(var d in meshes={},t.meshes)meshes[t.meshes[d]._id]=t.meshes[d];null!=currentMesh&&(currentMesh=meshes[currentMesh._id]),mainUpdate(132);break;case"usergroups":var c=0;if(Array.isArray(t.ugroups)){for(var i in usergroups={},t.ugroups)c++,usergroups[t.ugroups[i]._id]=t.ugroups[i];0==c&&(usergroups=null)}else{for(var i in usergroups=t.ugroups,t.ugroups)c++,t.ugroups[i]._id=i;0==c&&(usergroups=null)}mainUpdate(8192);break;case"files":filetree=setupBackPointers(t.filetree),updateFiles(),d3updatefiles();break;case"nodes":for(var d in nodes=[],t.nodes)for(var u in t.nodes[d])null!=t.nodes[d][u]._id?(null==t.nodes[d][u].name&&(t.nodes[d][u].name="???"),t.nodes[d][u].namel=t.nodes[d][u].name.toLowerCase(),t.nodes[d][u].rname?t.nodes[d][u].rnamel=t.nodes[d][u].rname.toLowerCase():t.nodes[d][u].rnamel=t.nodes[d][u].namel,t.nodes[d][u].meshnamel=meshes[d]?meshes[d].name.toLowerCase():"*",t.nodes[d][u].meshid=d,t.nodes[d][u].state=t.nodes[d][u].state?t.nodes[d][u].state:0,t.nodes[d][u].icon||(t.nodes[d][u].icon=1),t.nodes[d][u].ident=++nodeShortIdent,nodes.push(t.nodes[d][u])):console.log("Invalid node ("+u+"): "+JSON.stringify(t.nodes));for(var i in stars)null==getNodeFromId(i)&&delete stars[i];null!=currentNode&&0==IsNodeViewable(currentNode)&&(currentNode=null,go(1)),null!=currentNode&&(null!=(currentNode=getNodeFromId(currentNode._id))?gotoDevice(currentNode._id,xxcurrentView,!0):go(1)),devicePagingState=null==t.totalcount?null:{total:t.totalcount,skip:t.skip,limit:t.limit},updateDevicePageState(),mainUpdate(71);break;case"powertimeline":if(t.nodeid!=powerTimelineReq)break;for(var i in powerTimelineNode=t.nodeid,powerTimeline=t.timeline,powerTimelineUpdate=Date.now()+3e5,powerTimeline)i%2==1&&(powerTimeline[i]=1e3*powerTimeline[i]);currentNode._id==t.nodeid&&mainUpdate(256);break;case"deviceShares":if(t.nodeid!=deviceSharesReq)break;deviceSharesNode=t.nodeid,deviceShares=t.deviceShares,null!=currentNode&&currentNode._id==t.nodeid&&gotoDevice(currentNode._id,xxcurrentView,!0);break;case"deviceMeshShares":if(t.meshid!=deviceSharesReq)break;deviceSharesNode=t.meshid,deviceShares=t.deviceShares,null!=currentMesh&&currentMesh._id==t.meshid&&p20updateMesh();break;case"getsysinfo":if(t.nodeid!=powerTimelineReq)break;!0===t.noinfo?updateDeviceDetails(getNodeFromId(t.nodeid)):updateDeviceDetails(getNodeFromId(t.nodeid),t.hardware);break;case"lastconnect":null!=(ie=getNodeFromId(t.nodeid))&&(ie.lastconnect=t.time,ie.lastaddr=t.addr,currentNode._id==ie._id&&""==Q("MainComputerState").innerHTML&&null!=ie.lastconnect&&QH("MainComputerState","<span>Последнее посещение:<br />"+printDateTime(new Date(ie.lastconnect))+"</span>"));break;case"lastconnects":var p=Object.keys(t.lastconnects);for(var i in p){var m=p[i];null!=(ie=getNodeFromId(m))&&(ie.lastconnect=t.lastconnects[m])}mainUpdate(4);case"msg":if(null!=t.nodeid){var g=-1;if(null!=nodes)for(var i in nodes)if(nodes[i]._id==t.nodeid){g=i;break}if(-1!=g)if("cpuinfo"===t.type&&null!=currentNode&&currentNode._id==t.nodeid){var v=Date.now()/1e3,h=0,f=0;"number"==typeof t.cpu.total&&(h=t.cpu.total),"number"==typeof t.memory.percentConsumed&&(f=t.memory.percentConsumed),deviceDetailsStatsData.push([v,h,f]),deviceDetailsStatsDraw(t)}else if("console"===t.type)p15consoleReceive(nodes[g],t.value,t.source);else if("notify"===t.type){if(!(8&(u=getstore("notifications",0)))&&null!=t.amtMessage)break;u={text:t.value,title:t.title,icon:t.icon,titleid:t.titleid,msgid:t.msgid,args:t.args};null!=t.id&&(u.id=t.id),null!=t.nodeid&&(u.nodeid=t.nodeid),null!=t.tag&&(u.tag=t.tag),null!=t.url&&(u.url=t.url),null!=t.username&&(u.username=t.username),"number"==typeof t.maxtime&&(u.maxtime=t.maxtime),addNotification(u)}else if("ps"===t.type)showDeskToolsProcesses(t);else if("services"===t.type)showDeskToolsServices(t);else if("service"===t.type)showServiceDetailsDialog(t);else if("getclip"===t.type&&null!=currentNode&&currentNode._id==t.nodeid)1==t.tag&&"clipboard"===xxdialogTag?Q("d2clipText").value=t.data:2===t.tag&&null!=navigator.clipboard&&navigator.clipboard.writeText(t.data).then(function(){}).catch(function(e){console.log(e)});else if("setclip"===t.type&&"clipboard"===xxdialogTag&&null!=currentNode&&currentNode._id==t.nodeid)QH("dlgClipStatus",t.success?"<span style=color:green>Успешно</span>":"<span style=color:red>Не удалось</span>"),setTimeout(function(){try{QH("dlgClipStatus","")}catch(e){}},2e3);else if("userSessions"===t.type&&null!=currentNode&&currentNode._id===t.nodeid&&null==desktop){var x=[];if(null!=t.data)for(var i in t.data)"Active"!=t.data[i].State&&"Connected"!=t.data[i].State&&"Console"!=t.data[i].StationName&&3!=debugmode||x.push(t.data[i]);if(0===x.length)connectDesktop(null,1,null,t.tag);else if(1===x.length)connectDesktop(null,1,x[0].SessionId,t.tag);else{o="";var k="{{{userSessionsSort}}}";for(var i in x.sort(function(e,t){return e[k]?t[k]?e[k]<t[k]?-1:e[k]>t[k]?1:0:1:-1}),x)o+='<div style="text-align:left;cursor:pointer;background-color:gray;margin:5px;padding:5px;border-radius:5px" onclick=connectDesktop(event,1,'+x[i].SessionId+","+t.tag+")>"+x[i].State+(x[i].StationName?", "+x[i].StationName:""),x[i].Username&&(x[i].Domain?o+=" - "+x[i].Domain+"/"+x[i].Username:o+=" - "+x[i].Username),o+="</div>";QH("p11DeskSessionSelector",o),QV("p11DeskSessionSelector",!0)}}else if("psinfo"===t.type){if(xxdialogTag==="ps|"+t.nodeid+"|"+t.pid){o="<div style=max-height:200px;overflow-y:auto>";"object"==typeof t.value&&Object.keys(t.value).length>0?(t.value=jsonToCamel(t.value),!t.value.cmd&&t.value.path&&(t.value.cmd=t.value.path),!t.value.processUser&&t.value.userName&&(t.value.processUser=t.value.userName.split("\\")[1]),!t.value.processDomain&&t.value.userName&&(t.value.processDomain=t.value.userName.split("\\")[0]),t.value.processName&&(o+="<div style=padding:4px><div style=padding-bottom:4px>Имя процесса</div><div style=word-wrap:break-word;padding-left:6px><b>"+t.value.processName+"</b></div></div>"),t.value.machineName&&(o+=addHtmlValue5("Имя машины",t.value.machineName)),t.value.cmd&&(o+="<div style=padding:4px><div style=padding-bottom:4px>Командная строка</div><div style=word-wrap:break-word;padding-left:6px><b>"+t.value.cmd+"</b></div></div>"),t.value.mainWindowTitle&&(o+="<div style=padding:4px><div style=padding-bottom:4px>Заголовок окна</div><div style=word-wrap:break-word;padding-left:6px><b>"+t.value.mainWindowTitle+"</b></div></div>"),t.value.processUser&&(o+=addHtmlValue5("Пользователь",t.value.processUser)),t.value.processDomain&&(o+=addHtmlValue5("Домен",t.value.processDomain)),t.value.startTime&&(o+=addHtmlValue5("Время начала",t.value.startTime)),o+="<hr />",t.value.PriorityBoostEnabled&&(o+=addHtmlValue5("Повышение приоритета",t.value.PriorityBoostEnabled?"Включено":"Отключено")),t.value.sessionId&&(o+=addHtmlValue5("Идентификатор сессии",t.value.sessionId)),t.value.handleCount&&(o+=addHtmlValue5("Счетчик ручки",t.value.handleCount)),t.value.privilegedProcessorTime&&(o+=addHtmlValue5("Время привилегированного процессора",format("{0} секунд",t.value.privilegedProcessorTime))),t.value.totalProcessorTime&&(o+=addHtmlValue5("Общее время процессора",format("{0} секунд",t.value.totalProcessorTime))),t.value.userProcessorTime&&(o+=addHtmlValue5("Время пользовательского процессора",format("{0} секунд",t.value.userProcessorTime))),t.value.nonpagedSystemMemorySize&&(o+=addHtmlValue5("Невыгружаемая память",getNiceSize2(t.value.nonpagedSystemMemorySize))),t.value.pagedMemorySize&&(o+=addHtmlValue5("Страничная память",getNiceSize2(t.value.pagedMemorySize))),t.value.privateMemorySize&&(o+=addHtmlValue5("Частная память",getNiceSize2(t.value.privateMemorySize))),t.value.virtualMemorySize&&(o+=addHtmlValue5("Виртуальная память",getNiceSize2(t.value.virtualMemorySize))),t.value.workingSet&&(o+=addHtmlValue5("Рабочий набор",getNiceSize2(t.value.workingSet))),t.value.peakWorkingSet&&(o+=addHtmlValue5("Пиковый рабочий набор",getNiceSize2(t.value.peakWorkingSet))),t.value.peakPagedMemorySize&&(o+=addHtmlValue5("Пиковая выгружаемая память",getNiceSize2(t.value.peakPagedMemorySize))),t.value.peakVirtualMemorySize&&(o+=addHtmlValue5("Пиковая виртуальная память",getNiceSize2(t.value.peakVirtualMemorySize)))):o+="Информация не предоставлена",o+="</div>",QH("id_dialogOptions",o)}}else"deskBackground"===t.type&&(""!=t.data?Q("DeskBackgroundButtonImage").style.color="":Q("DeskBackgroundButtonImage").style.color="red")}else if("notify"===t.type){u={text:t.value,title:t.title,icon:t.icon,titleid:t.titleid,msgid:t.msgid,args:t.args};null!=t.id&&(u.id=t.id),null!=t.tag&&(u.tag=t.tag),null!=t.url&&(u.url=t.url),null!=t.username&&(u.username=t.username),"number"==typeof t.maxtime&&(u.maxtime=t.maxtime),addNotification(u)}break;case"getnetworkinfo":if(currentNode._id!=t.nodeid)return;if(updateDeviceDetails(getNodeFromId(t.nodeid),null,t),2==xxdialogMode&&xxdialogTag=="if"+t.nodeid){o="<div class=dialogText>";if(currentNode.lastconnect&&(o+=addHtmlValue2("Последнее подключение агента",printDateTime(new Date(currentNode.lastconnect)))),currentNode.lastaddr){var y=currentNode.lastaddr.split(":");y.length>2?o+=addHtmlValue2("Последний адрес агента",currentNode.lastaddr+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(currentNode.lastaddr)+'")></i>'):isPrivateIP(currentNode.lastaddr)?o+=addHtmlValue2("Последний адрес агента",y[0]+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(y[0])+'")></i>'):o+=addHtmlValue2("Последний адрес агента",'<a href="https://iplocation.com/?ip='+y[0]+'" rel="noreferrer noopener" target="MeshIPLoopup">'+y[0]+'</a> <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(y[0])+'")></i>')}if(null!=t.updateTime&&(o+=addHtmlValue2("Последнее обновление интерфейсов",printDateTime(new Date(t.updateTime)))),null!=t.netif)for(var i in t.netif){o+="<hr />",(b=t.netif[i]).name&&(o+=addHtmlValue2("Имя","<b>"+EscapeHtml(b.name)+"</b>")),b.desc&&(o+=addHtmlValue2("Описание",EscapeHtml(b.desc).replace("(R)","&reg;").replace("(r)","&reg;"))),b.dnssuffix&&(o+=addHtmlValue2("DNS-суффикс",EscapeHtml(b.dnssuffix)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать имя в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(b.dnssuffix)+'")></i>')),b.mac&&(o+=addHtmlValue2("MAC адрес",'<a href="https://maclookup.app/search/result?mac='+b.mac.substring(0,6)+'" rel="noreferrer noopener" target="MeshMACLoopup">'+EscapeHtml(b.mac.toLowerCase())+'</a> <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать МАС адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(b.mac.toLowerCase())+'")></i>')),b.v4addr&&(o+=addHtmlValue2("IPv4 адрес",EscapeHtml(b.v4addr)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(b.v4addr)+'")></i>')),b.v4mask&&(o+=addHtmlValue2("IPv4 маска",EscapeHtml(b.v4mask)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(b.v4mask)+'")></i>')),b.v4gateway&&(o+=addHtmlValue2("IPv4 шлюз",EscapeHtml(b.v4gateway)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(b.v4gateway)+'")></i>')),b.gatewaymac&&(o+=addHtmlValue2("MAC шлюза",'<a href="https://maclookup.app/search/result?mac='+b.gatewaymac.substring(0,6)+'" rel="noreferrer noopener" target="MeshMACLoopup">'+EscapeHtml(b.gatewaymac.toLowerCase())+'</a> <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать МАС адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(b.gatewaymac.toLowerCase())+'")></i>'))}else if(null!=t.netif2)for(var i in t.netif2){var b=t.netif2[i];if(!(0==Array.isArray(b)||b.length<1||null==b[0]||"string"==typeof b[0].mac&&b[0].mac.startsWith("00:00:00:00"))){o+="<hr />",o+=addHtmlValue2("Имя","<b>"+EscapeHtml(i)+"</b>"),"string"==typeof b[0].mac&&(o+=addHtmlValue2("MAC адрес",'<a href="https://maclookup.app/search/result?mac='+b[0].mac.split(":").join("").substring(0,6)+'" rel="noreferrer noopener" target="MeshMACLoopup">'+EscapeHtml(b[0].mac.toLowerCase())+'</a> <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать МАС адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(b[0].mac.toLowerCase())+'")></i>')),b[0].fqdn&&(o+=addHtmlValue2("FQDN",b[0].fqdn));for(var w=0;w<b.length;w++){var M=b[w];"IPv6"==M.family?(M.address&&(o+=addHtmlValue2("IPv6-адрес",EscapeHtml(M.address)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(M.address)+'")></i>')),M.netmask&&(o+=addHtmlValue2("Маска IPv6",EscapeHtml(M.netmask)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(M.netmask)+'")></i>')),M.gateway&&(o+=addHtmlValue2("Шлюз IPv6",EscapeHtml(M.gateway)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(M.gateway)+'")></i>'))):"IPv4"==M.family&&(M.address&&(o+=addHtmlValue2("IPv4 адрес",EscapeHtml(M.address)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(M.address)+'")></i>')),M.netmask&&(o+=addHtmlValue2("IPv4 маска",EscapeHtml(M.netmask)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(M.netmask)+'")></i>')),M.gateway&&(o+=addHtmlValue2("IPv4 шлюз",EscapeHtml(M.gateway)+' <i class="fa-fw fa-regular fa-clipboard fa-sm" role=button title="Скопировать адрес в буфер обмена" onclick=copyTextToClip2("'+encodeURIComponentEx(M.gateway)+'")></i>')))}}}else o+="<hr />",o+="Информации о сетевых интерфейсах этого устройства нет.";o+="</div>",QH("d2netinfo",o)}break;case"serverversion":if(2==xxdialogMode&&"MeshCentralServerUpdate"==xxdialogTag){o="<div class=dialogText>";t.tags.current||(t.tags.current="Неизвестно"),t.tags.stable||(t.tags.stable="Неизвестно"),t.tags.latest||(t.tags.latest="Неизвестно"),o+=addHtmlValue2("Текущая версия","<b>"+EscapeHtml(t.tags.current)+"</b>"),o+="<hr />",o+=addHtmlValue2('<label><input id=d2updateCheck1 type=checkbox class="form-check-input me-2" onclick=server_showVersionDlgUpdate()'+("Неизвестно"!=t.tags.stable&&t.tags.current!=t.tags.stable&&2048&features?"":" disabled")+" /> Стабильная версия</label>","<b>"+EscapeHtml(t.tags.stable)+"</b>"),o+=addHtmlValue2('<label><input id=d2updateCheck2 type=checkbox class="form-check-input me-2" onclick=server_showVersionDlgUpdate()'+("Неизвестно"!=t.tags.latest&&t.tags.current!=t.tags.latest&&2048&features?"":" disabled")+" /> Последняя версия</label>","<b>"+EscapeHtml(t.tags.latest)+"</b>"),o+="</div>",(t.tags.current!=t.tags.latest||t.tags.current!=t.tags.stable)&&2048&features?(o+="<hr />Установите флажок и нажмите ОК для начала самообновления.",xxdialogTag=t.tags,setModalContent("xxAddAgent","Версия MeshCentral",o),showModal("xxAddAgentModal","idx_dlgOkButton",function(){server_showVersionDlgEx(2,t.tags)}),server_showVersionDlgUpdate()):(setModalContent("xxAddAgent","Версия MeshCentral",o),showModal("xxAddAgentModal","idx_dlgOkButton"))}break;case"servererrors":if(2==xxdialogMode&&"MeshCentralServerErrors"==xxdialogTag)if(null==t.data)setModalContent("xxAddAgent","Server Errors","На сервере нет журнала ошибок."),showModal("xxAddAgentModal","idx_dlgOkButton");else{o='<div class="dialogText dialogTextLog"><pre id=d2ServerErrorsLogPre>'+EscapeHtml(t.data)+"</pre></div>";o+='<br /><div style=float:right><i role=button class="fa-fw fa-solid fa-download fa-sm" title="Скачать журнал ошибок" onclick=d2CopyServerErrorsToClip()></i></div>',setModalContent("xxAddAgent","Ошибки сервера MeshCentral",o+='<div><label><input id=d2clearErrorsCheck type=checkbox class="form-check-input me-2" onclick=server_showErrorsDlgUpdate() /> Установите флажок и нажмите ОК для очищения журнала ошибок.</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",server_showErrorsDlgEx),server_showErrorsDlgUpdate()}break;case"serverconfig":2==xxdialogMode&&"MeshCentralServerConfig"==xxdialogTag&&(null==t.data?setModalContent("xxAddAgent","Server Configuration","Server has no config file.","extra-large"):(setModalContent("xxAddAgent","Server Configuration",4,"extra-large"),QV("d4EncodingButton",!1),QV("d4LineBreakButton",!1),Q("d4editorarea").value=t.data,Q("d4editorarea").setAttribute("readonly","readonly")),showModal("xxAddAgentModal","idx_dlgOkButton"));break;case"serverconsole":p15consoleReceive("serverconsole",t.value);break;case"events":null!=t.nodeid&&null!=currentNode&&t.nodeid==currentNode._id?(currentDeviceEvents=t.events,mainUpdate(1024)):null!=t.userid&&null!=currentUser&&t.userid==currentUser._id?(currentUserEvents=t.events,mainUpdate(2048)):(events=t.events,mainUpdate(32));break;case"recordings":p52recordings=t.events,null!=t.error&&(p52recordings=t.error),updateRecordings();break;case"getcookie":if("MCRouter"==t.tag){(-1==(ue=serverinfo.name).indexOf(".")||2&features)&&(ue=window.location.hostname);domainUrl.substring(0,domainUrl.length-1);var C="mcrouter://"+ue+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"control.ashx?c="+authCookie+"&t="+serverinfo.tlshash+"&l={{{lang}}}"+(urlargs.key?"&key="+urlargs.key:"");null!=t.nodeid&&(C+="&nodeid="+t.nodeid),null!=t.tcpport&&(C+="&protocol=1&remoteport="+t.tcpport),t.localRelay&&(C+="&local=1"),t.localport&&(C+="&localport="+t.localport),null!=t.name&&(C+="&name="+encodeURIComponentEx(t.name)),null!=t.ip&&(C+="&remoteip="+t.ip),downloadFile(C+="&appid="+t.protocol+"&autoexit=1","")}else if("novnc"==t.tag){var S=window.location.origin+domainUrl+"novnc/vnc.html?ws=wss%3A%2F%2F"+window.location.host+encodeURIComponentEx(domainUrl)+(t.localRelay?"local":"mesh")+"relay.ashx%3Fauth%3D"+t.cookie+"&show_dot=1"+(urlargs.key?"&key="+urlargs.key:"")+"&l={{{lang}}}";null!=(ie=getNodeFromId(t.nodeid))&&(S+="&name="+encodeURIComponentEx(ie.name)),safeNewWindow(S,"mcnovnc/"+t.nodeid)}else if("mstsc"==t.tag){var A=window.location.origin+domainUrl+"mstsc.html?ws="+t.cookie+(urlargs.key?"&key="+urlargs.key:"");null!=(ie=getNodeFromId(t.nodeid))&&(A+="&name="+encodeURIComponentEx(ie.name)),t.localRelay&&(A+="&local=1"),safeNewWindow(A,"mcmstsc/"+t.nodeid)}else if("ssh"==t.tag){var D=window.location.origin+domainUrl+"ssh.html?ws="+t.cookie+(urlargs.key?"&key="+urlargs.key:"");null!=(ie=getNodeFromId(t.nodeid))&&(D+="&name="+encodeURIComponentEx(ie.name)),t.localRelay&&(D+="&local=1"),safeNewWindow(D,"mcssh/"+t.nodeid)}break;case"getNotes":if((u=Q("d2devNotes"))&&t.id==decodeURIComponent(u.attributes.noteid.value))t.notes?QH("d2devNotes",decodeURIComponent(t.notes)):QH("d2devNotes",""),0==("true"==u.attributes.ro.value)&&(u.removeAttribute("readonly"),QE("idx_dlgOkButton",!0),QV("idx_dlgOkButton",!0),focusTextBox("d2devNotes"));else Q("notesPanelArea").innerHTML=t.notes&&marked&&DOMPurify?DOMPurify.sanitize(marked.parse(decodeURIComponent(t.notes),{breaks:!0}),{USE_PROFILES:{html:!0}}):"","true"===showNotesPanel&&t.notes?QV("notesPanel",!0):QV("notesPanel",!1);break;case"otpauth-request":if(2==xxdialogMode&&"otpauth-request"==xxdialogTag)if(null!=t.err){var T=["","2FA заблокирована","Резервные коды заблокированы","Токен входа используется","Двухфакторная аутентификация одноразовым паролем не разрешена","Аккаунт заблокирован","Не удалось загрузить OTPLIB"];t.err>0&&t.err<T.length?QH("d2optinfo",T[t.err]):QH("d2optinfo",format("Ошибка  #{0}",t.err))}else{var E=t.secret;52==E.length?E=E.split(/(.............)/).filter(Boolean).join(" "):32==E.length&&(E=(E=E.split(/(....)/).filter(Boolean).join(" ")).substring(0,20)+"<br/>"+E.substring(20)),QH("d2optinfo","<table><tr><td style=vertical-align:top>"+format('Установка <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2" rel="noreferrer noopener" target=_blank>Google Authenticator</a> или совместимое приложение и отсканируйте штрих-код, используйте <a href="{0}" rel="noreferrer noopener" target=_blank>эту ссылку</a> или введите ключ. Затем введите ниже текущий токен из 6 цифр для активации двухфакторной авторизации.',t.url)+'<br /><br />Secret <img src=images/link4.png height=10 width=10 title="Copy Secret to clipboard" style=cursor:pointer onclick=d2CopySecretToClip()><br /><tt id=d2optsecret secret="'+t.secret+'" style=font-size:12px>'+E+'</tt><br /><br /></td><td style=width:1px;vertical-align:top><a href="'+t.url+'" rel="noreferrer noopener" target=_blank><div id="qrcode"></div></a></td><tr><td colspan=2 style="text-align:center;border-top:1px solid black"><br />Для двухэтапного входа введите токен здесь: <input type=text autocomplete="one-time-code" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" onkeyup=account_addOtpCheck(event) onkeydown=account_addOtpCheck() maxlength=6 id=d2otpauthinput type=text></td></table>'),new QRCode(Q("qrcode"),{text:t.url,width:128,height:128,colorDark:"#000000",colorLight:"#EEE",correctLevel:QRCode.CorrectLevel.H}),QV("idx_dlgOkButton",!0),QE("idx_dlgOkButton",!1),Q("d2otpauthinput").focus()}break;case"otpauth-setup":if(xxdialogMode)return;setModalContent("xxAddAgent","Приложение-аутентификатор",t.success?"<b style=color:green>Приложение для аутентификации активированно успешно.</b> Теперь вам понадобится действительный токен, чтобы снова войти в систему.":"<b style=color:red>Активация двухэтапного входа не удалась.</b> Удалите ключ из приложения и попробуйте еще раз. У вас есть всего несколько минут, чтобы ввести правильный код."),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"otpauth-clear":if(xxdialogMode)return;setModalContent("xxAddAgent","Приложение-аутентификатор",t.success?"<b>Приложение для аутентификации удалено.</b> Вы можете возобновить эту функцию в любое время.":"<b style=color:red>Удаление активации двухэтапного входа не удалось.</b> Попытайтесь снова."),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"otpauth-getpasswords":if(2==xxdialogMode&&"otpauth-manage"!=xxdialogTag)return;o="Однократные токены можно использовать как вторичную аутентификацию. Сгенерируйте, распечатайте и храните их в надежном месте.";if(o+='<div style="border-radius:6px;border: 2px dashed #888;width:100%;margin-top:8px"><div style="padding:8px;font-family:Arial, Helvetica, sans-serif;font-size:20px;font-weight:bold"><table class=selecttext style=width:100%;text-align:center>',t.passwords){w=0;var _="";for(var i in t.passwords){++w%2&&(o+="<tr>");for(var N=""+t.passwords[i].p;N.length<8;)N="0"+N;!0===t.passwords[i].u?(o+="<td>"+N.substring(0,4)+"&nbsp;"+N.substring(4),""!=_&&(_+=" "),_+=N):o+="<td><strike style=color:#BBB>"+N.substring(0,4)+"&nbsp;"+N.substring(4)}}else o+="<tr><td>Активных токенов нет";o+="</table></div></div><br />",o+='<div class="btn-group">',o+='<button type=button class="btn btn-warning" onclick="account_manageOtp(1);">Генерация новых токенов</input>',null!=t.passwords?(o+='<button type=button class="btn btn-danger" onclick="account_manageOtp(2);">Очистить токены</button></div>',o+='&nbsp;<i class="fa-regular fa-clipboard" title="Скопировать действительные коды в буфер обмена" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(_)+'")></i>'):o+="</div>",xxdialogTag="otpauth-manage",setModalContent("xxAddAgent","Управление резервными кодами",o),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"otp-hkey-get":if(xxdialogMode&&"otpauth-hardware-manage"!=xxdialogTag)return;var I='<div style="border-radius:6px;border:2px solid #CCC;background-color:#BBB;width:100%;box-sizing:border-box;margin-bottom:6px"><div style="margin:3px;font-family:Arial, Helvetica, sans-serif;font-size:16px;font-weight:bold"><table style=width:100%;text-align:left>',V="</table></div></div>";o='<a href="https://www.yubico.com/" rel="noreferrer noopener" target="_blank">Аппаратные ключи</a> используются в качестве дополнительной аутентификации.';if(o+='<div class="backgroundContainer" style="max-height:150px;overflow-y:auto;overflow-x:hidden;margin-top:6px;margin-bottom:6px">',t.keys&&t.keys.length>0)for(var i in t.keys){var U=t.keys[i];o+=I+'<tr style=margin:5px><td style=width:30px><img width=24 height=18 src="images/hardware-key-'+(me=2==U.type?"OTP":"WebAuthn")+'-24.png" style=margin-top:4px><td style=width:250px>'+U.name+'<td style=text-align:right><button type=button class="btn btn-danger" onclick=account_removehkey('+U.i+")>Удалить</button>"+V}else o+=I+"<tr style=text-align:center><td>Ключи не настроены"+V;o+="</div>",o+="<div>";var R="number"==typeof userinfo.otphkeys?userinfo.otphkeys:0;"number"!=typeof serverinfo.maxfidokeys||serverinfo.maxfidokeys>R?(131072&features&&(o+='<button class="btn btn-primary" id=d2addkey3 type=button onclick="account_addhkey(3);">Добавить ключ</input>'),16384&features&&(o+='<button class="btn btn-primary" id=d2addkey2 type=button onclick="account_addhkey(2);">Добавить YubiKey&reg; OTP</input>')):o+="Достигнуто максимальное количество ключей.",xxdialogTag="otpauth-hardware-manage",setModalContent("xxAddAgent","Управление ключами безопасности",o+="</div><br />"),showModal("xxAddAgentModal","idx_dlgOkButton"),0==u2fSupported()&&QE("d2addkey1",!1);break;case"otp-hkey-yubikey-add":t.result?meshserver.send({action:"otp-hkey-get"}):(setModalContent("xxAddAgent","Добавить ключ безопасности","<br />Ошибка, Невозможно добавить код.<br /><br />"),showModal("xxAddAgentModal","idx_dlgOkButton"));break;case"otp-hkey-setup-response":if(xxdialogMode&&"otpauth-hardware-manage"!=xxdialogTag)return;1==t.result?meshserver.send({action:"otp-hkey-get"}):(setModalContent("xxAddAgent","Добавить ключ безопасности","<br />Ошибка, Невозможно добавить код.<br /><br />"),showModal("xxAddAgentModal","idx_dlgOkButton"));break;case"webauthn-startregister":if(xxdialogMode&&"otpauth-hardware-manage"!=xxdialogTag)return;setModalContent("xxAddAgent","Добавить ключ безопасности",o='Нажмите кнопку ключа сейчас.<br /><br /><div style=width:100%;text-align:center><img width=120 height=117 src="images/hardware-keypress-120.png" /></div><input id=dp1keyname style=display:none value='+t.name+" />");var H=t.request;t.request.challenge=Uint8Array.from(atob(t.request.challenge),function(e){return e.charCodeAt(0)}),t.request.user.id=Uint8Array.from(atob(t.request.user.id),function(e){return e.charCodeAt(0)}),navigator.credentials.create({publicKey:H}).then(function(e){meshserver.send({action:"webauthn-endregister",response:{rawId:btoa(String.fromCharCode.apply(null,new Uint8Array(e.rawId))),response:{attestationObject:btoa(String.fromCharCode.apply(null,new Uint8Array(e.response.attestationObject))),clientDataJSON:btoa(String.fromCharCode.apply(null,new Uint8Array(e.response.clientDataJSON)))},type:e.type}})},function(e){console.log("ОШИБКА:"+e),setModalContent("xxAddAgent","Добавить ключ безопасности","ОШИБКА:"+e)}),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"verifyPhone":if(xxdialogMode&&"verifyPhone"!=xxdialogTag)return;o='<table><tr><td><img src="images/phone80.png" style=padding:8px>';o+="<td>Проверьте свой телефон и введите проверочный код.",setModalContent("xxAddAgent","Уведомления по телефону",o+='<br /><br /><div style=width:100%;text-align:center>Код подтверждения: <input type=tel pattern="[0-9]" inputmode="number" maxlength=6 id=d2phoneCodeInput onKeyUp=account_managePhoneCodeValidate() onkeypress="if (event.key==\'Enter\') account_managePhoneCodeValidate(1)"></div></table>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_managePhoneConfirm(3,t.cookie)),Q("d2phoneCodeInput").focus(),account_managePhoneCodeValidate();break;case"verifyMessaging":if(xxdialogMode&&"verifyMessaging"!=xxdialogTag)return;o='<table><tr><td><img src="images/messaging40.png" style=padding:8px>';o+="<td>Check your messaging application and enter the verification code.",setModalContent("xxAddAgent","Messaging Notifications",o+='<br /><br /><div style=width:100%;text-align:center>Код подтверждения: <input type=tel pattern="[0-9]" inputmode="number" maxlength=6 id=d2phoneCodeInput onKeyUp=account_managePhoneCodeValidate() onkeypress="if (event.key==\'Enter\') account_managePhoneCodeValidate(1)"></div></table>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_manageMessagingConfirm(3,t.cookie)),Q("d2phoneCodeInput").focus(),account_managePhoneCodeValidate();break;case"fileoperation":setModalContent("xxAddAgent",EscapeHtml(t.file),4,"extra-large"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>function(e,t){var n,o=Q("d4editorarea").value;o=0===d4EditLineBreakVal?o.replace(/\r?\n|\r/g,"\r\n"):2===d4EditLineBreakVal?o.replace(/\r\n|\n/g,"\r"):o.replace(/\r\n|\r/g,"\n"),n=1==d4EditEncodingVal?encode_utf8(o):o,meshserver.send({action:"fileoperation",fileop:"set",path:t.path,file:t.file,data:btoa(n)})}(0,t)),QV("d4EncodingButton",!0),QV("d4LineBreakButton",!0),Q("d4editorarea").value=1==d4EditEncodingVal?decode_utf8(atob(t.data)):atob(t.data);break;case"event":if(!t.event.nolog){if(currentNode&&t.event.nodeid==currentNode._id&&null!=currentDeviceEvents&&(t.event.action==p16filterevents.value||""==p16filterevents.value)){if(null!=currentDeviceEvents){currentDeviceEvents.unshift(t.event);for(var F=parseInt(p16limitdropdown.value);currentDeviceEvents.length>F;)currentDeviceEvents.pop()}mainUpdate(1024)}if(currentUser&&t.event.userid==currentUser._id&&(t.event.action==p31filterevents.value||""==p31filterevents.value)){if(null!=currentUserEvents){currentUserEvents.unshift(t.event);for(F=parseInt(p31limitdropdown.value);currentUserEvents.length>F;)currentUserEvents.pop()}mainUpdate(2048)}if(t.event.action==p3filterevents.value||""==p3filterevents.value){if(null!=events){events.unshift(t.event);for(F=parseInt(p3limitdropdown.value);events.length>F;)events.pop()}mainUpdate(32)}}if(t.event.noact)break;switch(t.event.action){case"serverinfochange":null!=t.event.lock2factor&&(serverinfo.lock2factor=t.event.lock2factor,updateSelf(),updateSiteAdmin());break;case"deviceShareUpdate":if(t.event.nodeid!=deviceSharesReq)break;deviceSharesNode=t.event.nodeid,deviceShares=t.event.deviceShares,currentNode._id==deviceSharesNode&&gotoDevice(currentNode._id,xxcurrentView,!0);break;case"agentlog":if(98==t.event.msgid&&GetNodeRights(t.event.nodeid)>0){u=getNodeFromId(t.event.nodeid);addNotification({text:format("Запрошена помощь от {0}: {1}",t.event.msgArgs[0],t.event.msgArgs[1]),title:u.name,icon:u.icon,nodeid:t.event.nodeid})}break;case"recording":null!=p52recordings&&"object"==typeof p52recordings&&(p52recordings.unshift(t.event),t.event.present=1,updateRecordings());break;case"userWebState":try{if(null!=localStorage){var B=localStorage.getItem("showRealNames"),O=localStorage.getItem("uiMode"),P=localStorage.getItem("sort"),L=localStorage.getItem("loctag"),z=localStorage.getItem("nightMode"),W=localStorage.getItem("footerBar"),G=JSON.parse(t.event.state);for(var i in G)localStorage.setItem(i,G[i]);if(null!=G.showRealNames&&G.showRealNames!=B&&(showRealNames=Q("RealNameCheckBox").checked="1"==G.showRealNames,mainUpdate(6)),null!=G.uiMode&&G.uiMode!=O&&userInterfaceSelectMenu(parseInt(G.uiMode)),null!=G.sort&&G.sort!=P&&(document.getElementById("sortselect").selectedIndex=sort=parseInt(G.sort),mainUpdate(6)),null!=G.loctag&&G.loctag!=L&&(null!=G.loctag?args.locale=G.loctag:delete args.locale,mainUpdate(4294967295)),null!=G.nightMode&&G.nightMode!=z&&(putstore("nightMode",G.nightMode),setNightMode()),null!=G.footerBar&&G.footerBar!=W&&(footerBar="1"==G.footerBar,QS("container")["grid-template-rows"]=null,QS("container")["-ms-grid-rows"]=null,adjustPanels()),null!=G.stars&&G.stars!=JSON.stringify(stars)&&(stars=JSON.parse(G.stars),3==Q("DevFilterSelect").value?mainUpdate(5):mainUpdate(4),currentNode&&refreshDevice(currentNode._id)),null!=G.deskKeyShortcuts){deskKeyboardShortcuts=[];var K=G.deskKeyShortcuts.split(",");for(var i in K)""!=K[i]&&deskKeyboardShortcuts.push(parseInt(K[i]));updateDeskShortcutKeys()}if(null!=G.deskStrings){r=null;try{r=JSON.parse(G.deskStrings)}catch(e){}Array.isArray(r)&&(deskKeyboardStrings=r,updateDesktopStrings())}}}catch(e){}break;case"servertimelinestats":addServerTimelineStats(t.event.data);break;case"accountcreate":case"accountchange":if("object"!=typeof t.event.account||null==t.event.account)return void console.log(t.event);if(userinfo._id==t.event.account._id){var j=t.event.account.siteadmin?t.event.account.siteadmin:0,q=userinfo.siteadmin?userinfo.siteadmin:0,J=t.event.account.removeRights?t.event.account.removeRights:0,$=userinfo.removeRights?userinfo.removeRights:0;(t.event.account.quota!=userinfo.quota||!(8&userinfo.siteadmin)&&8&t.event.account.siteadmin)&&meshserver.send({action:"files"});var X=userinfo.groups;if(userinfo=t.event.account,q==j&&$==J&&1!=t.event.accountImageChange||(1==t.event.accountImageChange&&(userinfo.accountImageRnd=Math.floor(9999999999*Math.random())),updateSiteAdmin()),updateSelf(),2&userinfo.siteadmin){var Y=X||[],Z=userinfo.groups?userinfo.groups:[];Y.join(",")!=Z.join(",")&&(users=wssessions=null,meshserver.send({action:"users"}),meshserver.send({action:"wssessioncount"}))}t.event.nodeListChange==userinfo._id&&meshserver.send({action:"nodes",skip:null==devicePagingState?0:devicePagingState.skip})}if(currentNode&&refreshDevice(currentNode._id),null==users)break;null==userinfo.groups||0==userinfo.groups.length||1==findOne(t.event.account.groups,userinfo.groups)?users[t.event.account._id]=t.event.account:delete users[t.event.account._id],mainUpdate(16388);break;case"accountremove":if(null==users)break;delete users[t.event.userid],mainUpdate(16384);break;case"createusergroup":case"usergroupchange":null==usergroups&&(usergroups={});var ee=usergroups[t.event.ugrpid];null==ee?usergroups[t.event.ugrpid]={_id:t.event.ugrpid,name:t.event.name,desc:t.event.desc,domain:t.event.domain,links:t.event.links}:(ee.name=t.event.name,t.event.desc?ee.desc=t.event.desc:delete ee.desc,t.event.links?ee.links=t.event.links:delete ee.links,t.event.flags?ee.flags=t.event.flags:delete ee.flags,"number"==typeof t.event.consent&&(ee.consent=t.event.consent)),mainUpdate(28672),meshserver.send({action:"meshes"}),meshserver.send({action:"nodes",skip:null==devicePagingState?0:devicePagingState.skip});break;case"deleteusergroup":if(null!=usergroups&&null!=usergroups[t.event.ugrpid]){delete usergroups[t.event.ugrpid];var te=0;for(var i in usergroups)te++;0==te&&(usergroups=null),mainUpdate(24576)}break;case"createmesh":null!=meshes[t.event.meshid]||!serverinfo.manageAllDeviceGroups&&null==t.event.mesh.links[userinfo._id]||(meshes[t.event.meshid]=t.event.mesh,mainUpdate(24708),meshserver.send({action:"files"}));break;case"meshchange":if(null==meshes[t.event.meshid]){var ne=!1;for(var i in null!=t.event.links[userinfo._id]&&(ne=!0),null!=userinfo.links[t.event.meshid]&&(ne=!0),userinfo.links)i.startsWith("ugrp/")&&null!=t.event.links[i]&&(ne=!0);ne&&(meshes[t.event.meshid]={_id:t.event.meshid,name:t.event.name,mtype:t.event.mtype,desc:t.event.desc,links:t.event.links,amt:t.event.amt,invite:t.event.invite,expireDevs:t.event.expireDevs,relayid:t.event.relayid},meshserver.send({action:"nodes",skip:null==devicePagingState?0:devicePagingState.skip}))}else{if(null!=t.event.name)for(var i in meshes[t.event.meshid].name=t.event.name,nodes)nodes[i].meshid==t.event.meshid&&(nodes[i].meshnamel=t.event.name.toLowerCase());if(null!=t.event.desc&&(meshes[t.event.meshid].desc=t.event.desc),null!=t.event.flags&&(meshes[t.event.meshid].flags=t.event.flags),null!=t.event.consent&&(meshes[t.event.meshid].consent=t.event.consent),t.event.links&&(meshes[t.event.meshid].links=t.event.links),t.event.amt&&(meshes[t.event.meshid].amt=t.event.amt),null!=t.event.invite?meshes[t.event.meshid].invite=t.event.invite:delete meshes[t.event.meshid].invite,null!=t.event.expireDevs&&(t.event.expireDevs>0?meshes[t.event.meshid].expireDevs=t.event.expireDevs:delete meshes[t.event.meshid].expireDevs),null!=t.event.relayid&&(meshes[t.event.meshid].relayid=t.event.relayid),0==IsMeshViewable(t.event.meshid)){20==xxcurrentView&&currentMesh==meshes[t.event.meshid]&&go(2),delete meshes[t.event.meshid];var oe=[];for(var i in nodes)(nodes[i].meshid!=t.event.meshid||null!=userinfo.links&&null!=userinfo.links[nodes[i]._id])&&oe.push(nodes[i]);nodes=oe,xxcurrentView>=10&&xxcurrentView<20&&currentNode&&!IsNodeViewable(currentNode)&&(setDialogMode(0),go(1))}}mainUpdate(24708),currentNode&&!IsNodeViewable(currentNode)&&(currentNode=null,xxcurrentView>=10&&xxcurrentView<20&&go(1)),20==xxcurrentView&&currentMesh._id==t.event.meshid&&mainUpdate(4096);break;case"deletemesh":meshes[t.event.meshid]&&(delete meshes[t.event.meshid],mainUpdate(128),meshserver.send({action:"files"}));oe=[];if(null!=nodes)for(var i in nodes)nodes[i].meshid!=t.event.meshid&&oe.push(nodes[i]);nodes=oe,mainUpdate(24580),xxcurrentView>=20&&xxcurrentView<30&&currentMesh._id==t.event.meshid&&(setDialogMode(0),go(2)),xxcurrentView>=10&&xxcurrentView<20&&currentNode&&!IsNodeViewable(currentNode)&&(setDialogMode(0),go(1));break;case"addnode":var ie=t.event.node;if(!meshes[ie.meshid])break;if(null!=getNodeFromId(ie._id))break;ie.namel=ie.name.toLowerCase(),ie.rname?ie.rnamel=ie.rname.toLowerCase():ie.rnamel=ie.namel,ie.meshnamel=meshes[ie.meshid]?meshes[ie.meshid].name.toLowerCase():"*",ie.state=0,ie.icon||(ie.icon=1),ie.ident=++nodeShortIdent,nodes.push(ie),mainUpdate(23),20==xxcurrentView&&null!=currentMesh&&currentMesh._id==ie.meshid&&mainUpdate(4096);break;case"removenode":g=-1;for(var i in nodes)if(nodes[i]._id==t.event.nodeid){g=i;break}if(-1!=g){ie=nodes[g];currentNode==ie&&(xxcurrentView>=10&&xxcurrentView<20&&(setDialogMode(0),go(1)),currentNode=null),nodes.splice(g,1),mainUpdate(20),20==xxcurrentView&&null!=currentMesh&&currentMesh._id==ie.meshid&&mainUpdate(4096)}break;case"changenode":g=-1;for(var i in nodes)if(nodes[i]._id==t.event.nodeid){g=i;break}if(-1!=g){if((ie=nodes[g]).name=t.event.node.name,ie.rname=t.event.node.rname,ie.lusers=t.event.node.lusers,ie.users=t.event.node.users,ie.host=t.event.node.host,ie.desc=t.event.node.desc,ie.ip=t.event.node.ip,ie.osdesc=t.event.node.osdesc,ie.publicip=t.event.node.publicip,ie.iploc=t.event.node.iploc,ie.wifiloc=t.event.node.wifiloc,ie.gpsloc=t.event.node.gpsloc,ie.tags=t.event.node.tags,ie.ssh=t.event.node.ssh,ie.rdp=t.event.node.rdp,ie.userloc=t.event.node.userloc,ie.rdpport=t.event.node.rdpport,ie.rfbport=t.event.node.rfbport,ie.sshport=t.event.node.sshport,ie.httpport=t.event.node.httpport,ie.httpsport=t.event.node.httpsport,ie.consent=t.event.node.consent,ie.pmt=t.event.node.pmt,null!=t.event.node.links?ie.links=t.event.node.links:delete ie.links,null!=t.event.node.agent&&(null==ie.agent&&(ie.agent={}),null!=t.event.node.agent.ver&&(ie.agent.ver=t.event.node.agent.ver),null!=t.event.node.agent.id&&(ie.agent.id=t.event.node.agent.id),null!=t.event.node.agent.caps&&(ie.agent.caps=t.event.node.agent.caps),null!=t.event.node.agent.root&&(ie.agent.root=t.event.node.agent.root),null!=t.event.node.agent.core?ie.agent.core=t.event.node.agent.core:ie.agent.core&&delete ie.agent.core,ie.agent.tag=t.event.node.agent.tag),null!=t.event.node.intelamt&&(null==ie.intelamt&&(ie.intelamt={}),null!=t.event.node.intelamt.state&&(ie.intelamt.state=t.event.node.intelamt.state),null!=t.event.node.intelamt.host&&(ie.intelamt.user=t.event.node.intelamt.host),null!=t.event.node.intelamt.user?ie.intelamt.user=t.event.node.intelamt.user:delete ie.intelamt.user,null!=t.event.node.intelamt.tls&&(ie.intelamt.tls=t.event.node.intelamt.tls),null!=t.event.node.intelamt.ver&&(ie.intelamt.ver=t.event.node.intelamt.ver),null!=t.event.node.intelamt.tag&&(ie.intelamt.tag=t.event.node.intelamt.tag),null!=t.event.node.intelamt.uuid&&(ie.intelamt.uuid=t.event.node.intelamt.uuid),null!=t.event.node.intelamt.realm&&(ie.intelamt.realm=t.event.node.intelamt.realm),null!=t.event.node.intelamt.flags&&(ie.intelamt.flags=t.event.node.intelamt.flags),null!=t.event.node.intelamt.warn?ie.intelamt.warn=t.event.node.intelamt.warn:delete ie.intelamt.warn),null!=t.event.node.av&&(ie.av=t.event.node.av),null!=t.event.node.wsc&&(ie.wsc=t.event.node.wsc),null!=t.event.node.volumes&&(ie.volumes=t.event.node.volumes),ie.namel=ie.name.toLowerCase(),ie.rname?ie.rnamel=ie.rname.toLowerCase():ie.rnamel=ie.namel,t.event.node.icon&&(ie.icon=t.event.node.icon),null!=t.event.node.lastbootuptime&&(ie.lastbootuptime=t.event.node.lastbootuptime),t.event.node.meshid!=ie.meshid)if(null!=meshes[t.event.node.meshid]||null!=userinfo.links&&null!=userinfo.links[ie._id])ie.meshid=t.event.node.meshid,ie.meshnamel=meshes[t.event.node.meshid]?meshes[t.event.node.meshid].name.toLowerCase():"*",mainUpdate(7);else{null!=currentNode&&currentNode._id==ie._id&&xxcurrentView>=10&&xxcurrentView<20&&!IsNodeViewable(currentNode)&&(currentNode=null,setDialogMode(0),go(1));g=-1;for(var i in nodes)if(nodes[i]._id==t.event.nodeid){g=i;break}nodes.splice(g,1),mainUpdate(20)}updateDeviceViewDevice(ie),mainUpdate(26),refreshDevice(ie._id),20==xxcurrentView&&null!=currentMesh&&currentMesh._id==ie.meshid&&mainUpdate(4096),currentNode==ie&&null!=xxdialogMode&&"@xxmap"==xxdialogTag&&p10showNodeLocationDialog()}break;case"nodemeshchange":g=-1;for(var i in nodes)if(nodes[i]._id==t.event.nodeid){g=i;break}if(-1!=g){ie=nodes[g];null!=meshes[t.event.newMeshId]||null!=userinfo.links&&null!=userinfo.links[ie._id]?(ie.meshid=t.event.newMeshId,ie.meshnamel=meshes[t.event.newMeshId]?meshes[t.event.newMeshId].name.toLowerCase():"*",mainUpdate(7)):(null!=currentNode&&currentNode._id==ie._id&&xxcurrentView>=10&&xxcurrentView<20&&!IsNodeViewable(currentNode)&&(currentNode=null,setDialogMode(0),go(1)),nodes.splice(g,1),mainUpdate(20)),refreshDevice(t.event.nodeid)}else{ie=t.event.node;if(!meshes[ie.meshid])break;ie.namel=ie.name.toLowerCase(),ie.rname?ie.rnamel=ie.rname.toLowerCase():ie.rnamel=ie.namel,ie.meshnamel=meshes[ie.meshid]?meshes[ie.meshid].name.toLowerCase():"*",ie.state=0,ie.icon||(ie.icon=1),ie.ident=++nodeShortIdent,nodes.push(ie),mainUpdate(23)}break;case"nodeconnect":g=-1;for(var i in nodes)if(nodes[i]._id==t.event.nodeid){g=i;break}if(-1!=g){ie=nodes[g],u=getstore("notifications",0);if(t.event.meshid&&userinfo.links&&userinfo.links[t.event.meshid]&&userinfo.links[t.event.meshid].notify&&(u|=userinfo.links[t.event.meshid].notify),null!=userinfo.notify&&(null!=userinfo.notify[t.event.meshid]&&(u|=userinfo.notify[t.event.meshid]),null!=userinfo.notify[t.event.nodeid]&&(u|=userinfo.notify[t.event.nodeid])),2&u){var ae="Агент подключен";null!=ie.agent&&!1===ie.agent.root&&(ae="Агент подключен с ограниченными привилегиями");var se={title:ie.name,icon:ie.icon,nodeid:ie._id,id:t.event.id};!(1&ie.conn)&&1&t.event.conn&&(se.text=ae,addNotification(se)),!(2&ie.conn)&&2&t.event.conn&&(se.text="Intel AMT CIRA подключен",addNotification(se)),!(4&ie.conn)&&4&t.event.conn&&(se.text="Intel AMT подключен",addNotification(se)),!(16&ie.conn)&&16&t.event.conn&&(se.text="Подключен MQTT",addNotification(se))}if(4&u){se={title:ie.name,icon:ie.icon,nodeid:ie._id,id:t.event.id};1&ie.conn&&!(1&t.event.conn)&&(se.text="Агент отключился",addNotification(se)),2&ie.conn&&!(2&t.event.conn)&&(se.text="Intel AMT CIRA отключен",addNotification(se)),4&ie.conn&&!(4&t.event.conn)&&(se.text="Intel AMT отключен",addNotification(se)),16&ie.conn&&!(16&t.event.conn)&&(se.text="MQTT отключено",addNotification(se))}ie.conn=t.event.conn,ie.pwr=t.event.pwr,ie.lastconnect=Date.now(),1&ie.conn||delete ie.sessions;var re=Q("DevFilterSelect").value;1==re||5==re?mainUpdate(21):(updateDeviceViewDevice(ie),mainUpdate(17)),refreshDevice(ie._id),20==xxcurrentView&&null!=currentMesh&&currentMesh._id==ie.meshid&&mainUpdate(4096)}break;case"wssessioncount":null!=wssessions&&(0==t.event.count&&wssessions[t.event.userid]?delete wssessions[t.event.userid]:wssessions[t.event.userid]=t.event.count,mainUpdate(16384));break;case"login":null!=users&&users[t.event.userid]&&(users[t.event.userid].login=Math.floor(new Date(t.event.time).getTime()/1e3));break;case"scanamtdevice":if(null==xxdialogMode||!Q("dp1range")||xxdialogTag!="AMTSCAN:"+t.event.range)return;o="";if(null==t.event.results)o="<div style=width:100%;text-align:center;margin-top:12px>Невозможно отсканировать этот диапазон адресов.</div><div style=width:100%;text-align:center;margin-top:12px;color:gray;line-height:1.5>Примеры значений диапазона IP-адресов<br />192.168.0.100<br />192.168.1.0/24<br />192.167.0.1-192.168.0.100</div>";else{for(var i in amtScanResults=t.event.results,t.event.results){var le=t.event.results[i],de=le.hostname;"host"==le.hosttype&&(de=capitalizeFirstLetter(de.split(".")[0])),de.length>20&&(de=de.substring(0,20)+"...");var ce='<b title="'+EscapeHtml(le.hostname)+'">'+EscapeHtml(de)+"</b> - v"+le.ver;2==le.state?1==le.tls?ce+=" с TLS.":ce+=" без TLS":ce+=" not activated.",o+='<div style=width:100%;margin-bottom:2px;background-color:lightgray><div style=padding:4px><div style=display:inline-block;margin-right:5px><input class="DevScanCheckbox form-check-input me-2" name=dp1checkbox tag="'+EscapeHtml(i)+'" type=checkbox onclick=addAmtScanToMeshCheckbox() /></div><div class=j1 style=display:inline-block></div><div style=display:inline-block;margin-left:5px;overflow-x:auto;white-space:nowrap>'+ce+"</div></div></div>"}""==o&&(o="<div style=width:100%;text-align:center;margin-top:12px>Сканирование не дало результатов .</div><div style=width:100%;text-align:center;margin-top:12px;color:gray;line-height:1.5>Примеры значений диапазона IP-адресов<br />192.168.0.100<br />192.168.1.0/24<br />192.167.0.1-192.168.0.100</div>")}QH("dp1results",o),QE("dp1range",!0),QE("dp1rangebutton",!0),QE("d2scanSelectButton",!0);break;case"notify":u={text:t.event.value,title:t.event.title,icon:t.event.icon,titleid:t.titleid,msgid:t.msgid,args:t.args};null!=t.id&&(u.id=t.id),null!=t.event.tag&&(u.tag=t.event.tag),"number"==typeof t.maxtime&&(u.maxtime=t.maxtime),addNotification(u);break;case"traceinfo":"object"==typeof t.event.traceSources&&(null!=t.event.traceSources&&t.event.traceSources.length>0?(serverTraceSources=t.event.traceSources,QH("p41traceStatus",EscapeHtml(t.event.traceSources.join(", ")))):(serverTraceSources=[],QH("p41traceStatus","Пусто")));break;case"sysinfohash":null!=currentNode&&t.event.nodeid==powerTimelineReq&&meshserver.send({action:"getsysinfo",nodeid:t.event.nodeid});break;case"ifchange":null!=currentNode&&currentNode._id==t.event.nodeid&&meshserver.send({action:"getnetworkinfo",nodeid:currentNode._id});break;case"devicesessions":if(null==(ie=getNodeFromId(t.event.nodeid)))break;if(ie.sessions=t.event.sessions,null!=ie.sessions){for(var i in ie.sessions)0==Object.keys(ie.sessions[i]).length&&delete ie.sessions[i];0==Object.keys(ie.sessions).length&&delete ie.sessions}updateDeviceViewDevice(ie),null!=currentNode&&currentNode._id==t.event.nodeid&&gotoDevice(currentNode._id,xxcurrentView,!0),xxdialogTag=="SESSIONS-"+t.event.nodeid&&showDeviceSessions(t.event.nodeid,!0),xxdialogTag=="MESSAGES-"+t.event.nodeid&&showDeviceMessages(t.event.nodeid,!0),xxdialogTag=="HELPREQ-"+t.event.nodeid&&showDeviceHelpRequests(t.event.nodeid,!0),2!=Q("DevFilterSelect").value&&6!=Q("DevFilterSelect").value||mainUpdate(1);break;case"loginTokenChanged":if(t.event.userid!=userinfo._id)return;loginTokens=t.event.loginTokens,mainUpdate(65536);break;case"loginTokenAdded":if(t.event.userid!=userinfo._id)return;null==loginTokens&&(loginTokens=[]),loginTokens.push(t.event.newToken),mainUpdate(65536);break;case"stopped":default:break;case"updatePluginList":installedPluginList=t.event.list,updatePluginList();break;case"pluginStateChange":if(null==pluginHandler)break;pluginHandler.refreshPluginHandler();break;case"plugin":if(null==pluginHandler)break;try{pluginHandler[t.event.plugin][t.event.pluginaction](t)}catch(e){console.log("PluginHandler не смог сообщение о событии:",e)}}break;case"createInviteLink":if(xxdialogTag!=t.meshid)break;var ue;(-1==(ue=serverinfo.name).indexOf(".")||2&features)&&(ue=window.location.hostname);domainUrl.substring(0,domainUrl.length-1);if(1==serverinfo.https)C="https://"+ue+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"agentinvite?c="+t.cookie+(urlargs.key?"&key="+urlargs.key:"");else C="http://"+ue+(80==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"agentinvite?c="+t.cookie+(urlargs.key?"&key="+urlargs.key:"");Q("agentInvitationLink").href=C;var pe=format(1==t.expire?"1 час":"{0} часов",t.expire);24==t.expire&&(pe="1 день"),168==t.expire&&(pe="1 неделя"),5040==t.expire&&(pe="1 месяц"),0==t.expire&&(pe="Неограниченно"),QH("agentInvitationLink",format("Ссылка для приглашения ({0})",pe)),QV("agentInvitationLinkDiv",!0);break;case"createDeviceShareLink":if(xxdialogTag)break;o="";if(null==(ie=getNodeFromId(t.nodeid)))break;o+=addHtmlValue("Устройство",ie.name),o+=addHtmlValue("Имя гостя",t.guestname),o+=addHtmlValue("Пользовательский ввод",t.viewOnly?"Не разрешено, только просмотр":"Разрешено"),t.start&&t.expire&&(t.recurring?(o+=addHtmlValue("Время начала",printDateTime(new Date(t.start))),t.expire<2?o+=addHtmlValue("Длительность",format("{0} минута",t.expire)):o+=addHtmlValue("Длительность",format("{0} минут",t.expire))):(o+=addHtmlValue("Время начала",printDateTime(new Date(t.start))),o+=addHtmlValue("Время действия",printDateTime(new Date(t.expire))))),1==t.recurring&&(o+=addHtmlValue("Повторяющийся","Ежедневно")),2==t.recurring&&(o+=addHtmlValue("Повторяющийся","Еженедельно"));s=[];7&t.consent&&s.push("Уведомить"),56&t.consent&&s.push("Подсказка"),64&t.consent&&s.push("Панель-уведомление"),0==s.length&&s.push("Пусто"),o+=addHtmlValue("Согласие пользователя",s.join(", "));var me="";t.p<=7?me=["","Связь с удаленным терминалом","Ссылка на удаленный рабочий стол","Ссылка на Удаленный рабочий стол + Терминал","Ссылка на Файлы","Ссылка на Терминал + Файлы","Ссылка на Удаленный рабочий стол + Файлы","Ссылка на Удаленный рабочий стол + Терминал + Файлы"][t.p]:8==t.p?me=format("HTTP/{0} link",t.port):16==t.p&&(me=format("HTTPS/{0}",t.port)),setModalContent("xxAddAgent","Поделиться устройством",o+='<div id=agentInvitationLinkDiv style="text-align:center;font-size:large;margin:16px"><a href="'+t.url+'" id=agentInvitationLink rel="noreferrer noopener" target="_blank" style=cursor:pointer>'+me+'</a> <i class="fa-regular fa-copy" title="Скопировать ссылку в буфер обмена" style=cursor:pointer onclick=d2CopyInviteToClip()></i></div></div>'),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"getmqttlogin":if(null==currentNode||currentNode._id!=t.nodeid||null!=xxdialogMode)return;o="Эти настройки можно использовать для подключения MQTT для этого устройства.<br /><br />";delete t.action,delete t.nodeid,setModalContent("xxAddAgent","MQTT Учетные данные",o+="<textarea readonly=readonly style=width:100%;resize:none;height:100px;overflow:auto;font-size:12px readonly>"+JSON.stringify(t)+"</textarea>"),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"stopped":autoReconnect=!1,QH("p0span",t.msg);break;case"updatePluginList":installedPluginList=t.list,updatePluginList();break;case"pluginVersionsAvailable":if(null==pluginHandler)break;updatePluginList(t.list);break;case"downgradePluginVersions":var ge='<select id="lastPluginVersion">';t.info.versionList.forEach(function(e){ge+='<option value="'+e.zipball_url+'">'+e.name+"</option>"}),ge+="</select>",setModalContent("xxAddAgent","Действие плагина",format("Select the version to downgrade the plugin: {0}",t.info.name)+"<hr />"+ge+"<hr />Внимание, понижение версии не рекомендуется. Делайте это только в том случае, если недавнее обновление что-то сломало.NaN"+t.info.id+'" />'),showModal("xxAddAgentModal","idx_dlgOkButton",pluginActionEx);break;case"serverBackup":if("googleDrive"==t.service&&(QV("p2ServerActionsGoogleBackup",t.state>0),QV("p2ServerActionsGoogleBackupCheck",t.state>2),miscState.googleDrive={state:t.state},2==t.state)){o='<img style=float:right src="images/googledrive-48.png" /><div>Перейдите по URL-адресу ниже, предоставьте доступ и скопируйте код токена обратно.</div><br />';o+=addHtmlValue("Активация",'<a href="'+t.url+'" rel="noreferrer noopener" target="_blank">Browse to this URL</a>'),setModalContent("xxAddAgent","Резервное копирование на Google Диск",o+=addHtmlFormFloating("Код","<input id=gdcode onkeyup=server_setupGoogleDriveBackupCheck3() class=form-control></input>")),showModal("xxAddAgentModal","idx_dlgOkButton",()=>server_setupGoogleDriveBackupEx(3,"gd2")),Q("gdcode").focus(),QE("idx_dlgOkButton",!1)}break;case"pluginError":setModalContent("xxAddAgent","Ошибка плагина",t.msg),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"plugin":if(null==pluginHandler||"string"!=typeof t.plugin)break;try{pluginHandler[t.plugin][t.method](e,t)}catch(e){console.log("Error loading plugin handler ("+e+")")}break;case"amtsetupbin":saveAs(new Blob([Uint8Array.from(atob(t.file),function(e){return e.charCodeAt(0)})],{type:"application/octet-stream"}),"setup.bin");break;case"previousLogins":null!=t.userid&&":"+t.userid;o="",te="BBB";var ve="";if(0==t.events.length)o+="No previous login.";else{for(var i in o+='<div class="backgroundContainer" style=max-height:260px;overflow-y:scroll;overflow-x:hidden><table>',t.events){107==(d=t.events[i].m)?(d="Удачный вход",te="BBD1BB",ve="",null!=t.events[i].tn&&(d=format("Токен: {0}",t.events[i].tn),te="88D188")):108==d?(d="Неверный 2FA",te="DD9DC3",ve="x"):109==d?(d="Заблокированная учетная запись",te="E1BBBB",ve="x"):110==d&&(d="Неверный пароль",te="E1BBBB",ve="x"),o+="<tr><td><img src=images/user-32"+ve+'.png height=32 width=32 style=float:left srcset="images/user-64'+ve+'.png 2x"><td><div style=width:350px;background-color:#'+te+";border-radius:6px;margin-bottom:4px;padding:4px><div>"+printDateTime(new Date(t.events[i].t))+", <b>"+EscapeHtml(d)+"</b></div><div style=font-size:x-small>"+EscapeHtml(t.events[i].a.join(", "))+"</div></div></tr>"}o+="</table></div>"}setModalContent("xxAddAgent","Предыдущие входы",o),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"getDeviceDetails":saveAs(new Blob([t.data],{type:"application/octet-stream"}),"список устройств."+t.type);break;case"createLoginToken":if(xxdialogMode)return;o="Сохраните это имя пользователя и пароль, пароль не может быть показан снова.<br /><br />";o+=addHtmlValue("Имя",EscapeHtml(t.name)),0!=t.expire&&(o+=addHtmlValue("Срок действия",EscapeHtml(printDateTime(new Date(t.expire))))),o+=addHtmlValue("Имя пользователя",'<i class="fa-regular fa-copy" title="Скопировать ссылку в буфер обмена" style="margin:9px;cursor:pointer;float:right" onclick=copyTextToClip2("'+encodeURIComponentEx(t.tokenUser)+'")></i><div class=selecttext style=width:230px;padding:5px;background-color:orange;border-radius:5px;font-size:15px>'+EscapeHtml(t.tokenUser)+"</div>"),setModalContent("xxAddAgent","Создать токен входа",o+=addHtmlValue("Пароль",'<i class="fa-regular fa-copy" title="Скопировать ссылку в буфер обмена" style="margin:9px;cursor:pointer;float:right" onclick=copyTextToClip2("'+encodeURIComponentEx(t.tokenPass)+'")></i><div class=selecttext style=width:230px;padding:5px;background-color:orange;border-radius:5px;font-size:15px>'+EscapeHtml(t.tokenPass)+"</div>")),showModal("xxAddAgentModal","idx_dlgOkButton");break;case"loginTokens":loginTokens=t.loginTokens,mainUpdate(65536);break;case"report":renderReport(t.data)}}function gotoStartViewPage(){var e=parseInt("{{viewmode}}");if(-1==xxcurrentView){if(""!="{{currentNode}}".toLowerCase()){if(null==getNodeFromId("{{currentNode}}"))return;gotoDevice("{{currentNode}}",e)}else if(null!=args.gotonode){if(96==args.gotonode.length&&(args.gotonode=btoa(hex2rstr(args.gotonode)).split("+").join("@").split("/").join("$")),null==getNodeFromId("node/"+domain+"/"+args.gotonode))return;gotoDevice("node/"+domain+"/"+args.gotonode,e),goBackStack.push(1)}else if(null!=args.gotodevicename){var t=null;if(null!=nodes)for(var n in nodes)nodes[n].name==args.gotodevicename&&(t=nodes[n]._id);t&&(gotoDevice(t,e),goBackStack.push(1))}else if(null!=args.gotodevicername){t=null;if(null!=nodes)for(var n in nodes)nodes[n].rname==args.gotodevicername&&(t=nodes[n]._id);t&&(gotoDevice(t,e),goBackStack.push(1))}else if(null!=args.gotodeviceip){t=null;if(null!=nodes)for(var n in nodes)nodes[n].ip==args.gotodeviceip&&(t=nodes[n]._id);t&&(gotoDevice(t,e),goBackStack.push(1))}else if(null!=args.gotomesh){if(null==meshes["mesh/"+domain+"/"+args.gotomesh])return;gotoMesh("mesh/"+domain+"/"+args.gotomesh),go(e),goBackStack.push(2)}else if(null!=args.gotouser){var o=args.gotouser;if(args.gotouser.indexOf("/")<0&&(o="user/"+domain+"/"+args.gotouser),null==users||null==users[o])return;gotoUser(encodeURIComponentEx(o)),go(e),goBackStack.push(4)}else if(null!=args.gotougrp){var i=args.gotougrp;if(args.gotougrp.indexOf("/")<0&&(i="ugrp/"+domain+"/"+args.gotougrp),null==usergroups||null==usergroups[i])return;gotoUserGroup(i),go(e),goBackStack.push(50)}else isNaN(e)?(setDialogMode(0),go(1)):go(e);delete args.gotonode,delete args.gotomesh,delete args.gotouser,delete args.gotougrp}}function topMenu(e){null!=xxdialogMode&&0!=xxdialogMode&&999!=xxdialogMode||(void 0===e?1==("none"==QS("topMenu").display)?0!=xxdialogMode&&null!=xxdialogMode||(QV("topMenu",!0),xxdialogMode=999):(QV("topMenu",!1),xxdialogMode=0):(QV("topMenu",!1),xxdialogMode=0,1==e&&goForward("devices"),2==e&&goForward("account"),3==e&&goForward("events"),4==e&&goForward("users"),5==e&&goForward("files"),6==e&&goForward("server")))}function onRealNameCheckBox(){putstore("showRealNames",(showRealNames=Q("RealNameCheckBox").checked)?1:0),mainUpdate(7)}function onOnlineCheckBox(e){putstore("devFilterSelect",Q("DevFilterSelect").value),onDeviceSearchChanged(e)}function updateDevicePageState(){if(null==devicePagingState||devicePagingState.total<=devicePagingState.limit)QV("devViewPageState",!1),QV("devViewPageButton1",!1),QV("devViewPageButton2",!1),QV("devViewPageButton3",!1),QV("devViewPageButton4",!1);else{var e=Math.floor((devicePagingState.skip+devicePagingState.limit)/devicePagingState.limit),t=Math.ceil(devicePagingState.total/devicePagingState.limit);QV("devViewPageState",!0),QV("devViewPageButton1",!0),QV("devViewPageButton2",!0),QV("devViewPageButton3",!0),QV("devViewPageButton4",!0),QH("devViewPageState",e+"/"+t)}}function onDeviceViewPageChange(e){if(null!=devicePagingState){var t=Math.floor((devicePagingState.skip+devicePagingState.limit)/devicePagingState.limit),n=Math.ceil(devicePagingState.total/devicePagingState.limit);switch(e){case 1:t>1&&meshserver.send({action:"nodes",skip:0});break;case 2:t>1&&meshserver.send({action:"nodes",skip:(t-2)*devicePagingState.limit});break;case 3:t<n&&meshserver.send({action:"nodes",skip:t*devicePagingState.limit});break;case 4:t<n&&meshserver.send({action:"nodes",skip:(n-1)*devicePagingState.limit})}}}function onDeviceViewChange(e){null!=e&&(Q("viewselect").value=e);for(var t=1;t<6;t++)Q("devViewButton"+t).classList.remove("viewSelectorSel");Q("devViewButton"+Q("viewselect").value).classList.add("viewSelectorSel"),putstore("deviceView",Q("viewselect").value),putstore("viewsize",Q("sizeselect").value),mainUpdate(4),setTimeout(function(){mainUpdate(512)},200)}function onDeviceViewSettings(){if(!xxdialogMode){null==deviceViewSettings&&(deviceViewSettings={}),Array.isArray(deviceViewSettings.devsCols)||(deviceViewSettings.devsCols=["user","ip","conn"]);var e="";e+='<label><input id=d2c8 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("agtype")>=0?" checked":"")+">Тип агента</label><br />",e+='<label><input id=d2c9 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("agver")>=0?" checked":"")+">Версия агента</label><br />",e+='<label><input id=d2c6 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("desc")>=0?" checked":"")+">Описание устройства</label><br />",e+='<label><input id=d2c5 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("os")>=0?" checked":"")+">Операционная система</label><br />",e+='<label><input id=d2c10 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("tags")>=0?" checked":"")+">Теги</label><br />",e+='<label><input id=d2c11 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("windowsav")>=0?" checked":"")+">Windows AV</label><br />",e+='<label><input id=d2c12 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("windowsupdate")>=0?" checked":"")+">Windows Update</label><br />",e+='<label><input id=d2c13 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("windowsfirewall")>=0?" checked":"")+">Windows Firewall</label><br />",e+='<label><input id=d2c14 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("lastbootuptime")>=0?" checked":"")+">Last Boot Up Time</label><br />",e+='<label><input id=d2c1 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("links")>=0?" checked":"")+">Ссылки MeshCentral Router </label><br />",e+='<label><input id=d2c2 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("user")>=0?" checked":"")+">Авторизованные пользователи</label><br />",e+='<label><input id=d2c3 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("ip")>=0?" checked":"")+">IP-адрес агента</label><br />",e+='<label><input id=d2c4 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("conn")>=0?" checked":"")+">Подключение к серверу</label><br />",e+='<label><input id=d2c15 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("amthost")>=0?" checked":"")+">Intel&reg; AMT hostname</label><br />",e+='<label><input id=d2c17 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("amtstate")>=0?" checked":"")+">Intel&reg; AMT state</label><br />",setModalContent("xxAddAgent","Столбцы просмотра устройства",e+='<label><input id=d2c7 type=checkbox class="form-check-input me-2"'+(deviceViewSettings.devsCols.indexOf("lastseen")>=0?" checked":"")+">Последний визит</label><br />"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>onDeviceViewSettingsEx())}}function onDeviceViewSettingsEx(){var e=[];Q("d2c1").checked&&e.push("links"),Q("d2c2").checked&&e.push("user"),Q("d2c3").checked&&e.push("ip"),Q("d2c4").checked&&e.push("conn"),Q("d2c5").checked&&e.push("os"),Q("d2c6").checked&&e.push("desc"),Q("d2c7").checked&&e.push("lastseen"),Q("d2c8").checked&&e.push("agtype"),Q("d2c9").checked&&e.push("agver"),Q("d2c10").checked&&e.push("tags"),Q("d2c11").checked&&e.push("windowsav"),Q("d2c12").checked&&e.push("windowsupdate"),Q("d2c13").checked&&e.push("windowsfirewall"),Q("d2c14").checked&&e.push("lastbootuptime"),Q("d2c15").checked&&e.push("amthost"),Q("d2c17").checked&&e.push("amtstate"),deviceViewSettings.devsCols=e,putstore("_deviceViewSettings",JSON.stringify(deviceViewSettings)),mainUpdate(4)}function ondockeypress(e){if(!document.querySelector(".modal.show")){if(setSessionActivity(),!xxdialogMode&&11==xxcurrentView&&desktop&&Q("DeskControl").checked){if(null!=currentNode){var t=GetNodeRights(currentNode);if(0==!(8192&features2||4294967295!=t&&(!(8&t)||256&t)))return!1;if(1==!(4294967295==t||!(8&t)||256&t||!(4096&t))&&(1==e.altKey||1==e.ctrlKey||e.keyCode<32&&8!=e.keyCode&&13!=e.keyCode||e.keyCode>90))return!1}return desktop.m.handleKeys(e)}if(!xxdialogMode&&12==xxcurrentView&&terminal&&3==terminal.State&&null==xterm)return terminal.m.TermHandleKeys(e);if(!xxdialogMode&&(15==xxcurrentView||115==xxcurrentView))return agentConsoleHandleKeys(e);if(!xxdialogMode&&4==xxcurrentView){if(1==e.ctrlKey||1==e.altKey||1==e.metaKey)return;var n=0;if(e.key){if(1===e.key.length&&0==userSearchFocus&&(Q("UserSearchInput").value=Q("UserSearchInput").value+e.key,n=1),8==e.keyCode&&0==userSearchFocus){var o=Q("UserSearchInput").value;Q("UserSearchInput").value=o.substring(0,o.length-1),n=1}27==e.keyCode&&(Q("UserSearchInput").value="",n=1)}else 0!=e.charCode&&0==userSearchFocus&&(Q("UserSearchInput").value=Q("UserSearchInput").value+String.fromCharCode(e.charCode),n=1);if(n>0)return 1==n&&onUserSearchInputChanged(),haltEvent(e)}if(!xxdialogMode&&1==xxcurrentView){if(1==e.ctrlKey&&96==e.charCode)return showRealNames=!showRealNames,Q("RealNameCheckBox").value=showRealNames,putstore("showRealNames",showRealNames?1:0),void mainUpdate(6);if(1!=e.ctrlKey&&1!=e.altKey&&1!=e.metaKey){if(Q("viewselect").value<4){n=0;if(e.key){if(1===e.key.length&&0==searchFocus&&(Q("KvmSearchInput").value=Q("SearchInput").value=Q("SearchInput").value+e.key,n=1),8==e.keyCode&&0==searchFocus){o=Q("SearchInput").value;Q("KvmSearchInput").value=Q("SearchInput").value=o.substring(0,o.length-1),n=1}27==e.keyCode&&(Q("KvmSearchInput").value=Q("SearchInput").value="",n=1)}else 0!=e.charCode&&0==searchFocus&&(Q("KvmSearchInput").value=Q("SearchInput").value=Q("SearchInput").value+String.fromCharCode(e.charCode),n=1);if(n>0)return 1==n&&mainUpdate(5),haltEvent(e)}4==Q("viewselect").value&&(e.key?(1===e.key.length&&0==mapSearchFocus&&(Q("mapSearchLocation").value=Q("mapSearchLocation").value+e.key,n=1),27==e.keyCode&&(Q("mapSearchLocation").value="",mapCloseSearchWindow(),n=1),13==e.keyCode&&getSearchLocation()):0!=e.charCode&&0==mapSearchFocus&&(Q("mapSearchLocation").value=Q("mapSearchLocation").value+String.fromCharCode(e.charCode),n=1))}}}}function ondockeydown(e){if(setSessionActivity(),!xxdialogMode&&11==xxcurrentView&&desktop&&Q("DeskControl").checked){if(null!=currentNode){var t=GetNodeRights(currentNode);if(0==!(8192&features2||4294967295!=t&&(!(8&t)||256&t)))return!1;if(1==!(4294967295==t||!(8&t)||256&t||!(4096&t))&&(1==e.altKey||1==e.ctrlKey||e.keyCode<32&&8!=e.keyCode&&13!=e.keyCode||e.keyCode>90))return!1}return desktop.m.handleKeyDown(e)}if(!xxdialogMode&&12==xxcurrentView&&terminal&&3==terminal.State&&null==xterm&&(terminal.m.TermHandleKeyDown(e),e.keyCode>=37&&e.keyCode<=40&&haltEvent(e)),!xxdialogMode&&13==xxcurrentView&&116==e.keyCode&&null!=p13filetree)return haltEvent(e),!1;if(!xxdialogMode&&(15==xxcurrentView||115==xxcurrentView))return agentConsoleHandleKeys(e);if(!xxdialogMode&&4==xxcurrentView){if(8===e.keyCode&&0==userSearchFocus){var n=Q("UserSearchInput").value;Q("UserSearchInput").value=n.substring(0,n.length-1),o=1}if(27===e.keyCode&&(Q("UserSearchInput").value="",o=1),o>0)return 1==o&&mainUpdate(5),haltEvent(e)}if(!xxdialogMode&&1==xxcurrentView&&1!=e.ctrlKey&&1!=e.altKey&&1!=e.metaKey){var o=0;if(Q("viewselect").value<4){if(8===e.keyCode&&0==searchFocus){n=Q("SearchInput").value;Q("KvmSearchInput").value=Q("SearchInput").value=n.substring(0,n.length-1),o=1}if(27===e.keyCode&&(Q("KvmSearchInput").value=Q("SearchInput").value="",o=1),o>0)return 1==o&&mainUpdate(5),haltEvent(e)}if(4==Q("viewselect").value){if(8===e.keyCode&&0==mapSearchFocus){n=Q("mapSearchLocation").value;Q("mapSearchLocation").value=n.substring(0,n.length-1),o=1}27===e.keyCode&&(Q("mapSearchLocation").value="",mapCloseSearchWindow(),o=1)}}}function ondockeyup(e){if(setSessionActivity(),!xxdialogMode&&11==xxcurrentView&&desktop&&Q("DeskControl").checked){if(null!=currentNode){var t=GetNodeRights(currentNode);if(0==!(8192&features2||4294967295!=t&&(!(8&t)||256&t)))return!1;if(1==!(4294967295==t||!(8&t)||256&t||!(4096&t))&&(1==e.altKey||1==e.ctrlKey||e.keyCode<32&&8!=e.keyCode&&13!=e.keyCode||e.keyCode>90))return!1}return desktop.m.handleKeyUp(e)}return!xxdialogMode&&12==xxcurrentView&&terminal&&3==terminal.State&&null==xterm?terminal.m.TermHandleKeyUp(e):xxdialogMode||13!=xxcurrentView||116!=e.keyCode||null==p13filetree?xxdialogMode||4!=xxcurrentView||(8!==e.keyCode||0!=searchFocus)&&27!==e.keyCode?(xxdialogMode&&27==e.keyCode&&dialogclose(0),1==e.shiftKey&&27==e.keyCode?(dialogclose(0),Q("KvmSearchInput").value=Q("SearchInput").value="",mainUpdate(5),null!=desktop&&connectDesktop(),null!=terminal&&connectTerminal(),null!=files&&connectFiles(),void go(1)):xxdialogMode||0!=xxcurrentView||1==e.ctrlKey||1==e.altKey||1==e.metaKey?void 0:Q("viewselect").value<4&&(8===e.keyCode&&0==searchFocus||27===e.keyCode)||4==Q("viewselect").value&&(8===e.keyCode&&0==mapSearchFocus||27===e.keyCode)?haltEvent(e):void 0):haltEvent(e):(p13folderup(9999),haltEvent(e),!1)}function ondocblur(){if(!xxdialogMode&&11==xxcurrentView&&desktop&&Q("DeskControl").checked&&desktop.m.handleReleaseKeys)return desktop.m.handleReleaseKeys()}function devGrpMouseHover(e,t){setSessionActivity();Q("viewselect").value;var n=e.children[1].children[1];n.children[0].classList.remove("g1s"),n.children[1].classList.remove("e2s"),n.children[2].classList.remove("g2s"),1==t&&(n.children[0].classList.add("g1s"),n.children[1].classList.add("e2s"),n.children[2].classList.add("g2s"))}function devMouseHover(e,t){setSessionActivity();var n=Q("viewselect").value;if(1==n)(o=e.children[0].children[0].children[1].children[0].children[0].children[0]).children[1].classList.remove("g1s"),o.children[2].classList.remove("e2s"),o.children[3].classList.remove("g2s"),1==t&&(o.children[1].classList.add("g1s"),o.children[2].classList.add("e2s"),o.children[3].classList.add("g2s"));else if(2==n){var o;(o=e).children[2].classList.remove("g1s"),o.children[4].classList.remove("e2s"),o.children[3].classList.remove("g2s"),1==t&&(o.children[2].classList.add("g1s"),o.children[4].classList.add("e2s"),o.children[3].classList.add("g2s"))}}var deviceHeaderCount,deviceHeaderId=0,deviceHeaderTotal=0,deviceHeadersTitles={},deviceHeaders={},oldviewmode=0;function updateDevices(){if(null!=nodes&&1==xxcurrentView){var e="",t=0,n=null,o={},i=Q("viewselect").value,a={},s={};if(QV("xdevices",4!=i),QV("xdevicesmap",4==i),QVH("devListToolbar",i<3),QVH("kvmListToolbar",3==i||5==i),QVH("devMapToolbar",4==i),QV("devListToolbarSize",3==i||5==i),QV("devListToolbarSettings",2==i),QV("NoMeshesPanel",0==nodes.length&&0==meshcount),QV("devListToolbarViewIcons",nodes.length>0),QV("devListToolbarSort",nodes.length>0&&4!=i),0==nodes.length&&(i=1,sort=0),4==i)setTimeout(function(){null!=xxmap.map&&xxmap.map.updateSize()},200);else{deviceHeaderId=0,deviceHeaderCount={},deviceHeaderTotal=0,deviceHeaders={},deviceHeadersTitles={};var r=[];0==sort?nodes.sort(meshSort):1==sort?nodes.sort(powerSort):2==sort?1==showRealNames?nodes.sort(deviceHostSort):nodes.sort(deviceSort):5==sort&&(deviceViewSettings&&deviceViewSettings.devsCols&&deviceViewSettings.devsCols.indexOf("lastseen")>=0||(0==requestedLastConnects&&(requestedLastConnects=!0,meshserver.send({action:"lastconnects"})),null==deviceViewSettings&&(deviceViewSettings={}),Array.isArray(deviceViewSettings.devsCols)?deviceViewSettings.devsCols.push("lastseen"):deviceViewSettings.devsCols=["user","ip","conn","lastseen"]),nodes.sort(lastConnectSort));var l=Q("column_l").clientWidth-60,d=Math.floor(l/301);d=301+Math.floor((l-301*d)/d);var c=4;for(var u in deviceViewSettings&&deviceViewSettings.devsCols&&(c=deviceViewSettings.devsCols.length+1,deviceViewSettings.devsCols.indexOf("desc")>=0&&c--),nodes){if(0!=(H=nodes[u]).v){var p=meshes[H.meshid],m=GetNodeRights(H);if(0==sort){if((meshes[H.meshid]?H.meshid:"*")!=n){1!=i&&3!=i&&5!=i||null==n||(e+="</div>"),deviceHeaderSet();var g="";if(2==i&&(e+="<tr><td colspan="+c+">"),meshes[H.meshid]&&1==meshes[H.meshid].mtype&&(g="<span class=devHeaderx>, только для Intel&reg; AMT</span>"),meshes[H.meshid]&&3==meshes[H.meshid].mtype&&(g=meshes[H.meshid].relayid?"<span class=devHeaderx>, Ретранслируемые устройства</span>":"<span class=devHeaderx>, Локальные устройства</span>"),1==i&&null!=n&&(2==t&&(e+="<td><div style=width:301px></div></td>"),""!=e&&(e+="</tr></table>")),2==i&&(e+="<div>"),e+="<div class=DevSt style=width:100%;padding-top:4px><span style=float:right>",e+="<span id=DevxHeader"+deviceHeaderId+" class=devHeaderx></span>"+g,e+="</span>",1==i||2==i||3==i||5==i){var v=CollapsedGroups[H.meshid];e+='<i role="button" cmenu=expandAllContextMenu onclick=toggleCollapseGroup("'+deviceHeaderId+'","'+H.meshid+'",'+i+') class="fa-fw fa-solid '+(!0===v?"fa-chevron-right":"fa-chevron-down")+'" id="DevxColImg'+deviceHeaderId+'"></i>'}meshes[H.meshid]?(e+='<span id=MxMESH cmenu=meshContextMenu tabindex=0 style=cursor:pointer onclick=gotoMesh("'+H.meshid+"\") onkeypress=\"if (event.key=='Enter') gotoMesh('"+H.meshid+"')\">"+EscapeHtml(meshes[H.meshid].name)+"</span>"+getMeshActions(p,m)+"</div>",n=H.meshid):(e+="<span id=MxMESH><i>Индивидуальные устройства</i></span></div>",n="*"),2==i&&(e+="</div>"),o[n]=1,t=0,1!=i&&3!=i&&5!=i||(e+="<div id=DevxCol"+deviceHeaderId+(!0===v?" style=display:none":"")+">")}}else if(1==sort){var h=H.pwr?H.pwr:0;if(h!==n){if(1!=i&&3!=i&&5!=i||null==n||(e+="</div>"),deviceHeaderSet(),1==i&&null!==n&&(2==t&&(e+="<td><div style=width:301px></div></td>"),""!=e&&(e+="</tr></table>")),2==i&&(e+="<tr><td colspan="+c+">"),e+="<div class=DevSt style=width:100%;padding-top:4px><span id=DevxHeader"+deviceHeaderId+" class=devHeaderx style=float:right></span>",1==i||2==i||3==i||5==i){v=CollapsedGroups["pwr:"+h];e+='<i role="button" cmenu=expandAllContextMenu onclick=toggleCollapseGroup("'+deviceHeaderId+'","pwr:'+h+'",'+i+') class="fa-fw fa-solid '+(!0===v?"fa-chevron-right":"fa-chevron-down")+'" id="DevxColImg'+deviceHeaderId+'"></i>'}e+="<span>"+PowerStateStr2(H.pwr)+"</span></div>",n=h,t=0,1!=i&&3!=i&&5!=i||(e+="<div id=DevxCol"+deviceHeaderId+(!0===v?" style=display:none":"")+">")}}else 2!=sort&&5!=sort||null==n&&(n="1");if(1==i)e+="<div name=xxdevice1 id=xv1"+H._id+" style=display:inline-block;position:relative;width:"+d+"px;height:50px;padding-top:1px;padding-bottom:1px></div>";else if(2==i){var f=H.meshid;1==sort?f="pwr:"+(H.pwr?H.pwr:0):3!=sort&&4!=sort||(f="tag:**xx**xx*TaG*xx**xx**"),e+="<tr name=xxdevice2 colname=DevxCol"+f+" style=height:20px"+((v=3!=sort&4!=sort&CollapsedGroups[f])?";display:none":"")+" id=xv2"+H._id+"></tr>"}else(3==i||5==i)&&1&H.conn&&0!=(8&m||256&m)&&H.agent&&1&H.agent.caps&&(0==Object.keys(checkedNodeids).length||checkedNodeids[H._id])&&(e+=updateDeviceViewHtml(i,null,H),r.push(H._id));if((3==sort||4==sort)&&""!=e){if(H.tags)for(var x in H.tags){var k=H.tags[x];4==sort&&(k=p?p.name+" - "+H.tags[x]:"**INDV*~*DEVS** - "+H.tags[x]);v=CollapsedGroups["tag:"+encodeURIComponentEx(k)];var y=e.replace("**xx**xx*TaG*xx**xx**",encodeURIComponentEx(k)+(v?" style=display:none":""));if(null==a[k]?(a[k]=y,s[k]=1):(a[k]+=y,s[k]+=1),3==i||5==i)break}else if(4==sort&&null!=p&&(null==H.tags||0==H.tags.length)){k=p.name,v=CollapsedGroups["tag:"+encodeURIComponentEx(k)],y=e.replace("**xx**xx*TaG*xx**xx**",encodeURIComponentEx(k)+(v?" style=display:none":""));null==a[k]?(a[k]=y,s[k]=1):(a[k]+=y,s[k]+=1)}e=""}deviceHeaderTotal++,void 0===deviceHeaderCount[H.state]?deviceHeaderCount[H.state]=1:deviceHeaderCount[H.state]++}}if(1==i&&null!=n&&(e+="</div>"),r.length>=32&&(Q("autoConnectDesktopCheckbox").checked=!1),QE("autoConnectDesktopCheckbox",r.length<32),3==sort||4==sort){var b=[],w=0;for(var u in a)b.push(u);for(var x in b.sort(function(e,t){return sortCollator.compare(e.toLowerCase(),t.toLowerCase())}),b){u=b[x];if(2==i){e+="<tr><td colspan="+c+"><div class=DevSt style=width:100%;padding-top:4px>";v=CollapsedGroups["tag:"+encodeURIComponentEx(u)];e+='<i role="button" cmenu=expandAllContextMenu onclick=toggleCollapseGroup("'+w+'","tag:'+encodeURIComponentEx(u)+'",2) class="fa-fw fa-solid '+(!0===v?"fa-chevron-right":"fa-chevron-down")+'" id="DevxColImg'+w+'"></i>',e+="<span class=devHeaderx style=float:right>"+s[u]+" node"+(s[u]>1?"s":"")+"</span><span>"+EscapeHtml(u).split("|").join(" &rarr; ").split("**INDV*~*DEVS**").join("<i>Индивидуальные устройства</i>")+"</span></div>"+a[u]}else{e+="<div class=DevSt style=width:100%;padding-top:4px><span class=devHeaderx style=float:right>"+format(s[u]>1?"{0} nodes":"{0} node",s[u])+"</span>";v=CollapsedGroups["tag:"+encodeURIComponentEx(u)];e+='<i role="button" cmenu=expandAllContextMenu onclick=toggleCollapseGroup("'+w+'","tag:'+encodeURIComponentEx(u)+'") class="fa-fw fa-solid '+(!0===v?"fa-chevron-right":"fa-chevron-down")+'" id="DevxColImg'+w+'"></i>',e+="<span>"+EscapeHtml(u).split("|").join(" &rarr; ").split("**INDV*~*DEVS**").join("<i>Индивидуальные устройства</i>")+"</span></div>",e+="<div id=DevxCol"+w+(!0===v?" style=display:none":"")+">"+a[u]+"</div>"}w++}}var M=!1;if(""==e&&nodes.length>0&&(""!=Q("SearchInput").value||0!=Q("DevFilterSelect").value)&&(M=!0,e=3==sort?'<div style="margin:30px">Ни одно устройство не включено ни в одну группу, нажмите на «Группы» устройства, чтобы добавить их в группу.</div>':'<div style="margin:30px">Нет устройств, соответствующих этому запросу. <a onclick=clearDeviceSearch()>Очистить фильтр поиска</a></div>'),1==i&&2==t&&(e+="<td><div style=width:301px></div></td>"),0==sort&&""==Q("SearchInput").value&&0==Q("DevFilterSelect").value&&i<3){var C=deviceHeaderId,S=[];for(var u in meshes)S.push(meshes[u]);for(var u in S.sort(nameSort),S){var A=S[u];m=GetMeshRights(A);if(null==o[A._id]){""!=n&&""!=e&&(e+="</tr></table>"),e+="<table style=width:100%;padding-top:4px cellpadding=0 cellspacing=0><tr><td colspan=3 class=DevSt>",C++;v=CollapsedGroups[A._id];e+='<i role="button" cmenu=expandAllContextMenu onclick=toggleCollapseGroup("'+C+'","'+A._id+'") class="fa-fw fa-solid '+(!0===v?"fa-chevron-right":"fa-chevron-down")+'" id="DevxColImg'+C+'"></i>',e+='<span id=MxMESH style=cursor:pointer onclick=gotoMesh("'+A._id+'")>'+EscapeHtml(A.name)+"</span><span>",e+=getMeshActions(A,m),e+="</span></td></tr><tr>",1==A.mtype?(e+="<td><div style=padding:10px><i>В этой группе нет устройств Intel&reg; AMT",!(4&m)||4294967295!=userinfo.siteadmin&&4096&userinfo.siteadmin||(e+=", <a href=# style=cursor:pointer onclick='return addDeviceToMesh(\""+A._id+"\")'>добавить</a>")):2==A.mtype?(e+="<td><div id=DevxCol"+C+(!0===v?" style=display:none":"")+">",e+="<div style=padding:10px><i>В этой группе нет устройств",!(4&m)||4294967295!=userinfo.siteadmin&&4096&userinfo.siteadmin||(e+=", <a href=# style=cursor:pointer onclick='return addAgentToMesh(\""+A._id+"\")'>добавить</a>")):3==A.mtype?(e+="<td><div id=DevxCol"+C+(!0===v?" style=display:none":"")+">",e+="<div style=padding:10px><i>В этой группе нет локальных устройств",!(4&m)||4294967295!=userinfo.siteadmin&&4096&userinfo.siteadmin||(e+=", <a href=# style=cursor:pointer onclick='return addLocalDeviceToMesh(\""+A._id+"\")'>добавить</a>")):4==A.mtype&&(e+="<td><div id=DevxCol"+C+(!0===v?" style=display:none":"")+">",e+="<div style=padding:10px><i>В этой группе нет устройств"),e+=".</i></div></td>",e+="</div>",n=A._id}}}if(""!=e&&0==M){if(e+="</table>",2==i){var D="";null==deviceViewSettings&&(deviceViewSettings={}),Array.isArray(deviceViewSettings.devsCols)||(deviceViewSettings.devsCols=["user","ip","conn"]),deviceViewSettings.devsCols.indexOf("agtype")>=0&&(D+="<th style=width:100px>Тип агента"),deviceViewSettings.devsCols.indexOf("agver")>=0&&(D+="<th style=width:100px>Версия агента"),deviceViewSettings.devsCols.indexOf("os")>=0&&(D+="<th style=width:160px>ОС"),deviceViewSettings.devsCols.indexOf("tags")>=0&&(D+="<th style=width:120px>Теги"),deviceViewSettings.devsCols.indexOf("windowsav")>=0&&(D+="<th style=width:100px>Windows AV"),deviceViewSettings.devsCols.indexOf("windowsupdate")>=0&&(D+="<th style=width:120px>Windows Update"),deviceViewSettings.devsCols.indexOf("windowsfirewall")>=0&&(D+="<th style=width:120px>Windows Firewall"),deviceViewSettings.devsCols.indexOf("lastbootuptime")>=0&&(D+="<th style=width:120px>Last Boot Up Time"),deviceViewSettings.devsCols.indexOf("links")>=0&&(D+="<th style=width:120px>Ссылки"),deviceViewSettings.devsCols.indexOf("user")>=0&&(D+="<th style=width:120px>Пользователь"),deviceViewSettings.devsCols.indexOf("ip")>=0&&(D+="<th style=width:120px>Адрес"),deviceViewSettings.devsCols.indexOf("conn")>=0&&(D+="<th style=width:100px>Соединение"),deviceViewSettings.devsCols.indexOf("amthost")>=0&&(D+="<th style=width:100px>AMT Host"),deviceViewSettings.devsCols.indexOf("amtstate")>=0&&(D+="<th style=width:100px>AMT State"),deviceViewSettings.devsCols.indexOf("lastseen")>=0&&(D+="<th style=width:120px>Последний визит",0==requestedLastConnects&&(requestedLastConnects=!0,meshserver.send({action:"lastconnects"}))),e="<table style=width:100%;margin-top:4px;table-layout:fixed cellpadding=0 cellspacing=0><th>"+D+e+"</tr></table><div style=height:1px></div>"}}else e+="</table>",3==sort&&(e='<div style="margin:10px"><i>Не найдено устройств с тегом.</i></div>');for(var u in e+="<div style=border-top-style:solid;border-top-width:1px;border-top-color:#DDDDDD;cursor:pointer;font-size:small;margin-top:4px>",!(i<3&&0==sort&&Object.keys(meshes).length>0)||4294967295!=userinfo.siteadmin&&64&userinfo.siteadmin||(e+='<a href=# onclick="return account_createMesh()" title="Создать новую группу устройств." style=cursor:pointer>Добавить группу устройств</a>&nbsp'),4294967295!=userinfo.siteadmin&&128&userinfo.siteadmin||(e+="<a href=# onclick='return p10showMeshCmdDialog(0)' style=cursor:pointer title=\"Скачать MeshCmd, инструмент командной строки, выполняющий множество функций.\">MeshCmd</a>&nbsp","win32"!=navigator.platform.toLowerCase()&&"macintel"!=navigator.platform.toLowerCase()||(e+="<a href=# onclick='return p10showMeshRouterDialog()' style=cursor:pointer title=\"Скачать MeshCentral Router, инструмент переадресации TCP портов.\">Router</a>&nbsp")),e+="</div><div style=height:60px></div>",QH("xdevices",e),deviceHeaderSet(),deviceHeaders)QH(u,deviceHeaders[u]);for(var u in deviceHeadersTitles)Q(u).title=deviceHeadersTitles[u];if(p1updateInfo(),3!=i&&5!=i||1!=xxcurrentView)disconnectAllKvmFunction(),Q("autoConnectDesktopCheckbox").checked=!1;else{var T=[{x:180,y:101},{x:302,y:169},{x:454,y:255}][Q("sizeselect").selectedIndex];if(3==i){var E=T.x+2,_=l-5,N=Math.floor(_/E);N=E+Math.floor((_-N*E)/N),T.y=T.y*(N/T.x),T.x=N}for(var u in multiDesktop)multiDesktop[u].xxdelete=!0;for(var u in r){var I=r[u],V=I.split("/")[2],U=multiDesktop[I];if(null!=U){var R=5==i?U.m.width*T.y/U.m.height:T.x;U.m.CanvasId.setAttribute("style","background-color:black;width:"+R+"px;height:"+T.y+"px"),Q("xkvmid_"+V).appendChild(U.m.CanvasId),delete U.xxdelete,QH("skvmid_"+V,["Отключен","Подключение...","Установка...","",""][null==U.m.State?U.m.state:U.m.State])}else{var H=getNodeFromId(I);if(desktopNode==H&&null!=desktop){t=desktop.m.CanvasId,R=5==i?desktop.m.width*T.y/desktop.m.height:T.x;t.setAttribute("id","kvmid_"+V),t.setAttribute("style","background-color:black;width:"+R+"px;height:"+T.y+"px"),t.setAttribute("onclick","toggleKvmDevice('"+I+"')"),t.removeAttribute("onmousedown"),t.removeAttribute("onmouseup"),t.removeAttribute("onmousemove"),Q("xkvmid_"+V).appendChild(t),QH("skvmid_"+V,["Отключен","Подключение...","Установка...","",""][null==desktop.m.State?desktop.m.state:desktop.m.State]),desktop.m.SendCompressionLevel&&desktop.m.SendCompressionLevel(multidesktopsettings.agentencoding,multidesktopsettings.quality,multidesktopsettings.scaling,multidesktopsettings.framerate),desktop.shortid=V,desktop.onStateChanged=onMultiDesktopStateChange,desktop.m.onRemoteInputLockChanged=null,desktop.m.onKeyboardStateChanged=null,multiDesktop[I]=desktop,desktop=desktopNode=currentNode=null,QH("DeskParent",'<canvas id="Desk" oncontextmenu="return false" onmousedown=dmousedown(event) onmouseup=dmouseup(event) onmousemove=dmousemove(event)></canvas>')}else{(t=document.createElement("canvas")).setAttribute("id","kvmid_"+V),t.setAttribute("width",640),t.setAttribute("height",480),t.setAttribute("oncontextmenu","return false"),t.setAttribute("style","background-color:black;width:"+T.x+"px;height:"+T.y+"px"),t.setAttribute("onclick","toggleKvmDevice('"+I+"')");try{Q("xkvmid_"+V).appendChild(t)}catch(e){}1==Q("autoConnectDesktopCheckbox").checked&&setTimeout(function(){connectMultiDesktop(H,1)},100)}}}for(var u in multiDesktop)1==multiDesktop[u].xxdelete?(multiDesktop[u].Stop(),delete multiDesktop[u]):debugmode&&multiDesktop[u].m&&multiDesktop[u].m.onScreenSizeChange&&mdeskAdjust(multiDesktop[u].m,multiDesktop[u].m.ScreenWidth,multiDesktop[u].m.ScreenHeight,multiDesktop[u].m.CanvasId);deskAdjust()}}oldviewmode=i,onDevicesScrollEx()}}var xxModal,onDevicesTouchActive=!1,onDevicesScrollnagleTimer=null;function onDevicesScroll(e){void 0===e&&(e=!1),e&&(Q("xdevices").scrollTop=0),null!=onDevicesScrollnagleTimer||onDevicesTouchActive||(onDevicesScrollnagleTimer=setTimeout(onDevicesScrollEx,250))}function onDeviceTouch(e){onDevicesTouchActive!=e&&(onDevicesTouchActive=e,0==e&&onDevicesScrollEx())}function onDevicesScrollEx(){null!=onDevicesScrollnagleTimer&&(clearTimeout(onDevicesScrollnagleTimer),onDevicesScrollnagleTimer=null);for(var e=Q("xdevices").scrollTop-200,t=Q("xdevices").scrollTop+Q("xdevices").clientHeight+200,n=Q("viewselect").value,o=document.getElementsByName("xxdevice"+n),i=0;i<o.length;i++)if(o[i].offsetTop>=e&&o[i].offsetTop<t){var a=getNodeFromId(o[i].id.substring(3));null!=a?updateDeviceViewHtml(n,o[i],a):o[i].innerHTML=""}else o[i].innerHTML=""}function updateDeviceViewDevice(e){var t=Q("viewselect").value;if(1==t||2==t){if("string"==typeof e&&(e=getNodeFromId(e)),null!=e){var n=Q("xv"+t+e._id);null!=n&&""!=n.innerHTML&&updateDeviceViewHtml(t,n,e)}}else mainUpdate(4)}function updateDeviceViewHtml(e,t,n){var o=EscapeHtml(n.name);0==o.length&&(o="<i>Пусто</i>"),null!=n.rname&&n.rname.length>0&&(o+=" / "+EscapeHtml(n.rname));var i=EscapeHtml(n.name);if(1==showRealNames&&null!=n.rname&&(i=EscapeHtml(n.rname)),0==i.length&&(i="<i>Пусто</i>"),1==e&&"none"==t.parentNode.style.display||2==e&&"none"==t.style.display)t.innerHTML="";else{var a="",s="";if(1==stars[n._id]&&(s+=2==e?"<img class=deviceNotifySmallDotSub src=images/icon-star-notify-10.png width=10 height=10>":"<img class=deviceNotifyDotSub src=images/icon-star-notify-16.png width=16 height=16>"),null!=n.sessions&&(null!=n.sessions.msg&&(s+=2==e?"<div onclick=showDeviceMessages('"+n._id+'\',null,event) style="width:10;height:10" class=deviceNotifySmallDotSub></div>':"<div onclick=showDeviceMessages('"+n._id+'\',null,event) style="width:16;height:16" class=deviceNotifyDotSub>'+Object.keys(n.sessions.msg).length+"</div>"),null==n.sessions.kvm&&null==n.sessions.terminal&&null==n.sessions.files&&null==n.sessions.tcp&&null==n.sessions.udp||(s+=2==e?"<img onclick=showDeviceSessions('"+n._id+"',null,event) class=deviceNotifySmallDotSub src=images/icon-relay-notify10.png width=10 height=10>":"<img onclick=showDeviceSessions('"+n._id+"',null,event) class=deviceNotifyDotSub src=images/icon-relay-notify.png width=16 height=16>"),null!=n.sessions.help&&(s+=2==e?"<img onclick=showDeviceHelpRequests('"+n._id+"',null,event) class=deviceNotifySmallDotSub src=images/icon-help-notify-10.png width=10 height=10>":"<img onclick=showDeviceHelpRequests('"+n._id+"',null,event) class=deviceNotifyDotSub src=images/icon-help-notify-16.png width=16 height=16>"),null!=n.sessions.battery&&1==e)){var r=n.sessions.battery,l="";"ac"==r.state&&(l="Устройство подключено"),"dc"==r.state&&(l="Устройство работает от аккумулятора");var d="",c=-1;"number"==typeof r.level&&r.level>=0&&r.level<=100&&(d=r.level+"%",(c=Math.floor((r.level+10)/25)+1)>5&&(lvl=5),"ac"==r.state&&(100==r.level?c=11:c+=5)),c>0&&(a+='<div class="deviceBatterySmall deviceBatterySmall'+c+'" title="'+(null!=l?l+", "+d:d)+'"></div>')}""!=s&&(a+=2==e?"<div class=deviceNotifySmallDot>"+s+"</div>":"<div class=deviceNotifyDot>"+s+"</div>");var u=n.icon;if(n.conn&&0!=n.conn||3==n.mtype||(u+=" gray"),1==e)t.innerHTML='<table id=devs cmenu=devsContentMenu onmouseover=devMouseHover(this,1) onmouseout=devMouseHover(this,0) style=width:100%;height:100%><tr><td style=width:22px><input class="'+n.meshid+' DeviceCheckbox form-check-input me-2" onchange=p1devcheck(event) value=devid_'+n._id+" type=checkbox "+(checkedNodeids[n._id]?" checked":"")+"></td><td><table onmouseup=gotoDevice('"+n._id+"',null,null,event) border=0 cellspacing=0 style=width:100%;height:100%;cursor:pointer><tr><td style=width:50px tabindex=0 onkeypress=\"if (event.key=='Enter') gotoDevice('"+n._id+'\',null,null,event)"><div class="i'+u+'" style=width:50px></div></td><td class=g1t></td><td class=e2t><div class=e1t style=width:'+(t.clientWidth-120)+'px title="'+o+'">'+i+"</div><div>"+NodeStateStr(n)+"</div></td><td class=g2t></td></tr></table></td></tr></table>"+a;else if(2==e){var p=[];if(n.conn&&(1&n.conn&&(4==n.mtype?"PDU"==n.porttype?p.push('<span title="Порт свитча готов к использованию.">Свитч</span>'):p.push('<span title="Порт IP-KVM подключен и готов к использованию.">IP-KVM</span>'):p.push('<span title="Mesh Agent подключен и готов к использованию.">Агент</span>')),2&n.conn?p.push('<span title="Intel&reg; AMT CIRA подключен и готов к использованию.">CIRA</span>'):4&n.conn&&p.push('<span title="Intel&reg; AMT маршрутизируется.">AMT</span>'),8&n.conn&&p.push('<span title="Mesh Agent доступен с использованием другого агента в качестве ретранслятора.">Ретранслятор</span>'),16&n.conn&&p.push('<span title="MQTT подключение к устройству активно.">MQTT</span>')),3==n.mtype){var m=meshes[n.meshid];m&&m.relayid?p.push('<span title="Подключение к локальной сети через агент ретрансляции.">Ретранслятор</span>'):p.push('<span title="Локальное сетевое подключение.">Локальный</span>')}n.desc&&deviceViewSettings.devsCols.indexOf("desc")>=0&&(i='<div class="flex-grow-1">'+i+"</div><div style=float:right"+(1==stars[n._id]?";padding-right:15px":"")+">"+EscapeHtml(n.desc)+"</div>");var g=n.meshid;1==sort?g="pwr:"+(n.pwr?n.pwr:0):3!=sort&&4!=sort||(g="tag:**xx**xx*TaG*xx**xx**");CollapsedGroups[g];var v="<td style=position:relative><div id=devs cmenu=devsContentMenu class=bar18 tabindex=0 onmouseover=devMouseHover(this,1) onmouseout=devMouseHover(this,0) style=height:18px;width:100%;font-size:medium onkeypress=\"if (event.key=='Enter') gotoDevice('"+n._id+"',null,null,event)\">";if(v+='<div class=deviceBarCheckbox><input class="'+n.meshid+' DeviceCheckbox form-check-input me-2" value=devid_'+n._id+" type=checkbox onchange=p1devcheck(event) "+(checkedNodeids[n._id]?" checked":"")+"></div>",v+="<div class=deviceBarIcon onmouseup=gotoDevice('"+n._id+"',null,null,event)><div class=\"j"+u+'" style=width:16px;margin-top:1px;margin-left:2px;height:16px></div></div>',v+="<div class=g1 style=height:18px;float:left></div><div class=g2 style=height:18px;float:right></div>",v+='<div class="style10 d-flex align-items-center" style=cursor:pointer;font-size:14px;max-height:18px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap title="'+o+"\" onmouseup=gotoDevice('"+n._id+"',null,null,event)>"+i+"</div></div>"+a+"</td>",null==deviceViewSettings&&(deviceViewSettings={}),Array.isArray(deviceViewSettings.devsCols)||(deviceViewSettings.devsCols=["user","ip","conn"]),deviceViewSettings.devsCols.indexOf("agtype")>=0&&(v+='<td style=text-align:center;font-size:x-small;padding-left:4px;padding-right:4px title="'+EscapeHtml(3!=n.mtype&&n.agent&&n.agent.id&&n.agent.id<=agentsStr.length?agentsStr[n.agent.id]:"")+'">'+EscapeHtml(3!=n.mtype&&n.agent&&n.agent.id&&n.agent.id<=agentsStr.length?agentsStr[n.agent.id]:"").replace(",","<br />")),deviceViewSettings.devsCols.indexOf("agver")>=0&&(v+='<td style=text-align:center;font-size:x-small;padding-left:4px;padding-right:4px title="'+EscapeHtml(n.agent&&n.agent.core?n.agent.core:"")+'">'+EscapeHtml(n.agent&&n.agent.core?n.agent.core:"").replace(",","<br />")),deviceViewSettings.devsCols.indexOf("os")>=0)if(3==n.mtype){var h="";4==n.agent.id&&(h="Windows"),6==n.agent.id&&(h="Linux"),29==n.agent.id&&(h="MacOS"),v+='<td style=text-align:center;font-size:x-small title="'+EscapeHtml(h)+'">'+EscapeHtml(h)}else v+='<td style=text-align:center;font-size:x-small title="'+EscapeHtml(n.osdesc?n.osdesc:"")+'">'+EscapeHtml(n.osdesc?n.osdesc:"");if(deviceViewSettings.devsCols.indexOf("tags")>=0){v+="<td style=text-align:center;font-size:x-small>";var f="";if(null!=n.tags)for(var x in n.tags)f+="<span class=tagSpan>"+EscapeHtml(n.tags[x])+"</span> ";v+="<span style=line-height:20px>"+f+"</span>"}if(deviceViewSettings.devsCols.indexOf("windowsav")>=0&&(v+="<td style=text-align:center>"+(n.wsc&&null!=n.wsc.antiVirus?"OK"==n.wsc.antiVirus?"<span style=color:green>OK</span>":"<span style=color:red>BAD</span>":"")),deviceViewSettings.devsCols.indexOf("windowsupdate")>=0&&(v+="<td style=text-align:center>"+(n.wsc&&null!=n.wsc.autoUpdate?"OK"==n.wsc.autoUpdate?"<span style=color:green>OK</span>":"<span style=color:red>BAD</span>":"")),deviceViewSettings.devsCols.indexOf("windowsfirewall")>=0&&(v+="<td style=text-align:center>"+(n.wsc&&null!=n.wsc.firewall?"OK"==n.wsc.firewall?"<span style=color:green>OK</span>":"<span style=color:red>BAD</span>":"")),deviceViewSettings.devsCols.indexOf("lastbootuptime")>=0&&(v+="<td style=text-align:center;font-size:x-small>"+(null!=n.lastbootuptime?printDateTime(new Date(n.lastbootuptime)):"")),deviceViewSettings.devsCols.indexOf("links")>=0&&(v+="<td style=text-align:center;font-size:x-small>"+getShortRouterLinks(n)),deviceViewSettings.devsCols.indexOf("user")>=0&&(v+="<td style=text-align:center>"+getUserShortStr(n)),deviceViewSettings.devsCols.indexOf("ip")>=0){var k="";3==n.mtype?k=n.host:n.ip&&(k=n.ip),v+='<td style=text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis title="'+EscapeHtml(k)+'">'+EscapeHtml(k)}if(deviceViewSettings.devsCols.indexOf("conn")>=0&&(v+="<td style=text-align:center>"+p.join("&nbsp;+&nbsp;")),deviceViewSettings.devsCols.indexOf("amthost")>=0&&(v+="<td style=text-align:center>"+(null==n.intelamt||null==n.intelamt.host?"":EscapeHtml(n.intelamt.host))),deviceViewSettings.devsCols.indexOf("amtstate")>=0){var y="";n.intelamt&&(0==n.intelamt.state&&(y=' <span title="Intel&reg; AMT is not activated">Pre</span>'),1==n.intelamt.state&&(y=' <span title="Intel&reg; AMT is in activation mode">In</span>'),2==n.intelamt.state&&n.intelamt.flags&&(2&n.intelamt.flags?y=' <span title="Intel&reg; AMT активирован в режиме клиента">CCM</span>':4&n.intelamt.flags&&(y+=' <span title="Intel&reg; AMT активирован в режиме администратора">ACM</span>'))),v+="<td style=text-align:center>"+y}deviceViewSettings.devsCols.indexOf("lastseen")>=0&&(v+="<td style=text-align:center;font-size:x-small>",n.conn>0?v+="Подключено":null!=n.lastconnect&&(v+=printDateTime(new Date(n.lastconnect)))),t.innerHTML=v}else if(3==e||5==e){v="<div id=devs cmenu=devsContentMenu style=display:inline-block;position:relative;margin:1px;background-color:lightgray;border-radius:5px;position:relative><div tabindex=0 style=padding:3px;cursor:pointer onmouseup=gotoDevice('"+n._id+"',11,null,event) onkeypress=\"if (event.key=='Enter') gotoDevice('"+n._id+"',11,null,event)\">"+a;return v+='<div class="j'+u+'" style=width:16px;float:left></div>&nbsp;'+i+"</div>",v+="<span onmouseup=gotoDevice('"+n._id+"',null,null,event)></span><div id=xkvmid_"+n._id.split("/")[2]+"><div id=skvmid_"+n._id.split("/")[2]+' tabindex=0 style="position:absolute;color:white;left:5px;top:27px;text-shadow:0px 0px 5px #000;z-index:10;cursor:default" onclick=toggleKvmDevice(\''+n._id+"') onkeypress=\"if (event.key=='Enter') toggleKvmDevice('"+n._id+"')\">Отключен</div></div>",v+="</div>"}}}function getShortRouterLinks(e){var t="",n=GetNodeRights(e);if((1&e.conn||3==e.mtype)&&e.agent&&8&n&&14!=e.agent.id&&(0!=webRelayPort&&(t+='<a href=# onclick=p10WebRouter("'+e._id+'",1,'+(e.httpport?e.httpport:80)+")>HTTP"+(e.httpport&&80!=e.httpport?"/"+e.httpport:"")+"</a>&nbsp;",t+='<a href=# onclick=p10WebRouter("'+e._id+'",2,'+(e.httpsport?e.httpsport:443)+")>HTTPS"+(e.httspport&&443!=e.httpsport?"/"+e.httpsport:"")+"</a>&nbsp;"),e.agent.id>0&&e.agent.id<5&&"win32"==navigator.platform.toLowerCase()&&(null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.rdp||(t+='<a href=# cmenu=altPortContextMenu id=rdpMCRouterLink onclick=p10MCRouter("'+e._id+'",3)>RDP</a>&nbsp;')),e.agent.id>4&&("win32"!=navigator.platform.toLowerCase()&&"macintel"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.ssh||(t+='<a href=# onclick=p10MCRouter("'+e._id+'",4,'+(e.sshport?e.sshport:22)+")>SSH</a>&nbsp;"),"win32"==navigator.platform.toLowerCase()&&(null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.scp||(t+='<a href=# onclick=p10MCRouter("'+e._id+'",5,'+(e.sshport?e.sshport:22)+")>SCP</a>&nbsp;"))),("win32"==navigator.platform.toLowerCase()||"macintel"==navigator.platform.toLowerCase())&&null!=serverinfo.devicemeshrouterlinks&&Array.isArray(serverinfo.devicemeshrouterlinks.extralinks)))for(var o in serverinfo.devicemeshrouterlinks.extralinks){var i=serverinfo.devicemeshrouterlinks.extralinks[o],a='"'+i.protocol+'"';if(doesDeviceMatchFilterTags(e,i.filter)){if(3==e.mtype&&("mcrdesktop"==i.protocol||"mcrfiles"==i.protocol))continue;"number"==typeof i.protocol?a=i.protocol:"http"==i.protocol?a=1:"https"==i.protocol?a=2:"rdp"==i.protocol?a=3:"ssh"==i.protocol?a=4:"scp"==i.protocol?a=5:"mcrdesktop"==i.protocol?a=6:"mcrfiles"==i.protocol&&(a=7),t+='<a href=# onclick=p10MCRouter("'+e._id+'",'+a+","+i.port+(i.ip?',"'+i.ip+'"':",null")+","+(i.localport?i.localport:0)+")>"+i.name+"</a>&nbsp;"}}return t}function doesDeviceMatchFilterTags(e,t){if(null==t)return!0;if(!Array.isArray(t))return!1;if(t.indexOf(e.meshid)>=0)return!0;if(t.indexOf(e._id)>=0)return!0;if(Array.isArray(e.tags))for(var n in e.tags)if(t.indexOf("tag:"+e.tags[n])>=0)return!0;return!1}function showDeviceHelpRequests(e,t,n){if(n&&haltEvent(n),xxdialogMode&&!t)return!1;var o=null,i="";if(null==(o=null==e?currentNode:getNodeFromId(e))||null==o.sessions)return setDialogMode(0),!1;if(null!=o.sessions.help)for(var a in o.sessions.help)i+='<div style="background-color:#CCC;padding:6px;border-radius:6px"><a style="float:right" onclick=closeDeviceHelpRequest("'+encodeURIComponentEx(a)+'","'+encodeURIComponentEx(o._id)+'")>Отклонить</a><div style=margin-bottom:6px><b>'+EscapeHtml(a)+"</b></div><div style=margin-bottom:6px>"+EscapeHtml(o.sessions.help[a])+"</div></div>";return""!=i&&(xxdialogTag="HELPREQ-"+o._id,setModalContent("xxAddAgent","Запросы на помощь - "+EscapeHtml(o.name),i),showModal("xxAddAgentModal","idx_dlgOkButton")),!1}function closeDeviceHelpRequest(e,t){setDialogMode(0),meshserver.send({action:"msg",type:"localapp",nodeid:decodeURIComponent(t),appid:decodeURIComponent(e),value:{cmd:"cancelhelp"}})}function showDeviceSessions(e,t,n){if(n&&haltEvent(n),xxdialogMode&&!t)return!1;var o=null,i="";if(null==(o=null==e?currentNode:getNodeFromId(e))||null==o.sessions)return setDialogMode(0),!1;for(var a in o.sessions)if("kvm"==a&&null==o.sessions.multidesk)for(var s in i+="<u>Удаленного рабочего стола</u>",o.sessions.kvm)if(s.startsWith("user/")){var r="";s!=userinfo._id&&4294967295!=GetNodeRights(o)||(r=' <i role=button onclick=\'return endDeviceSession("kvm", "'+encodeURIComponentEx(o._id)+'", "'+encodeURIComponentEx(s)+'")\' title="Отключить этот сеанс" class="fa-fw fa-solid fa-trash text-danger" ></i>'),i+=addHtmlValue2(getUserName(s),(1==o.sessions.kvm[s]?"1 сессия":nobreak(format("{0} сессий",o.sessions.kvm[s])))+r)}else"busy"==s&&(i+=addHtmlValue2("Устройство занято",1==o.sessions.kvm[s]?"1 сессия":nobreak(format("{0} сессий",o.sessions.kvm[s]))));else if("multidesk"==a)for(var s in i+="<u>Удаленного рабочего стола</u>",o.sessions.multidesk){r="";s!=userinfo._id&&4294967295!=GetNodeRights(o)||(r=' <i role=button onclick=\'return endDeviceSession("multidesk", "'+encodeURIComponentEx(o._id)+'", "'+encodeURIComponentEx(s)+'")\' title="Отключить этот сеанс" class="fa-fw fa-solid fa-trash text-danger"></i>'),i+=addHtmlValue2(getUserName(s),(1==o.sessions.multidesk[s]?"1 сессия":nobreak(format("{0} сессий",o.sessions.multidesk[s])))+r)}else if("terminal"==a)for(var s in i+="<u>Терминал</u>",o.sessions.terminal){r="";s!=userinfo._id&&4294967295!=GetNodeRights(o)||(r=' <i role=button onclick=\'return endDeviceSession("terminal", "'+encodeURIComponentEx(o._id)+'", "'+encodeURIComponentEx(s)+'")\' title="Отключить этот сеанс" class="fa-fw fa-solid fa-trash text-danger"></i>'),i+=addHtmlValue2(getUserName(s),(1==o.sessions.terminal[s]?"1 сессия":nobreak(format("{0} сессий",o.sessions.terminal[s])))+r)}else if("files"==a)for(var s in i+="<u>Файлы</u>",o.sessions.files){r="";s!=userinfo._id&&4294967295!=GetNodeRights(o)||(r=' <i role=button onclick=\'return endDeviceSession("files", "'+encodeURIComponentEx(o._id)+'", "'+encodeURIComponentEx(s)+'")\' title="Отключить этот сеанс" class="fa-fw fa-solid fa-trash text-danger"></i>'),i+=addHtmlValue2(getUserName(s),(1==o.sessions.files[s]?"1 сессия":nobreak(format("{0} сессий",o.sessions.files[s])))+r)}else if("tcp"==a)for(var s in i+="<u>TCP-маршрутизация</u>",o.sessions.tcp){r="";s!=userinfo._id&&4294967295!=GetNodeRights(o)||(r=' <i role=button onclick=\'return endDeviceSession("tcp", "'+encodeURIComponentEx(o._id)+'", "'+encodeURIComponentEx(s)+'")\' title="Отключить этот сеанс" class="fa-fw fa-solid fa-trash text-danger"></i>'),i+=addHtmlValue2(getUserName(s),(1==o.sessions.tcp[s]?"1 сессия":nobreak(format("{0} сессий",o.sessions.tcp[s])))+r)}else if("udp"==a)for(var s in i+="<u>UDP-маршрутизация</u>",o.sessions.udp){r="";s!=userinfo._id&&4294967295!=GetNodeRights(o)||(r=' <i role=button onclick=\'return endDeviceSession("udp", "'+encodeURIComponentEx(o._id)+'", "'+encodeURIComponentEx(s)+'")\' title="Отключить этот сеанс" class="fa-fw fa-solid fa-trash text-danger"></i>'),i+=addHtmlValue2(getUserName(s),(1==o.sessions.udp[s]?"1 сессия":nobreak(format("{0} сессий",o.sessions.udp[s])))+r)}return""!=i?(xxdialogTag="SESSIONS-"+o._id,setModalContent("xxAddAgent","Сессии - "+EscapeHtml(o.name),i),showModal("xxAddAgentModal","idx_dlgOkButton")):setDialogMode(0),!1}function endDeviceSession(e,t,n){var o=decodeURIComponent(n).split("/"),i=o[0]+"/"+o[1]+"/"+o[2],a=null;4==o.length&&o[3].startsWith("guest:")&&(a=atob(o[3].substring(6))),"multidesk"==e?meshserver.send({action:"endDesktopMultiplex",nodeid:decodeURIComponent(t),xuserid:i,guestname:a,guestname:a}):meshserver.send({action:"msg",type:"endtunnel",nodeid:decodeURIComponent(t),xuserid:i,guestname:a,guestname:a,protocol:e})}function showDeviceMessages(e,t,n){if(n&&haltEvent(n),xxdialogMode&&!t)return!1;var o=null,i="<div style=max-height:200px;overflow-y:auto>",a=0;if(null==(o=null==e?currentNode:getNodeFromId(e))||null==o.sessions||null==o.sessions.msg)return setDialogMode(0),!1;for(var s in o.sessions.msg){var r=s,l=5;"string"==typeof o.sessions.msg[s].msg&&(r=o.sessions.msg[s].msg),"number"==typeof o.sessions.msg[s].msgid&&null!=eventsMessageId[o.sessions.msg[s].msgid]&&(r=eventsMessageId[o.sessions.msg[s].msgid]),"number"==typeof o.sessions.msg[s].icon&&(l=o.sessions.msg[s].icon),(l<1||l>9)&&(l=5),i+="<table style=width:96%><td style=width:24px><div class=NotifyIconSmall"+l+'></div><td><div style="border-radius:5px;background-color:#BBB;width:100%;padding:8px">'+EscapeHtml(r)+"</div></table>",a++}return i+="</div>",a>0&&(xxdialogTag="MESSAGES-"+o._id,setModalContent("xxAddAgent","Сообщения агента - "+EscapeHtml(o.name),i),showModal("xxAddAgentModal","idx_dlgOkButton")),!1}function toggleCollapseGroup(e,t,n){if(2==n){var o,i=document.getElementsByName("xxdevice2");if(0==i.length)return;for(var a=[],s=0;s<i.length;s++)i[s].attributes.colname.value.substring(7)==t&&a.push(i[s]);(o="none"==a[0].style.display)?delete CollapsedGroups[t]:CollapsedGroups[t]=!0;for(s=0;s<a.length;s++)a[s].style.display=o?"":"none"}else(o="none"==QS("DevxCol"+e).display)?delete CollapsedGroups[t]:CollapsedGroups[t]=!0,QV("DevxCol"+e,o);o?(QC("DevxColImg"+e).remove("fa-chevron-right"),QC("DevxColImg"+e).add("fa-chevron-down")):(QC("DevxColImg"+e).remove("fa-chevron-down"),QC("DevxColImg"+e).add("fa-chevron-right")),putstore("_collapse",JSON.stringify(CollapsedGroups)),updateCollapseAllButton(),onDevicesScrollEx(),onDevicesScrollEx()}function toggleKvmDevice(e){"string"==typeof e&&(e=getNodeFromId(e));var t=GetNodeRights(e);(8&t||256&t)&&1&e.conn&&connectMultiDesktop(e,1)}function getUserShortStr(e){if(null==e||null==e.users||!Array.isArray(e.users)||0==e.users.length)return"";if(e.users.length>1)return'<span title="'+EscapeHtml(e.users.join(", "))+'">'+nobreak(format("{0} пользователей",e.users.length))+"</span>";var t=e.users[0],n=t,o=t.indexOf("\\");return o>0&&(n=t.substring(o+1)),(n=EscapeHtml(n)).length>15&&(n=n.substring(0,14)+"&#8230;"),e.lusers&&e.lusers.length>0?addKeyLinkConditional(n,EscapeHtml(t)+" (Заблокирован)",e.lusers&&e.lusers.indexOf(t)>=0):'<span title="'+EscapeHtml(t)+'">'+n+"</span>"}function autoConnectDesktops(){1==Q("autoConnectDesktopCheckbox").checked&&connectAllKvmFunction()}function connectAllKvmFunction(e){if(xxdialogMode)return!1;if(!0!==e){var t=0;for(var n in nodes){var o=nodes[n],i=nodes[n]._id;if(null==multiDesktop[i]&&(0==Object.keys(checkedNodeids).length||checkedNodeids[i])){var a=GetNodeRights(o);(8&a||256&a)&&1&o.conn&&1==o.v&&t++}}if(t>8){setModalContent("xxAddAgent","Подключиться ко всем",format("Вы действительно хотите подключиться к {0} устройствам?",t));var s=function(e,t){document.getElementById("xxAddAgentModal").removeEventListener("hide.bs.modal",s),Q("autoConnectDesktopCheckbox").checked=!1};return document.getElementById("xxAddAgentModal").addEventListener("hide.bs.modal",s),void showModal("xxAddAgentModal","idx_dlgOkButton",()=>{document.getElementById("xxAddAgentModal").removeEventListener("hide.bs.modal",s),connectAllKvmFunction(!0)})}}for(var n in nodes)1!=nodes[n].v||null!=multiDesktop[nodes[n]._id]||0!=Object.keys(checkedNodeids).length&&!checkedNodeids[nodes[n]._id]||toggleKvmDevice(nodes[n]._id)}function disconnectAllKvmFunction(){if(xxdialogMode)return!1;for(var e in multiDesktop)multiDesktop[e].Stop();multiDesktop={}}function onMultiDesktopStateChange(e,t){try{QH("skvmid_"+e.shortid,["Отключен","Подключение...","Установка...","",""][t])}catch(e){}}function onDeviceSearchChanged(e){var t=new URL(window.location.href);if(null==e||"SearchInput"!=e.target.id&&"KvmSearchInput"!=e.target.id?null!=e&&"DevFilterSelect"==e.target.id||(t.searchParams.delete("filter"),urlargs.filter&&delete urlargs.filter):("SearchInput"==e.target.id?Q("KvmSearchInput").value=Q("SearchInput").value:Q("SearchInput").value=Q("KvmSearchInput").value,""!=e.target.value?(t.searchParams.set("filter",e.target.value),urlargs.filter&&(urlargs.filter=e.target.value)):(t.searchParams.delete("filter"),urlargs.filter&&delete urlargs.filter)),!(268435456&features)&&xxcurrentView>0)try{window.history.replaceState({},document.title,decodeURIComponent(t.toString()))}catch(e){}mainUpdate(5)}function showMultiDesktopSettings(){QV("td7amtkvm",!1),QV("td7meshkvm",!0),QV("td7rdpkvm",!1),QV("d7desktopOtherSettings",!1),d7bitmapquality.value=multidesktopsettings.quality,d7bitmapscaling.value=multidesktopsettings.scaling,d7encoding.value=multidesktopsettings.agentencoding,multidesktopsettings.framerate?d7framelimiter.value=multidesktopsettings.framerate:d7framelimiter.value=100,setModalContent("xxAddAgent","Настройки удаленного рабочего стола",x),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showMultiDesktopSettingsChanged())}function showMultiDesktopSettingsChanged(){for(var e in multidesktopsettings.quality=d7bitmapquality.value,multidesktopsettings.scaling=d7bitmapscaling.value,multidesktopsettings.framerate=d7framelimiter.value,multidesktopsettings.agentencoding=d7encoding.value,localStorage.setItem("multidesktopsettings",JSON.stringify(multidesktopsettings)),multiDesktop)multiDesktop[e].m.SendCompressionLevel(multidesktopsettings.agentencoding,multidesktopsettings.quality,multidesktopsettings.scaling,multidesktopsettings.framerate)}function connectMultiDesktop(e,t){var n=e._id,o=n.split("/")[2],i=multiDesktop[n];if(null==i){if(null==Q("kvmid_"+o))return;if(2==t){if(null==e.intelamt.user||""==e.intelamt.user)return;(i=CreateAmtRedirect(CreateAmtRemoteDesktop("kvmid_"+o),authCookie)).shortid=o,i.onStateChanged=onMultiDesktopStateChange,i.m.bpp=1,i.m.useZRLE=!0,i.m.showmouse=!0,i.m.onKvmData=function(e){console.log("KVM Data received in multi-desktop mode, this is not supported.")},i.m.onScreenSizeChange=mdeskAdjust,i.Start(n,16994,"*","*",0),i.contype=2,multiDesktop[n]=i}else 1==t&&((i=CreateAgentRedirect(meshserver,CreateAgentRemoteDesktop("kvmid_"+o),serverPublicNamePort,authCookie,authRelayCookie,domainUrl)).m.UseExtendedKeyFlag=e.agent.id<5,i.m.mouseCursorActive(11==xxcurrentView),i.shortid=o,i.attemptWebRTC=attemptWebRTC,i.webrtcconfig=webrtcconfiguration,i.onStateChanged=onMultiDesktopStateChange,i.m.ImageType=multidesktopsettings.agentencoding,i.m.CompressionLevel=multidesktopsettings.quality,i.m.ScalingLevel=multidesktopsettings.scaling,multidesktopsettings.framerate&&(i.m.FrameRateTimer=multidesktopsettings.framerate),multidesktopsettings.swapmouse&&(i.m.SwapMouse=multidesktopsettings.swapmouse),multidesktopsettings.rmw&&(i.m.ReverseMouseWheel=multidesktopsettings.rmw),1==multidesktopsettings.remotekeymap&&(i.m.remoteKeyMap=multidesktopsettings.remotekeymap),i.m.onScreenSizeChange=mdeskAdjust,i.Start(n),i.contype=1,multiDesktop[n]=i)}else i.Stop(),delete multiDesktop[n]}function getMeshActions(e,t){if(!(4&t))return"";var n="";return 1==e.mtype&&(1&features||(n+=' <a href=# role="button" title="Добавить новый Intel&reg; AMT компьютер, находящийся в локальной сети." onclick=\'return addDeviceToMesh("'+e._id+"\")'>Добавить локально</a>",n+=' <a href=# role="button" title="Добавить новый Intel&reg; AMT компьютер сканированием локальной сети." onclick=\'return addAmtScanToMesh("'+e._id+"\")'>Сканировать сеть</a>"),e.amt&&e.amt.type>0&&(n+=' <a href=# role="button" title="Выполнить активацию и настройку Intel&reg; AMT." onclick=\'return showAmtSetup("'+e._id+"\")'>Настроить</a>")),2!=e.mtype||4294967295!=userinfo.siteadmin&&4096&userinfo.siteadmin||(n+=' <a href=# role="button" title="Добавьте новый компьютер в эту группу устройств, установив Mesh Agent." onclick=\'return addAgentToMesh("'+e._id+"\")'>Добавить агент</a>",2&features||(n+=' <a href=# role="button" title="Пригласите кого-нибудь установить Mesh Agent в этой группе устройств." onclick=\'return inviteAgentToMesh("'+e._id+"\")'>Пригласить</a>")),3==e.mtype&&(n+=' <a href=# role="button" title="Добавить устройство, находящееся в локальной сети." onclick=\'return addLocalDeviceToMesh("'+e._id+"\")'>Добавить устройство</a>"),n}function addLocalDeviceToMesh(e){if(xxdialogMode)return!1;var t=meshes[e],n=format('Добавить локальное устройство в группу "{0}".',EscapeHtml(t.name))+"<br /><br />";n+=addHtmlFormFloating("Имя устройства","<input id=dp1devicename class=form-control maxlength=32 autocomplete=off onchange=validateLocalDeviceToMesh() onkeyup=validateLocalDeviceToMesh() />"),n+=addHtmlFormFloating("Имя хоста",'<input id=dp1hostname class=form-control maxlength=32 autocomplete=off placeholder="Такое же как имя устройства" onchange=validateLocalDeviceToMesh() onkeyup=validateLocalDeviceToMesh() />'),setModalContent("xxAddAgent","Добавить локальное устройство",n+=addHtmlFormFloating("Тип","<select id=dp1type class=form-select><option value=4>Windows (RDP)</option><option value=6>Linux (SSH/SCP/VNC)</option><option value=29>macOS (SSH/SCP/VNC)</option></select>")),showModal("xxAddAgentModal","idx_dlgOkButton",()=>addLocalDeviceToMeshEx(3,e)),validateLocalDeviceToMesh(),Q("dp1devicename").focus()}function validateLocalDeviceToMesh(){QE("idx_dlgOkButton",Q("dp1devicename").value.length>0)}function addLocalDeviceToMeshEx(e,t){var n=Q("dp1hostname").value;""==n&&(n=Q("dp1devicename").value),meshserver.send({action:"addlocaldevice",meshid:t,devicename:Q("dp1devicename").value,hostname:n,type:parseInt(Q("dp1type").value)})}function addDeviceToMesh(e){if(xxdialogMode)return!1;var t=meshes[e],n=format('Добавить новое Intel&reg; AMT устройство к группе устройств "{0}".',EscapeHtml(t.name))+"<br /><br />";return n+=addHtmlFormFloating("Имя устройства",'<input id=dp1devicename class="form-control" maxlength=32 autocomplete=off onchange=validateDeviceToMesh() onkeyup=validateDeviceToMesh() />'),n+=addHtmlFormFloating("Имя хоста",'<input id=dp1hostname class="form-control" maxlength=32 autocomplete=off placeholder="Такое же как имя устройства" onchange=validateDeviceToMesh() onkeyup=validateDeviceToMesh() />'),n+=addHtmlFormFloating("Имя пользователя",'<input id=dp1username class="form-control" maxlength=32 autocomplete=off placeholder="админ" onchange=validateDeviceToMesh() onkeyup=validateDeviceToMesh() />'),n+=addHtmlFormFloating("Пароль",'<input id=dp1password type=password class="form-control" autocomplete=off maxlength=32 onchange=validateDeviceToMesh() onkeyup=validateDeviceToMesh() />'),setModalContent("xxAddAgent","Добавить Intel&reg; AMT устройство",n+=addHtmlFormFloating("Защита",'<select id=dp1tls class="form-select"><option value=0>Нет безопасности TLS</option><option value=1>Требуется безопасность TLS</option></select>')),showModal("xxAddAgentModal","idx_dlgOkButton",()=>addDeviceToMeshEx(3,e)),validateDeviceToMesh(),Q("dp1devicename").focus(),!1}function showAmtImport(e){if(!xxdialogMode){setModalContent("xxAddAgent","Intel&reg; AMT Device Import",'Create many Intel&reg; AMT device at once by importing a JSON file with the following format:<br /><pre>[\r\n  {\r\n    "fqdn":"mycomputer.com",\r\n    "uuid":"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",\r\n    "version":"12.0.1",\r\n    "username":"admin",\r\n    "password":"password",\r\n    "tls":true\r\n  }\r\n]</pre><input type=file id=d4importFile class="form-control" accept=".json" onchange=showAmtImportValidate() />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showAmtImportEx(3,e)),QE("idx_dlgOkButton",!1)}}function showAmtImportValidate(){QE("idx_dlgOkButton",null!=Q("d4importFile").value)}function showAmtImportEx(e,t){var n=new FileReader;n.onload=function(e){var n=null;try{n=JSON.parse(e.target.result)}catch(e){return setModalContent("xxAddAgent","Intel&reg; AMT Device Import",format("Некорректный файл JSON: {0}.",e)),void showModal("xxAddAgentModal","idx_dlgOkButton")}null!=n?meshserver.send({action:"importamtdevices",meshid:t,amtdevices:n}):(setModalContent("xxAddAgent","Intel&reg; AMT Device Import","Некорректный формат файла JSON."),showModal("xxAddAgentModal","idx_dlgOkButton"))},n.readAsText(Q("d4importFile").files[0])}function showAmtSetup(e){if(xxdialogMode)return!1;var t=serverinfo.name,n=meshes[e];(-1==t.indexOf(".")||2&features)&&(t=window.location.hostname);var o;domainUrl.substring(0,domainUrl.length-1);1==serverinfo.https?o="wss://"+t+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl:o="ws://"+t+(80==serverinfo.port?"":":"+serverinfo.port)+domainUrl;var i=format('Добавьте, активируйте и настройте Intel&reg; AMT в группу "{0}", периодически запуская MeshCmd от имени администратора на удаленном устройстве.',EscapeHtml(n.name))+"<br /><br />";return i+="<textarea readonly=readonly style=width:100%;resize:none;height:100px;overflow:auto;font-size:12px readonly>meshcmd amtconfig --url "+o+"apf.ashx --id '"+e.split("/")[2]+"' --serverhttpshash "+serverinfo.tlshash+"</textarea>",null!=serverinfo.amtAcmFqdn&&(i+="<div style=margin-top:8px>Для активации ACM в Intel&reg; AMT необходимо указать следующее надежное полное доменное имя: <b>"+serverinfo.amtAcmFqdn.join(", ")+"</b></div>"),setModalContent("xxAddAgent","Настройка Intel&reg; AMT",i),showModal("xxAddAgentModal","idx_dlgOkButton"),Q("idx_dlgOkButton").focus(),!1}function showAmtAcmSetup(){if(xxdialogMode)return!1;var e="<table><tr><td><img src=images/usbkey70.png height=70 width=31 style=margin-left:4px;margin-right:8px><td><div>Активируйте Intel&reg; AMT в режиме управления администратором (ACM) с помощью USB-ключа в формате FAT. Поместите на него файл setup.bin и загрузите один или несколько компьютеров с этим ключом.</div><div style=margin-top:6px>Начните с ввода старого и нового пароля MBEx.</div></table>";e+=addHtmlFormFloating("Прежний пароль",'<input id=dp1password0 type=password class="form-control" autocomplete=off maxlength=32 onchange=validateAmtAcmSetupEx() onkeyup=validateAmtAcmSetupEx() />'),e+=addHtmlFormFloating("Новый пароль*",'<input id=dp1password1 type=password class="form-control" autocomplete=off maxlength=32 onchange=validateAmtAcmSetupEx() onkeyup=validateAmtAcmSetupEx() />'),e+=addHtmlFormFloating("Новый пароль*",'<input id=dp1password2 type=password class="form-control" autocomplete=off maxlength=32 onchange=validateAmtAcmSetupEx() onkeyup=validateAmtAcmSetupEx() />'),32&features2&&1==currentMesh.mtype&&serverinfo.amtProvServerMeshId==currentMesh._id&&(e+='<label><input id=dp1lanprov type=checkbox class="form-check-input me-2" /> Используется для LAN активации без операционной системы.</label>'),setModalContent("xxAddAgent","Intel&reg; AMT ACM",e+='<div><span id=dp10passNotify style="font-size:10px"> * 8-16 символов, 1 верхний, 1 нижний, 1 числовой, 1 не буквенно-цифровой.</span></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",showAmtAcmSetupEx),Q("dp1password0").focus(),validateAmtAcmSetupEx()}function validateAmtAcmSetupEx(){var e=Q("dp1password0").value,t=Q("dp1password1").value,n=Q("dp1password2").value,o=!0;"admin"!=e&&0==checkPasswordRequirements(e,{min:8,max:16,numeric:1,lower:1,upper:1,nonalpha:1})&&(o=!1),t==n&&0!=checkPasswordRequirements(t,{min:8,max:16,numeric:1,lower:1,upper:1,nonalpha:1})||(o=!1),QE("idx_dlgOkButton",o)}function showAmtAcmSetupEx(){meshserver.send({action:"amtsetupbin",oldmebxpass:Q("dp1password0").value,newmebxpass:Q("dp1password1").value,baremetal:32&features2&&Q("dp1lanprov").checked})}function addAmtScanToMesh(e){if(xxdialogMode)return!1;var t="Введите диапазон IP-адресов для сканирования Intel&reg; AMT устройств.<br /><br />";return t+=addHtmlValue("Диапазон IP",'<table style=width:250px><tr><td style=width:99%><input id=dp1range style=width:100% list=iprangelist value="192.168.1.0/24" onkeyup=addAmtScanToMeshKeyUp(event) /><td style=width:1%><input id=dp1rangebutton type=button value="Сканировать" onclick=addAmtScanToMeshButton()></input></tr></table>'),t+='<div id=dp1results style="width:100%;height:200px;background-color:white;border:1px gray solid;overflow-y:scroll"></div>',t+='<input type=hidden id=amtScanMeshId value="'+e+'" />',xxdialogTag=e,setModalContent("xxAddAgent","Сканировать на наличие Intel&reg; AMT устройств",t+='<div style="padding:10px;margin-bottom:5px"><input id="idx_dlgCancelButton2" type="button" value="Отмена" style="" onclick="dialogclose(0)" /><input id="idx_dlgOkButton2" type="button" value="OK" style="" onclick="dialogclose(1)" /><div><input id="d2scanSelectButton" type="button" value="Выбрать все" onclick="scanSelectAll()" /></div></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",addAmtScanToMeshEx),QE("idx_dlgOkButton2",!1),QE("d2scanSelectButton",!1),QH("dp1results","<div style=width:100%;text-align:center;margin-top:12px;color:gray;line-height:1.5>Примеры значений диапазона IP-адресов<br />192.168.0.100<br />192.168.1.0/24<br />192.167.0.1-192.168.0.100</div>"),focusTextBox("dp1range"),addAmtScanToMeshKeyUp(),!1}function scanSelectAll(){for(var e=document.getElementsByClassName("DevScanCheckbox"),t=0;t<e.length;t++)e[t].checked=!0;addAmtScanToMeshCheckbox()}function addAmtScanToMeshKeyUp(e){QE("dp1rangebutton",Q("dp1range").value.split(".").length>3),e&&13==e.keyCode&&(haltEvent(e),addAmtScanToMeshButton())}function addAmtScanToMeshEx(e){for(var t=document.getElementsByClassName("DevScanCheckbox"),n=0;n<t.length;n++)if(t[n].checked){var o=t[n].getAttribute("tag"),i=amtScanResults[o],a=i.hostname;"host"==i.hosttype&&(a=capitalizeFirstLetter(a.split(".")[0])),meshserver.send({action:"addamtdevice",meshid:Q("amtScanMeshId").value,devicename:a,hostname:i.hostname,amtusername:"",amtpassword:"",amttls:i.tls})}}function addAmtScanToMeshButton(){var e=Q("dp1range").value.trim(),t=e.split(" ");t.length>1&&(e=t[t.length-1]),""!=(e=e.trim())&&(QE("dp1range",!1),QE("dp1rangebutton",!1),QH("dp1results","<div style=width:100%;text-align:center;margin-top:20px>Сканирование...</div><div style=width:100%;text-align:center;margin-top:6px;color:#666>"+e+"</div>"),xxdialogTag="AMTSCAN:"+e,meshserver.send({action:"scanamtdevice",range:e}))}function addAmtScanToMeshCheckbox(){for(var e=document.getElementsByClassName("DevScanCheckbox"),t=0,n=0;n<e.length;n++)e[n].checked&&t++;QE("idx_dlgOkButton2",t>0)}function checkEmail(e){var t=e.split("@"),n=2==t.length&&t[0].length>0&&t[1].split(".").length>1&&t[1].length>2;if(1==n){var o=t[1].split(".");for(var i in o)0==o[i].length&&(n=!1)}return n}function inviteAgentToMesh(e){if(xxdialogMode)return!1;var t="",n=meshes[e];return 64&features&&(t+=addHtmlFormFloating("Тип приглашения","<select id=d2InviteType onchange=d2ChangedInviteType() class=form-select><option value=0>Ссылка приглашение</option><option value=1>Электронное приглашение</option></select>")+"<hr />",t+="<div id=emailInviteDiv style=display:none>"+format('Пригласите установить Mesh Agent. Ссылка на установку для группы "{0}" будет отправлена по электронной почте.',EscapeHtml(n.name))+"<br /><br />",t+=addHtmlFormFloating("Имя (не обязательно)",'<input id=agentInviteName value="" placeholder="Name (optional)" class="form-control" maxlength=64 />'),t+=addHtmlFormFloating("Email",'<input id=agentInviteEmail placeholder="example@email.com" class="form-control" onkeyup=validateAgentInvite() />'),t+=addHtmlFormFloating("Операционная система","<select id=agentInviteNameOs onchange=d2ChangedInviteType() class=form-select><option value=4>Отправить ссылку для установки</option><option value=0 selected>Любые поддерживаемые</option><option value=1>Только Windows</option><option value=3>Только Apple macOS</option><option value=2>Только Linux</option><option value=5>MeshCentral Ассистент</option></select>"),t+="<div id=d2agentexpirediv>",t+=addHtmlFormFloating("Срок действия ссылки","<select id=agentInviteExpire class=form-select><option value=1>1 час</option><option value=8>8 часов</option><option value=24>1 день</option><option value=168>1 неделя</option><option value=5040>1 месяц</option><option value=0>Неограниченно</option></select>"),t+="</div>",t+="<div id=d2agentInstallTypeDiv2>",t+=addHtmlFormFloating("Тип установки","<select id=agentInviteType class=form-select><option value=0>Фоновый и интерактивный</option><option value=2>Только фоновый</option><option value=1>Только интерактивный режим</option></select>"),t+="</div>",t+=addHtmlFormFloating("Сообщение (необязательно)",'<textarea id="agentInviteMessage" class="form-control" style="height:100px;resize:none;" maxlength="1024"></textarea>'),t+="</div>"),t+="<div id=urlInviteDiv>"+format('Пригласите установить Mesh Agent поделившись ссылкой. Эта ссылка ведет на инструкции для установки для группы устройств "{0}". Ссылка общедоступна и не требует наличия учетной записи на сервере.',EscapeHtml(n.name))+"<br /><br />",t+=addHtmlFormFloating("Срок действия ссылки","<select id=d2inviteExpire class=form-select onchange=d2RequestInvitationLink()><option value=1>1 час</option><option value=8>8 часов</option><option value=24>1 день</option><option value=168>1 неделя</option><option value=5040>1 месяц</option><option value=0>Неограниченно</option></select>"),t+=addHtmlFormFloating("Агенты","<select id=d2agentType class=form-select onchange=d2ChangedInviteType()><option value=0>Все доступные агенты</option><option value=1>MeshAgent для Windows </option><option value=2>MeshAgent для Linux</option><option value=4>MeshAgent для MacOS</option><option value=8>MeshCentral Ассистент</option><option value=16>Android MeshAgent</option></select>"),t+="<div id=d2agentInstallTypeDiv>",t+=addHtmlFormFloating("Тип установки","<select id=d2agentInviteType class=form-select onchange=d2RequestInvitationLink()><option value=0>Фоновый и интерактивный</option><option value=2>Только фоновый</option><option value=1>Только интерактивный режим</option></select>"),t+="</div>",xxdialogTag=e,setModalContent("xxAddAgent","Пригласить",t+='<div id=agentInvitationLinkDiv style="text-align:center;font-size:large;margin:16px;display:none"><a href=# id=agentInvitationLink rel="noreferrer noopener" target="_blank" style=cursor:pointer></a> <img src=images/link4.png height=10 width=10 title="Скопировать ссылку в буфер обмена" style=cursor:pointer onclick=d2CopyInviteToClip()></div></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){performAgentInvite(3,e)}),64&features?(Q("d2InviteType").focus(),d2ChangedInviteType()):(Q("d2inviteExpire").focus(),validateAgentInvite()),d2RequestInvitationLink(),!1}function d2RequestInvitationLink(){meshserver.send({action:"createInviteLink",meshid:xxdialogTag,expire:parseInt(Q("d2inviteExpire").value),flags:parseInt(Q("d2agentInviteType").value),agents:parseInt(Q("d2agentType").value)})}function d2ChangedInviteType(){64&features&&(QV("urlInviteDiv",0==Q("d2InviteType").value),QV("d2agentexpirediv",4==Q("agentInviteNameOs").value),QV("d2agentInstallTypeDiv2",Q("agentInviteNameOs").value<2),QV("emailInviteDiv",1==Q("d2InviteType").value)),QV("d2agentInstallTypeDiv",parseInt(Q("d2agentType").value)<2),validateAgentInvite(),d2RequestInvitationLink()}function d2CopyInviteToClip(){copyTextToClip(Q("agentInvitationLink").href)}function d2CopySecretToClip(){copyTextToClip(Q("d2optsecret").getAttribute("secret"))}function validateAgentInvite(){64&features&&1==Q("d2InviteType").value?(QE("idx_dlgOkButton",checkEmail(Q("agentInviteEmail").value)),QV("idx_dlgCancelButton",!0)):(QE("idx_dlgOkButton",!0),QV("idx_dlgCancelButton",!1))}function performAgentInvite(e,t){64&features&&1==Q("d2InviteType").value&&meshserver.send({action:"inviteAgent",meshid:t,email:Q("agentInviteEmail").value,name:Q("agentInviteName").value,os:Q("agentInviteNameOs").value,flags:Q("agentInviteType").value,msg:Q("agentInviteMessage").value,expire:parseInt(Q("agentInviteExpire").value)})}function addAgentToMesh(e){if(xxdialogMode)return!1;var t=meshes[e],n="",o="",i="<select id=aginsSelect onchange=addAgentToMeshClick() class=form-select><option value=0>Windows</option><option value=1>Linux / BSD</option><option value=5>Двоичный установщик Linux / BSD / macOS</option><option value=2>Apple macOS</option>";2&features||(i+="<option value=6>Мобильное устройство</option>"),i+="<option value=7>MeshCentral Ассистент</option>",n+=addHtmlFormFloating("Операционная система",i+="<option value=3>Windows (Удаление)</option><option value=4>Linux / BSD (Удаление)</option><option value=8>Apple macOS (UnInstall)</option></select>");var a=serverinfo.name;(-1==a.indexOf(".")||2&features)&&(a=window.location.hostname);var s=domainUrl.substring(0,domainUrl.length-1),r="";r=1==serverinfo.https?443==serverinfo.port?"":":"+serverinfo.port:80==serverinfo.port?"":":"+serverinfo.port;var l=[6,5,10005,25,26,28,30,32,36,37,40,41,45,16,29],d={6:"Linux x86-64",5:"Linux x86-32",10005:"Apple OSX Universal",25:"Linux ARM-HF, Rasberry Pi",26:"Linux ARM64-HF",28:"Linux MIPS24KC (OpenWRT)",30:"FreeBSD x86-64",32:"Linux ARM 64 bit (glibc/2.24 NOKVM)",36:"OpenWRT x86-64",37:"OpenBSD x86-64",40:"Linux MIPSEL24KC (OpenWRT)",41:"ARMADA/CORTEX-A53/MUSL (OpenWRT)",45:"RISC-V 64bit",16:"Apple macOS x86-64",29:"Apple macOS ARM-64"};for(var c in l)o+='<option value="'+l[c]+'">'+d[l[c]]+"</option>";n+='<div id="aginsSysTypeDiv">',n+=addHtmlFormFloating("Тип системы",'<select id="aginsSysType" onchange="addAgentToMeshClick()"  class="form-select">'+o+"</select>"),n+="</div>",n+='<div id="aginsTypeDiv">',n+=addHtmlFormFloating("Тип установки",'<select id="aginsType" onchange="addAgentToMeshClick()" class="form-select"><option value="0">Фоновый и интерактивный</option><option value="2">Только фоновый</option><option value="1">Только интерактивный режим</option></select>'),n+='</div><div id="asinsTypeDiv">',n+=addHtmlFormFloating("Тип установки",'<select id="asinsType" onchange="addAgentToMeshClick()" class="form-select"><option value="2">Приложение, подключение по запросу пользователя</option><option value="3">Приложение, Всегда на связи</option><option value="0">Системный лоток, подключение по запросу пользователя</option><option value="1">Системный лоток, всегда подключен</option><option value="4">Системный лоток, только монитор</option></select>'),n+="</div><hr>";var u=t.name;return u=u.split("\\").join("").split("/").join("").split(":").join("").split("*").join("").split("?").join("").split('"').join("").split("<").join("").split(">").join("").split("|").join("").split(" ").join("").split("'").join(""),n+="<div id=agins_windows>"+format('Чтобы добавить новый компьютер в группу устройств "{0}", скачайте Mesh Agent и установите его для управления этим компьютером. В этот агент встроена информация о текущем сервере и группе устройств.',EscapeHtml(t.name))+"<br /><br />",n+=addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginsw32lnk name="meshagents?id=3&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="x86 32bit version of the MeshAgent">Windows x86-32 (.exe)</a> <i class="fa-regular fa-clipboard" title="Copy Windows x86 32bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=3&meshid='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"]),n+=addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginsw64lnk name="meshagents?id=4&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="x86 64bit version of the MeshAgent">Windows x86-64 (.exe)</a> <i class="fa-regular fa-clipboard" title="Copy Windows x86 64bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=4&meshid='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"]),n+=addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginswa64lnk name="meshagents?id=43&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="ARM 64bit version of the MeshAgent">Windows ARM-64 (.exe)</a> <i class="fa-regular fa-clipboard" title="Copy Windows ARM 64bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=43&meshid='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"]),debugmode>0&&(n+=addHtmlValue("Файл настроек",'<a id=aginswmshlnk name="meshsettings?id='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'">'+format("{0} настройки (.msh)",EscapeHtml(t.name))+"</a>")),n+="</div>",n+="<div id=agins_linux style=display:none>"+format('Чтобы добавить компьютер в группу "{0}", выполните следующую команду. Потребуются права root.',EscapeHtml(t.name))+"<br />",n+="<textarea id=agins_linux_area rows=2 cols=20 readonly=readonly style=border-radius:4px;padding:6px;margin-top:4px;margin-bottom:4px;border:0;width:100%;resize:none;height:160px;overflow:auto;font-size:12px class=form-control></textarea>",n+='<div style=font-size:x-small;float:right>* Для BSD сначала запустите "pkg install wget sudo bash".</div><a style=text-decoration:none title="Скопировать в буфер обмена" onclick=copyAgentIdValue("agins_linux_area")>Копировать <i class="fa-regular fa-clipboard" style=cursor:pointer></i></a></div>',n+="<div id=agins_osx style=display:none>"+format('Чтобы добавить новый компьютер в группу устройств "{0}", скачайте Mesh Agent и установите его для управления этим компьютером. В этот установщик агента встроена информация о текущем сервере и группе устройств.',EscapeHtml(t.name))+"<br /><br />",n+=addHtmlValue("Mesh Agent",'<a class=text-decoration-underline onclick=downloadFile("meshosxagent?id=16&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'") title="x86-64bit version of macOS Mesh Agent">macOS x86-64bit</a> <i class="fa-regular fa-clipboard" title="Скопировать ссылку macOS agent в буфер обмена" style=cursor:pointer onclick=copyAgentUrl("meshosxagent?id=16&meshid='+e.split("/")[2]+'",0)></i>',["col-md-4","col-md-8"]),n+=addHtmlValue("Mesh Agent",'<a class=text-decoration-underline onclick=downloadFile("meshosxagent?id=29&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'") title="ARM 64bit version of macOS Mesh Agent">macOS ARM (64bit)</a> <i class="fa-regular fa-clipboard" title="Скопировать ссылку macOS agent в буфер обмена" style=cursor:pointer onclick=copyAgentUrl("meshosxagent?id=29&meshid='+e.split("/")[2]+'",0)></i>',["col-md-4","col-md-8"]),n+=addHtmlValue("Mesh Agent",'<a class=text-decoration-underline onclick=downloadFile("meshosxagent?id=10005&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'") title="Universal version of macOS Mesh Agent">macOS (Universal)</a> <i class="fa-regular fa-clipboard" title="Скопировать ссылку macOS agent в буфер обмена" style=cursor:pointer onclick=copyAgentUrl("meshosxagent?id=10005&meshid='+e.split("/")[2]+'",0)></i>',["col-md-4","col-md-8"]),n+="</div>",n+='<div id=agins_qrcode style=display:none;min-height:180px><a id=agins_qrimage_a rel="noreferrer noopener" target=_blank><div id=agins_qrimage style=float:right;margin-left:10px;width:180px;height:180px;cursor:pointer></div></a><div>'+format('Чтобы добавить мобильное устройство в группу "{0}", загрузите приложение MeshAgent и отсканируйте этот QR-код.',EscapeHtml(t.name))+"</div>",n+="<table style=width:180px>",n+='<tr><td style=text-align:center><a title="Google Play Store"rel="noreferrer noopener" target=_blank href="https://play.google.com/store/apps/details?id=com.meshcentral.agent2"><img style=cursor:pointer src="images/google-play-140.png" width=140 srcset="images/google-play-280.png 2x" /></a></td></tr>',n+='<tr><td style=text-align:center><a title="Amazon App Store" rel="noreferrer noopener" target=_blank href="https://www.amazon.co.uk/gp/product/B097Z4Q7SK/"><img style=cursor:pointer src="images/amazon-appstore-140.png"  width=140 srcset="images/amazon-appstore-280.png 2x" /></a></td></tr>',n+="</table>",n+=addHtmlValue("Android APK",'<a class=text-decoration-underline onclick=downloadFile("meshagents?id=14'+(urlargs.key?"&key="+urlargs.key:"")+'",null,true) title="APK version of the MeshAgent">APK</a> <i class="fa-regular fa-clipboard" title="Скопировать URL в буфер обмена" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=14&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'")></i>'),n+="</div>",n+="<div id=agins_assistant style=display:none><table><tr><td style=vertical-align:top><div>"+format('MeshCentral Assistant - это инструмент Windows, который пользователи могут использовать, чтобы попросить о помощи. Воспользуйтесь ссылкой ниже, чтобы загрузить версию, которая будет подключаться к группе устройств "{0}".',EscapeHtml(t.name))+"</div><div></div><br />",n+='<a class=text-decoration-underline id=asinslnk name="meshagents?id=10006&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'" title="MeshCentral Ассистент для Windows">Ассистент для Windows (.exe)</a> <i class="fa-regular fa-clipboard" title="Скопировать URL в буфер обмена" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=10006&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'")></i>',n+='</td><td><img id=agass_img1 src=images/assistant-100.png width=74 height=100 srcset="images/assistant-200.png 2x"><img id=agass_img2 src=images/assistant2-100.png width=74 height=100 srcset="images/assistant2-200.png 2x"></td></tr></table></div>',n+="<div id=agins_assistant2 style=display:none><table><tr><td style=vertical-align:top><div>MeshCentral Assistant - это инструмент Windows, который пользователи могут использовать, чтобы попросить о помощи. Воспользуйтесь ссылкой ниже, чтобы загрузить версию, которая будет отслеживать фоновый агент.</div><div></div><br />",n+='<a class=text-decoration-underline id=asinslnk2 name="meshagents?id=10006&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'" title="MeshCentral Ассистент для Windows">Ассистент для Windows (.exe)</a> <i class="fa-regular fa-clipboard" title="Скопировать URL в буфер обмена" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=10006&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'")></i>',n+='</td><td><img src=images/assistant-100.png width=74 height=100 srcset="images/assistant-200.png 2x"></td></tr></table></div>',n+='<div id=agins_windows_un style=display:none>Для удаления Mesh Agent скачайте файл ниже, запустите его и нажмите "удалить".<br /><br />',n+=addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginsw32unlnk name="meshagents?id=3&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="x86 32bit version of the MeshAgent">Windows x86-32 (.exe)</a> <i class="fa-regular fa-clipboard" title="Copy Windows x86 32bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=3&meshid='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"]),n+=addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginsw64unlnk name="meshagents?id=4&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="x86 64bit version of the MeshAgent">Windows x86-64 (.exe)</a> <i class="fa-regular fa-clipboard" title="Copy Windows x86 64bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=4&meshid='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"]),n+=addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginswa64unlnk name="meshagents?id=43&meshid='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'" title="ARM 64bit version of the MeshAgent">Windows ARM-64 (.exe)</a> <i class="fa-regular fa-clipboard" title="Copy Windows ARM 64bit agent URL to clipboard" style=cursor:pointer onclick=copyAgentUrl("meshagents?id=43&meshid='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"]),n+="</div>",n+="<div id=agins_linux_un style=display:none>Для удаления Mesh Agent выполните следующую команду. Потребуются учетные данные root.<br />",n+="<textarea id=agins_linux_area_un rows=2 cols=20 readonly=readonly style=border-radius:4px;padding:6px;margin-top:4px;margin-bottom:4px;border:0;width:100%;resize:none;height:160px;overflow:auto;font-size:12px  class=form-control></textarea>",n+='<a style=text-decoration:none title="Скопировать в буфер обмена" onclick=copyAgentIdValue("agins_linux_area_un")>Copy <i class="fa-regular fa-clipboard" style=cursor:pointer></i></a></div>',n+='<div id=agins_osx_un style=display:none>To remove a mesh agent, download the file below, right click on the ".mpkg" file and click "Show Package Contents", then right click on "Uninstall.command" and click "Open"<br /><br />',n+=addHtmlValue("Mesh Agent",'<a class=text-decoration-underline onclick=downloadFile("meshosxagent?id=10005&meshid='+e.split("/")[2]+(urlargs.key?"&key="+urlargs.key:"")+'") title="Universal version of macOS Mesh Agent">macOS Agent (Universal)</a> <i class="fa-regular fa-clipboard" title="Скопировать ссылку macOS agent в буфер обмена" style=cursor:pointer onclick=copyAgentUrl("meshosxagent?id=10005&meshid='+e.split("/")[2]+'",0)></i>',["col-md-4","col-md-8"]),n+="</div>",n+="<div id=agins_linux_inst style=display:none>This is a executable on OS's with graphical user interfaces<br /><br />Apple macOS executables will need to be removed from quarantine to run 'xattr -r -d com.apple.quarantine meshagent'<br /><br />You need to 'chmod +x meshagent' and run this file<br /><br />",n+=addHtmlValue("Mesh Agent",'<a class=text-decoration-underline id=aginsbinlnk name="meshagents?id='+e.split("/")[2]+"&installflags=0"+(urlargs.key?"&key="+urlargs.key:"")+'">MeshAgent</a> <i class="fa-regular fa-clipboard" title="Скопировать URL агента в буфер обмена" style=cursor:pointer onclick=copyAgentUrl("meshagents?id='+e.split("/")[2]+'&installflags=",1)></i>',["col-md-4","col-md-8"]),n+=addHtmlValue('Команда&nbsp;<i class="fa-regular fa-clipboard" title="Скопировать URL агента в буфер обмена" style=cursor:pointer onclick=copyAgentIdValue("aginsbincmd")></i>','<input id=aginsbincmd type=text class="form-control" readonly value=\'wget -O meshagent'+(2147483648&features?" --no-check-certificate":"")+' "https://'+a+r+domainUrl+"meshagents?id="+e.split("/")[2].split("$").join("%24").split("@").join("%40")+"' />",["col-md-4 d-flex align-items-center","col-md-8"]),setModalContent("xxAddAgent","Добавить Mesh Agent",n+="</div>"),showModal("xxAddAgentModal","idx_dlgOkButton"),new QRCode(Q("agins_qrimage"),{text:serverinfo.magenturl+","+serverinfo.agentCertHash+","+e.split("/")[2],width:180,height:180,colorDark:"#000000",colorLight:"#EEE",correctLevel:QRCode.CorrectLevel.M}),Q("agins_qrimage_a").setAttribute("href",serverinfo.magenturl+","+serverinfo.agentCertHash+","+e.split("/")[2]),8192&features?(Q("agins_linux_area").value='wget "https://'+a+r+domainUrl+"meshagents?script=1"+(urlargs.key?"&key="+urlargs.key:"")+'" --no-proxy'+(2147483648&features?" --no-check-certificate":"")+" -O ./meshinstall.sh && chmod 755 ./meshinstall.sh && sudo -E ./meshinstall.sh https://"+a+r+s+" '"+e.split("/")[2]+"' || ./meshinstall.sh https://"+a+r+s+" '"+e.split("/")[2]+"'\r\n",Q("agins_linux_area_un").value='wget "https://'+a+r+domainUrl+"meshagents?script=1"+(urlargs.key?"&key="+urlargs.key:"")+'" --no-proxy'+(2147483648&features?" --no-check-certificate":"")+" -O ./meshinstall.sh && chmod 755 ./meshinstall.sh && sudo -E ./meshinstall.sh uninstall https://"+a+r+s+" '"+e.split("/")[2]+"' || ./meshinstall.sh uninstall https://"+a+r+s+" '"+e.split("/")[2]+"'\r\n"):(Q("agins_linux_area").value='(wget "https://'+a+r+domainUrl+"meshagents?script=1"+(urlargs.key?"&key="+urlargs.key:"")+'"'+(2147483648&features?" --no-check-certificate":"")+' -O ./meshinstall.sh || wget "https://'+a+r+domainUrl+'meshagents?script=1" --no-proxy'+(2147483648&features?" --no-check-certificate":"")+" -O ./meshinstall.sh) && chmod 755 ./meshinstall.sh && sudo -E ./meshinstall.sh https://"+a+r+s+" '"+e.split("/")[2]+"' || ./meshinstall.sh https://"+a+r+s+" '"+e.split("/")[2]+"'\r\n",Q("agins_linux_area_un").value='(wget "https://'+a+r+domainUrl+"meshagents?script=1"+(urlargs.key?"&key="+urlargs.key:"")+'"'+(2147483648&features?" --no-check-certificate":"")+' -O ./meshinstall.sh || wget "https://'+a+r+domainUrl+'meshagents?script=1" --no-proxy'+(2147483648&features?" --no-check-certificate":"")+" -O ./meshinstall.sh) && chmod 755 ./meshinstall.sh && sudo -E ./meshinstall.sh uninstall https://"+a+r+s+" '"+e.split("/")[2]+"' || ./meshinstall.sh uninstall https://"+a+r+s+" '"+e.split("/")[2]+"'\r\n"),Q("aginsSelect").focus(),addAgentToMeshClick(),!1}function setModalContent(e,t,n,o=null){var i=document.getElementById("xxAddAgentModalConf"),a=document.getElementById(e+"Title");if(i&&a){if(a.innerHTML=t,"number"==typeof n){for(var s=1;s<24;s++)QV("dialog"+s,s==n);xxdialogMode=s}else if("string"==typeof n){Q("dialog2").innerHTML=n;for(s=1;s<24;s++)QV("dialog"+s,2==s);xxdialogMode=2}if(o)switch(i.classList.remove("modal-sm","modal-lg","modal-xl"),o){case"small":i.classList.add("modal-sm");break;case"large":i.classList.add("modal-lg");break;case"extra-large":i.classList.add("modal-xl")}else i.classList.remove("modal-sm","modal-lg","modal-xl")}else console.error("Modal elements not found:",e+"Title",e+"Body")}function showModal(e,t,n,o=null,i=null){if(null==xxModal){["idx_dlgOkButton","idx_dlgCancelButton"].forEach(function(e){Q(e).onclick=null,QE(e,!0),QV(e,!0)}),xxModal=new bootstrap.Modal(document.getElementById(e));var a=function(t){xxModal&&(xxModal.dispose(),xxModal=null),0!=xxdialogMode&&(xxdialogMode=0),document.getElementById(e).removeEventListener("hidden.bs.modal",a)};document.getElementById(e).addEventListener("hidden.bs.modal",a)}xxModal.show(),document.getElementById(t).onclick=function(){"function"==typeof n&&n?(xxdialogMode=0,!1!==n(o,i)&&xxModal.hide()):xxModal&&xxModal.hide()}}function copyAgentIdValue(e){copyTextToClip(Q(e).value)}function showNotification(e,t,n,o,i,a,s,r){Swal.fire({position:e,title:t,text:n,icon:o,confirmButtonText:i,timer:a,width:s,showConfirmButton:null!==i})}function copyAgentUrl(e,t){var n=serverinfo.name;(-1==n.indexOf(".")||2&features)&&(n=window.location.hostname);domainUrl.substring(0,domainUrl.length-1);var o="https://"+n+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+e;1==t&&(o+=Q("aginsType").value),o+=urlargs.key?"&key="+urlargs.key:"",5==Q("aginsSelect").value&&(o+="&meshinstall="+Q("aginsSysType").value),7==Q("aginsSelect").value&&(o+="&ac="+Q("asinsType").value),copyTextToClip(o)}function addAgentToMeshClick(){var e=Q("aginsSelect").value;QV("agins_windows",0==e),QV("agins_linux",1==e),QV("agins_osx",2==e),QV("agins_windows_un",3==e),QV("agins_linux_un",4==e),QV("agins_linux_inst",5==e),QV("aginsSysTypeDiv",5==e),QV("agins_qrcode",6==e),QV("agins_assistant",7==e&&4!=Q("asinsType").value),QV("agins_assistant2",7==e&&4==Q("asinsType").value),QV("agins_osx_un",8==e),Q("aginsbinlnk").onclick=function(){downloadFile(Q("aginsbinlnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:"")+"&meshinstall="+Q("aginsSysType").value)},Q("aginsbincmd").value=Q("aginsbincmd").value.split("&installflags=")[0]+"&installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:"")+"&meshinstall="+Q("aginsSysType").value+'"',QV("aginsTypeDiv",0==e||5==e),QV("asinsTypeDiv",7==e),Q("aginsw32lnk").onclick=function(){downloadFile(Q("aginsw32lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginsw64lnk").onclick=function(){downloadFile(Q("aginsw64lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginswa64lnk").onclick=function(){downloadFile(Q("aginswa64lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginsw32unlnk").onclick=function(){downloadFile(Q("aginsw32lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginsw64unlnk").onclick=function(){downloadFile(Q("aginsw64lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},Q("aginswa64unlnk").onclick=function(){downloadFile(Q("aginswa64lnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)},debugmode>0&&(Q("aginswmshlnk").onclick=function(){downloadFile(Q("aginswmshlnk").name.split("installflags=")[0]+"installflags="+Q("aginsType").value+(urlargs.key?"&key="+urlargs.key:""),null,!0)}),Q("asinslnk").onclick=function(){downloadFile(Q("asinslnk").name+"&ac="+Q("asinsType").value,null,!0)},Q("asinslnk2").onclick=function(){downloadFile(Q("asinslnk").name+"&ac="+Q("asinsType").value,null,!0)},7==e&&(QV("agass_img1",Q("asinsType").value<2),QV("agass_img2",Q("asinsType").value>=2))}function validateDeviceToMesh(){QE("idx_dlgOkButton",Q("dp1devicename").value.length>0&&passwordcheck(Q("dp1password").value))}function addDeviceToMeshEx(e,t){var n=Q("dp1username").value;""==n&&(n="admin");var o=Q("dp1hostname").value;""==o&&(o=Q("dp1devicename").value),meshserver.send({action:"addamtdevice",meshid:t,devicename:Q("dp1devicename").value,hostname:o,amtusername:n,amtpassword:Q("dp1password").value,amttls:Q("dp1tls").value})}function deviceHeaderSet(){0!=deviceHeaderId?(deviceHeaders["DevxHeader"+deviceHeaderId]=1==deviceHeaderTotal?"1 устройство":format("{0} устройств",deviceHeaderTotal),deviceHeaderId++,deviceHeaderCount={},deviceHeaderTotal=0):deviceHeaderId=1}var powerStateStrings=["",'<span title="Устройство включено.">Включено</span>','<span title="Устройство находится в спящем режиме (S1).">В режиме сна</span>','<span title="Устройство находится в спящем режиме (S2).">В режиме сна</span>','<span title="Устройство находится в состоянии глубокого сна (S3).">Глубокий сон</span>','<span title="Устройство находится в режиме гибернации (S4).">Гибернация</span>','<span title="Устройство находится в выключенном состоянии (S5).">Soft-Off</span>','<span title="Устройство обнаружено, но состояние питания не может быть получено.">Текущее состояние</span>','<span title="Устройство выключено.">Выключено</span>'],powerStateStrings2=["","Устройство включено","Устройство находится в спящем режиме (S1)","Устройство находится в спящем режиме (S2)","Устройство находится в состоянии глубокого сна (S3)","Устройство находится в режиме гибернации (S4)","Устройство находится в выключенном состоянии (S5)","Устройство присутствует, но состояние питания не может быть определено","Устройство выключено"],powerColorTable=["pwsTransparent","pwsBlack","pwsBlue","pwsBlue2","pwsLightblue","pwsBlueviolet","pwsDarkgreen","pwsLightseagreen","pwsLightseagreen2"];function NodeStateStr(e){var t=[];return e.state>0&&e.state<powerStatetable.length&&state.push(powerStatetable[e.state]),e.conn&&(1&e.conn&&(4==e.mtype?"PDU"==e.porttype?t.push('<span title="Выключатель питания готов к использованию.">Свитч</span>'):t.push('<span title="Порт IP-KVM запущен и готов к использованию.">IP-KVM</span>'):t.push('<span title="Mesh Agent подключен и готов к использованию.">Агент</span>')),2&e.conn?t.push('<span title="Intel&reg; AMT CIRA подключен и готов к использованию.">CIRA</span>'):4&e.conn&&t.push('<span title="Intel&reg; AMT маршрутизируется.">AMT</span>'),8&e.conn&&t.push('<span title="Mesh Agent доступен с использованием другого агента в качестве ретранслятора.">Ретранслятор</span>'),16&e.conn&&t.push('<span title="MQTT подключение к устройству активно.">MQTT</span>')),null!=e.pwr&&0!=e.pwr&&t.push(powerStateStrings[e.pwr]),0==t.length?"&nbsp;":t.join(", ")}function PowerStateStr(e){return e<powerStatetable.length?powerStatetable[e]:""}function PowerStateStr2(e){return 0!=e&&e<powerStatetable.length?powerStatetable[e]:"Неизвестно"}function updateCollapseAllButton(){var e=Object.keys(CollapsedGroups).length>0;QV("CollapseAllButton",!e),QV("ExpandAllButton",e),QV("CollapseAllButton2",!e),QV("ExpandAllButton2",e)}function selectallButtonFunction(){for(var e=document.getElementsByClassName("DeviceCheckbox"),t=Object.keys(checkedNodeids).length,n=0;n<e.length;n++)e[n].checked=0==t;if(checkedNodeids={},0==t){checkedNodeids={};var o=document.getElementsByName("xxdevice"+Q("viewselect").value);for(n=0;n<o.length;n++)(null==o[n].parentElement.attributes.style||o[n].parentElement.attributes.style.value.indexOf("display")<0)&&(checkedNodeids[o[n].id.substring(3)]=1)}p1updateInfo()}function p1devcheck(e){e.srcElement.checked?checkedNodeids[e.srcElement.value.substring(6)]=1:delete checkedNodeids[e.srcElement.value.substring(6)],p1updateInfo()}function p1updateInfo(){var e=Object.keys(checkedNodeids).length;if(e>0?(QE("GroupActionButton",!0),Q("SelectAllButton").value="Очистить все",QV("cxmdesktop",!0)):(QE("GroupActionButton",!1),Q("SelectAllButton").value="Выбрать все",QV("cxmdesktop",!1)),null!=customui&&customui.devicesbarbuttons)for(var t in customui.devicesbarbuttons)"one"==customui.devicesbarbuttons[t].selection&&QE("cui:"+t,1==e),"many"==customui.devicesbarbuttons[t].selection&&QE("cui:"+t,e>=1)}function groupActionFunction(){var e=[],t=getCheckedDevices(),n=0;if(262144&features&&0==count2factoraAuths())return setModalContent("xxAddAgent","Безопасность учетной записи",'Невозможно получить доступ к этой функции, пока не будет включена двухфакторная аутентификация. Это необходимо для дополнительной безопасности. Перейдите на вкладку "Моя учетная запись" и посмотрите раздел "Безопасность учетной записи".'),void showModal("xxAddAgentModal","idx_dlgOkButton");if(4194304&features)for(var o in t)if(16&getNodeFromId(t[o]).conn){e.push({v:103,name:"Отправить MQTT сообщение"});break}for(var o in e.push({v:105,name:"Экспорт информации об устройствах",s:!0}),t){var i=getNodeFromId(t[o]),a=GetNodeRights(i);1&a&&!(2&n)&&(n|=2,e.push({v:102,name:"Переместить в группу устройств"})),1&i.conn&&32768&a&&!(1&n)&&(n|=1,e.push({v:104,name:"Удаление агента"})),64&a&&!(8&n)&&(n|=8,e.push({v:100,name:"Разбудить устройства"})),262144&a&&!(4&n)&&(n|=4,e.push({v:4,name:"Отправить в сон"}),e.push({v:3,name:"Отправить в перезагрузку"}),e.push({v:2,name:"Выключить устройства"})),131072&a&&!(16&n)&&(n|=16,e.push({v:106,name:"Выполнить команды"})),16384&a&&!(32&n)&&(n|=32,e.push({v:108,name:"Отправить уведомление"})),4&a&&!(64&n)&&(n|=64,e.push({v:107,name:"Отредактировать тэги"})),8&a&&!(256&n)&&(n|=256,e.push({v:109,name:"Загрузить файлы"})),32768&a&&!(128&n)&&(n|=128,e.push({v:101,name:"Удалить устройства"})),null!=i.agent&&16&features2&&4294967295==a&&!(512&n)&&(n|=512,e.push({v:110,name:"Принудительно обновить агент"}),e.push({v:111,name:"Очистить ядро агента"}),e.push({v:112,name:"Загрузить ядро по умолчанию с сервера "}))}var s="";for(var o in e.sort(nameSort),e)s+="<option value="+e[o].v+(e[o].s?" selected":"")+">"+e[o].name+"</option>";var r="Выберите действие для осуществления на всех выбранных устройствах. Действия будут выполнены только при наличии соответствующих прав.<br /><br />";setModalContent("xxAddAgent","Групповое действие",r+=addHtmlFormFloating("Операция",'<select id=d2groupop class="form-select">'+s+"</select>")),showModal("xxAddAgentModal","idx_dlgOkButton",groupActionFunctionEx)}function getCheckedDevices(){return Object.keys(checkedNodeids)}function uncheckAllDevices(){for(var e=document.getElementsByClassName("DeviceCheckbox"),t=0;t<e.length;t++)e[t].checked=!1;checkedNodeids={}}function groupActionFunctionEx(){var e=Q("d2groupop").value;if(100==e)return meshserver.send({action:"wakedevices",nodeids:getCheckedDevices()}),uncheckAllDevices(),!0;if(101==e){var t="";if(0==(c=getCheckedDevices()).length)return;if(1==c.length)t+="Подтвердить удаление выбранного устройства?<br /><br />";else{t+=format("Подтвердить удаление выбранных устройств ({0})?<br />",c.length);var n=0,o=0;for(var i in c){null!=(u=getNodeFromId(c[i])).conn&&u.conn>0?n++:o++}var a="";1==n?a+=format("1 выбранное устройство в сети.<br />",n):n>1&&(a+=format("Выбранные устройства ({0}) подключены к Интернету.<br />",n)),1==o?a+=format("1 выбранное устройство не в сети.<br />",o):o>1&&(a+=format("Выбранные устройства ({0}) отключены.<br />",o)),t+=""!=a?"<div style=padding:8px>"+a+"</div>":"<br />"}setModalContent("xxAddAgent","Удалить устройства",t+='<label><input id=d2check type=checkbox class="form-check-input me-2" onchange=d2groupActionFunctionDelCheck() />Подтвердить</label>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2groupActionFunctionDelExec()),QE("idx_dlgOkButton",!1)}else if(102==e)p10showChangeGroupDialog(getCheckedDevices());else if(103==e)p10showSendMqttMsgDialog(getCheckedDevices());else if(104==e)p10showSendUninstallAgentDialog(getCheckedDevices());else if(105==e)p2downloadDeviceInfo();else if(106==e)d2runCommandDialog({nodeids:getCheckedDevices(),title:"Выполнить команды на выбранных устройствах.",func:uncheckAllDevices});else if(107==e){t="Выполнить пакетную операциию с тегами устройств<br /><br />";t+=addHtmlFormFloating("Операция",'<select id=d2deviceop class="form-select"><option value=1>Добавить теги</option><option value=2>Установить теги</option><option value=3>Удалить теги</option></select>'),t+=addHtmlFormFloating("Теги",'<select id=dp10devicevalue multiple class="form-control" maxlength=4096>');var s=[];a="";for(var i in nodes)if(nodes[i].tags)for(var r in nodes[i].tags)-1==s.indexOf(nodes[i].tags[r])&&s.push(nodes[i].tags[r]);if(s.length>0)for(var i in s.sort(),s){EscapeHtml(s[i]);a+="<option>"+EscapeHtml(s[i])+"</option>"}setModalContent("xxAddAgent","Изменить теги устройства",t+=a+"</select>"),$("#dp10devicevalue").select2({theme:"bootstrap-5",width:$(this).data("width")?$(this).data("width"):$(this).hasClass("w-100")?"100%":"style",placeholder:"Тег1, Тег2, Тег3",closeOnSelect:!1,allowClear:!0,tokenSeparators:[","],tags:!0}),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2groupActionFunctionTagsExec())}else if(108==e){t="<div style=margin-bottom:4px>Выполнить пакетное уведомление устройств</div>";t+='<select id=d2deviceop class="form-select-sm me-2" style=width:100%;margin-bottom:4px><option value=2>Уведомление в трее (тост)</option><option value=1>Уведомление в окне</option><option value=3>Alert Box</option></select>',t+='<input id=dp2notifyTitle maxlength=256 placeholder="Заголовок" style=width:100%;box-sizing:border-box;margin-bottom:4px />',t+="<textarea id=d2notifyMsg style=width:100%;height:140px;resize:none;overflow-y:scroll;box-sizing:border-box;margin-bottom:4px></textarea>",t+="<select style=width:100% id=d2notifyTimeout>",t+='<option disabled value="">Only Applicable to Message Box Notifications</option>',t+="<option value=2 selected>Show for 2 Minutes (Default)</option>",t+="<option value=10>Show for 10 minutes</option>",t+="<option value=30>Show for 30 minutes</option>",t+="<option value=60>Show for 60 minutes</option>",t+="<option value=0>Показывать сообщение, пока оно не будет закрыто пользователем</option>",setModalContent("xxAddAgent","Уведомление устройства",t+="</select>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2groupActionFunctionNotifyExec()),Q("d2notifyMsg").focus()}else if(109==e){var l=!1,d=!1,c=getCheckedDevices();for(var i in c){var u;(u=getNodeFromId(c[i])).agent&&(u.agent.id>0&&u.agent.id<5||34==u.agent.id?l=!0:d=!0)}t="Загрузить выбранные файлы на все выбранные устройства<br /><br />";t+="<form method=post enctype=multipart/form-data action=uploadfilebatch.ashx target=fileUploadFrame>",t+="<input type=hidden name=authCookie value="+authCookie+" /><input type=hidden name=nodeIds value="+c.join(",")+" /><input type=submit id=d2batchUploadSubmit style=display:none />",t+='<input type=file name=files id=d2uploadinput class="form-control" multiple=multiple onchange="d2batchUploadValidate()" /><br /><br />',l&&(t+=addHtmlFormFloating("Путь к Windows",'<input type=text class="form-control" onchange="d2batchUploadValidate()" onkeyup="d2batchUploadValidate()" name=winpath id=d2winuploadpath placeholder="C:\\temp" value="" />')),d&&(t+=addHtmlFormFloating("Путь к Linux",'<input type=text class="form-control" onchange="d2batchUploadValidate()" onkeyup="d2batchUploadValidate()" name=linuxpath id=d2linuxuploadpath placeholder="/tmp" value="" />')),t+='<br /><label><input type=checkbox class="form-check-input me-2" name=createFolder />Создать папку, если ее нет?</label><br />',setModalContent("xxAddAgent","Пакетная загрузка файла",t+='<label><input type=checkbox class="form-check-input me-2" name=overwriteFiles />Перезаписать, если файл существует?</label></form>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2batchUploadValidateOk()),d2batchUploadValidate()}else if(110==e){setModalContent("xxAddAgent","Принудительно обновить агент",t="Принудительно обновить агенты на выбранных устройствах?<br /><br />"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2groupActionFunctionAgentUpdateExec())}else if(111==e){setModalContent("xxAddAgent","Очистить ядро агента",t="Очистить ядро агента на выбранных устройствах?<br /><br />"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2groupActionFunctionAgentClearCoreExec())}else{if(112!=e)return meshserver.send({action:"poweraction",nodeids:getCheckedDevices(),actiontype:parseInt(e)}),uncheckAllDevices(),!0;setModalContent("xxAddAgent","Загрузить ядро по умолчанию с сервера ",t="Загрузить серверное ядро по умолчанию на выбранные устройства?<br /><br />"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>d2groupActionFunctionAgentDefaultCodeExec())}return!1}function d2batchUploadValidate(){QE("idx_dlgOkButton",!(0==Q("d2uploadinput").files.length||null!=Q("d2winuploadpath")&&""==Q("d2winuploadpath").value||null!=Q("d2linuxuploadpath")&&""==Q("d2linuxuploadpath").value))}function d2batchUploadValidateOk(){Q("d2batchUploadSubmit").click()}function d2groupActionFunctionAgentUpdateExec(){meshserver.send({action:"updateAgents",nodeids:getCheckedDevices()})}function d2groupActionFunctionAgentClearCoreExec(){meshserver.send({action:"uploadagentcore",nodeids:getCheckedDevices(),type:"clear"})}function d2groupActionFunctionAgentDefaultCodeExec(){meshserver.send({action:"uploadagentcore",nodeids:getCheckedDevices(),type:"default"})}function d2groupActionFunctionNotifyExec(){var e=Q("d2deviceop").value,t=Q("dp2notifyTitle").value,n=Q("d2notifyMsg").value,o=getCheckedDevices(),i=parseFloat(Q("d2notifyTimeout").value);if(0!=n.length)if(""==t&&(t=decodeURIComponent("{{{extitle}}}")),""==t&&(t="MeshCentral"),isNaN(i)&&(i=2),1==e)for(var a=0;a<o.length;a++)meshserver.send({action:"msg",type:"messagebox",nodeid:o[a],title:t,msg:n,timeout:6e4*i});else if(2==e)meshserver.send({action:"toast",nodeids:o,title:t,msg:n});else if(3==e)for(a=0;a<o.length;a++)meshserver.send({action:"msg",type:"alertbox",nodeid:o[a],title:t,msg:n})}function d2groupActionFunctionTagsExec(){var e=getCheckedDevices(),t=Q("d2deviceop").value,n=[],o=$("#dp10devicevalue").select2("data");for(var i in o)n.push(o[i].text.trim());if(2==t)for(var i in e)meshserver.send({action:"changedevice",nodeid:e[i],tags:n.join(",")});else{var a=[];for(var i in n){var s=n[i].trim();s.length>0&&s.length<64&&-1==a.indexOf(s)&&a.push(s)}for(var i in e){var r=null,l=!1,d=getNodeFromId(e[i]);null!=d.tags&&(r=Clone(d.tags)),null==r&&(r=[]);for(var c=0;c<n.length;c++)if(1==t&&-1==r.indexOf(n[c])&&(r.push(n[c]),l=!0),3==t){var u=r.indexOf(n[c]);u>=0&&(r.splice(u,1),l=!0)}l&&meshserver.send({action:"changedevice",nodeid:e[i],tags:r.join(",")})}}}function p2downloadDeviceInfo(){if(!xxdialogMode){var e=getCheckedDevices(),t=!1;for(var n in e)null!=getNodeFromId(e[n]).intelamt&&(t=!0);var o="Скачайте список устройств в одном из форматов доступных ниже.<br /><br />";o+=addHtmlValue("Формат CSV","<a href=# style=cursor:pointer onclick='return p2downloadDeviceInfoCSV()'>devicelist.csv</a>"),o+=addHtmlValue("Формат JSON","<a href=# style=cursor:pointer onclick='return p2downloadDeviceInfoJSON()'>devicelist.json</a>"),t&&(o+=addHtmlValue("Intel&reg; AMT JSON","<a href=# style=cursor:pointer onclick='return p2downloadAmtInfoJSON()'>computerlist.json</a>")),setModalContent("xxAddAgent","Экспорт информации об устройстве",o+='<div style=margin-top:8px><label><input type=checkbox class="form-check-input me-2" id=d2DevInfoDetailsCheck />Добавить подробные сведения об устройствах</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton")}}function csvClean(e){return null==e?"":e.split(",").join("")}function p2downloadDeviceInfoCSV(){var e=getCheckedDevices();if(Q("d2DevInfoDetailsCheck").checked){var t=null;try{t=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}meshserver.send({action:"getDeviceDetails",nodeids:e,tz:t,tf:(new Date).getTimezoneOffset(),l:getLang(),type:"csv"})}else{var n="id,name,rname,host,icon,ip,osdesc,state,groupname,conn,pwr,av,update,firewall,bitlocker,avdetails,tags,lastbootuptime\r\n";for(var o in e){var i=getNodeFromId(e[o]);if(n+='"'+i._id.split(",").join("")+'","'+i.name.split(",").join("")+'","'+(i.rname?i.rname.split(",").join(""):"")+'","'+(i.host?i.host.split(",").join(""):"")+'","'+i.icon+'","'+(i.ip?i.ip:"")+'","'+(i.osdesc?i.osdesc.split(",").join(""):"")+'","'+i.state+'","'+meshes[i.meshid].name.split(",").join("")+'","'+(i.conn?i.conn:"")+'","'+(i.pwr?i.pwr:"")+'"',"object"==typeof i.wsc?n+=',"'+csvClean(i.wsc.antiVirus)+'","'+csvClean(i.wsc.autoUpdate)+'","'+csvClean(i.wsc.firewall)+'"':n+=",,,","object"==typeof i.volumes){var a="",s=!0;for(var r in i.volumes)void 0!==i.volumes[r].protectionStatus&&(s?s=!1:a+="|",a+=r+"/"+i.volumes[r].volumeStatus);n+=',"'+csvClean(a)+'"'}else n+=",";if("object"==typeof i.av){var l="",d=!0;for(var r in i.av)"string"==typeof i.av[r].product&&(d?d=!1:l+="|",l+=i.av[r].product+"/"+(i.av[r].enabled?"enabled":"disabled")+"/"+(i.av[r].updated?"updated":"notupdated"));n+=',"'+csvClean(l)+'"'}else n+=",";if("object"==typeof i.tags){var c="",u=!0;for(var r in i.tags)u?u=!1:c+="|",c+=i.tags[r];n+=',"'+csvClean(c)+'"'}else n+=",";"number"==typeof i.lastbootuptime&&(n+=',"'+i.lastbootuptime+'"'),n+="\r\n"}saveAs(stringToUtf8Blob(n),"devicelist.csv")}return!1}function p2downloadAmtInfoJSON(){var e=getCheckedDevices(),t={webappversion:"0.9.0",computers:[]};for(var n in e){var o=getNodeFromId(e[n]);if(null!=o.intelamt){var i={name:o.name,host:o.host,user:o.intelamt.user,pass:"",tls:1==o.intelamt.tls?1:0,ver:o.intelamt.ver,pstate:o.intelamt.state};2==o.intelamt.state&&(i.pmode=1),o.intelamt.realm&&(i.digestrealm=o.intelamt.realm),o.intelamt.hash&&(i.tlscerthash=o.intelamt.hash),t.computers.push(i)}}saveAs(new Blob([JSON.stringify(t,null,2)],{type:"application/octet-stream"}),"computerlist.json")}function p2downloadDeviceInfoJSON(){var e=getCheckedDevices();if(Q("d2DevInfoDetailsCheck").checked){var t=null;try{t=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}meshserver.send({action:"getDeviceDetails",nodeids:e,tz:t,tf:(new Date).getTimezoneOffset(),l:getLang(),type:"json"})}else{var n=[];for(var o in e)n.push(getNodeFromId(e[o]));saveAs(new Blob([JSON.stringify(n,null,2)],{type:"application/octet-stream"}),"devicelist.json")}return!1}function d2groupActionFunctionDelCheck(){QE("idx_dlgOkButton",Q("d2check").checked)}function d2groupActionFunctionDelExec(){meshserver.send({action:"removedevices",nodeids:getCheckedDevices()}),uncheckAllDevices()}function d2runCommandDialog(e){var t=!1,n=!1,o=!1;for(var i in e.nodeids){var a=getNodeFromId(e.nodeids[i]);a.agent&&(24&~GetNodeRights(a)||(o=!0),a.agent.id>0&&a.agent.id<5?t=!0:n=!0)}if(1==t||1==n||1==o){var s={type:1,runAs:0,source:1,cmd:""};try{s=JSON.parse(getstore("runopt",s))}catch(e){}if(e.selectedFile){var r=e.selectedFile.name.toLowerCase();console.log("filename",r),r.endsWith(".bat")&&(s.type=1),r.endsWith(".ps1")&&(s.type=2),r.endsWith(".sh")&&(s.type=3),r.endsWith(".agentconsole")&&(s.type=4)}var l="";e.title&&(l+=e.title+"<br />"),l+="<select id=d2cmdtype onclick=d2runCommandValidate() style=width:100%;margin-bottom:4px;margin-top:4px class=form-select>",1==t&&(l+="<option value=1"+(1==s.type?" selected":"")+">Командная строка Windows</option><option value=2"+(2==s.type?" selected":"")+">Windows PowerShell</option>"),1==n&&(l+="<option value=3"+(3==s.type?" selected":"")+">Командная оболочка Linux/BSD/macOS</option>"),1==o&&(l+="<option value=4"+(4==s.type?" selected":"")+">Консоль агента</option>"),l+="</select>",l+="<select id=d2cmduser style=width:100%;margin-bottom:4px class=form-select><option value=0"+(0==s.runAs?" selected":"")+">Запуск от имени агента</option><option value=1"+(1==s.runAs?" selected":"")+">Запуск от имени пользователя, если нет пользователя, то от агента</option><option value=2"+(2==s.runAs?" selected":"")+">Запуск только от имени пользователя</option></select>",null==e.selectedFile&&(l+="<select id=d2cmdsource onclick=d2runCommandValidate() style=width:100%;margin-bottom:4px class=form-select><option value=0"+(0==s.source?" selected":"")+">Commands from text box</option><option value=1"+(1==s.source?" selected":"")+">Commands from file</option>",8&userinfo.siteadmin&&(l+="<option value=2"+(2==s.source?" selected":"")+">Commands from file on server</option>"),l+="</select><textarea id=d2runcmd onkeyup=d2runCommandValidate() style=background-color:#fcf3cf;width:100%;height:200px;resize:none;overflow-y:scroll class=form-control>"+(s.cmd?EscapeHtml(decodeURIComponent(s.cmd)):"")+"</textarea>",l+='<div id=d2runfile style=display:none><input id=d2runfileex class="form-control" type=file onchange=d2runCommandValidate() id=d2localFile name=files onchange=d2runCommandValidate() /></div>',8&userinfo.siteadmin&&(l+='<div id=d2runsfile style=display:none><div id=d2serveraction valign=bottom><input type=button id=p2FolderUp disabled="disabled" onclick=d3folderup() value="Up" />&nbsp;<span id=p2CurrentFolder></span></div><div id=d2serverfiles></div></div>')),xxdialogTag=e,setModalContent("xxAddAgent","Выполнить команды",l),showModal("xxAddAgentModal","idx_dlgOkButton",function(){d2groupActionFunctionRunCommands(3,e)}),null==e.selectedFile&&(Q("d2runcmd").focus(),8&userinfo.siteadmin&&(d3fileoptions={dialog:2,files:"d2serverfiles",folderup:"p2FolderUp",currentFolder:"p2CurrentFolder",func:null},d3updatefiles())),d2runCommandValidate()}}function d2runCommandValidate(){if(QV("d2cmduser",Q("d2cmdtype").value<4),null==xxdialogTag.selectedFile){QV("d2runcmd",0==Q("d2cmdsource").value),QV("d2runfile",1==Q("d2cmdsource").value),QV("d2runsfile",2==Q("d2cmdsource").value);var e=!1;0==Q("d2cmdsource").value&&Q("d2runcmd").value.length>0&&(e=!0),1==Q("d2cmdsource").value&&1==Q("d2runfileex").files.length&&(e=!0),2==Q("d2cmdsource").value&&(e=!1),QE("idx_dlgOkButton",e)}else QE("idx_dlgOkButton",!0)}function d2groupActionFunctionRunCommands(e,t){var n=3;try{n=parseInt(Q("d2cmdtype").value)}catch(e){}null==t.selectedFile&&putstore("runopt",JSON.stringify({type:n,runAs:parseInt(Q("d2cmduser").value),source:parseInt(Q("d2cmdsource").value),cmd:encodeURIComponent(Q("d2runcmd").value)}));var o={action:"runcommands",nodeids:t.nodeids,type:n,runAsUser:parseInt(Q("d2cmduser").value)};if(t.selectedFile)(i=new FileReader).onload=function(e){o.cmds=e.target.result,meshserver.send(o),t.func&&t.func()},i.readAsText(t.selectedFile);else if(0==Q("d2cmdsource").value)o.cmds=Q("d2runcmd").value,meshserver.send(o),t.func&&t.func();else if(1==Q("d2cmdsource").value){var i;(i=new FileReader).onload=function(e){o.cmds=e.target.result,meshserver.send(o),t.func&&t.func()},i.readAsText(Q("d2runfileex").files[0])}else if(2==Q("d2cmdsource").value){var a=d3getFileSel();if(1!=a.length)return;o.cmdpath=d3filetreelocation.join("/")+"/"+a[0],meshserver.send(o),t.func&&t.func()}}function onSortSelectChange(e){sort=document.getElementById("sortselect").selectedIndex,e||putstore("sort",sort)}var sortCollator=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});function nameSort(e,t){var n=e.name.toLowerCase(),o=t.name.toLowerCase();return sortCollator.compare(n,o)}function meshSort(e,t){var n=sortCollator.compare(e.meshnamel,t.meshnamel);return 0!=n||0!=(n=sortCollator.compare(e.meshid,t.meshid))?n:1==showRealNames?sortCollator.compare(e.rnamel,t.rnamel):sortCollator.compare(e.namel,t.namel)}function powerSort(e,t){var n=e.pwr?e.pwr:0,o=t.pwr?t.pwr:0;return n>o?-1:n<o?1:n==o?1==showRealNames?sortCollator.compare(e.rnamel,t.rnamel):sortCollator.compare(e.namel,t.namel):void 0}function deviceSort(e,t){return sortCollator.compare(e.namel,t.namel)}function deviceHostSort(e,t){return sortCollator.compare(e.rnamel,t.rnamel)}function lastConnectSort(e,t){var n=e.lastconnect,o=t.lastconnect;return null==n&&(n=99999999999999),null==o&&(o=99999999999999),e.conn>0&&(n=99999999999998),t.conn>0&&(o=99999999999998),n==o?nameSort(e,t):n-o}function onSearchFocus(e){searchFocus=e}function clearDeviceSearch(){Q("KvmSearchInput").value=Q("SearchInput").value="",onOnlineCheckBox(),mainUpdate(1)}function onMapSearchFocus(e){mapSearchFocus=e}function onUserSearchFocus(e){userSearchFocus=e}function onConsoleFocus(e){consoleFocus=e}function parseSearchAndInput(e){var t=e.split(" а также "),n=null;for(var o in t){var i=getDevicesThatMatchFilter(t[o]);if(null==n)n=i;else{var a=[];for(var s in i)n.indexOf(i[s])>=0&&a.push(i[s]);n=a}}return n}function parseSearchOrInput(e){var t=e.split(" или "),n=null;for(var o in t){var i=parseSearchAndInput(t[o]);if(null==n)n=i;else for(var a in i)n.indexOf(i[a]>=0)&&n.push(i[a])}return n}function getDevicesThatMatchFilter(e){var t=[],n=null,o=null,i=null,a=null,s=null,r=null,l=null,d=null,c=null,u=null;if(e.startsWith("пользователь:".toLowerCase())?n=e.substring(13):e.startsWith("u:".toLowerCase())?n=e.substring(2):e.startsWith("ip:".toLowerCase())?o=e.substring(3):e.startsWith("группа:".toLowerCase())?i=e.substring(7):e.startsWith("g:".toLowerCase())?i=e.substring(2):e.startsWith("tag:".toLowerCase())?a=e.substring(4):e.startsWith("т:".toLowerCase())?a=e.substring(2):e.startsWith("atag:".toLowerCase())?s=e.substring(5):e.startsWith("а:".toLowerCase())?s=e.substring(2):e.startsWith("os:".toLowerCase())?l=e.substring(3):e.startsWith("amt:".toLowerCase())?d=e.substring(4):e.startsWith("desc:".toLowerCase())?c=e.substring(5):e.startsWith("connectivity:".toLowerCase())?u=e.substring(13):e.startsWith("c:".toLowerCase())?u=e.substring(2):"wsc:ok"==e?r=1:"wsc:noav"==e?r=2:"wsc:noupdate"==e?r=3:"wsc:nofirewall"==e?r=4:"wsc:any"==e&&(r=5),""==e)for(var p in nodes)t.push(p);else if(null!=o)for(var p in nodes)null!=nodes[p].ip&&nodes[p].ip.toLowerCase().indexOf(o)>=0&&t.push(p);else if(null!=i)for(var p in nodes)meshes[nodes[p].meshid].name.toLowerCase().indexOf(i)>=0&&t.push(p);else if(null!=a){for(var p in nodes)if(null==nodes[p].tags&&""==a)t.push(p);else if(null!=nodes[p].tags)for(var m in nodes[p].tags)if(nodes[p].tags[m].toLowerCase().indexOf(a)>=0){t.push(p);break}}else if(null!=s)for(var p in nodes)(null!=nodes[p].agent&&null==nodes[p].agent.tag&&""==s||null!=nodes[p].agent&&null!=nodes[p].agent.tag&&nodes[p].agent.tag.toLowerCase().indexOf(s)>=0)&&t.push(p);else if(null!=n){for(var p in nodes)if(nodes[p].users&&nodes[p].users.length>0)for(var g in nodes[p].users)nodes[p].users[g].toLowerCase().indexOf(n)>=0&&t.push(p)}else if(null!=l)for(var p in nodes)null!=nodes[p].osdesc&&nodes[p].osdesc.toLowerCase().indexOf(l)>=0&&t.push(p);else if(null!=d)for(var p in nodes)null==nodes[p].intelamt||""!=d&&nodes[p].intelamt.state!=d||t.push(p);else if(null!=c)for(var p in nodes)null!=nodes[p].desc&&""!=nodes[p].desc&&(""==c||nodes[p].desc.toLowerCase().indexOf(c)>=0)&&t.push(p);else if(null!=r)for(var p in nodes)nodes[p].wsc&&(1==r&&"OK"==nodes[p].wsc.antiVirus&&"OK"==nodes[p].wsc.autoUpdate&&"OK"==nodes[p].wsc.firewall?t.push(p):(2!=r&&5!=r||"OK"==nodes[p].wsc.antiVirus)&&(3!=r&&5!=r||"OK"==nodes[p].wsc.autoUpdate)&&(4!=r&&5!=r||"OK"==nodes[p].wsc.firewall)||t.push(p));else if(null!=u){for(var p in nodes)if(nodes[p].conn&&(1&nodes[p].conn&&(4==nodes[p].mtype?("PDU"==nodes[p].porttype&&"switch"==u.toLowerCase()||"ipkvm"==u.toLowerCase())&&t.push(p):"agent"==u.toLowerCase()&&t.push(p)),(2&nodes[p].conn&&"cira"==u.toLowerCase()||4&nodes[p].conn&&"amt"==u.toLowerCase())&&t.push(p),8&nodes[p].conn&&"relay"==u.toLowerCase()&&t.push(p),16&nodes[p].conn&&"mqtt"==u.toLowerCase()&&t.push(p)),3==nodes[p].mtype){var v=meshes[nodes[p].meshid];(v&&v.relayid&&"relay"==u.toLowerCase()||v&&void 0===v.relayid&&"local"==u.toLowerCase())&&t.push(p)}}else if("*"==e)for(var p in nodes)1==stars[nodes[p]._id]&&t.push(p);else try{var h=e.split(/\s+/).join("|"),f=new RegExp(h);for(var p in nodes)32768&features2?268435456&features2?(f.test(nodes[p].name.toLowerCase())||f.test(meshes[nodes[p].meshid].name.toLowerCase())||null!=nodes[p].rnamel&&f.test(nodes[p].rnamel.toLowerCase()))&&t.push(p):(f.test(nodes[p].name.toLowerCase())||null!=nodes[p].rnamel&&f.test(nodes[p].rnamel.toLowerCase()))&&t.push(p):268435456&features2?showRealNames?(null!=nodes[p].rnamel&&f.test(nodes[p].rnamel.toLowerCase())||f.test(meshes[nodes[p].meshid].name.toLowerCase()))&&t.push(p):(f.test(nodes[p].name.toLowerCase())||f.test(meshes[nodes[p].meshid].name.toLowerCase()))&&t.push(p):showRealNames?null!=nodes[p].rnamel&&f.test(nodes[p].rnamel.toLowerCase())&&t.push(p):f.test(nodes[p].name.toLowerCase())&&t.push(p)}catch(e){for(var p in nodes)t.push(p)}return t}function onSearchInputChanged(){var e=Q("SearchInput").value.toLowerCase().trim();putstore("_search",Q("SearchInput").value),""==e?QC("SearchInput").remove("search"):QC("SearchInput").add("search"),QV("SearchInputClearButton",""!=e),QV("KvmSearchInputClearButton",""!=e);var t=parseSearchOrInput(e);for(var n in nodes)nodes[n].v=t.indexOf(n)>=0;var o=Q("DevFilterSelect").value;if(1==o)for(var n in nodes)null!=nodes[n].conn&&0!=nodes[n].conn||3==nodes[n].mtype||(nodes[n].v=!1);if(2==o)for(var n in nodes){(null==(i=nodes[n]).sessions||null==i.sessions.kvm&&null==i.sessions.terminal&&null==i.sessions.files&&null==i.sessions.tcp&&null==i.sessions.udp)&&(i.v=!1)}if(3==o)for(var n in nodes)1!=stars[nodes[n]._id]&&(nodes[n].v=!1);if(4==o)for(var n in nodes)null==nodes[n].intelamt&&(nodes[n].v=!1);if(5==o)for(var n in nodes)null!=nodes[n].conn&&0!=nodes[n].conn&&(nodes[n].v=!1);if(6==o)for(var n in nodes){null!=(i=nodes[n]).sessions&&null!=i.sessions.help||(i.v=!1)}if(7==o)for(var n in nodes){null!=(i=nodes[n]).tags&&0!=i.tags.length||(i.v=!1)}if(8==o)for(var n in nodes){var i;null!=(i=nodes[n]).tags&&i.tags.length>0&&(i.v=!1)}}function newContextMenu(e,t){if(1===t){if(null==currentNode||null==currentNode.agent||3==currentNode.mtype)return!0;if(serverinfo.linuxshell&&currentNode.agent.id>4)return;var n=e.target.nextElementSibling;if(n)for(var o=n.children,i=currentNode.agent.id>4&&!isWindowsNode(currentNode)?"lin":34==currentNode.agent.id?"add":null,a=0;a<o.length;a++)o[a].style.display=i?o[a].classList.contains(i)?"block":"none":o[a].classList.contains("lin")||o[a].classList.contains("ass")?"none":"block"}}var contextelement=null;function handleContextMenu(e){if(hideContextMenu(),!xxdialogMode){for(var t=null!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,n=null!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop,o=document.elementFromPoint(e.pageX-t,e.pageY-n);o&&null!=o&&null==o.attributes.cmenu;)o=o.parentElement;if(null==o)return!0;var i=o.attributes.cmenu.value;if("devsContentMenu"===i){contextelement=o;var a,s=document.getElementById("contextMenu");showContextMenuDiv(s,e.pageX,e.pageY);var r=getNodeFromId((a=1==Q("viewselect").value?contextelement.children[0].children[0].children[1].children[0].attributes.onmouseup.value:contextelement.children[1].attributes.onmouseup.value).substring(12,a.length-18)),l=GetNodeRights(r),d=!!(16&l),c=4294967295==l||!(65536&l),u=4294967295==l||!(512&l),p=4294967295==l||!(1024&l);QV("cxdesktop",!!(1&r.conn)&&4!=r.mtype&&(1==r.mtype||null==r.agent||null==r.agent.caps||!!(1&r.agent.caps)||r.intelamt&&2==r.intelamt.state)&&(8&l||256&l)&&c),QV("cxterminal",!!(1&r.conn)&&4!=r.mtype&&(1==r.mtype||null==r.agent||null==r.agent.caps||!!(2&r.agent.caps)||r.intelamt&&2==r.intelamt.state)&&8&l&&u),QV("cxfiles",4!=r.mtype&&2==r.mtype&&(null==r.agent||null==r.agent.caps||!!(4&r.agent.caps))&&8&l&&p),QV("cxevents",null!=r.intelamt&&(2==r.intelamt.state||2&r.conn)&&8&l),QV("cxdetails",r.mtype<3),QV("cxwebvnc",(!!(1&r.conn)||3==r.mtype)&&r.agent&&!!(8&l)&&!(536870912&features)),QV("cxwebrdp",(!!(1&r.conn)||3==r.mtype)&&r.agent&&!!(8&l)&&!(1073741824&features)),QV("cxwebssh",512&features2&&(!!(1&r.conn)||3==r.mtype)&&r.agent&&!!(8&l)),QV("cxconsole",d&&2==r.mtype&&(null==r.agent||null==r.agent.caps||!!(8&r.agent.caps))&&8&l),QV("cxrdp",!1),(1&r.conn||3==r.mtype)&&r.agent&&8&l&&r.agent.id>0&&r.agent.id<5&&"win32"==navigator.platform.toLowerCase()&&(null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.rdp||QV("cxrdp",!0)),QV("cxmgroupsplit",!0),QV("cxstar",!0)}else{if(null==(s=document.getElementById(i)))return!0;contextelement=o,showContextMenuDiv(s,e.pageX,e.pageY)}return haltEvent(e)}}function showContextMenuDiv(e,t,n){var o=document.documentElement.getBoundingClientRect(),i=o.height,a=o.width;e.style.left=e.style.right=e.style.top=e.style.bottom=null,t>a/2?e.style.right=a-event.pageX+"px":e.style.left=event.pageX+"px",n>i/2?e.style.bottom=i-event.pageY+"px":e.style.top=event.pageY+"px",e.style.display="block"}function cmaction(e,t){var n;if(n=(n=1==Q("viewselect").value?contextelement.children[0].children[0].children[1].children[0].attributes.onmouseup.value:contextelement.children[1].attributes.onmouseup.value).substring(12,n.length-18),9==e&&(Q("viewselect").value=3,Q("viewselect").onchange(),Q("autoConnectDesktopCheckbox").checked=!0,Q("autoConnectDesktopCheckbox").onclick()),e>0&&e<9){var o=[0,10,12,11,13,16,17,15,19][e];if(t&&1==t.shiftKey)safeNewWindow(window.location.origin+"?node="+n.split("/")[2]+"&viewmode="+o+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+n);else{gotoDevice(n,o);var i=meshes[currentNode.meshid];1&currentNode.conn&&2==i.mtype&&(11==o&&null==desktop&&1&currentNode.agent.caps&&connectDesktop(null,3),12==o&&null==terminal&&2&currentNode.agent.caps&&connectTerminal(null,1),13==o&&null==files&&connectFiles(null))}}if(10==e){for(var a=document.getElementsByClassName("DeviceCheckbox"),s=[],r=0;r<a.length;r++)!0===a[r].checked&&s.push(a[r].defaultValue.substring(6));for(var r in 0==s.length&&s.push(n),s)null!=stars[s[r]]&&(delete stars[s[r]],delete s[r]);var l=Object.keys(stars).length;for(var r in s)l<200&&null==stars[s[r]]&&(stars[s[r]]=1,l++);putstore("stars",JSON.stringify(stars)),updateDeviceViewDevice(n),3==Q("DevFilterSelect").value&&mainUpdate(1)}else 11==e?p10mstsc(n):12==e?p10rfb(n):13==e?p10ssh(n):14==e&&p10MCRouter(n,3)}function cmmeshaction(e){var t=contextelement.attributes.onclick.value.substring(10,contextelement.attributes.onclick.value.length-2),n=document.getElementsByClassName("DeviceCheckbox");if(1==e||2==e){for(var o=0;o<n.length;o++)n[o].attributes&&n[o].attributes.class.value.split(" ")[0]==t&&(n[o].checked=1==e);if(1==e)for(var o in nodes)nodes[o].meshid==t&&1==nodes[o].v&&(checkedNodeids[nodes[o]._id]=1);else if(2==e)for(var o in checkedNodeids){var i=getNodeFromId(o);null!=i&&i.meshid==t&&1==i.v&&delete checkedNodeids[o]}}p1updateInfo()}function cmconnectfilesaction(){connectFiles(null,1,32)}function cmtermaction(e,t){e<100?connectTerminal(null,1,{protocol:e,consent:t}):100==e&&connectTerminal(null,1,{protocol:1,requireLogin:!0,consent:t})}function cmdeskaction(e){1==e&&connectDesktop(null,3,null,72),2==e&&connectDesktop(null,3,null,8),3==e&&connectDesktop(null,3,null,64),10==e&&null!=desktop&&(desktop.sendCtrlMsg('{"ctrlChannel":"102938","type":"autolock","value":true}'),connectDesktop()),11==e&&null!=desktop&&(desktop.sendCtrlMsg('{"ctrlChannel":"102938","type":"autolock","value":false}'),connectDesktop())}function cmaltportaction(e){if(!xxdialogMode){setModalContent("xxAddAgent","Подключение RDP",'Порт RDP:<br /><br /><input type=text placeholder="3389" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10rdpport type=text>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){var e=Q("d10rdpport").value.length>0?parseInt(Q("d10rdpport").value):3389;meshserver.send({action:"changedevice",nodeid:currentNode._id,rdpport:e})}),Q("d10rdpport").focus(),null!=currentNode.rdpport&&(Q("d10rdpport").value=currentNode.rdpport)}}function cmsshportaction(e){if(!xxdialogMode){setModalContent("xxAddAgent","SSH соединение",'Порт удаленного подключения SSH:<br /><br /><input type=text placeholder="22" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10sshport type=text>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){var e=Q("d10sshport").value.length>0?parseInt(Q("d10sshport").value):22;meshserver.send({action:"changedevice",nodeid:currentNode._id,sshport:e})}),Q("d10sshport").focus(),null!=currentNode.sshport&&(Q("d10sshport").value=currentNode.sshport)}}function cmrfbportaction(e){if(!xxdialogMode){setModalContent("xxAddAgent","VNC соединение",'Порт удаленного подключения VNC:<br /><br /><input type=text placeholder="5900" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10rfbport type=text>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){var e=Q("d10rfbport").value.length>0?parseInt(Q("d10rfbport").value):3389;meshserver.send({action:"changedevice",nodeid:currentNode._id,rfbport:e})}),Q("d10rfbport").focus(),null!=currentNode.rfbport&&(Q("d10rfbport").value=currentNode.rfbport)}}function cmhttpportaction(e){if(!xxdialogMode){setModalContent("xxAddAgent","HTTP Connection",'HTTP remote connection port:<br /><br /><input type=text placeholder="80" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10httpport type=text>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){var e=Q("d10httpport").value.length>0?parseInt(Q("d10httpport").value):80;meshserver.send({action:"changedevice",nodeid:currentNode._id,httpport:e})}),Q("d10httpport").focus(),null!=currentNode.httpport&&(Q("d10httpport").value=currentNode.httpport)}}function cmhttpsportaction(e){if(!xxdialogMode){setModalContent("xxAddAgent","HTTPS Connection",'HTTPS remote connection port:<br /><br /><input type=text placeholder="443" inputmode="numeric" pattern="[0-9]*" onkeypress="return (event.keyCode == 8) || (event.charCode >= 48 && event.charCode <= 57)" maxlength=5 id=d10httpsport type=text>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){var e=Q("d10httpsport").value.length>0?parseInt(Q("d10httpsport").value):443;meshserver.send({action:"changedevice",nodeid:currentNode._id,httpsport:e})}),Q("d10httpsport").focus(),null!=currentNode.httpsport&&(Q("d10httpsport").value=currentNode.httpsport)}}function cmfilesaction(e){if(!xxdialogMode){var t=p13sort_files(p13filetree.dir)[parseInt(contextelement.attributes.fileindex.nodeValue)];1==e?(setModalContent("xxAddAgent","Переименовать",'<input type=text id=p13renameinput maxlength=64 onkeyup=p13fileNameCheck(event) style=width:100% value="'+t.n+'" />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13renamefileEx(3,{action:"rename",path:p13filetreelocation.join("/"),oldname:t.n})),focusTextBox("p13renameinput"),p13fileNameCheck()):2==e?t.s<=204800?p13downloadfile(encodeURIComponentEx(p13filetreelocation.join("/")+"/"+t.n),encodeURIComponentEx(t.n),t.s,"viewer"):messagebox("Редактор файлов","Редактировать можно только файлы размером менее 200КБ."):3==e&&(setModalContent("xxAddAgent","Удалить","Удалить пункт?"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13deletefileCm(3,t)))}}function cmexpandaction(e){if(1==e)CollapsedGroups={};else{if(0==sort){for(var t in CollapsedGroups={},meshes)CollapsedGroups[t]=!0;for(var t in nodes)null==meshes[nodes[t].meshid]&&(CollapsedGroups[nodes[t].meshid]=!0)}if(1==sort){CollapsedGroups={};for(t=0;t<10;t++)CollapsedGroups["pwr:"+t]=!0}if(3==sort)for(var t in CollapsedGroups={},nodes){if((o=nodes[t]).tags)for(var n in o.tags)CollapsedGroups["tag:"+encodeURIComponentEx(o.tags[n])]=!0}if(4==sort)for(var t in CollapsedGroups={},nodes){var o=nodes[t],i=meshes[o.meshid];if(i){if(CollapsedGroups["tag:"+encodeURIComponentEx(i.name)]=!0,o.tags)for(var n in o.tags)CollapsedGroups["tag:"+encodeURIComponentEx(i.name+" - "+o.tags[n])]=!0}else if(o.tags)for(var n in o.tags)CollapsedGroups["tag:"+encodeURIComponentEx("**INDV*~*DEVS** - "+o.tags[n])]=!0}}putstore("_collapse",JSON.stringify(CollapsedGroups)),updateCollapseAllButton(),mainUpdate(4)}function cmdeskplayeraction(e){xxdialogMode||safeNewWindow(window.location.origin+"{{{domainurl}}}player.htm"+(urlargs.key?"?key="+urlargs.key:""),"meshcentral-deskplayer")}function cmdeskshortcutaction(e){xxdialogMode||deskCustomizeKeys()}function cmdeskpreconfigtypeaction(e){xxdialogMode||(-1==e?deskCustomizeStrings():showDeskTypeEx(e<1e3?serverinfo.preConfiguredRemoteInput[e].value:deskKeyboardStrings[e-1e3].v))}function cmdeskpreconfigscriptaction(e){meshserver.send({action:"runcommands",nodeids:[currentNode._id],presetcmd:e})}function p13deletefileCm(e,t){files.sendText({action:"rm",reqid:1,path:p13filetreelocation.join("/"),delfiles:[t.n],rec:!1}),p13folderup(999)}function hideContextMenu(){QV("contextMenu",!1),QV("meshContextMenu",!1),QV("altPortContextMenu",!1),QV("rfbPortContextMenu",!1),QV("sshPortContextMenu",!1),QV("httpPortContextMenu",!1),QV("httpsPortContextMenu",!1),QV("filesContextMenu",!1),QV("deskPlayerContextMenu",!1),QV("deskKeyShortcutContextMenu",!1),QV("deskPreConfigShortcutContextMenu",!1),QV("deskPreConfigScriptContextMenu",!1),QV("expandAllContextMenu",!1),contextelement=null}var map_cm_popup,map_cm_editMarker,map_cm_clearMarker,map_cm_saveMarker,map_cm_nodemenu_items,contextmenu_items,currentNode,xxmap={map:null,contextmenu:null,activeInteractions:[],showindex:0,markersSource:null,markersLayer:null,mapLayer:null,mapView:null};function updateMapMarkers(e){if(32768&features){if(null!=xxmap&&null==xxmap.map)try{loadmap()}catch(e){console.error("loadmap() exception",e)}if(null!=xxmap){var t=null;for(var n in nodes)try{var o=map_parseNodeLoc(nodes[n]),i=xxmap.markersSource.getFeatureById(nodes[n]._id);if(null==o||nodes[n].meshid!=e&&null!=e)i&&xxmap.markersSource.removeFeature(i);else{var a=o[0],s=o[1];o[2];null==t?t=[a,s,a,s,0]:(a<t[0]&&(t[0]=a),s<t[1]&&(t[1]=s),a>t[2]&&(t[2]=a),s>t[3]&&(t[3]=s)),null==i?(addFeature(nodes[n]),t[4]=1):(updateFeature(nodes[n],i),i.setStyle(markerStyle(nodes[n],o[2])))}}catch(e){console.error("updateMapMarkers() exception",e,JSON.stringify(nodes[n]))}return t}}}function stringToIntHash(e){var t,n=0;for(t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return n}function map_parseNodeLoc(e){var t=null,n=0;return e.iploc&&(t=e.iploc,n=1),e.wifiloc&&(t=e.wifiloc,n=2),e.gpsloc&&(t=e.gpsloc,n=3),e.userloc&&(t=e.userloc,n=4),null==t||"string"!=typeof t?null:(t=t.split(","),1==n?[parseFloat(t[0])+stringToIntHash(e._id.substring(0,20))/1e11,parseFloat(t[1])+stringToIntHash(e._id.substring(20))/1e11,n]:[parseFloat(t[0]),parseFloat(t[1]),n])}function loadmap(){if(32768&features&&null!=xxmap)if(32768&features){QV("viewselectmapoption",!0),QV("devViewButton4",!0);try{xxmap.markersSource=new ol.source.Vector,xxmap.markersLayer=new ol.layer.Vector({source:xxmap.markersSource}),xxmap.mapLayer=new ol.layer.Tile({source:new ol.source.OSM}),xxmap.mapView=new ol.View({center:ol.proj.transform([0,0],"EPSG:4326","EPSG:3857"),zoom:2,minZoom:2,maxZoom:20,extent:ol.proj.transformExtent([-1e5,-69.55,1e5,69.55],"EPSG:4326","EPSG:3857")}),xxmap.map=new ol.Map({target:"xdevicesmap",layers:[xxmap.mapLayer,xxmap.markersLayer],view:xxmap.mapView}),xxmap.map.addOverlay(map_cm_popup),xxmap.map.on("click",function(e){var t=xxmap.map.forEachFeatureAtPixel(e.pixel,function(e,t){return e});if(t){var n=t.getId();if(null!=n)gotoDevice(n,10);else gotoDevice(getCorrespondingFeature(t).getId(),10)}}),xxmap.map.on("pointermove",function(e){var t=xxmap.map.forEachFeatureAtPixel(e.pixel,function(e,t){return e});if(t){xxmap.map.getTargetElement().style.cursor="pointer";var n=t.getGeometry().getCoordinates();if(map_cm_popup.setPosition(n),t.getId())QH("xmap-info-window",t.get("name"));else{var o=getCorrespondingFeature(t);QH("xmap-info-window",o.get("name"))}}else xxmap.map.getTargetElement().style.cursor="",QH("xmap-info-window","")});var e=new ContextMenu({width:160,defaultItems:!1,items:contextmenu_items});e.on("open",function(e){var t=xxmap.map.forEachFeatureAtPixel(e.pixel,function(e,t){return e});if(xxmap.contextmenu.clear(),t)if(t.getId())addContextMenuItems(t);else{var n=getCorrespondingFeature(t);n?addContextMenuItems(n):xxmap.contextmenu.extend(contextmenu_items)}else xxmap.contextmenu.extend(contextmenu_items)}),null==xxmap.contextmenu&&(xxmap.contextmenu=e),xxmap.map.addControl(xxmap.contextmenu)}catch(e){console.log(e),QV("viewselectmapoption",!1),QV("devViewButton4",!1),xxmap=null}}else xxmap=null}function addFeature(e,t,n){var o=getModifiedFeature(e._id);if(o)xxmap.markersSource.addFeature(o);else{if(!t&&!n){var i=map_parseNodeLoc(e);t=i[0],n=i[1]}if(n>180&&(n=180-n,meshserver.send({action:"changedevice",nodeid:e._id,userloc:[t,n]})),t<90&&t>-90&&n<180&&n>-180){var a=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([n,t],"EPSG:4326","EPSG:3857")),name:e.name,status:e.conn,lat:t,lon:n});a.setId(e._id),a.setStyle(markerStyle(e)),xxmap.markersSource.addFeature(a)}}}function removeFeature(e){var t=xxmap.markersSource.getFeatureById(e._id);t&&xxmap.markersSource.removeFeature(t)}function updateFeature(e,t){e.conn!=t.get("status")&&(t.set("status",e.conn),t.setStyle(markerStyle(e)));var n=map_parseNodeLoc(e);if(null!=n){var o=n[0],i=n[1];if(o!=t.get("lat")||i!=t.get("lon")){t.set("lat",o),t.set("lon",i);var a=ol.proj.transform([parseFloat(i),parseFloat(o)],"EPSG:4326","EPSG:3857");t.getGeometry().setCoordinates(a)}}e.name!=t.get("name")&&t.set("name",e.name)}function modifyMarkerloc(e){var t=e.getId();if(t&&(e.setStyle(markerStyle(getNodeFromId(e.a),4)),!getActiveInteractions(e))){var n=new ol.interaction.Modify({features:new ol.Collection([e]),pixelTolerance:10});xxmap.activeInteractions.push({featureid:t,feature:e,interaction:n}),xxmap.map.addInteraction(n)}}function saveMarkerloc(e){var t=e.getId();if(t){var n=getActiveInteractions(e);if(n){xxmap.map.removeInteraction(n),removeInteraction(t);var o=e.getGeometry().getCoordinates(),i=ol.proj.transform(o,"EPSG:3857","EPSG:4326");i[0]>180&&(i[0]=180-i[0]);var a=[i[1],i[0]];meshserver.send({action:"changedevice",nodeid:t,userloc:a})}}}function markerStyle(e,t){null==t&&(t=0,e.iploc&&(t=1),e.wifiloc&&(t=2),e.gpsloc&&(t=3),e.userloc&&(t=4));var n=connStateColor(e);return[new ol.style.Style({image:new ol.style.Icon({color:n,anchor:[.5,1],src:"images/mapmarker"+["","-ip","-wifi","-gps","-user"][t]+".png"})})]}function connStateColor(e){return 1==e.conn||3==e.conn||5==e.conn?"#00ffdd":"#C70039"}function addContextMenuItems(e){getActiveInteractions(e)?(map_cm_saveMarker.data=e,xxmap.contextmenu.push(map_cm_saveMarker)):(map_cm_editMarker.data=e,xxmap.contextmenu.push(map_cm_editMarker),getNodeFromId(e.a).userloc&&(map_cm_clearMarker.data=e,xxmap.contextmenu.push(map_cm_clearMarker)));map_cm_nodemenu_items.forEach(function(t){"Масштабирование +"==t.text||"Масштабирование -"==t.text?t.data=e:"-"!=t&&(t.data=e.getId())}),xxmap.contextmenu.extend(map_cm_nodemenu_items)}function getActiveInteractions(e){for(var t=e.getId(),n=0;n<xxmap.activeInteractions.length;n++)if(xxmap.activeInteractions[n].featureid==t)return xxmap.activeInteractions[n].interaction;return!1}function getModifiedFeature(e){if(e)for(var t=0;t<xxmap.activeInteractions.length;t++)if(xxmap.activeInteractions[t].featureid==e)return xxmap.activeInteractions[t].feature;return null}function removeInteraction(e){for(var t=-1,n=0;n<xxmap.activeInteractions.length;n++)if(xxmap.activeInteractions[n].featureid===e){t=n;break}t>=0&&xxmap.activeInteractions.splice(t,1)}function getCorrespondingFeature(e){for(var t=e.getGeometry().getCoordinates(),n=0;n<xxmap.activeInteractions.length;n++){var o=xxmap.activeInteractions[n].feature,i=o.getGeometry().getCoordinates();if(i[0].toFixed(5)==t[0].toFixed(5)&&i[1].toFixed(5)==t[1].toFixed(5))return o}return null}function refreshMap(e,t){e&&(xxmap.map.setTarget(null),xxmap.map=null,xxmap.markersSource=null,xxmap.mapView=null,xxmap.mapLayer=null,xxmap.activeInteractions=[]);var n=updateMapMarkers();if(null!=n&&(t||1==n[4])){var o=(n[0]+n[2])/2,i=(n[1]+n[3])/2,a=Math.max(Math.abs(n[0]-n[2]),Math.abs(n[1]-n[3])),s=xxmap.map.getView();s.setCenter(ol.proj.transform([i,o],"EPSG:4326","EPSG:3857"));for(var r=360,l=-2;r>a;)l++,r/=2;s.setZoom(l)}}function placeNode(e){if(!xxdialogMode){var t='<div style=margin-bottom:6px><label for=selectnode-search>Поиск</label>&nbsp&nbsp<input type=text placeholder="Имя устройства" id="selectnode-search" onchange=onPlaceNodeInputChange() onkeyup=onPlaceNodeInputChange() autocomplete=off style=width:120px></div><div id=placenode style="height:254px;overflow-y:auto;width:100%;margin:12px 1px 4px 1px;"><div id=noNodesMapPlace style=text-align:center;width:100%;display:none>Устройства не найдены.</div>';for(var n in nodes)t+="<div class=noselect id="+nodes[n]._id+"-rowid onclick=selectNodeToPlace(event,'"+nodes[n]._id+"') style=background-color:lightgray;margin-bottom:4px;border-radius:2px><input name=PlaceMapDeviceCheckbox id="+nodes[n]._id+'-checkid type=checkbox class="form-check-input me-2" style=width:16px;display:inline />',t+="<div class=j"+nodes[n].icon+" style=width:16px;height:16px;margin-top:2px;margin-right:4px;display:inline-block></div><div style=width:16px;display:inline>"+nodes[n].name+"</div></div>";setModalContent("xxAddAgent","Выберите узел для размещения",t+"</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>placeNodeEx(3,e)),onPlaceNodeInputChange()}}function placeNodeEx(e,t){var n=document.getElementsByName("PlaceMapDeviceCheckbox");for(var o in n)if(n[o].checked){var i=getNodeFromId(n[o].id.substring(0,n[o].id.length-8));if(i){var a=xxmap.markersSource.getFeatureById(o),s=ol.proj.transform(t,"EPSG:3857","EPSG:4326"),r=[s[1],s[0]];if(a)a.getGeometry().setCoordinates(t),getActiveInteractions(a)?saveMarkerloc(a):meshserver.send({action:"changedevice",nodeid:i._id,userloc:r});else meshserver.send({action:"changedevice",nodeid:i._id,userloc:r})}}}function onPlaceNodeInputChange(){updatePlaceNodeTable(Q("selectnode-search").value.trim().toLowerCase())}function updatePlaceNodeTable(e){document.getElementsByName("PlaceMapDeviceCheckbox");var t=0;for(var n in nodes){var o=nodes[n].namel.indexOf(e)>=0||""==e||null!=nodes[n].rnamel&&nodes[n].rnamel.indexOf(e)>=0;o&&t++,QV(nodes[n]._id+"-rowid",o)}QV("noNodesMapPlace",0==t)}function selectNodeToPlace(e,t){if("PlaceMapDeviceCheckbox"!=e.target.name){var n=Q(t+"-checkid");n.checked=!n.checked}var o=document.getElementsByName("PlaceMapDeviceCheckbox"),i=0;for(var a in o)o[a].checked&&i++;QE("idx_dlgOkButton",i>0)}function addMeshOptions(e,t){}function meshOptionRmvMod(e,t){}function meshExists(){for(var e in meshes)if(meshes[e])return!0;return!1}function setMeshView(e){var t=Q("select-mesh");t[t.selectedIndex].value==e&&(t[0].selected=!0,onSelectMeshChange())}function clearMeshOptions(){}function getSearchLocation(){try{var e=Q("mapSearchLocation").value.trim();if(e.length>0){var t=new XMLHttpRequest;t.onreadystatechange=function(){4==t.readyState&&200==t.status&&formatSearchData(t.responseText)},t.open("GET","https://nominatim.openstreetmap.org/search?q="+e+"&format=json",!0),t.send()}}catch(e){}}function formatSearchData(e){try{QH("xmapSearchResults","");for(var t=JSON.parse(e),n=0,o='<div class="xmapItem">',i=0;i<t.length;i++)if(t[i].display_name&&t[i].boundingbox[0]&&t[i].boundingbox[1]&&t[i].boundingbox[2]&&t[i].boundingbox[3]){n++;o+='<div class="xmapItemSel1" onclick=mapGotoSelectedLocation(this)><div>'+t[i].display_name+"</div><div style=display:none>"+t[i].boundingbox[0]+"!#!"+t[i].boundingbox[1]+"!#!"+t[i].boundingbox[2]+"!#!"+t[i].boundingbox[3]+"</div></div>"}if(o+="</div>",1==n)zoomToExtent([parseFloat(t[0].boundingbox[2]),parseFloat(t[0].boundingbox[0]),parseFloat(t[0].boundingbox[3]),parseFloat(t[0].boundingbox[1])]);else 0==n&&(o="<div style=width:200px>Местоположение не найдено.<div>"),QV("xmapSearchResultsDlg",!0);QH("xmapSearchResults",o)}catch(e){}}function mapGotoSelectedLocation(e){var t=e.children[1].innerHTML.split("!#!");zoomToExtent([parseFloat(t[2]),parseFloat(t[0]),parseFloat(t[3]),parseFloat(t[1])]),mapCloseSearchWindow()}function mapCloseSearchWindow(){QH("xmapSearchResults",""),QV("xmapSearchResultsDlg",!1)}function zoomToLocation(e,t){var n=xxmap.map.getView();n.setCenter(e),n.setZoom(t)}function zoomToFitExtent(){if(xxmap.markersSource.getFeatures().length>0){var e=xxmap.markersSource.getExtent();xxmap.map.getView().fit(e,xxmap.map.getSize())}}function zoomToExtent(e){var t=ol.proj.transformExtent(e,ol.proj.get("EPSG:4326"),ol.proj.get("EPSG:3857"));xxmap.map.getView().fit(t,xxmap.map.getSize())}function refreshDevice(e){currentNode&&currentNode._id==e&&gotoDevice(e,xxcurrentView,!0)}32768&features&&(map_cm_popup=new ol.Overlay({element:Q("xmap-info-window"),positioning:"bottom-center",stopEvent:!1}),map_cm_editMarker={text:"Изменить позицию узла",callback:function(e){modifyMarkerloc(e.data)}},map_cm_clearMarker={text:"Удалить местоположение узла",callback:function(e){meshserver.send({action:"changedevice",nodeid:e.data.a,userloc:[]})}},map_cm_saveMarker={text:"Сохранить расположение узла",callback:function(e){saveMarkerloc(e.data)}},map_cm_nodemenu_items=[{text:"Общая информация",callback:function(e){null!=e.data&&gotoDevice(e.data,10)}},{text:"Рабочий стол",callback:function(e){null!=e.data&&gotoDevice(e.data,11)}},{text:"Терминал",callback:function(e){null!=e.data&&gotoDevice(e.data,12)}},{text:"Intel&reg; AMT",callback:function(e){null!=e.data&&gotoDevice(e.data,14)}},"-",{text:"Масштабирование +",callback:function(e){zoomToLocation(e.data.getGeometry().getCoordinates(),19)}},{text:"Масштабирование -",callback:function(e){zoomToLocation(e.data.getGeometry().getCoordinates(),2)}}],contextmenu_items=[{text:"Обновить",callback:function(){refreshMap(!0,!0)}},{text:"Масштабирование по размеру",callback:function(){zoomToFitExtent()}},{text:"Установить центр карты здесь",callback:function(e){xxmap.mapView.animate({center:e.coordinate})}},{text:"Поместить узел сюда",callback:function(e){placeNode(e.coordinate)}}]);var powerTimelineNode=null,powerTimelineReq=null,powerTimelineUpdate=null,powerTimeline=null,deviceSharesNode=null,deviceSharesReq=null,deviceShares=null;function getCurrentNode(){return currentNode}function gotoDevice(e,t,n,o){if(!o||3!=o.which&&2!=o.button){if(!0!==userinfo.emailVerified&&1==serverinfo.emailcheck&&4294967295!=userinfo.siteadmin)return setModalContent("xxAddAgent","Безопасность учетной записи",'Невозможно получить доступ к этой функции, пока адрес электронной почты не будет проверен. Это необходимо для восстановления пароля. Перейдите на вкладку "Моя учетная запись", чтобы изменить и подтвердить адрес электронной почты.'),void showModal("xxAddAgentModal","idx_dlgOkButton");if(262144&features&&0==count2factoraAuths())return setModalContent("xxAddAgent","Безопасность учетной записи",'Невозможно получить доступ к этой функции, пока не будет включена двухфакторная аутентификация. Это необходимо для дополнительной безопасности. Перейдите на вкладку "Моя учетная запись" и посмотрите раздел "Безопасность учетной записи".'),void showModal("xxAddAgentModal","idx_dlgOkButton");if(!o||1!=o.shiftKey&&2!=o.which&&1!=o.button){var i=getNodeFromId(e);if(null!=i){null!=currentNode&&currentNode._id==i._id&&1&i.conn||deviceDetailsStatsClear();var a=meshes[i.meshid],s=GetNodeRights(i),r=null==currentNode||currentNode._id!=e;if(!currentNode||currentNode._id!=i._id||1==n){if(currentNode=i,QV("deskPreConfigScriptContextMenu1",2==currentNode.mtype&&isWindowsNode(currentNode)),QV("deskPreConfigScriptContextMenu2",2==currentNode.mtype&&!isWindowsNode(currentNode)),QV("p10deviceNotify",null!=currentNode.sessions&&(null!=currentNode.sessions.kvm||null!=currentNode.sessions.terminal||null!=currentNode.sessions.files||null!=currentNode.sessions.tcp||null!=currentNode.sessions.udp)),QV("p10deviceStar",1==stars[currentNode._id]),QV("p10deviceHelp",null!=currentNode.sessions&&null!=currentNode.sessions.help),null!=currentNode.sessions&&null!=currentNode.sessions.msg?(QV("p10deviceMsg",!0),QH("p10deviceMsg",Object.keys(currentNode.sessions.msg).length)):QV("p10deviceMsg",!1),QV("p10deviceBattery",!1),null!=currentNode.sessions&&null!=currentNode.sessions.battery){var l=currentNode.sessions.battery,d="";"ac"==l.state&&(d="Устройство подключено"),"dc"==l.state&&(d="Устройство работает от аккумулятора");var c="",u=-1;"number"==typeof l.level&&l.level>=0&&l.level<=100&&(c=l.level+"%",(u=Math.floor((l.level+10)/25)+1)>5&&(lvl=5),"ac"==l.state&&(100==l.level?u=11:u+=5)),u>0&&(Q("p10deviceBattery").title=null!=d?d+", "+c:c,QV("p10deviceBattery",!0),Q("p10deviceBattery").className="deviceBatteryLarge deviceBatteryLarge"+u)}else QV("p10deviceBattery",!1);var p,m=EscapeHtml(i.name);0==m.length&&(m="<i>Пусто</i>"),4&s&&(!a.flags||!(2&a.flags)||16&a.flags)&&(m='<span tabindex=0 title="Для изменения имени устройства на сервере нажмите сюда" onclick=showEditNodeValueDialog(0) onkeyup="if (event.key == \'Enter\') showEditNodeValueDialog(0)" role="button">'+m+' <i class="fa-solid fa-pencil fa-2xs"/></i></span>'),p=m,a&&(m+="<span style=color:#AAA;font-size:small> - "+EscapeHtml(a.name)+"</span>"),QH("p10deviceName",m),QH("p11deviceName",m),QH("p12deviceName",m),QH("p13deviceName",m),QH("p14deviceName",m),QH("p15deviceName","Консоль - "+m),QH("p16deviceName",m),QH("p17deviceName",m),QH("p19deviceName",m);var g="<table style=width:100%>";8&args.hide&&(g+="<br />"+addDeviceAttribute("Имя",p)),a&&(g+=addDeviceAttribute('<span title="Имя группы устройств, к которой принадлежит этот компьютер.">Группа</span>','<a href=# title="Имя группы устройств, к которой принадлежит этот компьютер" onclick=gotoMesh("'+i.meshid+'") style=cursor:pointer>'+EscapeHtml(meshes[i.meshid].name)+"</a>")),null!=i.rname&&i.name!=i.rname&&(g+=addDeviceAttribute('<span title="Имя этого компьютера, указанное в операционной системе">Имя из ОС</span>','<span title="Имя этого компьютера, указанное в операционной системе">'+EscapeHtml(i.rname)+"</span>")),(1&features||4==i.mtype)&&3!=i.mtype||(g+=addDeviceAttribute("Имя хоста",addLinkConditional(i.host?EscapeHtml(i.host):"<i>Пусто</i>","showEditNodeValueDialog(1)",4&s)));var v=i.desc?EscapeHtml(i.desc):"<i>Пусто</i>";if(g+=addDeviceAttribute("Описание",4&s?"<span onclick=showEditNodeValueDialog(2) style=cursor:pointer>"+v+' <i class="fa-solid fa-pencil fa-xs" role="button"></i></span>':v),4==i.mtype&&(null!=i.portnum&&(g+=addDeviceAttribute("Номер порта",i.portnum)),null!=i.porttype&&(g+=addDeviceAttribute("Тип порта",i.porttype))),null!=i.agent&&null!=i.agent.id&&3==i.mtype)4==i.agent.id&&(g+=addDeviceAttribute("Тип устройства","Windows")),6==i.agent.id&&(g+=addDeviceAttribute("Тип устройства","Linux")),29==i.agent.id&&(g+=addDeviceAttribute("Тип устройства","macOS"));else if(null!=i.agent&&null!=i.agent.id&&null!=i.agent.ver){var h="";h=i.agent.id<=agentsStr.length?agentsStr[i.agent.id]:agentsStr[0],0!=i.agent.ver&&(h+=" v"+i.agent.ver),14==i.agent.id&&(h=i.agent.core),!1===i.agent.root&&1&i.conn&&(h+=", Ограниченный"),g+=addDeviceAttribute("Mesh Agent",h)}if(null!=i.intelamt){h="";var f={0:nobreak("Не активированно (Pre)"),1:nobreak("Не активированно (In)"),2:nobreak("Активировано")};if(null!=i.intelamt.ver&&null==i.intelamt.state?h+="<i>Состояние неизвестно</i>, v"+EscapeHtml(i.intelamt.ver):null==i.intelamt.ver&&2==i.intelamt.state?h+="<i>Активировано</i>":null==i.intelamt.ver||null==i.intelamt.state?h+="<i>Версия и состояние неизвестны</i>":(h+=f[i.intelamt.state],2==i.intelamt.state&&i.intelamt.flags&&(2&i.intelamt.flags?h+=' <span title="Intel&reg; AMT активирован в режиме клиента">CCM</span>':4&i.intelamt.flags&&(h+=' <span title="Intel&reg; AMT активирован в режиме администратора">ACM</span>')),h+=", v"+EscapeHtml(i.intelamt.ver)),2==i.intelamt.state){1==i.intelamt.tls&&(h+=', <span title="Intel&reg; AMT настроен с TLS безопасностью сети">TLS</span>');var x=!1;if(null==i.intelamt.user||""==i.intelamt.user)4&s?(h+=', <i style=color:#FF0000;cursor:pointer title="Редактировать учетные данные Intel&reg; AMT" onclick=editDeviceAmtSettings("'+i._id+'")>Учетных данных нет</i>',x=!0):h+=", <i style=color:#FF0000>Учетных данных нет</i>";else if(1&features2&&null!=i.intelamt.warn){var k=null;1&i.intelamt.warn&&(k="Неверные учетные данные"),8&i.intelamt.warn&&(k="Проверка учетных данных"),null!=k&&(4&s?(h+=', <i style=color:#FF0000;cursor:pointer title="Редактировать учетные данные Intel&reg; AMT" onclick=editDeviceAmtSettings("'+i._id+'")>'+k+"</i>",x=!0):h+=", <i style=color:#FF0000>"+k+"</i>")}4&s&&!(1&features2)&&(x=!0),h+=" ",x&&(h+='<img src=images/link4.png height=10 width=10 title="Редактировать учетные данные Intel&reg; AMT" style=cursor:pointer onclick=editDeviceAmtSettings("'+i._id+'")>')}var y='<span title="Intel&reg; Manageability Engine">Intel&reg; ME<span>';"number"==typeof i.intelamt.sku&&(8&i.intelamt.sku?y='<span title="Технология Intel&reg; Active Management">Intel&reg; AMT<span>':16&i.intelamt.sku&&(y='<span title="Intel&reg; Standard Manageability">Intel&reg; SM<span>')),g+=addDeviceAttribute(y,h)}if(null!=i.agent&&null!=i.agent.tag)(b=EscapeHtml(i.agent.tag)).startsWith("mailto:")&&(b='<a href="'+EscapeHtml(b)+'">'+EscapeHtml(b.substring(7))+"</a>"),g+=addDeviceAttribute("Тег агента",b);else if(null!=i.intelamt&&null!=i.intelamt.tag){var b;(b=EscapeHtml(i.intelamt.tag)).startsWith("mailto:")&&(b='<a href="'+EscapeHtml(b)+'">'+EscapeHtml(b.substring(7))+"</a>"),g+=addDeviceAttribute("Intel&reg; AMT Тег",b)}if(i.osdesc&&(g+=addDeviceAttribute("Операционная система",i.osdesc)),i.wsc){var w=[];null!=i.wsc.antiVirus&&("OK"==i.wsc.antiVirus?w.push("Антивирус - <span style=color:green>OK</span>"):w.push("Антивирус - <span style=color:red>BAD</span>")),null!=i.wsc.autoUpdate&&("OK"==i.wsc.autoUpdate?w.push("Обновить - <span style=color:green>OK</span>"):w.push("Обновить - <span style=color:red>BAD</span>")),null!=i.wsc.firewall&&("OK"==i.wsc.firewall?w.push("Брандмауэр - <span style=color:green>OK</span>"):w.push("Брандмауэр - <span style=color:red>BAD</span>")),g+=addDeviceAttribute("Безопасность Windows",w.join(", "))}if(i.defender){w=[];null!=i.defender.RealTimeProtection&&(1==i.defender.RealTimeProtection?w.push("RealTimeProtection - <span style=color:green>On</span>"):w.push("RealTimeProtection - <span style=color:red>Выключено</span>")),null!=i.defender.TamperProtected&&(1==i.defender.TamperProtected?w.push("TamperProtection - <span style=color:green>On</span>"):w.push("TamperProtection - <span style=color:red>Выключено</span>")),w.length>0&&(g+=addDeviceAttribute("Windows Defender",w.join(", ")))}if(i.av&&i.av.length>0){w=[];for(var M in i.av)if(i.av[M].product){var C=EscapeHtml(i.av[M].product);!0!==i.av[M].enabled&&(C+=" - <span style=color:red>Отключено</span>"),!0!==i.av[M].updated&&(C+=" - <span style=color:red>Устаревший</span>"),1==i.av[M].enabled&&1==i.av[M].updated&&(C+=" - <span style=color:green>OK</span>"),w.push(C)}g+=addDeviceAttribute("Антивирус",w.join("<br />"))}if(i.users&&i.users.length>0){var S=i.users.map(function(e){return addKeyLinkConditional(EscapeHtml(e),"Заблокирован",i.lusers&&i.lusers.indexOf(e)>=0)}).join(", ");g+=addDeviceAttribute(i.users.length>1?"Активные пользователи":"Активный пользователь",S)}if(null!=i.agent&&14!=i.agent.id&&3!=i.mtype){var A=[],D=0;i.consent&&(D=i.consent),serverinfo.consent&&(D|=serverinfo.consent),64&D&&8&D?A.push("Рабочий стол: запросить + панель-уведомление"):64&D?A.push("Панель-уведомление на экране"):8&D?A.push("Рабочий стол: запросить"):1&D&&A.push("Рабочий стол: уведомить"),16&D?A.push("Терминал: запросить"):2&D&&A.push("Терминал: уведомить"),32&D?A.push("Файлы: запросить"):4&D&&A.push("Файлы: уведомить"),7==D&&(A=["Всегда уведомлять"]),56&~D||(A=["Всегда запрашивать"]),""==(A=A.join(", "))&&(A="<i>Пусто</i>"),g+=addDeviceAttribute("Согласие пользователя",addLinkConditional(A,"p20editmeshconsent(3)",1&s))}var T=[];if(null!=userinfo.notify&&null!=userinfo.notify[i._id]){var E=userinfo.notify[i._id];if(2&E&&T.push("Подключиться"),4&E&&T.push("Разъединить"),null!=i.intelamt&&8&E&&T.push("Intel&reg; AMT"),16384&features2&&userinfo.emailVerified){var _=0;16&E&&_++,32&E&&_++,64&E&&_++,_>0&&T.push(format("Email ({0})",_))}if(null!=userinfo.msghandle&&33554432&features2){_=0;128&E&&_++,256&E&&_++,512&E&&_++,_>0&&T.push(format("Messaging ({0})",_))}}""==(T=T.join(", "))&&(T="<i>Пусто</i>"),g+=addDeviceAttribute("Уведомления",addLink(T,"p20editDeviceNotify()"));var N=i.conn;if(N&&N>1){var I=[];1&i.conn&&I.push('<span title="Mesh Agent подключен и готов к использованию.">Mesh Agent</span>'),2&i.conn?I.push('<span title="Intel&reg; AMT CIRA подключен и готов к использованию.">Intel&reg; AMT CIRA</span>'):4&i.conn&&I.push('<span title="Intel&reg; AMT маршрутизируется и готов к использованию.">Intel&reg; AMT</span>'),8&i.conn&&I.push('<span title="Mesh Agent доступен с использованием другого агента в качестве ретранслятора.">Mesh Ретранслятор</span>'),16&i.conn&&I.push('<span title="MQTT подключение к устройству активно.">MQTT</span>'),g+=addDeviceAttribute("Соединение",I.join(", "))}var V="<i>Пусто</i>";if(null!=i.tags)for(var M in V="",i.tags)V+="<span class=tagSpan>"+EscapeHtml(i.tags[M])+"</span> ";if(g+=addDeviceAttribute("Теги",4&s?"<span onclick=showEditNodeValueDialog(3) style=line-height:26px;cursor:pointer>"+V+' <i class="fa-solid fa-pencil fa-xs" role="button"></i></span>':"<span style=line-height:26px>"+V+"</span>"),null!=i.ssh||null!=i.rdp){w=[];4&s?(null!=i.ssh&&w.push("<span onclick=showClearSshDialog(3) style=cursor:pointer>"+(1==i.ssh?"SSH-Пользователь+Пароль":2==i.ssh?"SSH-Пользователь+Ключ+Пароль":"SSH-Пользователь+Ключ")+' <i class="fa-solid fa-pencil fa-xs" role="button"></i></span>'),null!=i.rdp&&w.push('<span onclick=showClearRdpDialog(3) style=cursor:pointer>RDP <i class="fa-solid fa-pencil fa-xs" role="button"></i></span>')):(null!=i.ssh&&w.push(1==i.ssh?"SSH-Пользователь+Пароль":2==i.ssh?"SSH-Пользователь+Ключ+Пароль":"SSH-Пользователь+Ключ"),null!=i.rdp&&w.push("RDP")),g+=addDeviceAttribute("Учетные данные",w.join(", "))}var U=[];for(var M in meshes)meshes[M].relayid==i._id&&U.push('<a href=# onclick=gotoMesh("'+meshes[M]._id+'") style=cursor:pointer>'+EscapeHtml(meshes[M].name)+"</a>");if(U.length>0&&(g+=addDeviceAttribute('<span title="Группы устройств, для которых это устройство является релеем">Ретранслятор для</span>',U.join(", "))),g+="</table><br />",262220&s&&i.mtype<3&&(null==i.agent||34!=i.agent.id)&&(g+='<input type=button class="btn btn-primary btn-sm me-2" value="Действия" title="Управление питанием устройства" onclick=deviceActionFunction() />'),g+='<input type=button class="btn btn-primary btn-sm me-2" value="Примечания" title="Посмотреть примечания этого устройства" onclick=showNotes('+!(128&s)+',"'+encodeURIComponentEx(i._id)+'") />',g+='<input type=button class="btn btn-primary btn-sm me-2" value="Добавить событие" title="Записать событие к этому устройству" onclick=writeDeviceEvent("'+encodeURIComponentEx(i._id)+'") />',2==i.mtype&&1&N&&131072&s&&(g+='<input type=button class="btn btn-primary btn-sm me-2" cmenu=deskPreConfigScriptContextMenu value="Run" title="Выполнить команды на этом устройстве." onclick=runDeviceCmd("'+encodeURIComponentEx(i._id)+'") />'),4!=i.mtype){if((8&s&&1&N&&16384&s||1==i.pmt&&2&features2)&&(g+='<input type=button class="btn btn-primary btn-sm me-2" value="Сообщение" title="Показать текстовое сообщение на удаленном устройстве" onclick=deviceMessageFunction() />'),(8&s&&1&N&&16384&s||1==i.pmt&&2&features2)&&(g+='<input type=button class="btn btn-primary btn-sm me-2" value="Чат" title="Открыть окно чата на этом компьютере" onclick=deviceChat(event) />'),null!=serverinfo&&null!=serverinfo.altmessenging&&8&s&&1&N)for(var M in serverinfo.altmessenging){var R=serverinfo.altmessenging[M];null!=R.type&&"device"!=R.type||(g+='<input type=button class="btn btn-primary btn-sm me-2" value="'+EscapeHtml(serverinfo.altmessenging[M].name)+'" onclick=altDeviceChat(event,'+M+") />")}!(!1!==serverinfo.guestdevicesharing&&null!=i.agent&&3&i.agent.caps&&1&N)||524296&~s||4294967295!=s&&4096&s?QV("DeskGuestShareButton",!1):(g+='<input type=button class="btn btn-primary btn-sm me-2" value="Поделиться" title="Создайте ссылку, чтобы поделиться этим устройством с гостем" onclick=showShareDevice() />',QV("DeskGuestShareButton",!0))}if(4==i.mtype&&1&N&&("PDU"==i.porttype?1==i.pwr?262144&s&&(g+='<input type=button class="btn btn-primary btn-sm me-2" value="Выключить" title="Выключить" onclick=setIpPduState(0) />'):8==i.pwr&&64&s&&(g+='<input type=button class="btn btn-primary btn-sm me-2" value="Включить" title="Включить" onclick=setIpPduState(1) />'):8&s&&(g+='<input type=button class="btn btn-primary btn-sm me-2" value="Удаленное управление" title="Удаленное управление" onclick=openIpKvmRemoteControl("'+encodeURIComponentEx(i._id)+'") />')),null!=customui&&null!=customui.devicebuttons)for(var M in customui.devicebuttons)(null==customui.devicebuttons[M].showif||null!=a&&customui.devicebuttons[M].showif==a._id||customui.devicebuttons[M].showif==currentNode._id)&&(g+='<input id="cui:'+M+'" type="button" class="btn btn-primary btn-sm me-2" value="'+customui.devicebuttons[M].name+'" onclick=customUIAction(event,"devicebuttons") />');QH("p10html",g),mainUpdate(256);var H=4294967295==s||!(65536&s),F=4294967295==s||!(512&s),B=4294967295==s||!(1024&s),O=4294967295==s||!(2048&s);if(g='<div class="p10html3right">',1&s&&4!=i.mtype&&(g+='&nbsp;<a href=# onclick=p10showChangeGroupDialog(["'+i._id+'"]) title="Переместить это устройство в другую группу устройств">Смена группы</a>'),32768&s&&(g+='&nbsp;<a href=# onclick=p10showDeleteNodeDialog("'+i._id+'") title="Удалить это устройство">Удалить устройство</a>'),g+='</div><div class="p10html3left">',i.agent&&3!=i.mtype&&1048576&s&&(g+='<a href=# onclick=p10showNodeNetInfoDialog("'+i._id+'") title="Показать информацию о сетевом интерфейсе устройства">Интерфейсы</a>&nbsp;'),32768&features&&null!=xxmap&&(g+='<a href=# onclick=p10showNodeLocationDialog("'+i._id+'") title="Показать информацию о расположении устройства">Местонахождение</a>&nbsp;'),null==i.agent||14!=i.agent.id&&34!=i.agent.id){if(4294967295!=userinfo.siteadmin&&128&userinfo.siteadmin||F&&8&s&&null!=i.agent&&14!=i.agent.id&&(g+='<a href=# onclick=p10showMeshCmdDialog(1,"'+i._id+'") title="Router используется для подключения к различным портам устройства через этот сервер.">MeshCmd</a>&nbsp;'),!(0===args.xterm&&i.agent&&2&i.agent.caps&&8&s)||4294967295!=s&&512&s||(g+='<a href=# onclick=p10openxterm(event,"'+i._id+'") title="Открыть терминал XTerm">XTerm</a>&nbsp;'),(1&N||3==i.mtype)&&i.agent&&8&s&&(0!=webRelayPort&&(g+='<a href=# cmenu=httpPortContextMenu onclick=p10WebRouter("'+i._id+'",1,'+(i.httpport?i.httpport:80)+")>HTTP"+(i.httpport&&80!=i.httpport?"/"+i.httpport:"")+"</a>&nbsp;",g+='<a href=# cmenu=httpsPortContextMenu onclick=p10WebRouter("'+i._id+'",2,'+(i.httpsport?i.httpsport:443)+")>HTTPS"+(i.httpsport&&443!=i.httpsport?"/"+i.httpsport:"")+"</a>&nbsp;"),i.agent.id>0&&i.agent.id<5&&"win32"==navigator.platform.toLowerCase()&&(null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.rdp||(g+='<a href=# cmenu=altPortContextMenu id=rdpMCRouterLink onclick=p10MCRouter("'+i._id+'",3) title="Требуется установка MeshCentral Router.">RDP'+(i.rdpport&&3389!=i.rdpport?"/"+i.rdpport:"")+"</a>&nbsp;")),i.agent.id>4&&("win32"!=navigator.platform.toLowerCase()&&"macintel"!=navigator.platform.toLowerCase()||null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.ssh||(g+='<a href=# cmenu=sshPortContextMenu onclick=p10MCRouter("'+i._id+'",4,'+(i.sshport?i.sshport:22)+') title="Требуется установка MeshCentral Router.">SSH'+(i.sshport&&22!=i.sshport?"/"+i.sshport:"")+"</a>&nbsp;"),"win32"==navigator.platform.toLowerCase()&&(null!=serverinfo.devicemeshrouterlinks&&0==serverinfo.devicemeshrouterlinks.scp||(g+='<a href=# cmenu=sshPortContextMenu onclick=p10MCRouter("'+i._id+'",5,'+(i.sshport?i.sshport:22)+') title="Требуется установка MeshCentral Router.">SCP'+(i.sshport&&22!=i.sshport?"/"+i.sshport:"")+"</a>&nbsp;"))),("win32"==navigator.platform.toLowerCase()||"macintel"==navigator.platform.toLowerCase())&&null!=serverinfo.devicemeshrouterlinks&&Array.isArray(serverinfo.devicemeshrouterlinks.extralinks)))for(var M in serverinfo.devicemeshrouterlinks.extralinks){var P=serverinfo.devicemeshrouterlinks.extralinks[M],L='"'+P.protocol+'"';if(doesDeviceMatchFilterTags(i,P.filter)){if("number"==typeof P.protocol?L=P.protocol:"http"==P.protocol?L=1:"https"==P.protocol?L=2:"rdp"==P.protocol?L=3:"ssh"==P.protocol?L=4:"scp"==P.protocol?L=5:"mcrdesktop"==P.protocol?L=6:"mcrfiles"==P.protocol&&(L=7),(6==L||7==L)&&2!=i.mtype)continue;g+='<a href=# onclick=p10MCRouter("'+i._id+'",'+L+","+P.port+(P.ip?',"'+P.ip+'"':",null")+","+(P.localport?P.localport:0)+') title="Требуется установка MeshCentral Router.">'+P.name+"</a>&nbsp;"}}(1&N||3==i.mtype)&&i.agent&&8&s&&!(536870912&features)&&(g+='<a href=# cmenu=rfbPortContextMenu id=rfbLink onclick=p10rfb("'+i._id+'") title="Запустить веб-сеанс VNC на этом устройстве.">Web-VNC</a>&nbsp;'),(1&N||3==i.mtype)&&i.agent&&8&s&&!(1073741824&features)&&(g+='<a href=# cmenu=altPortContextMenu id=mstscLink onclick=p10mstsc("'+i._id+'") title="Запустить веб-сеанс RDP на это устройство.">Web-RDP</a>&nbsp;'),512&features2&&(1&N||3==i.mtype)&&i.agent&&8&s&&(g+='<a href=# cmenu=sshPortContextMenu id=sshLink onclick=p10ssh("'+i._id+'") title="Запустить веб-сеанс SSH на это устройство.">Web-SSH</a>&nbsp;'),4294967295==s&&4194304&features&&(g+='<a href=# onclick=p10showMqttLoginDialog("'+i._id+'") title="Получить учетные данные MQTT для этого устройства.">MQTT Вход</a>&nbsp;')}g+="</div><br>",3==i.mtype?(QH("p10html3",""),QH("p10html5",g)):(QH("p10html3",g),QH("p10html5",""));var z=PowerStateStr(i.state),W="";null!=i.agent&&!1===i.agent.root&&(W=', <span title="Агент работает на удаленном устройстве с ограниченными правами.">Ограниченный</span>'),1&N&&(z.length>0&&(z+="<br/>"),4==i.mtype?"PDU"==i.porttype?z+='<span style=font-size:12px title="Порт свитча подключен">Порт свитча подключен</span>'+W:z+='<span style=font-size:12px title="Порт IP-KVM подключен">Порт IP-KVM подключен</span>'+W:z+='<span style=font-size:12px title="Агент подключен">Агент подключен</span>'+W),2&N?(z.length>0&&(z+="<br/>"),z+='<span style=font-size:12px title="Intel&reg; AMT подключен">Intel&reg; AMT подключен</span>'):4&N&&(z.length>0&&(z+="<br/>"),z+='<span style=font-size:12px title="Intel&reg; AMT обнаружен">Intel&reg; AMT обнаружен</span>'),16&N&&(z.length>0&&(z+="<br/>"),z+='<span style=font-size:12px title="Подключен MQTT">Подключен MQTT канал</span>'),""==z&&i.lastconnect?z="<span style=font-size:12px>Последнее посещение:<br />"+printDateTime(new Date(i.lastconnect))+"</span>":("PDU"==i.porttype||i.pwr>1&&7!=i.pwr)&&(z+="<br/>"+powerStateStrings[i.pwr]),QH("MainComputerState",z),Q("MainComputerImage").setAttribute("src","images/icons256-"+i.icon+"-1.png"),Q("MainComputerImage").className=i.conn&&0!=i.conn||3==i.mtype?"":"gray",3==i.mtype&&null!=i.agent&&i.agent.id>4&&512&features2&&(i.agent.caps=6),F&&setupTerminal(),B&&setupFiles();var G=!!(16&s);G?setupConsole():15==t&&(t=10),QV("MainDevDesktop",H&&(null==i.agent&&null!=i.intelamt&&("number"!=typeof i.intelamt.sku||!!(8&i.intelamt.sku))||null!=i.agent&&(null==i.agent.caps||!!(1&i.agent.caps)||i.intelamt&&2==i.intelamt.state)||3==i.mtype&&(3==i.agent.id||4==i.agent.id))&&(8&s||256&s)),QV("MainDevTerminal",(null==i.agent&&null!=i.intelamt||i.agent&&null==i.agent.caps||i.agent&&!!(2&i.agent.caps)||i.intelamt&&2==i.intelamt.state)&&8&s&&F),QV("MainDevFiles",null!=i.agent&&null!=i.agent.caps&&!!(4&i.agent.caps)&&8&s&&B),QV("MainDevInfo",i.mtype<3&&!!(1048576&s)),QV("MainDevAmt",null!=i.intelamt&&(2==i.intelamt.state||2&i.conn)&&8&s&&O),QV("MainDevConsole",G&&null!=i.agent&&null!=i.agent.caps&&!!(8&i.agent.caps)&&8&s),QV("MainDevPlugins",!1),QV("p15uploadCore",null!=i.agent&&null!=i.agent.caps&&!!(16&i.agent.caps)),QH("p15coreName",null!=i.agent&&null!=i.agent.core?i.agent.core:""),null!=i.intelamt&&"number"==typeof i.intelamt.sku&&16&i.intelamt.sku?(QH("MainDevAmt","Intel&reg;SM"),QH("p14deviceNamePrefix","Intel&reg; SM")):(QH("MainDevAmt","Intel&reg;AMT"),QH("p14deviceNamePrefix","Intel&reg; AMT"));var K=Q("p14iframe").contentWindow.getCurrentMeshNode();null!=K&&K._id!=currentNode._id&&Q("p14iframe").contentWindow.disconnect();var j=!!(6&i.conn);if(Q("p14iframe").contentWindow.setConnectionState(j),Q("p14iframe").contentWindow.setFrameHeight("650px"),Q("p14iframe").contentWindow.setAuthCallback(updateAmtCredentials),powerTimelineNode!=currentNode._id&&powerTimelineReq!=currentNode._id&&(QH("p10html2",""),powerTimelineReq=currentNode._id,meshserver.send({action:"powertimeline",nodeid:currentNode._id}),meshserver.send({action:"lastconnect",nodeid:currentNode._id}),meshserver.send({action:"getsysinfo",nodeid:currentNode._id}),meshserver.send({action:"getnetworkinfo",nodeid:currentNode._id}),meshserver.send({action:"getNotes",id:currentNode._id}),QH("p17info2","")),deviceSharesNode!=currentNode._id&&deviceSharesReq!=currentNode._id&&(deviceSharesReq=currentNode._id,meshserver.send({action:"deviceShares",nodeid:currentNode._id})),QV("DeskTools",!1),showDeskToolsProcesses(),refreshDeviceEvents(),document.title=currentNode&&xxcurrentView>=10&&xxcurrentView<20?currentNode.name+(a?" - "+a.name:"")+" - "+decodeURIComponent("{{{extitle}}}"):decodeURIComponent("{{{extitle}}}"),r&&(p11clearConsoleMsg(),p12clearConsoleMsg(),p13clearConsoleMsg()),null!=pluginHandler){QH("p19headers",""),QH("p19pages",""),pluginHandler.callHook("onDeviceRefreshEnd",e,t,n,o);var q=getstore("_curPluginPage",null);null!=q&&null!=Q("p19ph-"+q)&&pluginHandler.callPluginPage(q,Q("p19ph-"+q))}if(g="",7&s&&(g+='<button class="btn btn-primary btn-sm me-2" onclick="return p20showAddMeshUserDialog(5)" style=cursor:pointer;margin-right:10px><i class="fa-solid fa-circle-plus"></i> Добавить пользователя</button>',null!=usergroups)){var J=0,$=!1;for(var M in usergroups)null==usergroups[M].membershipType&&usergroups[M]._id.split("/")[1]==e.split("/")[1]&&(J++,null!=currentNode.links&&null!=currentNode.links[M]||($=!0));J>0&&$&&(g+='<a href=# onclick="return p20showAddMeshUserDialog(6)" style=cursor:pointer;margin-right:10px><i class="fa-solid fa-circle-plus"></i> Добавить группу пользователей</a>')}g+='<table class="table table-hover" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>Права пользователей</th><th scope=col style=text-align:left></th></tr>';var X=1;if(null!=currentNode.links){var Y=[];for(var M in currentNode.links)(M.startsWith("user/")||M.startsWith("ugrp/"))&&Y.push(M);for(var M in Y.sort(),Y){var Z="",ee="",te=Y[M],ne=currentNode.links[te].rights,oe=EscapeHtml(te.split("/")[2]),ie=(ee=makeUserDeviceRightsString(ne),!1);null!=currentNode.links[te].name&&(oe=EscapeHtml(currentNode.links[te].name)),te==userinfo._id&&(oe=EscapeHtml(userinfo.name)),null!=users&&null!=users[te]&&(oe=EscapeHtml(users[te].name)),null!=usergroups&&null!=usergroups[te]&&(oe=EscapeHtml(usergroups[te].name),ie=!0),2&s&&(ie?(Z="<a href=# onclick='return p30removeUserFromNode(event,\""+encodeURIComponentEx(te)+'")\' title="Удалить права группы пользователей для этой группы устройств" style=cursor:pointer><i class="fa-solid fa-trash text-danger hoverButton"></i></a>',ee='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(6,"'+encodeURIComponentEx(te)+'")>'+ee+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"):(Z="<a href=# onclick='return p30removeUserFromNode(event,\""+encodeURIComponentEx(te)+'")\' title="Удалить права пользователя для этой группы устройств" style=cursor:pointer><i class="fa-solid fa-trash text-danger hoverButton"></i></a>',ee='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(5,"'+encodeURIComponentEx(te)+'")>'+ee+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>")),null!=users&&(oe=ie?"<a href=# onclick='gotoUserGroup(\""+encodeURIComponentEx(te)+"\");haltEvent(event);'>"+oe+"</a>":"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(te)+"\");haltEvent(event);'>"+oe+"</a>"),g+="<tr "+(++X%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="'+(ie?"Группа пользователей":"Пользователь")+'" class=m'+(ie?4:2)+"></div><div>&nbsp;"+oe+"<div></div></div></td><td style=width:70%><div style=float:right>"+Z+"</div><div>"+ee+"</div></td></tr>"}}if(1==X&&(g+="<tr><td><div style=padding:6px>&nbsp;<i>Нет пользователей со специальными правами доступа к устройству</i><div></div></div></td><td></td></tr>"),g+="</tbody></table>",null!=deviceShares&&deviceSharesNode==currentNode._id&&deviceShares.length>0){g+='<br /><table class="table table-hover" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>Активные гоcтевые доступы к устройствам</th><th scope=col style=text-align:left></th></tr>',X=1;for(M=0;M<deviceShares.length;M++){var ae=deviceShares[M];Z="";null!=ae.url&&(Z+='<a href="'+ae.url+'" rel="noreferrer noopener" target=_blank title="Ссылка для совместного использования устройства" style=cursor:pointer><img src=images/link2.png border=0 height=10 width=10></a> '),Z+="<i role=button onclick='return p30removeDeviceSharing(event,\""+encodeURIComponentEx(currentNode._id)+'","'+encodeURIComponentEx(ae.publicid)+'","'+encodeURIComponentEx(ae.guestName)+'")\' title="Удалить доступ к устройству" class="fa-fw fa-solid fa-trash text-danger"></i>';var se="";ae.p<=7?se=["","Терминал","Рабочий стол","Рабочий стол + Терминал","Файлы","Терминал + Файлы","Рабочий стол + Файлы","Рабочий стол + Терминал + Файлы"][ae.p]:8==ae.p?se="HTTP/"+ae.port:16==ae.p&&(se="HTTPS/"+ae.port);var re=se;null!=ae.startTime&&null!=ae.expireTime&&(re=format("{0}, с {1} на {2}",se,printFlexDateTime(new Date(ae.startTime)),printFlexDateTime(new Date(ae.expireTime)))),null!=ae.startTime&&null!=ae.duration&&(re=(ae.duration,format("{0}, {1} на {2} мин.",se,printFlexDateTime(new Date(ae.startTime)),ae.duration))),1==ae.recurring&&(re+=", Ежедневно"),2==ae.recurring&&(re+=", Еженедельно"),2&ae.p&&!0===ae.viewOnly&&(re+=",  Только просмотр рабочего стола"),null!=ae.consent&&(0==ae.consent?re+=", Нет согласия":(56&ae.consent&&(re+=", Запрос согласия"),64&ae.consent&&(re+=", Панель-уведомление")));var le=EscapeHtml(ae.guestName);ae.publicid.startsWith("AS:node/")&&(le="<i>Общий доступ из Агента</i>"),g+="<tr "+(++X%2==0?"style=background-color:#DDD":"")+"><td style=width:30%><div class=m2></div><div>&nbsp;"+le+"<div></div></div></td><td style=width:70%><div style=float:right>"+Z+"</div><div>"+re+"</div></td></tr>"}g+="</tbody></table>"}QH("p10html4",g);var de="";if(!(268435456&features)&&xxcurrentView>=10&&xxcurrentView<=19&&null!=currentNode){for(var M in de="?viewmode="+xxcurrentView+"&gotonode="+currentNode._id.split("/")[2],urlargs)de+="&"+M+"="+urlargs[M];try{window.history.replaceState({},document.title,window.location.pathname+de)}catch(e){}}QV("p11DeskSessionSelector",!1),QH("p11DeskSessionSelector","")}setupDesktop(),t||(t=10),go(t)}}else safeNewWindow(window.location.origin+"?node="+e.split("/")[2]+"&viewmode=10&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+e)}}function setIpPduState(e){0==e?(setModalContent("xxAddAgent","Работа с питанием","Perform power off?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:2})})):(setModalContent("xxAddAgent","Работа с питанием","Perform power on?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"wakedevices",nodeids:[currentNode._id]})}))}function p20editDeviceNotify(){if(xxdialogMode)return!1;var e=0,t=16384&features2&&userinfo.emailVerified?1:0;userinfo.notify&&userinfo.notify[currentNode._id]&&(e=userinfo.notify[currentNode._id]);var n='<div style="border-bottom: 1px solid #888;margin-bottom:3px">Веб Push-уведомления</div>';return n+='<div><label><input id=p20notifyIntelDeviceConnect type=checkbox class="form-check-input me-2" />Подключения устройств</label></div>',n+='<div><label><input id=p20notifyIntelDeviceDisconnect type=checkbox class="form-check-input me-2" />Отключения устройств</label></div>',null!=currentNode.intelamt&&(t+=2,n+='<div><label><input id=p20notifyIntelAmtKvmActions type=checkbox class="form-check-input me-2" />События Intel&reg; AMT desktop или serial</label></div>'),1&t&&(n+='<br /><div style="border-bottom: 1px solid #888;margin-bottom:3px">Уведомления по электронной почте</div>',n+='<div><label><input id=p20enotifyIntelDeviceConnect type=checkbox class="form-check-input me-2" />Подключения устройств</label></div>',n+='<div><label><input id=p20enotifyIntelDeviceDisconnect type=checkbox class="form-check-input me-2" />Отключения устройств</label></div>',n+='<div><label><input id=p20enotifyIntelDeviceHelp type=checkbox class="form-check-input me-2" />Help requests</label></div>'),null!=userinfo.msghandle&&33554432&features2&&(n+='<br /><div style="border-bottom: 1px solid #888;margin-bottom:3px">Messaging Notifications</div>',n+='<div><label><input id=p20emsgDeviceConnect type=checkbox class="form-check-input me-2" />Подключения устройств</label></div>',n+='<div><label><input id=p20emsgDeviceDisconnect type=checkbox class="form-check-input me-2" />Отключения устройств</label></div>',n+='<div><label><input id=p20emsgDeviceHelp type=checkbox class="form-check-input me-2" />Help requests</label></div>'),setModalContent("xxAddAgent","Настройки уведомлений",n),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p20editDeviceNotifyEx(3,t)),Q("p20notifyIntelDeviceConnect").checked=2&e,Q("p20notifyIntelDeviceDisconnect").checked=4&e,2&t&&(Q("p20notifyIntelAmtKvmActions").checked=8&e),1&t&&(Q("p20enotifyIntelDeviceConnect").checked=16&e,Q("p20enotifyIntelDeviceDisconnect").checked=32&e,Q("p20enotifyIntelDeviceHelp").checked=64&e),null!=userinfo.msghandle&&33554432&features2&&(Q("p20emsgDeviceConnect").checked=128&e,Q("p20emsgDeviceDisconnect").checked=256&e,Q("p20emsgDeviceHelp").checked=512&e),!1}function p20editDeviceNotifyEx(e,t){var n=0;n+=Q("p20notifyIntelDeviceConnect").checked?2:0,n+=Q("p20notifyIntelDeviceDisconnect").checked?4:0,2&t&&(n+=Q("p20notifyIntelAmtKvmActions").checked?8:0),1&t&&(n+=Q("p20enotifyIntelDeviceConnect").checked?16:0,n+=Q("p20enotifyIntelDeviceDisconnect").checked?32:0,n+=Q("p20enotifyIntelDeviceHelp").checked?64:0),null!=userinfo.msghandle&&33554432&features2&&(n+=Q("p20emsgDeviceConnect").checked?128:0,n+=Q("p20emsgDeviceDisconnect").checked?256:0,n+=Q("p20emsgDeviceHelp").checked?512:0),meshserver.send({action:"changeusernotify",nodeid:currentNode._id,notify:n})}function makeUserDeviceRightsString(e){if(57592==e)return"Полные права на устройство";var t=[];if(8&e){var n=[];256&e&&n.push("Нет ввода"),512&e&&n.push("Нет терминала"),1024&e&&n.push("Файлов нет"),2048&e&&n.push("Нет AMT"),4096&e&&n.push("Ограниченный ввод"),65536&e&&n.push("Нет рабочего стола"),524288&e&&!1!==serverinfo.guestdevicesharing&&n.push("Поделиться с гостем"),n.length>0?t.push("Control ("+n.join(", ")+")"):t.push("Управление")}return 16&e&&t.push("Консоль"),32&e&&t.push("Серверные файлы"),64&e&&t.push("Разбудить"),128&e&&t.push("Примечания"),8192&e&&t.push("Предельные события"),16384&e&&t.push("Чат"),32768&e&&t.push("Удаление"),131072&e&&t.push("Команды"),262144&e&&t.push("Сброс / Выкл."),524288&e&&t.push("Совместное использование"),1048576&e&&t.push("Детали"),2097152&e&&t.push("Ретранслятор"),0==t.length?"Нет прав":t.join(", ")}function makeDeviceGroupRightsString(e){if(4294967295==e)return"Полные права";var t=[];if(1&e&&t.push("Редактировать группу"),2&e&&t.push("Управление пользователями"),4&e&&t.push("Управление устройствами"),8&e){var n=[];256&e&&n.push("Нет ввода"),512&e&&n.push("Нет терминала"),1024&e&&n.push("Файлов нет"),2048&e&&n.push("Нет AMT"),4096&e&&n.push("Ограниченный ввод"),65536&e&&n.push("Нет рабочего стола"),524288&e&&!1!==serverinfo.guestdevicesharing&&n.push("Поделиться с гостем"),n.length>0?t.push("Control ("+n.join(", ")+")"):t.push("Управление")}return 16&e&&t.push("Консоль"),32&e&&t.push("Серверные файлы"),64&e&&t.push("Разбудить"),128&e&&t.push("Примечания"),8192&e&&t.push("Предельные события"),16384&e&&t.push("Чат"),32768&e&&t.push("Удаление"),131072&e&&t.push("Команды"),262144&e&&t.push("Сброс / Выкл."),524288&e&&t.push("Совместное использование"),1048576&e&&t.push("Детали"),2097152&e&&t.push("Ретранслятор"),0==t.length?"Нет прав":t.join(", ")}function runDeviceCmd(e){xxdialogMode||d2runCommandDialog({nodeids:[e?decodeURIComponent(e):currentNode._id]})}function writeDeviceEvent(e){xxdialogMode||(setModalContent("xxAddAgent","Добавить событие к устройству","<textarea id=d2devEvent style=width:100%;height:200px;resize:none;overflow-y:scroll></textarea><span style=font-size:10px>Это добавит запись в журнал событий этого устройства.<span>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){writeDeviceEventEx(3,e)}),Q("d2devEvent").focus())}function writeDeviceEventEx(e,t){meshserver.send({action:"setDeviceEvent",nodeid:decodeURIComponent(t),msg:encodeURIComponentEx(Q("d2devEvent").value)})}function showNotes(e,t){if(!xxdialogMode){null==t&&(t=encodeURIComponentEx("p"+userinfo._id));var n="<textarea id=d2devNotes ro="+e+" noteid="+t+' readonly class="form-control" style=width:100%;height:200px;resize:none;overflow-y:scroll></textarea>';t.startsWith("node%2F%2F")&&(n+="<span style=font-size:10px>Примечания могут быть просмотрены и изменены другими администраторами.<span>"),"true"===showNotesPanel&&(n+=" <span style=font-size:10px><a target=_blank href='https://www.markdownguide.org/cheat-sheet/'>Markdown syntax supported</a></span>"),setModalContent("xxAddAgent","Примечания",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){showNotesEx(2,t)}),meshserver.send({action:"getNotes",id:decodeURIComponent(t)})}}function showNotesEx(e,t){Q("notesPanelArea").innerHTML=marked&&DOMPurify?DOMPurify.sanitize(marked.parse(Q("d2devNotes").value,{breaks:!0}),{USE_PROFILES:{html:!0}}):Q("d2devNotes").value,meshserver.send({action:"setNotes",id:decodeURIComponent(t),notes:encodeURIComponentEx(Q("d2devNotes").value)}),"true"===showNotesPanel&&""!=Q("d2devNotes").value?QV("notesPanel",!0):QV("notesPanel",!1)}function openIpKvmRemoteControl(e){if(!xxdialogMode){var t=decodeURIComponent(e).split("/")[2];safeNewWindow("/ipkvm.ashx/"+t+"/","ipkvm:"+t)}}function deviceChat(e){if(!xxdialogMode){var t="/messenger?id=meshmessenger/"+encodeURIComponentEx(currentNode._id)+"/"+encodeURIComponentEx(userinfo._id)+"&title="+currentNode.name;""!=serverinfo.domainsuffix&&(t="/"+serverinfo.domainsuffix+t),null!=authCookie&&""!=authCookie&&(t+="&auth="+authCookie),1==currentNode.pmt&&2&features2&&(t+="&pmt=1"),e&&1==e.shiftKey?safeNewWindow(t,"meshmessenger:"+currentNode._id):safeNewWindow(t,"meshmessenger:"+currentNode._id,"directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=400,height=560"),meshserver.send({action:"meshmessenger",nodeid:decodeURIComponent(currentNode._id)})}}function altDeviceChat(e,t){if(!xxdialogMode){var n=serverinfo.altmessenging[t].url.split("{0}").join(currentNode._id.split("/")[2]).split("{1}").join(currentNode._id.split("/")[2]).split("{2}").join(currentNode._id.split("/")[2]).split("{3}").join(currentNode._id.split("/")[2]),o=encodeURIComponentEx(userinfo._id.split("/")[2]),i=encodeURIComponentEx(userinfo._id.split("/").join("-")),a=o,s=i;null!=userinfo.realname&&(a=encodeURIComponentEx(userinfo.realname.split(" ").join("")),s=encodeURIComponentEx(userinfo.realname.split(" ").join("-")));var r=n=n.split("{4}").join(o).split("{5}").join(i).split("{6}").join(a).split("{7}").join(s);"string"==typeof serverinfo.altmessenging[t].localurl&&(r=(r=serverinfo.altmessenging[t].localurl.split("{0}").join(currentNode._id.split("/")[2]).split("{1}").join(currentNode._id.split("/")[2]).split("{2}").join(currentNode._id.split("/")[2]).split("{3}").join(currentNode._id.split("/")[2])).split("{4}").join(o).split("{5}").join(i).split("{6}").join(a).split("{7}").join(s)),""!=n&&meshserver.send({action:"msg",type:"openUrl",nodeid:currentNode._id,url:n}),""!=r&&safeNewWindow(r,"altmessenger:"+currentNode._id,"directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=400,height=560")}}function deviceToggleBackground(){xxdialogMode||meshserver.send({action:"msg",type:"deskBackground",nodeid:currentNode._id,op:1})}function deviceUrlFunction(){xxdialogMode||(xxdialogButtons=3,setModalContent("xxAddAgent","Открыть страницу на устройстве",'<input id=d2devurl placeholder="http://server.com" style=width:100%;overflow-y:scroll onkeyup=deviceUrlFunctionValidate() onchange=deviceUrlFunctionValidate()></input>'),showModal("xxAddAgentModal","idx_dlgOkButton",deviceUrlFunctionEx),Q("d2devurl").focus(),deviceUrlFunctionValidate())}function deviceUrlFunctionValidate(){var e=Q("d2devurl").value.toLowerCase();QE("idx_dlgOkButton",e.startsWith("http://")&&e.length>7||e.startsWith("https://")&&e.length>8)}function deviceUrlFunctionEx(){meshserver.send({action:"msg",type:"openUrl",nodeid:currentNode._id,url:Q("d2devurl").value})}function deviceMessageFunction(){if(!xxdialogMode){xxdialogButtons=3,setModalContent("xxAddAgent","Сообщение устройства","<div style=margin-bottom:4px>Показать окно с сообщением на удаленном устройстве.</div><textarea id=d2devMessage style=width:100%;height:80px;resize:none;overflow-y:scroll;box-sizing:border-box;margin-bottom:4px></textarea><select style=width:100% id=d2devTimeout><option value=2 selected>Show for 2 Minutes (Default)</option><option value=10>Show for 10 minutes</option><option value=30>Show for 30 minutes</option><option value=60>Show for 60 minutes</option><option value=0>Показывать сообщение, пока оно не будет закрыто пользователем</option></select>"),showModal("xxAddAgentModal","idx_dlgOkButton",deviceMessageFunctionEx),Q("d2devMessage").focus()}}function deviceMessageFunctionEx(){var e=decodeURIComponent("{{{extitle}}}"),t=parseFloat(Q("d2devTimeout").value);""==e&&(e="MeshCentral"),isNaN(t)&&(t=2),1==currentNode.pmt?meshserver.send({action:"pushmessage",nodeid:currentNode._id,title:e,msg:Q("d2devMessage").value}):meshserver.send({action:"msg",type:"messagebox",nodeid:currentNode._id,title:e,msg:Q("d2devMessage").value,timeout:6e4*t})}function deskClipboardInFunction(){if(null!=desktop&&3==desktop.State)if(desktop.m.getClipboard){var e=desktop.m.getClipboard();null!=e&&null!=navigator.clipboard&&navigator.clipboard.writeText(e).then(function(){}).catch(function(e){console.log(e)})}else meshserver.send({action:"msg",type:"getclip",nodeid:currentNode._id,tag:2})}function deskInputLockFunction(e){xxdialogMode||null==desktop||3!=desktop.State||(setModalContent("xxAddAgent","Блокировка удаленного ввода",1==e?"Заблокировать мышь и клавиатуру удаленного пользователя?":"Разблокировать мышь и клавиатуру удаленного пользователя?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){try{desktop.m.SendRemoteInputLock(e)}catch(e){}}))}function deskClipboardOutFunction(){if(null!=navigator.clipboard&&null!=navigator.clipboard.readText)try{navigator.clipboard.readText().then(function(e){desktop.m.setClipboard?desktop.m.setClipboard(e):meshserver.send({action:"msg",type:"setclip",nodeid:currentNode._id,data:e})}).catch(function(e){console.log(e)})}catch(e){console.log(e)}return!0}function deskRefreshFunction(){null!=desktop&&3==desktop.State&&desktop.m.SendRefresh()}function deviceToastFunction(){if(!xxdialogMode){xxdialogButtons=3,setModalContent("xxAddAgent","Уведомление устройства",'<select id=d2deviceop style=width:100%;margin-bottom:4px class=form-select><option value=2>Уведомление в трее (тост)</option><option value=1>Уведомление в окне</option><option value=3>Alert Box</option></select><input id=dp2notifyTitle maxlength=256 placeholder="Заголовок" style=width:100%;box-sizing:border-box;margin-bottom:4px class=form-control/><textarea id=d2notifyMsg style=background-color:#fcf3cf;width:100%;height:140px;resize:none;overflow-y:scroll;box-sizing:border-box;margin-bottom:4px class=form-control></textarea><select style=width:100% id=d2notifyTimeout class=form-select><option disabled value="">Only Applicable to Message Box Notifications</option><option value=2 selected>Show for 2 Minutes (Default)</option><option value=10>Show for 10 minutes</option><option value=30>Show for 30 minutes</option><option value=60>Show for 60 minutes</option><option value=0>Показывать сообщение, пока оно не будет закрыто пользователем</option></select>'),showModal("xxAddAgentModal","idx_dlgOkButton",deviceToastFunctionEx),Q("d2notifyMsg").focus()}}function deviceToastFunctionEx(){var e=Q("d2deviceop").value,t=Q("dp2notifyTitle").value,n=Q("d2notifyMsg").value,o=parseFloat(Q("d2notifyTimeout").value);0!=n.length&&(""==t&&(t=decodeURIComponent("{{{extitle}}}")),""==t&&(t="MeshCentral"),isNaN(o)&&(o=2),1==e?meshserver.send({action:"msg",type:"messagebox",nodeid:currentNode._id,title:t,msg:n,timeout:6e4*o}):2==e?meshserver.send({action:"toast",nodeids:[currentNode._id],title:t,msg:n}):3==e&&meshserver.send({action:"msg",type:"alertbox",nodeid:currentNode._id,title:t,msg:n}))}function deviceLockFunction(){null==xxdialogMode&&null!=desktop&&1==desktop.contype&&(setModalContent("xxAddAgent","Заблокировать рабочий стол","Заблокировать рабочий стол пользователя?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){null!=desktop&&1==desktop.contype&&desktop.sendCtrlMsg('{"ctrlChannel":"102938","type":"lock"}')}))}function showShareDevice(){if(!xxdialogMode){var e=GetNodeRights(currentNode),t="",n="Создает ссылку, которая позволяет гостю без учетной записи удаленно управлять этим устройством в течение ограниченного времени.<br /><br />";n+=addHtmlFormFloating("Имя гостя",'<input id=d2inviteName class="form-control" maxlength=128 type=text onkeyup=showShareDeviceValidate() />');var o="<option value=2>Рабочий стол</option>";4294967295!=e&&256&e&&(o="");var i="<option value=1>Терминал</option>";4294967295!=e&&512&e&&(i="");var a="<option value=4>Файлы</option>";4294967295!=e&&1024&e&&(a="");var s="<option value=5>Рабочий стол + Файлы</option>";4294967295!=e&&1280&e&&(s="");var r="<option value=6>Терминал + Файлы</option>";4294967295!=e&&1536&e&&(r="");var l="<option value=7>Рабочий стол + Терминал + Файлы</option>";4294967295!=e&&1792&e&&(l="");var d="";0!=webRelayPort&&(d="<option value=8>HTTP</option><option value=9>HTTPS</option>",4294967295!=e&&8&e&&(d=""));t="";var c="";1&~currentNode.agent.caps||(t+=o+"<option value=3>Рабочий стол, только просмотр</option>"),2&~currentNode.agent.caps||(t+=i),4&~currentNode.agent.caps||(t+=a),5&~currentNode.agent.caps||(t+=s),6&~currentNode.agent.caps||(t+=r),7&~currentNode.agent.caps||(t+=l),n+=addHtmlFormFloating("Тип",'<select id=d2shareType class="form-select" onchange=showShareDeviceValidate()>'+(t+=d)+"</select>");var u={1:"1 минута",5:"5 минут",10:"10 минут",15:"15 минут",30:"30 минут",45:"45 минут",60:"60 минут",120:"2 часа",240:"4 часа",480:"8 часов",720:"12 часов",960:"16 часов",1440:"24 часа",2880:"2 дня",5760:"4 дня",0:"Неограниченно"};for(var p in t="",u)(null==serverinfo.guestdevicesharingmaxtime||p>0&&p<=serverinfo.guestdevicesharingmaxtime)&&(t+="<option value="+p+">"+u[p]+"</option>"),p>0&&p<=720&&(null==serverinfo.guestdevicesharingmaxtime||p>0&&p<=serverinfo.guestdevicesharingmaxtime)&&(c+="<option value="+p+">"+u[p]+"</option>");n+=addHtmlFormFloating("Начнет действовать",'<select id=d2timeRange class="form-select" onchange=showShareDeviceValidate()><option value=0>Прямо сейчас</option><option value=1>Временной диапазон</option><option value=2>Ежедневно</option><option value=3>Еженедельно</option></select>'),n+="<div id=d2modenow>",n+=addHtmlFormFloating("Время действия",'<select id=d2inviteExpire class="form-select">'+t+"</select>"),n+="</div><div id=d2moderange style=display:none>",n+=addHtmlFormFloating("Временный диапазон запускается",'<input id=d2timeRangeStartSelector class="flatpickr form-select" type="text" placeholder="Выберите дату и время..." data-id="altinput">'),n+=addHtmlFormFloating("Временный диапазон конец",'<input id=d2timeRangeEndSelector class="flatpickr form-select" type="text" placeholder="Выберите дату и время..." data-id="altinput">'),n+="</div><div id=d2moderecurring style=display:none>",n+=addHtmlFormFloating("Время начала",'<input id=d2timeStartSelector class="flatpickr form-select" type="text" placeholder="Выберите дату и время..." data-id="altinput">'),n+=addHtmlFormFloating("Длительность",'<select id=d2inviteDuration class="form-select">'+c+"</select>"),n+="</div>",1&currentNode.agent.caps&&(n+="<div id=d2userConsentSelector>"+addHtmlFormFloating("Согласие пользователя",'<select id=d2userConsent class="form-select"><option value=0>Только уведомлять<option value=1>Запрос согласия</option><option value=2>No Consent</option></select>')+"</div>"),n+="<div id=d2httpPortSelector>"+addHtmlFormFloating("Port",'<input id=d2httpPort class="form-control" value=80 onkeyup=showShareDeviceValidate()></input>')+"</div>",n+="<div id=d2httpsPortSelector>"+addHtmlFormFloating("Port",'<input id=d2httpsPort class="form-control" value=443 onkeyup=showShareDeviceValidate()></input>')+"</div>",xxdialogButtons=3,setModalContent("xxAddAgent","Поделиться устройством",n),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showShareDeviceEx("",xxdialogTag)),showShareDeviceValidate();var m=new Date;m.setDate(m.getDate()+1);var g=flatpickr("#d2timeRangeStartSelector",{enableTime:!0,minDate:new Date,defaultDate:new Date,minuteIncrement:1,plugins:[new confirmDatePlugin({})],onChange:function(e,t,n){v.set("minDate",t),v.selectedDates[0]&&v.selectedDates[0]<e[0]&&v.clear()}}),v=flatpickr("#d2timeRangeEndSelector",{enableTime:!0,minDate:m,defaultDate:m,minuteIncrement:1,plugins:[new confirmDatePlugin({})]}),h=flatpickr("#d2timeStartSelector",{enableTime:!0,minDate:new Date,defaultDate:new Date,minuteIncrement:1,plugins:[new confirmDatePlugin({})]});xxdialogTag={rangeStart:g,rangeEnd:v,start:h}}}function showShareDeviceValidate(){1&currentNode.agent.caps&&QV("d2userConsentSelector",Q("d2shareType").value<8),QV("d2httpPortSelector",8==Q("d2shareType").value),QV("d2httpsPortSelector",9==Q("d2shareType").value),QV("d2modenow",0==Q("d2timeRange").value),QV("d2moderange",1==Q("d2timeRange").value),QV("d2moderecurring",Q("d2timeRange").value>=2);var e=!0;if(8==Q("d2shareType").value){var t=parseInt(Q("d2httpPort").value);(Q("d2httpPort").value!=t||t<1||t>65535)&&(e=!1)}if(9==Q("d2shareType").value){t=parseInt(Q("d2httpsPort").value);(Q("d2httpsPort").value!=t||t<1||t>65535)&&(e=!1)}0==Q("d2inviteName").value.trim().length&&(e=!1),QE("idx_dlgOkButton",e)}function showShareDeviceEx(e,t){var n=0,o=parseInt(Q("d2shareType").value),i=!1,a=0;8!=o?9!=o?(3==o&&(i=!0),1&(a=[0,1,2,2,4,6,5,7][o])&&(n|=2,1&currentNode.agent.caps&&1==Q("d2userConsent").value&&(n|=16),1&currentNode.agent.caps&&2==Q("d2userConsent").value&&(n=0)),2&a&&(n|=65,1&currentNode.agent.caps&&1==Q("d2userConsent").value&&(n|=8),1&currentNode.agent.caps&&2==Q("d2userConsent").value&&(n=0)),4&a&&(n|=4,1&currentNode.agent.caps&&1==Q("d2userConsent").value&&(n|=32),1&currentNode.agent.caps&&2==Q("d2userConsent").value&&(n=0)),0==Q("d2timeRange").value?meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:a,expire:parseInt(Q("d2inviteExpire").value),consent:n,viewOnly:i}):1==Q("d2timeRange").value?meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:a,start:Math.floor(t.rangeStart.selectedDates[0].getTime()/1e3),end:Math.floor(t.rangeEnd.selectedDates[0].getTime()/1e3),consent:n,viewOnly:i}):meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:a,start:Math.floor(t.start.selectedDates[0].getTime()/1e3),expire:parseInt(Q("d2inviteDuration").value),recurring:Q("d2timeRange").value-1,consent:n,viewOnly:i})):meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:16,expire:parseInt(Q("d2inviteExpire").value),port:parseInt(Q("d2httpsPort").value),consent:0}):meshserver.send({action:"createDeviceShareLink",nodeid:currentNode._id,guestname:Q("d2inviteName").value.trim(),p:8,expire:parseInt(Q("d2inviteExpire").value),port:parseInt(Q("d2httpPort").value),consent:0})}function deviceActionFunction(){if(!xxdialogMode){var e=GetNodeRights(currentNode),t=0,n="Выберите действие для осуществления на этом устройстве.<br /><br />",o="<select id=d2deviceop onchange=deviceActionFunctionValidate() class=form-select>",i="";null!=currentNode.agent&&14==currentNode.agent.id?1&currentNode.conn&&8&e&&(t++,o+="<option value=400>Вспышка</option>",o+="<option value=401>Вибрировать</option>",i+="<div id=d2devicetimediv>"+addHtmlFormFloating("Время","<select id=d2devicetime class=form-select><option value=1000>1 секунда</option><option value=5000>5 секунд</option><option value=10000>10 секунд</option></select>")+"</div>"):(64&e&&(t++,o+="<option value=100>Разбудить</option>"),1&currentNode.conn&&131072&e&&(t++,o+="<option value=106>Выполнить команды</option>"),0!=currentNode.conn&&262144&e&&(t++,o+="<option value=4>Отправить в сон</option><option value=3>Перезагрузить</option><option value=2>Выключить</option>"),16&currentNode.conn&&(t++,o+="<option value=103>Отправить MQTT сообщение</option>"),null!=currentNode.intelamt&&2==currentNode.intelamt.state&&6&currentNode.conn&&262144&e&&(t++,o+="<option value=310>Сброс Intel&reg; AMT</option>",o+="<option value=308>Intel&reg; AMT Power off</option>",11!=xxcurrentView&&12!=xxcurrentView||(o+="<option value=312>Intel&reg; AMT Reset to BIOS</option>",o+="<option value=311>Intel&reg; AMT Power on to BIOS</option>",o+="<option value=315>Intel&reg; AMT Power on to PXE</option>",o+="<option value=316>Intel&reg; AMT Reset to PXE</option>")),null!=currentNode.intelamt&&2==currentNode.intelamt.state&&6&currentNode.conn&&64&e&&(t++,o+="<option value=302>Intel&reg; AMT Power on</option>"),(11==xxcurrentView||12==xxcurrentView)&&getNodeAmtVersion(currentNode)>=15&&2==currentNode.intelamt.state&&6&currentNode.conn&&4294967295==e&&!(1024&features)&&(t++,o+="<option value=107>Восстановление Intel&reg; AMT в один клик</option>"),1&currentNode.conn&&32768&e&&(t++,o+="<option value=104>Удаление агента</option>")),n+=addHtmlFormFloating("Операция",o+="</select>"),0==t&&(n="В настоящее время для этого устройства нет доступных действий."),xxdialogButtons=0==t?2:3,xxdialogTag=n+i,setModalContent("xxAddAgent","Управление устройством",n),showModal("xxAddAgentModal","idx_dlgOkButton",deviceActionFunctionEx),t>0&&deviceActionFunctionValidate()}}function deviceActionFunctionValidate(){var e=Q("d2deviceop").value;try{QV("d2devicetimediv",400==e||401==e)}catch(e){}}function deviceActionFunctionEx(){var e=Q("d2deviceop").value;if(100==e)return meshserver.send({action:"wakedevices",nodeids:[currentNode._id]}),!0;if(103==e)p10showSendMqttMsgDialog([currentNode._id]);else if(104==e)p10showSendUninstallAgentDialog([currentNode._id]);else if(106==e){var t=!1,n=!1;if(currentNode.agent&&(currentNode.agent.id>0&&currentNode.agent.id<5?t=!0:n=!0),1==t||1==n){var o="Выполнить команды на выбранных устройствах.<br />";1==t&&(o+="<select id=d2cmdtype style=width:100%;margin-bottom:4px;margin-top:4px>",o+="<option value=1>Командная строка Windows</option><option value=2>Windows PowerShell</option>",1==n&&(o+="<option value=3>Командная оболочка Linux/BSD/macOS</option>"),o+="</select>"),o+="<select id=d2cmduser style=width:100%;margin-bottom:4px><option value=0>Запуск от имени агента</option><option value=1>Запуск от имени пользователя, если нет пользователя, то от агента</option><option value=2>Запуск только от имени пользователя</option></select>",setModalContent("xxAddAgent","Выполнить команды",o+="<textarea id=d2runcmd style=width:100%;height:200px;resize:none;overflow-y:scroll></textarea>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>deviceRunCmdsFunctionEx()),Q("d2runcmd").focus()}}else if(107==e)Q("d3localmodeform").action="oneclickrecovery.ashx",Q("d3auth").value=authCookie,Q("d3filter").value=".efi",Q("d3attrib").value=currentNode._id,setModalContent("xxAddAgent","Восстановление Intel&reg; AMT в один клик",o),showModal("xxAddAgentModal","idx_dlgOkButton",()=>deviceActionOneClickRecovery()),d3init();else if(302==e)setModalContent("xxAddAgent","Intel&reg; AMT Power Operation","Включить питание Intel&reg; AMT?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(e)})});else if(308==e)setModalContent("xxAddAgent","Intel&reg; AMT Power Operation","Perform Intel&reg; AMT power off?<br><br><b>NOTE: If there is an active AMT session, then power off command will be rejected, so you must disconnect from the AMT session first!</b>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(e)})});else if(310==e)setModalContent("xxAddAgent","Intel&reg; AMT Power Operation","Выполнить сброс Intel&reg; AMT?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(e)})});else if(311==e)setModalContent("xxAddAgent","Intel&reg; AMT Power Operation","Perform Intel&reg; AMT power on to BIOS?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(e)+(12==xxcurrentView?2:0)})});else{if(312!=e)return 400==e||401==e?(meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(e),time:parseInt(Q("d2devicetime").value)}),!0):(meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(e)}),!0);setModalContent("xxAddAgent","Intel&reg; AMT Power Operation","Perform Intel&reg; AMT reset to BIOS?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"poweraction",nodeids:[currentNode._id],actiontype:parseInt(e)+(12==xxcurrentView?2:0)})})}return!1}function deviceActionOneClickRecovery(){if(1==Q("d3uploadMode").value)Q("d3submit").click();else{var e=d3getFileSel();1==e.length&&meshserver.send({action:"oneclickrecovery",nodeids:[Q("d3attrib").value],type:"diskimage",path:d3filetreelocation.join("/")+"/"+e[0]})}}function deviceRunCmdsFunctionEx(){var e=3;try{e=parseInt(Q("d2cmdtype").value)}catch(e){}meshserver.send({action:"runcommands",nodeids:[currentNode._id],type:e,cmds:Q("d2runcmd").value,runAsUser:parseInt(Q("d2cmduser").value)})}function updateAmtCredentials(e){var t=getNodeFromId(currentNode._id);1==e||null==t.intelamt.user||""==t.intelamt.user?editDeviceAmtSettings(currentNode._id,updateAmtCredentialsEx):Q("p14iframe").contentWindow.connectButtonfunctionEx()}function updateAmtCredentialsEx(e,t){Q("p14iframe").contentWindow.connectButtonfunctionEx()}function updateDeviceTimeline(){2==meshserver.State&&null!=powerTimelineNode&&null!=powerTimelineUpdate&&null!=currentNode&&3!=currentNode.mtype&&powerTimelineNode==powerTimelineReq&&currentNode._id==powerTimelineNode&&powerTimelineUpdate<Date.now()&&(powerTimelineUpdate=null,meshserver.send({action:"powertimeline",nodeid:currentNode._id}),meshserver.send({action:"lastconnect",nodeid:currentNode._id}))}function drawDeviceTimeline(){if(!(null==currentNode||xxcurrentView<10||xxcurrentView>19||3==currentNode.mtype||"true"===hidePowerTimeline)){var e=null,t=Date.now();currentNode._id==powerTimelineNode&&(e=powerTimeline);var n=new Date;n.setHours(0,0,0,0);(n=new Date(n.getTime()-5184e5)).getTime();var o=[];if(null!=e&&e.length>1){o.push([0,e[1],e[0]]);for(var i=e[1],a=2;a<e.length;a+=2){var s=e[a],r=t;e.length>a+1&&(r=e[a+1]),o.push([i,i+r,s]),i+=r}}var l="",d=1,c=new Date,u=Q("column_l").offsetWidth-192;c.setHours(0,0,0,0);for(a=0;a<7;a++){var p="",m=c.getTime(),g=m+864e5;for(var v in o){var h=o[v];if(1==isTimeBlockInside(m,g,h[0],h[1])){var f=Math.max(m,h[0]),x=Math.min(Math.min(g,h[1]),t),k=Math.round((x-f)*u/864e5);if(k>0){var y=format("{0} с {1} по {2}.",powerStateStrings2[h[2]],printTime(new Date(f)),printTime(new Date(x)));p+='<div class="pwState '+powerColor(h[2])+'" title="'+y+'" style="width:'+k+'px;"></div>'}}}l+="<tr class="+(d%2==0?"altBack":"")+"><td><div>&nbsp;"+printDate(c)+"<div></div></div></td><td><div>"+p+"</div></td></tr>",++d,c=new Date(c.getFullYear(),c.getMonth(),c.getDate()-1)}var b="";try{b="&tz="+encodeURIComponentEx(Intl.DateTimeFormat().resolvedOptions().timeZone)}catch(e){}QH("p10html2",'<table class="table table-striped align-middle text-center" cellpadding=2 cellspacing=0><thead><tr><th scope=col style=width:150px>День</th><th scope=col>7-дневная статистика работы<div class="float-end pe-1"><i role="button" onclick=downloadFile("devicepowerevents.ashx?id='+currentNode._id+"&tf="+(new Date).getTimezoneOffset()+"&l="+encodeURIComponentEx(getLang())+b+(urlargs.key?"&key="+urlargs.key:"")+'",null,true) title="Скачать события состояния питания" class="fa-solid fa-download"></i></div></th></tr></thead><tbody>'+l+"</tbody></table>")}}function powerColor(e){return e<powerColorTable.length?powerColorTable[e]:"pwsYellow"}function isTimeBlockInside(e,t,n,o){return n<e&&o>t||(n>e&&n<t||o>e&&o<t)}function addDeviceAttribute(e,t,n=[]){return`<div class="row mb-1"><div class="${n[0]||"col col-md-2 col-lg-2"}"><b> ${e} </b></div><div class="${n[1]||"col col-md-10 col-lg-10"}"> ${t} </div></div>`}function editDeviceAmtSettings(e,t,n){if(!xxdialogMode){var o="",i=getNodeFromId(e),a=3;4&GetNodeRights(i)&&(o+=addHtmlFormFloating("Имя пользователя",'<input id=dp10username class="form-control" maxlength=32 autocomplete=nope placeholder="admin" onchange=validateDeviceAmtSettings() onkeyup=validateDeviceAmtSettings() />'),o+=addHtmlFormFloating("Пароль",'<input id=dp10password type=password class="form-control" autocomplete=nope maxlength=32 onchange=validateDeviceAmtSettings() onkeyup=validateDeviceAmtSettings() />'),1&features2||(o+=addHtmlFormFloating("Защита",'<select id=dp10tls class="form-select"><option value=0>Нет безопасности TLS</option><option value=1>Требуется безопасность TLS</option></select>')),null!=i.intelamt.user&&""!=i.intelamt.user&&(a=7),setModalContent("xxAddAgent","Редактировать учетные данные Intel&reg; AMT",o),showModal("xxAddAgentModal","idx_dlgOkButton",()=>editDeviceAmtSettingsEx(a,{node:i,func:t,arg:n})),null!=i.intelamt.user&&""!=i.intelamt.user?Q("dp10username").value=i.intelamt.user:Q("dp10username").value="admin",1&features2||(Q("dp10tls").value=i.intelamt.tls),validateDeviceAmtSettings())}}function validateDeviceAmtSettings(){QE("idx_dlgOkButton",passwordcheck(Q("dp10password").value))}function editDeviceAmtSettingsEx(e,t){if(2==e)meshserver.send({action:"changedevice",nodeid:t.node._id,intelamt:{user:"",pass:""}});else{var n=Q("dp10username").value;""==n&&(n="admin");var o=Q("dp10password").value;""==o&&(n="");var i={action:"changedevice",nodeid:t.node._id,intelamt:{user:n,pass:o}};1&features2||(i.intelamt.tls=parseInt(Q("dp10tls").value)),meshserver.send(i),t.func&&setTimeout(function(){t.func(null,t.arg)},1e3)}}function p10showSendMqttMsgDialog(e){if(xxdialogMode)return!1;var t=addHtmlFormFloating("Тема",'<input id=dp2topic class="form-control" maxlength=64 onchange=p10validateSendMqttMsgDialog() onkeyup=p10validateSendMqttMsgDialog(event,1) />');return setModalContent("xxAddAgent","Отправить MQTT сообщение",t+=addHtmlFormFloating("Сообщение",'<textarea id=dp2msg class="form-control" maxlength=4096 style=width:100%;height:150px;resize:none onchange=p10validateSendMqttMsgDialog() onkeyup=p10validateSendMqttMsgDialog(event,1)></textarea>')),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p10showSendMqttMsgDialogEx(3,e)),p10validateSendMqttMsgDialog(),Q("dp2topic").focus(),!1}function p10validateSendMqttMsgDialog(){QE("idx_dlgOkButton",Q("dp2topic").value.length>0&&Q("dp2msg").value.length>0)}function p10showSendMqttMsgDialogEx(e,t){meshserver.send({action:"sendmqttmsg",nodeids:t,topic:Q("dp2topic").value,msg:Q("dp2msg").value}),uncheckAllDevices()}function p10showSendUninstallAgentDialog(e){if(xxdialogMode)return!1;var t="";return t=e.length>1?format("Вы действительно хотите деинсталлировать выбранных {0} агентов?",e.length):"Вы действительно хотите деинсталировать выбранного агента?",t+="<br /><br />",e.length>1?t+="Это не приведет к удалению устройств с сервера, но они больше не смогут подключаться к серверу. Удаленный доступ к устройствам будет потерян. Чтобы эта команда сработала, устройства должны быть подключены, ":t+="Это не приведет к удалению этого устройства с сервера, но оно больше не сможет подключаться к серверу. Удаленный доступ к устройству будет потерян. Чтобы эта команда сработала, устройство должно быть подключено, ",setModalContent("xxAddAgent","Удалить агент",t+='<br /><br /><label style=color:red><input id=p10check type=checkbox class="form-check-input me-2" onchange=p10validateDeleteNodeDialog() />Подтвердить</label>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p10showSendUninstallAgentDialogEx(3,e)),p10validateSendUninstallAgentDialog(),!1}function p10validateSendUninstallAgentDialog(){QE("idx_dlgOkButton",Q("p10check").checked)}function p10showSendUninstallAgentDialogEx(e,t){meshserver.send({action:"uninstallagent",nodeids:t}),uncheckAllDevices()}function p10showChangeGroupDialog(e){if(xxdialogMode)return!1;var t=null;if(1==e.length)try{t=meshes[getNodeFromId(e[0]).meshid]._id}catch(e){}var n='<select id=p10newGroup class="form-select">',o=0,i=[];for(var a in meshes){var s=GetMeshRights(a);meshes[a]._id!=t&&4&s&&i.push(meshes[a])}for(var a in i.sort(nameSort),i)o++,n+="<option value='"+i[a]._id+"'>"+i[a].name+"</option>";if(n+="</select>",o>0){var r=1==e.length?"Выберите новую группу для этого устройства<br /><br />":"Выберите новую группу для выбранных устройств<br /><br />";setModalContent("xxAddAgent","Смена группы",r+=addHtmlFormFloating("Новая группа устройств",n)),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p10showChangeGroupDialogEx(3,e))}else setModalContent("xxAddAgent","Смена группы","No other device group of same type exists."),showModal("xxAddAgentModal","idx_dlgOkButton");return!1}function p10showChangeGroupDialogEx(e,t){meshserver.send({action:"changeDeviceMesh",nodeids:t,meshid:Q("p10newGroup").value}),uncheckAllDevices()}function p10showDeleteNodeDialog(e){if(xxdialogMode)return!1;var t=format('Вы действительно хотите удалить устройство "{0}"?',EscapeHtml(currentNode.name))+'<br /><br /><label><input id=p10check type=checkbox class="form-check-input me-2" onchange=p10validateDeleteNodeDialog() />Подтвердить</label>';return xxdialogButtons=3,xxdialogTag=e,setModalContent("xxAddAgent","Удалить устройство",t),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p10showDeleteNodeDialogEx(0,e)),p10validateDeleteNodeDialog(),!1}function p10validateDeleteNodeDialog(){QE("idx_dlgOkButton",Q("p10check").checked)}function p10showDeleteNodeDialogEx(e,t){meshserver.send({action:"removedevices",nodeids:[t]})}function p10WebRouter(e,t,n,o){var i=null,a=getNodeFromId(e);if(3==a.mtype){var s=meshes[a.meshid];s&&s.relayid&&(i=s.relayid,o=a.host)}var r=serverinfo.name;(-1==r.indexOf(".")||2&features)&&(r=window.location.hostname),""!=webRelayDns&&(r=webRelayDns);var l="https://"+r+":"+webRelayPort+"/control-redirect.ashx?n="+e+"&p="+n+"&appid="+t+"&c="+authRelayCookie;return null!=o&&(l+="&addr="+o),null!=i&&(l+="&relayid="+i),safeNewWindow(l,"WebRelay"),!1}function p10MCRouter(e,t,n,o,i){var a=getNodeFromId(e),s=meshes[a.meshid];return 3==t&&null==n&&(n=null!=a.rdpport?a.rdpport:3389),3==a.mtype&&s&&s.relayid&&(e=s.relayid,o=a.host),meshserver.send({action:"getcookie",nodeid:e,tcpport:n,ip:o,tag:"MCRouter",protocol:t,localport:i,name:s?s.name:null}),!1}function p10rfb(e,t){var n=getNodeFromId(e),o=null,i=meshes[n.meshid];null==t&&(t=null!=n.rfbport?n.rfbport:5900),3==n.mtype&&i&&i.relayid&&(e=i.relayid,o=n.host),meshserver.send({action:"getcookie",nodeid:e,tcpport:t,tcpaddr:o,tag:"novnc",name:i?i.name:null})}function p10mstsc(e,t){var n=getNodeFromId(e),o=meshes[n.meshid];null==t&&(t=null!=n.rdpport?n.rdpport:3389),meshserver.send({action:"getcookie",nodeid:e,tcpport:t,tag:"mstsc",name:o?o.name:null})}function p10ssh(e,t){var n=getNodeFromId(e),o=meshes[n.meshid];null==t&&(t=null!=n.sshport?n.sshport:22),meshserver.send({action:"getcookie",nodeid:e,tcpport:t,tag:"ssh",name:o?o.name:null})}var d2map=null;function p10showNodeLocationDialog(){if(null!=xxdialogMode&&"@xxmap"==xxdialogTag)setDialogMode(0);else if(xxdialogMode)return!1;var e=function(t){var n=[],o=["iploc","wifiloc","gpsloc","userloc"],i=null;for(var a in o)if(null!=currentNode[o[a]]){var s=currentNode[o[a]].split(","),r=parseFloat(s[0]),l=parseFloat(s[1]);if(r<90&&r>-90&&l<180&&l>-180){var d=new ol.Feature({geometry:new ol.geom.Point(ol.proj.fromLonLat([l,r]))});d.setStyle(markerStyle(currentNode,parseInt(a)+1)),n.push(d),null==i?i=[r,l,r,l,0]:(r<i[0]&&(i[0]=r),l<i[1]&&(i[1]=l),r>i[2]&&(i[2]=r),l>i[3]&&(i[3]=l))}}var c=new ol.source.Vector({features:n}),u=new ol.layer.Vector({source:c}),p=0,m=0,g=8;if(null!=i){m=(i[0]+i[2])/2,p=(i[1]+i[3])/2;var v=Math.max(Math.abs(i[0]-i[2]),Math.abs(i[1]-i[3])),h=360;for(g=-2;h>v;)g++,h/=2}1==n.length&&(g=8),d2map=new ol.Map({target:"d2map",interactions:ol.interaction.defaults({dragPan:!1,mouseWheelZoom:!1}),layers:[new ol.layer.Tile({source:new ol.source.OSM}),u],view:new ol.View({center:ol.proj.fromLonLat([p,m]),zoom:g})}),document.getElementById("xxAddAgentModal").removeEventListener("shown.bs.modal",e)};document.getElementById("xxAddAgentModal").addEventListener("shown.bs.modal",e);return xxdialogTag="@xxmap",setModalContent("xxAddAgent","Местонахождение устройства","<div id=d2map style=width:100%;height:300px></div>"),showModal("xxAddAgentModal","idx_dlgOkButton"),!1}function p10showNodeNetInfoDialog(){return xxdialogMode||(xxdialogButtons=1,xxdialogTag="if"+currentNode._id,setModalContent("xxAddAgent","Сетевые интерфейсы","<div id=d2netinfo>Загрузка...</div>"),showModal("xxAddAgentModal","idx_dlgOkButton"),meshserver.send({action:"getnetworkinfo",nodeid:currentNode._id})),!1}function p10showMeshRouterDialog(){if(!xxdialogMode){var e="<div>MeshCentral Router это инструмент Windows для сопоставления портов TCP. Например, через этот сервер можно установить подключение по RDP к удаленному устройству.</div><br />";e+='<div class="row mb-1"><div class="col-md-4"><b>Win32 Executable</b></div><div class="col-md-8"><a style="cursor:pointer" onclick="downloadFile(\'meshagents?meshaction=winrouter'+(urlargs.key?"&key="+urlargs.key:"")+'\',null,true)" class="link-primary">MeshCentralRouter.exe</a></div></div>',e+='<div class="row mb-1"><div class="col-md-4"><b>MacOS Installer</b></div><div class="col-md-8"><a style="cursor:pointer" onclick="downloadFile(\'meshagents?meshaction=macrouter'+(urlargs.key?"&key="+urlargs.key:"")+'\',null,true)" class="link-primary">MeshCentralRouter.dmg</a></div></div>';var t=serverinfo.name;(-1==t.indexOf(".")||2&features)&&(t=window.location.hostname);domainUrl.substring(0,domainUrl.length-1);e+='<br /><div class="alert alert-info">Запустите MeshCentral Router и нажмите "установить", чтобы сделать его доступным для запуска из браузера.</div>',e+='<br /><a style=cursor:pointer target="mcrouterframe" rel="noreferrer noopener" href="'+("mcrouter://"+t+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"control.ashx?c="+authCookie+"&t="+serverinfo.tlshash+"&l={{{lang}}}"+(urlargs.key?"&key="+urlargs.key:""))+'"><input type=button style=width:100%;cursor:pointer value="Запустить MeshCentral Router" class="btn btn-primary btn-block" /></a>',setModalContent("xxAddAgent","MeshCentral Router ",e+='<iframe class="d-none" name="mcrouterframe"></iframe>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(1,"fileDownload")})}}function p10showMqttLoginDialog(e){meshserver.send({action:"getmqttlogin",nodeid:e})}function p10openxterm(e,t){haltEvent(e);var n="/xterm?nodeid="+encodeURIComponentEx(t)+"&auto=1",o=getNodeFromId(t);if(null!=o)return[1,2,3,4,21,22].indexOf(o.agent.id)>=0?n+="&os=win":n+="&os=linux",urlargs.key&&(n+="&key="+urlargs.key),safeNewWindow(n,"xterm:"+t),!1}function p10showMeshCmdDialog(e,t){if(!xxdialogMode){0;var n="";0==e&&(n+="<div>MeshCmd это утилита командной строки, которая позволяет выполнить множество операций. Файл с командами может быть опционально скачан и отредактирован для указания информации о сервере и учетных данных.<br /><br />"),1==e&&(n+='<div>Скачайте "meshcmd" с файлом команд для маршрутизации трафика к этому устройству через сервер. Не забудьте указать пароль от своей учетной записи в meshaction.txt и сделать другие правки при необходимости.<br /><br />'),n+=addHtmlFormFloating("Операционная система","<select id=aginsSelect onclick=meshCmdOsClick() class=form-select><option value=4>Windows x86 (64bit)</option><option value=3>Windows x86 (32bit)</option><option value=43>Windows ARM (64bit)</option><option value=6>Linux x86 (64bit)</option><option value=5>Linux x86 (32bit)</option><option value=16>macOS x86 (64bit)</option><option value=29>macOS ARM (64bit)</option><option value=25>Linux ARM, Raspberry Pi (32bit)</option><option value=26>Linux ARM, Raspberry Pi (64bit)</option></select>"),n+=addHtmlValue("MeshCmd",'<a id=meshcmddownloadid onclick=downloadFile("meshagents?meshcmd=3'+(urlargs.key?"&key="+urlargs.key:"")+'") class=link-primary></a>'),0==e&&(n+=addHtmlValue("Файл действий",'<a onclick=downloadFile("meshagents?meshaction=generic'+(urlargs.key?"&key="+urlargs.key:"")+'") class=link-primary>MeshAction (.txt)</a>')),1==e&&(n+=addHtmlValue("Файл действий",'<a onclick=downloadFile("meshagents?meshaction=route&nodeid='+t+(urlargs.key?"&key="+urlargs.key:"")+'") class=link-primary>MeshAction (.txt)</a>')),xxdialogButtons=9,xxdialogMode="fileDownload",setModalContent("xxAddAgent","Скачать MeshCmd",n+="</div>"),showModal("xxAddAgentModal","idx_dlgOkButton"),meshCmdOsClick()}}function meshCmdOsClick(){var e=Q("aginsSelect").value,t="";3==e&&(t="MeshCmd (Win x86-32 executable)"),4==e&&(t="MeshCmd (Win x86-64 executable)"),43==e&&(t="MeshCmd (Win ARM-64 executable)"),5==e&&(t="MeshCmd (Linux x86, 32bit)"),6==e&&(t="MeshCmd (Linux x86, 64bit)"),16==e&&(t="MeshCmd (macOS, x86-64bit)"),29==e&&(t="MeshCmd (macOS, ARM-64bit)"),25==e&&(t="MeshCmd (Linux ARM, 32bit)"),26==e&&(t="MeshCmd (Linux ARM, 64bit)"),QH("meshcmddownloadid",t),Q("meshcmddownloadid").onclick=function(){downloadFile("meshagents?meshcmd="+e+(urlargs.key?"&key="+urlargs.key:""))}}function p10showiconselector(){if(!xxdialogMode&&4&GetNodeRights(currentNode)){setModalContent("xxAddAgent","Выбор иконки",'<div style=text-align:center><br /><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i1 onclick=p10setIcon(1) onkeypress="if (event.key==\'Enter\') p10setIcon(1)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i2 onclick=p10setIcon(2) onkeypress="if (event.key==\'Enter\') p10setIcon(2)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i3 onclick=p10setIcon(3) onkeypress="if (event.key==\'Enter\') p10setIcon(3)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i4 onclick=p10setIcon(4) onkeypress="if (event.key==\'Enter\') p10setIcon(4)"></div><br /><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i5 onclick=p10setIcon(5) onkeypress="if (event.key==\'Enter\') p10setIcon(5)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i6 onclick=p10setIcon(6) onkeypress="if (event.key==\'Enter\') p10setIcon(6)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i7 onclick=p10setIcon(7) onkeypress="if (event.key==\'Enter\') p10setIcon(7)"></div><div tabindex=0 style="display:inline-block;margin:0 10px 0 10px" class=i8 onclick=p10setIcon(8) onkeypress="if (event.key==\'Enter\') p10setIcon(8)"></div><br /><br /></div>'),showModal("xxAddAgentModal","idx_dlgOkButton"),QV("id_dialogclose",!0)}}function p10setIcon(e){setDialogMode(0),meshserver.send({action:"changedevice",nodeid:currentNode._id,icon:e})}function showClearSshDialog(){setModalContent("xxAddAgent","Редактировать устройство","Clear SSH credentials?"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showClearSshDialogEx(3))}function showClearSshDialogEx(e,t){meshserver.send({action:"changedevice",nodeid:currentNode._id,ssh:0})}function showClearRdpDialog(){setModalContent("xxAddAgent","Редактировать устройство","Clear RDP credentials?"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showClearRdpDialogEx(3))}function showClearRdpDialogEx(e,t){meshserver.send({action:"changedevice",nodeid:currentNode._id,rdp:0})}var desktopNode,showEditNodeValueDialog_modes=["Имя устройства","Имя хоста","Описание","Теги"],showEditNodeValueDialog_modes2=["name","host","desc","tags"],showEditNodeValueDialog_modes3=["","","","Тег1, Тег2, Тег3"],showEditNodeValueDialog_modes4=[64,64,64,4096];function showEditNodeValueDialog(e){if(!xxdialogMode){var t="",n="",o=currentNode[showEditNodeValueDialog_modes2[e]];if(null==o&&(o=""),3==e){t="<select id=dp10devicevalue multiple maxlength="+showEditNodeValueDialog_modes4[e]+" class=form-control>";var i=[];for(var a in nodes)if(nodes[a].tags)for(var s in nodes[a].tags)-1==i.indexOf(nodes[a].tags[s])&&i.push(nodes[a].tags[s]);if(i.length>0)for(var a in i.sort(),i)n+=Array.isArray(o)&&-1!==o.indexOf(i[a])?"<option selected=selected>"+EscapeHtml(i[a])+"</option>":"<option>"+EscapeHtml(i[a])+"</option>";setModalContent("xxAddAgent","Edit Tags",t+=n+"</select>"),$("#dp10devicevalue").select2({theme:"bootstrap-5",width:$(this).data("width")?$(this).data("width"):$(this).hasClass("w-100")?"100%":"style",placeholder:showEditNodeValueDialog_modes3[e],closeOnSelect:!1,allowClear:!0,tokenSeparators:[","],tags:!0})}else setModalContent("xxAddAgent","Редактировать устройство",t=addHtmlFormFloating(showEditNodeValueDialog_modes[e],'<input id=dp10devicevalue class="form-control" maxlength='+showEditNodeValueDialog_modes4[e]+' placeholder="'+showEditNodeValueDialog_modes3[e]+'" onchange=p10editdevicevalueValidate('+e+",event) onkeyup=p10editdevicevalueValidate("+e+",event) class=form-control/>")),Array.isArray(o)&&(o=o.join(", ")),Q("dp10devicevalue").value=o;p10editdevicevalueValidate(),showModal("xxAddAgentModal","idx_dlgOkButton",function(){showEditNodeValueDialogEx(3,e)}),Q("dp10devicevalue").focus()}}function showEditNodeValueDialogEx(e,t){var n="",o={action:"changedevice",nodeid:currentNode._id};if(3==t){var i=$("#dp10devicevalue").select2("data");for(var a in i)n+=i[a].text.trim()+", ";o[showEditNodeValueDialog_modes2[t]]=decodeURIComponent(n.slice(0,-2))}else o[showEditNodeValueDialog_modes2[t]]=Q("dp10devicevalue").value;meshserver.send(o)}function p10editdevicevalueValidate(e,t){var n=e>1||Q("dp10devicevalue").value.length>0;QE("idx_dlgOkButton",n),null!=t&&1==n&&13==t.keyCode&&dialogclose(1)}function setupDesktop(){if(desktopNode!=currentNode&&null!=desktop&&desktopNode._id!=currentNode._id&&(desktop.Stop(),desktopNode=null,desktop=null),desktopNode!=currentNode||null==desktop){var e=multiDesktop[currentNode._id];if(null!=e){QH("DeskParent","");var t=e.m.CanvasId;t.setAttribute("id","Desk"),t.setAttribute("onmousedown","dmousedown(event)"),t.setAttribute("onmouseup","dmouseup(event)"),t.setAttribute("onmousemove","dmousemove(event)"),t.removeAttribute("onclick"),Q("DeskParent").appendChild(t),(desktop=e).m.SendCompressionLevel&&desktop.m.SendCompressionLevel(desktopsettings.agentencoding,desktopsettings.quality,desktopsettings.scaling,desktopsettings.framerate),desktop.onStateChanged=onDesktopStateChange,desktop.onMetadataChange=function(e){updateMetadata(desktop,"deskmetadata")},8192&features2&&(desktop.m.stopInput=!0),desktop&&desktop.m.mouseCursorActive&&desktop.m.mouseCursorActive(!0),QV("DeskInputLockedButton",1==desktop.m.RemoteInputLock),QV("DeskInputUnLockedButton",0==desktop.m.RemoteInputLock),desktop.m.onRemoteInputLockChanged=function(e,t){QV("DeskInputLockedButton",t),QV("DeskInputUnLockedButton",!t)},desktop.m.onKeyboardStateChanged=function(e,t){QS("p11numlock").display=1&t?"inline-block":"none",QS("p11scrolllock").display=2&t?"inline-block":"none",QS("p11capslock").display=4&t?"inline-block":"none"},desktopNode=currentNode,onDesktopStateChange(desktop,desktop.State),delete multiDesktop[currentNode._id]}else null==desktop&&QH("DeskParent",'<canvas id=Desk oncontextmenu="return false" onmousedown=dmousedown(event) onmouseup=dmouseup(event) onmousemove=dmousemove(event)></canvas>'),desktopNode=currentNode;Q("Desk").addEventListener("DOMMouseScroll",function(e){return dmousewheel(e)}),Q("Desk").addEventListener("mousewheel",function(e){return dmousewheel(e)})}desktopNode=currentNode,desktop&&(desktop.m.onDisplayinfo=deskDisplayInfo,deskDisplayInfo(desktop.m,desktop.m.displays,desktop.m.selectedDisplay)),updateDesktopButtons(),deskAdjust(),updateMetadata(desktop,"deskmetadata")}function updateDesktopButtons(){var e=0;null!=desktop&&(e=desktop.State);var t=GetNodeRights(currentNode),n=1==currentNode.agent?1:2;QV("disconnectbutton1span",0!=e),QV("connectbutton1span",0==e&&(8&t||256&t)&&null!=currentNode.agent&&1&currentNode.agent.caps),QV("connectbutton1rspan",!(1073741824&features)&&0==e&&8&t&&null!=currentNode.agent&&(3==currentNode.agent.id||4==currentNode.agent.id)),1==n?QV("connectbutton1hspan",0==e&&8&t&&null!=currentNode.intelamt&&2==currentNode.intelamt.state):QV("connectbutton1hspan",0==e&&8&t&&null!=currentNode.intelamt&&2==currentNode.intelamt.state&&null!=currentNode.intelamt.ver&&(null==currentNode.intelamt.sku||"number"==typeof currentNode.intelamt.sku&&!!(8&currentNode.intelamt.sku))),QV("td7amtkvm",!(null==currentNode.intelamt||"number"==typeof currentNode.intelamt.sku&&16&currentNode.intelamt.sku||null==currentNode.intelamt.ver&&null!=currentNode.agent||0!=e&&2!=desktop.contype)),QV("td7meshkvm",webRtcDesktop||null!=currentNode.agent&&1&currentNode.agent.caps&&(0==e||1==desktop.contype)),QV("td7rdpkvm",!(null==currentNode.agent||3!=currentNode.agent.id&&4!=currentNode.agent.id||0!=e&&4!=desktop.contype));var o=!(8192&features2||null!=currentNode.agent&&14==currentNode.agent.id||4294967295!=t&&(!(8&t)||256&t||4096&t)),i=!!(1&currentNode.conn);QE("connectbutton1",i),QE("connectbutton1d",i),QE("connectbutton1r",i||3==currentNode.mtype),QE("connectbutton1rd",i||3==currentNode.mtype),currentNode.rdpport&&3389!=currentNode.rdpport?QH("desktopCustomUpperRight",'<a style="cursor:pointer;line-height:22px" onclick="cmaltportaction(1,event)">'+format("RDP Port {0}",currentNode.rdpport?currentNode.rdpport:3389)+"</a>"):QH("desktopCustomUpperRight","");var a=!!(6&currentNode.conn);QE("connectbutton1h",a),QV("deskFocusBtn",null!=desktop&&2==desktop.contype&&0!=e&&desktopsettings.showfocus),QE("DeskClip",3==e),QV("DeskClip",o&&currentNode.agent&&!!(6144&~features2)&&11!=currentNode.agent.id&&16!=currentNode.agent.id&&(null==desktop||2!=desktop.contype)&&(1!=desktopsettings.autoclipboard||null==navigator.clipboard||null==navigator.clipboard.readText)),QE("DeskESC",3==e&&4!=desktop.contype),QV("DeskESC",browserfullscreen&&o),QE("DeskType",3==e),QV("DeskType",o),QE("DeskWD",3==e),QV("DeskWD",o),QV("deskkeys",o),QE("deskkeys",null!=desktop),QV("DeskTimer",3==e),QV("DeskLatency",3==e),QS("DeskLatency").display=3==e?"inline-block":"none";var s=desktop&&4==desktop.contype?desktopsettings.rdpautoclipboard:desktopsettings.autoclipboard;QV("DeskClipboardOutButton",i&&o&&null!=desktop&&!(4096&features2)&&null!=navigator.clipboard&&null!=navigator.clipboard.readText&&(1!=s||null==navigator.clipboard||null==navigator.clipboard.readText)),QV("d7deskAutoClipboardLabel",null!=navigator.clipboard.readText&&!(4096&features2)),QV("DeskClipboardInButton",i&&o&&null!=desktop&&!(2048&features2)&&null!=navigator.clipboard&&null!=navigator.clipboard.writeText&&(1!=s||null==navigator.clipboard||null==navigator.clipboard.readText)),3!=e&&(QV("DeskInputLockedButton",!1),QV("DeskInputUnLockedButton",!1),QV("p11numlock",!1),QV("p11scrolllock",!1),QV("p11capslock",!1)),QV("DeskRunButton",!!(131072&t)&&i),QV("DeskSaveImageButton",3==e&&null!=Q("Desk").toBlob&&!(1024&features2)),QV("DeskRecordButton",3==e&&null!=Q("Desk").toBlob&&null!=desktop.m.StartRecording&&!(1024&features2)),QV("DeskChatButton",!!(16384&t)&&0==browserfullscreen&&currentNode.agent&&i),QV("DeskNotifyButton",!!(16384&t)&&0==browserfullscreen&&currentNode.agent&&i),QV("DeskLockButton",!!(16384&t)&&0==browserfullscreen&&currentNode.agent&&currentNode.agent.id<5&&o&&3==e),QV("DeskToolsButton",currentNode.agent&&i),QE("DeskToolsButton",o),QV("DeskOpenWebButton",0==browserfullscreen&&o&&currentNode.agent&&i),QV("DeskBackgroundButton",o&&3==e&&1==desktop.contype&&currentNode.agent&&11!=currentNode.agent.id&&16!=currentNode.agent.id&&i),QV("DeskControlSpan",o),QV("DeskRefreshButton",3==e&&1==desktop.contype),Q("DeskControl").checked=!!(8&t)&&1==getstore("DeskControl",1),QS("DeskControlSpan").color=Q("DeskControl").checked?null:"red",0==i&&QV("DeskTools",!1)}var autoConnectDesktopTimer=null;function autoConnectDesktop(e){null==autoConnectDesktopTimer?autoConnectDesktopTimer=setInterval(function(){connectDesktop(null,1)},1e3):(clearInterval(autoConnectDesktopTimer),autoConnectDesktopTimer=null)}var agentConsoleMessages=["","Ожидание предоставления доступа пользователем ...","Отказано","Не удалось запустить сеанс удаленного терминала, {0} ({1})","Тайм-аут","Получены неверные сетевые данные","Невозможно захватить изображение","Ошибка согласования протокола ({0})","NLA не поддерживается","SSL требуется сервером","SSL не разрешен сервером","SSL-сертификат не на сервере","Несоответствие флагов","Cервер требует гибридный режим","SSL с аутентификацией пользователя, требуется сервером"];function formatAgentConsoleMessage(e,t,n){for(null==n&&(n=[]);n.length<3;)n.push("");return(t&&t<agentConsoleMessages.length?EscapeHtml(format(agentConsoleMessages[t],n[0],n[1],n[2])):EscapeHtml(e)).split("\n").join("<br />")+"<br /><br />"}function connectDesktop(e,t,n,o){if(!xxdialogMode)if(null!=e&&0!=e.shiftKey&&3==t&&(t=1),QV("p11DeskSessionSelector",!1),p11clearConsoleMsg(),null==desktop)if(desktopNode=currentNode,2==t){if(null==desktopNode.intelamt.user||""==desktopNode.intelamt.user)return void editDeviceAmtSettings(desktopNode._id,connectDesktop,2);(desktop=CreateAmtRedirect(CreateAmtRemoteDesktop("Desk"),authCookie)).debugmode=debugmode,desktop.onStateChanged=onDesktopStateChange,desktop.m.bpp=1==desktopsettings.encoding||3==desktopsettings.encoding?1:2,desktop.m.useZRLE=desktopsettings.encoding<3,desktop.m.localKeyMap=desktopsettings.localkeymap,desktop.m.ReverseMouseWheel=desktopsettings.kvmrmw,desktop.m.showmouse=desktopsettings.showmouse,desktop.m.onScreenSizeChange=deskAdjust,desktop.m.onKvmData=function(e){if(0!=e.length){var t=null;try{t=JSON.parse(e)}catch(e){}if(null!=t&&null!=t.action)if("restart"==t.action)webRtcDesktopReset(),desktop.m.sendKvmData(JSON.stringify({action:"present",ver:1}));else if("present"==t.action&&null==webRtcDesktop){webRtcDesktop={platform:t.platform};"undefined"!=typeof RTCPeerConnection?webRtcDesktop.webrtc=new RTCPeerConnection(null):"undefined"!=typeof webkitRTCPeerConnection&&(webRtcDesktop.webrtc=new webkitRTCPeerConnection(null)),webRtcDesktop.webchannel=webRtcDesktop.webrtc.createDataChannel("DataChannel",{}),webRtcDesktop.webchannel.onopen=function(){console.log("WebRTC Data Channel Open"),Q("deskstatus").textContent=StatusStrs[desktop.State]+", Soft-KVM",desktop.m.hold(!0),webRtcDesktop.webRtcActive=!0,webRtcDesktop.softdesktop=CreateKvmDataChannel(webRtcDesktop.webchannel,CreateAgentRemoteDesktop("Desk",Q("id_mainarea")),desktop.m),webRtcDesktop.softdesktop.m.setRotation(desktop.m.rotation),webRtcDesktop.softdesktop.m.onScreenSizeChange=deskAdjust,webRtcDesktop.softdesktop.m.ImageType=webpSupport?4:1,desktopsettings.quality&&(webRtcDesktop.softdesktop.m.CompressionLevel=desktopsettings.quality),desktopsettings.scaling&&(webRtcDesktop.softdesktop.m.ScalingLevel=desktopsettings.scaling),webRtcDesktop.softdesktop.Start()},webRtcDesktop.webchannel.onclose=function(e){console.log("WebRTC Data Channel Closed"),webRtcDesktopReset()},webRtcDesktop.webrtc.onicecandidate=function(e){null==e.candidate?desktop.m.sendKvmData(JSON.stringify({action:"offer",ver:1,sdp:webRtcDesktop.webrtcoffer.sdp})):webRtcDesktop.webrtcoffer.sdp+="a="+e.candidate.candidate+"\r\n"},webRtcDesktop.webrtc.oniceconnectionstatechange=function(){null==webRtcDesktop||null==webRtcDesktop.webrtc||"disconnected"!=webRtcDesktop.webrtc.iceConnectionState&&"failed"!=webRtcDesktop.webrtc.iceConnectionState||webRtcDesktopReset()},webRtcDesktop.webrtc.createOffer(function(e){webRtcDesktop.webrtcoffer=e,webRtcDesktop.webrtc.setLocalDescription(e,function(){},webRtcDesktopReset)},webRtcDesktopReset,{mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}})}else"answer"==t.action&&null!=webRtcDesktop&&webRtcDesktop.webrtc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:t.sdp}),function(){},webRtcDesktopReset)}else desktop.m._sentPresence||(desktop.m._sentPresence=!0,desktop.m.sendKvmData(JSON.stringify({action:"present",ver:1})))},4==desktopNode.conn&&null!=desktopNode.intelamt&&1==desktopNode.intelamt.tls?desktop.Start(desktopNode._id,16995,"*","*",1):desktop.Start(desktopNode._id,16994,"*","*",0),desktop.contype=2}else null==t||1==t||3==t&&currentNode.agent.id>4&&null==debugmode?((desktop=CreateAgentRedirect(meshserver,CreateAgentRemoteDesktop("Desk"),serverPublicNamePort,authCookie,authRelayCookie,domainUrl)).m.UseExtendedKeyFlag=desktopNode.agent.id<5,desktop.m.mouseCursorActive(11==xxcurrentView),desktop.debugmode=debugmode,desktop.m.debugmode=debugmode,desktop.attemptWebRTC=attemptWebRTC,desktop.webrtcconfig=webrtcconfiguration,desktop.options={},null!=n&&(desktop.options.tsid=n),null!=o&&(desktop.options.consent=o),1==desktopsettings.autolock&&(desktop.options.autolock=!0),desktop.onStateChanged=onDesktopStateChange,8192&features2&&(desktop.m.stopInput=!0),desktop.m.onRemoteInputLockChanged=function(e,t){QV("DeskInputLockedButton",t),QV("DeskInputUnLockedButton",!t)},desktop.m.onKeyboardStateChanged=function(e,t){QS("p11numlock").display=1&t?"inline-block":"none",QS("p11scrolllock").display=2&t?"inline-block":"none",QS("p11capslock").display=4&t?"inline-block":"none"},desktop.onConsoleMessageChange=function(){desktop.consoleMessage?(Q("p11DeskConsoleMsg").innerHTML+=formatAgentConsoleMessage(desktop.consoleMessage,desktop.consoleMessageId,desktop.consoleMessageArgs),QV("p11DeskConsoleMsg",!0),null!=p11DeskConsoleMsgTimer&&clearTimeout(p11DeskConsoleMsgTimer),desktop.consoleMessageTimeout&&(p11DeskConsoleMsgTimer=setTimeout(p11clearConsoleMsg,1e3*desktop.consoleMessageTimeout))):p11clearConsoleMsg()},desktop.onMetadataChange=function(e){updateMetadata(desktop,"deskmetadata")},desktop.m.ImageType=desktopsettings.agentencoding,desktop.m.CompressionLevel=desktopsettings.quality,desktop.m.ScalingLevel=desktopsettings.scaling,desktopsettings.framerate&&(desktop.m.FrameRateTimer=desktopsettings.framerate),desktopsettings.swapmouse&&(desktop.m.SwapMouse=desktopsettings.swapmouse),desktopsettings.rmw&&(desktop.m.ReverseMouseWheel=desktopsettings.rmw),1==desktopsettings.remotekeymap&&(desktop.m.remoteKeyMap=desktopsettings.remotekeymap),desktop.m.onScreenSizeChange=deskAdjust,desktop.Start(desktopNode._id),desktop.latency.callback=function(e){updateSessionTime()},desktop.contype=1):3==t?meshserver.send({action:"msg",type:"userSessions",nodeid:currentNode._id,tag:o}):4==t&&((desktop=CreateRDPDesktop("Desk",domainUrl)).onStateChanged=onDesktopStateChange,desktop.m.onScreenSizeChange=mdeskAdjust,desktop.m.onClipboardChanged=function(e){null!=e&&desktopsettings.rdpautoclipboard&&null!=navigator.clipboard&&navigator.clipboard.writeText(e).then(function(){}).catch(function(e){console.log(e)})},desktopsettings.rdpsmb&&(desktop.m.SwapMouse=desktopsettings.rdpsmb),desktopsettings.rdprmw&&(desktop.m.ReverseMouseWheel=desktopsettings.rdprmw),desktop.Start(desktopNode._id,currentNode.rdpport?currentNode.rdpport:3389,n),desktop.contype=4,desktop.onConsoleMessageChange=function(){desktop.consoleMessage?(Q("p11DeskConsoleMsg").innerHTML+=formatAgentConsoleMessage(desktop.consoleMessage,desktop.consoleMessageId,desktop.consoleMessageArgs),QV("p11DeskConsoleMsg",!0),null!=p11DeskConsoleMsgTimer&&clearTimeout(p11DeskConsoleMsgTimer),desktop.consoleMessageTimeout&&(p11DeskConsoleMsgTimer=setTimeout(p11clearConsoleMsg,1e3*desktop.consoleMessageTimeout))):p11clearConsoleMsg()});else desktop.Stop(),webRtcDesktopReset(),desktopNode=desktop=null,null!=pluginHandler&&pluginHandler.callHook("onDesktopDisconnect")}function askRdpCredentials(){if(!xxdialogMode){var e="<div>";1==currentNode.rdp?(e+=addHtmlFormFloating("Учетные данные",'<select id=d2mode class="form-select" onchange=askRdpCredentialsValidate()><option value=1>Использовать учетные данные сервера</option><option value=2>Использовать новые учетные данные</option></select>'),e+="<div id=d2cred style=display:none>"):e+="<div id=d2cred>",e+=addHtmlFormFloating("Домен",'<input type=text id=d2domain class="form-control" maxlength=128 />'),e+=addHtmlFormFloating("Имя пользователя",'<input type=text id=d2user class="form-control" onKeyUp=askRdpCredentialsValidate() maxlength=128 />'),e+=addHtmlFormFloating("Пароль",'<input type=password id=d2pass class="form-control" maxlength=128 autocomplete=off />'),4194304&features2||(e+=addHtmlValue("",'<label><input type="checkbox" class="form-check-input me-2" id=d2savecred>Запомнить учетные данные</label>')),e+="</div>",e+=MoreStart(),e+=addHtmlFormFloating("Альтернативная оболочка",'<input type=text id=d2altshell class="form-control" maxlength=2048 />'),e+=addHtmlFormFloating("Рабочий каталог",'<input type=text id=d2workdir class="form-control" maxlength=2048 />'),setModalContent("xxAddAgent","Учетные данные RDP",e+=MoreEnd()),showModal("xxAddAgentModal","idx_dlgOkButton",()=>askRdpCredentialsEx())}}function askRdpCredentialsValidate(){1!=currentNode.rdp||(QV("d2cred",2==Q("d2mode").value),1!=Q("d2mode").value)?QE("idx_dlgOkButton",""!=Q("d2user").value):QE("idx_dlgOkButton",!0)}function askRdpCredentialsEx(){var e=null,t=null;if(desktopsettings.rdpsize)if("browser"==desktopsettings.rdpsize)e=window.innerWidth,t=window.innerHeight;else if("screen"==desktopsettings.rdpsize)e=window.screen.width,t=window.screen.height;else if("canvas"==desktopsettings.rdpsize)e=Q("DeskParent").offsetWidth,t=Q("DeskParent").offsetHeight;else{var n=desktopsettings.rdpsize.indexOf("x");n>=1&&(e=parseInt(desktopsettings.rdpsize.substring(0,n)),t=parseInt(desktopsettings.rdpsize.substring(n+1)))}else e=Q("DeskParent").offsetWidth,t=Q("DeskParent").offsetHeight;if(1==currentNode.rdp&&1==Q("d2mode").value)connectDesktop(null,4,{servercred:!0,width:e,height:t,flags:null!=desktopsettings.rdpflags?desktopsettings.rdpflags:47,altshell:Q("d2altshell").value,workdir:Q("d2workdir").value});else{var o=!1;4194304&features2||(o=Q("d2savecred").checked),connectDesktop(null,4,{domain:Q("d2domain").value,username:Q("d2user").value,password:Q("d2pass").value,savecred:o,width:e,height:t,flags:null!=desktopsettings.rdpflags?desktopsettings.rdpflags:47,altshell:Q("d2altshell").value,workdir:Q("d2workdir").value})}}function updateMetadata(e,t){var n="",o=0;if(e&&3==e.State){if(e.metadata&&e.metadata.users)for(var i in e.metadata.users)o+=e.metadata.users[i];o>1&&(n="<span onclick=showSessionMetadata(1) style=cursor:pointer>"+format(", {0} смотрят",o)+"</span>")}QH("deskmetadata",n),e==desktop&&"sessionMetadata1"==xxdialogTag&&showSessionMetadata(1)}function showSessionMetadata(e){if(!xxdialogMode||xxdialogTag=="sessionMetadata"+e){xxdialogMode&&setDialogMode(0);var t=null;if(1==e&&(t=desktop),t&&t.metadata){var n="";if(t.metadata.startTime&&(n+=addHtmlValue4("Время начала",printDateTime(new Date(t.metadata.startTime)))),t.metadata.users)for(var o in t.metadata.users){var i=1==t.metadata.users[o]?"1 соединение":format("{0} подключений",t.metadata.users[o]);n+=addHtmlValue2(getUserName(o),i)}xxdialogTag="sessionMetadata"+e,setModalContent("xxAddAgent","Информация о сеансе",n),showModal("xxAddAgentModal","idx_dlgOkButton")}}}function p11clearConsoleMsg(){QH("p11DeskConsoleMsg",""),QV("p11DeskConsoleMsg",!1),p11DeskConsoleMsgTimer&&(clearTimeout(p11DeskConsoleMsgTimer),p11DeskConsoleMsgTimer=null)}function p12clearConsoleMsg(){QH("p12TermConsoleMsg",""),QV("p12TermConsoleMsg",!1),p12TermConsoleMsgTimer&&(clearTimeout(p12TermConsoleMsgTimer),p12TermConsoleMsgTimer=null)}function p13clearConsoleMsg(){QH("p13FilesConsoleMsg",""),QV("p13FilesConsoleMsg",!1),p13FilesConsoleMsgTimer&&(clearTimeout(p13FilesConsoleMsgTimer),p13FilesConsoleMsgTimer=null)}function p12setConsoleMsg(e,t){e?(Q("p12TermConsoleMsg").innerHTML+=e,QV("p12TermConsoleMsg",!0),null!=p12TermConsoleMsgTimer&&clearTimeout(p12TermConsoleMsgTimer),t&&(p12TermConsoleMsgTimer=setTimeout(p12clearConsoleMsg,t))):p12clearConsoleMsg()}function p13setConsoleMsg(e,t){e?(Q("p13FilesConsoleMsg").innerHTML+=e,QV("p13FilesConsoleMsg",!0),null!=p13FilesConsoleMsgTimer&&clearTimeout(p13FilesConsoleMsgTimer),t&&(p13FilesConsoleMsgTimer=setTimeout(p13clearConsoleMsg,t))):p13clearConsoleMsg()}var webRtcDesktop=null;function webRtcDesktopReset(){if(null!=webRtcDesktop){if(null!=webRtcDesktop.softdesktop&&(webRtcDesktop.softdesktop.Stop(),webRtcDesktop.softdesktop=null),null!=webRtcDesktop.webchannel){try{webRtcDesktop.webchannel.close()}catch(e){}webRtcDesktop.webchannel=null}if(null!=webRtcDesktop.webrtc){try{webRtcDesktop.webrtc.close()}catch(e){}webRtcDesktop.webrtc=null}webRtcDesktop=null,desktop&&desktop.m&&(desktop.m.hold(!1),Q("deskstatus").textContent=StatusStrs[desktop.State])}}function onDesktopStateChange(e,t){var n=t;3==n&&2==e.contype&&n++;var o=StatusStrs[n];switch(null!=desktop&&1==desktop.webRtcActive&&(o+=", WebRTC"),null!=desktop&&3==n&&4==desktop.contype&&(o+=", RDP"),QH("deskstatus",o),t){case 0:null!=desktop&&(null!=desktop.m.recordedData&&deskRecordSession(),desktop.Stop()),desktopNode=desktop=null,QV("DeskFocus",!1),QV("DeskMonitorSelectionSpan",!1),QV("deskRecordIcon",!1),QV("DeskInputLockedButton",!1),QV("DeskInputUnLockedButton",!1),deskFocusBtn.value="Фокусирование всех",1==fullscreen&&deskToggleFull(),webRtcDesktopReset(),deskPreferedStickyDisplay=0;break;case 2:default:break;case 3:desktop&&1==desktop.serverIsRecording&&QV("deskRecordIcon",!0),desktop.startTime=new Date,deskLastClipboardSent=null,null==updateSessionTimer&&(updateSessionTimer=setInterval(updateSessionTime,1e3))}updateDesktopButtons(),deskAdjust(),setTimeout(deskAdjust,50),updateMetadata(desktop,"deskmetadata")}function updateSessionTime(){var e="",t=0;if(desktop&&desktop.startTime){if(desktop.latency&&desktop.latency.current>=0&&(e=format("{0} ms",desktop.latency.current)),t=Math.floor((new Date-desktop.startTime)/1e3),QH("DeskTimer",zeroPad(Math.floor(t/3600),2)+":"+zeroPad(Math.floor(t/60)%60,2)+":"+zeroPad(t%60,2)),QH("DeskLatency",e),(4!=desktop.contype&&!0===desktopsettings.autoclipboard||4==desktop.contype&&!0===desktopsettings.rdpautoclipboard)&&null!=navigator.clipboard&&null!=navigator.clipboard.readText){if("firefox"==Mstsc.browser())return;try{navigator.clipboard.readText().then(function(e){null!=desktop&&null!=e&&deskLastClipboardSent!=e&&(desktop.m.setClipboard?desktop.m.setClipboard(e):(console.log("s3"),meshserver.send({action:"msg",type:"setclip",nodeid:currentNode._id,data:e})),deskLastClipboardSent=e)}).catch(function(e){})}catch(e){console.log(e)}}}else QH("DeskTimer",""),QH("DeskLatency","");t=0,terminal&&terminal.startTime?(terminal.latency&&terminal.latency.current>=0&&(e=format("{0} ms, ",terminal.latency.current)),t=Math.floor((new Date-terminal.startTime)/1e3),QH("TermTimer",e+zeroPad(Math.floor(t/3600),2)+":"+zeroPad(Math.floor(t/60)%60,2)+":"+zeroPad(t%60,2))):QH("TermTimer",""),null==desktop&&null==terminal&&(clearInterval(updateSessionTimer),updateSessionTimer=null)}function showDesktopSettings(){if(!xxdialogMode){applyDesktopSettings(),updateDesktopButtons();var e=!1;("none"!=QS("td7meshkvm").display&&Q("td7meshkvm").className.indexOf("active")>0||"none"!=QS("td7rdpkvm").display&&Q("td7rdpkvm").className.indexOf("active")>0||"none"!=QS("td7amtkvm").display&&Q("td7amtkvm").className.indexOf("active")>0)&&(e=!0),0==e&&("none"!=QS("td7meshkvm").display?changeDesktopSettingsTab(null,"d7meshkvm"):"none"!=QS("td7rdpkvm").display?changeDesktopSettingsTab(null,"d7rdpkvm"):"none"!=QS("td7amtkvm").display&&changeDesktopSettingsTab(null,"d7amtkvm")),xxdialogButtons=3,setModalContent("xxAddAgent","Настройки удаленного рабочего стола",7),showModal("xxAddAgentModal","idx_dlgOkButton",showDesktopSettingsChanged)}}function changeDesktopSettingsTab(e,t){var n,o,i;for(o=document.getElementsByClassName("tabcontent"),n=0;n<o.length;n++)o[n].style.display="none";for(i=document.getElementsByClassName("tablinks"),n=0;n<i.length;n++)i[n].className=i[n].className.replace(" active","");document.getElementById(t).style.display="block",null!=e?e.currentTarget.className+=" active":document.getElementById("t"+t).className+=" active"}function showDesktopSettingsChanged(){desktopsettings.encoding=d7desktopmode.value,desktopsettings.showfocus=d7showfocus.checked,desktopsettings.showmouse=d7showcursor.checked,desktopsettings.quality=d7bitmapquality.value,desktopsettings.scaling=d7bitmapscaling.value,desktopsettings.framerate=d7framelimiter.value,desktopsettings.agentencoding=d7encoding.value,desktopsettings.swapmouse=d7deskSwapMouse.checked,desktopsettings.rmw=d7deskrmw.checked,desktopsettings.remotekeymap=d7deskRemoteKeyMap.checked,desktopsettings.autoclipboard=d7deskAutoClipboard.checked,desktopsettings.autolock=d7deskAutoLock.checked,desktopsettings.localkeymap=d7localKeyMap.checked,desktopsettings.kvmrmw=d7kvmrmw.checked,desktopsettings.rdpsize=d7rdpsize.value,desktopsettings.rdpsmb=d7rdpsmb.checked,desktopsettings.rdprmw=d7rdprmw.checked,desktopsettings.rdpautoclipboard=d7rdpclip.checked;for(var e=0,t=1;t<10;t++)5!=t&&Q("d7rdp"+t).checked&&(e|=1<<t-1);desktopsettings.rdpflags=e,putstore("desktopsettings",JSON.stringify(desktopsettings)),applyDesktopSettings(),updateDesktopButtons(),desktop&&(1==desktop.contype&&(desktop.m.SwapMouse=desktopsettings.swapmouse,desktop.m.ReverseMouseWheel=desktopsettings.rmw,desktop.m.remoteKeyMap=desktopsettings.remotekeymap,0!=desktop.State&&(desktop.m.SendCompressionLevel(desktopsettings.agentencoding,desktopsettings.quality,desktopsettings.scaling,desktopsettings.framerate),desktop.sendCtrlMsg('{"ctrlChannel":"102938","type":"autolock","value":'+desktopsettings.autolock+"}"),desktop.m.SendRefresh())),2==desktop.contype&&(desktop.m.ReverseMouseWheel=desktopsettings.kvmrmw,0==desktopsettings.showfocus&&(desktop.m.focusmode=0,deskFocusBtn.value="Фокусирование всех"),0!=desktop.State&&(desktop.Stop(),setTimeout(function(){connectDesktop(null,2)},50))),4==desktop.contype&&(desktop.m.SwapMouse=desktopsettings.rdpsmb,desktop.m.ReverseMouseWheel=desktopsettings.rdprmw))}function applyDesktopSettings(){var e="",t=512&features?[100,90,80,70,60,50,40,30,20,10,5,1]:[60,50,40,30,20,10,5,1];for(var n in t)e+="<option value="+t[n]+">"+t[n]+"%</option>";QH("d7bitmapquality",e),d7desktopmode.value=desktopsettings.encoding,d7showfocus.checked=desktopsettings.showfocus,d7showcursor.checked=desktopsettings.showmouse,desktopsettings.agentencoding?d7encoding.value=desktopsettings.agentencoding:desktopsettings.agentencoding=4,d7bitmapquality.value=40,t.indexOf(parseInt(desktopsettings.quality))>=0&&(d7bitmapquality.value=desktopsettings.quality),d7bitmapscaling.value=desktopsettings.scaling,desktopsettings.framerate?d7framelimiter.value=desktopsettings.framerate:d7framelimiter.value=100,null!=desktopsettings.swapmouse&&(d7deskSwapMouse.checked=desktopsettings.swapmouse),null!=desktopsettings.rmw&&(d7deskrmw.checked=desktopsettings.rmw),null!=desktopsettings.remotekeymap&&(d7deskRemoteKeyMap.checked=desktopsettings.remotekeymap),null!=desktopsettings.autoclipboard&&(d7deskAutoClipboard.checked=desktopsettings.autoclipboard),null!=desktopsettings.autolock&&(d7deskAutoLock.checked=desktopsettings.autolock),desktopsettings.localkeymap&&(d7localKeyMap.checked=desktopsettings.localkeymap),desktopsettings.kvmrmw&&(d7kvmrmw.checked=desktopsettings.kvmrmw),QV("deskFocusBtn",null!=desktop&&2==desktop.contype&&0!=desktop.state&&desktopsettings.showfocus),null!=desktopsettings.rdpsize&&(d7rdpsize.value=desktopsettings.rdpsize),null==desktopsettings.rdpflags&&(desktopsettings.rdpflags=47),null!=desktopsettings.rdpsmb&&(d7rdpsmb.checked=desktopsettings.rdpsmb),null!=desktopsettings.rdprmw&&(d7rdprmw.checked=desktopsettings.rdprmw),null!=desktopsettings.rdpautoclipboard&&(d7rdpclip.checked=desktopsettings.rdpautoclipboard);for(n=1;n<10;n++)5!=n&&(Q("d7rdp"+n).checked=!!(desktopsettings.rdpflags&1<<n-1))}function enterBrowserFullscreen(e){navigator.keyboard&&navigator.keyboard.lock&&navigator.keyboard.lock(),e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}function exitBrowserFullscreen(){document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),navigator.keyboard&&navigator.keyboard.unlock&&navigator.keyboard.unlock()}function isBrowserFullscreen(){return!!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement)}var fullscreen=!1,browserfullscreen=!1;function deskToggleFull(e){var t=!(0===args.xterm||null!=terminal&&null==xterm);if(fullscreen=!fullscreen)QC("body").add("fulldesk"),QS("deskarea3x").height="100%",QS("deskarea3x")["max-height"]="100%",t?(QS("termTable").position="absolute",QS("termTable").top=QS("termTable").bottom=QS("termTable").left=QS("termTable").right="0"):(QS("termTable").height="100%",QS("termTable")["max-height"]="100%"),1==e.shiftKey&&(enterBrowserFullscreen(Q("body")),browserfullscreen=!0);else{QC("body").remove("fulldesk");var n=args.hide;0==footerBar&&(n|=4);var o=(1&n?0:66)+(2&n?0:24)+(4&n?0:45)+(8&n?0:60);QS("deskarea3x").height="calc(100vh - "+(75+o)+"px)",QS("deskarea3x")["max-height"]="calc(100vh - "+(75+o)+"px)",t?(QS("termTable").position=null,QS("termTable").top=QS("termTable").bottom=QS("termTable").left=QS("termTable").right=null):(QS("termTable").height="calc(100vh - "+(75+o)+"px)",QS("termTable")["max-height"]="calc(100vh - "+(75+o)+"px)"),1==browserfullscreen&&(exitBrowserFullscreen(),browserfullscreen=!1)}deskAdjust(),updateDesktopButtons(),adjustPanels(),null!=xterm&&12==xxcurrentView&&(xtermfit.fit(),xterm.focus())}function deskToggleFocus(){desktop.m.focusmode=(desktop.m.focusmode+64)%192,Q("deskFocusBtn").value=["Фокусирование всех","Малая фокусировка","Большой Фокус"][desktop.m.focusmode/64]}function deskAdjust(){var e=Q("DeskParent").clientHeight,t=Q("DeskParent").clientWidth,n=Q("Desk").height,o=Q("Desk").width;if(2==deskAspectRatio)QS("Desk")["margin-top"]=null,QS("Desk").height="100%",QS("Desk").width="100%",QS("DeskParent").overflow="hidden";else if(1==deskAspectRatio)QS("Desk")["margin-top"]="0px",QS("Desk").height=n+"px",QS("Desk").width=o+"px",QS("DeskParent").overflow="scroll";else{if(e/t>n/o){var i=n*t/o+"px";QS("Desk").height=i,QS("Desk").width="100%"}else{var a=o*e/n+"px";QS("Desk").height=webPageFullScreen||fullscreen?null:"100%",QS("Desk").width=a}QS("Desk")["margin-top"]=null,QS("DeskParent").overflow="hidden"}}function mdeskAdjust(e,t,n,o){if(e&&t&&n&&o){var i=Q("viewselect").value;if(3==i||5==i)if("Desk"!=o.id){if(5==i){var a=[{x:180,y:101},{x:302,y:169},{x:454,y:255}][Q("sizeselect").selectedIndex];QS(o.id).width=(0!=e.State?t*a.y/n:a.x)+"px"}QS(o.id)["margin-top"]=null,QS(o.id)["margin-bottom"]=null}else deskAdjust()}}function sendDeskEsc(){null!=desktop&&3==desktop.State&&(2==desktop.contype?desktop.m.sendkey([[65307,1],[65307,0]]):desktop.m.SendKeyMsgKC([[desktop.m.KeyAction.EXDOWN,27],[desktop.m.KeyAction.EXUP,27]]))}function p11fileDragDrop(e){if(haltEvent(e),QV("p11bigfail",!1),QV("p11bigok",!1),null==xxdialogMode&&null!=desktop&&3==desktop.State&&null!=e.dataTransfer&&0!=e.dataTransfer.files.length){var t=e.dataTransfer.files[0],n=t.name.toLowerCase();if(n.endsWith(".bat")||n.endsWith(".ps1")||n.endsWith(".sh")||n.endsWith(".agentconsole"))d2runCommandDialog({nodeids:[currentNode._id],selectedFile:t});else if(n.endsWith(".txt")){var o=new FileReader;o.onload=function(e){showDeskType(e.target.result)},o.readAsText(t)}}}var p11dragtimer=null;function p11fileDragOver(e){haltEvent(e),null!=p11dragtimer&&(clearTimeout(p11dragtimer),p11dragtimer=null);var t=null==xxdialogMode&&null!=desktop&&3==desktop.State;QV("p11bigok",t),QV("p11bigfail",!t)}function p11fileDragLeave(e){haltEvent(e),"Desk"!=e.target.id?(QV("p11bigfail",!1),QV("p11bigok",!1)):p11dragtimer=setTimeout(function(){QV("p11bigfail",!1),QV("p11bigok",!1),p11dragtimer=null},10)}function updateDeskShortcutKeys(){var e="",t=parseInt(Q("deskkeys").value);for(var n in""==t&&deskKeyboardShortcuts.length>0&&(t=deskKeyboardShortcuts[0]),deskKeyboardShortcuts)e+="<option value="+deskKeyboardShortcuts[n]+(t==deskKeyboardShortcuts[n]?" selected":"")+">"+keyShortcutTotext(deskKeyboardShortcuts[n])+"</option>";QH("deskkeys",e)}var keyStrings={8:"Backspace",9:"Tab",13:"Ввод",27:"Escape",32:"Space",44:"Print Screen",45:"Insert",46:"Del",36:"Home",35:"Конец",33:"Page Up",34:"Page Down",37:"Left",38:"Up",39:"Right",40:"Down",0:"Пусто"};function keyShortcutTotext(e){var t=[];return 65536&e&&t.push("Shift"),131072&e&&t.push("Alt"),524288&e&&t.push("Ctrl"),1048576&e&&t.push("Win"),(e&=65535)>=112&&e<=123?t.push("F"+(e-111)):0!=e&&keyStrings[e]?t.push(keyStrings[e]):0!=e&&t.push(String.fromCharCode(e)),t.join(" + ")}function deskCustomizeKeys(){if(!xxdialogMode){var e='<div id=d2shortcuts style="width:100%;height:180px;padding:4px;overflow-y:auto;border:1px solid gray"></div><div style=width:100%;padding:5px>';for(var t in e+='<label><input id=d1kshift type=checkbox class="form-check-input me-2" /> Shift</label><label> <input id=d1kalt type=checkbox class="form-check-input me-2" /> Alt</label><label> <input id=d1kctrl type=checkbox class="form-check-input me-2" /> Ctrl</label> <input id=d1kwin type=checkbox class="form-check-input me-2" /> Win</label>',e+=" <select id=d2keySelect>",keyStrings)e+="<option value="+t+">"+keyStrings[t]+"</option>";for(t=1;t<=12;t++)e+="<option value="+(t+111)+">F"+t+"</option>";for(t=0;t<10;t++)e+="<option value="+(t+48)+">"+t+"</option>";for(t=0;t<26;t++)e+="<option value="+(t+65)+">"+String.fromCharCode(t+65)+"</option>";e+="</select> <input type=button value=Добавить onclick=addDeskCustomizeKey() /></div>",setModalContent("xxAddAgent","Настройка сочетаний клавиш",e+='<div style=width:100%;padding:2px;text-align:center><input type=button value="Restore Default Keyboard Shortcuts" onclick=restoreDeskCustomizeKey() /></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>deskCustomizeKeysEx()),deskUpdateShortcutList()}}function deskCustomizeKeysEx(){putstore("deskKeyShortcuts",deskKeyboardShortcuts.join(",")),updateDeskShortcutKeys()}function deskUpdateShortcutList(){var e="";for(var t in deskKeyboardShortcuts){var n=keyShortcutTotext(deskKeyboardShortcuts[t]),o="";t!=deskKeyboardShortcuts.length-1&&(o+='<img width=8 height=8 style=float:right;cursor:pointer;padding:3px src="images/c2.png" onclick=deskCustomizeKeyDown('+deskKeyboardShortcuts[t]+")>"),0!=t&&(o+='<img width=8 height=8 style=float:right;cursor:pointer;padding:3px src="images/c3.png" onclick=deskCustomizeKeyUp('+deskKeyboardShortcuts[t]+")>"),e+='<div style="width:100%;background-color:#AAA;border-radius:4px;margin-bottom:4px;padding:4px;text-align:left;box-sizing:border-box" value='+deskKeyboardShortcuts[t]+">"+n+'<img width=10 height=10 style=float:right;cursor:pointer;padding:2px;margin-left:8px src="images/trash.png" onclick=removeDeskCustomizeKey('+deskKeyboardShortcuts[t]+")>"+o+"</div>"}""==e&&(e="<i>Сочетания клавиш не заданны</i>"),QH("d2shortcuts",e)}function deskCustomizeKeyDown(e){var t=deskKeyboardShortcuts.indexOf(e),n=deskKeyboardShortcuts[t+1];deskKeyboardShortcuts[t+1]=deskKeyboardShortcuts[t],deskKeyboardShortcuts[t]=n,deskUpdateShortcutList()}function deskCustomizeKeyUp(e){var t=deskKeyboardShortcuts.indexOf(e),n=deskKeyboardShortcuts[t];deskKeyboardShortcuts[t]=deskKeyboardShortcuts[t-1],deskKeyboardShortcuts[t-1]=n,deskUpdateShortcutList()}function removeDeskCustomizeKey(e){var t=[];for(var n in deskKeyboardShortcuts)deskKeyboardShortcuts[n]!=e&&t.push(deskKeyboardShortcuts[n]);deskKeyboardShortcuts=t,deskUpdateShortcutList()}function restoreDeskCustomizeKey(){deskKeyboardShortcuts=[],putstore("deskKeyShortcuts",null);var e=getstore("deskKeyShortcuts","0x0A002E,0x100000,0x100028,0x100026,0x10004C,0x10004D,0x11004D,0x100052,0x020073,0x080057,0x020009,0x100025,0x100027").split(",");for(var t in e)""!=e[t]&&deskKeyboardShortcuts.push(parseInt(e[t]));updateDeskShortcutKeys(),deskUpdateShortcutList()}function addDeskCustomizeKey(){var e=parseInt(Q("d2keySelect").value);Q("d1kshift").checked&&(e|=65536),Q("d1kalt").checked&&(e|=131072),Q("d1kctrl").checked&&(e|=524288),Q("d1kwin").checked&&(e|=1048576),e>0&&-1==deskKeyboardShortcuts.indexOf(e)&&(deskKeyboardShortcuts.push(e),deskUpdateShortcutList())}function deskCustomizeStrings(){if(!xxdialogMode){var e='<div id=d2strings style="width:100%;height:180px;padding:4px;overflow-y:auto;border:1px solid gray"></div><div style=width:100%;padding:5px>';e+=addHtmlFormFloating("Имя",'<input type=text id=d2shortcutname class="form-control" maxlength=32 autocomplete=off onkeyup=deskCustomizeStringsUpdate(event) />'),e+=addHtmlFormFloating("Строка",'<input type=text id=d2shortcutvalue class="form-control" maxlength=256 autocomplete=off onkeyup=deskCustomizeStringsUpdate(event) />'),setModalContent("xxAddAgent","Настройка клавиатурных строк",e+=addHtmlFormFloating("",'<input id=d2addbutton type=button value=Добавить onclick=addDeskCustomizeString() class="form-control" />')),showModal("xxAddAgentModal","idx_dlgOkButton",()=>deskCustomizeStringsEx()),deskUpdateStringsList(),deskCustomizeStringsUpdate()}}function deskCustomizeStringsUpdate(){QE("d2addbutton",""!=Q("d2shortcutname").value&&""!=Q("d2shortcutvalue").value)}function deskCustomizeStringsEx(){putstore("deskStrings",JSON.stringify(deskKeyboardStrings)),updateDesktopStrings()}function deskUpdateStringsList(){var e="";for(var t in deskKeyboardStrings){var n="";t!=deskKeyboardStrings.length-1&&(n+='<img width=8 height=8 style=float:right;cursor:pointer;padding:3px src="images/c2.png" onclick=deskCustomizeStringDown('+t+")>"),0!=t&&(n+='<img width=8 height=8 style=float:right;cursor:pointer;padding:3px src="images/c3.png" onclick=deskCustomizeStringUp('+t+")>"),e+='<div style="width:100%;background-color:#AAA;border-radius:4px;margin-bottom:4px;padding:4px;text-align:left;box-sizing:border-box" value='+(t+1e3)+"><div><b>"+EscapeHtml(deskKeyboardStrings[t].n)+'</b><img width=10 height=10 style=float:right;cursor:pointer;padding:2px;margin-left:8px src="images/trash.png" onclick=removeDeskCustomizeString('+t+")>"+n+"</div>",e+="<div stlye=font-size:x-small>"+EscapeHtml(deskKeyboardStrings[t].v)+"</div>",e+="</div>"}""==e&&(e="<i>Клавиатурные строки не заданны</i>"),QH("d2strings",e)}function deskCustomizeStringDown(e){var t=deskKeyboardStrings[e+1];deskKeyboardStrings[e+1]=deskKeyboardStrings[e],deskKeyboardStrings[e]=t,deskUpdateStringsList()}function deskCustomizeStringUp(e){var t=deskKeyboardStrings[e];deskKeyboardStrings[e]=deskKeyboardStrings[e-1],deskKeyboardStrings[e-1]=t,deskUpdateStringsList()}function removeDeskCustomizeString(e){deskKeyboardStrings.splice(e,1),deskUpdateStringsList()}function addDeskCustomizeString(){Array.isArray(deskKeyboardStrings)||(deskKeyboardStrings=[]);var e=Q("d2shortcutname").value,t=Q("d2shortcutvalue").value;""!=e&&""!=t&&(deskKeyboardStrings.push({n:e,v:t}),deskUpdateStringsList())}function updateDesktopStrings(){var e="";for(var t in deskKeyboardStrings){e+='<div class="cmtext" onclick="cmdeskpreconfigtypeaction('+(parseInt(t)+1e3)+',event)">'+EscapeHtml(deskKeyboardStrings[t].n)+"</div>"}""!=e&&(e+="<hr />"),QH("deskPreConfigShortcutContextMenu2",e)}function deskSendKeys(){if(Q("DeskWD").blur(),!xxdialogMode&&null!=desktop&&3==desktop.State){var e=parseInt(Q("deskkeys").value);if(655406!=e){var t=(16711680&e)>>16,n=65535&e,o=[],i=[],a={8:65288,9:65289,13:65293,27:65307,45:65379,46:65535,36:65360,35:65367,33:65365,34:65366,37:65361,38:65362,39:65363,40:65364,112:65470,113:65471,114:65472,115:65473,116:65474,117:65475,118:65476,119:65477,120:65478,121:65479,122:65480,123:65481};if(2==desktop.contype){1&t&&(o.push([65505,1]),i.push([65505,0])),2&t&&(o.push([65513,1]),i.push([65513,0])),8&t&&(o.push([65507,1]),i.push([65507,0])),16&t&&(o.push([65511,1]),i.push([65511,0])),a[n]&&(n=a[n]),n>=65&&n<=90&&(n+=32),0!=n&&(o.push([n,1]),i.push([n,0])),i.reverse();for(var s=0;s<i.length;s++)o.push(i[s]);desktop.m.sendkey(o)}else{1&t&&(o.push([desktop.m.KeyAction.DOWN,16]),i.push([desktop.m.KeyAction.UP,16])),2&t&&(o.push([desktop.m.KeyAction.EXDOWN,18]),i.push([desktop.m.KeyAction.EXUP,18])),8&t&&(o.push([desktop.m.KeyAction.EXDOWN,17]),i.push([desktop.m.KeyAction.EXUP,17])),16&t&&(o.push([desktop.m.KeyAction.EXDOWN,91]),i.push([desktop.m.KeyAction.EXUP,91])),0!=n&&(o.push([desktop.m.KeyAction.DOWN,n]),i.push([desktop.m.KeyAction.UP,n])),i.reverse();for(s=0;s<i.length;s++)o.push(i[s]);desktop.m.SendKeyMsgKC(o)}}else desktop.m.sendcad()}}function showDeskType(e){if(!xxdialogMode&&null!=desktop&&3==desktop.State){Q("DeskType").blur();var t="<div>Введите текст и нажмите ОК, чтобы ввести его удаленно. Перед продолжением убедитесь, что вы установили удаленный курсор в правильное положение.<div>";setModalContent("xxAddAgent","Ввод с удаленной клавиатуры",t+='<textarea id=d2typeText style="margin-top:5px;width:100%;height:184px;resize:none" maxlength=2000>'+(e?EscapeHtml(e):"")+"</textarea>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showDeskTypeEx()),Q("d2typeText").focus()}}var AmtDeskTypeTimer=null,AmtDeskTypeContent=null,DeskTypeTranslate={39:222,42:106,43:107,44:188,45:189,46:190,47:191,59:186,61:187,91:219,92:220,93:221,96:192,191:111},DeskTypeShiftTranslate={33:49,34:222,35:51,36:52,37:53,38:55,40:57,41:48,58:186,60:188,62:190,63:191,64:50,94:54,95:189,106:56,107:187,123:219,124:220,125:221,126:192};function showDeskTypeEx(e){var t,n,o=[],i=!1;if("string"==typeof e?(t=e,n=e.toUpperCase()):(t=Q("d2typeText").value,n=Q("d2typeText").value.toUpperCase()),2==desktop.contype){for(var a in t){var s=t.charCodeAt(a);o.push([s,1],[s,0])}AmtDeskTypeContent=o,AmtDeskTypeTimer=setInterval(function(){var e=AmtDeskTypeContent.shift();desktop&&desktop.m.sendkey(e[0],e[1]),null!=desktop&&0!=AmtDeskTypeContent.length||(clearInterval(AmtDeskTypeTimer),AmtDeskTypeContent=null)},10)}else if(4==desktop.contype)desktop.m.SendStringUnicode(t);else if(!0!==desktopsettings.remotekeymap)desktop.m.SendStringUnicode(t);else{for(var a in t){s=t.charCodeAt(a);var r=n.charCodeAt(a);s>=65&&s<=90||s>=97&&s<=122?(s==r&&0==i&&(o.push([desktop.m.KeyAction.DOWN,16]),i=!0),s!=r&&1==i&&(o.push([desktop.m.KeyAction.UP,16]),i=!1)):s>=48&&s<=57?1==i&&(o.push([desktop.m.KeyAction.UP,16]),i=!1):DeskTypeTranslate[s]?(1==i&&(o.push([desktop.m.KeyAction.UP,16]),i=!1),r=DeskTypeTranslate[s]):DeskTypeShiftTranslate[s]&&(0==i&&(o.push([desktop.m.KeyAction.DOWN,16]),i=!0),r=DeskTypeShiftTranslate[s]),o.push([desktop.m.KeyAction.DOWN,r],[desktop.m.KeyAction.UP,r])}1==i&&(o.push([desktop.m.KeyAction.UP,16]),i=!1),desktop.m.SendKeyMsgKC(o)}}function showDeskClip(){if(!xxdialogMode&&null!=desktop&&3==desktop.State){Q("DeskClip").blur();var e="";2048&features2||(e+='<input id=dlgClipGet type=button value="Получить буфер" style=width:160px onclick=showDeskClipGet()>'),4096&features2||(e+='<input id=dlgClipSet type=button value="Установить буфер" style=width:160px onclick=showDeskClipSet()>'),e+='<div id=dlgClipStatus style="display:inline-block;margin-left:8px" ></div>',e+='<textarea id=d2clipText style="width:100%;height:184px;resize:none" maxlength=65535></textarea>',xxdialogTag="clipboard",setModalContent("xxAddAgent","Удаленный буфер обмена",e+='<input type=button value="Close" style=width:80px;float:right onclick=dialogclose(0)><div style=height:26px;margin-top:3px><span id=linuxClipWarn style=display:none>Удаленный буфер обмена действителен в течении 60 секунд.</span>&nbsp;</div><div></div>'),showModal("xxAddAgentModal","idx_dlgOkButton"),Q("d2clipText").focus()}}function showDeskClipGet(){null!=desktop&&3==desktop.State&&meshserver.send({action:"msg",type:"getclip",nodeid:currentNode._id,tag:1})}function showDeskClipSet(){null!=desktop&&3==desktop.State&&(desktop.m.setClipboard?desktop.m.setClipboard(Q("d2clipText").value):(meshserver.send({action:"msg",type:"setclip",nodeid:currentNode._id,data:Q("d2clipText").value}),QV("linuxClipWarn",currentNode&&currentNode.agent&&currentNode.agent.id>4&&21!=currentNode.agent.id&&22!=currentNode.agent.id&&34!=currentNode.agent.id)))}function sendCAD(){xxdialogMode||null==desktop||3!=desktop.State||desktop.m.sendcad()}function toggleDeskTools(){Q("DeskToolsButton").blur(),xxdialogMode||("none"==QS("DeskTools").display?(QV("DeskTools",!0),Q("DeskTools").nodeid=currentNode._id,QH("DeskToolsProcesses",""),QH("DeskToolsServices",""),QV("deskToolsTopTabService",!1),changeDeskToolTab(0),refreshDeskTools(0),refreshDeskTools(1)):QV("DeskTools",!1))}var deskToolTabSelection=0;function changeDeskToolTab(e){deskToolTabSelection=e,QV("DeskToolsProcessTab",0==e),QV("DeskToolsServiceTab",1==e),QS("deskToolsTopTabProcess").bottom=0==e?"0px":"3px",QS("deskToolsTopTabService").bottom=1==e?"0px":"3px",QS("deskToolsTopTabProcess").color=0==e?"black":"gray",QS("deskToolsTopTabService").color=1==e?"black":"gray"}function refreshDeskTools(e){var t=null==e?deskToolTabSelection:e;QV("DeskToolsRefreshButton",!1),setTimeout(refreshDeskToolsEx,500),0==t&&meshserver.send({action:"msg",type:"ps",nodeid:currentNode._id}),1==t&&meshserver.send({action:"msg",type:"services",nodeid:currentNode._id})}function refreshDeskToolsEx(){QV("DeskToolsRefreshButton",!0)}var deskTools={sort:1,ssort:1,msg:null,smsg:null,resizing:!1};function sortProcess(e){deskTools.sort=e,showDeskToolsProcesses(deskTools.msg)}function sortService(e){deskTools.ssort=e,showDeskToolsServices(deskTools.smsg)}function sortProcessPid(e,t){return e.p>t.p?1:e.p<t.p?-1:sortProcessName(e,t)}function sortProcessName(e,t){return e.d>t.d?1:e.d<t.d?-1:0}function showDeskToolsProcesses(e){if(deskTools.msg=e,null!=e){if(Q("DeskTools").nodeid==e.nodeid){var t=[],n=null;try{n=JSON.parse(e.value)}catch(e){}if(null!=n){for(var o in n)t.push({p:parseInt(o),c:n[o].cmd,d:n[o].cmd.toLowerCase(),u:n[o].user});0==deskTools.sort?t.sort(sortProcessPid):1==deskTools.sort&&t.sort(sortProcessName);var i="";for(var a in t)if(0!=t[a].p){var s=t[a].c;i+="<div onclick=showProcessDetails("+t[a].p+') class="deskToolsBar d-flex">',i+='<div class="pe-1 text-start" style=width:50px;>'+EscapeHtml(t[a].p)+"</div>",i+='<div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="'+EscapeHtml(s)+'">'+s+"</div>",i+='<div class="ms-auto">'+(t[a].u?EscapeHtml(t[a].u):""),i+='<i class="ps-1 fa-solid fa-trash-can" role="button" title="Остановить процесс" onclick=\'return stopProcess('+EscapeHtml(t[a].p)+',"'+EscapeHtml(t[a].c)+"\")'></i></div>",i+="</div>"}QH("DeskToolsProcesses",i)}}}else QH("DeskToolsProcesses","")}function showProcessDetails(e){xxdialogMode||(setModalContent("xxAddAgent",format("Сведения о процессе, № {0}",e),"Requesting Process Details..."),xxdialogTag="ps|"+currentNode._id+"|"+e,showModal("xxAddAgentModal","idx_dlgOkButton"),meshserver.send({action:"msg",type:"psinfo",nodeid:currentNode._id,pid:e}))}function showDeskToolsServices(e){if(deskTools.smsg=e,null!=e){if(Q("DeskTools").nodeid==e.nodeid){QV("deskToolsTopTabService",!0);var t=[],n=null;try{n=JSON.parse(e.value)}catch(e){}if(deskTools.services=n,null!=n){for(var o in n)n[o].status?t.push({p:capitalizeFirstLetter(n[o].status.state.toLowerCase()),d:n[o].displayName,i:o}):n[o].serviceType&&t.push({p:n[o].serviceType,d:n[o].name,i:o});0==deskTools.ssort?t.sort(sortProcessPid):1==deskTools.ssort&&t.sort(sortProcessName);var i="";for(var o in t)if(0!=t[o].p){var a=t[o].d,s=t[o].p;"Stopped"==s?s="Остановлен":"Running"==s&&(s="Запущен"),i+="<div onclick=showServiceWaitDialog("+t[o].i+") class=deskToolsBar>",i+="<div style=width:70px;float:left;padding-right:5px>"+EscapeHtml(s)+"</div>",i+='<div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="'+a+'">'+EscapeHtml(a)+"</div>",i+="</div>"}QH("DeskToolsServices",i)}}}else QH("DeskToolsProcesses","")}function showServiceDetailsDialog(e){if(xxdialogMode&&-1!=xxdialogTag.indexOf("service_")){var t=xxdialogTag.replace("service_",""),n=e.value?JSON.parse(e.value):deskTools.services[t];if(e.value&&(n.displayName=deskTools.services[t].displayName),null!=n){var o="";if(n.name&&(o+=addHtmlValue("Имя",n.name)),n.displayName&&(o+=addHtmlValue("Отображаемое имя",n.displayName)),n.status){var i=capitalizeFirstLetter(n.status.state.toLowerCase());"Stopped"==i?i="Остановлен":"Running"==i&&(i="Запущен"),n.status.state&&(o+=addHtmlValue("Состояние",i)),n.status.pid&&(o+=addHtmlValue("PID",n.status.pid));var a=[];!0===n.status.isFileSystemDriver&&a.push("FileSystemDriver"),!0===n.status.isInteractive&&a.push("Интерактивный"),!0===n.status.isKernelDriver&&a.push("Драйвер ядра"),!0===n.status.isOwnProcess&&a.push("Собственный процесс"),!0===n.status.isSharedProcess&&a.push("Общий процесс"),a.length>0&&(o+=addHtmlValue("Тип",a.join(", ")))}if(n.startType&&(o+=addHtmlValue("Start Type",n.startType)),n.user&&(o+=addHtmlValue("Пользователь",n.user)),n.installedBy&&(o+=addHtmlValue("Installed By",n.installedBy)),n.installedDate&&(o+=addHtmlValue("Installed Date",printDateTime(new Date(n.installedDate)))),n.failureActions){if(n.failureActions.resetPeriod){var s=(n.failureActions.resetPeriod<86400?0:n.failureActions.resetPeriod)/86400;o+=addHtmlValue("Restart Fail Count After ",s+" Day"+(1!=s?"s":""))}n.failureActions.actions&&(n.failureActions.actions[0]&&(o+=addHtmlValue("First Failure",n.failureActions.actions[0].type)),n.failureActions.actions[1]&&(o+=addHtmlValue("Second Failure",n.failureActions.actions[1].type)),n.failureActions.actions[2]&&(o+=addHtmlValue("Subsequent Failures",n.failureActions.actions[2].type)))}xxdialogTag="service_"+t,setModalContent("xxAddAgent","Детали службы",o+='<br/><div style=float:right;margin-bottom:12px><input type=button value="Закрыть" onclick=showServiceDetailsDialogEx(0,'+t+')></div><div style=margin-bottom:12px><input type=button value="Старт" onclick=showServiceDetailsDialogEx(1,'+t+')><input type=button value="Стоп" onclick=showServiceDetailsDialogEx(2,'+t+')><input type=button value="Перезапуск" onclick=showServiceDetailsDialogEx(3,'+t+")></div>"),showModal("xxAddAgentModal","idx_dlgOkButton")}}}function showServiceWaitDialog(e){if(xxdialogMode)return!1;var t=deskTools.services[e];return null!=t&&(meshserver.send({action:"msg",type:"service",nodeid:currentNode._id,serviceName:t.name}),xxdialogTag="service_"+e,setModalContent("xxAddAgent","Детали службы","Requesting Service Details..."),showModal("xxAddAgentModal","idx_dlgOkButton")),!1}function showServiceDetailsDialogEx(e,t){if(setDialogMode(0),0!=e){var n=deskTools.services[t];null!=n&&(1==e&&meshserver.send({action:"msg",type:"serviceStart",nodeid:currentNode._id,serviceName:n.name}),2==e&&meshserver.send({action:"msg",type:"serviceStop",nodeid:currentNode._id,serviceName:n.name}),3==e&&meshserver.send({action:"msg",type:"serviceRestart",nodeid:currentNode._id,serviceName:n.name}),setTimeout(function(){refreshDeskTools(1)},1e3))}}function toggleKvmControl(){Q("DeskControl").blur(),putstore("DeskControl",Q("DeskControl").checked?1:0),QS("DeskControlSpan").color=Q("DeskControl").checked?null:"red"}function deskRecordSession(){if(null!=desktop)if(null==desktop.m.recordedData)Q("DeskRecordButtonImage").style.color="red",desktop.m.StartRecording();else{Q("DeskRecordButtonImage").style.color="";var e=new Date,t="DesktopSession-"+currentNode.name+"-"+e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+"-"+("0"+e.getHours()).slice(-2)+"-"+("0"+e.getMinutes()).slice(-2);saveAs(data2blob(desktop.m.StopRecording().join("")),t+".mcrec")}}function deskSaveImage(){if(!xxdialogMode&&null!=desktop&&3==desktop.State){var e=new Date,t="Рабочий стол-"+currentNode.name+"-"+e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+"-"+("0"+e.getHours()).slice(-2)+"-"+("0"+e.getMinutes()).slice(-2);Q("Desk").toBlob(function(e){saveAs(e,t+".png")})}}function deskDisplayInfo(e,t,n){var o=0,i="";for(var a in t){o++;var s=t[a],r=1;"All Displays"==s&&(s="Все экраны",r=2),s.startsWith("Display ")&&(s=format("Экран {0}",s.substring(8)));var l="id=DeskMonitorSelectionX"+a+' title="'+EscapeHtml(s)+'" onclick=deskSetDisplay('+a+") role=button";i+=2==r?"<span "+l+' class="fa-layers fa-fw '+(n==a?"":" gray")+'"><i class="fa-solid fa-desktop"></i><i class="fa-solid fa-square" data-fa-transform="shrink-12 left-3 up-3"></i><i class="fa-solid fa-square" data-fa-transform="shrink-12 right-3 up-3"></i></span>':"<i "+l+' class="fa-fw fa-solid fa-desktop '+(n==a?"":" gray")+'"></i>',deskPreferedStickyDisplay==a&&n!=deskPreferedStickyDisplay&&desktop.m.SetDisplay(a),deskPreferedStickyDisplay=-1}QH("DeskMonitorSelectionSpan",i),QV("DeskMonitorSelectionSpan",o>1)}function deskGetDisplayNumbers(e){desktop.m.GetDisplayNumbers()}Q("DeskTools").addEventListener("mousemove",function(e){var t=e.clientX-Q("DeskTools").getBoundingClientRect().left;Q("DeskTools").style.cursor=t<5?"col-resize":"default"}),Q("DeskTools").addEventListener("mousedown",function(e){"col-resize"===Q("DeskTools").style.cursor&&(deskTools.resizing=!0,Q("Desk").removeAttribute("onmouseup"),Q("Desk").removeAttribute("onmousedown"),Q("Desk").removeAttribute("onmousemove"))}),document.addEventListener("mouseup",function(){!0===deskTools.resizing&&"col-resize"===Q("DeskTools").style.cursor&&(deskTools.resizing=!1)}),document.addEventListener("mousemove",function(e){if(deskTools.resizing){var t=Q("DeskTools").getBoundingClientRect().right-e.clientX;t<Q("DeskParent").clientWidth-10&&(Q("DeskTools").style.width=t+"px")}});var deskPreferedStickyDisplay=-1;function deskSetDisplay(e){desktop.m.SetDisplay(deskPreferedStickyDisplay=parseInt(e))}var terminalNode,dblClickDetectArgs={t:0,x:0,y:0};function dblClickDetect(e){if(1==e.buttons){var t=Date.now();t-dblClickDetectArgs.t<250&&Math.abs(e.clientX-dblClickDetectArgs.x)<2&&Math.abs(e.clientY-dblClickDetectArgs.y)<2&&!xxdialogMode&&null!=desktop&&Q("DeskControl").checked&&(null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mousedblclick(e),desktop.m.sendKeepAlive()):desktop.m.mousedblclick(e)),dblClickDetectArgs.t=t,dblClickDetectArgs.x=e.clientX,dblClickDetectArgs.y=e.clientY}}function dmousedown(e){setSessionActivity(),e.addx=Q("DeskParent").scrollLeft,e.addy=Q("DeskParent").scrollTop,!xxdialogMode&&null!=desktop&&Q("DeskControl").checked&&(null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mousedown(e),desktop.m.sendKeepAlive()):desktop.m.mousedown(e)),dblClickDetect(e)}function dmouseup(e){setSessionActivity(),e.addx=Q("DeskParent").scrollLeft,e.addy=Q("DeskParent").scrollTop,!xxdialogMode&&null!=desktop&&Q("DeskControl").checked&&(null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mouseup(e),desktop.m.sendKeepAlive()):desktop.m.mouseup(e))}function dmousemove(e){setSessionActivity(),e.addx=Q("DeskParent").scrollLeft,e.addy=Q("DeskParent").scrollTop,!xxdialogMode&&null!=desktop&&Q("DeskControl").checked?(Q("Desk").style.cursor="",null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mousemove(e),desktop.m.sendKeepAlive()):desktop.m.mousemove(e)):xxdialogMode||null==desktop||Q("DeskControl").checked||(Q("Desk").style.cursor="not-allowed")}function dmousewheel(e){return setSessionActivity(),e.addx=Q("DeskParent").scrollLeft,e.addy=Q("DeskParent").scrollTop,!(xxdialogMode||null==desktop||!Q("DeskControl").checked)&&(null!=webRtcDesktop&&null!=webRtcDesktop.softdesktop?(webRtcDesktop.softdesktop.m.mousewheel(e),desktop.m.sendKeepAlive()):desktop.m.mousewheel&&desktop.m.mousewheel(e),haltEvent(e),!0)}function drotate(e){xxdialogMode||null==desktop||(desktop.m.setRotation(desktop.m.rotation+e),deskAdjust(),deskAdjust())}function stopProcess(e,t){return setModalContent("xxAddAgent","Управление процессами",format('Остановить процесс № {0} "{1}"?',e,t)),showModal("xxAddAgentModal","idx_dlgOkButton",()=>stopProcessEx(3,e)),!1}function stopProcessEx(e,t){meshserver.send({action:"msg",type:"pskill",nodeid:currentNode._id,value:t}),setTimeout(refreshDeskTools,300)}function setupTerminal(){terminalNode!=currentNode&&null!=terminal&&terminalNode._id!=currentNode._id&&(terminal.Stop(),terminalNode=null,terminal=null),terminalNode=currentNode,updateTerminalButtons()}function updateTerminalButtons(){var e=null!=terminal&&0!=terminal.state;3==terminalNode.mtype&&null!=terminalNode.agent&&terminalNode.agent.id>4&&512&features2&&(terminalNode.agent.caps=6),QV("disconnectbutton2span",1==e),QV("connectbutton2span",0==e&&null!=terminalNode.agent&&2&terminalNode.agent.caps&&3!=terminalNode.mtype),QV("connectbutton2sspan",512&features2&&0==e&&null!=terminalNode.agent&&2&terminalNode.agent.caps&&3!=terminalNode.agent.id&&!(16777216&features2)),1==terminalNode.mtype?(QV("connectbutton2hspan",0==e&&null!=terminalNode.intelamt&&2==terminalNode.intelamt.state),QV("terminalSizeDropDown",0==e&&null!=terminalNode.intelamt&&2==terminalNode.intelamt.state)):(QV("connectbutton2hspan",0==e&&null!=terminalNode.intelamt&&2==terminalNode.intelamt.state&&null!=terminalNode.intelamt.ver),QV("terminalSizeDropDown",0==e&&null!=terminalNode.intelamt&&2==terminalNode.intelamt.state&&null!=terminalNode.intelamt.ver)),QV("termActionsBtn",3!=terminalNode.mtype),1==e&&3!=terminal.contype||null==terminalNode.agent||3==terminalNode.agent.id||4==terminalNode.agent.id?QH("terminalCustomUpperRight",""):QH("terminalCustomUpperRight","<a style=cursor:pointer onclick=cmsshportaction(1,event)>"+format("Порт SSH {0}",terminalNode.sshport?terminalNode.sshport:22)+"</a>");var t=!!(1&terminalNode.conn)||3==terminalNode.mtype;QE("connectbutton2",t),QE("connectbutton2d",t),QE("connectbutton2s",t),QE("connectbutton2sd",t);var n=!!(6&terminalNode.conn);QE("connectbutton2h",n),QE("ctrlcbutton",e),QE("ctrlxbutton",e),QE("escbutton",e),QE("bsbutton",e),QE("pastebutton",e),QE("specialkeylist",e),QE("specialkeylistinput",e),QV("terminalSettingsButtons",terminal&&2==terminal.contype),terminal&&(Q("id_ttypebutton").value=terminalEmulations[terminal.m.terminalEmulation],Q("id_tfxkeysbutton").value=fxEmulations[terminal.m.fxEmulation],Q("id_tcrbutton").value="\r\n"==terminal.m.lineFeed?"CR+LF":"LF");var o=!(0===args.xterm||null!=terminal&&null==xterm);QV("termarea3xdiv",o),QV("Term",!o),QV("bsbutton",!o),QV("pastebutton",!o),QV("devListToolbarViewIcons2",o),QE("termSizeList",null==terminal)}function onTerminalStateChange(e,t){if(terminal==e){var n=t;3==n&&2==e.contype&&n++;var o=StatusStrs[n];switch(3==n&&(3==e.contype&&(o+=", SSH"),1==e.webRtcActive&&(o+=", WebRTC")),QH("termstatus",o),t){case 0:if(QH("termtitle",""),QV("termRecordIcon",!1),null==xterm)try{e.m.TermResetScreen(),e.m.TermDraw()}catch(e){}else xterm.dispose(),xterm=xtermfit=null;null!=e&&(e.Stop(),terminal=null);break;case 3:e&&1==e.serverIsRecording&&QV("termRecordIcon",!0),e.startTime=new Date,null==updateSessionTimer&&(updateSessionTimer=setInterval(updateSessionTime,1e3)),null!=xterm&&xterm.focus()}updateTerminalButtons()}}var autoConnectTerminalTimer=null;function autoConnectTerminal(e){null==autoConnectTerminalTimer?autoConnectTerminalTimer=setInterval(connectTerminal,100):(clearInterval(autoConnectTerminalTimer),autoConnectTerminalTimer=null)}function CreateRemoteTunnel(e,t){var n={protocol:1};return null!=t&&"number"==typeof t.protocol&&(n.protocol=t.protocol),n.onTunnelUpdate=e,n.xxStateChange=function(e){},n.ProcessBinaryData=function(e){n.onTunnelUpdate(e)},n.ProcessData=function(e){n.onTunnelUpdate(e)},n.terminalEmulation=1,n.fxEmulation=0,n.lineFeed="\r\n",n}function tunnelUpdate(e){null!=xterm&&(xterm.writeUtf8?"string"==typeof e?xterm.writeUtf8(e):xterm.writeUtf8(new Uint8Array(e)):"string"==typeof e?xterm.write(e):xterm.write(new Uint8Array(e)))}function sshTunnelAuthDialog(e,t){var n="";e.askkeypass?n+=addHtmlFormFloating("Аутентификация",'<select id=dp2authmethod class="form-select" onchange=sshAuthUpdate(event)><option value=3 selected>Сохраненный ключ</option><option value=1>Имя пользователя и пароль</option><option value=2>Имя пользователя и ключ</option></select>'):n+=addHtmlFormFloating("Аутентификация",'<select id=dp2authmethod class="form-select" onchange=sshAuthUpdate(event)><option value=1 selected>Имя пользователя и пароль</option><option value=2>Имя пользователя и ключ</option></select>'),n+="<div id=d2userauth style=display:none>",n+=addHtmlFormFloating("Имя пользователя",'<input id=dp2user class="form-control" maxlength=64 autocomplete=off onkeyup=sshAuthUpdate(event) />'),n+="</div>",n+="<div id=d2passauth style=display:none>",n+=addHtmlFormFloating("Пароль",'<input type=password id=dp2pass class="form-control" maxlength=64 autocomplete=off onkeyup=sshAuthUpdate(event) />'),4194304&features2||(n+=addHtmlValue("",'<label><input id=dp2keep type=checkbox class="form-check-input me-2">Запомнить учетные данные</label>')),n+="</div><div id=d2keyauth style=display:none>",n+=addHtmlValue("Ключевой файл",'<input type=file id=dp2key class="form-control" maxlength=64 autocomplete=off onchange=sshAuthUpdate(event) /><div id=d2badkey style=font-size:x-small>Ключевой файл должен быть в формате OpenSSH.</div>'),n+=addHtmlFormFloating("Пароль ключа",'<input type=password id=dp2keypass class="form-control" maxlength=64 autocomplete=off onkeyup=sshAuthUpdate(event) />'),4194304&features2||(n+=addHtmlValue("",'<label><input id=dp2keep1 type=checkbox class="form-check-input me-2" onchange=sshAuthUpdate(event)>Запомнить пользователя и ключ</label>'),n+=addHtmlValue("",'<label><input id=dp2keep2 type=checkbox class="form-check-input me-2">Запомнить пароль</label>')),n+="</div>",e.askkeypass&&(n+="<div id=d2keyauth2 style=display:none>",n+=addHtmlFormFloating("Пароль",'<input type=password id=dp2keypass2 class="form-control" maxlength=64 autocomplete=off onkeyup=sshAuthUpdate(event) />'),n+="</div>"),setModalContent("xxAddAgent","Аутентификация",n);var o=function(e,t){document.getElementById("xxAddAgentModal").removeEventListener("hide.bs.modal",o),connectTerminal()};document.getElementById("xxAddAgentModal").addEventListener("hide.bs.modal",o),showModal("xxAddAgentModal","idx_dlgOkButton",()=>{document.getElementById("xxAddAgentModal").removeEventListener("hide.bs.modal",o),t(11,"ssh")}),Q("dp2user").focus(),sshAuthUpdate(),setTimeout(sshAuthUpdate,50)}function sshTunnelUpdate(e){if("string"==typeof e)if("{"==e[0]){var t=JSON.parse(e);switch(t.action){case"sshauth":sshTunnelAuthDialog(t,sshConnectEx);break;case"sshautoauth":terminal.socket.send(JSON.stringify({action:"sshautoauth",cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight}));break;case"connectionerror":p12setConsoleMsg("Ошибка соединения",5e3);break;case"autherror":p12setConsoleMsg("Ошибка аутентификации",5e3);break;case"sessionerror":p12setConsoleMsg("Сессия истекла",5e3);break;case"sessiontimeout":p12setConsoleMsg("Тайм-аут сеанса",5e3)}}else"~"==e[0]&&(xterm.writeUtf8?xterm.writeUtf8(e.substring(1)):xterm.write(e.substring(1)))}function sshAuthUpdate(e){if(QV("d2userauth",3!=Q("dp2authmethod").value),QV("d2passauth",1==Q("dp2authmethod").value),QV("d2keyauth",2==Q("dp2authmethod").value),QV("d2keyauth2",3==Q("dp2authmethod").value),1==Q("dp2authmethod").value)QE("idx_dlgOkButton",Q("dp2user").value.length>0&&Q("dp2pass").value.length>0);else if(3==Q("dp2authmethod").value)QE("idx_dlgOkButton",Q("dp2keypass2").value.length>0);else{if(QE("idx_dlgOkButton",!1),4194304&features2||QE("dp2keep2",Q("dp2keep1").checked),1==(Q("dp2user").value.length>0&&null!=Q("dp2key").files&&1==Q("dp2key").files.length&&Q("dp2key").files[0].size<8e3)){var t=new FileReader;t.onload=function(e){var t=e.target.result.indexOf("-----BEGIN OPENSSH PRIVATE KEY-----")>=0&&e.target.result.indexOf("-----END OPENSSH PRIVATE KEY-----")>=0||e.target.result.indexOf("-----BEGIN RSA PRIVATE KEY-----")>=0&&e.target.result.indexOf("-----END RSA PRIVATE KEY-----")>=0;QE("idx_dlgOkButton",t),QS("d2badkey").color=t?"#000":"#F00"},t.readAsText(Q("dp2key").files[0])}}e&&13==e.keyCode&&e.target&&1==Q("dp2authmethod").value&&("dp2user"==e.target.id&&Q("dp2pass").focus(),"dp2pass"==e.target.id&&dialogclose(1))}function sshConnectEx(e){if(0==e)null!=terminal&&connectTerminal();else{var t=0;if(1==Q("dp2authmethod").value)4194304&features2||(t=Q("dp2keep").checked?1:0),terminal.socket.send(JSON.stringify({action:"sshauth",username:Q("dp2user").value,password:Q("dp2pass").value,keep:t,cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight}));else if(3==Q("dp2authmethod").value)terminal.socket.send(JSON.stringify({action:"sshkeyauth",keypass:Q("dp2keypass2").value,cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight}));else{4194304&features2||1==(t=Q("dp2keep1").checked?1:0)&&(t+=Q("dp2keep2").checked?1:0);var n=new FileReader,o=Q("dp2user").value,i=Q("dp2keypass").value;n.onload=function(e){terminal.socket.send(JSON.stringify({action:"sshauth",username:o,keypass:i,key:e.target.result,keep:t,cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight}))},n.readAsText(Q("dp2key").files[0])}}}function xTermSendResize(){xtermResizeTimer=null,null!=xterm&&null!=terminal&&null!=terminal.sendCtrlMsg&&("sshterminalrelay.ashx"==terminal.urlname?terminal.socket.send(JSON.stringify({action:"resize",cols:xterm.cols,rows:xterm.rows,width:Q("termarea3xdiv").offsetWidth,height:Q("termarea3xdiv").offsetHeight})):terminal.sendCtrlMsg(JSON.stringify({ctrlChannel:"102938",type:"termsize",cols:xterm.cols,rows:xterm.rows})))}function connectTerminal(e,t,n){if(p12clearConsoleMsg(),terminal)"ssh"==xxdialogTag&&setDialogMode(0),terminal.Stop(),terminal=null,fullscreen&&deskToggleFull();else if(2==t){if(null==terminalNode.intelamt.user||""==terminalNode.intelamt.user)return void editDeviceAmtSettings(terminalNode._id,connectTerminal,2);var o={};1==Q("termSizeList").value?(o.cols=80,o.rows=25):2==Q("termSizeList").value&&(o.cols=100,o.rows=30),fullscreen&&deskToggleFull(),QV("termarea3xdiv",!1),QV("Term",!0),(terminal=CreateAmtRedirect(CreateAmtRemoteTerminal("Term",o),authCookie)).debugmode=debugmode,terminal.m.debugmode=debugmode,terminal.m.onTitleChange=function(e,t){QH("termtitle"," - "+EscapeHtml(t))},terminal.onStateChanged=onTerminalStateChange,terminal.Start(terminalNode._id,16994,"*","*",0),terminal.contype=2,Q("id_ttypebutton").value=terminalEmulations[terminal.m.terminalEmulation]}else{o={protocol:null!=n&&"number"==typeof n.protocol?n.protocol:1};n&&n.requireLogin&&(o.requireLogin=!0),n&&n.consent&&(o.consent=n.consent),-1==[1,2,3,4,21,22].indexOf(currentNode.agent.id)&&(1==Q("termSizeList").value?(o.cols=80,o.rows=25,o.xterm=!0):2==Q("termSizeList").value?(o.cols=100,o.rows=30,o.xterm=!0):3==Q("termSizeList").value&&(o.cols=Math.floor((Q("column_l").clientWidth-60)/10),o.rows=Math.floor((Q("column_l").clientHeight-120)/20),o.xterm=!0)),e&&1==e.shiftKey&&(currentNode.agent.id>4?1==o.protocol&&(o.protocol=7):1==o.protocol&&(o.protocol=6)),null!=serverinfo.linuxshell&&currentNode.agent.id>4&&("root"==serverinfo.linuxshell&&(o.protocol=1,delete o.requireLogin),"user"==serverinfo.linuxshell&&(o.protocol=8,delete o.requireLogin),"login"==serverinfo.linuxshell&&(o.protocol=1,o.requireLogin=!0)),0!==args.xterm?(QV("termarea3xdiv",!0),QV("Term",!1),null!=xterm&&xterm.dispose(),xtermfit=new FitAddon.FitAddon,xterm=new Terminal,xtermfit&&xterm.loadAddon(xtermfit),xterm.open(Q("termarea3xdiv")),xterm.onData(function(e){null!=terminal&&("sshterminalrelay.ashx"==terminal.urlname?terminal.socket.send("~"+e):terminal.sendText(e))}),xtermfit&&xtermfit.fit(),xterm.onTitleChange(function(e){QH("termtitle"," - "+EscapeHtml(e))}),xterm.onResize(function(e){xtermResizeTimer&&clearTimeout(xtermResizeTimer),xtermResizeTimer=setTimeout(xTermSendResize,200)}),o.cols=xterm.cols,o.rows=xterm.rows,terminal=CreateAgentRedirect(meshserver,CreateRemoteTunnel(3==t?sshTunnelUpdate:tunnelUpdate,o),serverPublicNamePort,authCookie,authRelayCookie,domainUrl),3==t&&(terminal.urlname="sshterminalrelay.ashx"),terminal.debugmode=debugmode,terminal.m.debugmode=debugmode,terminal.options=o,o.requireLogin&&(terminal.options.requireLogin=!0),terminal.Start(terminalNode._id),terminal.onStateChanged=onTerminalStateChange,terminal.contype=t,terminal.attemptWebRTC=!1,terminal.onConsoleMessageChange=function(){p12setConsoleMsg(terminal.consoleMessage?formatAgentConsoleMessage(terminal.consoleMessage,terminal.consoleMessageId,terminal.consoleMessageArgs):null,terminal.consoleMessageTimeout)}):(QV("termarea3xdiv",!1),QV("Term",!0),(terminal=CreateAgentRedirect(meshserver,CreateAmtRemoteTerminal("Term",o),serverPublicNamePort,authCookie,authRelayCookie,domainUrl)).options=o,terminal.debugmode=debugmode,terminal.m.debugmode=debugmode,terminal.m.onTitleChange=function(e,t){QH("termtitle"," - "+EscapeHtml(t))},terminal.m.lineFeed=[1,2,3,4,21,22].indexOf(currentNode.agent.id)>=0?"\r\n":"\r",terminal.attemptWebRTC=!1,terminal.onStateChanged=onTerminalStateChange,terminal.onConsoleMessageChange=function(){p12setConsoleMsg(terminal.consoleMessage?formatAgentConsoleMessage(terminal.consoleMessage,terminal.consoleMessageId,terminal.consoleMessageArgs):null,terminal.consoleMessageTimeout)},terminal.Start(terminalNode._id),terminal.contype=t,terminal.m.terminalEmulation=0,terminal.m.fxEmulation=0,Q("id_ttypebutton").value=terminalEmulations[0])}Q("connectbutton2").blur()}var terminalEmulations=["Терминал UTF8","Расширенный ASCII","Intel ASCII"];function termToggleType(){terminal&&!xxdialogMode&&(terminal.m.terminalEmulation=(terminal.m.terminalEmulation+1)%3,Q("id_ttypebutton").value=terminalEmulations[terminal.m.terminalEmulation],Q("id_ttypebutton").blur())}var filesNode,fxEmulations=["Intel (F10 = ESC+[OM)","Поменять (F10 = ESC+0)","VT100+ (F10 = ESC+[OY)"];function termToggleFx(){terminal&&!xxdialogMode&&(terminal.m.fxEmulation=(terminal.m.fxEmulation+1)%3,Q("id_tfxkeysbutton").value=fxEmulations[terminal.m.fxEmulation],Q("id_tfxkeysbutton").blur())}function termToggleCr(){terminal&&!xxdialogMode&&("\n"==terminal.m.lineFeed?terminal.m.lineFeed="\r\n":terminal.m.lineFeed="\n",Q("id_tcrbutton").value="\r\n"==terminal.m.lineFeed?"CR+LF":"LF")}function termSendKey(e,t){terminal&&!xxdialogMode&&(null!=xterm?("sshterminalrelay.ashx"==terminal.urlname?terminal.socket.send("~"+String.fromCharCode(e)):terminal.sendText?terminal.sendText(String.fromCharCode(e)):terminal.send(String.fromCharCode(e)),xterm.focus()):null!=terminal&&(terminal.m.TermSendKey(e),Q(t).blur()))}function showTermPasteDialog(){terminal&&!xxdialogMode&&(Q("pastebutton").blur(),setModalContent("xxAddAgent","Вставить",'<textarea id=d2pasteText style="width:100%;height:184px;resize:none"></textarea>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showTermPasteDialogEx()),Q("d2pasteText").focus())}function showTermPasteDialogEx(){terminal&&terminal.m.TermSendKeys(Q("d2pasteText").value)}function sendSpecialKey(){null!=xterm?("sshterminalrelay.ashx"==terminal.urlname?terminal.socket.send("~"+String.fromCharCode(Q("specialkeylist").value)):terminal.sendText(String.fromCharCode(Q("specialkeylist").value)),xterm.focus()):null!=terminal&&(terminal.m.TermSendKey(Q("specialkeylist").value),Q("specialkeylist").blur(),Q("specialkeylistinput").blur())}function setupFiles(){filesNode!=currentNode&&null!=files&&filesNode._id!=currentNode._id&&(files.Stop(),filesNode=null,files=null);var e=!!(1&(filesNode=currentNode).conn)||3==filesNode.mtype;QE("p13Connect",e),QE("p13Connectdrop",e),QE("p13Connects",e),QE("p13Connectsdrop",e),QV("p13Connectspan",null==files&&2==filesNode.mtype),QV("p13Connectsspan",!(!(512&features2)||null==filesNode.agent||3==filesNode.agent.id||4==filesNode.agent.id||8388608&features2)),QV("p13Disconnect",null!=files),p13setActions()}function onFilesStateChange(e,t){setSessionActivity(),QV("p13Connectspan",0==t&&2==filesNode.mtype),QV("p13Connectsspan",0==t&&512&features2&&null!=filesNode.agent&&3!=filesNode.agent.id&&4!=filesNode.agent.id&&!(8388608&features2)),QV("p13Disconnect",0!=t);var n=StatusStrs[t];switch(3==t&&(2==files.contype&&(n+=", SFTP"),1==files.webRtcActive&&(n+=", WebRTC")),Q("p13Status").textContent=n,t){case 0:QH("p13files",""),p13filetree=null,p13filetreelocation=[],QH("p13currentpath",""),QE("p13FolderUp",!1),QV("filesRecordIcon",!1),p13setActions(),null!=files&&(files.Stop(),files=null),"fileMsgDialog"==xxdialogTag&&setDialogMode(0),null!=uploadFile&&(p13uploadFileTransferDone(),uploadFile=null);break;case 3:if(p13filetreelocation=[],p13targetpath="",files){var o=[];try{o=JSON.parse(getstore("_devFilePaths","[]"))}catch(e){}for(var i=0;i<o.length;i++)o[i].n==currentNode._id&&(p13targetpath=o[i].p);p13filetreelocation=p13targetpath.split("/"),files.sendText({action:"ls",reqid:1,path:p13targetpath}),1==files.serverIsRecording&&QV("filesRecordIcon",!0)}}}function CreateRemoteFiles(e){var t={protocol:5};return t.onFileUpdate=e,t.xxStateChange=function(e){},t.ProcessData=function(e){t.onFileUpdate(e)},t}var autoConnectFilesTimer=null;function autoConnectFiles(e){null==autoConnectFilesTimer?autoConnectFilesTimer=setInterval(connectFiles,100):(clearInterval(autoConnectFilesTimer),autoConnectFilesTimer=null)}function connectFiles(e,t,n){p13clearConsoleMsg(),files?(files.Stop(),files=null):(files=CreateAgentRedirect(meshserver,CreateRemoteFiles(p13gotFiles),serverPublicNamePort,authCookie,authRelayCookie,domainUrl),2==t&&(files.urlname="sshfilesrelay.ashx"),files.contype=t,files.options={consent:n},files.attemptWebRTC=attemptWebRTC,files.webrtcconfig=webrtcconfiguration,files.onStateChanged=onFilesStateChange,files.onConsoleMessageChange=function(){files.consoleMessage?(Q("p13FilesConsoleMsg").innerHTML+=formatAgentConsoleMessage(files.consoleMessage,files.consoleMessageId,files.consoleMessageArgs),QV("p13FilesConsoleMsg",!0),null!=p13FilesConsoleMsgTimer&&clearTimeout(p13FilesConsoleMsgTimer),files.consoleMessageTimeout&&(p13FilesConsoleMsgTimer=setTimeout(p13clearConsoleMsg,1e3*files.consoleMessageTimeout))):p13clearConsoleMsg()},files.Start(filesNode._id)),p13clipboard=p13clipboardFolder=null,p13clipboardCut=0,p13updateClipview()}var p13sortorder,p13filetree=null,p13targetpath=null,p13filetreelocation=[];function p13fileOperationDialogEx(e){0==e&&null!=files&&files.sendText({action:"cancel"})}function p13gotFiles(e){if(e.length>0&&123!=e.charCodeAt(0))p13gotDownloadBinaryData(e);else{try{e=JSON.parse(decode_utf8(e))}catch(t){try{e=JSON.parse(e)}catch(t){return void console.log("Unable to parse: "+e)}}if("download"!=e.action)if("findfile"!=e.action)if(null!=e.action&&e.action.startsWith("upload"))p13gotUploadData(e);else{switch(e.action){case"sshauth":return void sshTunnelAuthDialog(e,p13sshConnectEx);case"autherror":return void p13setConsoleMsg("Ошибка аутентификации",5e3);case"connectionerror":return void p13setConsoleMsg("Ошибка соединения",5e3);case"sessionerror":return void p13setConsoleMsg("Сессия истекла",5e3);case"sessiontimeout":return void p13setConsoleMsg("Тайм-аут сеанса",5e3)}if("dialogmessage"!=e.action)if("refresh"!=e.action){if(null!=e.path)if(null==e.dir)""!=p13targetpath&&p13folderup();else if(e.path=e.path.replace(/\//g,"\\"),null!=p13filetree&&e.path==p13filetree.path){var t=p13getCheckedNames();p13filetree=e,p13updateFiles(t)}else{for(var n=e.path.replace(/\//g,"\\"),o=p13targetpath.replace(/\//g,"\\");n.length>0&&"\\"==n[0];)n=n.substring(1);for(;o.length>0&&"\\"==o[0];)o=o.substring(1);(n==o||"\\"==e.path&&""==p13targetpath)&&(p13filetree=e,p13updateFiles())}}else p13folderup(9999);else null==e.msg&&"fileMsgDialog"==xxdialogTag?setDialogMode(0):"zipping"!=e.msg||xxdialogMode&&"fileMsgDialog"!=xxdialogTag?"unzipping"!=e.msg||xxdialogMode&&"fileMsgDialog"!=xxdialogTag?"unziperror"!=e.msg||xxdialogMode&&"fileMsgDialog"!=xxdialogTag?"zippingFile"!=e.msg||xxdialogMode&&"fileMsgDialog"!=xxdialogTag||(setModalContent("xxAddAgent","Работа с файлами","<div style=margin:10px>"+EscapeHtml(e.file)+"</div><br /><progress value="+EscapeHtml(e.progress)+" style=width:100% max=100 />"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13fileOperationDialogEx(10))):(setModalContent("xxAddAgent","Работа с файлами","<div style=margin:10px>Unzipping Error</div><br />"+EscapeHtml(e.error)),showModal("xxAddAgentModal","idx_dlgOkButton")):(setModalContent("xxAddAgent","Работа с файлами","<div style=margin:10px>Unzipping file...</div>"),showModal("xxAddAgentModal","idx_dlgOkButton")):(setModalContent("xxAddAgent","Работа с файлами","<div style=margin:10px>Сжатие файлов ...</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13fileOperationDialogEx(10)))}else xxdialogTag==e.reqid&&(null==e.r?(QE("d2findFilter",!0),QE("filefind_dlgOkButton",!0),xxdialogTag=null,""==Q("d2findResults").innerHTML&&QH("d2findResults","<div style=text-align:center;margin:10px><i>Файлы не найдены</i></div>")):QA("d2findResults","<div style=white-space:nowrap>"+EscapeHtml(e.r)+"</div>"));else p13gotDownloadCommand(e)}}function p13sshConnectEx(e){if(0==e)null!=files&&connectFiles();else{var t=0;if(1==Q("dp2authmethod").value)4194304&features2||(t=Q("dp2keep").checked?1:0),files.socket.send(JSON.stringify({action:"sshauth",username:Q("dp2user").value,password:Q("dp2pass").value,keep:t}));else if(3==Q("dp2authmethod").value)files.socket.send(JSON.stringify({action:"sshkeyauth",keypass:Q("dp2keypass2").value}));else{4194304&features2||1==(t=Q("dp2keep1").checked?1:0)&&(t+=Q("dp2keep2").checked?1:0);var n=new FileReader,o=Q("dp2user").value,i=Q("dp2keypass").value;n.onload=function(e){files.socket.send(JSON.stringify({action:"sshauth",username:o,keypass:i,key:e.target.result,keep:t}))},n.readAsText(Q("dp2key").files[0])}}}function p13getCheckedNames(){for(var e=[],t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&e.push(p13filetree.dir[t[n].value].n);return e}function p13updateFiles(e){var t="",n="",o='<a href=# style=cursor:pointer onclick="return p13folderup(0)">Root/Корень</a>';if(null!=p13filetree){var i=p13filetree.path.split("\\");for(var a in p13filetreelocation=[],i)""!=i[a]&&p13filetreelocation.push(i[a]);for(var a in p13filetreelocation)o+=' / <a href=# style=cursor:pointer onclick="return p13folderup('+(parseInt(a)+1)+')">'+EscapeHtml(p13filetreelocation[a])+"</a>";var s=p13filetreelocation.join("/"),r=p13sort_files(p13filetree.dir);for(var a in r){var l,d=r[a],c=d.n;l=c.length>70?'<span title="'+EscapeHtml(c)+'">'+EscapeHtml(c.substring(0,70))+"...</span>":EscapeHtml(c);var u="";if(null!=d.d){var p=new Date(d.d);"number"==typeof d.d&&(p=new Date(1e3*d.d));u=printDateTime(p)+"&nbsp;"}var m="";if(null!=d.s){const e=["Bytes","KB","MB","GB","TB"],t=parseInt(Math.floor(Math.log(Math.abs(d.s))/Math.log(1024)),10),n=Q("p13sizedropdown").options[Q("p13sizedropdown").selectedIndex];m=0==Q("p13sizedropdown").value?0===d.s?"n/a":0===t?`${d.s} ${e[t]}`:`${(d.s/1024**t).toFixed(2)} ${e[t]}`:1==Q("p13sizedropdown").value?getFileSizeStr(d.s):`${(d.s/2**n.value).toFixed(2)} ${n.title}`}var g="";if(d.t<3){g="<div class=filelist file=999>",g+='<input file=999 style=float:left name=fd class=fcb type=checkbox class="form-check-input me-2" onchange=p13setActions() value=\''+d.nx+'\'>&nbsp;<span style=float:right title=""></span>',g+="<span><div class=fileIcon"+("REMOVABLE"==d.dt?5:"CDROM"==d.dt?6:d.t)+' onclick=p13folderset("'+encodeURIComponentEx(d.nx)+'")></div><a href=# style=cursor:pointer onclick=\'return p13folderset("'+encodeURIComponentEx(d.nx)+"\")'>",isWindowsNode(currentNode)&&d.dt&&currentNode.volumes&&currentNode.volumes[l.charAt(0).toUpperCase()]&&currentNode.volumes[l.charAt(0).toUpperCase()].name?g+=currentNode.volumes[l.charAt(0).toUpperCase()].name+" ("+l+")":g+=l,g+="</a></span></div>"}else{var v=l;d.s>0&&(v=3==filesNode.mtype?"<a href=# style=cursor:pointer onclick=\"return p13downloadfile('"+encodeURIComponentEx(s+"/"+c)+"','"+encodeURIComponentEx(c)+"',"+d.s+')">'+l+"</a>":'<a onclick=downloadFile("devicefile.ashx?c='+authCookie+"&m="+currentNode.meshid.split("/")[2]+"&n="+currentNode._id.split("/")[2]+"&f="+encodeURIComponentEx(s+"/"+c)+'","'+encodeURIComponentEx(c)+'") style=cursor:pointer>'+l+"</a>"),g="<div id=fileEntry cmenu=filesContextMenu fileIndex="+a+' class=filelist file=3><input file=3 style=float:left name=fd class=fcb type=checkbox class="form-check-input me-2" onchange=p13setActions() value=\''+d.nx+"'>&nbsp;<span class=fsize>"+u+"</span><span style=float:right>"+EscapeHtml(m)+"</span><span><div class=fileIcon"+d.t+"></div>"+v+"</span></div>"}d.t<3?t+=g:n+=g}if(QH("p13files",t+n),QH("p13currentpath",o),QE("p13FolderUp",0!=p13filetreelocation.length),null!=e){var h=document.getElementsByName("fd");for(a=0;a<h.length;a++)e.indexOf(p13filetree.dir[h[a].value].n)>=0&&(h[a].checked=!0)}p13setActions()}}function p13openfilefolder(){setModalContent("xxAddAgent","Open File/Folder","Are you sure you want to open this file/folder on the remote devices desktop?"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13openfilefolderEx())}function p13openfilefolderEx(){for(var e="",t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&(e=(isWindowsNode(currentNode)?"":"/")+p13filetreelocation.join(isWindowsNode(currentNode)?"\\":"/")+(isWindowsNode(currentNode)?"\\":"/")+p13filetree.dir[t[n].value].n);""!=e&&files.sendText({action:"open",reqid:1,path:e,dir:1==p13getFileSelDirCount()})}function p13gotofolder(){xxdialogButtons=3,setModalContent("xxAddAgent","Go To Folder",'<input type=text id=p13folderinput style=width:100% placeholder="'+(isWindowsNode(currentNode)?"C:\\":"/var/www")+'" />'),showModal("xxAddAgentModal","idx_dlgOkButton",p13gotofolderEx),focusTextBox("p13folderinput")}function p13gotofolderEx(){p13targetpath=Q("p13folderinput").value.split("\\").join("/"),files&&(p13storeCurrentPath(p13targetpath),files.sendText({action:"ls",reqid:1,path:p13targetpath}))}function p13folderset(e){p13targetpath=joinPaths(p13filetree.path,p13filetree.dir[e].n).split("\\").join("/"),files&&(p13storeCurrentPath(p13targetpath),files.sendText({action:"ls",reqid:1,path:p13targetpath}))}function p13folderup(e){if(null==e)p13filetreelocation.pop();else for(;p13filetreelocation.length>e;)p13filetreelocation.pop();return p13targetpath=p13filetreelocation.join("/"),files&&(p13storeCurrentPath(p13targetpath),files.sendText({action:"ls",reqid:1,path:p13targetpath})),!1}function p13storeCurrentPath(e){var t=[],n=-1;try{t=JSON.parse(getstore("_devFilePaths","[]"))}catch(e){}for(var o=0;o<t.length;o++)t[o].n==currentNode._id&&(n=o);for(n>=0&&t.splice(n,1),t.push({n:currentNode._id,p:e});t.length>40;)t.shift();putstore("_devFilePaths",JSON.stringify(t))}function p13findfile(){if(!xxdialogMode){var e=addHtmlFormFloating("Фильтр",'<input id=d2findFilter class="form-control" onkeyup=p13findfileValidate() onkeydown=p13findfileDown(event) placeholder="*.txt"></input>');e+='<div id=d2findResults style="width:100%;height:184px;background-color:white;border:1px solid black;padding:3px;overflow:scroll;margin-top:8px"></div>',e+="<div style=margin-top:8px><input id=filefind_dlgCancelButton type=button value=Закрыть style=float:right;width:80px;margin-left:5px onclick=p13findfileCancel()>",setModalContent("xxAddAgent","Найти файлы",e+="<input id=filefind_dlgOkButton type=submit value=Поиск style=float:right;width:80px onclick=p13findfileEx()><br /><br /></div>"),showModal("xxAddAgentModal","idx_dlgOkButton"),p13findfileValidate(),Q("d2findFilter").focus()}}function p13findfileDown(e){"Ввод"==e.code&&p13findfileEx()}function p13findfileValidate(){QE("filefind_dlgOkButton",Q("d2findFilter").value.length>0)}function p13findfileCancel(){null!=xxdialogTag&&files.sendText({action:"cancelfindfile",reqid:xxdialogTag}),dialogclose(0)}function p13findfileEx(e,t){if(0!=Q("d2findFilter").value.length){var n=currentNode.agent.id>0&&currentNode.agent.id<5||14==currentNode.agent.id||34==currentNode.agent.id,o=n?"\\":"/",i=p13filetreelocation.join(o)+o;n||(i=o+i),xxdialogTag="find:"+Math.random(),files.sendText({action:"findfile",reqid:xxdialogTag,path:i,filter:Q("d2findFilter").value}),QH("d2findResults",""),QE("d2findFilter",!1),QE("filefind_dlgOkButton",!1)}}function p13sort_filename(e,t){return e.ln>t.ln?1*p13sortorder:e.ln<t.ln?-1*p13sortorder:0}function p13sort_timestamp(e,t){return e.d>t.d?1*p13sortorder:e.d<t.d?-1*p13sortorder:0}function p13sort_bysize(e,t){return e.s==t.s?p13sort_filename(e,t):(e.s-t.s)*p13sortorder}function p13sort_files(e){var t=[],n=Q("p13sortdropdown").value;for(var o in e)e[o].nx=o,null==e[o].s&&(e[o].s=0),null==e[o].n&&(e[o].n=o),e[o].ln=e[o].n.toLowerCase(),t.push(e[o]);return p13sortorder=1,n>3&&(p13sortorder=-1,n-=3),1==n?t.sort(p13sort_filename):2==n?t.sort(p13sort_bysize):3==n&&t.sort(p13sort_timestamp),t}function p13setActions(){var e=null!=currentNode.agent&&14!=currentNode.agent.id;if(null==p13filetree)QE("p13DeleteFileButton",!1),QE("p13NewFolderButton",!1),QE("p13UploadButton",!1),QE("p13RenameFileButton",!1),QE("p13ViewFileButton",!1),QE("p13SelectAllButton",!1),Q("p13SelectAllButton").value="Выбрать все",QE("p13RefreshButton",!1),QE("p13FindButton",!1),QE("p13CutButton",!1),QE("p13CopyButton",!1),QE("p13ZipButton",!1),QE("p13UnZipButton",!1),QE("p13PasteButton",!1),QE("p13GoToFolderButton",!1),QE("p13DownloadButton",!1),QE("p13OpenButton",!1);else{var t=p13getFileSelCount(),n=p13getFileCount(),o=p13getFileSelCount(!1),i=currentNode.agent.id>0&&currentNode.agent.id<5||14==currentNode.agent.id||34==currentNode.agent.id;QE("p13DeleteFileButton",t>0&&(p13filetreelocation.length>0||0==i)),QE("p13NewFolderButton",e&&(p13filetreelocation.length>0||0==i)),QE("p13UploadButton",p13filetreelocation.length>0||0==i||14==currentNode.agent.id),QE("p13RenameFileButton",e&&1==t&&(p13filetreelocation.length>0||0==i)),QE("p13ViewFileButton",e&&1==t&&1==o&&(p13filetreelocation.length>0||0==i)),QE("p13SelectAllButton",n>0),Q("p13SelectAllButton").value=t>0?"Очистить все":"Выбрать все",QE("p13RefreshButton",!0),QE("p13FindButton",e&&(p13filetreelocation.length>0||0==i)),QE("p13CutButton",e&&t>0&&t==o&&(p13filetreelocation.length>0||0==i)),QE("p13CopyButton",e&&t>0&&t==o&&(p13filetreelocation.length>0||0==i)),QE("p13ZipButton",e&&t>0&&(p13filetreelocation.length>0||0==i)),QE("p13UnzipButton",e&&1==t&&1==o&&(p13filetreelocation.length>0||0==i)&&p13getFileSelAllowedExt(".zip")),QE("p13PasteButton",e&&(p13filetreelocation.length>0||0==i)&&null!=p13clipboard&&p13clipboard.length>0),QE("p13GoToFolderButton",e),QE("p13OpenButton",e&&1==t),QE("p13DownloadButton",t>0&&t==o&&(p13filetreelocation.length>0||0==i))}1==(null!=files&&0!=files.state)&&2!=files.contype||null==filesNode.agent||3==filesNode.agent.id||4==filesNode.agent.id?QH("filesCustomUpperRight",""):QH("filesCustomUpperRight","<a style=cursor:pointer onclick=cmsshportaction(1,event)>"+format("Порт SSH {0}",filesNode.sshport?filesNode.sshport:22)+"</a>"),QV("filesActionsBtn",3!=filesNode.mtype),QV("p13FindButton",3!=filesNode.mtype),QV("p13CutButton",3!=filesNode.mtype),QV("p13CopyButton",3!=filesNode.mtype),QV("p13ZipButton",3!=filesNode.mtype),QV("p13UnzipButton",3!=filesNode.mtype),QV("p13PasteButton",3!=filesNode.mtype)}function p13getFileSelCount(e){for(var t=0,n=document.getElementsByName("fd"),o=0;o<n.length;o++)!n[o].checked||0==e&&"3"!=n[o].attributes.file.value||t++;return t}function p13getFileSelDirCount(){for(var e=0,t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&"999"==t[n].attributes.file.value&&e++;return e}function p13getFileCount(){return document.getElementsByName("fd").length}function p13getFileSelAllowedExt(e){for(var t=document.getElementsByName("fd"),n=0;n<t.length;n++)if(t[n].checked&&!p13filetree.dir[t[n].value].n.endsWith(e))return!1;return!0}function p13selectallfile(){for(var e=0==p13getFileSelCount(),t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked=e;p13setActions()}function p13createfolder(){setModalContent("xxAddAgent","Новая папка","<input type=text id=p13renameinput maxlength=64 onkeyup=p13fileNameCheck(event) style=width:100% />"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13createfolderEx()),focusTextBox("p13renameinput"),p13fileNameCheck()}function p13createfolderEx(){files.sendText({action:"mkdir",reqid:1,path:p13filetreelocation.join("/")+"/"+Q("p13renameinput").value}),p13folderup(999)}function p13deletefile(){var e=p13getFileSelCount(),t=p13getFileSelDirCount()>0?'<br /><br /><label><input type=checkbox class="form-check-input me-2" id=p13recdeleteinput>Рекурсивное удаление</label><br>':"<input type=checkbox class=\"form-check-input me-2\" id=p13recdeleteinput style='display:none'>";setModalContent("xxAddAgent","Удалить",e>1?format("Удалить {0} выбранных элементов?",e)+t:"Удалить выбранные элементы?"+t),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13deletefileEx())}function p13deletefileEx(){for(var e=[],t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&e.push(p13filetree.dir[t[n].value].n);files.sendText({action:"rm",reqid:1,path:p13filetreelocation.join("/"),delfiles:e,rec:Q("p13recdeleteinput").checked}),p13folderup(999)}function p13renamefile(){for(var e,t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&(e=p13filetree.dir[t[n].value].n);setModalContent("xxAddAgent","Переименовать",'<input type=text id=p13renameinput maxlength=64 onkeyup=p13fileNameCheck(event) style=width:100% value="'+e+'" />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13renamefileEx(3,{oldname:e})),focusTextBox("p13renameinput"),p13fileNameCheck()}function p13renamefileEx(e,t){t.newname=Q("p13renameinput").value,files.sendText(t),p13folderup(999)}function p13fileNameCheck(e){var t=isFilenameValid(Q("p13renameinput").value);QE("idx_dlgOkButton",t),1==t&&null!=e&&13==e.keyCode&&dialogclose(1)}function p13uploadFile(){setModalContent("xxAddAgent","Загрузить файл",'<input type=file name=files id=p13uploadinput class="form-control" multiple=multiple onchange="updateUploadDialogOk(\'p13uploadinput\')" />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13uploadFileEx()),updateUploadDialogOk("p13uploadinput")}function updateUploadDialogOk(e){QE("idx_dlgOkButton",Q("p13uploadinput").files.length>0)}function p13uploadFileEx(){return p13doUploadFiles(Q("p13uploadinput").files),!1}function p13viewfile(){for(var e=document.getElementsByName("fd"),t=0;t<e.length;t++)if(e[t].checked){p13filetree.dir[e[t].value].s<=204800?p13downloadfile(encodeURIComponentEx(p13filetreelocation.join("/")+"/"+p13filetree.dir[e[t].value].n),encodeURIComponentEx(p13filetree.dir[e[t].value].n),p13filetree.dir[e[t].value].s,"viewer"):messagebox("Редактор файлов","Редактировать можно только файлы размером менее 200КБ.");break}}function p13unzipFile(){for(var e,t,n=document.getElementsByName("fd"),o=0;o<n.length;o++)if(n[o].checked){var i=isWindowsNode(currentNode)?"\\":"/";e=(isWindowsNode(currentNode)?"":"/")+p13filetreelocation.join(i)+i+p13filetree.dir[n[o].value].n.split(".zip")[0]+i,t=(isWindowsNode(currentNode)?"":"/")+p13filetreelocation.join(i)+i+p13filetree.dir[n[o].value].n}setModalContent("xxAddAgent","Unzip To Folder",'<input type=text id=p13unzipfolderinput maxlength=64 style=width:100% value="'+e+'" />'),showModal("xxAddAgentModal","idx_dlgOkButton",p13unzipFileEx(3,{action:"unzip",input:t})),focusTextBox("p13unzipfolderinput")}function p13unzipFileEx(e,t){t.dest=Q("p13unzipfolderinput").value,files.sendText(t)}function p13zipFiles(){for(var e=[],t=document.getElementsByName("fd"),n=0;n<t.length;n++)t[n].checked&&e.push(p13filetree.dir[t[n].value].n);setModalContent("xxAddAgent","Zip-файл",'<input type=text id=p13renameinput maxlength=64 onkeyup=p13fileNameCheck(event) style=width:100% value="" />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13zipFilesEx(3,{action:"zip",path:p13filetreelocation.join("/"),files:e})),focusTextBox("p13renameinput"),p13fileNameCheck()}function p13zipFilesEx(e,t){t.output=Q("p13renameinput").value,t.output.toLowerCase().endsWith(".zip")||(t.output+=".zip"),files.sendText(t)}var p13clipboard=null,p13clipboardFolder=null,p13clipboardCut=0;function p13copyFile(e){var t=document.getElementsByName("fd");p13clipboard=[],p13clipboardCut=e,p13clipboardFolder=p13targetpath;for(var n=0;n<t.length;n++)t[n].checked&&"3"==t[n].attributes.file.value&&p13clipboard.push(p13filetree.dir[t[n].value].n);p13updateClipview()}function p13pasteFile(){var e="";null!=p13clipboard&&p13clipboard.length>0&&(e=0==p13clipboardCut?p13clipboard.length>1?format("Подтвердить копирование {0} записей в это расположение?",p13clipboard.length):format("Подтвердить копирование 1 записи в это расположение?"):p13clipboard.length>1?format("Подтвердить перемещение {0} записей в это расположение?",p13clipboard.length):format("Подтвердить перемещение 1 записи в это расположение?")),setModalContent("xxAddAgent","Вставить",e),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13pasteFileEx())}function p13pasteFileEx(){files.sendText({action:0==p13clipboardCut?"copy":"move",reqid:1,scpath:p13clipboardFolder,dspath:p13targetpath,names:p13clipboard}),p13folderup(999),1==p13clipboardCut&&(p13clipboard=null,p13clipboardFolder=null,p13clipboardCut=0,p13updateClipview())}function p13updateClipview(){var e="";null!=p13clipboard&&p13clipboard.length>0&&(e=0==p13clipboardCut?p13clipboard.length>1?format('Задержано {0} записей для копирования, <a href=# onclick="return p13clearClip()" style=cursor:pointer>Очистить</a>.',p13clipboard.length):format('Задержана 1 запись для копирования, <a href=# onclick="return p13clearClip()" style=cursor:pointer>Очистить</a>.'):p13clipboard.length>1?format('Задержано {0} записей для перемещения, <a href=# onclick="return p13clearClip()" style=cursor:pointer>Очистить</a>.',p13clipboard.length):format('Задержана 1 запись для перемещения, <a href=# onclick="return p13clearClip()" style=cursor:pointer>Очистить</a>.')),QH("p13bottomstatus",e),p13setActions()}function p13clearClip(){return p13clipboard=null,p13clipboardFolder=null,p13clipboardCut=0,p13updateClipview(),!1}function p13fileDragDrop(e){if(haltEvent(e),QV("p13bigfail",!1),QV("p13bigok",!1),null!=e.dataTransfer&&0!=e.dataTransfer.files.length&&null!=p13filetree){var t=[];for(var n in e.dataTransfer.files)null!=e.dataTransfer.files[n].size&&0!=e.dataTransfer.files[n].size&&t.push(e.dataTransfer.files[n]);0!=t.length&&p13doUploadFiles(t)}}var gdownloadFile,p13dragtimer=null;function p13fileDragOver(e){haltEvent(e),null!=p13dragtimer&&(clearTimeout(p13dragtimer),p13dragtimer=null);var t=null!=p13filetree;QV("p13bigok",t),QV("p13bigfail",!t)}function p13fileDragLeave(e){haltEvent(e),"p13filetable"!=e.target.id?(QV("p13bigfail",!1),QV("p13bigok",!1)):p13dragtimer=setTimeout(function(){QV("p13bigfail",!1),QV("p13bigok",!1),p13dragtimer=null},10)}function p13downloadfile(e,t,n,o){!xxdialogMode&&files&&(gdownloadFile={path:decodeURIComponent(e),file:decodeURIComponent(t),size:n,tsize:0,data:"",state:0,id:Math.random(),tag:o},files.sendText({action:"download",sub:"start",id:gdownloadFile.id,path:gdownloadFile.path}),setModalContent("xxAddAgent","Скачать файл","<div>"+gdownloadFile.file+"</div><br /><progress id=d2progressBar style=width:100% value=0 max="+n+" />"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13downloadFileCancel()))}function p13downloadFileCancel(){setDialogMode(0),files.sendText({action:"download",sub:"cancel",id:gdownloadFile.id}),gdownloadFile=null}function p13gotDownloadCommand(e){null!=gdownloadFile&&e.id==gdownloadFile.id&&("start"==e.sub?(gdownloadFile.state=1,files.sendText({action:"download",sub:"startack",id:gdownloadFile.id})):"cancel"==e.sub&&(gdownloadFile=null,setDialogMode(0)))}function p13gotDownloadBinaryData(e){if(gdownloadFile&&0!=gdownloadFile.state)if(e.length>4&&(gdownloadFile.tsize+=e.length-4,gdownloadFile.data+=e.substring(4),Q("d2progressBar").value=gdownloadFile.tsize),1&ReadInt(e,0))if("viewer"==gdownloadFile.tag){setModalContent("xxAddAgent",EscapeHtml(gdownloadFile.file),4,"extra-large");var t=gdownloadFile.file;showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13editSaveBack(3,t)),QV("d4EncodingButton",!0),QV("d4LineBreakButton",!0),Q("d4editorarea").value=1==d4EditEncodingVal?decode_utf8(gdownloadFile.data):gdownloadFile.data,gdownloadFile=null}else saveAs(data2blob(gdownloadFile.data),gdownloadFile.file),gdownloadFile=null,setDialogMode(0);else files.sendText({action:"download",sub:"ack",id:gdownloadFile.id})}function p13downloadButton(){for(var e=document.getElementsByName("fd"),t=0;t<e.length;t++)if(e[t].checked){var n=p13filetree.dir[e[t].value],o="devicefile.ashx?c="+authCookie;o+="&m="+currentNode.meshid.split("/")[2],o+="&n="+currentNode._id.split("/")[2],downloadFile(o+="&f="+encodeURIComponentEx(p13filetreelocation.join("/")+"/"+n.n),encodeURIComponentEx(n.n))}}var uploadFile,d4EditWrapVal=0,d4EditSizeVal=0,d4EditEncodingVal=0,d4EditLineBreakVal=0;function d4ToggleWrap(e){e||(d4EditWrapVal=++d4EditWrapVal%2),Q("d4WrapButton").value=["Перенос строк: ВКЛ","Перенос строк: ВЫКЛ"][d4EditWrapVal],QS("d4editorarea").overflow=0==d4EditWrapVal?"auto":"scroll",QS("d4editorarea")["white-space"]=0==d4EditWrapVal?null:"pre",putstore("editorWrap",d4EditWrapVal)}function d4ToggleSize(e){e||(d4EditSizeVal=++d4EditSizeVal%4),QS("d4editorarea")["font-size"]=["100%","125%","150%","200%"][d4EditSizeVal],Q("d4SizeButton").value=["Размер: 100%","Размер: 125%","Размер: 150%","Размер: 200%"][d4EditSizeVal],putstore("editorSize",d4EditSizeVal)}function d4ToggleEncoding(e){e||(d4EditEncodingVal=++d4EditEncodingVal%2,Q("d4editorarea").value=1==d4EditEncodingVal?decode_utf8(Q("d4editorarea").value):encode_utf8(Q("d4editorarea").value)),Q("d4EncodingButton").value=["Кодировка: RAW","Кодировка: UTF8"][d4EditEncodingVal],putstore("editorEncoding",d4EditEncodingVal)}function d4ToggleLineBreak(e){e||(d4EditLineBreakVal=++d4EditLineBreakVal%3),Q("d4LineBreakButton").value=["Line Break: Windows (CR LF)","Line Break: Linux (LF)","Line Break: Mac (CR)"][d4EditLineBreakVal],putstore("editorLineBreak",d4EditLineBreakVal)}function p13editSaveBack(e,t){var n,o=Q("d4editorarea").value;o=0===d4EditLineBreakVal?o.replace(/\r?\n|\r/g,"\r\n"):2===d4EditLineBreakVal?o.replace(/\r\n|\n/g,"\r"):o.replace(/\r\n|\r/g,"\n"),p13uploadFileContinue(1,[{name:t,size:(n=1==d4EditEncodingVal?(new TextEncoder).encode(o):(new TextEncoder).encode(decode_utf8(o))).byteLength,type:"text/plain",xdata:n}])}function p13doUploadFiles(e){if(!xxdialogMode){var t=currentNode.agent.id>0&&currentNode.agent.id<5||14==currentNode.agent.id||34==currentNode.agent.id,n=[],o=0;for(var i in p13filetree.dir)t?n.push(p13filetree.dir[i].n.toLowerCase()):n.push(p13filetree.dir[i].n);for(i=0;i<e.length;i++)t?n.indexOf(e[i].name.toLowerCase())>=0&&o++:n.indexOf(e[i].name)>=0&&o++;0==o?p13uploadFileContinue(1,e):(setModalContent("xxAddAgent","Загрузить файл",format(1==o?"Загрузка перезапишет 1 файл. Продолжить?":"Загрузка перезапишет {0} файлов. Продолжить?",o)),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p13uploadFileContinue(3,e)))}}function p13uploadFileContinue(e,t){if((uploadFile={}).xpath=p13filetreelocation.join("/"),uploadFile.xfiles=t,uploadFile.xfilePtr=-1,setModalContent("xxAddAgent","Загрузить файл","<div id=p13dfileName>Подключение...</div><br /><progress id=d2progressBar style=width:100% value=0 max=0 />"),showModal("xxAddAgentModal","idx_dlgCancelButton",()=>p13uploadFileCancel(10)),document.getElementById("idx_dlgOkButton").style.display="none",p13uploadNextFile(),3==e)return!1}const byteToHex=[];for(var n=0;n<=255;++n){var hexOctet=n.toString(16).padStart(2,"0");byteToHex.push(hexOctet)}function arrayBufferToHex(e){return Array.prototype.map.call(new Uint8Array(e),e=>byteToHex[e]).join("")}function performHash(e,t){window.crypto.subtle.digest("SHA-384",e).then(function(e){t(arrayBufferToHex(e))},function(){t(null)})}function performHashOnFile(e,t){var n=new FileReader;n.onerror=function(e){t(null)},n.onload=function(){window.crypto.subtle.digest("SHA-384",n.result).then(function(e){t(arrayBufferToHex(e))},function(){t(null)})},n.readAsArrayBuffer(e)}function p13uploadNextFile(){if(uploadFile.xfilePtr++,uploadFile.xfiles.length>uploadFile.xfilePtr){uploadFile.xptr=0;var e=uploadFile.xfiles[uploadFile.xfilePtr];if(QH("p13dfileName",EscapeHtml(e.name)),Q("d2progressBar").max=e.size,Q("d2progressBar").value=0,null==e.xdata){uploadFile.xfile=e;var t=null;for(var n in p13filetree.dir)p13filetree.dir[n].n==e.name&&(t=p13filetree.dir[n]);null!=t&&t.s<=uploadFile.xfile.size?performHashOnFile(uploadFile.xfile,function(n){files.sendText(JSON.stringify({action:"uploadhash",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:e.name,tag:{h:n.toUpperCase(),s:t.s,skip:t.s==uploadFile.xfile.size}}))}):files.sendText(JSON.stringify({action:"upload",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:e.name,size:uploadFile.xfile.size}))}else uploadFile.xdata=e.xdata,files.sendText(JSON.stringify({action:"upload",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:e.name,size:uploadFile.xdata.byteLength}))}else p13uploadFileTransferDone()}function p13uploadFileCancel(e,t){null!=uploadFile&&(files.sendText(JSON.stringify({action:"uploadcancel",reqid:uploadFile.xfilePtr})),uploadFile=null),p13uploadFileTransferDone()}function p13uploadFileTransferDone(){uploadFile=null,setDialogMode(0),p13folderup(9999)}function p13gotUploadData(e){if(null!=uploadFile&&parseInt(uploadFile.xfilePtr)==parseInt(e.reqid))switch(e.action){case"uploadstart":uploadFile.xdataPriming=8,p13uploadNextPart(!1);break;case"uploadack":p13uploadNextPart(!1);break;case"uploaddone":uploadFile.xfiles.length>uploadFile.xfilePtr+1?p13uploadNextFile():p13uploadFileTransferDone();break;case"uploaderror":p13uploadFileCancel();break;case"uploadhash":var t=uploadFile.xfiles[uploadFile.xfilePtr];t&&(e.tag.h===e.hash?e.tag.skip?p13uploadNextFile():(uploadFile.xptr=e.tag.s,files.sendText(JSON.stringify({action:"upload",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:t.name,size:uploadFile.xfile.size,append:!0}))):files.sendText(JSON.stringify({action:"upload",reqid:uploadFile.xfilePtr,path:uploadFile.xpath,name:t.name,size:uploadFile.xfile.size,append:!1})))}}function p13uploadNextPart(e){if(uploadFile.xdata){var t=uploadFile.xdata,n=uploadFile.xptr;if(n>=t.byteLength)files.sendText(JSON.stringify({action:"uploaddone",reqid:uploadFile.xfilePtr}));else{if((a=uploadFile.xptr+(attemptWebRTC?16384:65536))>t.byteLength){if(1==e)return;a=t.byteLength}var o=new Uint8Array(t.slice(n,a));if(123==o[0]||0==o[0]){var i=new Uint8Array(a-n+1);i.set(o,1),files.send(i)}else files.send(o);uploadFile.xptr=a,Q("d2progressBar").value=a}}else if(uploadFile.xfile){if(null!=uploadFile.xreader)return;if(uploadFile.xptr>=uploadFile.xfile.size)return;var a;if((a=uploadFile.xptr+(attemptWebRTC?16384:65536))>uploadFile.xfile.size){if(1==e)return;a=uploadFile.xfile.size}uploadFile.xreader=new FileReader,uploadFile.xreader.onerror=function(e){console.log(e)},uploadFile.xreader.onload=function(){var e=uploadFile.xreader.result;if(delete uploadFile.xreader,null!=e){var t=new Uint8Array(e);if(123==t[0]||0==t[0]){var n=new Uint8Array(e.byteLength+1);n.set(t,1),files.send(n)}else files.send(t);uploadFile.xptr=a,Q("d2progressBar").value=a,uploadFile.xptr>=uploadFile.xfile.size?files.sendText(JSON.stringify({action:"uploaddone",reqid:uploadFile.xfilePtr})):uploadFile.xdataPriming>0&&(uploadFile.xdataPriming--,p13uploadNextPart(!0))}},uploadFile.xreader.readAsArrayBuffer(uploadFile.xfile.slice(uploadFile.xptr,a))}}var currentDeviceEvents=null;function deviceEventsUpdate(){var e="",t=null;for(var n in currentDeviceEvents){var o=currentDeviceEvents[n],i=new Date(o.time);if(o.msg){null==o.h&&(o.h=Math.random()),printDate(i)!=t&&(null!=t&&(e+="</table>"),e+='<table class="table table-hover p3eventsTable" cellpadding=0 cellspacing=0><tr><td colspan=4 class=DevSt>'+(t=printDate(i))+"</td></tr>");var a,s="fa-mobile-screen";if("user"==o.etype&&(s="fa-user"),"server"==o.etype&&(s="fa-server"),null==o.msgid||null==eventsMessageId[o.msgid])a="string"==typeof o.msg?EscapeHtml(o.msg).split("(R)").join("&reg;"):"";else{for(var n in a=eventsMessageId[o.msgid],o.msgArgs){var r=o.msgArgs[n];"string"==typeof r&&0==r.indexOf("DATETIME:")&&(r=printFlexDateTime(new Date(parseInt(r.substring(9))))),a=a.split("{"+n+"}").join(r)}a=EscapeHtml(a).split("(R)").join("&reg;")}if(o.username){var l="";o.guestname&&(l=' / <span title="Это гостевой сеанс общего доступа">'+EscapeHtml(o.guestname)+"</span>"),a=2&userinfo.siteadmin&&o.userid?"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(o.userid)+"\");haltEvent(event);'>"+EscapeHtml(o.username)+"</a>"+l+" &rarr; "+a:EscapeHtml(o.username)+l+" &rarr; "+a}"relay"!=o.etype&&"relaylog"!=o.action||(s="fa-arrow-right-arrow-left"),e+="<tr onclick=showEventDetails("+o.h+',1) onmouseover=eventMouseHover(this,1) onmouseout=eventMouseHover(this,0) role="button"><td style=width:18px><i class="fa-solid '+s+'"></i></td><td class=g1>&nbsp;</td><td class=style10>'+printTime(i)+" - "+a+"</td></tr><tr></tr>"}}null!=t&&(e+="</table>"),""==e&&(e="<br><i>События не найдены</i><br><br>"),QH("p16events",e)}function refreshDeviceEvents(){""!=p16filterevents.value?meshserver.send({action:"events",nodeid:currentNode._id,limit:parseInt(p16limitdropdown.value),filter:p16filterevents.value}):meshserver.send({action:"events",nodeid:currentNode._id,limit:parseInt(p16limitdropdown.value)})}function showEventDetails(e,t){if(xxdialogMode)return!1;var n,o;for(var i in 1==t&&(n=currentDeviceEvents),2==t&&(n=events),3==t&&(n=currentUserEvents),n)if(n[i].h==e){o=n[i];break}if(o){var a="<div style=overflow-y:auto;max-height:300px>";for(var i in o)"h"!=i&&"_id"!=i&&"ids"!=i&&"domain"!=i&&null!=o[i]&&("object"==typeof o[i]?a+=addHtmlValue3(EscapeHtml(i),EscapeHtml(JSON.stringify(o[i]))):a+=addHtmlValue3(EscapeHtml(i),EscapeHtml(o[i])));setModalContent("xxAddAgent","Детали события",a+="</div>"),showModal("xxAddAgentModal","idx_dlgOkButton")}}var deviceDetailsStats=null,deviceDetailsStatsTimer=null,deviceDetailsStatsData=[],deviceDetailsConfig={type:"line",data:{labels:[],datasets:[{label:"CPU",backgroundColor:"rgba(134, 16, 158, .5)",borderColor:"rgb(134, 16, 158)",data:[],fill:!0},{label:"ОЗУ",backgroundColor:"rgba(255, 99, 132, .5)",borderColor:"rgb(255, 99, 132)",data:[],fill:!0}]},options:{events:["click"],animation:!1,responsive:!0,maintainAspectRatio:!1,tooltips:{enabled:!1},elements:{line:{cubicInterpolationMode:"monotone"}},scales:{x:{type:"linear",display:!0,title:{display:!1,text:""},min:0,max:100,reverse:!0},y:{type:"linear",display:!0,title:{display:!1,text:""},min:0,max:100}}}};function deskToggleCpuGraph(){"none"==QS("p17graph").display?(QV("p17graph",!0),window.deviceDetailsStatsChart=new Chart(document.getElementById("deviceDetailsStats").getContext("2d"),deviceDetailsConfig),deviceDetailsStatsTimer=setInterval(deviceDetailsStatsTimerFunc,2e3),deviceDetailsStatsTimerFunc()):deviceDetailsStatsClear()}function deviceDetailsStatsClear(){QV("p17graph",!1),null!=window.deviceDetailsStatsChart&&(window.deviceDetailsStatsChart.destroy(),delete window.deviceDetailsStatsChart),null!=deviceDetailsStatsTimer&&(clearInterval(deviceDetailsStatsTimer),deviceDetailsStatsTimer=null),deviceDetailsStatsData=[],deviceDetailsStatsDraw(),QV("extraGraphValues",!1),QH("extraGraphValues","")}function deviceDetailsStatsTimerFunc(){null!=currentNode&&meshserver.send({action:"msg",type:"cpuinfo",nodeid:currentNode._id})}function deviceDetailsStatsDraw(e){for(var t=Date.now()/1e3-100;deviceDetailsStatsData.length>0&&deviceDetailsStatsData[0][0]<t-5;)deviceDetailsStatsData.shift();var n=[],o=[];for(var i in deviceDetailsStatsData){var a=deviceDetailsStatsData[i];n.push({x:100-(a[0]-t),y:a[1]}),o.push({x:100-(a[0]-t),y:a[2]})}if(deviceDetailsConfig.data.datasets[0].data=n,deviceDetailsConfig.data.datasets[1].data=o,window.deviceDetailsStatsChart&&window.deviceDetailsStatsChart.update(),null!=e&&Array.isArray(e.thermals)&&e.thermals.length>0){var s="&nbsp;";for(var i in e.thermals)s+='<div class=thermalSensor title="'+e.thermals[i].InstanceName+'">'+parseFloat(e.thermals[i].CurrentTemperature).toFixed(2)+"&deg;C / "+parseFloat(1.8*e.thermals[i].CurrentTemperature+32).toFixed(2)+"&deg;F</div>";QV("extraGraphValues",!0),QH("extraGraphValues",s)}}var consoleNode,DeviceDetailsHardware=null,DeviceDetailsNetwork=null,DeviceDetailsNodeId=null;function updateDeviceDetails(e,t,n){if(null!=currentNode&&(null==e&&(e=currentNode),currentNode._id==e._id)){DeviceDetailsNodeId!=e._id&&(DeviceDetailsHardware=null,DeviceDetailsNetwork=null,DeviceDetailsNodeId=e._id),null!=t&&(DeviceDetailsHardware=t),null!=n&&(DeviceDetailsNetwork=n),null==(t=DeviceDetailsHardware)&&(t={}),null==(n=DeviceDetailsNetwork)&&(n={});var o=[],i={},a="";if(e.rname&&(a+=addDetailItem("Имя",EscapeHtml(e.rname),i)),t.windows&&t.windows.osinfo&&t.windows.osinfo.Description&&(a+=addDetailItem("Описание",EscapeHtml(t.windows.osinfo.Description),i)),e.osdesc&&(a+=addDetailItem("Версия",EscapeHtml(e.osdesc),i)),t.windows&&t.windows.osinfo)if((p=t.windows.osinfo).OSArchitecture&&(p.OSArchitecture.startsWith("32")?a+=addDetailItem("Архитектура","32-битный",i):p.OSArchitecture.startsWith("64")?a+=addDetailItem("Архитектура","64-битный",i):a+=addDetailItem("Архитектура",EscapeHtml(p.OSArchitecture),i)),p.LastBootUpTime){var s={year:parseInt(p.LastBootUpTime.substring(0,4)),month:parseInt(p.LastBootUpTime.substring(4,6))-1,day:parseInt(p.LastBootUpTime.substring(6,8)),hours:parseInt(p.LastBootUpTime.substring(8,10)),minutes:parseInt(p.LastBootUpTime.substring(10,12)),seconds:parseInt(p.LastBootUpTime.substring(12,14))};a+=addDetailItem("Last Boot Up Time",printDateTime(new Date(s.year,s.month,s.day,s.hours,s.minutes,s.seconds)))}if(t.linux&&t.linux.LastBootUpTime){a+=addDetailItem("Last Boot Up Time",printDateTime(new Date(t.linux.LastBootUpTime)))}if(t.darwin&&t.darwin.LastBootUpTime){a+=addDetailItem("Last Boot Up Time",printDateTime(new Date(1e3*t.darwin.LastBootUpTime)))}if(""!=a&&o.push({name:"Операционная система",html:a,img:"software64.png"}),e.agent){a="";if(null!=e.agent&&null!=e.agent.id&&null!=e.agent.ver){var r="";r=e.agent.id<=agentsStr.length?agentsStr[e.agent.id]:agentsStr[0],0!=e.agent.ver&&(r+=" v"+e.agent.ver),14==e.agent.id&&(r=e.agent.core),a+=addDetailItem("Mesh Agent",r)}if(1&e.conn?a+=addDetailItem("Последнее подключение агента","Подключено сейчас"):e.lastconnect&&(a+=addDetailItem("Последнее подключение агента",printDateTime(new Date(e.lastconnect)))),e.lastaddr){var l=e.lastaddr.split(":");l.length>2?a+=addDetailItem("Последний адрес агента",'<a href="https://iplocation.com/?ip='+l.slice(0,-1).join(":")+'" rel="noreferrer noopener" target="MeshIPLoopup">'+l.slice(0,-1).join(":")+"</a>"):isPrivateIP(e.lastaddr)?a+=addDetailItem("Последний адрес агента",l[0]):a+=addDetailItem("Последний адрес агента",'<a href="https://iplocation.com/?ip='+l[0]+'" rel="noreferrer noopener" target="MeshIPLoopup">'+l[0]+"</a>")}if(null!=t.agentvers&&t.agentvers.compileTime){var d=Date.parse(t.agentvers.compileTime);a+=addDetailItem("Время компиляции",isNaN(d)?t.agentvers.compileTime:printDateTime(new Date(d)))}""!=a&&o.push({name:"Mesh Agent",html:a,img:"meshagent64.png"})}if(t.mobile){a="";t.mobile.brand&&t.mobile.model&&(a+=addDetailItem("Модель",EscapeHtml(t.mobile.brand+", "+t.mobile.model),i)),t.mobile.device&&(a+=addDetailItem("Устройство",EscapeHtml(t.mobile.device),i)),t.mobile.bootloader&&(a+=addDetailItem("Загрузчик",EscapeHtml(t.mobile.bootloader),i)),t.mobile.id&&(a+=addDetailItem("Идентификатор",EscapeHtml(t.mobile.id),i)),t.mobile.host&&(a+=addDetailItem("Имя хоста",EscapeHtml(t.mobile.host),i)),t.mobile.androidapi&&t.mobile.androidrelease&&(a+=addDetailItem("Android Version",EscapeHtml(t.mobile.androidrelease+", API Level "+t.mobile.androidapi),i)),""!=a&&o.push({name:"Мобильное устройство",html:a,img:"mobile64.png"})}if(null!=n.netif){var c={};for(var u in n.netif){"string"==typeof(p=n.netif[u]).mac&&(null==c[p.mac]?(c[p.mac]=p,c[p.mac].ipv4layer=[{v4addr:p.v4addr,v4mask:p.v4mask,v4gateway:p.v4gateway}]):c[p.mac].ipv4layer.push({v4addr:p.v4addr,v4mask:p.v4mask,v4gateway:p.v4gateway}))}a="";for(var u in a+='<table class="table table-hover" style=width:100%>',c){var p=c[u];for(var m in a+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>",a+="<div style=margin-bottom:3px><b>"+EscapeHtml(p.name+(p.dnssuffix?", "+p.dnssuffix:""))+"</b></div>",p.desc&&(a+=addDetailItem("Описание",EscapeHtml(p.desc).split("(R)").join("&reg;"))),p.mac&&(p.gatewaymac?a+=addDetailItem("MAC-уровень",format("MAC: {0}, шлюз: {1}",EscapeHtml(p.mac),EscapeHtml(p.gatewaymac))):p.mac&&(a+=addDetailItem("MAC-уровень",format("MAC: {0}",EscapeHtml(p.mac))))),p.ipv4layer){var g=p.ipv4layer[m];g.v4gateway&&g.v4mask?a+=addDetailItem("Уровень IPv4",format("IP: {0}, маска: {1}, шлюз: {2}",EscapeHtml(g.v4addr),EscapeHtml(g.v4mask),EscapeHtml(g.v4gateway))):g.v4addr&&(a+=addDetailItem("Уровень IPv4",format("IP: {0}",EscapeHtml(g.v4addr))))}a+="</div></td></tr>"}""!=(a+="</table>")&&o.push({name:"Сеть",html:a,img:"networking64.png"})}if(null!=n.netif2){a="";for(var u in a+='<table class="table table-hover" style=width:100%>',n.netif2){p=n.netif2[u];if(!(0==Array.isArray(p)||p.length<1||null==p[0]||"string"==typeof p[0].mac&&p[0].mac.startsWith("00:00:00:00"))){a+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>";var v="";null!=u&&(v+=u),null!=p[0].fqdn&&""!=p[0].fqdn&&(v+=", "+p[0].fqdn),v.length>0&&(a+="<div style=margin-bottom:3px><b>"+EscapeHtml(v)+"</b></div>"),p.desc&&(a+=addDetailItem("Описание",EscapeHtml(p.desc).split("(R)").join("&reg;"))),"string"==typeof p[0].mac&&(p[0].gatewaymac?a+=addDetailItem("MAC-уровень",format("MAC: {0}, шлюз: {1}",EscapeHtml(p[0].mac),EscapeHtml(p[0].gatewaymac))):a+=addDetailItem("MAC-уровень",format("MAC: {0}",EscapeHtml(p[0].mac))));for(m=0;m<p.length;m++){var h=p[m],f=[];h.address&&f.push(format("IP: {0}",EscapeHtml(h.address))),h.netmask&&f.push(format("Mask: {0}",EscapeHtml(h.netmask))),h.gateway&&f.push(format("Gateway: {0}",EscapeHtml(h.gateway))),f.length>0&&("IPv4"==h.family&&(a+=addDetailItem("Уровень IPv4",f.join(", "))),"IPv6"==h.family&&(a+=addDetailItem("Уровень IPv6",f.join(", "))))}a+="</div></td></tr>"}}t.network&&t.network.dns&&(a+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>",a+=addDetailItem("<b>DNS Servers</b>",t.network.dns.join(", ")),a+="</div></td></tr>"),""!=(a+="</table>")&&o.push({name:"Сеть",html:a,img:"networking64.png"})}if(null!=e.intelamt){a="";a+=addDetailItem("Версия",e.intelamt.ver?"v"+EscapeHtml(e.intelamt.ver):"<i>Неизвестно</i>",i);var x={0:nobreak("Не активирован"),1:nobreak("Предварительная активация"),2:nobreak("Активировано")},k="";2==e.intelamt.state&&e.intelamt.flags&&(2&e.intelamt.flags?k=", Режим управления клиентом (CCM)":4&e.intelamt.flags&&(k=", Режим управления администратора (ACM)")),a+=addDetailItem("Состояние инициализации",(e.intelamt.state?x[e.intelamt.state]:"<i>Неизвестно</i>")+k,i),a+=addDetailItem("Защита",1==e.intelamt.tls?"Защищено с помощью TLS":"TLS не настроен",i),""!=(a+=addDetailItem("Учетные данные администратора",null==e.intelamt.user||""==e.intelamt.user||null!=e.intelamt.warn&&9&e.intelamt.warn?"Неизвестный":"Известный",i))&&("number"==typeof e.intelamt.sku&&16&e.intelamt.sku?o.push({name:"Intel&reg; Standard Manageability (Intel&reg; SM)",html:a,img:"amt64.png"}):o.push({name:"Intel&reg; Active Management Technology (Intel&reg; AMT)",html:a,img:"amt64.png"}))}if(t.identifiers){a="";var y=t.identifiers;if(y.bios_vendor&&(a+=addDetailItem("Вендор",EscapeHtml(y.bios_vendor),i)),y.bios_version&&(a+=addDetailItem("Версия",EscapeHtml(y.bios_version),i)),y.bios_serial&&(a+=addDetailItem("Серийный номер",EscapeHtml(y.bios_serial),i)),y.bios_mode&&(a+=addDetailItem("Mode",EscapeHtml(y.bios_mode),i)),""!=a&&o.push({name:"BIOS",html:a,img:"chip64.png"}),a="",y.board_vendor&&(a+=addDetailItem("Вендор",EscapeHtml(y.board_vendor),i)),y.board_name&&(a+=addDetailItem("Имя",EscapeHtml(y.board_name),i)),y.board_serial&&""!=y.board_serial&&(a+=addDetailItem("Серийный номер",EscapeHtml(y.board_serial),i)),y.board_version&&(a+=addDetailItem("Версия",EscapeHtml(y.board_version),i)),y.product_uuid&&(a+=addDetailItem("Идентификатор",EscapeHtml(y.product_uuid),i)),y.cpu_name&&(a+=addDetailItem("CPU",EscapeHtml(y.cpu_name).split("(TM)").join("&trade;").split("(R)").join("&reg;"),i)),y.gpu_name)for(var u in y.gpu_name)a+=addDetailItem("GPU",EscapeHtml(y.gpu_name[u]).split("(TM)").join("&trade;").split("(R)").join("&reg;"),i);""!=a&&o.push({name:"Материнская плата",html:a,img:"motherboard64.png"})}if(t.tpm){a="";var b=t.tpm;b.SpecVersion&&(a+=addDetailItem("SpecVersion",parseFloat(EscapeHtml(b.SpecVersion)).toFixed(1),i)),b.ManufacturerId&&(a+=addDetailItem("ManufacturerId",EscapeHtml(b.ManufacturerId),i)),b.ManufacturerVersion&&(a+=addDetailItem("ManufacturerVersion",EscapeHtml(b.ManufacturerVersion),i)),null!=b.IsActivated&&(a+=addDetailItem("IsActivated",b.IsActivated?"Yes":"No",i)),null!=b.IsEnabled&&(a+=addDetailItem("IsEnabled",b.IsEnabled?"Yes":"No",i)),null!=b.IsOwned&&(a+=addDetailItem("IsOwned",b.IsOwned?"Yes":"No",i)),""!=a&&o.push({name:"TPM",html:a,img:"tpm64.png"})}if(t.windows&&t.windows.memory&&t.windows.memory.length>0){a="";for(var u in t.windows.memory.sort(function(e,t){return e.BankLabel>t.BankLabel?1:e.BankLabel<t.BankLabel?-1:0}),a+='<table class="table table-hover" style=width:100%>',t.windows.memory){p=t.windows.memory[u];a+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>",a+="<div style=margin-bottom:3px><b>"+EscapeHtml(p.BankLabel?p.BankLabel:p.DeviceLocator?p.DeviceLocator:"Unknown")+"</b></div>",p.Capacity&&p.Speed?a+=addDetailItem("Объем / Скорость",format("{0} Мб, {1} Мгц",p.Capacity/1024/1024,p.Speed),i):p.Capacity&&(a+=addDetailItem("Объем",format("{0} Mб",p.Capacity/1024/1024),i)),p.PartNumber&&(a+=addDetailItem("Part Number",EscapeHtml(p.Manufacturer&&"Undefined"!=p.Manufacturer?p.Manufacturer+", ":"")+EscapeHtml(p.PartNumber),i)),a+="</div>"}""!=(a+="</table>")&&o.push({name:"ОЗУ",html:a,img:"ram64.png"})}if(t.linux&&t.linux.memory&&t.linux.memory.Memory_Device.length>0){a="";for(var u in t.linux.memory.Memory_Device.sort(function(e,t){return e.Locator>t.Locator?1:e.Locator<t.Locator?-1:0}),a+='<table class="table table-hover" style=width:100%>',t.linux.memory.Memory_Device){(p=t.linux.memory.Memory_Device[u]).Size&&"No Module Installed"==p.Size||(a+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>",a+="<div style=margin-bottom:3px><b>"+EscapeHtml(p.Locator?p.Locator:"Unknown")+"</b></div>",p.Size&&p.Speed?a+=addDetailItem("Объем / Скорость",format("{0}, {1}",p.Size,p.Speed),i):p.Size&&(a+=addDetailItem("Объем",format("{0}",p.Size),i)),p.PartNumber&&(a+=addDetailItem("Part Number",EscapeHtml(p.Manufacturer&&"Undefined"!=p.Manufacturer?p.Manufacturer+", ":"")+EscapeHtml(p.PartNumber),i)),a+="</div>")}""!=(a+="</table>")&&o.push({name:"ОЗУ",html:a,img:"ram64.png"})}if(t.darwin&&t.darwin.memory&&t.darwin.memory.length>0){a="";for(var u in a+='<table class="table table-hover" style=width:100%>',t.darwin.memory){(p=t.darwin.memory[u]).Size&&"No Module Installed"==p.Size||(a+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>",a+="<div style=margin-bottom:3px><b>"+EscapeHtml(p.DeviceLocator?p.DeviceLocator:"Unknown")+"</b></div>",p.Size&&p.Speed?a+=addDetailItem("Объем / Скорость",format("{0}, {1}",p.Size,p.Speed),i):p.Size&&(a+=addDetailItem("Объем",format("{0}",p.Size),i)),p.PartNumber&&(a+=addDetailItem("Part Number",EscapeHtml(p.Manufacturer&&""!=p.Manufacturer?p.Manufacturer+", ":"")+EscapeHtml(p.PartNumber),i)),a+="</div>")}""!=(a+="</table>")&&o.push({name:"ОЗУ",html:a,img:"ram64.png"})}if(t.identifiers&&t.identifiers.storage_devices){a="";for(var u in y.storage_devices.sort(function(e,t){return e.Caption>t.Caption?1:e.Caption<t.Caption?-1:0}),a+="<table style=width:100%>",y.storage_devices){if((p=y.storage_devices[u]).Size){if(a+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>",a+="<div style=margin-bottom:3px><b>"+EscapeHtml(p.Caption)+"</b></div>",p.Model&&p.Model!=p.Caption&&(a+=addDetailItem("Модель",EscapeHtml(p.Model),i)),p.Size&&("string"==typeof p.Size&&parseInt(p.Size)==p.Size&&(p.Size=parseInt(p.Size)),"number"==typeof p.Size&&(a+=addDetailItem("Объем",format("{0} Mб",Math.floor(p.Size/1024/1024)),i)),"string"==typeof p.Size&&(a+=addDetailItem("Объем",EscapeHtml(p.Size),i))),t.windows&&t.windows.drives&&p.Model){const e=t.windows.drives.find(e=>e.Model===p.Model);e&&e.Status&&(a+=addDetailItem("Статус",EscapeHtml(e.Status),i))}a+="</div>"}}""!=(a+="</table>")&&o.push({name:"Хранилище",html:a,img:"storage64.png"})}if(t.windows&&t.windows.volumes){a="";for(var u in t.windows.volumes){if(a+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>",a+="<div style=margin-bottom:3px><b>"+u+":"+(null==(p=t.windows.volumes[u]).name||""==p.name?"":" - "+EscapeHtml(p.name))+"</b></div>",p.size){var w=["Bytes","KB","MB","GB","TB"],M=0===(m=parseInt(Math.floor(Math.log(Math.abs(p.size))/Math.log(1024)),10))?`${p.size} ${w[m]}`:`${(p.size/1024**m).toFixed(2)} ${w[m]}`;a+=addDetailItem("Объем",EscapeHtml(M),i)}if(p.sizeremaining){w=["Bytes","KB","MB","GB","TB"],M=0===(m=parseInt(Math.floor(Math.log(Math.abs(p.sizeremaining))/Math.log(1024)),10))?`${p.sizeremaining} ${w[m]}`:`${(p.sizeremaining/1024**m).toFixed(2)} ${w[m]}`;a+=addDetailItem("Capacity Remaining",EscapeHtml(M),i)}if(p.type)a+=addDetailItem("File System",(""!=(S=1==p.removable?"Removable":1==p.cdrom?"CD-ROM":"")?S+" / ":"")+("Unknown"==p.type?"Неизвестно":EscapeHtml(p.type)),i);if(p.protectionStatus||p.volumeStatus){var C=[];p.protectionStatus&&C.push("Включено"),p.volumeStatus&&"FullyDecrypted"==p.volumeStatus&&C.push("Fully Decrypted"),p.volumeStatus&&"EncryptionInProgress"==p.volumeStatus&&C.push("Encryption In Progress"),p.volumeStatus&&"FullyEncrypted"==p.volumeStatus&&C.push("Fully Encrypted"),C=C.join(" - "),p.recoveryPassword&&(C+=addKeyLink("",'deviceDetailsShowBitlockerInfo("'+encodeURIComponentEx(u)+'","'+encodeURIComponentEx(p.identifier)+'","'+encodeURIComponentEx(p.recoveryPassword)+'")')),a+=addDetailItem("BitLocker",C,i)}a+="</div>"}""!=a&&o.push({name:"Storage Volumes",html:"<table style=width:100%>"+a+"</table>",img:"storage64.png"})}if(t.linux&&t.linux.volumes){a="";for(var u in t.linux.volumes){if(!(p=t.linux.volumes[u]).mount_point.startsWith("/var/lib/docker/overlay2")){if(a+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>",a+="<div style=margin-bottom:3px><b>"+p.mount_point+"</b></div>",p.size){w=["KB","MB","GB","TB"],M=0===(m=parseInt(Math.floor(Math.log(Math.abs(p.size))/Math.log(1024)),10))?`${p.size} ${w[m]}`:`${(p.size/1024**m).toFixed(2)} ${w[m]}`;a+=addDetailItem("Объем",EscapeHtml(M),i)}if(p.available){if(0==Math.abs(p.available))M="0 KB";else w=["KB","MB","GB","TB"],M=0===(m=parseInt(Math.floor(Math.log(Math.abs(p.available))/Math.log(1024)),10))?`${p.available} ${w[m]}`:`${(p.available/1024**m).toFixed(2)} ${w[m]}`;a+=addDetailItem("Capacity Remaining",EscapeHtml(M),i)}if(p.type)a+=addDetailItem("File System",(""!=(S=1==p.removable?"Removable":1==p.cdrom?"CD-ROM":"")?S+" / ":"")+("Unknown"==p.type?"Неизвестно":EscapeHtml(p.type)),i);a+="</div>"}}""!=a&&o.push({name:"Storage Volumes",html:"<table style=width:100%>"+a+"</table>",img:"storage64.png"})}if(t.darwin&&t.darwin.volumes){a="";for(var u in t.darwin.volumes){if(!(p=t.darwin.volumes[u]).mount_point.startsWith("/var/lib/docker/overlay2")){var S;if(a+="<tr><td><div class=style10 style=border-radius:5px;padding:8px>",a+="<div style=margin-bottom:3px><b>"+p.mount_point+"</b></div>",p.size&&(a+=addDetailItem("Объем",EscapeHtml(p.size),i)),p.available&&(a+=addDetailItem("Capacity Remaining",EscapeHtml(p.available),i)),p.type)a+=addDetailItem("File System",(""!=(S=1==p.removable?"Removable":1==p.cdrom?"CD-ROM":"")?S+" / ":"")+("Unknown"==p.type?"Неизвестно":EscapeHtml(p.type)),i);a+="</div>"}}""!=a&&o.push({name:"Storage Volumes",html:"<table style=width:100%>"+a+"</table>",img:"storage64.png"})}a="";for(var u in o)null==o[u].img?a+="<div class=DevSt style=margin-bottom:3px;margin-left:16px><b>"+o[u].name+"</b></div><div style=margin-bottom:10px;margin-left:16px>"+o[u].html+"</div>":(a+="<table style=width:100%><tr>",a+="<td style=width:64px;vertical-align:top><img src=images/details/"+o[u].img+" border=0 width=64 /></td>",a+="<td><div class=DevSt style=margin-bottom:3px;margin-left:16px><b>"+o[u].name+"</b></div><div style=margin-bottom:10px;margin-left:16px>"+o[u].html+"</div></td>",a+="</tr></table>");""==a?QH("p17info2","Информации об этом устройстве нет"):QH("p17info2",a)}}function deviceDetailsShowBitlockerInfo(e,t,n){if(xxdialogMode)return!1;var o="<div><p>Идентификатор</p><p style=user-select:text;font-weight:bold>"+(t?decodeURIComponent(t):"Неизвестно")+"</p>";o+="<p>Recovery Password</p><p style=user-select:text;font-weight:bold>"+(n?decodeURIComponent(n):"Неизвестно")+"</p></div>",setModalContent("xxAddAgent",decodeURIComponent(e)+": BitLocker Information",o),showModal("xxAddAgentModal","idx_dlgOkButton")}function agentConsoleHandleKeys(e){if(e.ctrlKey||e.altKey)return!0;var t=0,n=Q("p15consoleText");if(e.key)if(13==e.keyCode&&0==consoleFocus)p15consoleSend(e),t=1;else if(8==e.keyCode&&0==consoleFocus){var o=n.value;n.value=o.substring(0,o.length-1),t=1}else if(27==e.keyCode)n.value="",t=1;else if(38==e.keyCode||40==e.keyCode){var i=consoleHistory.indexOf(n.value);38==e.keyCode&&consoleHistory.length-1>i?n.value=consoleHistory[i+1]:40==e.keyCode&&i>0?n.value=consoleHistory[i-1]:40==e.keyCode&&0==i&&(n.value=""),t=1}else 1===e.key.length&&(insertTextAtCursor(n,e.key),t=1);else 0!=e.charCode&&0==consoleFocus&&(n.value=n.value+String.fromCharCode(e.charCode),t=1);return t>0?haltEvent(e):void 0}function insertTextAtCursor(e,t){if(document.selection)e.focus(),sel=document.selection.createRange(),sel.text=t;else if(e.selectionStart||"0"==e.selectionStart){var n=e.selectionStart,o=e.selectionEnd;e.value=e.value.substring(0,n)+t+e.value.substring(o,e.value.length),e.setSelectionRange(o+1,o+1)}else e.value+=myValue}var consoleServerText="";function setupConsole(){if(115==xxcurrentView){var e="server"==consoleNode;consoleNode="server",QH("p15deviceName","Консоль моего сервера"),QE("p15consoleText",!0),QH("p15statetext",""),QH("p15coreName",""),QV("p15outputselecttd",!1),0==e&&(QH("p15agentConsoleText",consoleServerText),Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight)}else{e=consoleNode==currentNode,meshes[(consoleNode=currentNode).meshid];if(16&GetNodeRights(currentNode)){null==consoleNode.consoleText&&(consoleNode.consoleText=""),0==e&&(QH("p15agentConsoleText",consoleNode.consoleText),Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight);1&consoleNode.conn||consoleNode.conn;var t=1&consoleNode.conn?"Агент онлайн":"Агент оффлайн";16&consoleNode.conn&&(t+=", MQTT онлайн"),QH("p15statetext",t),QE("p15uploadCore",!!(1&consoleNode.conn)),QV("p15outputselecttd",!!(16&consoleNode.conn)||1==currentNode.pmt&&!!(4&features2)),QV("p15outputselect2",!!(16&consoleNode.conn)),QV("p15outputselect3",1==currentNode.pmt&&!!(4&features2));var n=Q("p15outputselect").value;16&consoleNode.conn||2!=n||(n=1,Q("p15outputselect").value=1),1==currentNode.pmt&&4&features2||3!=n||(n=1,Q("p15outputselect").value=1);var o=!1;1&consoleNode.conn&&1==n&&(o=!0),16&consoleNode.conn&&2==n&&(o=!0),1==currentNode.pmt&&4&features2&&3==n&&(o=!0),QE("p15consoleText",o)}else QH("p15statetext","Отказано в доступе"),QE("p15consoleText",!1),QE("p15uploadCore",!1),QV("p15outputselecttd",!1);QV("devListToolbarViewIcons3",!!(1&consoleNode.conn))}}function p15consoleClear(){QH("p15agentConsoleText",""),Q("id_p15consoleClear").blur(),115==xxcurrentView?consoleServerText="":consoleNode.consoleText=""}var consoleHistory=[];function p15consoleSend(e){if(!e||13==e.keyCode){var t=Q("p15consoleText").value,n="<div style=color:green>&gt; "+EscapeHtml(t)+"<br/></div>";if(115==xxcurrentView?(consoleServerText+=n,meshserver.send({action:"serverconsole",value:t})):16&consoleNode.conn&&2==Q("p15outputselect").value?(n="<div style=color:orange>MQTT&gt; "+EscapeHtml(t)+"<br/></div>",consoleNode.consoleText+=n,meshserver.send({action:"sendmqttmsg",topic:"console",nodeids:[consoleNode._id],msg:t})):1==consoleNode.pmt&&3==Q("p15outputselect").value&&4&features2?(n="<div style=color:violet>PUSH&gt; "+EscapeHtml(t)+"<br/></div>",consoleNode.consoleText+=n,meshserver.send({action:"pushconsole",nodeid:consoleNode._id,console:t})):1&consoleNode.conn&&(consoleNode.consoleText+=n,meshserver.send({action:"msg",type:"console",nodeid:consoleNode._id,value:t})),Q("p15agentConsoleText").innerHTML+=n,Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight,Q("p15consoleText").value="",t.length>0){var o=consoleHistory.indexOf(t);o>=0&&consoleHistory.splice(o,1),consoleHistory.unshift(t),consoleHistory.splice(10)}}}function p15consoleReceive(e,t,n){"serverconsole"===e?(t="<div>"+EscapeHtml(t)+"</div>",consoleServerText+=t,"server"==consoleNode&&(Q("p15agentConsoleText").innerHTML+=t,Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight)):(t="MQTT"==n?"<div style=color:red>MQTT&gt; "+EscapeHtml(t)+"<br/></div>":"<div>"+EscapeHtml(t)+"</div>",null==e.consoleText?e.consoleText=t:e.consoleText+=t,consoleNode==e&&(Q("p15agentConsoleText").innerHTML+=t,Q("p15agentConsoleText").scrollTop=Q("p15agentConsoleText").scrollHeight))}function p15downloadConsoleText(){saveAs(new Blob([Q("p15agentConsoleText").innerText],{type:"application/octet-stream"}),"console.txt")}function p15uploadCore(e){if(!xxdialogMode)if(1==e.shiftKey)meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"default"});else if(1==e.altKey)meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"clear"});else if(1==e.ctrlKey)p15uploadCore2();else{setModalContent("xxAddAgent","Произвести действие агента",addHtmlFormFloating("Действиe",'<select id=d3coreMode class="form-select me-2"><option value=1>Загрузить ядро по умолчанию с сервера </option><option value=2>Очистить ядро</option><option value=3>Загрузить файл ядра</option><option value=4>Програмное отключение агента</option><option value=5>Жесткое отключение агента</option><option value=6>Загрузить ядро восстановления</option><option value=7>Загрузить крошечное ядро</option><option value=8>Restart agent service</option><option value=9>Принудительно обновить агент</option></select>')),showModal("xxAddAgentModal","idx_dlgOkButton",p15uploadCoreEx)}}function p15uploadCoreEx(){1==Q("d3coreMode").value?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"default"}):2==Q("d3coreMode").value?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"clear"}):3==Q("d3coreMode").value?p15uploadCore2():4==Q("d3coreMode").value?meshserver.send({action:"agentdisconnect",nodeid:consoleNode._id,disconnectMode:1}):5==Q("d3coreMode").value?meshserver.send({action:"agentdisconnect",nodeid:consoleNode._id,disconnectMode:2}):6==Q("d3coreMode").value?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"recovery"}):7==Q("d3coreMode").value?meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"tiny"}):8==Q("d3coreMode").value?meshserver.send({action:"msg",type:"console",nodeid:consoleNode._id,value:"service restart"}):9==Q("d3coreMode").value&&meshserver.send({action:"updateAgents",nodeids:[consoleNode._id]})}function p15uploadCore2(){xxdialogMode||(Q("d3localmodeform").action="uploadmeshcorefile.ashx",Q("d3auth").value=authCookie,Q("d3filter").value=".js",Q("d3attrib").value=currentNode._id,setModalContent("xxAddAgent","Загрузить ядро Mesh Agent",""),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p15uploadCoreEx2()),d3init())}function p15uploadCoreEx2(){if(1==Q("d3uploadMode").value)Q("d3submit").click();else{var e=d3getFileSel();1==e.length&&meshserver.send({action:"uploadagentcore",nodeids:[consoleNode._id],type:"custom",path:d3filetreelocation.join("/")+"/"+e[0]})}}function account_viewPreviousLogins(){xxdialogMode||(xxdialogTag="previousLogins",setModalContent("xxAddAgent","Предыдущие входы","Loading..."),showModal("xxAddAgentModal","idx_dlgOkButton"),meshserver.send({action:"previousLogins"}))}function account_manageImage(e){if(!xxdialogMode){var t=0==e?userinfo:currentUser;setModalContent("xxAddAgent","Управление изображением учетной записи",'<input id=p2file type=file class="form-control" accept="image/*" onchange=account_manageImageEx()><div style=width:100%><canvas id=p2canvas width=256 height=256 style="width:256px;height:256px;margin-left:60px;margin-top:8px;border-radius:16px;background: var(--sub-menu-bg);border: 1px solid #cfcdcd; cursor: pointer;" onclick=account_canvasClick() /></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",account_manageImageEx2);var n=Q("p2canvas").getContext("2d");null==t.accountImageRnd&&(t.accountImageRnd=Math.floor(9999999999*Math.random()));var o="";1==e&&(o="&id="+t._id.split("/")[2]);var i=new Image;i.onload=function(){n.clearRect(0,0,256,256),n.drawImage(i,0,0)},i.src=null!=t.flags&&1&t.flags?"userimage.ashx?rnd="+t.accountImageRnd+o:"images/user-256.png",QE("idx_dlgDeleteButton",null!=t.flags&&1&t.flags),QE("idx_dlgOkButton",!1)}}function account_canvasClick(){Q("p2file").click()}function account_manageImageEx(){var e=Q("p2file").files[0],t=new Image;t.onload=function(){var e=0,n=0,o=Math.min(t.width,t.height);t.width>o&&(e=(t.width-o)/2),t.height>o&&(n=(t.height-o)/2);var i=Q("p2canvas").getContext("2d");i.imageSmoothingEnabled=!0,i.webkitImageSmoothingEnabled=!0,i.mozImageSmoothingEnabled=!0,i.clearRect(0,0,256,256),i.drawImage(t,e,n,o,o,0,0,256,256),QE("idx_dlgOkButton",!0)},t.src=URL.createObjectURL(e)}function account_manageImageEx2(e,t){meshserver.send({action:"updateUserImage",userid:t,image:2==e?0:Q("p2canvas").toDataURL(Q("p2file").files[0].type)})}function account_managePhone(){var e;!xxdialogMode&&33554432&features&&(null!=userinfo.phone?(e='<table style=width:100%><tr><td style=width:56px><img src="images/phone80.png" style=padding:8px>',e+="<td style=text-align:center><div style=padding:6px>Проверенный номер телефона</div><div style=font-size:20px>"+EscapeHtml(userinfo.phone)+"</div>",setModalContent("xxAddAgent","Уведомления по телефону",e+='<div style=margin:10px><label><input id=d2delPhone type=checkbox class="form-check-input me-2" onclick=account_managePhoneRemoveValidate() />Удалить номер телефона</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_managePhoneRemove()),account_managePhoneRemoveValidate()):(e='<table style=width:100%><tr><td style=width:56px><img src="images/phone80.png" style=padding:8px>',e+="<td>Введите свой телефонный номер с возможностью отправки SMS. После проверки номер может использоваться для проверки входа в систему и других уведомлений.",xxdialogTag="verifyPhone",setModalContent("xxAddAgent","Уведомления по телефону",e+='<br /><br /><div style=width:100%;text-align:center>Телефонный номер: <input type=tel pattern="[0-9]" autocomplete="tel" inputmode="tel" maxlength=18 id=d2phoneinput onKeyUp=account_managePhoneValidate() onkeypress="if (event.key==\'Enter\') account_managePhoneValidate(1)"></div></table>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_managePhoneAdd()),Q("d2phoneinput").focus(),account_managePhoneValidate()))}function isPhoneNumber(e){var t=!0;e.startsWith("+")&&(e=e.substring(1));for(var n=0;n<e.length;n++){var o=e.charCodeAt(n);(o<48||o>57)&&32!=o&&45!=o&&46!=o&&(t=!1)}return t&&e.length>=10}function account_managePhoneValidate(e){var t=isPhoneNumber(Q("d2phoneinput").value);QE("idx_dlgOkButton",t),1==e&&t&&dialogclose(1)}function account_managePhoneCodeValidate(e){var t=6==Q("d2phoneCodeInput").value.length&&Q("d2phoneCodeInput").value.match(/[0-9]/);QE("idx_dlgOkButton",t),1==e&&t&&dialogclose(1)}function account_managePhoneConfirm(e,t){meshserver.send({action:"confirmPhone",code:Q("d2phoneCodeInput").value,cookie:t})}function account_managePhoneAdd(){0!=isPhoneNumber(Q("d2phoneinput").value)&&(QE("d2phoneinput",!1),meshserver.send({action:"verifyPhone",phone:Q("d2phoneinput").value}))}function account_managePhoneRemove(){Q("d2delPhone").checked&&meshserver.send({action:"removePhone"})}function account_managePhoneRemoveValidate(){QE("idx_dlgOkButton",Q("d2delPhone").checked)}function account_manageMessaging(){var e;if(!xxdialogMode&&33554432&features2)if(null!=userinfo.msghandle)e='<table style=width:100%><tr><td style=width:56px><img src="images/messaging40.png" style=padding:8px>',e+="<td style=text-align:center><div style=padding:6px>Verified handle</div><div style=font-weight:bold>"+EscapeHtml(userinfo.msghandle)+"</div>",setModalContent("xxAddAgent","Messaging Notifications",e+='<div style=margin:10px><label><input id=d2delPhone type=checkbox class="form-check-input me-2" onclick=account_managePhoneRemoveValidate() />Remove messaging</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_manageMessagingRemove()),account_managePhoneRemoveValidate();else{e='<table style=width:100%><tr><td style=width:56px;vertical-align:top><img src="images/messaging40.png" style=padding:8px>',e+="<td>Enter your messaging service and handle. Once verified, this server can send you login verification and other notifications.<br /><br />";var t="<select id=d2serviceselect style=width:160px;margin-left:8px onchange=account_manageMessagingValidate()>";1&serverinfo.userMsgProviders&&(t+="<option value=1>Telegram</option>"),4&serverinfo.userMsgProviders&&(t+="<option value=4>Discord</option>"),8&serverinfo.userMsgProviders&&(t+="<option value=8>XMPP</option>"),16&serverinfo.userMsgProviders&&(t+="<option value=16>CallMeBot</option>"),32&serverinfo.userMsgProviders&&(t+="<option value=32>Pushover</option>"),64&serverinfo.userMsgProviders&&(t+="<option value=64>ntfy</option>"),128&serverinfo.userMsgProviders&&(t+="<option value=128>Zulip</option>"),256&serverinfo.userMsgProviders&&(t+="<option value=256>Slack</option>"),e+="<table><tr><td>Service<td>"+(t+="</select>"),e+="<tr><td>Handle<td><input maxlength=1024 style=width:160px;margin-left:8px id=d2handleinput onKeyUp=account_manageMessagingValidate() onkeypress=\"if (event.key=='Enter') account_manageMessagingValidate(1)\">",e+="</table>",serverinfo.discordUrl&&(e+="<div id=d2discordurl style=display:none><br /><a href="+serverinfo.discordUrl+' target="_discord">Join this Discord server to receive notifications.</a></div>'),e+='<div id=d2callmebotinfo style=display:none><br /><a href=https://www.callmebot.com/blog/free-api-signal-send-messages/ target="_callmebot">Signal</a>, <a href=https://www.callmebot.com/blog/free-api-whatsapp-messages/ target="_callmebot">Whatsapp</a>, <a href=https://www.callmebot.com/blog/free-api-facebook-messenger/ target="_callmebot">Facebook</a>, <a href=https://www.callmebot.com/blog/telegram-text-messages/ target="_callmebot">Telegram</a></div>',e+='<div id=d2pushoverinfo style=display:none><br /><a href=https://pushover.net/ target="_pushover">Information at Pushover.net</a></div>',e+='<div id=d2ntfyinfo style=display:none><br /><a href="'+(serverinfo.userMsgNftyUrl?serverinfo.userMsgNftyUrl:"https://ntfy.sh/")+'" target="_ntfy">Free service at ntfy.sh</a></div>',xxdialogTag="VerifyMessaging",setModalContent("xxAddAgent","Messaging Notifications",e+='<div id=d2slackinfo style=display:none><br /><a href=https://api.slack.com/messaging/webhooks target="_slack">Slack Webhook Setup</a></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_manageMessagingAdd()),Q("d2handleinput").focus(),account_manageMessagingValidate()}}function account_manageMessagingValidate(e){serverinfo.discordUrl&&QV("d2discordurl",4==Q("d2serviceselect").value),QV("d2callmebotinfo",16==Q("d2serviceselect").value),QV("d2pushoverinfo",32==Q("d2serviceselect").value),QV("d2ntfyinfo",64==Q("d2serviceselect").value),QV("d2slackinfo",256==Q("d2serviceselect").value),4==Q("d2serviceselect").value?Q("d2handleinput").placeholder="Username:0000":8==Q("d2serviceselect").value?Q("d2handleinput").placeholder="username@server.com":16==Q("d2serviceselect").value?Q("d2handleinput").placeholder="https://api.callmebot.com/...":32==Q("d2serviceselect").value?Q("d2handleinput").placeholder="User key":64==Q("d2serviceselect").value?Q("d2handleinput").placeholder="Тема":128==Q("d2serviceselect").value?Q("d2handleinput").placeholder="username@sample.com":256==Q("d2serviceselect").value?Q("d2handleinput").placeholder="https://hooks.slack.com/...":Q("d2handleinput").placeholder="Имя пользователя";var t=Q("d2handleinput").value.length>0;QE("idx_dlgOkButton",t),1==e&&t&&dialogclose(1)}function account_manageMessagingAdd(){if(0!=Q("d2handleinput").value.length)return QE("d2handleinput",!1),meshserver.send({action:"verifyMessaging",service:Q("d2serviceselect").value,handle:Q("d2handleinput").value}),!1}function account_manageMessagingConfirm(e,t){meshserver.send({action:"confirmMessaging",code:Q("d2phoneCodeInput").value,cookie:t})}function account_manageMessagingRemove(){Q("d2delPhone").checked&&meshserver.send({action:"removeMessaging"})}function account_manageAuthEmail(){if(!xxdialogMode&&8388608&features){var e=1==userinfo.otpekey&&null!=userinfo.email&&1==userinfo.emailVerified;setModalContent("xxAddAgent","Аутентификация электронной почты",'Когда этот параметр включен, при каждом входе в систему вам будет предоставлена возможность получать токен для входа в свою учетную запись на электронную почту для обеспечения дополнительной безопасности.<br /><br /><label><input id=email2facheck type=checkbox class="form-check-input me-2" '+(e?"checked":"")+"/>Включить двухфакторную аутентификацию электронной почты.</label>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){e!=Q("email2facheck").checked&&meshserver.send({action:"otpemail",enabled:Q("email2facheck").checked})})}}function account_manageAuthDuo(){!xxdialogMode&&536870912&features2&&(0==(1==userinfo.otpduo)?(setModalContent("xxAddAgent","Duo Authentication",'Confirm enabling of Duo 2FA login security. Once enabled you will be given the option to use Duo at login for added security. Click ok to go thru the steps to enable Duo.<p style="text-align:center;margin-top:10px"><img src="images/duo-2fa-250.png"></p>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){window.location.href="/add-duo?rurl="+encodeURIComponentEx(window.location.href)+(urlargs.key?"&key="+urlargs.key:"")})):(setModalContent("xxAddAgent","Duo Authentication",'<p><label><input id=duo2facheck type=checkbox onclick=account_manageAuthDuoConfirm() /> Confirm disabling 2FA Duo login security.</label></p><p style="text-align: center"><img src="images/duo-2fa-250-disable.png"></p>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"otpduo",enabled:!1})}),QE("idx_dlgOkButton",!1)))}function account_manageAuthDuoConfirm(){QE("idx_dlgOkButton",Q("duo2facheck").checked)}function account_manageAuthApp(){if(!xxdialogMode&&4096&features)return 1==userinfo.otpsecret?account_removeOtp():account_addOtp(),!1}function account_addOtp(){!xxdialogMode&&1!=userinfo.otpsecret&&4096&features&&(xxdialogTag="otpauth-request",setModalContent("xxAddAgent","Приложение-аутентификатор","<div id=d2optinfo>Загрузка...</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){return meshserver.send({action:"otpauth-setup",secret:Q("d2optsecret").attributes.secret.value,token:Q("d2otpauthinput").value}),!1}),meshserver.send({action:"otpauth-request"}))}function account_addOtpCheck(e){var t=6==Q("d2otpauthinput").value.length;QE("idx_dlgOkButton",t),e&&13==e.keyCode&&t&&dialogclose(1)}function account_removeOtp(){!xxdialogMode&&1==userinfo.otpsecret&&4096&features&&(setModalContent("xxAddAgent","Приложение-аутентификатор","Подтвердить удаление приложения аутентификации двухэтапного входа в систему?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"otpauth-clear"})}))}function account_manageOtp(e){return!!(4096&features)&&(count2factoraAuths()>0&&meshserver.send({action:"otpauth-getpasswords",subaction:e}),!1)}function account_managePushAuthDev(){if(!xxdialogMode&&64&features2){if(1==userinfo.otpdev)setModalContent("xxAddAgent","Устройство аутентификации","Подтвердить удаление устройства push-аутентификации?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"otpdev-clear"})});else{var e=[];for(var t in nodes){var n=nodes[t];null!=n.agent&&14==n.agent.id&&1==n.pmt&&4294967295==GetNodeRights(n)&&e.push(n)}if(0==e.length)setModalContent("xxAddAgent","Устройство аутентификации","In order to use push notification authentication, a mobile device must be setup in your account with full rights."),showModal("xxAddAgentModal","idx_dlgOkButton");else{var o="Выберите устройство которое будет использоваться для аутентификации с помощью push-уведомлений. После выбора устройство запросит подтверждение.<br /><br />",i='<select id=d2devselect class="form-select">';for(var t in e)i+='<option value="'+e[t]._id+'">'+EscapeHtml(e[t].name)+"</option>";setModalContent("xxAddAgent","Устройство аутентификации",o+=addHtmlFormFloating("Устройство",i+="</select>")),showModal("xxAddAgentModal","idx_dlgOkButton",function(){meshserver.send({action:"otpdev-set",nodeid:Q("d2devselect").value})})}}return!1}}function account_manageHardwareOtp(){return 2==xxdialogMode&&"otpauth-hardware-manage"==xxdialogTag&&dialogclose(0),!(xxdialogMode||!(4096&features))&&(meshserver.send({action:"otp-hkey-get"}),!1)}function account_addhkey(e){if(3==e){var t="Введите имя ключа для добавления.<br /><br />";t+=addHtmlFormFloating("Имя ключа",'<input id=dp1keyname class="form-control" maxlength=20 autocomplete=off placeholder="Мой ключ" onkeyup=account_addhkeyValidate(event,2) />')}else if(2==e){t="Введите имя ключа, выберите поле OTP и нажмите кнопку на YubiKey&trade;.<br /><br />";t+=addHtmlFormFloating("Имя ключа",'<input id=dp1keyname class="form-control" maxlength=20 autocomplete=off placeholder="Мой ключ" onkeyup=account_addhkeyValidate(event,1) />'),t+=addHtmlFormFloating("YubiKey&trade; OTP",'<input id=dp1key class="form-control" autocomplete=off onkeyup=account_addhkeyValidate(event,2) />')}setModalContent("xxAddAgent","Добавить ключ безопасности",t),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_addhkeyEx(3,e)),Q("dp1keyname").focus()}function account_addhkeyValidate(e,t){null!=e&&13==e.keyCode&&(2==t?dialogclose(1):Q("dp1key").focus())}function account_addhkeyEx(e,t){var n=Q("dp1keyname").value;if(""==n&&(n="MyKey"),2==t)meshserver.send({action:"otp-hkey-yubikey-add",name:n,otp:Q("dp1key").value}),xxdialogTag="otpauth-hardware-manage",setModalContent("xxAddAgent","Добавить ключ безопасности","<br />Проверка...<br /><br /><br />"),showModal("xxAddAgentModal","idx_dlgOkButton");else if(3==t)return meshserver.send({action:"webauthn-startregister",name:n}),!1}function account_removehkey(e){meshserver.send({action:"otp-hkey-remove",index:e}),meshserver.send({action:"otp-hkey-get"})}var currentMesh,filetreelinkpath,loclist={af:"Африканский",sq:"Албанский",ar:"Арабский (стандартный)","ar-dz":"Арабский (Алжир)","ar-bh":"Арабский (Бахрейн)","ar-eg":"Арабский (Египет)","ar-iq":"Арабский (Ирак)","ar-jo":"Арабский (Иордания)","ar-kw":"Арабский (Кувейт)","ar-lb":"Арабский (Ливан)","ar-ly":"Арабский (Ливия)","ar-ma":"Арабский (Марокко)","ar-om":"Арабский (Оман)","ar-qa":"Арабский (Катар)","ar-sa":"Арабский (Саудовская Аравия)","ar-sy":"Арабский (Сирия)","ar-tn":"Арабский (Тунис)","ar-ae":"Арабский (О.А.Э.)","ar-ye":"Арабский (Йемен)",an:"Арагонский",hy:"Армянский",as:"Ассамский",ast:"Астурии",az:"Азербайджанский",eu:"Баскский",bg:"Болгарский",be:"Белорусский",bn:"Бенгальский",bs:"Боснийский",br:"Бретонский",my:"Бирманский",ca:"Каталонский",ch:"Чаморро",ce:"Чеченский",zh:"Китайский","zh-hk":"Китайский (Гонконг)","zh-cn":"Китайский (КНР)","zh-sg":"Китайский (Сингапур)","zh-tw":"Китайский (Тайвань)",cv:"Чувашский",co:"Kорсиканский",cr:"Кри (Канадский язык)",hr:"Хорватский",cs:"Чешский",da:"Датский",nl:"Голландский (Стандартный)","nl-be":"Голландский (Бельгийский)",en:"Английский","en-au":"Английский (Австралия)","en-bz":"Английский (Белиз)","en-ca":"Английский (Канада)","en-ie":"Английский (Ирландия)","en-jm":"Английский (Ямайка)","en-nz":"Английский (Новая Зеландия)","en-ph":"Английский (Филиппины)","en-za":"Английский (Южная Африка)","en-tt":"Английский (Тринидад и Тобаго)","en-gb":"Английский (Великобритания)","en-us":"Английский (Соединенные Штаты)","en-zw":"Английский (Зимбабве)",eo:"Эсперанто",et:"Эстонский",fo:"Фарерский",fa:"Фарси (Персидский)",fj:"Фиджи",fi:"Финский",fr:"Французский (Стандартный)","fr-be":"Французский (Бельгия)","fr-ca":"Французский (Канада)","fr-fr":"Французский (Франция)","fr-lu":"Французский (Люксембург)","fr-mc":"Французский (Монако)","fr-ch":"Французский (Швейцария)",fy:"Фризский",fur:"Фриульский",gd:"Гэльский (Шотландия)","gd-ie":"Гэльский (Ирландский)",gl:"Галицкий",ka:"Грузинский",de:"Немецкий (Стандартный)","de-at":"Немецкий (Австрия)","de-de":"Немецкий (Германия)","de-li":"Немецкий (Лихтенштейн)","de-lu":"Немецкий (Люксембург)","de-ch":"Немецкий (Швейцария)",el:"Греческий",gu:"Гуджарати",ht:"Гаитянский",he:"Иврит",hi:"Хинди",hu:"Венгерский",is:"Исландский",id:"Индонезийский",iu:"Инуктитут",ga:"Ирландский",it:"Итальянский (Стандартный)","it-ch":"Итальянский (Швейцария)",ja:"Японский",kn:"Каннада",ks:"Кашмирский",kk:"Казахский",km:"Кхмерский",ky:"Киргизский",tlh:"Клингонский",ko:"Korean","ko-kp":"Корейский (Северная Корея)","ko-kr":"Корейский (Южная Корея)",la:"Латинский",lv:"Латышский",lt:"Литовский",lb:"Люксембургский",mk:"Mакедонский (БЮР)",ms:"Малайский",ml:"Малаяламский",mt:"Мальтийский",mi:"Маори",mr:"Маратхи",mo:"Молдавский",nv:"Навахо",ng:"Ндонга",ne:"Непальский",no:"Норвежский",nb:"Норвежский (Букмол)",nn:"Норвежский (Нюнорск)",oc:"Окситанский",or:"Ория",om:"Оромо","fa-ir":"Персидский/Иран",pl:"Польский",pt:"Португальский","pt-br":"Португальский (Бразилия)",pa:"Пенджаби","pa-in":"Пенджаби (Индия)","pa-pk":"Пенджаби (Пакистан)",qu:"Кечуа",rm:"Ретороманский",ro:"Румынский","ro-mo":"Румынский (Молдавия)",ru:"Русский","ru-mo":"Русский (Молдавия)",sz:"Саамский",sg:"Санго",sa:"Санскритский",sc:"Сардинский",sd:"Синдхи",si:"Сингальский",sr:"Сербский",sk:"Словацкий",sl:"Словенский",so:"Сомани",sb:"Сорбский",es:"Испанский","es-ar":"Испанский (Аргентина)","es-bo":"Испанский (Боливия)","es-cl":"Испанский (Чили)","es-co":"Испанский (Колумбия)","es-cr":"Испанский (Коста-Рика)","es-do":"Испанский (Доминиканская Республика)","es-ec":"Испанский (Эквадор)","es-sv":"Испанский (Сальвадор)","es-gt":"Испанский (Гватемала)","es-hn":"Испанский (Гондурас)","es-mx":"Испанский (Мексика)","es-ni":"Испанский (Никарагуа)","es-pa":"Испанский (Панама)","es-py":"Испанский (Парагвай)","es-pe":"Испанский (Перу)","es-pr":"Испанский (Пуэрто-Рико)","es-es":"Испанский (Испания)","es-uy":"Испанский (Уругвай)","es-ve":"Испанский (Венесуэла)",sx:"Суту",sw:"Суахили",sv:"Шведский","sv-fi":"Шведский (Финляндия)","sv-sv":"Шведский (Швеция)",ta:"Тамильский",tt:"Татарский",te:"Телугу",th:"Тайский",tig:"Тигровый",ts:"Тсонга",tn:"Тсвана",tr:"Турецкий",tk:"Туркменский",uk:"Украинский",hsb:"Верхний Сорбский",ur:"Урду",ve:"Венда",vi:"Вьетнамский",vo:"Волапукский",wa:"Валлонский",cy:"Уэльский",xh:"Xhosa",ji:"Идиш",zu:"Зулусский"},loclistex={"zh-chs":"Упрощенный китайский)","zh-cht":"Китайский традиционный)"};function account_showLocalizationSettings(){if(xxdialogMode)return!1;var e=getstore("loctag",0),t="",n='<select id=d2locselect class="form-select"><option value="*">Использовать настройки браузера</option>';for(var o in loclist)n+='<option value="'+o+'"'+(e==o?" selected":"")+">"+o+" - "+loclist[o]+"</option>";if(n+="</select>",serverinfo.languages&&serverinfo.languages.length>0){t+="Изменение языка потребует перезагрузить страницу.<br /><br />";var i='<select id=d2langselect class="form-select"><option value="*">Использовать настройки браузера</option>';for(var o in serverinfo.languages){var a=serverinfo.languages[o];i+='<option value="'+a+'"'+(userinfo.lang==a?" selected":"")+">"+a+" - "+(loclist[a]?loclist[a]:loclistex[a])+"</option>"}t+=addHtmlFormFloating("Язык",i+="</select>")}return t+=addHtmlFormFloating("Дата и время",n),4294967295==userinfo.siteadmin&&""==domain&&(t+='<br /><a rel="noreferrer noopener" target="_blank" href="translator.htm">Помочь перевести MeshCentral</a>'),setModalContent("xxAddAgent","Настройки локализации",t),showModal("xxAddAgentModal","idx_dlgOkButton",account_showLocalizationSettingsEx),!1}function account_showLocalizationSettingsEx(){var e=Q("d2langselect"),t=e?e.value:null;"*"==t&&null==userinfo.lang&&(t=userinfo.lang),t!=userinfo.lang&&meshserver.send({action:"changelang",lang:t});var n=getstore("loctag",0),o=Q("d2locselect").value;n!=o&&("*"!=o?args.locale=o:delete args.locale,putstore("loctag",args.locale),mainUpdate(4294967295))}function account_enableNotifications(){return Notification&&Notification.requestPermission().then(function(e){QV("accountEnableNotificationsSpan","granted"!=e),setupServiceWorker()}),!1}function account_createLoginToken(){if(xxdialogMode)return!1;var e="",t="Создайте временные имя пользователя и пароль, которые можно использовать в качестве альтернативы для входа в вашу учетную запись. Это полезно для того, чтобы инструменты или другие службы могли получить доступ к вашей учетной записи.<br /><br />",n={0:"Неограниченно",1:"1 минута",5:"5 минут",10:"10 минут",15:"15 минут",30:"30 минут",45:"45 минут",60:"60 минут",120:"2 часа",240:"4 часа",480:"8 часов",720:"12 часов",960:"16 часов",1440:"24 часа",2880:"2 дня",5760:"4 дня",10080:"7 дней"};for(var o in n)e+="<option value="+o+">"+n[o]+"</option>";t+='<div class="form-floating mb-3">',t+='<input type=text class="boxsize form-control" id=d2tokenName maxlength="100" placeholder="Имя токена" onchange=account_createLoginTokenValidate() onkeyup=account_createLoginTokenValidate()>',t+="<label for=d2tokenName>Имя токена</label>",t+="</div>",setModalContent("xxAddAgent","Создать токен входа",t+=addHtmlFormFloating("Время действия",'<select class="boxsize form-select" id=d2tokenExpire>'+e+"</select>")),showModal("xxAddAgentModal","idx_dlgOkButton",account_createLoginTokenEx),QE("idx_dlgOkButton",!1),Q("d2tokenName").focus()}function account_createLoginTokenValidate(){QE("idx_dlgOkButton",Q("d2tokenName").value.length>0)}function account_createLoginTokenEx(){meshserver.send({action:"createLoginToken",name:Q("d2tokenName").value,expire:parseInt(Q("d2tokenExpire").value)})}function account_showAccountNotifySettings(){if(xxdialogMode)return!1;setModalContent("xxAddAgent","Настройки уведомлений",'<div class="form-check"><label><input id=p2notifyPlayNotifySound class="form-check-input me-2" type=checkbox />Звук уведомления</label></div><div class="form-check"><label><input id=p2notifyGroupName class="form-check-input me-2" type=checkbox />Показывать имя группы устройств</label></div><div class="form-check"><label><input id=p2notifyIntelDeviceConnect class="form-check-input me-2" type=checkbox />Подключения устройств</label></div><div class="form-check"><label><input id=p2notifyIntelDeviceDisconnect class="form-check-input me-2" type=checkbox />Отключения устройств</label></div><div class="form-check"><label><input id=p2notifyIntelAmtKvmActions class="form-check-input me-2" type=checkbox />События Intel&reg; AMT desktop или serial</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",account_showAccountNotifySettingsEx);var e=getstore("notifications",0);return Q("p2notifyPlayNotifySound").checked=1&e,Q("p2notifyIntelDeviceConnect").checked=2&e,Q("p2notifyIntelDeviceDisconnect").checked=4&e,Q("p2notifyIntelAmtKvmActions").checked=8&e,Q("p2notifyGroupName").checked=16&e,!1}function account_showAccountNotifySettingsEx(){var e=0;e+=Q("p2notifyPlayNotifySound").checked?1:0,e+=Q("p2notifyIntelDeviceConnect").checked?2:0,e+=Q("p2notifyIntelDeviceDisconnect").checked?4:0,e+=Q("p2notifyIntelAmtKvmActions").checked?8:0,putstore("notifications",e+=Q("p2notifyGroupName").checked?16:0)}function account_showVerifyEmail(){return xxdialogMode||1==userinfo.emailVerified||1!=serverinfo.emailcheck||(setModalContent("xxAddAgent","Подтверждение email","Нажмите ОК для отправки подтверждения по электронной почте:<br /><div style=padding:8px><b>"+EscapeHtml(userinfo.email)+"</b></div>Подождите пару минут для получения подтверждения."),showModal("xxAddAgentModal","idx_dlgOkButton",()=>account_showVerifyEmailEx())),!1}function account_showVerifyEmailEx(){meshserver.send({action:"verifyemail",email:userinfo.email})}function account_showChangeEmail(){if(xxdialogMode)return!1;return setModalContent("xxAddAgent","Изменение адреса email",'Измените адрес электронной почты вашей учетной записи здесь.<br /><br /><div class="form-floating"><input id=dp2email class="form-control" maxlength=256 onchange=account_validateEmail() onkeyup=account_validateEmail(event) placeholder=Email /> <label for=dp2email>Email</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",account_changeEmail),null!=userinfo.email&&(Q("dp2email").value=userinfo.email),account_validateEmail(),Q("dp2email").focus(),!1}function account_validateEmail(e,t){QE("idx_dlgOkButton",validateEmail(Q("dp2email").value)&&Q("dp2email").value!=userinfo.email),null!=e&&13==e.keyCode&&dialogclose(1)}function account_changeEmail(){meshserver.send({action:"changeemail",email:Q("dp2email").value})}function account_showDeleteAccount(){if(xxdialogMode)return!1;var e="Чтобы удалить эту учетную запись, введите пароль учетной записи в оба поля и нажмите ОК.<br /><br />";return e+="<form method=post>",e+="<input type=hidden name=action value=deleteaccount />",e+='<input type=hidden name=authcookie value="'+authCookie+'" />',e+='<div class="container">',e+='<div class="form-floating mb-2">',e+='<input type=password class="form-control" id=apassword1 name=apassword1 autocomplete=off placeholder="Password" onchange=account_validateDeleteAccount() onkeyup=account_validateDeleteAccount()>',e+='<label for="apassword1">Password</label>',e+="</div>",e+='<div class="form-floating mb-3">',e+='<input type=password class="form-control" id=apassword2 name=apassword2 autocomplete=off placeholder="Confirm Password" onchange=account_validateDeleteAccount() onkeyup=account_validateDeleteAccount()>',e+="<label for=apassword2>Confirm Password</label>",e+="</div>",e+="</div>",setModalContent("xxAddAgent","Удалить учетную запись",e+="</form>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){dialogclose(1)}),account_validateDeleteAccount(),Q("apassword1").focus(),!1}function account_showChangePassword(){if(xxdialogMode)return!1;var e="Измените пароль своей учетной записи, введя старый пароль и дважды новый пароль в поля ниже.";if(e+="<br /><br />",e+='<div class="container">',e+='<div class="form-floating mb-2">',e+='<input type=password class="form-control" id=apassword0 name=apassword0 autocomplete=off placeholder="Old password" onchange=account_validateNewPassword() onkeyup=account_validateNewPassword() onkeydown=account_validateNewPassword()>',e+="<label for=apassword0>Old password</label>",e+="</div>",e+='<div class="form-floating mb-2">',e+='<input type=password class="form-control" id=apassword1 name=apassword1 autocomplete=off placeholder="New password" onchange=account_validateNewPassword() onkeyup=account_validateNewPassword() onkeydown=account_validateNewPassword()>',e+="<label for=apassword1>New password</label>",e+="<b><span id=dxPassWarn></span></b>",e+="</div>",e+='<div class="form-floating mb-2">',e+='<input type=password class="form-control" id=apassword2 name=apassword2 autocomplete=off placeholder="Confirm new password" onchange=account_validateNewPassword() onkeyup=account_validateNewPassword() onkeydown=account_validateNewPassword()>',e+="<label for=apassword2>Confirm new password</label>",e+="</div>",65536&features&&(e+='<div class="form-floating mb-2">',e+='<input type=text class="form-control" id=apasswordhint name=apasswordhint maxlength=250 autocomplete=off onchange=account_validateNewPassword() onkeyup=account_validateNewPassword() onkeydown=account_validateNewPassword()>',e+="<label for=apasswordhint>Password hint</label>",e+="</div>"),e+="</div>",passRequirements){var t=[],n=0;for(var o in passRequirements)"reset"!=o&&"hint"!=o&&(t.push(o+":"+passRequirements[o]),n++);n>0&&(e+="<br /><span style=font-size:x-small>Требования: "+t.join(", ")+".</span>")}return setModalContent("xxAddAgent","Смена пароля",e+="<br />"),showModal("xxAddAgentModal","idx_dlgOkButton",account_showChangePasswordEx),Q("apassword0").focus(),account_validateNewPassword(),!1}function account_showChangePasswordEx(){if(Q("apassword1").value==Q("apassword2").value){var e={action:"changepassword",oldpass:Q("apassword0").value,newpass:Q("apassword1").value};65536&features&&(e.hint=Q("apasswordhint").value),meshserver.send(e)}}function account_showThemesSwitcher(){if(xxdialogMode)return!1;var e=getstore("theme")||"default",t=JSON.parse(getstore("lastThemes")||"[]"),n=new Set(t),o='<div class="form-group"><label for="theme-switcher">Выберите тему:</label>';return o+='<select id="theme-switcher" class="form-select" onchange="account_switchThemeEx()">',t.length>0&&(o+='<optgroup label="Последние темы"">',t.forEach(function(t){o+=`<option value="${t}"${t===e?" selected":""}>${t.charAt(0).toUpperCase()+t.slice(1)}</option>`}),o+="</optgroup>"),o+='<optgroup label="Все темы">',[{value:"default",label:"По умолчанию"},{value:"cerulean",label:"Cerulean"},{value:"cosmo",label:"Cosmo"},{value:"cyborg",label:"Cyborg"},{value:"darkly",label:"Darkly"},{value:"flatly",label:"Flatly"},{value:"journal",label:"Journal"},{value:"litera",label:"Litera"},{value:"lumen",label:"Lumen"},{value:"lux",label:"Lux"},{value:"materia",label:"Materia"},{value:"minty",label:"Minty"},{value:"morph",label:"Morph"},{value:"pulse",label:"Pulse"},{value:"sandstone",label:"Sandstone"},{value:"simplex",label:"Simplex"},{value:"sketchy",label:"Sketchy"},{value:"solar",label:"Solar"},{value:"spacelab",label:"Spacelab"},{value:"united",label:"United"},{value:"vapor",label:"Vapor"},{value:"yeti",label:"Yeti"},{value:"zephyr",label:"Zephyr"}].forEach(function(t){if(!n.has(t.value)){var i=t.value===e?" selected":"";o+=`<option value="${t.value}"${i}>${t.label}</option>`}}),o+="</optgroup>",setModalContent("xxAddAgent","Сменить тему",o+="</select></div>"),showModal("xxAddAgentModal","idx_dlgOkButton"),!1}function account_switchThemeEx(){const e=document.getElementById("theme-switcher").value,t="default"!=e?encodeURIComponent(e):encodeURIComponent("..");document.getElementById("theme-stylesheet").href=`styles/themes/${t}/bootstrap-min.css`,putstore("theme",e);var n=JSON.parse(getstore("lastThemes")||"[]");n.includes(e)?(n=n.filter(t=>t!==e)).unshift(e):(n.length>=4&&n.pop(),n.unshift(e)),putstore("lastThemes",JSON.stringify(n))}function account_createMesh(){if(4294967295!=userinfo.siteadmin&&64&userinfo.siteadmin)return setModalContent("xxAddAgent","Новая группа устройств","This account does not have the rights to create a new device group."),showModal("xxAddAgentModal","idx_dlgOkButton"),!1;if(!0!==userinfo.emailVerified&&1==serverinfo.emailcheck&&4294967295!=userinfo.siteadmin)return setModalContent("xxAddAgent","Безопасность учетной записи",'Unable to access this feature until a email address is verified. This is required for password recovery. Go to the "My Account" tab to change and verify an email address.'),showModal("xxAddAgentModal","idx_dlgOkButton"),!1;if(262144&features&&0==count2factoraAuths())return setModalContent("xxAddAgent","Безопасность учетной записи",'Unable to access this feature until two-factor authentication is enabled. This is required for extra security. Go to the "My Account" tab and look at the "Account Security" section.'),showModal("xxAddAgentModal","idx_dlgOkButton"),!1;var e=[];if(!(2&features))for(var t in nodes){var n=nodes[t];2==n.mtype&&null!=n.agent&&4294967295==GetNodeRights(n)&&e.push(n)}var o="Создайте новую группу устройств, используя параметры ниже.<br /><br />",i="";if(o+=addHtmlFormFloating("Имя",'<input id=dp2meshname maxlength=128 placeholder="Name" class=form-control onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,1) />'),1&features||(i+="<option value=3>Локальные устройства, без агентов</option>"),!(2&features)&&e.length>0&&(i+="<option value=103>Устройства без агента, ретранслируемые через агент</option>"),65536&features2&&(1&features||(i+="<option value=4>IP-KVM / Устройство питания</option>"),!(2&features)&&e.length>0&&(i+="<option value=104>IP-KVM / Устройство питания, ретранслируемое через агента</option>")),o+=addHtmlFormFloating("Тип","<select id=dp2meshtype class=form-select onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,2) ><option value=2>Управление с помощью программного агента</option><option value=1>Только Intel&reg; AMT, без агента</option>"+i+"</select>"),e.length>0){o+="<div id=d2devrelaydiv style=display:none>",e.sort(nameSort);var a=[];for(var t in e)a.push('<option value="'+e[t]._id+'">'+EscapeHtml(e[t].name)+" ("+EscapeHtml(e[t].meshnamel)+")</option>");o+=addHtmlFormFloating("Устройство-релей","<select id=d2devrelay onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,2) class=form-select >"+a.join("")+"</select>"),o+="</div>"}return o+=addHtmlFormFloating("Описание","<textarea id=dp2meshdesc maxlength=1024 class=form-control></textarea>"),o+="<div id=d2ipkvm style=display:none><hr />",o+=addHtmlFormFloating("Модель","<select id=dp2ipkvmmodel onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,2) class=form-select ><option value=1>Raritan Dominion KX III</option><option value=2>Web Power Switch 7</option></select>"),o+=addHtmlFormFloating("Имя хоста",'<input id=dp2ipkvmhost maxlength=128 placeholder="Hostname" onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,1) class=form-control />'),o+=addHtmlFormFloating("Имя пользователя",'<input id=dp2ipkvmuser maxlength=128 placeholder="Username" onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,1) class=form-control />'),o+=addHtmlFormFloating("Пароль",'<input id=dp2ipkvmpass type=password placeholder="Password" maxlength=128 onchange=account_validateMeshCreate() onkeyup=account_validateMeshCreate(event,1) class="form-control" />'),setModalContent("xxAddAgent","Новая группа устройств",o+="</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",account_createMeshEx),account_validateMeshCreate(),document.getElementById("dp2meshname").focus(),!1}function account_validateMeshCreate(e,t){var n=parseInt(Q("dp2meshtype").value);1==t&&null!=e&&"Ввод"==e.key&&Q("dp2meshname").value.length>0&&Q("dp2meshtype").focus(),2==t&&null!=e&&"Ввод"==e.key&&Q("dp2meshdesc").focus();var o=Q("dp2meshname").value.length>0;QV("d2ipkvm",4==n||104==n);try{QV("d2devrelaydiv",n>100)}catch(e){}4==n&&0==Q("dp2ipkvmhost").value.length&&0==Q("dp2ipkvmuser").value.length&&0==Q("dp2ipkvmpass").value.length&&(o=!1),QE("idx_dlgOkButton",o)}function account_createMeshEx(e,t){var n=parseInt(Q("dp2meshtype").value),o={action:"createmesh",meshname:Q("dp2meshname").value,meshtype:n,desc:Q("dp2meshdesc").value};4!=n&&104!=n||(o.kvmmodel=parseInt(Q("dp2ipkvmmodel").value),o.kvmhost=Q("dp2ipkvmhost").value,o.kvmuser=Q("dp2ipkvmuser").value,o.kvmpass=Q("dp2ipkvmpass").value),n>100&&(o.meshtype=n-100,o.relayid=Q("d2devrelay").value),meshserver.send(o)}function account_validateDeleteAccount(){QE("account_dlgOkButton",Q("apassword1").value.length>0&&Q("apassword1").value==Q("apassword2").value)}function account_validateNewPassword(){var e="",t=Q("apassword0").value.length>0&&Q("apassword1").value.length>0&&Q("apassword1").value==Q("apassword2").value&&Q("apassword0").value!=Q("apassword1").value;if(65536&features&&Q("apasswordhint").value==Q("apassword1").value&&(t=!1),""!=Q("apassword1").value)if(null==passRequirements||""==passRequirements){var n=checkPasswordStrength(Q("apassword1").value);e=n>=80?"<span style=color:green>Надежный<span>":n>=60?"<span style=color:blue>Хорошо<span>":"<span style=color:red>Слабый<span>"}else{0==checkPasswordRequirements(Q("apassword1").value,passRequirements)&&(t=!1,e="<span style=color:red>Политика<span>")}QH("dxPassWarn",e),QE("idx_dlgOkButton",t)}function checkPasswordStrength(e){var t=0,n={},o=0,i={digits:/\d/.test(e),lower:/[a-z]/.test(e),upper:/[A-Z]/.test(e),nonWords:/\W/.test(e)};if(!e)return 0;for(var a=0;a<e.length;a++)n[e[a]]=(n[e[a]]||0)+1,t+=5/n[e[a]];for(var s in i)o+=1==i[s]?1:0;return parseInt(t+10*(o-1))}function checkPasswordRequirements(e,t){if(null==t||""==t||"object"!=typeof t)return!0;if(t.min&&e.length<t.min)return!1;if(t.max&&e.length>t.max)return!1;for(var n=0,o=0,i=0,a=0,s=0;s<e.length;s++)/\d/.test(e[s])&&n++,/[a-z]/.test(e[s])&&o++,/[A-Z]/.test(e[s])&&i++,/\W/.test(e[s])&&a++;return!(t.numeric&&n<t.numeric)&&(!(t.lower&&o<t.lower)&&(!(t.upper&&i<t.upper)&&!(t.nonalpha&&a<t.nonalpha)))}function updateMeshes(){var e='<div class="row">',t=0,n=0,o=[];for(i in meshes)o.push(meshes[i]);for(i in o.sort(nameSort),o){t>1&&(e+="</tr><tr>",t=0),t++,n++;var a=GetMeshRights(o[i]),s="Частичные права";4294967295==a?s="Администратор с полным доступом":0==a&&(s="Нет прав"),e+='\n                    <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3 mb-2"\n                            onclick="gotoMesh(\''+o[i]._id+"')\"\n                            onkeypress=\"if (event.key=='Enter') gotoMesh('"+o[i]._id+'\')"\n                            style="cursor:pointer;">\n                        <div class="card mb-3">\n                            <div class="row g-0">\n                                <div class="col-2 parent" style="display: flex; justify-content: center; align-items: center;">\n                                    <i class="mi me-1"></i>\n                                </div>\n                                <div class="col-10 mx-auto" tabindex="0">\n                                    <div class="card-body" style=padding:0;>\n                                        <h5 class="card-title e1">'+EscapeHtml(o[i].name)+'</h5>\n                                        <p class="card-text">'+s+'</p>\n                                        <div class="g2"></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    '}e+="</div>",meshcount=n,QH("p2meshes",e),QV("p2noMeshFound",0==n)}function updateLoginTokens(){var e="",t=1;if(null!=loginTokens&&loginTokens.length>0){e+='<p><strong>Активные токены входа</strong> - <span id="p2createMeshLink1"> <button class="btn btn-primary btn-sm" onclick="return account_createLoginToken()"><i class="fa-fw fa-solid fa-circle-plus"></i> Создать</button></span></p>',e+='<div style=margin-left:40px><table class="table table-hover table-striped"><tbody><tr class="table-active"><th scope=col style=text-align:left;width:430px>Имя</th><th scope=col style=text-align:left>Имя пользователя</th></tr>';for(var n=0;n<loginTokens.length;n++){var o=loginTokens[n],i="<a href=# onclick='return p2removeLoginToken(event,\""+encodeURIComponentEx(o.tokenUser)+'")\' title="Удалить токен входа" role=button><i class="fa-solid fa-trash text-danger fa-xs"></i></a>',a="";0!=o.expire&&(a=EscapeHtml(format("Срок действия истекает {0}",printDateTime(new Date(o.expire))))+" "),e+="<tr "+(++t%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><i class="fa-fw fa-solid fa-user"></i>&nbsp;'+EscapeHtml(o.name)+"<div></div></div></td><td style=width:70%><div style=float:right>"+a+i+"</div><div>"+EscapeHtml(o.tokenUser)+"</div></td></tr>"}e+="</tbody></table></div><br />",QV("accountCreateLoginTokenSpan",!1)}else QV("accountCreateLoginTokenSpan",128&features2);QH("p2logintokens",e)}function p2removeLoginToken(e,t){if(t=decodeURIComponent(t),null!=loginTokens){for(var n=null,o=0;o<loginTokens.length;o++)loginTokens[o].tokenUser==t&&(n=loginTokens[o]);if(null!=n){var i="Подтвердить удаление этого токена входа?<br /><br />";i+=addHtmlValue("Имя",EscapeHtml(n.name)),setModalContent("xxAddAgent","Удалить токен входа",i+=addHtmlValue("Имя пользователя",EscapeHtml(n.tokenUser))),showModal("xxAddAgentModal","idx_dlgOkButton",()=>function(e,t){meshserver.send({action:"loginTokens",remove:[t]})})}}}function gotoMesh(e){return currentMesh=meshes[e],p20updateMesh(),go(20),!1}function server_setupGoogleDriveBackup(){if(xxdialogMode||null==miscState.googleDrive)return!1;var e=miscState.googleDrive;if(e.state<3){var t='<img style=float:right src="images/googledrive-48.png" /><div>Настройте этот сервер для автоматической загрузки резервных копий на Google Диск. Начните с создания и ввода ClientID и ClientSecret Google Диска для своей учетной записи.</div><br />';t+=addHtmlValue("Учетные данные",'<a href="https://console.developers.google.com/apis/api/drive.googleapis.com/credentials" rel="noreferrer noopener" target="_blank">Консоль Google Диска</a>'),t+=addHtmlFormFloating("ID клиента",'<input id=gdclientid class="form-control" placeholder="xxxxxxxx.apps.googleusercontent.com" onkeyup=server_setupGoogleDriveBackupCheck1()></input>'),setModalContent("xxAddAgent","Резервное копирование на Google Диск",t+=addHtmlFormFloating("Секрет клиента",'<input id=gdclientsecret class="form-control" onkeyup=server_setupGoogleDriveBackupCheck1()></input>')),showModal("xxAddAgentModal","idx_dlgOkButton",()=>server_setupGoogleDriveBackupEx(3,"gd1")),Q("gdclientid").focus(),QE("idx_dlgOkButton",!1)}else if(3==e.state){t='<img style=float:right src="images/googledrive-48.png" /><div>Резервное копирование на Google Диск в настоящее время активно.</div>';setModalContent("xxAddAgent","Резервное копирование на Google Диск",t+='<br /><label><input id=gdcheck type=checkbox class="form-check-input me-2" onchange=server_setupGoogleDriveBackupCheck2() />Удалить конфигурацию</label>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>server_setupGoogleDriveBackupEx(3,"gd0")),QE("idx_dlgOkButton",!1)}}function server_setupGoogleDriveBackupCheck1(){QE("idx_dlgOkButton",Q("gdclientid").value.length>0&&Q("gdclientsecret").value.length>0)}function server_setupGoogleDriveBackupCheck2(){QE("idx_dlgOkButton",Q("gdcheck").checked)}function server_setupGoogleDriveBackupCheck3(){QE("idx_dlgOkButton",Q("gdcode").value.length>0)}function server_setupGoogleDriveBackupEx(e,t){"gd0"==t&&meshserver.send({action:"serverBackup",service:"googleDrive",state:0}),"gd1"==t&&meshserver.send({action:"serverBackup",service:"googleDrive",state:1,clientid:Q("gdclientid").value,clientsecret:Q("gdclientsecret").value}),"gd2"==t&&meshserver.send({action:"serverBackup",service:"googleDrive",state:2,code:Q("gdcode").value})}function server_showRestoreDlg(){if(xxdialogMode)return!1;var e="Восстановить сервер из резервной копии, <span style=color:red>это удалит существующие данные сервера.</span> Продолжайте дальше только если знаете, что делаете.<br /><br />";return e+='<form action="/restoreserver.ashx'+(urlargs.key?"?key="+urlargs.key:"")+'" enctype="multipart/form-data" method="post"><div>',e+="<input type=hidden name=auth value="+authCookie+">",e+='<input id=account_dlgFileInput type=file name=datafile class="form-control" accept=".zip,application/octet-stream,application/zip,application/x-zip,application/x-zip-compressed" onchange=account_validateServerRestore()>',setModalContent("xxAddAgent","Восстановить сервер",e+="</div></form>"),showModal("xxAddAgentModal","idx_dlgOkButton"),account_validateServerRestore(),!1}function account_validateServerRestore(){QE("idx_dlgOkButton",1==Q("account_dlgFileInput").files.length)}function server_showVersionDlg(){return xxdialogMode||(xxdialogMode=2,xxdialogTag="MeshCentralServerUpdate",setModalContent("xxAddAgent","Версия MeshCentral","Загрузка..."),showModal("xxAddAgentModal","idx_dlgOkButton"),meshserver.send({action:"serverversion"})),!1}function server_showVersionDlgUpdate(){var e=Q("d2updateCheck1").checked,t=Q("d2updateCheck2").checked;QE("d2updateCheck1","Неизвестно"!=xxdialogTag.stable&&xxdialogTag.current!=xxdialogTag.stable&&0==t),QE("d2updateCheck2","Неизвестно"!=xxdialogTag.latest&&xxdialogTag.current!=xxdialogTag.latest&&0==e),QE("idx_dlgOkButton",e&&!t||!e&&t)}function server_showVersionDlgEx(e,t){Q("d2updateCheck1").checked&&meshserver.send({action:"serverupdate",tag:"stable",version:t.stable}),Q("d2updateCheck2").checked&&meshserver.send({action:"serverupdate",tag:"latest",version:t.latest})}function server_showErrorsDlg(){return xxdialogMode||(xxdialogMode=2,xxdialogTag="MeshCentralServerErrors",setModalContent("xxAddAgent","Server Errors","Загрузка..."),meshserver.send({action:"servererrors"})),!1}function server_showErrorsDlgUpdate(){QE("idx_dlgOkButton",Q("d2clearErrorsCheck").checked)}function server_showErrorsDlgEx(){meshserver.send({action:"serverclearerrorlog"})}function d2CopyServerErrorsToClip(){saveAs(new Blob([Q("d2ServerErrorsLogPre").innerText],{type:"application/octet-stream"}),"servererrors.txt")}function server_showConfigDlg(){return xxdialogMode||(xxdialogMode=2,xxdialogTag="MeshCentralServerConfig",meshserver.send({action:"serverconfig"})),!1}function d2CopyServerConfigToClip(){saveAs(new Blob([Q("d2ServerConfigPre").innerText],{type:"application/octet-stream"}),"config.json")}function p20updateMesh(){if(null!=currentMesh){var e=GetMeshRights(currentMesh),t=EscapeHtml(currentMesh.name);0==t.length&&(t="<i>Пусто</i>"),1&e&&(t='<span role=button tabindex=0 title="Нажмите здесь, чтобы изменить имя группы устройств" onclick=p20editmesh(1) onkeyup="if (event.key == \'Enter\') p20editmesh(1)">'+t+' <i class="fa-solid fa-pencil fa-2xs"></i></span>'),QH("p20meshName",t),QV("MeshSummary",4!=currentMesh.mtype);var n=format("Неизвестно #{0}",currentMesh.mtype);1==currentMesh.mtype&&(n="Только Intel&reg; AMT, без агента"),2==currentMesh.mtype&&(n="Управляется с помощью программного агента"),3==currentMesh.mtype&&(n=null==currentMesh.relayid?"Локальные устройства, без агентов":"Устройства без агента, ретранслируемые через агент"),4==currentMesh.mtype&&(n=null==currentMesh.relayid?"IP-KVM-устройство":"Устройство IP-KVM ретранслируемое через агента",1==currentMesh.kvm.model&&(n+=", Raritan KX III"));var o="";if(8&args.hide&&(o+=addHtmlValue("Имя",t)),o+=addHtmlValue("Описание",addLinkConditional(currentMesh.desc&&""!=currentMesh.desc?EscapeHtml(currentMesh.desc):"<i>Пусто</i>","p20editmesh(2)",!!(1&e))),o+=addHtmlValue("Тип",n),(3==currentMesh.mtype||4==currentMesh.mtype)&&null!=currentMesh.relayid){var i="<i>Неизвестно</i>",a=getNodeFromId(currentMesh.relayid);null!=a&&(i=EscapeHtml(a.name)+" ("+EscapeHtml(a.meshnamel)+")"),o+=addHtmlValue("Устройство-релей",addLinkConditional(i,"p20editmeshrelay()",!!(1&e)))}if(4==currentMesh.mtype&&(o+=addHtmlValue("Имя хоста",currentMesh.kvm.host),o+=addHtmlValue("Имя пользователя",currentMesh.kvm.user)),null!=currentMesh.creatorid&&null!=users&&null!=users[currentMesh.creatorid]){var s=users[currentMesh.creatorid];o+=addHtmlValue("Создатель",'<a href=# onclick=gotoUser("'+encodeURIComponentEx(s._id)+'",false,null)>'+EscapeHtml(s.name)+"</a>")}else null!=currentMesh.creatorname&&(o+=addHtmlValue("Создатель",EscapeHtml(currentMesh.creatorname)));if(null!=currentMesh.creation&&(o+=addHtmlValue("Время создания",printDateTime(new Date(currentMesh.creation)))),3!=currentMesh.mtype){var r=[];currentMesh.flags&&(1&currentMesh.flags&&r.push("Автоудаление"),2&currentMesh.flags&&r.push(4==currentMesh.mtype?"Синхронизация имени порта":"Синхронизация имени хоста"),8&currentMesh.flags&&r.push("prefer --agentname"),16&currentMesh.flags&&r.push("allow override"),1==serverinfo.devGroupSessionRecording&&4&currentMesh.flags&&r.push("Запись сеансов")),"number"==typeof currentMesh.expireDevs&&currentMesh.expireDevs>0&&r.push("Удалить неактивные"),""==(r=r.join(", "))&&(r="<i>Пусто</i>"),o+=addHtmlValue("Функции",addLinkConditional(r,"p20editmeshfeatures()",1&e))}if(2==currentMesh.mtype){r=[];var l=0;currentMesh.consent&&(l=currentMesh.consent),serverinfo.consent&&(l|=serverinfo.consent),64&l&&8&l?r.push("Рабочий стол: запросить + панель-уведомление"):64&l?r.push("Панель-уведомление на экране"):8&l?r.push("Рабочий стол: запросить"):1&l&&r.push("Рабочий стол: уведомить"),16&l?r.push("Терминал: запросить"):2&l&&r.push("Терминал: уведомить"),32&l?r.push("Файлы: запросить"):4&l&&r.push("Файлы: уведомить"),7==l&&(r=["Всегда уведомлять"]),56&~l||(r=["Всегда запрашивать"]),""==(r=r.join(", "))&&(r="<i>Пусто</i>"),o+=addHtmlValue("Согласие пользователя",addLinkConditional(r,"p20editmeshconsent(1)",1&e))}if(!(3==currentMesh.mtype||4294967295!=userinfo.siteadmin&&1024&userinfo.siteadmin)){var d=0,c=[];if(userinfo.links&&userinfo.links[currentMesh._id]&&userinfo.links[currentMesh._id].notify&&(d|=userinfo.links[currentMesh._id].notify),userinfo.notify&&userinfo.notify[currentMesh._id]&&(d|=userinfo.notify[currentMesh._id]),2&d&&c.push("Подключиться"),4&d&&c.push("Разъединить"),8&d&&c.push("Intel&reg; AMT"),16384&features2&&userinfo.emailVerified){var u=0;16&d&&u++,32&d&&u++,64&d&&u++,u>0&&c.push(format("Email ({0})",u))}if(null!=userinfo.msghandle&&33554432&features2){u=0;128&d&&u++,256&d&&u++,512&d&&u++,u>0&&c.push(format("Messaging ({0})",u))}0==c.length&&c.push("<i>Пусто</i>"),o+=addHtmlValue("Уведомления",addLink(c.join(", "),"p20editMeshNotify()"))}if(16777216&features&&2==currentMesh.mtype){var p="<i>Пусто</i>",m=!1;null!=currentMesh.invite&&(m=!0,p=currentMesh.invite.codes.join(", ")),o+=addHtmlValue("Пригласительные коды",addLinkConditional(p,"p20editmeshInviteCode()",1&e||m))}if(currentMesh.mtype<3&&1&features2){var g="Политик нет";currentMesh.amt&&(1==currentMesh.amt.type?g="Деактивировать":2==currentMesh.amt.type?(g="Простой режим управления клиента (CCM)",2==currentMesh.amt.cirasetup&&(g+=" + CIRA")):3==currentMesh.amt.type?(g="Простой режим управления администратора (ACM)",2==currentMesh.amt.cirasetup&&(g+=" + CIRA")):4==currentMesh.amt.type&&(g="Полностью автоматический")),o+=addHtmlValue("Intel&reg; AMT",addLinkConditional(g,"p20editMeshAmt()",1&e))}if(1&e&&(o+='<br><input type=button class="btn btn-primary btn-sm mb-1" value=Примечания title="Посмотреть примечания этой группы устройств" onclick=showNotes(false,"'+encodeURIComponentEx(currentMesh._id)+'") />'),o+="<br style=clear:both><br>",2&e&&(o+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p20showAddMeshUserDialog()"><i class="fa-solid fa-circle-plus"></i> Добавить пользователей</button>',null!=usergroups)){var v=0,h=!1;for(var f in usergroups)null==usergroups[f].membershipType&&usergroups[f]._id.split("/")[1]==currentMesh._id.split("/")[1]&&(v++,null!=currentMesh.links&&null!=currentMesh.links[f]||(h=!0));v>0&&h&&(o+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p20showAddMeshUserDialog(2)"><i class="fa-solid fa-circle-plus"></i> Добавить группу пользователей</button>')}1==currentMesh.mtype&&(1&e&&(o+='<button class="btn btn-primary btn-sm me-2 mb-1" title="Import Intel&reg; AMT devices." onclick=\'return showAmtImport("'+currentMesh._id+'")\'><i class="fa-solid fa-circle-arrow-down"></i> Import</button>'),null!=currentMesh.amt&&currentMesh.amt.type>0&&(o+='<button class="btn btn-primary btn-sm me-2 mb-1" title="Выполнить активацию и настройку Intel&reg; AMT." onclick=\'return showAmtSetup("'+currentMesh._id+'")\'><i class="fa-solid fa-gear"></i> Настроить</button>')),2!=currentMesh.mtype||4294967295!=userinfo.siteadmin&&4096&userinfo.siteadmin||(o+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick=\'return addAgentToMesh("'+currentMesh._id+'")\' title="Добавьте новый компьютер в эту группу устройств, установив Mesh Agent."><i class="fa-solid fa-circle-plus"></i> Добавить агент</button>',o+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick=\'return inviteAgentToMesh("'+currentMesh._id+'")\' title="Пригласите кого-нибудь установить Mesh Agent в этой группе устройств."><i class="fa-solid fa-user-plus"></i> Пригласить</button>'),3!=currentMesh.mtype||4294967295!=userinfo.siteadmin&&4096&userinfo.siteadmin||(o+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick=\'return addLocalDeviceToMesh("'+currentMesh._id+'")\' title="Добавить устройство, находящееся в локальной сети."><i class="fa-solid fa-circle-plus"></i> Добавить устройство</button>'),!(currentMesh.amt&&currentMesh.amt.type>2)||4294967295!=userinfo.siteadmin&&4096&userinfo.siteadmin||(o+='<button class="btn btn-primary btn-sm me-2 mb-1" title="Переключите Intel AMT в режим управления администратором (ACM)." onclick=\'return showAmtAcmSetup()\'><i class="fa-solid fa-circle-arrow-down"></i> ACM</button>'),o+='<table class="table table-hover table-striped" cellpadding=2 cellspacing=0><tbody><tr><th scope=col>Права пользователей</th><th scope=col></th></tr>';var x=1,k=[];for(var f in currentMesh.links){var y=f.split("/")[2];currentMesh.links[f].name&&(y=currentMesh.links[f].name),f==userinfo._id&&(y=userinfo.name),null!=usergroups&&null!=usergroups[f]&&(y=usergroups[f].name),k.push({id:f,name:y,rights:currentMesh.links[f].rights})}for(var f in k.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0}),k){var b="",w=makeDeviceGroupRightsString(k[f].rights),M="fa-user";k[f].id!=userinfo._id&&(4294967295==e||2&e)&&(4294967295!=e&&4294967295==currentMesh.links[k[f].id].rights||(b="<a href=# onclick='return p20deleteUser(event,\""+encodeURIComponentEx(k[f].id)+'")\' title="Удалить права пользователя для этой группы устройств"><i role=button class="fa-solid fa-trash text-danger fa-fw fa-xs"></i></a>'),w='<span tabindex=0 style=cursor:pointer onclick=p20viewuser("'+encodeURIComponentEx(k[f].id)+"\") onkeypress=\"if (event.key=='Enter') p20viewuser('"+encodeURIComponentEx(k[f].id)+"')\">"+w+' <i class="fa-fw fa-solid fa-pencil fa-xs"></i></span>'),k[f].id.startsWith("ugrp/")&&(M="fa-users");var C=EscapeHtml(decodeURIComponent(k[f].name));null!=usergroups&&k[f].id.startsWith("ugrp/")&&(C="<a tabindex=0 href=# onclick='gotoUserGroup(\""+encodeURIComponentEx(k[f].id)+"\");haltEvent(event);'>"+C+"</a>"),null!=users&&k[f].id.startsWith("user/")&&(C="<a tabindex=0 href=# onclick='gotoUser(\""+encodeURIComponentEx(k[f].id)+"\");haltEvent(event);'>"+C+"</a>"),o+="<tr style="+(x%2==0?";background-color:#DDD":"")+'><td style=width:30%><div><i title="Пользователь" class="fa-solid fa-fw '+M+'"></i>&nbsp;'+C+"<div></div></div></td><td style=width:70%><div style=float:right>"+b+"</div><div>"+w+"</div></td></tr>",++x}if(o+="</tbody></table>",null!=deviceShares&&deviceSharesNode==currentMesh._id&&deviceShares.length>0){o+='<p></p><table class="table table-hover table-striped" cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col style=text-align:left;width:430px>Активные гоcтевые доступы к устройствам</th><th scope=col style=text-align:left><th scope=col style=text-align:left></th></tr>',x=1;for(f=0;f<deviceShares.length;f++){var S=deviceShares[f];b="";null!=S.url&&(b+='<a href="'+S.url+'" rel="noreferrer noopener" target=_blank title="Ссылка для совместного использования устройства" style=cursor:pointer><img src=images/link2.png border=0 height=10 width=10></a> '),b+="<a href=# onclick='return p30removeDeviceSharing(event,\""+encodeURIComponentEx(S.nodeid)+'","'+encodeURIComponentEx(S.publicid)+'","'+encodeURIComponentEx(S.guestName)+'")\' title="Удалить доступ к устройству" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>';var Q="";S.p<=7?Q=["","Терминал","Рабочий стол","Рабочий стол + Терминал","Файлы","Терминал + Файлы","Рабочий стол + Файлы","Рабочий стол + Терминал + Файлы"][S.p]:8==S.p?Q="HTTP/"+S.port:16==S.p&&(Q="HTTPS/"+S.port);var A=Q;null!=S.startTime&&null!=S.expireTime&&(A=format("{0}, с {1} на {2}",Q,printFlexDateTime(new Date(S.startTime)),printFlexDateTime(new Date(S.expireTime)))),null!=S.startTime&&null!=S.duration&&(A=(S.duration,format("{0}, {1} на {2} мин.",Q,printFlexDateTime(new Date(S.startTime)),S.duration))),1==S.recurring&&(A+=", Ежедневно"),2==S.recurring&&(A+=", Еженедельно"),2&S.p&&!0===S.viewOnly&&(A+=",  Только просмотр рабочего стола"),null!=S.consent&&(0==S.consent?A+=", Нет согласия":(56&S.consent&&(A+=", Запрос согласия"),64&S.consent&&(A+=", Панель-уведомление")));var D=EscapeHtml(S.guestName);if(S.publicid.startsWith("AS:node/")&&(D="<i>Общий доступ из Агента</i>"),null!=(N=getNodeFromId(S.nodeid))){var T=N.conn>0?"":" gray";o+="<tr "+(++x%2==0?"style=background-color:#DDD":"")+"><td style=width:30%>"+("<div onclick='gotoDevice(\""+N._id+'",10);haltEvent(event);\' style=float:left class="j'+N.icon+T+'"></div>&nbsp;<a onclick=\'gotoDevice("'+N._id+"\",10);haltEvent(event);'>"+EscapeHtml(N.name)+"</a>")+"<td style=width:30%><div class=m2></div><div>&nbsp;"+D+"<div></div></div></td><td style=width:70%><div style=float:right>"+b+"</div><div>"+A+"</div></td></tr>"}}o+="</tbody></table>"}else deviceSharesNode!=currentMesh._id&&deviceSharesReq!=currentMesh._id&&(deviceSharesReq=currentMesh._id,meshserver.send({action:"deviceMeshShares",meshid:currentMesh._id}));x=0,nodes.sort(deviceSort);var E="";1==currentMesh.mtype&&(E+='<a onclick=meshDownloadDeviceList()><img title="Скачать список устройств" src="images/link4.png" /></a>',1&features||(E+=' <a onclick=meshImportDeviceList()><img title="Импортировать список устройств" src="images/link6.png" /></a>'));var _='<table class="table table-hover table-striped"><tbody><tr class="class="fw-bold"><th>Устройства</th><th scope=col class="text-end">'+E+"</th></tr>";for(var f in nodes){var N;T=(N=nodes[f]).conn>0?"":" gray";currentMesh._id==N.meshid&&(_+="<tr><td style=width:30%><div onclick='gotoDevice(\""+N._id+'",10);haltEvent(event);\' style=float:left class="j'+N.icon+T+'"></div>&nbsp;<a onclick=\'gotoDevice("'+N._id+"\",10);haltEvent(event);'>"+EscapeHtml(N.name)+"</a></div></div></td><td><div style=float:right>"+PowerStateStr(N.pwr)+"&nbsp;</div><div>"+(N.osdesc?EscapeHtml(N.osdesc):"")+"</div></td></tr>",++x)}0==x&&(_+='<tr><td colspan="2"><i>Пусто</i></td></tr>'),_+="</tbody></table>",4294967295==e&&(_+="<div style=font-size:small;text-align:right><span><a href=# onclick=p20showDeleteMeshDialog() style=cursor:pointer>Удалить группу</a></span></div>"),QH("p20info",o),QH("p20info2",_);var I="";if(!(268435456&features)&&xxcurrentView>=20&&xxcurrentView<=29&&null!=currentMesh){for(var f in I="?viewmode="+xxcurrentView+"&gotomesh="+currentMesh._id.split("/")[2],urlargs)I+="&"+f+"="+urlargs[f];try{window.history.replaceState({},document.title,window.location.pathname+I)}catch(e){}}}}function meshDownloadDeviceList(){if(!xxdialogMode){var e={webappversion:"0.9.0",computers:[]};for(var t in nodes){var n=nodes[t];if(currentMesh._id==n.meshid&&null!=n.intelamt){var o={name:n.name,host:n.host,user:n.intelamt.user,pass:"",tls:1==n.intelamt.tls?1:0,ver:n.intelamt.ver,pstate:n.intelamt.state};2==n.intelamt.state&&(o.pmode=1),n.intelamt.realm&&(o.digestrealm=n.intelamt.realm),n.intelamt.hash&&(o.tlscerthash=n.intelamt.hash),e.computers.push(o)}}saveAs(stringToUtf8BlobNoHeader(JSON.stringify(e,null,2)),currentMesh.name+".json")}}function meshImportDeviceList(){if(!xxdialogMode){setModalContent("xxAddAgent","Импорт устройств Intel&reg; AMT",'Импортируйте список локальных устройств Intel&reg; AMT в формате MeshCommander JSON.<br /><br /><input type=file id=d4importFile class="form-control" accept=".json" onchange=meshImportDeviceListValidate() />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>meshImportDeviceListEx()),QE("idx_dlgOkButton",!1)}}function meshImportDeviceListValidate(){QE("idx_dlgOkButton",null!=Q("d4importFile").value)}function meshImportDeviceListEx(){var e=new FileReader;e.onload=function(e){var t=null;try{t=JSON.parse(e.target.result)}catch(e){return setModalContent("xxAddAgent","Импорт устройств Intel&reg; AMT",format("Некорректный файл JSON: {0}.",e)),void showModal("xxAddAgentModal","idx_dlgOkButton")}if("object"==typeof t&&"string"==typeof t.webappversion&&"object"==typeof t.computers&&Array.isArray(t.computers)){var n=0;for(var o in t.computers){var i=t.computers[o];if("string"==typeof i.name&&"string"==typeof i.host&&"string"==typeof i.user&&"string"==typeof i.pass){var a={action:"addamtdevice",meshid:currentMesh._id,devicename:i.name,hostname:i.host,amtusername:i.user,amtpassword:i.pass,amttls:1==i.tls?1:0};"string"==typeof i.ver&&(a.ver=i.ver),"number"==typeof i.pstate&&(a.state=i.pstate),"string"==typeof i.digestrealm&&(a.realm=i.digestrealm),"string"==typeof i.tlscerthash&&(a.hash=i.tlscerthash),meshserver.send(a),n++}}0==n&&setModalContent("xxAddAgent","Импорт учетной записи пользователя","Unable to import any device.")}else setModalContent("xxAddAgent","Импорт устройств Intel&reg; AMT","Invalid JSON file format.");showModal("xxAddAgentModal","idx_dlgOkButton")},e.readAsText(Q("d4importFile").files[0])}function p20editMeshAmt(){if(!xxdialogMode){var e="",t="";1048576&features&&(t="<option value=3>Простой режим управления администратора (ACM)</option>"),e+=addHtmlFormFloating("Тип",'<select id=dp20amtpolicy class="form-select" onchange=p20editMeshAmtChange()><option value=0>Политик нет</option><option value=1>Деактивировать</option><option value=2>Простой режим управления клиента (CCM)</option>'+t+"<option value=4>Полностью автоматический</option></select>"),setModalContent("xxAddAgent","Политика Intel&reg; AMT",e+="<div id=dp20amtpolicydiv></div>"),showModal("xxAddAgentModal","idx_dlgOkButton",p20editMeshAmtEx),currentMesh.amt&&(Q("dp20amtpolicy").value=currentMesh.amt.type),p20editMeshAmtChange(),!currentMesh.amt||2!=currentMesh.amt.type&&3!=currentMesh.amt.type||(Q("dp20amtpolicypass").value=currentMesh.amt.password,2!=currentMesh.amt.type&&3!=currentMesh.amt.type||(null!=currentMesh.amt.badpass&&(Q("dp20amtbadpass").value=currentMesh.amt.badpass),3==currentMesh.amt.type&&null!=currentMesh.amt.ccm&&(Q("dp20amtccmmode").value=currentMesh.amt.ccm)),1024&features||(Q("dp20amtcira").value=currentMesh.amt.cirasetup)),dp20amtValidatePolicy()}}function p20editMeshAmtChange(){var e=Q("dp20amtpolicy").value,t="";2!=e&&3!=e||(t+=addHtmlFormFloating("Пароль",'<select id=dp20amtpass class="form-select" onchange=dp20amtValidatePolicy() onkeyup=dp20amtValidatePolicy()><option value=0>Случайный пароль</option>'+(null!=currentMesh.amt&&1==currentMesh.amt.password?"<option value=1 selected>Сохранить существующий пароль</option>":"")+"<option value=2>Выберите новый пароль</option></select>"),t+="<div id=dp20amtpassdiv style=display:none>",t+=addHtmlFormFloating("Новый пароль*",'<input id=dp20amtpolicypass type=password class="form-control" maxlength=32 placeholder="New password*" onchange=dp20amtValidatePolicy() onkeyup=dp20amtValidatePolicy() autocomplete=off />'),t+=addHtmlFormFloating("Новый пароль*",'<input id=dp20amtpolicypass2 type=password class="form-control" maxlength=32 placeholder="New password*" onchange=dp20amtValidatePolicy() onkeyup=dp20amtValidatePolicy() autocomplete=off />'),t+="</div>",3==e&&(t+=addHtmlFormFloating("CCM режим",'<select id=dp20amtccmmode class="form-select" onchange=dp20amtValidatePolicy() onkeyup=dp20amtValidatePolicy()><option value=0>Не меняйте, оставьте CCM, если настроили</option><option value=1>Деактивировать CCM, если настроен</option><option value=2>Активировать в CCM, если ACM не работает</option></select>')),t+="<div id=dp20amtbadpassdiv style=display:none>",t+=addHtmlFormFloating("Неизвестный пароль",'<select id=dp20amtbadpass class="form-select"><option value=0>Ничего не делать</option><option value=1>Если в CCM, повторно активируйте Intel&reg; AMT</option></select>'),t+="</div>",1024&features||(t+=addHtmlFormFloating("Настройка CIRA",'<select id=dp20amtcira class="form-select" title="Клиент инициировал удаленный доступ"><option value=0>Ничего не делать</option><option value=1>Не подключайтесь к серверу</option><option value=2>Подключиться к серверу</option></select>')),t+='<span id=dp10passNotify style="font-size:10px"> * 8-16 символов, 1 верхний, 1 нижний, 1 числовой, 1 не буквенно-цифровой.</span>',2==currentMesh.mtype&&2==e&&(t+='<span style="font-size:10px"> Эта политика не повлияет на устройства с Intel&reg; AMT в режиме ACM.</span>'));0==e&&(t='<div class="row"><div class="col-2"><i class="fa-solid fa-times-circle text-danger" style="padding-right:8px; font-size:60px;"></i></div><div class="col-10">Когда выбрана эта политика, этот сервер не управляет Intel&reg; AMT. Intel AMT по-прежнему можно использовать, активировав и настроив его вручную.</div></div>'),1==e&&(t='<div class="row"><div class="col-2"><i class="fa-solid fa-times-circle text-danger" style="font-size:60px; padding-right:8px; color:green;"></i></div><div class="col-10">Когда выбрана эта политика, любой Intel&reg; AMT в режиме управления клиентом (CCM) будет деактивирован. Остальные устройства будут очищены от CIRA, и ими по-прежнему можно будет управлять вручную.</div></div>'),4==e&&(t='<div class="row"><div class="col-2"><i class="fa-solid fa-check-circle text-success" style="font-size:60px; padding-right:8px; color:blue;"></i></div><div class="col-10">Это рекомендуемая политика. Активация и управление Intel&reg; AMT полностью автоматизированы, и сервер пытается максимально использовать возможности управления оборудованием.</div></div>'),QH("dp20amtpolicydiv",t),setTimeout(dp20amtValidatePolicy,500)}function dp20amtValidatePolicy(){var e=!0,t=Q("dp20amtpolicy").value;if((2==t||3==t)&&2==Q("dp20amtpass").value){var n=Q("dp20amtpolicypass").value;e=n===Q("dp20amtpolicypass2").value&&passwordcheck(n)}QE("idx_dlgOkButton",e),2!=t&&3!=t||QV("dp20amtpassdiv",2==Q("dp20amtpass").value),QV("dp10passNotify",(2==t||3==t)&&2==Q("dp20amtpass").value),QV("dp20amtbadpassdiv",2==t||3==t&&1!=Q("dp20amtccmmode").value)}function p20editMeshAmtEx(){var e=parseInt(Q("dp20amtpolicy").value),t={type:e},n=null;2!=e&&3!=e||(0==Q("dp20amtpass").value&&(n=""),1==Q("dp20amtpass").value&&(n=null),2==Q("dp20amtpass").value&&(n=Q("dp20amtpolicypass").value)),2==e?(t={type:e,password:n,badpass:parseInt(Q("dp20amtbadpass").value)}).cirasetup=1024&features?1:parseInt(Q("dp20amtcira").value):3==e?(t={type:e,password:n,badpass:parseInt(Q("dp20amtbadpass").value),ccm:parseInt(Q("dp20amtccmmode").value)}).cirasetup=1024&features?1:parseInt(Q("dp20amtcira").value):4==e&&(t={type:e}),meshserver.send({action:"meshamtpolicy",meshid:currentMesh._id,amtpolicy:t})}function p20showDeleteMeshDialog(){if(xxdialogMode)return!1;var e=format('Вы действительно хотите удалить группу "{0}"? Удаление группы приведет к удалению всей информации связанной с устройствами в этой группе.',EscapeHtml(currentMesh.name))+"<br /><br />";return setModalContent("xxAddAgent","Удалить группу",e+='<label class=form-check-label><input id=p20check type=checkbox class="form-check-input m-2" onchange=p20validateDeleteMeshDialog() />Подтвердить</label>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showDeleteMeshDialogEx(3,"")}),p20validateDeleteMeshDialog(),!1}function p20validateDeleteMeshDialog(){QE("idx_dlgOkButton",Q("p20check").checked)}function p20showDeleteMeshDialogEx(e,t){meshserver.send({action:"deletemesh",meshid:currentMesh._id,meshname:currentMesh.name})}function p20editmeshrelay(){if(!xxdialogMode){var e=[];if(!(2&features))for(var t in nodes){var n=nodes[t];2==n.mtype&&null!=n.agent&&4294967295==GetNodeRights(n)&&e.push(n)}if(e.sort(nameSort),0==e.length)i="Нет доступных устройств-релеев.",setModalContent("xxAddAgent","Редактирование группы устройств","Нет доступных устройств-релеев."),showModal("xxAddAgentModal","idx_dlgOkButton");else{var o=[];for(var t in e)o.push('<option value="'+e[t]._id+'"'+(currentMesh.relayid==e[t]._id?" selected":"")+">"+EscapeHtml(e[t].name)+" ("+EscapeHtml(e[t].meshnamel)+")</option>");var i=addHtmlFormFloating("Устройство-релей",'<select id=d2devrelay class="form-select">'+o.join("")+"</select>");setModalContent("xxAddAgent","Редактирование группы устройств",i),showModal("xxAddAgentModal","idx_dlgOkButton",p20editmeshrelayEx)}}}function p20editmeshrelayEx(){meshserver.send({action:"editmesh",meshid:currentMesh._id,relayid:Q("d2devrelay").value})}function p20editmesh(e){if(!xxdialogMode){setModalContent("xxAddAgent","Редактирование группы устройств",'<div class="form-floating mb-2"><input type=text class="form-control" id=dp20meshname maxlength=128 placeholder="Имя" onchange=p20editmeshValidate() onkeyup=p20editmeshValidate(event) /><label for=dp20meshname>Имя</label></div><div class="form-floating mb-2"><textarea id=dp20meshdesc class="form-control" maxlength=1024 placeholder="Описание"></textarea><label for=dp20meshdesc>Описание</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",p20editmeshEx),Q("dp20meshname").value=currentMesh.name,currentMesh.desc&&(Q("dp20meshdesc").value=currentMesh.desc),p20editmeshValidate(),2==e?Q("dp20meshdesc").focus():Q("dp20meshname").focus()}}function p20editmeshEx(){meshserver.send({action:"editmesh",meshid:currentMesh._id,meshname:Q("dp20meshname").value,desc:Q("dp20meshdesc").value})}function p20editmeshValidate(e){QE("idx_dlgOkButton",Q("dp20meshname").value.length>0),e&&"Enter"==e.key&&Q("dp20meshdesc").focus()}function p20editmeshconsent(e){if(!xxdialogMode){var t="",n=0,o="";1==e&&(n=currentMesh.consent?currentMesh.consent:0,o="Редактировать согласие пользователя группы устройств"),2==e&&(n=currentUser.consent?currentUser.consent:0,o="Изменить согласие пользователя"),3==e&&(n=currentNode.consent?currentNode.consent:0,o="Изменить согласие пользователя устройства"),4==e&&(n=currentUserGroup.consent?currentUserGroup.consent:0,o="Изменить согласие пользователя группы пользователей"),t+='<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px"><b>Рабочий стол</b></div>',t+='<div><label for=d20flag1><input type=checkbox id=d20flag1 class="form-check-input me-2" '+(1&n?"checked":"")+">Уведомить пользователя</label></div>",t+='<div><label for=d20flag2><input type=checkbox id=d20flag2 class="form-check-input me-2" '+(8&n?"checked":"")+">Запрос согласия пользователя</label></div>",t+='<div><label for=d20flag7><input type=checkbox id=d20flag7 class="form-check-input me-2" '+(64&n?"checked":"")+">Показывать панель-уведомление</label></div>",t+='<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:8px"><b>Терминал</b></div>',t+='<div><label for=d20flag3><input type=checkbox id=d20flag3 class="form-check-input me-2" '+(2&n?"checked":"")+">Уведомить пользователя</label></div>",t+='<div><label for=d20flag4><input type=checkbox id=d20flag4 class="form-check-input me-2" '+(16&n?"checked":"")+">Запрос согласия пользователя</label></div>",t+='<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:8px"><b>Файлы</b></div>',t+='<div><label for=d20flag5><input type=checkbox id=d20flag5 class="form-check-input me-2" '+(4&n?"checked":"")+">Уведомить пользователя</label></div>",setModalContent("xxAddAgent",o,t+='<div><label for=d20flag6><input type=checkbox id=d20flag6 class="form-check-input me-2" '+(32&n?"checked":"")+">Запрос согласия пользователя</label></div>"),xxdialogButtons=3,xxdialogTag=e,showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20editmeshconsentEx(xxdialogButtons,xxdialogTag)}),serverinfo.consent&&(1&serverinfo.consent&&(Q("d20flag1").checked=!0),8&serverinfo.consent&&(Q("d20flag2").checked=!0),2&serverinfo.consent&&(Q("d20flag3").checked=!0),16&serverinfo.consent&&(Q("d20flag4").checked=!0),4&serverinfo.consent&&(Q("d20flag5").checked=!0),32&serverinfo.consent&&(Q("d20flag6").checked=!0),64&serverinfo.consent&&(Q("d20flag7").checked=!0),QE("d20flag1",!(1&serverinfo.consent)),QE("d20flag2",!(8&serverinfo.consent)),QE("d20flag3",!(2&serverinfo.consent)),QE("d20flag4",!(16&serverinfo.consent)),QE("d20flag5",!(4&serverinfo.consent)),QE("d20flag6",!(32&serverinfo.consent)),QE("d20flag7",!(64&serverinfo.consent)))}}function p20editmeshconsentEx(e,t){var n=0;Q("d20flag1").checked&&(n+=1),Q("d20flag2").checked&&(n+=8),Q("d20flag3").checked&&(n+=2),Q("d20flag4").checked&&(n+=16),Q("d20flag5").checked&&(n+=4),Q("d20flag6").checked&&(n+=32),Q("d20flag7").checked&&(n+=64),1==t&&meshserver.send({action:"editmesh",meshid:currentMesh._id,consent:n}),2==t&&meshserver.send({action:"edituser",id:currentUser._id,consent:n}),3==t&&meshserver.send({action:"changedevice",nodeid:currentNode._id,consent:n}),4==t&&meshserver.send({action:"editusergroup",ugrpid:currentUserGroup._id,consent:n})}function p20editmeshfeatures(){if(!xxdialogMode){var e=currentMesh.flags?currentMesh.flags:0,t="",n=0;"number"==typeof currentMesh.expireDevs&&currentMesh.expireDevs>0&&(n=currentMesh.expireDevs)>2e3&&(n=2e3),1==serverinfo.devGroupSessionRecording&&4!=currentMesh.mtype&&(t+='<div class="form-check"><label><input type=checkbox id=d20flag4 class="form-check-input me-2" onchange=p20editmeshfeaturesValidate() '+(4&e?"checked":"")+">Запись сеансов</label><br></div>"),2!=currentMesh.mtype&&4!=currentMesh.mtype||(t+='<div class="form-check"><label><input type=checkbox id=d20flag2 class="form-check-input me-2" onchange=p20editmeshfeaturesValidate() '+(2&e?"checked":"")+">"+(4==currentMesh.mtype?"Синхронизировать имя устройства сервера с именем порта":"Синхронизировать имя устройства на сервере с именем хоста")+"</label><br></div>",2==currentMesh.mtype&&(t+='<div style="margin-left:12px"><label><input type=checkbox id=d20flag8 class="form-check-input me-2" onchange=p20editmeshfeaturesValidate() '+(8&e?"checked":"")+">Prefer value of --agentName</label><br></div>",t+='<div style="margin-left:12px"><label><input type=checkbox id=d20flag16 class="form-check-input me-2" onchange=p20editmeshfeaturesValidate() '+(16&e?"checked":"")+">Allow to override server device name until next connection</label><br></div>"),t+='<div class="form-check"><label><input type=checkbox id=d20flag1 class="form-check-input me-2" onchange=p20editmeshfeaturesValidate() '+(1&e?"checked":"")+">Удалять устройства при отключении</label><br></div>"),t+='<div class="form-check"><label><input type=checkbox id=d20expireDevice class="form-check-input me-2" onchange=p20editmeshfeaturesValidate() '+(n>0?"checked":"")+">Автоматически удалять неактивные устройства</label><br></div>",t+='<div style=margin-left:20px id=d20expireDeviceDev>Кол-во дней без активности до удаления: <label><input type=number inputmode=numeric class="form-control" onchange=p20editmeshfeaturesValidate() onkeyup=p20editmeshfeaturesValidate() onpaste=p20editmeshfeaturesValidate() onkeydown=p20editmeshfeaturesValidate() maxlength=4 min=1 max=2000 style=width:80px value="'+(0==n?30:n)+'" id=d20expireDeviceDays></label><br></div>',serverinfo.autoremoveinactivedevices&&(1==serverinfo.autoremoveinactivedevices?t+=format("<span style=font-size:x-small;margin-left:6px>По умолчанию неактивные устройства удаляются через 1 день.</span>",serverinfo.autoremoveinactivedevices):t+=format("<span style=font-size:x-small;margin-left:6px>По умолчанию неактивные устройства удаляются через {0} дн.</span>",serverinfo.autoremoveinactivedevices)),setModalContent("xxAddAgent","Редактировать функции группы устройств",t),showModal("xxAddAgentModal","idx_dlgOkButton",p20editmeshfeaturesEx),p20editmeshfeaturesValidate()}}function p20editmeshfeaturesValidate(){var e=0,t=!0;if(2!=currentMesh.mtype&&4!=currentMesh.mtype||!Q("d20flag1").checked||(e+=1),2==currentMesh.mtype){Q("d20flag2").checked&&(e+=2,"d20flag2"==event.currentTarget.id&&(Q("d20flag8").checked=!0,Q("d20flag16").checked=!0));for(const t of[8,16]){const n=Q("d20flag"+t);(n.checked=n.checked&&!(n.disabled=!(2&e)))&&(e+=t)}}QE("d20expireDevice",!(1&e));var n=!(1&e)&&Q("d20expireDevice").checked;if(QV("d20expireDeviceDev",n),n){var o=parseInt(Q("d20expireDeviceDays").value);(isNaN(o)||o<1||o>2e3||o!=Q("d20expireDeviceDays").value)&&(t=!1)}QE("idx_dlgOkButton",t)}function p20editmeshfeaturesEx(){var e=0;2!=currentMesh.mtype&&4!=currentMesh.mtype||(Q("d20flag1").checked&&(e+=1),Q("d20flag2").checked&&(e+=2),Q("d20flag8").checked&&(e+=8),Q("d20flag16").checked&&(e+=16)),1==serverinfo.devGroupSessionRecording&&4!=currentMesh.mtype&&Q("d20flag4").checked&&(e+=4);var t=0;1&e||!Q("d20expireDevice").checked||(t=parseInt(Q("d20expireDeviceDays").value)),meshserver.send({action:"editmesh",meshid:currentMesh._id,flags:e,expireDevs:t})}function p20showAddMeshUserDialog(e,t){if(xxdialogMode)return!1;var n="";if(null==e||5==e)null==t&&(n+=null==e?"Разрешить пользователям управлять этой группой и устройствами этой группы.":"Разрешить пользователям управлять этим устройством.",524288&features&&(n+=" Для добавления в группу устройств, пользователь должен зайти на сервер хотя бы один раз."),n+="<br /><br />"),n+="<div style='position:relative'>",n+=addHtmlFormFloating("Идентификаторы пользователей",'<input id=dp20username maxlength=256 onchange=p20validateAddMeshUserDialog() onkeyup=p20validateAddMeshUserDialog() placeholder="user1, user2, user3" class="form-control" />'),n+="<div id=dp20usersuggest class=suggestionBox style='top:30px;left:130px;display:none'></div>",n+="</div><br>";else if(1==e){var o="";if(null==t){var i=getOrderedList(meshes,"name");for(var a in i)null!=currentUser.links&&null!=currentUser.links[i[a]._id]||(o+="<option value="+encodeURIComponentEx(i[a]._id)+">"+EscapeHtml(i[a].name)+"</option>")}else o+="<option value="+t+">"+EscapeHtml(meshes[decodeURIComponent(t)].name)+"</option>";n+=addHtmlFormFloating("Группа устройств","<select onchange=p20validateAddMeshUserDialog() id=dp2groupid class=form-select"+(t?" disabled":"")+">"+o+"</select>")}else if(2==e){if(null==usergroups)return;o="";var s=getOrderedList(usergroups,"name");for(var a in s)currentMesh._id.split("/")[1]==s[a]._id.split("/")[1]&&(null!=currentMesh.links&&null!=currentMesh.links[s[a]._id]||(o+="<option value="+encodeURIComponentEx(s[a]._id)+">"+EscapeHtml(s[a].name)+"</option>"));n+=addHtmlFormFloating("Группа пользователей",'<select onchange=p20validateAddMeshUserDialog() id=dp2groupid class="form-select">'+o+"</select>")}else if(6==e){if(null==usergroups)return;o="";if(null==t){s=getOrderedList(usergroups,"name");for(var a in s)null==s[a].membershipType&&currentNode._id.split("/")[1]==s[a]._id.split("/")[1]&&(null!=currentNode.links&&null!=currentNode.links[s[a]._id]||(o+="<option value="+encodeURIComponentEx(s[a]._id)+">"+EscapeHtml(s[a].name)+"</option>"))}else o+="<option value="+t+">"+EscapeHtml(usergroups[decodeURIComponent(t)].name)+"</option>";n+=addHtmlFormFloating("Группа пользователей","<select onchange=p20validateAddMeshUserDialog() id=dp2groupid "+(t?" disabled":"")+' class="form-select">'+o+"</select>")}else if(3==e){o="";t&&(t=decodeURIComponent(t));i=getOrderedList(meshes,"name");for(var a in i)null==t&&null!=currentUserGroup.links&&null!=currentUserGroup.links[i[a]._id]||(o+="<option value="+encodeURIComponentEx(i[a]._id)+(t==i[a]._id?" selected":" ")+">"+EscapeHtml(i[a].name)+"</option>");n+=addHtmlFormFloating("Группа устройств","<select onchange=p20validateAddMeshUserDialog("+e+') id=dp2groupid class="form-select">'+o+"</select>")}else if(4==e||7==e){o="";var r=null,l=null;null!=t&&null!=(l=getNodeFromId(decodeURIComponent(t)))&&(r=l.meshid);i=getOrderedList(meshes,"name");for(var a in i)null!=i[a].links[userinfo._id]&&7&i[a].links[userinfo._id].rights&&(null==r&&(r=i[a]._id),o+="<option value="+encodeURIComponentEx(i[a]._id)+(r==i[a]._id?" selected":" ")+">"+EscapeHtml(i[a].name)+"</option>");n+=addHtmlFormFloating("Группа устройств","<select onchange=p20changeMeshAddMeshUserDialog("+e+') id=dp2meshid class="form-select">'+o+"</select>"),o="";var d=getOrderedList(nodes,"name");for(var a in d)d[a].meshid==r&&(o+="<option value="+encodeURIComponentEx(d[a]._id)+(l==d[a]?" selected":" ")+">"+EscapeHtml(d[a].name)+"</option>");n+=addHtmlFormFloating("Устройство","<select onchange=p20validateAddMeshUserDialog("+e+') id=dp2nodeid class="form-select">'+o+"</select>")}else{var c=(e=decodeURIComponent(e)).split("/")[2];users&&users[e]&&(c=users[e].name),usergroups&&usergroups[e]&&(c=usergroups[e].name),userinfo._id==e&&(c=userinfo.name),e.startsWith("ugrp/")?n+=format("Права на группу для {0}.",c)+"<br /><br />":n+=format("Права на группу для пользователя {0}.",c)+"<br /><br />"}var u=-1,p=4!=e&&5!=e&&6!=e&&7!=e;if(n+='<div style="height:120px;overflow-y:scroll;border:1px solid var(--sub-menu-color);resize:vertical;padding:8px;border-radius:0.375rem;">',p&&(n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20fulladmin>Администратор с полным доступом</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20editmesh>Редактирование группы устройств</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20manageusers>Управление пользователями группы устройств</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20managecomputers>Управление компьютерами группы устройств</label><br>'),n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20remotecontrol>Remote Control & Relay</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20remoteview style=margin-left:12px>Только просмотр экрана без ввода</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20remotelimitedinput style=margin-left:12px>Ограничить элементы ввода</label><br>',!1!==serverinfo.guestdevicesharing&&(n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20guestshare style=margin-left:12px>Делиться с гостями</label><br>'),n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20nodesktop style=margin-left:12px>Нет доступа к рабочему столу</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20noterminal style=margin-left:12px>Нет доступа к терминалу</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20nofiles style=margin-left:12px>Нет доступа к файлам</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20noamt style=margin-left:12px>Нет доступа к Intel&reg; AMT</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20meshagentconsole>Консоль Mesh Agent</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20meshserverfiles>Серверные файлы</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20wakedevices>Разбудить устройства</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20editnotes>Редактировать примечания устройства</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20limitevents>Показывать только собственные события</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20chatnotify>Чаты и уведомления</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20uninstall>Удалить агент / Удалить устройство</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20commands>Удаленные команды</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20resetoff>Перезагрузка / Выключение</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20details>Детали устройства</label><br>',n+='<label><input type=checkbox class="form-check-input me-2" onchange=p20validateAddMeshUserDialog() id=p20relay>Use as Relay</label><br>',n+="</div>",null==e)xxdialogButtons=3,xxdialogTag="",setModalContent("xxAddAgent","Добавить пользователей в группу устройств",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),QE("p20fulladmin",4294967295==GetMeshRights(currentMesh)),Q("dp20username").focus();else if(1===e)xxdialogButtons=t?7:3,xxdialogTag=e,setModalContent("xxAddAgent",null==t?"Добавить разрешения группы устройств":"Редактировать права группы устройств",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),null!=t&&(u=meshes[decodeURIComponent(t)].links[currentUser._id].rights),4294967295==u&&(Q("p20fulladmin").checked=!0,u=-1);else if(2===e)xxdialogButtons=3,xxdialogTag=e,setModalContent("xxAddAgent","Добавить группу пользователей",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),QE("p20fulladmin",4294967295==GetMeshRights(currentMesh));else if(3===e)xxdialogButtons=t?7:3,xxdialogTag=e,setModalContent("xxAddAgent",null==t?"Добавить группу устройств":"Редактирование группы устройств",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),QE("dp2groupid",null==t),null!=t&&(u=currentUserGroup.links[decodeURIComponent(t)].rights),4294967295==u&&(Q("p20fulladmin").checked=!0,u=-1);else if(4===e)xxdialogButtons=t?7:3,xxdialogTag=e,setModalContent("xxAddAgent",null==t?"Добавить разрешения для устройства":"Изменить разрешения устройства",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),QE("dp2meshid",null==t),QE("dp2nodeid",null==t);else if(7===e)xxdialogButtons=t?7:3,xxdialogTag=e,setModalContent("xxAddAgent",null==t?"Добавить разрешения для устройства":"Изменить разрешения устройства",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),QE("dp2meshid",null==t),QE("dp2nodeid",null==t),null!=t&&(u=currentUserGroup.links[decodeURIComponent(t)].rights,QE("dp20username",!1));else if(5===e)xxdialogButtons=t?7:3,xxdialogTag=e,setModalContent("xxAddAgent",t?"Изменить разрешения для пользовательских устройств":"Добавить разрешения для пользовательских устройств",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),null!=t&&(t=decodeURIComponent(t),null!=users&&null!=users[t]?Q("dp20username").value=users[t].name:Q("dp20username").value=t.split("/")[2],u=currentNode.links[t].rights,QE("dp20username",!1)),Q("dp20username").focus();else if(6===e)xxdialogButtons=t?7:3,xxdialogTag=e,setModalContent("xxAddAgent",t?"Изменить права доступа к устройствам группы пользователей":"Добавить разрешения для устройств группы пользователей",n),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)}),null!=t&&(u=currentNode.links[decodeURIComponent(t)].rights);else{e.startsWith("ugrp/")?(xxdialogButtons=7,xxdialogTag=e,setModalContent("xxAddAgent","Редактировать права группы устройств",n)):(xxdialogButtons=7,xxdialogTag=e,setModalContent("xxAddAgent","Редактировать права пользователя для группы устройств",n)),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p20showAddMeshUserDialogEx(xxdialogButtons,xxdialogTag)});GetMeshRights(currentMesh);4294967295==(u=GetMeshRights(currentMesh,e))&&(Q("p20fulladmin").checked=!0,u=-1),QE("p20fulladmin",4294967295==GetMeshRights(currentMesh))}return-1!=u&&(p&&(1&u&&(Q("p20editmesh").checked=!0),2&u&&(Q("p20manageusers").checked=!0),4&u&&(Q("p20managecomputers").checked=!0)),8&u&&(Q("p20remotecontrol").checked=!0,65536&u&&(Q("p20nodesktop").checked=!0),256&u&&(Q("p20remoteview").checked=!0),524288&u&&!1!==serverinfo.guestdevicesharing&&(Q("p20guestshare").checked=!0),512&u&&(Q("p20noterminal").checked=!0),1024&u&&(Q("p20nofiles").checked=!0),2048&u&&(Q("p20noamt").checked=!0),4096&u&&(Q("p20remotelimitedinput").checked=!0)),16&u&&(Q("p20meshagentconsole").checked=!0),32&u&&(Q("p20meshserverfiles").checked=!0),64&u&&(Q("p20wakedevices").checked=!0),128&u&&(Q("p20editnotes").checked=!0),8192&u&&(Q("p20limitevents").checked=!0),16384&u&&(Q("p20chatnotify").checked=!0),32768&u&&(Q("p20uninstall").checked=!0),131072&u&&(Q("p20commands").checked=!0),262144&u&&(Q("p20resetoff").checked=!0),524288&u&&!1!==serverinfo.guestdevicesharing&&(Q("p20guestshare").checked=!0),1048576&u&&(Q("p20details").checked=!0),2097152&u&&(Q("p20relay").checked=!0)),p20validateAddMeshUserDialog(e),!1}function p20changeMeshAddMeshUserDialog(e){var t="",n=decodeURIComponent(Q("dp2meshid").value);for(var o in nodes)nodes[o].meshid==n&&(t+="<option value="+encodeURIComponentEx(nodes[o]._id)+">"+EscapeHtml(nodes[o].name)+"</option>");QH("dp2nodeid",t),p20validateAddMeshUserDialog(e)}function p20setname(e){e=decodeURIComponent(e);var t=Q("dp20username").value.split(",");for(var n in t)t[n]=t[n].trim();return t[t.length-1]=e,Q("dp20username").value=t.join(", "),p20validateAddMeshUserDialog(),!1}function p20validateAddMeshUserDialog(e){var t,n=!0;if(4===e){var o=0,i=decodeURIComponent(Q("dp2nodeid").value);""!=i&&null!=currentUser.links&&null!=currentUser.links[i]&&(o=currentUser.links[i].rights),Q("p20remotecontrol").checked=!!(8&o),Q("p20meshagentconsole").checked=!!(16&o),Q("p20meshserverfiles").checked=!!(32&o),Q("p20wakedevices").checked=!!(64&o),Q("p20editnotes").checked=!!(128&o),Q("p20remoteview").checked=!!(256&o),Q("p20noterminal").checked=!!(512&o),Q("p20nofiles").checked=!!(1024&o),Q("p20noamt").checked=!!(2048&o),Q("p20remotelimitedinput").checked=!!(4096&o),Q("p20limitevents").checked=!!(8192&o),Q("p20chatnotify").checked=!!(16384&o),Q("p20uninstall").checked=!!(32768&o),Q("p20nodesktop").checked=!!(65536&o),Q("p20commands").checked=!!(131072&o),Q("p20resetoff").checked=!!(262144&o),!1!==serverinfo.guestdevicesharing&&(Q("p20guestshare").checked=!!(524288&o)),Q("p20details").checked=!!(1048576&o),Q("p20relay").checked=!!(2097152&o),n=""!=i}if(Q("dp20username")){var a=Q("dp20username").value.split(",");for(var s in a){var r=a[s]=a[s].trim();(0==r.length||r.indexOf('"')>=0)&&(n=!1)}var l=!1,d=!1;if(null!=users){var c=a[a.length-1].trim(),u=c.toLowerCase(),p=[];if(c.length>0){for(var s in users){var m=users[s]._id.split("/");if((null==currentMesh||currentMesh.domain==m[1])&&(null==currentNode||currentNode.domain==m[1])){if(m[2]===u){d=!0;break}if(users[s].name.toLowerCase().indexOf(u)>=0&&(p.push([users[s]._id,users[s].name]),p.length>=8))break}}if(0==d&&p.length>0){var g="";for(var s in p){var v=p[s][0],h=p[s][1];v.split("/")[2]==h.toLowerCase()?g+="<div class=suggestionBoxItem onclick='p20setname(\""+encodeURIComponentEx(v.split("/")[2])+"\")'>"+EscapeHtml(h)+"</div>":g+="<div class=suggestionBoxItem onclick='p20setname(\""+encodeURIComponentEx(v.split("/")[2])+"\")'><div>"+EscapeHtml(h)+"</div><div class=suggestionBoxSubItem>"+EscapeHtml(v.split("/")[2])+"</div></div>"}QH("dp20usersuggest",g),l=!0}}}QV("dp20usersuggest",l)}QE("idx_dlgOkButton",n),null!=Q("p20fulladmin")?(t=!Q("p20fulladmin").checked,QE("p20editmesh",t),QE("p20manageusers",t),QE("p20managecomputers",t)):t=""!=i,QE("p20remotecontrol",t),QE("p20meshagentconsole",t),QE("p20meshserverfiles",t),QE("p20wakedevices",t),QE("p20editnotes",t),QE("p20limitevents",t),QE("p20remoteview",t&&Q("p20remotecontrol").checked),!1!==serverinfo.guestdevicesharing&&QE("p20guestshare",t&&Q("p20remotecontrol").checked&&(Q("p20remoteview").checked||!Q("p20remotelimitedinput").checked)),QE("p20remotelimitedinput",t&&Q("p20remotecontrol").checked&&!Q("p20remoteview").checked),QE("p20nodesktop",t&&Q("p20remotecontrol").checked),QE("p20noterminal",t&&Q("p20remotecontrol").checked),QE("p20nofiles",t&&Q("p20remotecontrol").checked),QE("p20noamt",t&&Q("p20remotecontrol").checked),QE("p20chatnotify",t),QE("p20uninstall",t),QE("p20commands",t),QE("p20resetoff",t),QE("p20details",t),QE("p20relay",t)}function p20showAddMeshUserDialogEx(e,t){var n=0;if(null!=Q("p20fulladmin")&&1==Q("p20fulladmin").checked?n=4294967295:(null!=Q("p20fulladmin")&&(1==Q("p20editmesh").checked&&(n+=1),1==Q("p20manageusers").checked&&(n+=2),1==Q("p20managecomputers").checked&&(n+=4)),1==Q("p20remotecontrol").checked&&(n+=8),1==Q("p20meshagentconsole").checked&&(n+=16),1==Q("p20meshserverfiles").checked&&(n+=32),1==Q("p20wakedevices").checked&&(n+=64),1==Q("p20editnotes").checked&&(n+=128),1==Q("p20remoteview").checked&&(n+=256),1==Q("p20nodesktop").checked&&(n+=65536),1==Q("p20noterminal").checked&&(n+=512),1==Q("p20nofiles").checked&&(n+=1024),1==Q("p20noamt").checked&&(n+=2048),1!=Q("p20remotelimitedinput").checked||Q("p20remoteview").checked||(n+=4096),1==Q("p20limitevents").checked&&(n+=8192),1==Q("p20chatnotify").checked&&(n+=16384),1==Q("p20uninstall").checked&&(n+=32768),1==Q("p20commands").checked&&(n+=131072),1==Q("p20resetoff").checked&&(n+=262144),!1===serverinfo.guestdevicesharing||1!=Q("p20guestshare").checked||!Q("p20remoteview").checked&&(Q("p20remoteview").checked||Q("p20remotelimitedinput").checked)||(n+=524288),1==Q("p20details").checked&&(n+=1048576),1==Q("p20relay").checked&&(n+=2097152)),8&n||(256&n&&(n-=256),512&n&&(n-=512),1024&n&&(n-=1024),2048&n&&(n-=2048),4096&n&&(n-=4096),65536&n&&(n-=65536)),1===t){var o=decodeURIComponent(Q("dp2groupid").value);null!=(a=meshes[o])&&meshserver.send({action:"addmeshuser",meshid:o,meshname:a.name,userids:[currentUser._id],meshadmin:n,remove:2==e})}else if(2===t){var i=decodeURIComponent(Q("dp2groupid").value);null!=(a=meshes[currentMesh._id])&&meshserver.send({action:"addmeshuser",meshid:currentMesh._id,meshname:currentMesh.name,userid:i,meshadmin:n,remove:2==e})}else if(3===t){var a;o=decodeURIComponent(Q("dp2groupid").value);null!=(a=meshes[o])&&meshserver.send({action:"addmeshuser",meshid:o,meshname:a.name,userids:[currentUserGroup._id],meshadmin:n,remove:2==e})}else if(4===t){null!=(c=getNodeFromId(d=decodeURIComponent(Q("dp2nodeid").value)))&&meshserver.send({action:"adddeviceuser",nodeid:d,nodename:c.name,userids:[currentUser._id],rights:n,remove:2==e})}else if(5===t){var s=Q("dp20username").value.split(","),r=[];for(var l in s)r.push(s[l].trim());meshserver.send({action:"adddeviceuser",nodeid:currentNode._id,nodename:currentNode.name,usernames:r,rights:n,remove:2==e})}else if(6===t){i=decodeURIComponent(Q("dp2groupid").value);null!=currentNode&&meshserver.send({action:"adddeviceuser",nodeid:currentNode._id,nodename:currentNode.name,userids:[i],rights:n,remove:2==e})}else if(7===t){var d,c;null!=(c=getNodeFromId(d=decodeURIComponent(Q("dp2nodeid").value)))&&meshserver.send({action:"adddeviceuser",nodeid:d,nodename:c.name,userids:[currentUserGroup._id],rights:n,remove:2==e})}else if(null==t){s=Q("dp20username").value.split(","),r=[];for(var l in s)r.push(s[l].trim());meshserver.send({action:"addmeshuser",meshid:currentMesh._id,meshname:currentMesh.name,usernames:r,meshadmin:n,remove:2==e})}else meshserver.send({action:"addmeshuser",meshid:currentMesh._id,meshname:currentMesh.name,userids:[t],meshadmin:n,remove:2==e})}function p20viewuser(e){if(!xxdialogMode){var t=decodeURIComponent(e),n=GetMeshRights(currentMesh),o=GetMeshRights(currentMesh,t);if(userinfo._id!=t&&(4294967295==n||2&n&&4294967295!=o))p20showAddMeshUserDialog(e);else{var i=[];4294967295==o?i.push("Администратор с полным доступом (все права)"):(1&o&&i.push("Редактирование группы устройств"),2&o&&i.push("Управление пользователями группы устройств"),4&o&&i.push("Управление компьютерами группы устройств"),8&o&&i.push("Удаленное управление"),16&o&&i.push("Консоль агента"),32&o&&i.push("Серверные файлы"),64&o&&i.push("Разбудить устройства"),128&o&&i.push("Редактировать примечания"),8&o&&256&o&&i.push("Только просмотр экрана без ввода"),8&o&&65536&o&&i.push("Нет рабочего стола"),8&o&&512&o&&i.push("Нет терминала"),8&o&&1024&o&&i.push("Файлов нет"),8&o&&2048&o&&i.push("Нет доступа к Intel&reg; AMT"),8&o&&4096&o&&!(256&o)&&i.push("Ограниченный ввод"),8192&o&&i.push("Только собственные события"),16384&o&&i.push("Чаты и уведомления"),32768&o&&i.push("Удаление"),131072&o&&i.push("Команды"),262144&o&&i.push("Сброс / Выкл."),524288&o&&i.push("Совместное использование"),1048576&o&&i.push("Детали"),2097152&o&&i.push("Ретранслятор")),0==i.length&&i.push("Нет прав");var a=t.split("/")[2];users&&users[t]&&(a=users[t].name),userinfo._id==t&&(a=userinfo.name);var s=1,r=addHtmlValue("Имя пользователя",EscapeHtml(decodeURIComponent(a)));t.split("/")[2]!=a&&(r+=addHtmlValue("Идентификатор пользователя",EscapeHtml(t.split("/")[2]))),r+=addHtmlValue("Права",i.join(", ")),userinfo._id!=t&&(4294967295==n||2&n&&4294967295!=o)&&(s+=4),setModalContent("xxAddAgent","Пользователь группы устройств",r),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p20viewuserEx(s,t))}}}function p20viewuserEx(e,t){if(2==e){var n=t.split("/")[2];users&&users[t]&&(n=users[t].name),usergroups&&usergroups[t]&&(n=usergroups[t].name),userinfo._id==t&&(n=userinfo.name),t.startsWith("user/")&&setModalContent("xxAddAgent","Удалить разрешения пользователя",format('Подтвердить удаление прав для пользователя "{0}"?',EscapeHtml(decodeURIComponent(n)))),t.startsWith("ugrp/")&&setModalContent("xxAddAgent","Удалить разрешения группы пользователей",format('Подтвердите удаление прав для группы пользователей "{0}"?',EscapeHtml(decodeURIComponent(n))),t),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p20viewuserEx2(3,t))}}function p20deleteUser(e,t){return haltEvent(e),p20viewuserEx(2,decodeURIComponent(t)),!1}function p20viewuserEx2(e,t){meshserver.send({action:"removemeshuser",meshid:currentMesh._id,meshname:currentMesh.name,userid:t})}function p20editmeshInviteCode(){if(xxdialogMode)return!1;var e,t=GetMeshRights(currentMesh),n=serverinfo.name;((-1==n.indexOf(".")||2&features)&&(n=window.location.hostname),1==serverinfo.https)?e="https://"+n+(443==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"invite"+(urlargs.key?"?key="+urlargs.key:""):e="http://"+n+(80==serverinfo.port?"":":"+serverinfo.port)+domainUrl+"invite"+(urlargs.key?"?key="+urlargs.key:"");if(1&t){var o="Когда этот параметр включен, коды приглашений могут использоваться любым пользователем для присоединения устройств к этой группе устройств по следующей общедоступной ссылке:<br /><br />";o+='<div style=width:100%;text-align:center><a rel="noreferrer noopener" target=_blank href="'+e+'">'+e+"</a></div><br />",o+='<div style=margin-bottom:5px><label><input id=agentJoinCheck type=checkbox class="form-check-input me-2" onclick=p20editmeshInviteCodeValidate() />Включить коды приглашения</label></div>',o+=addHtmlFormFloating("Пригласительные коды",'<input id=agentInviteCode class="form-control" onkeyup=p20editmeshInviteCodeValidate() placeholder="code1, code2, code3" />'),o+=addHtmlFormFloating("Агенты",'<select id=agentType class="form-select" onchange=p20editmeshInviteCodeValidate()><option value=0>Все доступные агенты</option><option value=1>MeshAgent для Windows </option><option value=2>MeshAgent для Linux</option><option value=4>MeshAgent для MacOS</option><option value=8>MeshCentral Ассистент</option></select>'),o+="<div id=d2agentInstallTypeDiv>",o+=addHtmlFormFloating("Тип установки",'<select id=agentInviteType class="form-select"><option value=0>Фоновый и интерактивный</option><option value=2>Только фоновый</option><option value=1>Только интерактивный режим</option></select>'),setModalContent("xxAddAgent","Пригласительные коды",o+="</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",p20editmeshInviteCodeEx),null!=currentMesh.invite&&(Q("agentJoinCheck").checked=!0,Q("agentInviteCode").value=currentMesh.invite.codes.join(", "),currentMesh.invite.ag&&(Q("agentType").value=currentMesh.invite.ag),Q("agentInviteType").value=3&currentMesh.invite.flags),p20editmeshInviteCodeValidate()}else{o="Коды приглашений могут использоваться любым пользователем для присоединения устройств к этой группе устройств по следующей общедоступной ссылке:<br /><br />";o+='<div style=width:100%;text-align:center><a rel="noreferrer noopener" target=_blank href="'+e+'">'+e+"</a></div><br />",o+=addHtmlValue("Пригласительные коды",currentMesh.invite.codes.join(", ")),setModalContent("xxAddAgent","Пригласительные коды",o+=addHtmlValue("Тип установки",["Фоновый и интерактивный","Только интерактивный режим","Только фоновый"][3&currentMesh.invite.flags])),showModal("xxAddAgentModal","idx_dlgOkButton")}}function p20editmeshInviteCodeValidate(){var e=!0,t=Q("agentInviteCode").value.split(",");for(var n in t)t[n]=t[n].trim(),""==t[n]&&(e=!1);QE("agentInviteCode",Q("agentJoinCheck").checked),QE("agentType",Q("agentJoinCheck").checked),QE("agentInviteType",Q("agentJoinCheck").checked),QE("idx_dlgOkButton",0==Q("agentJoinCheck").checked||e),QV("d2agentInstallTypeDiv",parseInt(Q("agentType").value)<2)}function p20editmeshInviteCodeEx(){if(1==Q("agentJoinCheck").checked){var e=Q("agentInviteCode").value.split(",");for(var t in e)e[t]=e[t].trim();meshserver.send({action:"editmesh",meshid:currentMesh._id,invite:{codes:e,flags:parseInt(Q("agentInviteType").value),ag:parseInt(Q("agentType").value)}})}else meshserver.send({action:"editmesh",meshid:currentMesh._id,invite:"*"})}function p20editMeshNotify(){if(xxdialogMode)return!1;var e=0,t=16384&features2&&userinfo.emailVerified;userinfo.links&&userinfo.links[currentMesh._id]&&userinfo.links[currentMesh._id].notify&&(e|=userinfo.links[currentMesh._id].notify),userinfo.notify&&userinfo.notify[currentMesh._id]&&(e|=userinfo.notify[currentMesh._id]);var n='<div style="border-bottom: 1px solid #888;margin-bottom:3px">Веб Push-уведомления</div>';return n+='<div class="form-check"><label><input id=p20notifyIntelDeviceConnect class="form-check-input me-2" type=checkbox />Подключения устройств</label></div>',n+='<div class="form-check"><label><input id=p20notifyIntelDeviceDisconnect class="form-check-input me-2" type=checkbox />Отключения устройств</label></div>',currentMesh.mtype<3&&(n+='<div class="form-check"><label><input id=p20notifyIntelAmtKvmActions class="form-check-input me-2" type=checkbox />События Intel&reg; AMT desktop или serial</label></div>'),t&&(n+='<br /><div style="border-bottom: 1px solid #888;margin-bottom:3px">Уведомления по электронной почте</div>',n+='<div class="form-check"><label><input id=p20enotifyIntelDeviceConnect class="form-check-input me-2" type=checkbox />Подключения устройств</label></div>',n+='<div class="form-check"><label><input id=p20enotifyIntelDeviceDisconnect class="form-check-input me-2" type=checkbox />Отключения устройств</label></div>',n+='<div class="form-check"><label><input id=p20enotifyIntelDeviceHelp class="form-check-input me-2" type=checkbox />Help requests</label></div>'),null!=userinfo.msghandle&&33554432&features2&&(n+='<br /><div style="border-bottom: 1px solid #888;margin-bottom:3px">Messaging Notifications</div>',n+='<div class="form-check"><label><input id=p20emsgDeviceConnect class="form-check-input me-2" type=checkbox />Подключения устройств</label></div>',n+='<div class="form-check"><label><input id=p20emsgDeviceDisconnect class="form-check-input me-2" type=checkbox />Отключения устройств</label></div>',n+='<div class="form-check"><label><input id=p20emsgDeviceHelp class="form-check-input me-2" type=checkbox />Help requests</label></div>'),setModalContent("xxAddAgent","Настройки уведомлений",n),showModal("xxAddAgentModal","idx_dlgOkButton",p20editMeshNotifyEx),Q("p20notifyIntelDeviceConnect").checked=2&e,Q("p20notifyIntelDeviceDisconnect").checked=4&e,currentMesh.mtype<3&&(Q("p20notifyIntelAmtKvmActions").checked=8&e),t&&(Q("p20enotifyIntelDeviceConnect").checked=16&e,Q("p20enotifyIntelDeviceDisconnect").checked=32&e,Q("p20enotifyIntelDeviceHelp").checked=64&e),null!=userinfo.msghandle&&33554432&features2&&(Q("p20emsgDeviceConnect").checked=128&e,Q("p20emsgDeviceDisconnect").checked=256&e,Q("p20emsgDeviceHelp").checked=512&e),!1}function p20editMeshNotifyEx(e,t){var n=0;n+=Q("p20notifyIntelDeviceConnect").checked?2:0,n+=Q("p20notifyIntelDeviceDisconnect").checked?4:0,currentMesh.mtype<3&&(n+=Q("p20notifyIntelAmtKvmActions").checked?8:0),t&&(n+=Q("p20enotifyIntelDeviceConnect").checked?16:0,n+=Q("p20enotifyIntelDeviceDisconnect").checked?32:0,n+=Q("p20enotifyIntelDeviceHelp").checked?64:0),null!=userinfo.msghandle&&33554432&features2&&(n+=Q("p20emsgDeviceConnect").checked?128:0,n+=Q("p20emsgDeviceDisconnect").checked?256:0,n+=Q("p20emsgDeviceHelp").checked?512:0),meshserver.send({action:"changemeshnotify",meshid:currentMesh._id,notify:n})}function setupMeshSummaryStats(){window.meshPowerChart=new Chart(document.getElementById("meshPowerChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#20F","#40D","#60B","#809","#A07","#C05"]}]},options:{shadowColor:"blue",responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},layout:{padding:{left:10,right:10,top:10,bottom:10}}}}),window.meshOsChart=new Chart(document.getElementById("meshOsChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#20F","#30E","#40D","#50C","#60B","#70A","#809","#908","#A07","#B06","#C05"]}]},options:{responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},layout:{padding:{left:10,right:10,top:10,bottom:10}}}}),window.meshConnChart=new Chart(document.getElementById("meshConnChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#20F","#40D","#60B","#809","#A07","#C05"]}],labels:["Не подключен","Агент","Intel&reg; AMT","Агент + Intel&reg; AMT"]},options:{responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},layout:{padding:{left:10,right:10,top:10,bottom:10}}}}),window.meshSecurityChart=new Chart(document.getElementById("meshSecurityChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#20F","#40D","#60B","#809","#A07","#C05"]}],labels:["OK","Антивирус не активен","Без автоматического обновления","Брандмауэр не активен","Множественные проблемы"]},options:{responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},layout:{padding:{left:10,right:10,top:10,bottom:10}}}})}function p21updateMesh(){if(null!=currentMesh){var e=GetMeshRights(currentMesh),t=EscapeHtml(currentMesh.name);0==t.length&&(t="<i>Пусто</i>"),1&e&&(t='<span tabindex=0 title="Нажмите здесь, чтобы изменить имя группы устройств" onclick=p20editmesh(1) onkeyup="if (event.key == \'Enter\') p20editmesh(1)" role=button>'+t+' <i class="fa-solid fa-pencil fa-2xs"></i></span>'),QH("p21meshName",t);var n={},o={},i=[0,0,0,0],a=[0,0,0,0,0],s=!1,r=!1,l=!1,d=!1;for(var c in nodes)if(nodes[c].meshid==currentMesh._id&&(nodes[c].agent&&(s=!0,null==n[nodes[c].agent.id]?n[nodes[c].agent.id]=1:n[nodes[c].agent.id]++),nodes[c].pwr&&(r=!0,null==o[nodes[c].pwr]?o[nodes[c].pwr]=1:o[nodes[c].pwr]++),0==nodes[c].conn?(l=!0,i[0]++):6&nodes[c].conn?(l=!0,1&nodes[c].conn?i[3]++:i[2]++):1&nodes[c].conn&&(l=!0,i[1]++),nodes[c].wsc)){d=!0;var u=0;"OK"==nodes[c].wsc.antiVirus&&u++,"OK"==nodes[c].wsc.autoUpdate&&u++,"OK"==nodes[c].wsc.firewall&&u++,3==u?a[0]++:u<2?a[4]++:"OK"!=nodes[c].wsc.antiVirus?a[1]++:"OK"!=nodes[c].wsc.autoUpdate?a[2]++:"OK"!=nodes[c].wsc.firewall&&a[3]++}var p=[],m=[],g=[],v=[],h=3==currentMesh.mtype?agentsStrNoAgent:agentsStr;for(var c in n)p.push(n[c]),m.push(h[c]);for(var c in o)g.push(o[c]),v.push(powerStatetable[c]);window.meshPowerChart.config.data.datasets[0].data=g,window.meshPowerChart.config.data.labels=v,window.meshPowerChart.update(),currentMesh.mtype>=2&&(window.meshOsChart.config.data.datasets[0].data=p,window.meshOsChart.config.data.labels=m,window.meshOsChart.update()),window.meshConnChart.config.data.datasets[0].data=i,window.meshConnChart.update(),window.meshSecurityChart.config.data.datasets[0].data=a,window.meshSecurityChart.update();var f="",x=0;if(g.length>0){var k=[];for(var c in o)k.push([powerStatetable[c],o[c]]);for(var c in k.sort(function(e,t){return-(e[1]-t[1])}),f+='<table class="table table-hover table-striped" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col colspan=2 style=text-align:left;width:430px>Состояния питания</th></tr>',k)f+="<tr style="+(++x%2==0?"background-color:#DDD":"")+"><td style=text-align:right;width:60px>"+k[c][1]+" <td> "+k[c][0]+"</tr>";f+="</tbody></table>"}if(p.length>0&&currentMesh.mtype>=2){x=0;var y=[];for(var c in n)y.push([h[c],n[c]]);for(var c in y.sort(function(e,t){return-(e[1]-t[1])}),f+='<table class="table table-hover table-striped" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col colspan=2 style=text-align:left;width:430px>Типы агента</th></tr>',y)f+="<tr style="+(++x%2==0?"background-color:#DDD":"")+"><td style=text-align:right;width:60px>"+y[c][1]+"<td> "+y[c][0]+"</tr>";f+="</tbody></table>"}if(l){x=0;var b=[];for(c=0;c<4;c++)b.push([["Не подключен","Агент","Intel&reg; AMT","Агент + Intel&reg; AMT"][c],i[c]]);b.sort(function(e,t){return-(e[1]-t[1])}),f+='<table class="table table-hover table-striped" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col colspan=2 style=text-align:left;width:430px>Соединение</th></tr>';for(c=0;c<4;c++)b[c][1]>0&&(f+="<tr style="+(++x%2==0?"background-color:#DDD":"")+"><td style=text-align:right;width:60px>"+b[c][1]+"<td> "+b[c][0]+"</tr>");f+="</tbody></table>"}if(d){x=0;var w=[];for(c=0;c<4;c++)w.push([['<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:ok")\' width=10 height=10 /> OK','<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:noav")\' width=10 height=10 /> Антивирус не активен','<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:noupdate")\' width=10 height=10 /> Без автоматического обновления','<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:nofirewall")\' width=10 height=10 /> Брандмауэр не активен','<img src="images/link2.png" style=cursor:pointer onclick=\'return p21setDevicesFilter("wsc:any")\' width=10 height=10 /> Множественные проблемы'][c],a[c]]);w.sort(function(e,t){return-(e[1]-t[1])}),f+='<table class="table table-hover table-striped" border=0 cellpadding=2 cellspacing=0 width=100%><tbody><tr style=background-color:#AAAAAA;font-weight:bold><th scope=col colspan=2 style=text-align:left;width:430px>Защита</th></tr>';for(c=0;c<4;c++)w[c][1]>0&&(f+="<tr style="+(++x%2==0?"background-color:#DDD":"")+"><td style=text-align:right;width:60px>"+w[c][1]+"<td> "+w[c][0]+"</tr>");f+="</tbody></table>"}""==f&&(f="<i>В группе нет устройств.</i>"),QH("p21info",f);var M=(r?1:0)+(currentMesh.mtype>=2&&s?1:0)+(l?1:0)+(d?1:0);QS("meshPowerChartDiv").display=r?"inline-block":"none",QS("meshOsChartDiv").display=currentMesh.mtype>=2&&s?"inline-block":"none",QS("meshConnChartDiv").display=l?"inline-block":"none",QS("meshSecurityChartDiv").display=d?"inline-block":"none",QS("meshPowerChartDiv").width=M>3?"23%":"31%",QS("meshOsChartDiv").width=M>3?"23%":"31%",QS("meshConnChartDiv").width=M>3?"23%":"31%",QS("meshSecurityChartDiv").width=M>3?"23%":"31%"}}function p21setDevicesFilter(e){go(1),Q("KvmSearchInput").value=Q("SearchInput").value=e,mainUpdate(5)}var sortorder,filetreelocation=[];function updateFiles(){if(QV("MainMenuMyFiles",!(8&features)),!(8&features)){for(var e,t="",n="",o='<a href=# style=cursor:pointer onclick="return p5folderup(0)">Root/Корень</a>',i="Root",a=filetree,s=1,r=[],l=filetreelinkpath,d=[],c=document.getElementsByName("fc"),u=0;u<c.length;u++)c[u].checked&&d.push(c[u].value);for(var u in filetreelinkpath="",filetreelocation){if(null==a.f||null==a.f[filetreelocation[u]])break;if(r.push(filetreelocation[u]),i+=" / "+filetreelocation[u],1==s){var p=filetreelocation[u].split("/");e=window.location.origin+domainUrl+p[0]+"files/"+p[2],filetreelinkpath+=filetreelocation[u]}else""!=filetreelinkpath&&(filetreelinkpath+="/"+filetreelocation[u],s>2&&(e+="/"+filetreelocation[u]));a=a.f[filetreelocation[u]],o+=' / <a href=# style=cursor:pointer onclick="return p5folderup('+s+')">'+EscapeHtml(null!=a.n?a.n:filetreelocation[u])+"</a>",s++}filetreelocation=r;var m=i.toLowerCase().startsWith("root / "+userinfo._id+" / public"),g=p5sort_files(a.f);for(var u in g){var v,h=g[u],f=h.n;v=f.length>70?'<span title="'+EscapeHtml(f)+'">'+EscapeHtml(f.substring(0,70))+"...</span>":EscapeHtml(f);var x="";if(null!=h.d)x=printDateTime(new Date(h.d))+"&nbsp;";var k="";null!=h.s&&(k=getFileSizeStr(h.s));var y="";if(h.t<3||4==h.t){var b=1==h.t||4==h.t?p5getQuotabar(h):"";y='<div class=filelist file=999><input file=999 style=float:left name=fc class="fcb form-check-input me-2" type=checkbox onchange=p5setActions() value="'+EscapeHtml(f)+'">&nbsp;<span style=float:right title="">'+b+"</span><span><div class=fileIcon"+h.t+' onclick=p5folderset("'+encodeURIComponentEx(h.nx)+'")></div><a href=# style=cursor:pointer onclick=\'return p5folderset("'+encodeURIComponentEx(h.nx)+"\")'>"+v+"</a></span></div>"}else{var w=v,M="",C=urlargs.key?"&key="+urlargs.key:"";m&&(M='<i class="fa-regular fa-copy" style=cursor:pointer title="Показать публичную ссылку" onclick=\'return p5showPublicLink("'+e+"/"+encodeURIComponentEx(h.nx)+"?download=1"+C+'")\'></i> <i class="fa-regular fa-copy" title="Скопировать ссылку в буфер обмена" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(e+"/"+encodeURIComponentEx(h.nx)+"?download=1"+C)+'")></i>'),h.s>0&&(w=M+'<a onclick=downloadFile("downloadfile.ashx?link='+encodeURIComponentEx(filetreelinkpath+"/"+h.nx)+'")>'+v+"</a>"),y='<div class=filelist file=3><input file=3 style=float:left name=fc class="fcb form-check-input me-2" type=checkbox onchange=p5setActions() value="'+h.nx+'">&nbsp;<span class=fsize>'+x+"</span><span style=float:right>"+k+"</span><span><div class=fileIcon"+h.t+"></div>"+w+"</span></div>"}h.t<3?t+=y:n+=y}if(QH("p5rightOfButtons",p5getQuotabar(a)),QH("p5files",t+n),QH("p5currentpath",o),QE("p5FolderUp",0!=filetreelocation.length),QV("p5PublicShare",m),l==filetreelinkpath){c=document.getElementsByName("fc");for(u=0;u<c.length;u++)c[u].checked=d.indexOf(c[u].value)>=0}p5setActions()}}function getNiceSize(e){return e<=0?"Превышен лимит места для хранения":e<2048?format("{0} байт осталось",e):e<2097152?format("{0} килобайт осталось",Math.round(e/1024)):e<2147483648?format("{0} мегабайт осталось",Math.round(e/1024/1024)):format("{0} гигабайт осталось",Math.round(e/1024/1024/1024))}function getNiceSize2(e){return e<=0?"Пусто":e<2048?format("{0} байт",e):e<2097152?format("{0} Kб",Math.round(e/1024)):e<2147483648?format("{0} Mб",Math.round(e/1024/1024)):format("{0} Гб",Math.round(e/1024/1024/1024))}function getNiceSize3(e){return e<=0?"Пусто":e<2048?format("{0} байт",e):e<2097152?format("{0} Kб",round(e/1024,1)):e<2147483648?format("{0} Mб",round(e/1024/1024,1)):format("{0} Гб",round(e/1024/1024/1024,1))}function p5getQuotabar(e){for(;e.t>1&&4!=e.t;)e=e.parent;if(1!=e.t&&4!=e.t||null==e.maxbytes)return"";var t=Math.floor(e.s/1024),n=e.maxbytes-e.s;return'<span title="'+(e.c>1?format("{0}k в {1} файлах. {2}k максимум",t,e.c,Math.floor(e.maxbytes/1024/1024)):format("{0}k в 1 файле. {1}k максимум",t,Math.floor(e.maxbytes/1024/1024)))+'">'+getNiceSize(n)+" <progress style=height:10px;width:100px value="+e.s+" max="+e.maxbytes+" /></span>"}function p5showPublicLink(e){return setModalContent("xxAddAgent","Публичная ссылка",'<input type=text style=width:350px value="'+e+'" readonly /> <i class="fa-regular fa-copy" title="Скопировать ссылку в буфер обмена" style="cursor:pointer" onclick=copyTextToClip2("'+encodeURIComponentEx(e)+'")></i>'),showModal("xxAddAgentModal","idx_dlgOkButton"),!1}function p5sort_filename(e,t){return e.ln>t.ln?1*sortorder:e.ln<t.ln?-1*sortorder:0}function p5sort_timestamp(e,t){return e.d>t.d?1*sortorder:e.d<t.d?-1*sortorder:0}function p5sort_bysize(e,t){return e.s==t.s?p5sort_filename(e,t):(e.s-t.s)*sortorder}function p5sort_files(e){var t=[],n=Q("p5sortdropdown").value;for(var o in e)e[o].nx=o,null==e[o].n&&(e[o].n=o),e[o].ln=e[o].n.toLowerCase(),t.push(e[o]);return sortorder=1,n>3&&(sortorder=-1,n-=3),1==n?t.sort(p5sort_filename):2==n?t.sort(p5sort_bysize):3==n&&t.sort(p5sort_timestamp),t}function p5setActions(){var e=getFileSelCount(),t=getFileCount(),n=getFileSelCount(!1);QE("p5DeleteFileButton",e>0&&filetreelocation.length>0),QE("p5ViewFileButton",1==e&&1==n&&filetreelocation.length>0),QE("p5NewFolderButton",filetreelocation.length>0),QE("p5UploadButton",filetreelocation.length>0),QE("p5DownloadButton",e>0&&e==n&&filetreelocation.length>0),QE("p5RenameFileButton",1==e&&filetreelocation.length>0),QE("p5SelectAllButton",t>0),Q("p5SelectAllButton").value=e>0?"Очистить все":"Выбрать все",QE("p5CutButton",n>0&&e==n),QE("p5CopyButton",n>0&&e==n),QE("p5PasteButton",null!=p5clipboard&&p5clipboard.length>0&&filetreelocation.length>0)}function getFileSelCount(e){for(var t=0,n=document.getElementsByName("fc"),o=0;o<n.length;o++)!n[o].checked||0==e&&"3"!=n[o].attributes.file.value||t++;return t}function getFileSelDirCount(){for(var e=0,t=document.getElementsByName("fc"),n=0;n<t.length;n++)t[n].checked&&"999"==t[n].attributes.file.value&&e++;return e}function getFileCount(){return document.getElementsByName("fc").length}function p5selectallfile(){for(var e=0==getFileSelCount(),t=document.getElementsByName("fc"),n=0;n<t.length;n++)t[n].checked=e;p5setActions()}function setupBackPointers(e){if(null!=e.f){var t=0,n=0;for(var o in e.f)setupBackPointers(e.f[o]),e.f[o].parent=e,e.f[o].s&&(t+=e.f[o].s),e.f[o].c&&(n+=e.f[o].c),3==e.f[o].t&&n++;e.s=t,e.c=n}return e}function getFileSizeStr(e){return"number"!=typeof e&&(e=0),1==e?"1 байт":format("{0} байт",e)}function p5folderup(e){if(null==e)filetreelocation.pop();else for(;filetreelocation.length>e;)filetreelocation.pop();return updateFiles(),!1}function p5folderset(e){return filetreelocation.push(decodeURIComponent(e)),updateFiles(),!1}function p5createfolder(){setModalContent("xxAddAgent","Новая папка",'<input type=text id=p5renameinput class="form-control" maxlength=64 onkeyup=p5fileNameCheck(event) />'),showModal("xxAddAgentModal","idx_dlgOkButton",p5createfolderEx),focusTextBox("p5renameinput"),p5fileNameCheck()}function p5createfolderEx(){meshserver.send({action:"fileoperation",fileop:"createfolder",path:filetreelocation,newfolder:Q("p5renameinput").value})}function p5deletefile(){var e=getFileSelCount(),t=getFileSelDirCount()>0?'<br /><br /><label><input type=checkbox class="form-check-input me-2" id=p5recdeleteinput>Рекурсивное удаление</label><br>':"<input type=checkbox id=p5recdeleteinput class=\"form-check-input me-2\" style='display:none'>";setModalContent("xxAddAgent","Удалить",e>1?format("Удалить {0} выбранных элементов?",e)+t:"Удалить выбранные элементы?"+t),showModal("xxAddAgentModal","idx_dlgOkButton",p5deletefileEx)}function p5deletefileEx(){for(var e=[],t=document.getElementsByName("fc"),n=0;n<t.length;n++)t[n].checked&&e.push(t[n].value);meshserver.send({action:"fileoperation",fileop:"delete",path:filetreelocation,delfiles:e,rec:Q("p5recdeleteinput").checked})}function p5renamefile(){for(var e,t=document.getElementsByName("fc"),n=0;n<t.length;n++)t[n].checked&&(e=t[n].value);setModalContent("xxAddAgent","Переименовать",'<input type=text id=p5renameinput class="form-control" maxlength=64 onkeyup=p5fileNameCheck(event) value="'+e+'" />'),showModal("xxAddAgentModal","idx_dlgOkButton",p5renamefileEx),focusTextBox("p5renameinput"),p5fileNameCheck()}function p5renamefileEx(e,t){t.newname=Q("p5renameinput").value,meshserver.send(t)}function p5fileNameCheck(e){var t=isFilenameValid(Q("p5renameinput").value);QE("idx_dlgOkButton",t),1==t&&e&&13==e.keyCode&&dialogclose(1)}var isFilenameValid=function(){var e=/^[^\\/:\*\?"<>\|]+$/,t=/^\./,n=/^(nul|prn|con|lpt[0-9]|com[0-9])(\.|$)/i;return function(o){return e.test(o)&&!t.test(o)&&!n.test(o)&&"."!=o[0]}}();function p5uploadFile(){setModalContent("xxAddAgent","Загрузить файл",'<form method=post enctype=multipart/form-data action=uploadfile.ashx target=fileUploadFrame><input type=text name=link style=display:none id=p5uploadpath value="'+encodeURIComponentEx(filetreelinkpath)+'" /><input type=file name=files id=p5uploadinput class="form-control" multiple=multiple onchange="p5updateUploadDialogOk(\'p5uploadinput\')" /><input type=hidden name=authCookie value='+authCookie+' /><input type=submit id=p5loginSubmit class="btn btn-outline-success mt-2" style="display:none" /><span id=p5confirmOverwriteSpan style=display:none><br/><label><input type=checkbox class="form-check-input me-2" id=p5confirmOverwrite onchange="p5updateUploadDialogOk(\'p5uploadinput\')" />Подтвердить перезапись?</label></span></ >'),showModal("xxAddAgentModal","idx_dlgOkButton",p5uploadFileEx),p5updateUploadDialogOk("p5uploadinput")}function p5uploadFileEx(){Q("p5loginSubmit").click()}function p5GetFileInfo(e){var t=filetree;for(var n in filetreelocation)null!=t.f&&null!=t.f[filetreelocation[n]]&&(t=t.f[filetreelocation[n]]);return t.f[e]}function p5updateUploadDialogOk(){var e=Q("p5uploadinput").files,t=[];for(var n in e)null!=e[n].size&&0!=e[n].size&&t.push(e[n]);var o=filetree,i=[],a=0;for(var n in filetreelocation)null!=o.f&&null!=o.f[filetreelocation[n]]&&(o=o.f[filetreelocation[n]]);if(QE("idx_dlgOkButton",e.length>0),e.length>0){if(null!=o.f){for(var n in o.f)i.push(n);for(n=0;n<e.length;n++)i.indexOf(e[n].name)>=0&&a++}QV("p5confirmOverwriteSpan",a>0),a>0?QE("idx_dlgOkButton",Q("p5confirmOverwrite").checked):(Q("p5confirmOverwrite").checked=!1,QE("idx_dlgOkButton",!0))}}function p5viewfile(){for(var e=document.getElementsByName("fc"),t=0;t<e.length;t++)if(e[t].checked){var n=p5GetFileInfo(e[t].value);if(null==n)return;return void(n.s<=204800?meshserver.send({action:"fileoperation",fileop:"get",path:filetreelocation,file:e[t].value,tag:"edit"}):messagebox("Редактор файлов","Редактировать можно только файлы размером менее 200КБ."))}}var p5clipboard=null,p5clipboardFolder=null,p5clipboardCut=0;function p5copyFile(e){var t=document.getElementsByName("fc");p5clipboard=[],p5clipboardCut=e,p5clipboardFolder=Clone(filetreelocation);for(var n=0;n<t.length;n++)t[n].checked&&"3"==t[n].attributes.file.value&&p5clipboard.push(t[n].value);p5updateClipview()}function p5pasteFile(){var e="";null!=p5clipboard&&p5clipboard.length>0&&(e=format("Подтвердить {0} из {1} записей в это расположение?",0==p5clipboardCut?"copy":"move",p5clipboard.length,p5clipboard.length>1?"s":"")),setModalContent("xxAddAgent","Вставить",e),showModal("xxAddAgentModal","idx_dlgOkButton",p5pasteFileEx)}function p5pasteFileEx(){meshserver.send({action:"fileoperation",fileop:0==p5clipboardCut?"copy":"move",scpath:p5clipboardFolder,path:filetreelocation,names:p5clipboard}),p5folderup(999),1==p5clipboardCut&&(p5clipboard=null,p5clipboardFolder=null,p5clipboardCut=0,p5updateClipview())}function p5updateClipview(){var e="";null!=p5clipboard&&p5clipboard.length>0&&(e=format("Задержано {0} записей для {2}",p5clipboard.length,p5clipboard.length>1?"s":"",0==p5clipboardCut?"копировать":"переместить")+', <a href=# onclick="return p5clearClip()" style=cursor:pointer>Очистить</a>.'),QH("p5bottomstatus",e),p5setActions()}function p5clearClip(){return p5clipboard=null,p5clipboardFolder=null,p5clipboardCut=0,p5updateClipview(),!1}function p5fileDragDrop(e){if(!xxdialogMode&&(haltEvent(e),QV("bigfail",!1),QV("bigok",!1),null!=e.dataTransfer)){var t=[];for(var n in e.dataTransfer.files)null!=e.dataTransfer.files[n].size&&0!=e.dataTransfer.files[n].size&&t.push(e.dataTransfer.files[n]);if(0!=t.length){var o=filetree,i=[],a=0;for(var n in filetreelocation)null!=o.f&&null!=o.f[filetreelocation[n]]&&(o=o.f[filetreelocation[n]]);if(null!=o.f){for(var n in o.f)i.push(n);for(n=0;n<e.dataTransfer.files.length;n++)i.indexOf(e.dataTransfer.files[n].name)>=0&&a++}0==a?p5PerformUpload(1,e.dataTransfer.files):(setModalContent("xxAddAgent","Загрузить файл",format(1==a?"Загрузка перезапишет 1 файл. Продолжить?":"Загрузка перезапишет {0} файлов. Продолжить?",a)),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p5PerformUpload(3,e.dataTransfer.files)))}}}function p5PerformUpload(e,t){var n=0;p5uploadFile();try{Q("p5uploadinput").files=t}catch(e){n=1}if(0==n&&p5uploadFileEx(),setDialogMode(0),1==n){if(0==filetreelocation.length)return;for(var o=[],i=[],a=[],s=[],r=t.length,l=0,d=0;d<t.length;d++)l+=t[d].size;if(l>13e5)return void p5uploadFile();for(d=0;d<t.length;d++){var c=new FileReader,u=t[d];o.push(u.name),i.push(u.size),a.push(u.type),c.onload=function(e){s.push(e.target.result),0==--r&&(Q("p5fileDragName").value=o.join("*"),Q("p5fileDragSize").value=i.join("*"),Q("p5fileDragType").value=a.join("*"),Q("p5fileDragData").value=s.join("*"),Q("p5fileDragLink").value=encodeURIComponentEx(filetreelinkpath),Q("p5fileDragAuthCookie").value=authCookie,Q("p5loginSubmit2").click())},c.readAsDataURL(u)}}}var p5dragtimer=null;function p5fileDragOver(e){if(!xxdialogMode){haltEvent(e),null!=p5dragtimer&&(clearTimeout(p5dragtimer),p5dragtimer=null);var t=!0;0==filetreelocation.length&&(t=!1),QV("bigok",t),QV("bigfail",!t)}}function p5fileDragLeave(e){xxdialogMode||(haltEvent(e),"p5filetable"!=e.target.id?(QV("bigfail",!1),QV("bigok",!1)):p5dragtimer=setTimeout(function(){QV("bigfail",!1),QV("bigok",!1),p5dragtimer=null},10))}function p5downloadButton(){for(var e=document.getElementsByName("fc"),t=0;t<e.length;t++){if(e[t].checked)downloadFile("downloadfile.ashx?link="+encodeURIComponentEx(filetreelinkpath+"/"+e[t].value))}}var eventsMessageId={1:"Логин аккаунта",2:"Выход из учетной записи",3:"Язык изменен с {1} на {2}",4:"Присоединился к сеансу мультиплексированного рабочего стола",5:"Покинул сеанс мультиплексного режима рабочего стола",6:"Начался сеанс мультиплексирования рабочего стола",7:"Завершение сеанса записи, {0} сек.",8:"Завершился сеанс мультиплексирования рабочего стола, {0} сек.",9:'Завершен сеанс ретрансляции "{0}" от {1} к {2}, {3} сек.',10:'Завершен сеанс терминала "{0}" от {1} к {2}, {3} сек.',11:'Завершен сеанс рабочего стола "{0}"  от {1} к {2}, {3} сек.',12:'Завершен сеанс управления файлами "{0}" от {1} к {2}, {3} сек.',13:'Начат сеанс ретрансляции "{0}" от {1} к {2}',14:'Начат сеанс терминала "{0}" от {1} к {2}',15:'Начат сеанс рабочего стола "{0}" от {1} к {2}',16:'Начат сеанс управления файлами "{0}" от {1} к {2}',17:'Выполнение консольной команды: "{0}"',18:'Показано окно с сообщением, title = "{0}", message = "{1}"',19:"Завершение процесса {0}",20:"Открытие: {0}",21:"Получение содержимого буфера обмена, байт (ов): {0}",22:"Установка содержимого буфера обмена, байт (ов): {0}",23:"Попытка активации режима Intel (R) AMT ACM",24:"Выполнение команд",25:"Управление питанием устройства = {0}, принудительно = {1}",26:'Показано всплывающее сообщение(тост), title = "{0}", message = "{1}"',27:"Локальный пользователь принял запрос удаленного терминала",28:"Локальный пользователь отклонил запрос удаленного терминала",29:"Подключение к удаленному рабочему столу принудительно закрыто локальным пользователем",30:"Запуск удаленного рабочего стола после согласия локального пользователя",31:"Панель-уведомление подключения к удаленному рабочему столу активирована/обновлена",32:"Панель-уведомление подключения к удаленному рабочему столу не работает или не поддерживается",33:"Подключение к удаленному рабочему столу принудительно закрыто локальным пользователем",34:"Не удалось запустить сеанс удаленного рабочего стола после отказа локального пользователя",35:"Удаленный рабочий стол запущен с всплывающим уведомлением",36:"Удаленный рабочий стол запущен без уведомления",37:"Панель-уведомление подключения к удаленному рабочему столу активирована/обновлена",38:"Панель-уведомление подключения к удаленному рабочему столу не работает или не поддерживается",39:"Подключение к удаленному рабочему столу принудительно закрыто локальным пользователем",40:"Запуск удаленного управления файлами после согласия локального пользователя",41:"Не удалось запустить сеанс управления файлами после отказа локального пользователя",42:"Удаленное управление файлами запущено с всплывающим уведомлением",43:"Удаленное управление файлами запущено без уведомления",44:'Создать папку: "{0}"',45:'Удалить: "{0}"',46:'Удалить рекурсивный: "{0}", {1} элемент(ы) удалены',47:'Удалить: "{0}", {1} элемент(ы) удалены',48:'Переименование: "{0}" в "{1}"',49:'Скачать: "{0}"',50:'Загрузить: "{0}"',51:'Копировать: "{0}" в "{1}"',52:'Переместить: "{0}" в "{1}"',53:"Блокировка удаленного пользователя с рабочего стола",54:"Агент закрыл сеанс с {0}% сжатия агента на сервер. Отправлено: {1}, сжато: {2}",55:"Созданная группа устройств: {0}",56:"Группа устройств восстановлена: {0}",57:"Добавлено устройство {0} в группу устройств {1}",58:"Устройство запросило активацию Intel (R) AMT ACM, полное доменное имя: {0}",59:"Изменено устройство {0} из группы {1}: {2}",60:"Удалены права пользователя на устройство для {0}",61:"Изменены права пользователя на устройство для {0}",62:"Удален пользователь {0} из группы пользователей {1}",63:"Аккаунт удален",64:"Аккаунт создан, имя пользователя: {0}",65:"Аккаунт создан, адрес электронной почты: {0}",66:"Аккаунт изменен: {0}",67:"Членство в группе пользователей изменено: {0}",68:"Группа пользователей {0} добавлена в группу устройств {1}",69:"Создана группа пользователей: {0}",70:"Удалена группа пользователей {0} из группы устройств {1}",71:"Пользователь {0} добавлен в группу пользователей {1}",72:"Удален пользователь {0} из группы пользователей {1}",73:"Уведомление о группе устройств изменено",74:"Пароль учетной записи изменен: {0}",75:"Изменены учетные данные",76:"Создана группа устройств: {0}",77:"Группа устройств удалена: {0}",78:"Членство в группе устройств изменено: {0}",79:"Группа пользователей изменена: {0}",80:"Пользователь {0} добавлен в группу пользователей {1}",81:"Удалены права пользователя на устройство для {0}",82:"Изменены права пользователя на устройство для {0}",83:"Удален пользователь {0} из группы устройств {1}",84:"Добавлено устройство {0} в группу устройств {1}",85:"Устройство перемещено {0} в группу {1}",86:"Удалены права пользователя на устройство для {0}",87:"Удалено устройство {0} из группы устройств {1}",88:"Включена двухфакторная аутентификация электронной почты",89:"Отключена двухфакторная аутентификация по электронной почте",90:"Добавлено приложение аутентификации",91:"Удалено приложение аутентификации",92:"Созданы новые резервные коды 2FA",93:"Резервные коды 2FA удалены",94:"Удален электронный ключ",95:"Добавлен электронный ключ",96:"Подтвержден номер телефона пользователя {0}",97:"Удален номер телефона пользователя {0}",98:"Запрошена помощь, пользователь: {0}, подробности: {1}",99:"Выполнение команд от имени пользователя",100:"Выполнение команд от имени пользователя, если возможно",101:"Добавлен общий доступ к устройству {0} с {1} на {2}",102:"Удалено совместное использование устройства {0}",103:"Массовая загрузка файлов ({0}) в папку {1}",104:'Автоматическая загрузка файла дампа ядра агента: "{0}"',105:'Загрузка: "{0}", Размер: {1}',106:'Скачивание: "{0}", Размер: {1}',107:"Вход в аккаунт с {0}, {1}, {2}",108:"Попытка входа пользователя с неверным вторым фактором из {0}, {1}, {2}",109:"Попытка входа пользователя в заблокированный аккаунт из {0}, {1}, {2}",110:"Некорректная попытка входа пользователя из {0}, {1}, {2}",111:"Устройство Intel(R) AMT ACM запросило активацию TLS, полное доменное имя: {0}",112:'Завершен сеанс обмена сообщениями "{0}" от {1} к {2}, {3} сек.',113:"Добавлено устройство аутентификации push-уведомлений",114:"Удалено устройство аутентификации push-уведомлений",115:"Добавлен токен входа",116:"Удален токен входа",117:"Это старая версия агента, рассмотрите возможность обновления.",118:"Этот агент имеет устаревший механизм проверки сертификата, рассмотрите возможность обновления.",119:"Этот агент использует незащищенные туннели, рассмотрите возможность обновления.",120:'Начат локальный сеанс ретрансляции "{0}", протокол {1} - {2}',121:'Завершен сеанс локальной ретрансляции "{0}" протокол {1} к {2}, {3} сек.',122:"Покинул сеанс мультиплексного режима рабочего стола через {0} с.",123:'Завершен сеанс Web-SSH "{1}", {0} с.',124:'Завершен сеанс Web-SFTP  "{1}", {0} с.',125:'Завершен сеанс Web-RDP "{1}", {0} с.',126:"Завершен сеанс Web-VNC, {0} с.",127:"Изменено отображаемое имя учетной записи на {0}.",128:"Аккаунт создан, имя {0}.",129:"Удалено отображаемое имя учетной записи.",130:"Уведомления пользователей изменены",131:"Добавлен общий доступ к устройству {0} с неограниченным временем.",132:"Включить.",133:"Выключить.",134:"Принудительно отключен сеанс рабочего стола пользователя {0}",135:"Принудительно отключен терминальный сеанс пользователя {0}",136:"Принудительно отключен файловый сеанс пользователя {0}",137:"Принудительно отключен сеанс маршрутизации пользователя {0}",138:"Добавлен ежедневный общий доступ к устройству {0}.",139:"Добавлен еженедельный общий доступ к устройству {0}.",140:"Изменено устройство {0} из группы {1}: {2}",141:"Изменение политик Intel(r) AMT",142:"Группа устройств {0} изменена: {1}",143:'Присоединился к сеансу мультиплексированного рабочего стола "{0}"',144:'Покинул сеанс мультиплексного режима рабочего стола "{0}" через {1} с.',145:'Начался сеанс мультиплексирования рабочего стола  "{0}"',146:'Завершение сеанса записи "{0}", {1} сек.',147:'Завершился сеанс мультиплексирования рабочего стола  "{0}", {1}  сек.',148:'Начат сеанс Web-SSH "{0}".',149:'Начат сеанс Web-SFTP "{0}".',150:'Начат сеанс Web-RDP "{0}".',151:'Начат сеанс Web-VNC "{0}".',152:'Больше не является ретранслятором для  "{0}".',153:'Установлен ретранслятором для "{0}".',154:"Account changed to sync with LDAP data.",155:"Denied user login from {0}, {1}, {2}",156:"Verified messaging account of user {0}",157:"Removed messaging account of user {0}",158:'Displaying alert box, title="{0}", message="{1}"',159:"Device Powered On",160:"Enabled Duo two-factor authentication",161:"Disabled Duo two-factor authentication",162:'Начал сеанс обмена сообщениями "{0}" с {1} по {2}'},eventsShortMessageId={1:"Имя группы",2:"Описание",3:"Флаги",4:"Согласие",5:"Автоудаление",6:"Код приглашения",7:"Устройство-ретранслятор"};function eventMouseHover(e,t){e.children[1].classList.remove("g1s"),e.children[2].classList.remove("style10s"),1==t&&(e.children[1].classList.add("g1s"),e.children[2].classList.add("style10s"))}function eventsUpdate(){var e="",t=null;for(var n in events){var o=events[n],i=new Date(o.time);if(o.msg){null==o.h&&(o.h=Math.random()),printDate(i)!=t&&(null!=t&&(e+="</table>"),e+='<table class="table table-hover p3eventsTable" cellpadding=0 cellspacing=0><tr><td colspan=4 class=DevSt>'+(t=printDate(i))+"</td></tr>");var a,s="fa-mobile-screen";if("ugrp"==o.etype&&(s="fa-users"),"user"==o.etype&&(s="fa-user"),"server"==o.etype&&(s="fa-server"),null==o.msgid||null==eventsMessageId[o.msgid])a="string"==typeof o.msg?EscapeHtml(o.msg).split("(R)").join("&reg;"):"";else{if(a=eventsMessageId[o.msgid],null!=o.msgArgs)for(var n in o.msgArgs){var r=o.msgArgs[n];if(Array.isArray(r)){var l=[];for(var d in r)"number"==typeof r[d]&&eventsShortMessageId[r[d]]?l.push(eventsShortMessageId[r[d]]):l.push(r[d]);r=l.join(", ")}else"string"==typeof r&&0==r.indexOf("DATETIME:")&&(r=printFlexDateTime(new Date(parseInt(r.substring(9)))));a=a.split("{"+n+"}").join(r)}a=EscapeHtml(a).split("(R)").join("&reg;")}if(o.nodeid){var c=getNodeFromId(o.nodeid);if(null!=c){switch(c.icon){case 1:s="fa-computer";break;case 2:s="fa-laptop";break;case 8:s="fa-laptop-code"}a="<a href=# onclick='gotoDevice(\""+o.nodeid+"\",10);haltEvent(event);'>"+EscapeHtml(c.name)+"</a> &rarr; "+a}}if(o.username){var u="";o.guestname&&(u=' / <span title="Это гостевой сеанс общего доступа">'+EscapeHtml(o.guestname)+"</span>"),a=2&userinfo.siteadmin&&o.userid?"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(o.userid)+"\");haltEvent(event);'>"+EscapeHtml(o.username)+"</a>"+u+" &rarr; "+a:EscapeHtml(o.username)+u+" &rarr; "+a}o.remoteaddr&&(a+=" ("+o.remoteaddr+")"),"relay"!=o.etype&&"relaylog"!=o.action||(s="fa-arrow-right-arrow-left"),e+="<tr onclick=showEventDetails("+o.h+',2)  onmouseover=eventMouseHover(this,1) onmouseout=eventMouseHover(this,0) role=button><td style=width:18px><i class="fa-fw fa-solid '+s+'"></i></td><td class=g1>&nbsp;</td><td class=style10>'+printTime(i)+" - "+a+"</td></tr><tr></tr>"}}null!=t&&(e+="</table>"),""==e&&(e="<br><i>События не найдены</i><br><br>"),QH("p3events",e)}function refreshEvents(){""!=p3filterevents.value?meshserver.send({action:"events",limit:parseInt(p3limitdropdown.value),filter:p3filterevents.value}):meshserver.send({action:"events",limit:parseInt(p3limitdropdown.value)})}function p3showReportDialog(){if(!xxdialogMode){var e="<div style=float:right><img src='images/report60.png' height=74 width=60 style=padding-top:2px /></div><div>";e+=addHtmlFormFloating("Тип отчета",'<select id=d2reportType class="form-select" onchange=p3showReportValidation()><option value=1>Все события</option>'),e+=addHtmlFormFloating("Промежуток времени",'<select id=d2reportSpan class="form-select" onchange=p3showReportValidation()><option value=1>Все в наличии</option><option value=2>Один день</option></select>'),e+="<div id=d2daySelector>"+addHtmlFormFloating("Отчетный день",'<input type=date id=d2reportDay class="form-control" onchange=p3showReportValidation()></input>')+"</div>",e+=addHtmlFormFloating("Группировать по",'<select id=d2reportGroupBy class="form-select" onchange=p3showReportValidation()><option value=1>Пусто</option><option value=2>Группа устройств</option><option value=3>Пользователь</option>'),e+=addHtmlFormFloating("Формат",'<select id=d2reportFormat class="form-select" onchange=p3showReportValidation()><option value=1>CSV</option><option value=2>JSON</option>'),setModalContent("xxAddAgent","Скачать отчет",e+="</div>"),showModal("xxAddAgentModal","idx_dlgOkButton"),p3showReportValidation(),Q("d2reportType").focus()}}function p3showReportValidation(){Q("d2reportType").value;var e=Q("d2reportSpan").value,t=Q("d2reportDay").value;Q("d2reportGroupBy").value,Q("d2reportFormat").value;QV("d2daySelector",2==e);var n=!0;2==e&&""==t&&(n=!1),QE("idx_dlgOkButton",n)}function p3showDownloadEventsDialog(e){if(!xxdialogMode){var t="Скачайте список событий в одном из форматов доступных ниже.<br /><br />";t+=addHtmlValue("Формат CSV",'<a href=# style=cursor:pointer onclick="return p3downloadEventsDialogCSV('+e+')">eventslist.csv</a>'),setModalContent("xxAddAgent","Экспорт списка событий",t+=addHtmlValue("Формат JSON",'<a href=# style=cursor:pointer onclick="return p3downloadEventsDialogJSON('+e+')">eventslist.json</a>')),showModal("xxAddAgentModal","idx_dlgOkButton")}}function p3downloadEventsDialogCSV(e){var t,n;for(var o in 1==e&&(n=currentDeviceEvents),2==e&&(n=events),3==e&&(n=currentUserEvents),t="utc, time, type, action, user, device, message\r\n",n){var i="";if(n[o].nodeid){var a=getNodeFromId(n[o].nodeid);a&&a.name&&(i=a.name)}t+='"'+n[o].time+'","'+printDateTime(new Date(n[o].time))+'","'+n[o].etype+'","'+(null!=n[o].action?n[o].action:"")+'","'+(null!=n[o].username?n[o].username:"")+'","'+EscapeHtml(i)+'","'+(null!=n[o].msg?n[o].msg:"").split(",").join(" -")+'"\r\n'}return saveAs(stringToUtf8Blob(t),"eventslist.csv"),!1}function p3downloadEventsDialogJSON(e){var t,n=[];for(var o in 1==e&&(t=currentDeviceEvents),2==e&&(t=events),3==e&&(t=currentUserEvents),t)n.push(events[o]);return saveAs(new Blob([JSON.stringify(n,null,2)],{type:"application/octet-stream"}),"eventslist.json"),!1}function updateUsers(){if(QV("UserNewAccountButton",!(4&features)&&0==serverinfo.domainauth),null==users||4&features)QH("p3users","");else{var e=null!=userViewSettings&&userViewSettings.noViewLimit?1e5:100,t=[],n=e,o=0;for(var i in users)t.push(users[i]);t.sort(nameSort);var a=Q("UserSearchInput").value.toLowerCase(),s=a;a.startsWith("email:")?(a=null,s=s.substring(6)):a.startsWith("name:")?(s=null,a=a.substring(5)):a.startsWith("e:")?(a=null,s=s.substring(2)):a.startsWith("n:")&&(s=null,a=a.substring(2));var r='<table class="table table-hover" cellpadding=0 cellspacing=0>',l=!0;r+="<th>Имя<th style=width:80px>Группы устройств<th style=width:120px>"+nobreak("Последний доступ")+"<th style=width:120px>Права";var d=[],c=document.getElementsByClassName("UserCheckbox");for(i=0;i<c.length;i++)c[i].checked&&d.push(c[i].value);for(var i in t){var u=t[i],p=null;null!=wssessions&&(p=wssessions[u._id]),null!=p&&(null!=a&&(""==a||u.name.toLowerCase().indexOf(a)>=0)||null!=s&&null!=u.email&&u.email.toLowerCase().indexOf(s)>=0)&&(n>0?(l&&(r+="<tr><td class=userTableHeader colspan=4>Онлайн пользователи",l=!1),r+=addUserHtml(u,p),n--):o++)}for(var i in l=!0,t){u=t[i],p=null;null!=wssessions&&(p=wssessions[u._id]),null==p&&(null!=a&&(""==a||u.name.toLowerCase().indexOf(a)>=0)||null!=s&&null!=u.email&&u.email.toLowerCase().indexOf(s)>=0)&&(n>0?(l&&(r+="<tr><td class=userTableHeader colspan=4>Оффлайн пользователи",l=!1),r+=addUserHtml(u,p),n--):o++)}r+="</table>",1==o?r+="<br />Еще 1 пользователь не показан, используйте поиск чтобы найти пользователей...<br />":o>1&&(r+="<br />"+format("Еще {0} пользователей не показаны, используйте поиск для нахождения пользователей...",o)+"<br />"),n==e&&(r+="<br />Пользователи не найдены.<br />"),QH("p3users",r),c=document.getElementsByClassName("UserCheckbox");var m=encodeURIComponentEx(userinfo._id);for(i=0;i<c.length;i++)c[i].checked=d.indexOf(c[i].value)>=0&&c[i].value!=m;p3updateInfo(),null!=currentUser&&30==xxcurrentView&&gotoUser(encodeURIComponentEx(currentUser._id),!0)}}function addUserHtml(e,t){var n="",o=" gray",i="",a=e._id!=userinfo._id,s="",r="";null!=t?(o="",a&&(i='<span style=float:right;margin-top:1px;margin-right:4px title=Чат><a href=# onclick=userChat(event,"'+encodeURIComponentEx(e._id)+'","'+encodeURIComponentEx(e.name)+"\")><img src='images/icon-chat.png' height=16 width=16 style=padding-top:2px /></a></span>",i+="<span style=float:right;margin-top:1px;margin-left:4px;margin-right:4px title=Notify><a href=# onclick='return showUserAlertDialog(event,\""+encodeURIComponentEx(e._id)+"\")'><img src='images/icon-notify.png' height=16 width=16 style=padding-top:2px /></a></span>"),s+=nobreak(1==t?"1 сессия":format("{0} сессий",t))):e.access?s+='<span title="'+format("Последний доступ: {0}",printDateTime(new Date(1e3*e.access)))+'">'+printDate(new Date(1e3*e.access))+"</span>":e.login&&(s+='<span title="'+format("Последний вход в систему: {0}",printDateTime(new Date(1e3*e.login)))+'">'+printDate(new Date(1e3*e.login))+"</span>"),a&&(r+="<a href=# style=cursor:pointer onclick='return showUserAdminDialog(event,\""+encodeURIComponentEx(e._id)+"\")'>"),null!=e.siteadmin&&32&e.siteadmin&&4294967295!=e.siteadmin&&(r+="Заблокирован,&nbsp;"),r+="<span title='Разрешения сервера'>";var l=4294966047&e.siteadmin;null==e.siteadmin||0==l?r+="Пользователь":8==l?r+="Пользователь + Файлы":4294967295==e.siteadmin?r+="Администратор":r+=2&l?"Менеджер":"Частично",null!=e.siteadmin&&4294967295!=e.siteadmin&&1216&e.siteadmin&&(r+="*"),r+="</span>",a&&(r+="</a>");var d=0;if(e.links)for(var c in e.links)c.startsWith("mesh/")&&d++;var u=EscapeHtml(e.name),p="";if(1==serverinfo.emailcheck&&(p=1!=e.emailVerified?' <b style=color:red title="Электронная почта не подтверждена">&#x2717;</b>':' <b style=color:green title="Электронная почта подтверждена">&#x2713</b>'),null!=e.email&&(2097152&features&&e.email.toLowerCase()==e.name.toLowerCase()?u+=' <a href="mailto:'+EscapeHtml(e.email)+'"><img src="images/mail12.png" height=9 width=12 title="Отправить письмо пользователю" style="margin-top:2px" /></a>'+p:u+=', <a href="mailto:'+EscapeHtml(e.email)+'">'+EscapeHtml(e.email)+"</a>"+p),null!=serverinfo.crossDomain){var m=e._id.split("/")[1];""!=m&&(u+=", <span style=color:#26F>"+m+"</span>")}return(e.otpsecret>0||e.otphkeys>0||1==e.otpekey&&8388608&features||1==e.otpduo||null!=e.phone&&67108864&features)&&(u+=' <i class="fa-solid fa-key" title="двухфакторная аутентификация включена" style="margin-top:2px"></i>'),null!=e.phone&&(u+=' <i class="fa-solid fa-mobile-screen" title="Проверенный номер телефона" style="margin-top:2px"></i>'),null!=e.siteadmin&&32&e.siteadmin&&4294967295!=e.siteadmin&&(u+=' <img src="images/padlock12.png" height=12 width=8 title="Аккаунт заблокирован" style="margin-top:2px" />'),null!=e.msghandle&&33554432&features2&&(u+=' <i class="fa-solid fa-comment fa-xs" title="Verified messaging account" style="margin-top:2px" />'),n+="<tr tabindex=0 onkeypress=\"if (event.key=='Enter') gotoUser('"+encodeURIComponentEx(e._id)+"')\"><td>",n+="<div>",n+='<div class=baricon><input class="UserCheckbox form-check-input me-2" value='+encodeURIComponentEx(e._id)+" onclick=p3updateInfo() type=checkbox"+(e._id==userinfo._id?" disabled":"")+'></div><div style=cursor:pointer onclick=gotoUser("'+encodeURIComponentEx(e._id)+'",false,event)>',n+='<div class=baricon><i class="fa-fw fa-solid fa-user '+o+'"></i></div>',n+="<div>",n+="<div><span style=line-height:24px>"+u+"</span>"+i+"</div></div><td style=text-align:center>"+d+"<td style=text-align:center>"+s+"<td style=text-align:center>"+r}function p3updateInfo(){for(var e=document.getElementsByClassName("UserCheckbox"),t=0,n=0;n<e.length;n++)!0===e[n].checked&&t++;QE("UsersGroupActionButton",t>0),Q("UsersSelectAllButton").value=t>0?"Очистить все":"Выбрать все"}function p3usersSelectallButtonFunction(){for(var e=encodeURIComponentEx(userinfo._id),t=document.getElementsByClassName("UserCheckbox"),n=0,o=0;o<t.length;o++)!0===t[o].checked&&n++;for(o=0;o<t.length;o++)t[o].checked=0==n&&t[o].value!=e;p3updateInfo()}function p3usersGroupActionFunction(){for(var e=document.getElementsByClassName("UserCheckbox"),t=0,n=0;n<e.length;n++)!0===e[n].checked&&t++;if(0!=t){var o="";serverinfo.emailcheck&&(o+="<option value=4>Подтвердить адрес электронной почты</option><option value=5>Недействительный адрес электронной почты</option>");var i="Выберите операцию, которую нужно выполнить для всех выбранных пользователей.<br /><br />";setModalContent("xxAddAgent","Групповое действие",i+=addHtmlFormFloating("Операция","<select id=d3groupop class=form-select><option value=1>Заблокировать учетную запись</option><option value=2>Разблокировать учетную запись</option>"+o+"<option value=3>Удалить учетную запись</option></select>")),showModal("xxAddAgentModal","idx_dlgOkButton",p3usersGroupActionFunctionEx)}}function p3usersGroupActionFunctionEx(){for(var e=document.getElementsByClassName("UserCheckbox"),t=[],n=0;n<e.length;n++)!0===e[n].checked&&t.push(decodeURIComponent(e[n].value));var o=Q("d3groupop").value;if(1==o)for(var n in t){32&(i=null==(a=users[t[n]]).siteadmin?0:a.siteadmin)||(i+=32,meshserver.send({action:"edituser",id:a._id,siteadmin:i}))}else if(2==o)for(var n in t){var i;32&(i=null==(a=users[t[n]]).siteadmin?0:a.siteadmin)&&(i-=32,meshserver.send({action:"edituser",id:a._id,siteadmin:i}))}else if(3==o){QE("idx_dlgOkButton",!1)}else if(4==o)for(var n in t){!0!==(a=users[t[n]]).emailVerified&&meshserver.send({action:"edituser",id:a._id,emailVerified:!0})}else if(5==o)for(var n in t){var a;!0===(a=users[t[n]]).emailVerified&&meshserver.send({action:"edituser",id:a._id,emailVerified:!1})}}function p3usersGroupActionFunctionDelCheck(){QE("idx_dlgOkButton",Q("d3check").checked)}function p3groupActionFunctionDelExec(e){for(var t=document.getElementsByClassName("UserCheckbox"),n=[],o=0;o<t.length;o++)!0===t[o].checked&&n.push(decodeURIComponent(t[o].value));for(var o in n){var i=users[n[o]];meshserver.send({action:"deleteuser",userid:i._id,username:i.name})}}function userMouseHover(e,t){var n=e.children[0].children[0].children[1];n.children[1].classList.remove("g1s"),n.children[2].classList.remove("g2s"),e.children[0].children[0].classList.remove("sbar"),1==t&&(n.children[1].classList.add("g1s"),n.children[2].classList.add("g2s"),e.children[0].children[0].classList.add("sbar"))}function userMouseHover2(e,t){var n=e.children[0].children[0];n.children[2].classList.remove("g1s"),n.children[3].classList.remove("g2s"),e.children[0].children[0].classList.remove("sbar"),1==t&&(n.children[2].classList.add("g1s"),n.children[3].classList.add("g2s"),e.children[0].children[0].classList.add("sbar"))}function userChat(e,t,n){if(!xxdialogMode){haltEvent(e);var o="/messenger?id=meshmessenger/"+t+"/"+encodeURIComponentEx(userinfo._id)+"&title="+n;return null!=authCookie&&""!=authCookie&&(o+="&auth="+authCookie),urlargs.key&&(o+="&key="+urlargs.key),safeNewWindow(o,"meshmessenger:"+t),meshserver.send({action:"meshmessenger",userid:decodeURIComponent(t)}),!1}}function altUserChat(e,t,n,o){if(!xxdialogMode){haltEvent(e);var i=serverinfo.altmessenging[o].url,a=decodeURIComponent(t),s=encodeURIComponentEx(a.split("/")[2]),r=encodeURIComponentEx(a.split("/").join("-")),l=s,d=r,c=users[a];return null!=c&&null!=c.realname&&(l=encodeURIComponentEx(c.realname.split(" ").join("")),d=encodeURIComponentEx(c.realname.split(" ").join("-"))),i=i.split("{0}").join(s).split("{1}").join(r).split("{2}").join(l).split("{3}").join(d),urlargs.key&&(i+="&key="+urlargs.key),safeNewWindow(i,"altmessenger:"+t),meshserver.send({action:"notifyuser",userid:decodeURIComponent(t),msg:serverinfo.altmessenging[o].name,msgid:11,url:i}),!1}}function showSendSMS(e){xxdialogMode||(setModalContent("xxAddAgent","Отправить смс","<textarea id=d2smsText maxlength=160 style=width:100%;height:100px;resize:none onKeyUp=showSendSMSValidate()></textarea><span style=font-size:10px><span>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showSendSMSEx(3,e)),Q("d2smsText").focus(),showSendSMSValidate())}function showSendSMSValidate(){QE("idx_dlgOkButton",Q("d2smsText").value.length>0)}function showSendSMSEx(e,t){Q("d2smsText").value.length>0&&meshserver.send({action:"smsuser",userid:decodeURIComponent(t),msg:Q("d2smsText").value})}function showSendMessage(e){xxdialogMode||(setModalContent("xxAddAgent","Send Message","<textarea id=d2smsText maxlength=160 style=width:100%;height:100px;resize:none onKeyUp=showSendSMSValidate()></textarea><span style=font-size:10px><span>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showSendMessageEx(3,e)),Q("d2smsText").focus(),showSendSMSValidate())}function showSendMessageEx(e,t){Q("d2smsText").value.length>0&&meshserver.send({action:"msguser",userid:decodeURIComponent(t),msg:Q("d2smsText").value})}function showSendEmail(e){if(!xxdialogMode){setModalContent("xxAddAgent","Отправить электронное письмо",'<input id=d2emailSubject style=width:100% placeholder="Тема"></input><textarea id=d2emailText maxlength=10000 style="width:100%;height:200px;resize:none;overflow-y:auto" onKeyUp=showSendEmailValidate()></textarea>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showSendEmailEx(3,e)),Q("d2emailSubject").focus(),showSendEmailValidate()}}function showSendEmailValidate(){QE("idx_dlgOkButton",Q("d2emailSubject").value.length>0&&Q("d2emailText").value.length>0)}function showSendEmailEx(e,t){Q("d2emailText").value.length>0&&meshserver.send({action:"emailuser",userid:decodeURIComponent(t),subject:Q("d2emailSubject").value,msg:Q("d2emailText").value})}function showUserAlertDialog(e,t){if(!xxdialogMode){haltEvent(e);return setModalContent("xxAddAgent",format("Уведомить {0}",EscapeHtml(users[decodeURIComponent(t)].name)),'<div style=margin-bottom:6px>Отправить текстовое уведомление этому пользователю.</div><textarea id=d2notifyText maxlength=2048 style="width:100%;height:184px;resize:none"></textarea><select style=width:100% id=broadcastMessageMaxTime><option value=0>Показывать сообщение, пока оно не будет закрыто пользователем</option><option value=10>Показывать 10 секунд</option><option value=60>Показывать 1 минуту</option><option value=300>Показывать 5 минут</option></select>'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>showUserAlertDialogEx(3,t)),Q("d2notifyText").focus(),!1}}function showUserAlertDialogEx(e,t){meshserver.send({action:"notifyuser",userid:decodeURIComponent(t),msg:Q("d2notifyText").value,maxtime:parseInt(Q("broadcastMessageMaxTime").value)})}function onUsersViewSettings(){if(!xxdialogMode){null==userViewSettings&&(userViewSettings={});var e="";setModalContent("xxAddAgent","Просмотр пользователей",e+='<label><input id=d2c1 type=checkbox class="form-check-input me-2"'+(userViewSettings.noViewLimit?"":" checked")+">Отображать только первых 100 пользователей</label><br />"),showModal("xxAddAgentModal","idx_dlgOkButton",onUsersViewSettingsEx)}}function onUsersViewSettingsEx(){userViewSettings.noViewLimit=!Q("d2c1").checked,putstore("_usersViewSettings",JSON.stringify(userViewSettings)),mainUpdate(16384)}function p4batchAccountCreate(){if(!xxdialogMode){setModalContent("xxAddAgent","Импорт учетной записи пользователя",'Create many accounts at once by importing a JSON or CSV file<br /><br />JSON file format is as follows:<br /><pre>[\r\n {"user":"x1","pass":"x","email":"x1@x"},\r\n {"user":"x2","pass":"x","resetNextLogin":true}\r\n]</pre><br />CSV file format is as follows:<br /><pre>user,pass,email,resetNextLogin\r\nx1,x,x1@x,\r\nx2,x,,true\r\n</pre><br /><input type=file id=d4importFile class="form-control" accept=".json,.csv" onchange=p4batchAccountCreateValidate() />'),showModal("xxAddAgentModal","idx_dlgOkButton",p4batchAccountCreateEx)}}function p4batchAccountCreateValidate(){QE("idx_dlgOkButton",null!=Q("d4importFile").value)}function p4batchAccountCreateEx(){var e=new FileReader;e.onload=function(e){var t=null;if(Q("d4importFile").value.endsWith(".csv")){const i=e.target.result.split("\n"),a=i[0].trim().split(","),s=[];for(let e=1;e<i.length;e++){const t=i[e].trim();if(""===t)continue;const n=t.split(",");let o=!1;for(let e=0;e<n.length;e++)if(""!==n[e].trim()){o=!0;break}if(!o)continue;const r={};for(let e=0;e<a.length;e++){const t=n[e].trim();""!==a[e].trim()&&""!==t&&(r[a[e]]="true"===t.toLowerCase()||t)}s.push(r)}if(null!=(t=s)&&Array.isArray(t)){var n=!0;for(var o in t)("string"!=typeof t[o].user||t[o].user.length<1||t[o].user.length>64)&&(n=!1),("string"!=typeof t[o].pass||t[o].pass.length<1||t[o].pass.length>256)&&(n=!1),0==checkPasswordRequirements(t[o].pass,passRequirements)&&(n=!1),null!=t[o].email&&("string"!=typeof t[o].email||t[o].email.length<1||t[o].email.length>128)&&(n=!1);0==n?setModalContent("xxAddAgent","Импорт учетной записи пользователя","Invalid CSV file format."):meshserver.send({action:"adduserbatch",users:t})}else setModalContent("xxAddAgent","Импорт учетной записи пользователя","Invalid CSV file format.")}else{try{t=JSON.parse(e.target.result)}catch(e){return setModalContent("xxAddAgent","Импорт учетной записи пользователя",format("Некорректный файл JSON: {0}.",e)),void showModal("xxAddAgentModal","idx_dlgOkButton")}if(null!=t&&Array.isArray(t)){n=!0;for(var o in t)("string"!=typeof t[o].user||t[o].user.length<1||t[o].user.length>64)&&(n=!1),("string"!=typeof t[o].pass||t[o].pass.length<1||t[o].pass.length>256)&&(n=!1),0==checkPasswordRequirements(t[o].pass,passRequirements)&&(n=!1),null!=t[o].email&&("string"!=typeof t[o].email||t[o].email.length<1||t[o].email.length>128)&&(n=!1);0==n?setModalContent("xxAddAgent","Импорт учетной записи пользователя","Некорректный формат файла JSON."):meshserver.send({action:"adduserbatch",users:t})}else setModalContent("xxAddAgent","Импорт учетной записи пользователя","Некорректный формат файла JSON.");showModal("xxAddAgentModal","idx_dlgOkButton")}},e.readAsText(Q("d4importFile").files[0])}function p4downloadUserInfo(){if(!xxdialogMode){var e="Скачайте список пользователей в одном из форматов доступных ниже.<br /><br />";e+=addHtmlValue("Формат CSV","<a href=# style=cursor:pointer onclick='return p4downloadUserInfoCSV()'>userlist.csv</a>"),setModalContent("xxAddAgent","Экспортировать список пользователей",e+=addHtmlValue("Формат JSON","<a href=# style=cursor:pointer onclick='return p4downloadUserInfoJSON()'>userlist.json</a>")),showModal("xxAddAgentModal","idx_dlgOkButton")}}function p4downloadUserInfoCSV(){var e="id,name,email,creation,lastlogin,groups,authfactors,siteadmin,useradmin,locked\r\n";for(var t in users){var n=!1,o=[];(users[t].otpsecret>0||users[t].otphkeys>0)&&(n=!0,users[t].otpsecret>0&&o.push("AuthApp"),users[t].otphkeys>0&&o.push("SecurityKey"),users[t].otpkeys>0&&o.push("BackupCodes")),e+='"'+users[t]._id+'","'+users[t].name+'","'+(users[t].email?users[t].email:"")+'","'+(users[t].creation?new Date(1e3*users[t].creation):"")+'","'+(users[t].login?new Date(1e3*users[t].login):"")+'","'+(users[t].groups?users[t].groups.join(","):"")+'","'+(n?o.join(","):"")+'"',e+=","+(4294967295==users[t].siteadmin?"1":"0"),e+=","+(2&users[t].siteadmin?"1":"0"),e+=","+(32&users[t].siteadmin?"1":"0"),e+="\r\n"}return saveAs(stringToUtf8Blob(e),"userlist.csv"),!1}function p4downloadUserInfoJSON(){var e=[];for(var t in users)e.push(users[t]);return saveAs(new Blob([JSON.stringify(e,null,2)],{type:"application/octet-stream"}),"userlist.json"),!1}function showUserBroadcastDialog(e){if(!xxdialogMode){setModalContent("xxAddAgent","Отправить сообщение",'<div style=margin-bottom:6px>Отправить сообщение всем подключенным пользователям.</div><textarea id=broadcastMessage class="form-control mb-2" style="width:100%;height:184px;resize:none" value="" maxlength=2048 /></textarea><select style=width:100% class="form-select" id=broadcastMessageMaxTime><option value=0>Показывать сообщение, пока оно не будет закрыто пользователем</option><option value=10>Показывать 10 секунд</option><option value=60>Показывать 1 минуту</option><option value=300>Показывать 5 минут</option></select>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){showUserBroadcastDialogEx(3,e?decodeURIComponent(e):null)}),Q("broadcastMessage").focus()}}function showUserBroadcastDialogEx(e,t){meshserver.send({action:"userbroadcast",msg:Q("broadcastMessage").value,target:t,maxtime:parseInt(Q("broadcastMessageMaxTime").value)})}function showCreateNewAccountDialog(){if(!xxdialogMode){var e="";if(serverinfo.crossDomain){var t='<select class="form-select" id=p4domain>';for(var n in serverinfo.crossDomain)t+="<option value="+n+">"+(""==serverinfo.crossDomain[n]?"По умолчанию":EscapeHtml(serverinfo.crossDomain[n]))+"</option>";e+=addHtmlFormFloating("Домен",t+="</select>")}if(2097152&features||(e+=addHtmlFormFloating("<span id=p4hname>Имя пользователя</span>",'<input id=p4name class="form-control" maxlength=64 autocomplete=username onchange=showCreateNewAccountDialogValidate() onkeyup=showCreateNewAccountDialogValidate() />')),e+=addHtmlFormFloating("<span id=p4hemail>Email",'<input id=p4email type=email class="form-control" maxlength=256 autocomplete="email" inputmode="email" onchange=showCreateNewAccountDialogValidate() onkeyup=showCreateNewAccountDialogValidate() />'),e+="",e+=addHtmlFormFloating("<span id=p4hp1>Пароль</span>",'<input id=p4pass1 type=password class="form-control" maxlength=256 autocomplete="new-password" onchange=showCreateNewAccountDialogValidate() onkeyup=showCreateNewAccountDialogValidate() />'),e+=addHtmlFormFloating("<span id=p4hp2>Confirm Password</span>",'<input id=p4pass2 type=password class="form-control" maxlength=256 autocomplete="new-password" onchange=showCreateNewAccountDialogValidate() onkeyup=showCreateNewAccountDialogValidate() />'),e+='<div><label><input id=p4randomPassword onchange=showCreateNewAccountDialogValidate() type=checkbox class="form-check-input me-2" />Случайный пароль.</label></div>',e+='<div><label><input id=p4removeEvents onchange=showCreateNewAccountDialogValidate() type=checkbox class="form-check-input me-2" />Удалить все прошлые события для этого userid.</label></div>',e+='<div><label><input id=p4resetNextLogin onchange=showCreateNewAccountDialogValidate() type=checkbox class="form-check-input me-2" />Принудительно сбросить пароль при следующем входе в систему.</label></div>',serverinfo.emailcheck&&(e+='<div><label><input id=p4verifiedEmail onchange=showCreateNewAccountDialogValidate() type=checkbox class="form-check-input me-2" />Email подтвержден.</label></div>',e+='<div><label><input id=p4invitationEmail type=checkbox class="form-check-input me-2" title=Электронная почта подтверждена и требуется принудительный сброс пароля. />Отправить приглашение по email.</label></div>'),passRequirements){var o=[],i=0;for(var n in passRequirements)"reset"!=n&&"hint"!=n&&(o.push(n+":"+passRequirements[n]),i++);i>0&&(e+="<div style=font-size:x-small;padding:6px>"+format("Требования: {0}.",o.join(", "))+"</div>")}setModalContent("xxAddAgent","Создать учетную запись",e),showModal("xxAddAgentModal","idx_dlgOkButton",showCreateNewAccountDialogEx),showCreateNewAccountDialogValidate(),2097152&features?Q("p4email").focus():Q("p4name").focus()}}function showCreateNewAccountDialogValidate(){var e=validateEmail(Q("p4email").value),t=!0,n=Q("p4pass1").value.length>0&&Q("p4pass1").value==Q("p4pass2").value&&checkPasswordRequirements(Q("p4pass1").value,passRequirements);2097152&features||(t=!Q("p4name")||Q("p4name").value.length>0&&-1==Q("p4name").value.indexOf(" "),QS("p4hname").color=t?"black":"#7b241c"),QS("p4hemail").color=e?"black":"#7b241c",serverinfo.emailcheck&&(QE("p4verifiedEmail",e),QE("p4invitationEmail",e&&Q("p4resetNextLogin").checked&&Q("p4verifiedEmail").checked),0==e&&(Q("p4verifiedEmail").checked=!1),0!=Q("p4resetNextLogin").checked&&0!=Q("p4verifiedEmail").checked||(Q("p4invitationEmail").checked=!1)),QE("p4pass1",!Q("p4randomPassword").checked),QE("p4pass2",!Q("p4randomPassword").checked),QS("p4hp1").color=n||Q("p4randomPassword").checked?"black":"#7b241c",QS("p4hp2").color=n||Q("p4randomPassword").checked?"black":"#7b241c";var o=t&e;0==Q("p4randomPassword").checked&&(o&=n),QE("idx_dlgOkButton",o)}function showCreateNewAccountDialogEx(){var e={action:"adduser",username:2097152&features?Q("p4email").value:Q("p4name").value,email:Q("p4email").value,pass:Q("p4pass1").value,resetNextLogin:Q("p4resetNextLogin").checked,randomPassword:Q("p4randomPassword").checked,removeEvents:Q("p4removeEvents").checked};serverinfo.emailcheck&&(e.emailVerified=Q("p4verifiedEmail").checked,e.emailInvitation=Q("p4invitationEmail").checked),serverinfo.crossDomain&&(e.domain=serverinfo.crossDomain[parseInt(Q("p4domain").value)]),meshserver.send(e)}function showUserGroupDialog(e,t){if(!xxdialogMode){haltEvent(e),t=decodeURIComponent(t);var n=users[t.toLowerCase()],o="";null!=n.groups&&(o=n.groups.join(", "));var i="Введите разделенный запятыми список имен административных областей.<br /><br />";return setModalContent("xxAddAgent","Административные области",i+=`<div class="form-floating mb-2"><input id=dp4usergroups value="${o}" class="form-control" placeholder="Name1, Name2, Name3" maxlength=256 onchange=p4validateUserGroups() onkeyup=p4validateUserGroups() /><label for=dp4usergroups>Realms</label></div>`),showModal("xxAddAgentModal","idx_dlgOkButton",function(){showUserGroupDialogEx(e,n)}),focusTextBox("dp4usergroups"),p4validateUserGroups(),!1}}function p4validateUserGroups(){var e=Q("dp4usergroups").value,t=0,n=e.indexOf('"')+e.indexOf("/")+e.indexOf(">")+e.indexOf("<")+e.indexOf("'"),o=e.split(",");for(var i in o)0==o[i].trim().length&&t++;QE("idx_dlgOkButton",""==e||-5==n&&t<1)}function showUserGroupDialogEx(e,t){var n=Q("dp4usergroups").value.split(","),o=[];for(var i in n){var a=n[i].trim();a.length>0&&o.push(a)}meshserver.send({action:"edituser",id:t._id,groups:o})}function showUserAdminDialog(e,t){if(!xxdialogMode){haltEvent(e),t=decodeURIComponent(t);var n=users[t];if(null!=n){var o=userinfo._id==n._id,i="";return i+='<div class="d-inline-flex align-items-center"><label class="form-label me-2"><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_fileaccess>Серверные файлы</label>, <input type=number class="me-1 form-control" onchange=showUserAdminDialogValidate() maxlength=10 id=ua_fileaccessquota>k макс, пусто - по умолчанию</div><br><hr/>',i+='<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_fulladmin>Администратор с полным доступом</label><br>',i+='<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_serverbackup>Резервное копирование сервера</label><br>',i+='<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_serverrestore>Восстановление сервера</label><br>',i+='<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_serverupdate>Обновление сервера</label><br></div>',i+='<div id=d2MngUsr><label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_manageusers>Управление пользователями</label><br></div>',i+='<div id=d2MngGrp><label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_manageusergroups>Управление группами пользователей</label><br></div>',i+='<div id=d2MngRec><label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_managerecordings>Управление записями</label><br></div>',""!=(i+='<div id=d2AllEvnt><label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_allevents>Просмотр всех событий</label><br></div>')&&(i+="<hr/>"),i="<div><div id=d2AdminPermissions>"+i,i+='<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_lockedaccount>Заблокировать учетную запись</label><br>',i+='<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_nonewgroups>Запретить создание групп устройств</label><br>',i+='<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_nonewdevices>Запретить добавление новых устройств</label><br>',i+='<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_nomeshcmd>Нет доступа к инструментам (MeshCmd/Router)</label><br>',i+='<label><input type=checkbox onchange=showUserAdminDialogValidate() class="form-check-input me-2" id=ua_locksettings>Заблокировать настройки учетной записи</label><br>',setModalContent("xxAddAgent","Разрешения сервера",i+="</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){showUserAdminDialogEx(2+(o?0:1),n)}),n.siteadmin&&0!=n.siteadmin&&(Q("ua_fulladmin").checked=4294967295==n.siteadmin,Q("ua_serverbackup").checked=4294967295!=n.siteadmin&&!!(1&n.siteadmin),Q("ua_serverrestore").checked=4294967295!=n.siteadmin&&!!(4&n.siteadmin),Q("ua_fileaccess").checked=4294967295!=n.siteadmin&&!!(8&n.siteadmin),Q("ua_serverupdate").checked=4294967295!=n.siteadmin&&!!(16&n.siteadmin),Q("ua_lockedaccount").checked=4294967295!=n.siteadmin&&!!(32&n.siteadmin),Q("ua_nonewgroups").checked=4294967295!=n.siteadmin&&!!(64&n.siteadmin),Q("ua_nomeshcmd").checked=4294967295!=n.siteadmin&&!!(128&n.siteadmin),Q("ua_locksettings").checked=4294967295!=n.siteadmin&&!!(1024&n.siteadmin),Q("ua_nonewdevices").checked=4294967295!=n.siteadmin&&!!(4096&n.siteadmin)),2&userinfo.siteadmin&&(Q("ua_manageusers").checked=4294967295!=n.siteadmin&&!!(2&n.siteadmin),QE("ua_manageusers",!o&&2&userinfo.siteadmin)),256&userinfo.siteadmin&&(Q("ua_manageusergroups").checked=4294967295!=n.siteadmin&&!!(256&n.siteadmin),QE("ua_manageusergroups",!o&&256&userinfo.siteadmin)),512&userinfo.siteadmin&&(Q("ua_managerecordings").checked=4294967295!=n.siteadmin&&!!(512&n.siteadmin),QE("ua_managerecordings",!o&&512&userinfo.siteadmin)),2048&userinfo.siteadmin&&(Q("ua_allevents").checked=4294967295!=n.siteadmin&&!!(2048&n.siteadmin),QE("ua_allevents",!o&&2048&userinfo.siteadmin)),QE("ua_fulladmin",!o&&4294967295==userinfo.siteadmin),QE("ua_serverbackup",!o&&4294967295==userinfo.siteadmin),QE("ua_serverrestore",!o&&4294967295==userinfo.siteadmin),QE("ua_fileaccess",!o&&4294967295==userinfo.siteadmin),QE("ua_fileaccessquota",!o&&4294967295==userinfo.siteadmin),QE("ua_serverupdate",!o&&4294967295==userinfo.siteadmin),QV("d2AdminPermissions",4294967295==userinfo.siteadmin),QV("d2MngUsr",!!(2&userinfo.siteadmin)),QV("d2MngGrp",!!(256&userinfo.siteadmin)),QV("d2MngRec",!!(512&userinfo.siteadmin)),QE("ua_lockedaccount",!o&&2&userinfo.siteadmin&&4294967295!=n.siteadmin&&userinfo._id!=n._id),QE("ua_nonewgroups",!o&&2&userinfo.siteadmin&&4294967295!=n.siteadmin&&userinfo._id!=n._id),QE("ua_nomeshcmd",!o&&2&userinfo.siteadmin&&4294967295!=n.siteadmin&&userinfo._id!=n._id),QE("ua_nonewdevices",!o&&2&userinfo.siteadmin&&4294967295!=n.siteadmin&&userinfo._id!=n._id),QE("ua_locksettings",!o&&2&userinfo.siteadmin&&4294967295!=n.siteadmin&&userinfo._id!=n._id),Q("ua_fileaccessquota").value=null!=n.quota?n.quota/1024:"",showUserAdminDialogValidate(),!1}}}function showUserAdminDialogValidate(){4294967295==userinfo.siteadmin&&(QE("ua_serverbackup",!Q("ua_fulladmin").checked),QE("ua_manageusers",!Q("ua_fulladmin").checked),QE("ua_serverrestore",!Q("ua_fulladmin").checked),QE("ua_fileaccess",!Q("ua_fulladmin").checked),QE("ua_serverupdate",!Q("ua_fulladmin").checked),QE("ua_lockedaccount",!Q("ua_fulladmin").checked),QE("ua_nonewgroups",!Q("ua_fulladmin").checked),QE("ua_nomeshcmd",!Q("ua_fulladmin").checked),QE("ua_nonewdevices",!Q("ua_fulladmin").checked),QE("ua_manageusergroups",!Q("ua_fulladmin").checked),QE("ua_managerecordings",!Q("ua_fulladmin").checked),QE("ua_allevents",!Q("ua_fulladmin").checked),QE("ua_locksettings",!Q("ua_fulladmin").checked),QE("ua_fileaccessquota",Q("ua_fileaccess").checked&&!Q("ua_fulladmin").checked))}function showUserAdminDialogEx(e,t){var n=0,o=parseInt(Q("ua_fileaccessquota").value);1==Q("ua_fulladmin").checked?n=4294967295:(1==Q("ua_serverbackup").checked&&(n+=1),1==Q("ua_manageusers").checked&&(n+=2),1==Q("ua_serverrestore").checked&&(n+=4),1==Q("ua_fileaccess").checked&&(n+=8),1==Q("ua_serverupdate").checked&&(n+=16),1==Q("ua_lockedaccount").checked&&(n+=32),1==Q("ua_nonewgroups").checked&&(n+=64),1==Q("ua_nomeshcmd").checked&&(n+=128),1==Q("ua_manageusergroups").checked&&(n+=256),1==Q("ua_managerecordings").checked&&(n+=512),1==Q("ua_locksettings").checked&&(n+=1024),1==Q("ua_allevents").checked&&(n+=2048),1==Q("ua_nonewdevices").checked&&(n+=4096));var i={action:"edituser",id:t._id,siteadmin:n};0==isNaN(o)&&(i.quota=1024*o),meshserver.send(i)}function onUserSearchInputChanged(){mainUpdate(16384)}function updateUserGroups(){QV("p50userGroupOps",!!(256&userinfo.siteadmin));var e=[],t="";if(usergroups)for(var n in usergroups)e.push(usergroups[n]);e.sort(nameSort);var o=[],i=document.getElementsByClassName("UserGroupCheckbox");for(n=0;n<i.length;n++)i[n].checked&&o.push(i[n].value);if(0==e.length)t+="<br />Группы не найдены.<br />",QV("DuplicateUserGroupButton",!1);else{for(var n in t+='<table class="table table-hover p3usersTable" cellpadding=0 cellspacing=0>',t+="<th>Имя<th style=width:80px>Пользователи<th style=width:80px>Группы устройств<th style=width:80px>Устройства",e)t+=addUserGroupHtml(e[n]);t+="</table>",QV("DuplicateUserGroupButton",!0)}QH("p50groups",t),i=document.getElementsByClassName("UserGroupCheckbox");for(n=0;n<i.length;n++)i[n].checked=o.indexOf(i[n].value)>=0;p50updateInfo(),null!=currentUserGroup&&51==xxcurrentView&&gotoUserGroup(encodeURIComponentEx(currentUserGroup._id),!0)}function addUserGroupHtml(e){var t=0,n=0,o=0;if(e.links)for(var i in e.links)i.startsWith("user/")&&t++,i.startsWith("mesh/")&&n++,i.startsWith("node/")&&o++;var a=EscapeHtml(e.name);if(null!=serverinfo.crossDomain){var s=e._id.split("/")[1];""!=s&&(a+=", <span style=color:#26F>"+EscapeHtml(s)+"</span>")}var r="<tr tabindex=0 onkeypress=\"if (event.key=='Enter') gotoUserGroup('"+encodeURIComponentEx(e._id)+"')\"><td style=cursor:pointer>";return r+="<div style=width:100%>",r+='<div class=baricon><input class="form-check-input me-2 UserGroupCheckbox" value='+encodeURIComponentEx(e._id)+" onclick=p50updateInfo() type=checkbox></div>",r+='<div class=baricon onclick=gotoUserGroup("'+encodeURIComponentEx(e._id)+'")><i class="fa-solid fa-users"></i></div>',r+='<div onclick=gotoUserGroup("'+encodeURIComponentEx(e._id)+'")></div><div onclick=gotoUserGroup("'+encodeURIComponentEx(e._id)+'")></div>',r+='<div style=line-height:24px onclick=gotoUserGroup("'+encodeURIComponentEx(e._id)+'")><span style=font-size:16px>'+a+"</span></div></div><td style=text-align:center>"+t+"<td style=text-align:center>"+n+"<td style=text-align:center>"+o}function p50updateInfo(){for(var e=document.getElementsByClassName("UserGroupCheckbox"),t=0,n=0;n<e.length;n++)!0===e[n].checked&&t++;QE("UsersGroupsGroupActionButton",t>0),Q("UsersGroupsSelectAllButton").value=t>0?"Очистить все":"Выбрать все"}function p50usersSelectallButtonFunction(){for(var e=encodeURIComponentEx(userinfo._id),t=document.getElementsByClassName("UserGroupCheckbox"),n=0,o=0;o<t.length;o++)!0===t[o].checked&&n++;for(o=0;o<t.length;o++)t[o].checked=0==n&&t[o].value!=e;p50updateInfo()}function p50usersGroupActionFunction(){for(var e=document.getElementsByClassName("UserGroupCheckbox"),t=0,n=0;n<e.length;n++)!0===e[n].checked&&t++;if(0!=t){var o="Выберите операцию, которую нужно выполнить для всех выбранных пользователей.<br /><br />";o+=addHtmlFormFloating("Операция","<select id=d50groupop class=form-select><option value=1>Удалить группу</option></select>"),xxdialogButtons=3,setModalContent("xxAddAgent","Групповое действие",o),showModal("xxAddAgentModal","idx_dlgOkButton",p50usersGroupActionFunctionEx)}}function p50usersGroupActionFunctionEx(){for(var e=document.getElementsByClassName("UserGroupCheckbox"),t=[],n=0;n<e.length;n++)!0===e[n].checked&&t.push(decodeURIComponent(e[n].value));if(1==Q("d50groupop").value){setModalContent("xxAddAgent","Удалить группы пользователей",'Подтвердить удаление выбранных групп пользователей?<br /><br /><label><input id=d3check type=checkbox class="form-check-input me-2" onchange=p50usersGroupActionFunctionDelCheck() />Подтвердить</label>'),document.getElementById("idx_dlgOkButton").onclick=function(){p50groupActionFunctionDelExec(3)}}}function p50usersGroupActionFunctionDelCheck(){QE("idx_dlgOkButton",Q("d3check").checked)}function p50groupActionFunctionDelExec(e){for(var t=document.getElementsByClassName("UserGroupCheckbox"),n=0;n<t.length;n++)!0===t[n].checked&&meshserver.send({action:"deleteusergroup",ugrpid:decodeURIComponent(t[n].value)})}function showCreateUserGroupDialog(e){if(!xxdialogMode){var t="",n="";if(2==e){if(usergroups)for(var o in usergroups)n+="<option value="+encodeURIComponentEx(o)+">"+EscapeHtml(usergroups[o].name)+"</option>";t+=addHtmlFormFloating("Группа пользователей",'<select id=dp4groupid class="form-select">'+n+"</select>")}if(1==e&&serverinfo.crossDomain){n='<select id=p4domain class="form-select">';for(var o in serverinfo.crossDomain)n+="<option value="+o+">"+(""==serverinfo.crossDomain[o]?"По умолчанию":EscapeHtml(serverinfo.crossDomain[o]))+"</option>";t+=addHtmlFormFloating("Домен",n+="</select>")}t+=addHtmlFormFloating("Имя","<input id=p4name class=form-control maxlength=64 onchange=showCreateUserGroupDialogValidate() onkeyup=showCreateUserGroupDialogValidate() />"),t+=addHtmlFormFloating("Описание",'<textarea id=p4desc class=form-control value="" maxlength=1024 /></textarea>'),setModalContent("xxAddAgent",1==e?"Создать группу пользователей":"Скопировать группу пользователей",t),showModal("xxAddAgentModal","idx_dlgOkButton",function(){showCreateUserGroupDialogEx(3,e)}),showCreateUserGroupDialogValidate(),Q("p4name").focus()}}function showCreateUserGroupDialogValidate(){QE("idx_dlgOkButton",Q("p4name").value.length>0)}function showCreateUserGroupDialogEx(e,t){var n={action:"createusergroup",name:Q("p4name").value,desc:Q("p4desc").value};2==t&&(n.clone=decodeURIComponent(Q("dp4groupid").value)),1==t&&serverinfo.crossDomain&&(n.domain=serverinfo.crossDomain[parseInt(Q("p4domain").value)]),meshserver.send(n)}var currentUserGroup=null;function gotoUserGroup(e,t){if(!xxdialogMode||t){var n=currentUserGroup=usergroups?usergroups[decodeURIComponent(e)]:null;if(null!=n){var o=EscapeHtml(n.name);0==o.length&&(o="<i>Пусто</i>"),null==currentUserGroup.membershipType&&256&userinfo.siteadmin&&(o='<span role=button tabindex=0 title="Нажмите здесь, чтобы изменить имя группы пользователей" onclick=p51editgroup(1) onkeyup="if (event.key == \'Enter\') p51editgroup(1)">'+o+'  <i class="fa-solid fa-pencil fa-2xs"/></i></span>'),QH("p51groupName",o);var i=0,a=0,s=0;if(n.links)for(var r in n.links)r.startsWith("user/")&&i++,r.startsWith("mesh/")&&a++,r.startsWith("node/")&&s++;var l=n.desc;l=null==l||""==l?"<i>Пусто<i>":EscapeHtml(l);var d="<div style=min-height:80px><table style=width:100%>";if(8&args.hide&&(d+="<br />"+addDeviceAttribute("Имя",o)),null!=serverinfo.crossDomain||0!=debugmode){var c=n._id.split("/")[1];d+=addDeviceAttribute("Домен",""!=c?EscapeHtml(c):"<i>По умолчанию</i>"),d+=addDeviceAttribute("Идентификатор группы",EscapeHtml(n._id))}if(null!=currentUserGroup.membershipType&&(d+=addDeviceAttribute("Group Type",EscapeHtml(currentUserGroup.membershipType))),256&userinfo.siteadmin?d+=addDeviceAttribute("Описание","<span role=button onclick=p51editgroup(2,"+(null!=currentUserGroup.membershipType)+")>"+l+' <i class="fa-solid fa-pencil fa-xs"/></i></span>'):d+=addDeviceAttribute("Описание",l),1==serverinfo.userGroupsSessionRecording){var u=[];n.flags&&2&n.flags&&u.push("Запись сеансов"),""==(u=u.join(", "))&&(u="<i>Пусто</i>"),d+=addDeviceAttribute("Функции",addLink(u,"p51edituserGroupFeatures()"))}var p=[],m=0;n.consent&&(m=n.consent),serverinfo.consent&&(m|=serverinfo.consent),64&m&&8&m?p.push("Рабочий стол: запросить + панель-уведомление"):64&m?p.push("Панель-уведомление на экране"):8&m?p.push("Рабочий стол: запросить"):1&m&&p.push("Рабочий стол: уведомить"),16&m?p.push("Терминал: запросить"):2&m&&p.push("Терминал: уведомить"),32&m?p.push("Файлы: запросить"):4&m&&p.push("Файлы: уведомить"),7==m&&(p=["Всегда уведомлять"]),56&~m||(p=["Всегда запрашивать"]),""==(p=p.join(", "))&&(p="<i>Пусто</i>"),d+=addDeviceAttribute("Согласие пользователя",addLinkConditional(p,"p20editmeshconsent(4)",!0)),d+=addDeviceAttribute("Пользователи",i),d+=addDeviceAttribute("Группы устройств",a),d+=addDeviceAttribute("Устройства",s),d+="</table></div><br />",256&userinfo.siteadmin&&(d+='<input type=button class="btn btn-primary btn-sm" value="Отправить сообщение" title="Отправить уведомление всем пользователям этой группы." onclick=showUserBroadcastDialog("'+encodeURIComponentEx(n._id)+'") />'),QH("p51group",d),d="<br />",null==currentUserGroup.membershipType&&256&userinfo.siteadmin&&(d+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p51showAddUserDialog()"><i class="fa-solid fa-circle-plus"></i> Добавить пользователей</button>'),d+='<table class="table table-hover"><tbody><tr class="table-active"><th scope=col>Члены группы</th><th scope=col></th></tr>';var g=1,v=[];for(var r in currentUserGroup.links)if(0!=r.startsWith("user/")){var h=r.split("/")[2];currentUserGroup.links[r].name&&(h=currentUserGroup.links[r].name),r==userinfo._id&&(h=userinfo.name),v.push({id:r,name:h,rights:currentUserGroup.links[r].rights})}for(var r in v.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0}),v){var f="";null==currentUserGroup.membershipType&&(f="<a href=# onclick='return p51deleteUser(event,\""+encodeURIComponentEx(v[r].id)+'")\' title="Удалить права пользователя для этой группы устройств" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>');var x=EscapeHtml(decodeURIComponent(v[r].name));null!=users&&(x="<a href=# onclick='gotoUser(\""+encodeURIComponentEx(v[r].id)+"\");haltEvent(event);'>"+x+"</a>"),d+="<tr "+(g%2==0?"style=background-color:#DDD":"")+'><td><i class="fa-solid fa-user fa-fw" title="Пользователь"></i>&nbsp;'+x+"</td><td><div style=float:right>"+f+"</div></td></tr>",++g}1==g&&(d+="<tr><td><div style=padding:6px>&nbsp;<i>Нет членов</i><div></div></div></td><td></td></tr>"),d+="</tbody></table><br />",g=1;var k=0,y=!1;for(var r in meshes)currentUserGroup._id.split("/")[1]==meshes[r]._id.split("/")[1]&&(k++,null!=currentUserGroup.links&&null!=currentUserGroup.links[r]||(y=!0));if(k>0&&y&&(d+='<button class="btn btn-primary btn-sm me-2 mb-1"onclick="return p20showAddMeshUserDialog(3)"><i class="fa-solid fa-circle-plus"></i> Добавить группу устройств</button>'),d+='<table class="table table-hover"><tbody><tr class="table-active"><th scope=col>Общие группы устройств</th><th scope=col></th></tr>',currentUserGroup.links){var b=[];for(var r in currentUserGroup.links)r.startsWith("mesh/")&&null!=meshes[r]&&b.push(meshes[r]);for(var r in b=getOrderedList(b,"name")){var w=0,M=b[r],C=(f="",makeDeviceGroupRightsString(currentUserGroup.links[M._id].rights));userinfo.links&&null!=userinfo.links[M._id]&&null!=userinfo.links[M._id].rights&&(w=userinfo.links[M._id].rights);var S="<i>Неизвестная группа устройств</i>";M&&(S="<a href=# onclick='gotoMesh(\""+M._id+"\");haltEvent(event);'>"+M.name+"</a>"),2&w&&(f="<a href=# onclick='return p51removeMeshFromUserGroup(event,\""+encodeURIComponentEx(M._id)+'")\' title="Удалить права группы пользователей для этой группы устройств" style=cursor:pointer><i class="fa-solid fa-trash text-danger hoverButton"></i></a>',C='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(3,"'+encodeURIComponentEx(M._id)+'")>'+C+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"),d+="<tr "+(++g%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="Группа устройств" class=m99></div><div>&nbsp;'+S+"<div></div></div></td><td style=width:70%><div style=float:right>"+f+"</div><div>"+C+"</div></td></tr>"}}if(1==g&&(d+="<tr><td><div style=padding:6px>&nbsp;<i>Нет общих групп устройств</i><div></div></div></td><td></td></tr>"),d+="</tbody></table>",g=1,d+="<br />",currentUserGroup._id.split("/")[1]==userinfo._id.split("/")[1]&&(d+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p20showAddMeshUserDialog(7)"><i class="fa-solid fa-circle-plus"></i> Добавить устройство</button>'),d+='<table class="table table-hover"><tbody><tr class="table-active"><th scope=col>Общие устройства</th><th scope=col></th></tr>',currentUserGroup.links){var Q=[];for(var r in currentUserGroup.links){if(r.startsWith("node/"))null!=(A=getNodeFromId(r))&&Q.push(A)}for(var r in Q=getOrderedList(Q,"name")){var A=Q[r],D=(f="",C=makeUserDeviceRightsString(currentUserGroup.links[A._id].rights),w=GetNodeRights(A),"<i>Неизвестное устройство</i>");A&&(D="<a href=# onclick='gotoDevice(\""+A._id+"\");haltEvent(event);'>"+A.name+"</a>"),2&w&&(f="<a href=# onclick='return p51removeDeviceFromUserGroup(event,\""+encodeURIComponentEx(A._id)+'")\' title="Удалить права группы пользователей на это устройство" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',C='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(7,"'+encodeURIComponentEx(A._id)+'")>'+C+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"),d+="<tr "+(++g%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="Группа устройств" class=m99></div><div>&nbsp;'+D+"<div></div></div></td><td style=width:70%><div style=float:right>"+f+"</div><div>"+C+"</div></td></tr>"}}1==g&&(d+="<tr><td><div style=padding:6px>&nbsp;<i>Нет общих устройств</i><div></div></div></td><td></td></tr>"),d+="</tbody></table>",(null==currentUserGroup.membershipType||0==i)&&256&userinfo.siteadmin&&(d+="<div style=font-size:small;text-align:right><span><a href=# onclick=p51showDeleteUserGroupDialog() style=cursor:pointer>Удалить группу пользователей</a></span></div>"),QH("p51group2",d),go(51);var T="";if(!(268435456&features)&&xxcurrentView>=51&&xxcurrentView<=59&&null!=currentUserGroup){for(var r in T="?viewmode="+xxcurrentView+"&gotougrp="+(serverinfo.crossDomain?currentUserGroup._id:currentUserGroup._id.split("/")[2]),urlargs)T+="&"+r+"="+urlargs[r];try{window.history.replaceState({},document.title,window.location.pathname+T)}catch(e){}}}else 51==xxcurrentView&&go(50)}}function p51edituserGroupFeatures(){if(!xxdialogMode){var e=currentUserGroup.flags?currentUserGroup.flags:0,t="";1==serverinfo.userGroupsSessionRecording&&(t+='<div><label><input type=checkbox class="form-check-input me-2" id=d51flag1 '+(2&e?"checked":"")+">Запись сеансов</label><br></div>"),xxdialogButtons=3,setModalContent("xxAddAgent","Редактировать функции групп пользователей",t),showModal("xxAddAgentModal","idx_dlgOkButton",p51edituserGroupFeaturesEx)}}function p51edituserGroupFeaturesEx(){var e=0;1==serverinfo.userGroupsSessionRecording&&Q("d51flag1").checked&&(e+=2),meshserver.send({action:"editusergroup",ugrpid:currentUserGroup._id,flags:e})}function p51removeDeviceFromUserGroup(e,t){if(!xxdialogMode){var n=getNodeFromId(decodeURIComponent(t));null!=n&&(setModalContent("xxAddAgent","Удалить разрешения устройства",format('Подтвердите удаление прав доступа для устройства "{0}"?',n.name)),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p51removeDeviceFromUserGroupEx(3,n._id)))}}function p51removeDeviceFromUserGroupEx(e,t){meshserver.send({action:"adddeviceuser",nodeid:t,userids:[currentUserGroup._id],rights:0,remove:!0})}function p51removeMeshFromUserGroup(e,t){if(!xxdialogMode){var n=meshes[decodeURIComponent(t)];null!=n&&(setModalContent("xxAddAgent","Удалить разрешения группы устройств",format('Подтвердить удаление прав доступа для группы устройств "{0}"?',n.name)),showModal("xxAddAgentModal","idx_dlgOkButton",()=>p51removeMeshFromUserGroupEx(3,n._id)))}}function p51editgroup(e,t){if(!xxdialogMode){var n=addHtmlFormFloating("Имя",'<input id=dp51name class="form-control" maxlength=32 onchange=p51editgroupValidate() onkeyup=p51editgroupValidate(event) '+(t?"readonly disabled":"")+"/>");n+=addHtmlFormFloating("Описание",'<textarea id=dp51desc class="form-control" maxlength=1024 style=width:100%;resize:none></textarea>'),xxdialogButtons=3,setModalContent("xxAddAgent","Редактировать группу пользователей",n),showModal("xxAddAgentModal","idx_dlgOkButton",p51editgroupEx),Q("dp51name").value=currentUserGroup.name,currentUserGroup.desc&&(Q("dp51desc").value=currentUserGroup.desc),p51editgroupValidate(),2==e?Q("dp51desc").focus():Q("dp51name").focus()}}function p51editgroupEx(){meshserver.send({action:"editusergroup",ugrpid:currentUserGroup._id,name:Q("dp51name").value,desc:Q("dp51desc").value})}function p51editgroupValidate(e){QE("idx_dlgOkButton",Q("dp51name").value.length>0),e&&"Enter"==e.key&&Q("dp51desc").focus()}function p51showDeleteUserGroupDialog(){if(xxdialogMode)return!1;var e=format("Удалить группу пользователей {0}?",EscapeHtml(currentUserGroup.name))+"<br /><br />";return xxdialogButtons=3,setModalContent("xxAddAgent","Удалить группу пользователей",e+='<label><input id=p51check type=checkbox class="form-check-input me-2" onchange=p51validateDeleteGroupDialog() />Подтвердить</label>'),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p51showDeleteUserGroupDialogEx(xxdialogButtons,xxdialogTag)}),p51validateDeleteGroupDialog(),!1}function p51validateDeleteGroupDialog(){QE("idx_dlgOkButton",Q("p51check").checked)}function p51showDeleteUserGroupDialogEx(e,t){meshserver.send({action:"deleteusergroup",ugrpid:currentUserGroup._id})}function p51deleteUser(e,t){return haltEvent(e),p51viewuserEx(2,decodeURIComponent(t)),!1}function p51viewuserEx(e,t){if(2==e){var n=t.split("/")[2];users&&users[t]&&(n=users[t].name),userinfo._id==t&&(n=userinfo.name),setModalContent("xxAddAgent","Удалить членство пользователя",format('Подтвердить удаление пользователя "{0}" из членства?',EscapeHtml(decodeURIComponent(n)))),showModal("xxAddAgentModal","idx_dlgOkButton",p51viewuserEx2(3,t))}}function p51viewuserEx2(e,t){meshserver.send({action:"removeuserfromusergroup",ugrpid:currentUserGroup._id,userid:t})}function p51showAddUserDialog(){if(xxdialogMode)return!1;var e="Разрешить пользователям управлять этой группой и устройствами этой группы.";return 524288&features&&(e+=" Для добавления в группу устройств, пользователь должен зайти на сервер хотя бы один раз."),e+="<br /><br /><div style='position:relative'>",e+=addHtmlFormFloating("Идентификаторы пользователей",'<input id=dp51username maxlength=32 class="form-control" onchange=p51validateAddUserDialog() onkeyup=p51validateAddUserDialog() placeholder="user1, user2, user3" />'),e+="<div id=dp51usersuggest class=suggestionBox style='top:30px;left:130px;display:none'></div>",setModalContent("xxAddAgent","Добавить пользователей в группу",e+="</div><br>"),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p51showAddUserDialogEx(3,xxdialogTag)}),Q("dp51username").focus(),p51validateAddUserDialog(),!1}function p51setname(e){e=decodeURIComponent(e);var t=Q("dp51username").value.split(",");for(var n in t)t[n]=t[n].trim();return t[t.length-1]=e,Q("dp51username").value=t.join(", "),p51validateAddUserDialog(),!1}function p51validateAddUserDialog(){var e=!0;if(Q("dp51username")){var t=Q("dp51username").value.split(",");for(var n in t){var o=t[n]=t[n].trim();(0==o.length||o.indexOf('"')>=0)&&(e=!1)}var i=!1,a=!1;if(null!=users){var s=t[t.length-1].trim(),r=s.toLowerCase(),l=[];if(s.length>0){for(var n in users){var d=users[n]._id.split("/");if(currentUserGroup.domain==d[1]&&d[2]===r){a=!0;break}if(users[n].name.toLowerCase().indexOf(r)>=0&&currentUserGroup.domain==d[1]&&(l.push([users[n]._id,users[n].name]),l.length>=8))break}if(0==a&&l.length>0){var c="";for(var n in l){var u=l[n][0],p=l[n][1];u.split("/")[2]==p.toLowerCase()?c+="<div class=suggestionBoxItem onclick='p51setname(\""+encodeURIComponentEx(u.split("/")[2])+"\")'>"+EscapeHtml(p)+"</div>":c+="<div class=suggestionBoxItem onclick='p51setname(\""+encodeURIComponentEx(u.split("/")[2])+"\")'><div>"+EscapeHtml(p)+"</div><div class=suggestionBoxSubItem>"+EscapeHtml(u.split("/")[2])+"</div></div>"}QH("dp51usersuggest",c),i=!0}}}QV("dp51usersuggest",i)}QE("idx_dlgOkButton",e)}function p51showAddUserDialogEx(e,t){if(null==t){var n=Q("dp51username").value.split(","),o=[];for(var i in n)o.push(n[i].trim());meshserver.send({action:"addusertousergroup",ugrpid:currentUserGroup._id,usernames:o})}else meshserver.send({action:"addusertousergroup",ugrpid:currentUserGroup._id,usernames:[t.split("/")[2]]})}var currentUser=null;function gotoUser(e,t,n){if((!xxdialogMode||t)&&(null==n||null==n.originalTarget||null==n.originalTarget.href)){var o=currentUser=users[decodeURIComponent(e)];if(null!=o){QH("p30userName",EscapeHtml(o.name)),QH("p31userName",EscapeHtml(o.name));var i=o._id==userinfo._id,a=0;null!=wssessions&&wssessions[o._id]&&(a=wssessions[o._id]),null!=o.flags&&1&o.flags?(QV("MainUserImage",!1),QV("MainUserImageEx",!0),null==o.accountImageRnd&&(o.accountImageRnd=Math.floor(9999999999*Math.random())),Q("MainUserImageEx").src="userimage.ashx?id="+o._id.split("/")[2]+"&rnd="+o.accountImageRnd):(Q("MainUserImage").classList.remove("gray"),0==a&&Q("MainUserImage").classList.add("gray"),QV("MainUserImage",!0),QV("MainUserImageEx",!1));var s=o._id.split("/")[2];s.startsWith("~twitter:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/twitter64.png"):s.startsWith("~google:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/google64.png"):s.startsWith("~github:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/github64.png"):s.startsWith("~azure:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/azure64.png"):s.startsWith("~oidc:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/oidc64.png"):s.startsWith("~jumpcloud:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/jumpcloud64.png"):s.startsWith("~intel:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/intel64.png"):s.startsWith("~:")?(QV("p30userAuthServiceLogo",!0),Q("p30userAuthServiceLogo").src="images/login/generic64.png"):QV("p30userAuthServiceLogo",!1);var r=[],l="";null!=o.siteadmin&&32&o.siteadmin&&4294967295!=o.siteadmin&&(l='<img src="images/padlock12.png" height=12 width=8 title="Аккаунт заблокирован" style="margin-top:2px" /> ',r.push("Заблокированная учетная запись")),null!=o.siteadmin&&4294966047&o.siteadmin?8==o.siteadmin?r.push("Доступ к файлам сервера"):4294967295==o.siteadmin?r.push("Администратор с полным доступом"):r.push("Частичные права"):r.push("Нет серверных прав"),null!=o.siteadmin&&4294967295!=o.siteadmin&&1216&o.siteadmin&&r.push("Ограничения");var d="<div style=min-height:80px><table style=width:100%>";8&args.hide&&(d+="<br />"+addDeviceAttribute("Имя",o.name));var c=o.email?EscapeHtml(o.email):"<i>Не задано</i>",u="",p=o.realname?EscapeHtml(o.realname):"<i>Не задано</i>";if(serverinfo.emailcheck&&(u=1==o.emailVerified?'<b style=color:green;cursor:pointer title="Электронная почта подтверждена">&#x2713</b> ':'<b style=color:red;cursor:pointer title="Email не подтвержден">&#x2717;</b> '),serverinfo.crossDomain||0!=debugmode){var m=o._id.split("/")[1];d+=addDeviceAttribute("Домен",""!=m?EscapeHtml(m):"<i>По умолчанию</i>"),d+=addDeviceAttribute("Идентификатор пользователя",EscapeHtml(o._id))}else o.name.toLowerCase()!=o._id.split("/")[2]&&(d+=addDeviceAttribute("Идентификатор пользователя",EscapeHtml(o._id.split("/")[2])));var g="";o.email&&(g=' <a href="mailto:'+EscapeHtml(o.email)+'" \'><i class="fa-solid fa-arrow-up-right-from-square fa-xs"></i></a>'),4294967295!=o.siteadmin||4294967295==userinfo.siteadmin?(d+=addDeviceAttribute("Email",'<span role=button onclick=p30showUserEmailChangeDialog(event,"'+encodeURIComponentEx(o._id)+'")>'+u+c+g+' <i class="fa-solid fa-pencil fa-xs"></i></span>'),d+=addDeviceAttribute("Настоящее имя",'<span role=button onclick=p30showUserRealNameChangeDialog(event,"'+encodeURIComponentEx(o._id)+'")>'+p+' <i class="fa-solid fa-pencil fa-xs"></i></span>')):(d+=addDeviceAttribute("Email",u+c+g),d+=addDeviceAttribute("Настоящее имя",p)),(33554432&features||null!=o.phone)&&(d+=addDeviceAttribute("Телефонный номер","<span role=button onclick=p30editPhone()>"+(o.phone?o.phone:"<i>Пусто</i>")+' <i class="fa-solid fa-pencil fa-xs"></i></span>')),(33554432&features2||null!=o.msghandle)&&(d+=addDeviceAttribute("Messaging",'<span role=button onclick=p30editMessaging()><i class="fa-solid fa-comment fa-xs" title="Messaging enabled" style="margin-top:2px"></i> '+(o.msghandle?o.msghandle:"<i>Пусто</i>")+' <i class="fa-solid fa-pencil fa-xs"></i></span>'));var v=[];1==serverinfo.usersSessionRecording&&o.flags&&2&o.flags&&v.push("Запись сеансов"),o.removeRights&&(8&o.removeRights?v.push("Нет доступа к удаленному управлению"):(65536&o.removeRights?v.push("Нет рабочего стола"):256&o.removeRights&&v.push("Только просмотр рабочего стола"),512&o.removeRights&&v.push("Нет терминала"),1024&o.removeRights&&v.push("Файлов нет")),16&o.removeRights&&v.push("Нет консоли"),32768&o.removeRights&&v.push("Нет доступа к удалению"),131072&o.removeRights&&v.push("Нет доступа к выполнению команд"),64&o.removeRights&&v.push("Нет доступа к пробуждению"),262144&o.removeRights&&v.push("Нет доступа к перезагрузке/выключению")),""==(v=v.join(", "))&&(v="<i>Пусто</i>"),d+=addDeviceAttribute("Функции",addLink(v,"p20edituserfeatures()")),d+=addDeviceAttribute("Права","<span role=button onclick='return showUserAdminDialog(event,\""+encodeURIComponentEx(o._id)+"\")'>"+l+r.join(", ")+' <i class="fa-solid fa-pencil fa-xs"></i></span>'),o.quota&&(d+=addDeviceAttribute("Квота сервера",EscapeHtml(parseInt(o.quota)/1024)+" k")),d+=addDeviceAttribute("Создано",printDateTime(new Date(1e3*o.creation))),o.login&&(d+=addDeviceAttribute("Последний вход в систему",printDateTime(new Date(1e3*o.login)))),-1==o.passchange?d+=addDeviceAttribute("Пароль","Будет изменено при следующем входе в систему."):o.passchange&&(d+=addDeviceAttribute("Пароль",format("Последнее изменение: {0}",printDateTime(new Date(1e3*o.passchange)))));var h=0,f="<i>Пусто<i>";if(o.links){for(var x in o.links)x.startsWith("mesh/")&&h++;1==h?f="1 группа":h>1&&(f=format("{0} групп",h))}if(d+=addDeviceAttribute("Группы устройств",f),4294967295==userinfo.siteadmin||2&userinfo.siteadmin){var k="<i>Пусто</i>";if(o.groups)for(var x in k="",o.groups)k+='<span class="tagSpan">'+EscapeHtml(o.groups[x])+"</span>";d+=addDeviceAttribute("Области администратора",addLinkConditional(k,'showUserGroupDialog(event,"'+encodeURIComponentEx(o._id)+'")',4294967295==userinfo.siteadmin||null==userinfo.groups&&userinfo._id!=o._id&&4294967295!=o.siteadmin))}var y=[],b=0;o.consent&&(b=o.consent),serverinfo.consent&&(b|=serverinfo.consent),64&b&&8&b?y.push("Рабочий стол: запросить + панель-уведомление"):64&b?y.push("Панель-уведомление на экране"):8&b?y.push("Рабочий стол: запросить"):1&b&&y.push("Рабочий стол: уведомить"),16&b?y.push("Терминал: запросить"):2&b&&y.push("Терминал: уведомить"),32&b?y.push("Файлы: запросить"):4&b&&y.push("Файлы: уведомить"),7==b&&(y=["Всегда уведомлять"]),56&~b||(y=["Всегда запрашивать"]),""==(y=y.join(", "))&&(y="<i>Пусто</i>"),d+=addDeviceAttribute("Согласие пользователя",addLinkConditional(y,"p20editmeshconsent(2)",!0));var w=0;if(o.otpsecret>0||o.otphkeys>0||o.otpekey>0||o.otpduo>0){w=1;var M=[];o.otpsecret>0&&M.push("Приложение аутентификации"),o.otphkeys>0&&M.push("Ключ безопасности"),o.otpekey>0&&M.push("Email"),o.otpduo>0&&M.push("Duo"),o.otpkeys>0&&M.push("Резервные коды"),o.otpdev>0&&M.push("Нажатие устройства"),null!=o.phone&&67108864&features&&M.push("смс"),null!=o.msghandle&&67108864&features2&&M.push("Messaging"),d+=addDeviceAttribute("Защита",'<i class="fa-solid fa-key" title="двухфакторная аутентификация включена" style="margin-top:2px"></i> '+M.join(", "))}if(d+="</table></div><br />",d+='<input type=button class="btn btn-primary btn-sm me-1" value="Примечания" title="Посмотреть примечания об этом пользователе" onclick=showNotes(false,"'+encodeURIComponentEx(o._id)+'") />',o.phone&&33554432&features&&(d+='<input type=button class="btn btn-primary btn-sm me-1" value="смс" title="Отправить SMS-сообщение этому пользователю" onclick=showSendSMS("'+encodeURIComponentEx(o._id)+'") />'),o.msghandle&&33554432&features2&&(d+='<input type=button class="btn btn-primary btn-sm me-1" value="Сообщение" title="Send a message to this user" onclick=showSendMessage("'+encodeURIComponentEx(o._id)+'") />'),"string"==typeof o.email&&!0===o.emailVerified&&64&features&&(d+='<input type=button class="btn btn-primary btn-sm me-1" value="Email" title="Отправить электронное сообщение этому пользователю" onclick=showSendEmail("'+encodeURIComponentEx(o._id)+'") />'),!i&&(a>0||8&features2&&o.webpush)&&(d+='<input type=button class="btn btn-primary btn-sm me-1" value="Уведомить" title="Отправить уведомление пользователю" onclick=showUserAlertDialog(event,"'+encodeURIComponentEx(o._id)+'") />',d+='<input type=button class="btn btn-primary btn-sm me-1" value="Чат" title="Чат" onclick=userChat(event,"'+encodeURIComponentEx(o._id)+'","'+encodeURIComponentEx(o.name)+'") />',a>0&&null!=serverinfo&&null!=serverinfo.altmessenging))for(var x in serverinfo.altmessenging){var C=serverinfo.altmessenging[x];null!=C.type&&"user"!=C.type||(d+='<input type=button class="btn btn-primary btn-sm me-1" value="'+EscapeHtml(C.name)+'" onclick=altUserChat(event,"'+encodeURIComponentEx(o._id)+'","'+encodeURIComponentEx(o.name)+'",'+x+") />")}QH("p30html",d),drawUserPermissions();var S=null!=userinfo.siteadmin&&2&userinfo.siteadmin&&4294967295!=o.siteadmin||4294967295==userinfo.siteadmin;d="<div style=float:right;font-size:small>",S&&userinfo._id!=o._id&&(d+="<a href=# style=cursor:pointer onclick='return p30showDeleteUserDialog()' title=\"Удалить этого пользователя\">Удалить пользователя</a>"),d+="</div><div style=font-size:small>",!S||524288&features||"~"==o._id.split("/")[2][0]||(d+="<a href=# style=cursor:pointer onclick='return p30showUserChangePassDialog("+w+')\' title="Изменить пароль для этого пользователя">Смена пароля</a>',d+=" <a href=# style=cursor:pointer onclick='return p30viewPreviousLogins()' title=\"Посмотреть предыдущие входы в систему для этого пользователя\">Предыдущие входы</a>"),d+="</div><br>",QH("p30html3",d),d="",1==a?d="1 активная сессия":a>1&&(d=format("{0} активных сессий",a)),QH("MainUserState",d),go(30),QH("p31events",""),refreshUsersEvents();var A="";if(!(268435456&features)&&xxcurrentView>=30&&xxcurrentView<=39&&null!=currentUser){for(var x in A="?viewmode="+xxcurrentView+"&gotouser="+(serverinfo.crossDomain?currentUser._id:currentUser._id.split("/")[2]),urlargs)A+="&"+x+"="+urlargs[x];try{window.history.replaceState({},document.title,window.location.pathname+A)}catch(e){}}}else go(4)}}function p30editPhone(){if(!xxdialogMode){var e='<table style=width:100%><tr><td style=width:56px><img src="images/phone80.png" style=padding:8px>';e+="<td style=width:100%;text-align:center>Телефонный номер с возможностью отправки SMS для этого пользователя.<br />Оставьте поле пустым.",e+='<br /><br /><div style=width:100%;text-align:center>Телефонный номер: <input type=tel pattern="[0-9]" autocomplete="tel" value="'+(currentUser.phone?currentUser.phone:"")+'" inputmode="tel" maxlength=18 id=d2phoneinput onKeyUp=p30editPhoneValidate() onkeypress="if (event.key==\'Enter\') p30editPhoneValidate(1)"></div></table>',xxdialogButtons=3,xxdialogTag="verifyPhone",setModalContent("xxAddAgent","Уведомления по телефону",e),showModal("xxAddAgentModal","idx_dlgOkButton",p30editPhoneEx),Q("d2phoneinput").focus(),p30editPhoneValidate()}}function p30editMessaging(){if(!xxdialogMode){var e='<table style=width:100%><tr><td style=width:56px;vertical-align:top><img src="images/messaging40.png" style=padding:8px>';e+="<td style=width:100%>Messaging account for this user.";var t="<select id=d2serviceselect style=width:160px;margin-left:8px onchange=p30editMessagingValidate()><option value=0>Пусто</option>";if(1&serverinfo.userMsgProviders&&(t+="<option value=1>Telegram</option>"),4&serverinfo.userMsgProviders&&(t+="<option value=4>Discord</option>"),8&serverinfo.userMsgProviders&&(t+="<option value=8>XMPP</option>"),16&serverinfo.userMsgProviders&&(t+="<option value=16>CallMeBot</option>"),32&serverinfo.userMsgProviders&&(t+="<option value=32>Pushover</option>"),64&serverinfo.userMsgProviders&&(t+="<option value=64>ntfy</option>"),128&serverinfo.userMsgProviders&&(t+="<option value=128>Zulip</option>"),256&serverinfo.userMsgProviders&&(t+="<option value=256>Slack</option>"),e+="<table style=margin-top:12px><tr><td>Service<td>"+(t+="</select>"),e+="<tr><td>Handle<td><input maxlength=1024 style=width:160px;margin-left:8px id=d2handleinput onKeyUp=p30editMessagingValidate() onkeypress=\"if (event.key=='Enter') p30editMessagingValidate(1)\">",e+="</table>",serverinfo.discordUrl&&(e+="<div id=d2discordurl style=display:none><br /><a href="+serverinfo.discordUrl+' target="_discord">Join this Discord server to receive notifications.</a></div>'),e+='<div id=d2callmebotinfo style=display:none><br /><a href=https://www.callmebot.com/blog/free-api-signal-send-messages/ target="_callmebot">Signal</a>, <a href=https://www.callmebot.com/blog/free-api-whatsapp-messages/ target="_callmebot">Whatsapp</a>, <a href=https://www.callmebot.com/blog/free-api-facebook-messenger/ target="_callmebot">Facebook</a>, <a href=https://www.callmebot.com/blog/telegram-text-messages/ target="_callmebot">Telegram</a></div>',e+='<div id=d2pushoverinfo style=display:none><br /><a href=https://pushover.net/ target="_pushover">Information at Pushover.net</a></div>',e+='<div id=d2ntfyinfo style=display:none><br /><a href="'+(serverinfo.userMsgNftyUrl?serverinfo.userMsgNftyUrl:"https://ntfy.sh/")+'" target="_ntfy">Free service at ntfy.sh</a></div>',xxdialogButtons=3,xxdialogTag="verifyMessaging",setModalContent("xxAddAgent","Messaging Notifications",e+='<div id=d2slackinfo style=display:none><br /><a href=https://api.slack.com/messaging/webhooks target="_slack">Slack Webhook Setup</a></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",p30editMessagingEx),Q("d2handleinput").focus(),currentUser.msghandle){if(currentUser.msghandle.startsWith("telegram:")&&1&serverinfo.userMsgProviders&&(Q("d2serviceselect").value=1,Q("d2handleinput").value=currentUser.msghandle.substring(10)),currentUser.msghandle.startsWith("discord:")&&4&serverinfo.userMsgProviders&&(Q("d2serviceselect").value=4,Q("d2handleinput").value=currentUser.msghandle.substring(8)),currentUser.msghandle.startsWith("xmpp:")&&8&serverinfo.userMsgProviders&&(Q("d2serviceselect").value=8,Q("d2handleinput").value=currentUser.msghandle.substring(5)),currentUser.msghandle.startsWith("callmebot:")&&16&serverinfo.userMsgProviders){Q("d2serviceselect").value=16;var n=currentUser.msghandle.substring(10).split("|");"signal"==n[0]&&3==n.length&&(Q("d2handleinput").value="https://api.callmebot.com/signal/send.php?phone="+decodeURIComponent(n[1])+"&apikey="+decodeURIComponent(n[2])),"whatsapp"==n[0]&&3==n.length&&(Q("d2handleinput").value="https://api.callmebot.com/whatsapp.php?phone="+decodeURIComponent(n[1])+"&apikey="+decodeURIComponent(n[2])),"facebook"==n[0]&&2==n.length&&(Q("d2handleinput").value="https://api.callmebot.com/facebook/send.php?apikey="+decodeURIComponent(n[1]))}currentUser.msghandle.startsWith("pushover:")&&32&serverinfo.userMsgProviders&&(Q("d2serviceselect").value=32,Q("d2handleinput").value=currentUser.msghandle.substring(9)),currentUser.msghandle.startsWith("ntfy:")&&64&serverinfo.userMsgProviders&&(Q("d2serviceselect").value=64,Q("d2handleinput").value=currentUser.msghandle.substring(5)),currentUser.msghandle.startsWith("zulip:")&&128&serverinfo.userMsgProviders&&(Q("d2serviceselect").value=128,Q("d2handleinput").value=currentUser.msghandle.substring(6)),currentUser.msghandle.startsWith("slack:")&&256&serverinfo.userMsgProviders&&(Q("d2serviceselect").value=256,Q("d2handleinput").value=currentUser.msghandle.substring(6))}p30editMessagingValidate()}}function p30editMessagingValidate(e){QE("d2handleinput",0!=Q("d2serviceselect").value),serverinfo.discordUrl&&QV("d2discordurl",4==Q("d2serviceselect").value),QV("d2callmebotinfo",16==Q("d2serviceselect").value),QV("d2pushoverinfo",32==Q("d2serviceselect").value),QV("d2ntfyinfo",64==Q("d2serviceselect").value),QV("d2slackinfo",256==Q("d2serviceselect").value),0==Q("d2serviceselect").value?Q("d2handleinput").placeholder="":4==Q("d2serviceselect").value?Q("d2handleinput").placeholder="Username:0000":8==Q("d2serviceselect").value?Q("d2handleinput").placeholder="username@server.com":16==Q("d2serviceselect").value?Q("d2handleinput").placeholder="https://api.callmebot.com/...":32==Q("d2serviceselect").value?Q("d2handleinput").placeholder="User key":64==Q("d2serviceselect").value?Q("d2handleinput").placeholder="Тема":128==Q("d2serviceselect").value?Q("d2handleinput").placeholder="username@sample.com":256==Q("d2serviceselect").value?Q("d2handleinput").placeholder="https://hooks.slack.com/...":Q("d2handleinput").placeholder="Имя пользователя",1==e&&dialogclose(1)}function p30editMessagingEx(){var e=null;""==Q("d2handleinput").value||0==Q("d2serviceselect").value?e="":1==Q("d2serviceselect").value?e="telegram:@"+Q("d2handleinput").value:4==Q("d2serviceselect").value?e="discord:"+Q("d2handleinput").value:8==Q("d2serviceselect").value?e="xmpp:"+Q("d2handleinput").value:16==Q("d2serviceselect").value?e="callmebot:"+Q("d2handleinput").value:32==Q("d2serviceselect").value?e="pushover:"+Q("d2handleinput").value:64==Q("d2serviceselect").value?e="ntfy:"+Q("d2handleinput").value:128==Q("d2serviceselect").value?e="zulip:"+Q("d2handleinput").value:256==Q("d2serviceselect").value&&(e="slack:"+Q("d2handleinput").value),null!=e&&meshserver.send({action:"edituser",id:currentUser._id,msghandle:e})}function p20edituserfeatures(){if(!xxdialogMode){var e=currentUser.flags?currentUser.flags:0,t="",n=currentUser.removeRights?currentUser.removeRights:0;t="";1==serverinfo.usersSessionRecording&&(t+='<div><label><input type=checkbox id=d20flag1 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(2&e?"checked":"")+">Запись сеансов</label><br></div>"),t+='<div><label><input type=checkbox id=d20flag7 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(8&n?"checked":"")+">Нет доступа к удаленному управлению</label><br></div>",t+='<div style=margin-left:8px><label><input type=checkbox id=d20flag2 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(65536&n?"checked":"")+">Нет доступа к рабочему столу</label><br></div>",t+='<div style=margin-left:16px><label><input type=checkbox id=d20flag3 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(256&n?"checked":"")+">Только просмотр экрана без ввода</label><br></div>",t+='<div style=margin-left:8px><label><input type=checkbox id=d20flag4 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(512&n?"checked":"")+">Нет доступа к терминалу</label><br></div>",t+='<div style=margin-left:8px><label><input type=checkbox id=d20flag5 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(1024&n?"checked":"")+">Нет доступа к файлам</label><br></div>",t+='<div><label><input type=checkbox id=d20flag6 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(16&n?"checked":"")+">Нет доступа к консоли агента</label><br></div>",t+='<div><label><input type=checkbox id=d20flag8 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(32768&n?"checked":"")+">Нет доступа к удалению</label><br></div>",t+='<div><label><input type=checkbox id=d20flag9 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(131072&n?"checked":"")+">Нет доступа к выполнению команд</label><br></div>",t+='<div><label><input type=checkbox id=d20flag10 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(64&n?"checked":"")+">Нет доступа к пробуждению</label><br></div>",setModalContent("xxAddAgent","Редактировать функции пользователя",t+='<div><label><input type=checkbox id=d20flag11 class="form-check-input me-2" onchange=p20edituserfeaturesValidate() '+(262144&n?"checked":"")+">Нет доступа к перезагрузке/выключению</label><br></div>"),showModal("xxAddAgentModal","idx_dlgOkButton",p20edituserfeaturesEx),p20edituserfeaturesValidate()}}function p20edituserfeaturesValidate(){QE("d20flag2",!Q("d20flag7").checked),QE("d20flag3",!Q("d20flag7").checked&&!Q("d20flag2").checked),QE("d20flag4",!Q("d20flag7").checked),QE("d20flag5",!Q("d20flag7").checked)}function p20edituserfeaturesEx(){var e=1&(currentUser.flags?currentUser.flags:0);1==serverinfo.usersSessionRecording&&Q("d20flag1").checked&&(e+=2);var t=0;Q("d20flag7").checked?t+=8:(Q("d20flag2").checked?t+=65536:Q("d20flag3").checked&&(t+=256),Q("d20flag4").checked&&(t+=512),Q("d20flag5").checked&&(t+=1024)),Q("d20flag6").checked&&(t+=16),Q("d20flag8").checked&&(t+=32768),Q("d20flag9").checked&&(t+=131072),Q("d20flag10").checked&&(t+=64),Q("d20flag11").checked&&(t+=262144),meshserver.send({action:"edituser",id:currentUser._id,flags:e,removeRights:t})}function p30editPhoneValidate(e){var t=""==Q("d2phoneinput").value||isPhoneNumber(Q("d2phoneinput").value);QE("idx_dlgOkButton",t),1==e&&t&&dialogclose(1)}function p30editPhoneEx(){meshserver.send({action:"edituser",id:currentUser._id,phone:Q("d2phoneinput").value})}function p30showUserRealNameChangeDialog(e){if(xxdialogMode)return!1;return xxdialogButtons=3,setModalContent("xxAddAgent",format("Изменить настоящее имя для {0}",EscapeHtml(currentUser.name)),'<div class="form-floating mb-2"><input id=dp30realname class="form-control" placeholder="Real Name" maxlength=256 /><label for=dp30realname>Real Name</label></div>'),showModal("xxAddAgentModal","idx_dlgOkButton",p30showUserRealNameChangeDialogEx),Q("dp30realname").focus(),Q("dp30realname").value=currentUser.realname?currentUser.realname:"",!1}function p30showUserRealNameChangeDialogEx(){meshserver.send({action:"edituser",id:currentUser._id,realname:Q("dp30realname").value})}function p30showUserEmailChangeDialog(e){if(xxdialogMode)return!1;var t="";return t+='<div class="form-floating mb-2"><input id=dp30email class="form-control" maxlength=32 onchange=p30validateEmail() onkeyup=p30validateEmail() placeholder=Email /><label for=dp30email>Email</label></div>',serverinfo.emailcheck&&(t+=addHtmlFormFloating("Статус",'<select id=dp30verified class="form-control" onchange=p30validateEmail()><option value=0>не подтверждено</option><option value=1>Проверенный</option></select>')),setModalContent("xxAddAgent",format("Смена email для {0}",EscapeHtml(currentUser.name)),t),xxdialogButtons=3,showModal("xxAddAgentModal","idx_dlgOkButton",p30showUserEmailChangeDialogEx),Q("dp30email").focus(),Q("dp30email").value=currentUser.email?currentUser.email:"",serverinfo.emailcheck&&(Q("dp30verified").value=currentUser.emailVerified?1:0),p30validateEmail(),!1}function p30validateEmail(){var e=Q("dp30email").value,t=e.split("@");t=0==e.length||2==t.length&&t[0].length>0&&t[1].split(".").length>1&&t[1].length>2&&e.length<1024&&(e!=userinfo.email||1==serverinfo.emailcheck&&Q("dp30verified").value!=(userinfo.emailVerified?1:0)),QE("idx_dlgOkButton",t)}function p30showUserEmailChangeDialogEx(){var e={action:"edituser",id:currentUser._id,email:Q("dp30email").value};serverinfo.emailcheck&&(e.emailVerified=1==Q("dp30verified").value),meshserver.send(e)}function p30viewPreviousLogins(){xxdialogMode||(setModalContent("xxAddAgent","Предыдущие входы","Loading..."),meshserver.send({action:"previousLogins",userid:currentUser._id}))}function p30showUserChangePassDialog(e){if(!xxdialogMode){var t="";if(t+='<div class="form-floating mb-2"><input id=p4pass1 type=password class="form-control" maxlength=256 onchange=p30showUserChangePassDialogValidate(1) onkeyup=p30showUserChangePassDialogValidate(1) placeholder=Password></input><label for=p4pass1>Password</label></div>',t+='<div class="form-floating mb-2"><input id=p4pass2 type=password class="form-control" maxlength=256 onchange=p30showUserChangePassDialogValidate(1) onkeyup=p30showUserChangePassDialogValidate(1) placeholder=Password></input><label for=p4pass2>Confirm Password</label></div>',65536&features&&(t+='<div class="form-floating mb-2"><input id=p4hint type=text class="form-control" maxlength=256 placeholder="Password hint"></input><label for=p4hint>Password hint</label></div>'),passRequirements){var n=[],o=0;for(var i in passRequirements)"reset"!=i&&"hint"!=i&&(n.push(i+":"+passRequirements[i]),o++);o>0&&(t+="<div style=font-size:x-small;padding:6px>"+format("Требования: {0}.",n.join(", "))+"</div>")}t+='<div><label><input id=p4resetNextLogin class="form-check-input me-2" type=checkbox />Принудительно сбросить пароль при следующем входе в систему.</label></div>',1==e&&(t+='<div><label><input id=p4twoFactorRemove class="form-check-input me-2" type=checkbox />Удалить все двухфакторные аутентификации.</label></div>'),setModalContent("xxAddAgent",format("Смена пароля для {0}",EscapeHtml(currentUser.name)),t),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p30showUserChangePassDialogEx(3,e)}),p30showUserChangePassDialogValidate(),Q("p4pass1").focus(),-1==currentUser.passchange&&(Q("p4resetNextLogin").checked=!0)}}function p30showUserChangePassDialogValidate(){var e=!0;""==Q("p4pass1").value&&""==Q("p4pass2").value||(Q("p4pass1").value!=Q("p4pass2").value||passRequirements&&0==checkPasswordRequirements(Q("p4pass1").value,passRequirements))&&(e=!1),QE("idx_dlgOkButton",e)}function p30showUserChangePassDialogEx(e,t){var n=!1;if(1==t&&1==Q("p4twoFactorRemove").checked&&(n=!0),Q("p4pass1").value==Q("p4pass2").value){var o={action:"changeuserpass",userid:currentUser._id,pass:Q("p4pass1").value,removeMultiFactor:n,resetNextLogin:Q("p4resetNextLogin").checked};65536&features&&(o.hint=Q("p4hint").value),meshserver.send(o)}}function p30showDeleteUserDialog(){xxdialogMode||(setModalContent("xxAddAgent",format("Удалить пользователя {0}",EscapeHtml(currentUser.name)),format("Подтвердить удаление пользователя {0}?",EscapeHtml(currentUser.name))+'<br /><br /><label><input id=p10check type=checkbox class="form-check-input me-2" onchange=p10validateDeleteNodeDialog() />Подтвердить</label>'),showModal("xxAddAgentModal","idx_dlgOkButton",p30showDeleteUserDialogEx),p10validateDeleteNodeDialog())}function p30showDeleteUserDialogEx(){meshserver.send({action:"deleteuser",userid:currentUser._id,username:currentUser.name})}function drawUserPermissions(){var e=1,t="",n=0,o=!1;for(var i in meshes)meshes[i]._id.split("/")[1]==currentUser._id.split("/")[1]&&(n++,null!=currentUser.links&&null!=currentUser.links[i]||(o=!0));if(n>0&&o&&(t+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p20showAddMeshUserDialog(1)"><i class="fa-solid fa-circle-plus"></i> Добавить группу устройств</button>'),t+='<table class="table table-hover"><tbody><tr class="table-active"><th scope=col>Общие группы устройств</th><th scope=col></th></tr>',currentUser.links){var a=[];for(var i in currentUser.links)i.startsWith("mesh/")&&null!=meshes[i]&&a.push(meshes[i]);for(var i in a=getOrderedList(a,"name")){var s=0,r=a[i],l="",d=makeDeviceGroupRightsString(v=currentUser.links[r._id].rights);if(null!=r){userinfo.links&&null!=userinfo.links[r._id]&&null!=userinfo.links[r._id].rights&&(s=userinfo.links[r._id].rights);var c="<i>Неизвестная группа устройств</i>";r&&(c="<a href=# onclick='gotoMesh(\""+r._id+"\");haltEvent(event);'>"+EscapeHtml(r.name)+"</a>"),currentUser._id!=userinfo._id&&2&s&&(l="<a href=# onclick='return p30removeMeshFromUser(event,\""+encodeURIComponentEx(r._id)+'")\' title="Удалить права пользователя для этой группы устройств" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',d='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(1,"'+encodeURIComponentEx(r._id)+'")>'+d+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"),t+="<tr "+(++e%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="Группа устройств" class=m99></div><div>&nbsp;'+c+"<div></div></div></td><td style=width:70%><div style=float:right>"+l+"</div><div>"+d+"</div></td></tr>"}}}if(1==e&&(t+="<tr><td><div style=padding:6px>&nbsp;<i>Нет общих групп устройств</i><div></div></div></td><td></td></tr>"),t+="</tbody></table>",null!=usergroups){if(e=1,t+="<br />",256&userinfo.siteadmin){var u=0,p=!1;for(var i in usergroups)null==usergroups[i].membershipType&&usergroups[i]._id.split("/")[1]==currentUser._id.split("/")[1]&&(u++,null!=currentUser.links&&null!=currentUser.links[i]||(p=!0));u>0&&p&&(t+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p30showAddUserGroupDialog()"><i class="fa-solid fa-circle-plus"></i> Добавить группу пользователей</button>')}if(t+='<table class="table table-hover"><tbody><tr class="table-active"><th scope=col>Членство в группах пользователей</th><th scope=col></th></tr>',currentUser.links){var m=[];for(var i in currentUser.links)i.startsWith("ugrp/")&&null!=usergroups[i]&&m.push(usergroups[i]);for(var i in m=getOrderedList(m,"name")){var g=m[i],v=currentUser.links[m[i]._id].rights,h=(l="","<i>Неизвестная группа пользователей</i>");null!=g&&(h=EscapeHtml(g.name),null!=usergroups&&(h="<a href=# onclick='gotoUserGroup(\""+encodeURIComponentEx(m[i]._id)+"\");haltEvent(event);'>"+h+"</a>")),null==g.membershipType&&256&userinfo.siteadmin&&(l="<a href=# onclick='return p30RemoveUserGroup(event,\""+encodeURIComponentEx(m[i]._id)+'")\' title="Удалить членство пользователя в группе" style=cursor:pointer><i class="fa-solid fa-trash text-danger hoverButton"></i></a>'),t+="<tr "+(++e%2==0?"style=background-color:#DDD":"")+'><td><div title="Группа пользователей" class=m4></div><div>&nbsp;'+h+"<div></div></div></td><td><div style=float:right>"+l+"</div></td></tr>"}}1==e&&(t+="<tr><td><div style=padding:6px>&nbsp;<i>Нет членства в группах пользователей</i><div></div></div></td><td></td></tr>"),t+="</tbody></table>"}if(e=1,t+="<br />",currentUser._id.split("/")[1]==userinfo._id.split("/")[1]&&(t+='<button class="btn btn-primary btn-sm me-2 mb-1" onclick="return p20showAddMeshUserDialog(4)"><i class="fa-solid fa-circle-plus"></i> Добавить устройство</button>'),t+='<table class="table table-hover"><tbody><tr class="table-active"><th scope=col>Общие устройства</th><th scope=col></th></tr>',currentUser.links){var f=[];for(var i in currentUser.links){if(i.startsWith("node/"))null!=(x=getNodeFromId(i))&&f.push(x)}for(var i in f.sort(nameSort),f){var x=f[i];v=currentUser.links[x._id].rights,l="",s=GetNodeRights(x);userinfo.links&&null!=userinfo.links[i]&&null!=userinfo.links[i].rights&&(s=userinfo.links[i].rights);var k=x?EscapeHtml(x.name):"<i>Неизвестное устройство</i>";2&s&&(l="<a href=# onclick='return p30removeNodeFromUser(event,\""+encodeURIComponentEx(x._id)+'")\' title="Удалить права пользователя для этой группы устройств" style=cursor:pointer><img src=images/trash.png border=0 height=10 width=10></a>',d='<span style=cursor:pointer onclick=p20showAddMeshUserDialog(4,"'+encodeURIComponentEx(x._id)+'")>'+makeUserDeviceRightsString(v)+" <img class=hoverButton style=cursor:pointer src=images/link5.png></span>"),k="<a href=# onclick='gotoDevice(\""+x._id+"\",10);haltEvent(event);'>"+k+"</a>",t+="<tr "+(++e%2==0?"style=background-color:#DDD":"")+'><td style=width:30%><div title="Устройство" class=si'+x.icon+"></div><div>&nbsp;"+k+"<div></div></div></td><td style=width:70%><div style=float:right>"+l+"</div><div>"+d+"</div></td></tr>"}}1==e&&(t+="<tr><td><div style=padding:6px>&nbsp;<i>Нет общих устройств</i><div></div></div></td><td></td></tr>"),t+="</tbody></table>",QH("p30html2",t)}function p30removeDeviceSharing(e,t,n,o){xxdialogMode||(setModalContent("xxAddAgent","Удалить общий доступ к устройству",format('Подтвердить удаление общего доступа к устройству "{0}"?',decodeURIComponent(o))),showModal("xxAddAgentModal","idx_dlgOkButton",function(e,t){meshserver.send({action:"removeDeviceShare",nodeid:t[0],publicid:t[1]})},3,[decodeURIComponent(t),decodeURIComponent(n)]))}function p30removeNodeFromUser(e,t){if(!xxdialogMode){var n=getNodeFromId(decodeURIComponent(t));setModalContent("xxAddAgent","Удалить разрешения устройства",format('Подтвердите удаление прав доступа для устройства "{0}"?',n.name)),showModal("xxAddAgentModal","idx_dlgOkButton",function(e,t){meshserver.send({action:"adddeviceuser",nodeid:t._id,nodename:t.name,userids:[currentUser._id],rights:0,remove:!0})},3,n)}}function p30removeUserFromNode(e,t){if(!xxdialogMode){var n=null,o="";t=decodeURIComponent(t),xxdialogButtons=3,xxdialogTag=n,t.startsWith("user/")?(users&&null!=(n=users[t])&&(o=n.name),setModalContent("xxAddAgent","Удалить разрешения пользователя",o?format('Подтвердить удаление прав доступа для пользователя "{0}"?',o):"Подтвердите снятие прав доступа?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(e,n){meshserver.send({action:"adddeviceuser",nodeid:currentNode._id,nodename:currentNode.name,userids:[t],rights:0,remove:!0})})):t.startsWith("ugrp/")&&(usergroups&&null!=(n=usergroups[t])&&(o=n.name),setModalContent("xxAddAgent","Удалить разрешения группы пользователей",o?format('Подтвердите удаление прав доступа для группы пользователей "{0}"?',o):"Подтвердите снятие прав доступа?"),showModal("xxAddAgentModal","idx_dlgOkButton",function(e,n){meshserver.send({action:"adddeviceuser",nodeid:currentNode._id,nodename:currentNode.name,userids:[t],rights:0,remove:!0})}))}}function p30RemoveUserGroup(e,t){if(!xxdialogMode&&null!=usergroups){var n=decodeURIComponent(t),o=usergroups[n];setModalContent("xxAddAgent","Удалить членство в группе пользователей",format('Подтвердить удаление членства в группе пользователей "{0}"?',null!=o?EscapeHtml(o.name):"<i>Неизвестно</i>")),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p30RemoveUserGroupEx(3,n)})}}function p30RemoveUserGroupEx(e,t){meshserver.send({action:"removeuserfromusergroup",ugrpid:t,userid:currentUser._id})}function p30showAddUserGroupDialog(){if(!xxdialogMode&&null!=usergroups){var e="";for(var t in usergroups)null==usergroups[t].membershipType&&usergroups[t]._id.split("/")[1]==currentUser._id.split("/")[1]&&(null!=currentUser.links&&null!=currentUser.links[t]||(e+="<option value="+encodeURIComponentEx(t)+">"+EscapeHtml(usergroups[t].name)+"</option>"));var n=addHtmlFormFloating("Группа пользователей",'<select id=dp2groupid class="form-select">'+e+"</select>");return xxdialogButtons=3,setModalContent("xxAddAgent","Добавить участие",n),showModal("xxAddAgentModal","idx_dlgOkButton",p30showAddUserGroupDialogEx),Q("dp2groupid").focus(),!1}}function p30showAddUserGroupDialogEx(){meshserver.send({action:"addusertousergroup",ugrpid:decodeURIComponent(Q("dp2groupid").value),usernames:[currentUser._id.split("/")[2]]})}function p30removeMeshFromUser(e,t){if(!xxdialogMode){var n=meshes[decodeURIComponent(t)];null!=n&&(setModalContent("xxAddAgent","Удалить разрешения группы устройств",format('Подтвердить удаление прав доступа для группы устройств "{0}"?',n.name)),showModal("xxAddAgentModal","idx_dlgOkButton",function(){p30removeMeshFromUserEx(3,n._id)}))}}function p30removeMeshFromUserEx(e,t){meshserver.send({action:"removemeshuser",meshid:t,userid:currentUser._id})}var currentUserEvents=null;function userEventsUpdate(){if(null!=currentUser){var e="",t=null;for(var n in currentUserEvents){var o=currentUserEvents[n],i=new Date(o.time);if(o.msg){null==o.h&&(o.h=Math.random()),printDate(i)!=t&&(null!=t&&(e+="</table>"),e+='<table class="table table-hover p3eventsTable" cellpadding=0 cellspacing=0><tr><td colspan=4 class=DevSt>'+(t=printDate(i))+"</td></tr>");var a,s="fa-mobile-screen";if("user"==o.etype&&(s="fa-user"),"server"==o.etype&&(s="fa-server"),null==o.msgid||null==eventsMessageId[o.msgid])a="string"==typeof o.msg?EscapeHtml(o.msg).split("(R)").join("&reg;"):"";else{for(var n in a=eventsMessageId[o.msgid],o.msgArgs){var r=o.msgArgs[n];"string"==typeof r&&0==r.indexOf("DATETIME:")&&(r=printFlexDateTime(new Date(parseInt(r.substring(9))))),a=a.split("{"+n+"}").join(r)}a=EscapeHtml(a).split("(R)").join("&reg;")}if(o.nodeid){var l=getNodeFromId(o.nodeid);null!=l&&(s="si"+l.icon,a="<a href=# onclick='gotoDevice(\""+o.nodeid+"\",10);haltEvent(event);'>"+EscapeHtml(l.name)+"</a> &rarr; "+a)}if(o.username&&o.username!=currentUser.name){var d="";o.guestname&&(d=' / <span title="Это гостевой сеанс общего доступа">'+EscapeHtml(o.guestname)+"</span>"),a=2&userinfo.siteadmin&&o.userid?"<a href=# onclick='gotoUser(\""+encodeURIComponentEx(o.userid)+"\");haltEvent(event);'>"+EscapeHtml(o.username)+"</a>"+d+" &rarr; "+a:EscapeHtml(o.guestname)+" &rarr; "+a}else o.guestname&&(a='<span title="Это гостевой сеанс общего доступа">'+EscapeHtml(o.guestname)+"</span> &rarr; "+a);"relay"!=o.etype&&"relaylog"!=o.action||(s="fa-arrow-right-arrow-left"),e+="<tr onclick=showEventDetails("+o.h+',3)  onmouseover=eventMouseHover(this,1) onmouseout=eventMouseHover(this,0) style=cursor:pointer><td style=width:18px><i class="fa-solid '+s+'"></i></td><td class=g1>&nbsp;</td><td class=style10>'+printTime(i)+" - "+a+"</td></tr><tr></tr>"}}null!=t&&(e+="</table>"),""==e&&(e="<br><i>События не найдены</i><br><br>"),QH("p31events",e)}}function refreshUsersEvents(){""!=p31filterevents.value?meshserver.send({action:"events",limit:parseInt(p31limitdropdown.value),userid:currentUser._id,filter:p31filterevents.value}):meshserver.send({action:"events",limit:parseInt(p31limitdropdown.value),userid:currentUser._id})}var d3filetreelinkpath,p52recordings=null;function updateRecordings(){for(var e=[],t=document.getElementsByClassName("RecordingCheckbox"),n="",o=0;o<t.length;o++)t[o].checked&&e.push(t[o].value);if(null==p52recordings)n+="<div style=width:100%;text-align:center;margin-top:20px><i>Загрузка...</i></div>";else if("number"==typeof p52recordings)n+=1==p52recordings?"<div style=width:100%;text-align:center;margin-top:20px><i>Server is unable to read from the recordings folder.</i></div>":2==p52recordings?"<div style=width:100%;text-align:center;margin-top:20px><i>Server is unable to get recordings from the database.</i></div>":"<div style=width:100%;text-align:center;margin-top:20px><i>An unknown error occured.</i></div>";else if(0==p52recordings.length)n+="<div style=width:100%;text-align:center;margin-top:20px><i>Нет записей.</i></div>";else{if(n+='<table class="table table-hover" cellpadding=0 cellspacing=0><thead class="text-center"><tr>',n+="<th>Сессия</th><th style=width:110px>"+nobreak("Время начала")+"</th><th style=width:110px>Длительность</th><th style=width:110px>Размер</th></tr></thead><tbody>",null!=p52recordings){var i=null;for(var o in p52recordings){var a=p52recordings[o],s=printDate(new Date(a.startTime));s!=i&&(i=s,n+="<tr><td class=userTableHeader colspan=4>"+s),n+=addRecordingHtml(o,a)}}n+="</tbody></table>"}QH("p52recordings",n),t=document.getElementsByClassName("RecordingCheckbox");for(o=0;o<t.length;o++)t[o].checked=e.indexOf(t[o].value)>=0;p52updateInfo()}function addRecordingHtml(e,t){var n="";t.lengthTime&&(n=pad2(Math.floor(t.lengthTime/3600))+":"+pad2(Math.floor(t.lengthTime%3600/60))+":"+pad2(Math.floor(t.lengthTime%60)));var o=printTime(new Date(t.startTime));t.sessionStart&&(o=printTime(new Date(t.sessionStart)));var i="";t.size&&(i=format("{0} Kб",Math.round(t.size/1024)));var a="<i>Неизвестно</i>";t.name&&t.meshname&&(a=null!=meshes[t.meshid]?"<a href=# onclick='gotoMesh(\""+t.meshid+"\")'>"+EscapeHtml(t.meshname)+"</a> - <a href=# onclick='gotoDevice(\""+t.nodeid+"\",10)'>"+EscapeHtml(t.name)+"</a>":EscapeHtml(t.meshname)+" - "+EscapeHtml(t.name));if(null!=t.userids&&t.userids.length>0)if(t.userids.length>1)a+=" - "+format("{0} users",t.userids.length);else{var s=null;null!=users&&(s=users[t.userids[0]]),a+=null!=s?" - <a href=# onclick='gotoUser(\""+encodeURIComponentEx(t.userids[0])+"\")'>"+EscapeHtml(s.name)+"</a>":" - "+EscapeHtml(t.userids[0].split("/")[2])}1==t.protocol&&(a+=" - Терминальная сессия"),2==t.protocol&&(a+=" - Сеанс рабочего стола"),5==t.protocol&&(a+=" - Передача файлов"),6==t.protocol&&(a+=" - PowerShell от Админа"),8==t.protocol&&(a+=" - Консоль от Пользователя"),9==t.protocol&&(a+=" - PowerShell от Пользователя"),100==t.protocol&&(a+=" - Intel&reg; AMT WSMAN"),101==t.protocol&&(a+=" - Перенаправление Intel&reg; AMT"),200==t.protocol&&(a+=" - Мессенджер");var r="",l="fa-circle-xmark text-danger";1==t.present&&(l="fa-circle-check text-success",r='<div style=cursor:pointer;float:right><a onclick=downloadFile("recordings.ashx?file='+encodeURIComponentEx(t.filename)+'")><i class="fa-fw fa-solid fa-download fa-sm" title="Download Recording"></i></a>&nbsp;</div>',r+='<div style=cursor:pointer;float:right><a href="player.htm?stream='+encodeURIComponentEx(t.filename)+'") rel="noreferrer noopener" target="mcplay-'+encodeURIComponentEx(t.filename)+'"><i class="fa-fw fa-solid fa-play fa-sm" title="Play Recording"></i></a>&nbsp;</div>');var d="<tr tabindex=0 onmouseover=userMouseHover2(this,1) onmouseout=userMouseHover2(this,0) onkeypress=\"if (event.key=='Enter') showRecordingDialog(event,'"+e+"')\"><td style=cursor:pointer>";return d+="<div class=bar style=width:100%>",d+="<div></div>",d+='<div class=baricon onclick=showRecordingDialog(event,"'+e+'")><i class="fa-fw fa-solid '+l+'"></i></div>',d+='<div class=g1 onclick=showRecordingDialog(event,"'+e+'")></div><div class=g2 onclick=showRecordingDialog("'+e+'")></div>',d+='<div style=line-height:24px onclick=showRecordingDialog(event,"'+e+'")>'+r+"<div style=font-size:16px>"+a+"</div></div></div><td style=text-align:center>"+o+"<td style=text-align:center>"+n+"<td style=text-align:center>"+i}function showRecordingDialog(e,t){if(!xxdialogMode&&"IMG"!=e.target.tagName&&"A"!=e.target.tagName){var n=p52recordings[t],o="";if(n.protocol){var i="Неизвестно";1==n.protocol&&(i="Терминал"),2==n.protocol&&(i="Рабочий стол"),5==n.protocol&&(i="Файлы"),6==n.protocol&&(i="PowerShell от Админа"),8==n.protocol&&(i="Консоль от Пользователя"),9==n.protocol&&(i="PowerShell от Пользователя"),100==n.protocol&&(i="Intel&reg; AMT WSMAN"),101==n.protocol&&(i="Перенаправление Intel&reg; AMT"),200==n.protocol&&(i="Мессенджер"),o+=addHtmlValue4("Протокол",i)}if(o+=addHtmlValue4("Статус",1==n.present?"Присутствует на сервере":"Не на сервере"),n.name&&(o+=addHtmlValue4("Имя устройства",EscapeHtml(n.name))),n.meshname&&(o+=addHtmlValue4("Группа устройств",EscapeHtml(n.meshname))),n.size&&(o+=addHtmlValue4("Размер",format("{0} байт",n.size))),n.startTime&&(o+=addHtmlValue4("Время начала",printTime(new Date(n.startTime)))),n.startTime&&n.lengthTime&&(o+=addHtmlValue4("Время окончания",printTime(new Date(n.startTime+1e3*n.lengthTime)))),n.lengthTime&&(o+=addHtmlValue4("Длительность",pad2(Math.floor(n.lengthTime/3600))+":"+pad2(Math.floor(n.lengthTime%3600/60))+":"+pad2(Math.floor(n.lengthTime%60)))),1==n.multiplex&&(o+=addHtmlValue4("Мультиплексор","Включено")),n.userids)for(var t in n.userids)o+=addHtmlValue4("Пользователь",n.userids[t].split("/")[2]);xxdialogButtons=9,setModalContent("xxAddAgent","Детали записи",o),showModal("xxAddAgentModal","idx_dlgOkButton",null)}}function refreshRecodings(){meshserver.send({action:"recordings",limit:1e3})}function openRecodringPlayer(){xxdialogMode||safeNewWindow(window.location.origin+"{{{domainurl}}}player.htm","meshcentral-deskplayer")}function p52updateInfo(){for(var e=document.getElementsByClassName("RecordingCheckbox"),t=0;t<e.length;t++)!0===e[t].checked&&0}function d3init(){d3fileoptions={dialog:1,filter:"d3filter",files:"d3serverfiles",folderup:"p3FolderUp",currentFolder:"p3CurrentFolder",func:d3setActions},Q("d3localFile").value="",Q("d3localFile").accept=Q("d3filter").value,d3modechange()}function d3modechange(){var e=Q("d3uploadMode").value;QV("d3localmode",1==e),QV("d3servermode",2==e),1==e?d3setActions():d3updatefiles()}var d3filetreelocation=[],d3fileoptions=null;function d3updatefiles(){if(null!=d3fileoptions&&("d3filter"!=d3fileoptions.filter||1!=Q("d3uploadMode").value)){for(var e="",t="",n=filetree,o=1,i="",a=[],s=[],r=document.getElementsByName("fc"),l=0;l<r.length;l++)r[l].checked&&s.push(r[l].value);for(var l in d3filetreelinkpath="",d3filetreelocation){if(null==n.f||null==n.f[d3filetreelocation[l]])break;if(a.push(d3filetreelocation[l]),1==o){var d=d3filetreelocation[l].split("/");window.location.origin+domainUrl+d[0]+"files/"+d[2],d3filetreelocation[l]===userinfo._id?d3filetreelinkpath+="self":d3filetreelinkpath+=d[0]+"/"+d[2]}else""!=d3filetreelinkpath&&(d3filetreelinkpath+="/"+d3filetreelocation[l],o>2&&"/"+d3filetreelocation[l]);i=(n=n.f[d3filetreelocation[l]]).n,o++}d3filetreelocation=a;var c=p5sort_files(n.f),u="";for(var l in d3fileoptions.filter&&(u=Q(d3fileoptions.filter).value),c){var p,m=c[l],g=m.n;if(3!=m.t||""==u||0!=m.nx.toLowerCase().endsWith(u)){p=g.length>70?'<span title="'+EscapeHtml(g)+'">'+EscapeHtml(g.substring(0,70))+"...</span>":EscapeHtml(g);var v="";null!=m.s&&(v=getFileSizeStr(m.s));var h="";if(3!=m.t){h='<div class=filelist file=999><span style=float:right title=""></span><span><div class=fileIcon'+m.t+' onclick=d3folderset("'+encodeURIComponentEx(m.nx)+'")></div>&nbsp;<a href=# style=cursor:pointer onclick=\'return d3folderset("'+encodeURIComponentEx(m.nx)+"\")'>"+p+"</a></span></div>"}else{var f=p;h='<div class=filelist file=3><input style=float:left name=fcx class="fcb form-check-input me-2" type=checkbox onchange=d3setActions() value="'+m.nx+'">&nbsp;<span style=float:right>'+EscapeHtml(v)+"</span><span><div class=fileIcon"+m.t+"></div>"+f+"</span></div>"}m.t<3?e+=h:t+=h}}d3fileoptions.currentFolder&&QH(d3fileoptions.currentFolder,i),QH(d3fileoptions.files,e+t),QE(d3fileoptions.folderup,d3filetreelocation.length>0),d3fileoptions.func&&d3fileoptions.func()}}function d3folderset(e){return d3filetreelocation.push(decodeURIComponent(e)),d3updatefiles(),!1}function d3folderup(e){if(null==e)d3filetreelocation.pop();else for(;d3filetreelocation.length>e;)d3filetreelocation.pop();d3updatefiles()}function d3getFileSel(){for(var e=[],t=document.getElementsByName("fcx"),n=0;n<t.length;n++)t[n].checked&&e.push(t[n].value);return e}function d3setActions(){1==d3fileoptions.dialog?1==Q("d3uploadMode").value?QE("idx_dlgOkButton",Q("d3localFile").value.length>0):QE("idx_dlgOkButton",1==d3getFileSel().length):2==d3fileoptions.dialog&&QE("idx_dlgOkButton",1==d3getFileSel().length)}var reportCSV=null;function generateReportDialog(){if(!xxdialogMode){var e="",t="",n=JSON.parse(getstore("_ReportSettings","{}")),o={1:"Удаленные сеансы",2:"Расход трафика пользователями",3:"Входы пользователей"};for(var i in 4294967295==userinfo.siteadmin&&(o[4]="Database Records"),o)e+="<option value="+i+(n.type==i?" selected":"")+">"+o[i]+"</option>";t+=addHtmlFormFloating("Тип",'<select id=d2reportType class="form-select" onchange=generateReportDialogValidate()>'+e+"</select>"),t+="<div id=d2GroupByDiv style=display:none>",e="";o={1:"Пользователь",2:"Устройство",3:"День"};for(var i in o)e+="<option value="+i+(n.groupBy==i?" selected":"")+">"+o[i]+"</option>";t+=addHtmlFormFloating("Группировать по",'<select id=d2groupBy class="form-select" onchange=generateReportDialogValidate()>'+e+"</select>"),t+="</div>",t+="<div id=d2GroupByDiv2 style=display:none>",e="";o={1:"Пользователь",3:"День"};for(var i in o)e+="<option value="+i+(n.groupBy2==i?" selected":"")+">"+o[i]+"</option>";t+=addHtmlFormFloating("Группировать по",'<select id=d2groupBy2 class="form-select" onchange=generateReportDialogValidate()>'+e+"</select>"),t+="</div>",t+="<div id=d2DeviceGroupDiv style=display:none>",e="<option value=0"+(0==n.devGroup?" selected":"")+">Все</option>";var a=getOrderedList(meshes,"name");for(var i in a)e+="<option value="+encodeURIComponentEx(a[i]._id)+(n.devGroup==a[i]._id?" selected":"")+">"+EscapeHtml(a[i].name)+"</option>";t+=addHtmlFormFloating("Группа устройств",'<select onchange=generateReportDialogValidate() id=d2groupId class="form-select">'+e+"</select>"),t+="</div>",t+="<div id=d2timeBackDiv style=display:none>",e="",null==n.timeRange&&(n.timeRange=1);o={1:"Последний день",7:"Последние 7 дней",30:"Последние 30 дней",0:"Временной диапазон"};for(var i in o)e+="<option value="+i+(n.timeRange==i?" selected":"")+">"+o[i]+"</option>";t+=addHtmlFormFloating("Время",'<select id=d2timeRange class="form-select" onchange=generateReportDialogValidate()>'+e+"</select>"),t+="</div>",t+="<div id=d2timeRangeDiv style=display:none>",t+=addHtmlFormFloating("Временный диапазон запускается",'<input id=d2timeRangeStartSelector class="flatpickr form-control" type="text" placeholder="Выберите дату и время..." data-id="altinput">'),t+=addHtmlFormFloating("Временный диапазон конец",'<input id=d2timeRangeEndSelector class="flatpickr form-control" type="text" placeholder="Выберите дату и время..." data-id="altinput">'),t+="</div>",t+="<div id=d2showTrafficDiv style=display:none>",t+=addHtmlValue("",'<div style=width:250px><label><input type=checkbox class="form-check-input me-2" id=d2showTraffic '+(n.showTraffic?"checked":"")+">Показать трафик</label><div>"),setModalContent("xxAddAgent","Создать отчет",t+="</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",()=>generateReportDialogEx("",xxdialogTag)),generateReportDialogValidate();var s=new Date;s.setDate(s.getDate()-7);var r=flatpickr("#d2timeRangeStartSelector",{enableTime:!0,maxDate:new Date,defaultDate:s,minuteIncrement:1,plugins:[new confirmDatePlugin({})],onChange:function(e,t,n){l.set("minDate",t),l.selectedDates[0]&&l.selectedDates[0]<e[0]&&l.clear()}}),l=flatpickr("#d2timeRangeEndSelector",{enableTime:!0,maxDate:new Date,defaultDate:new Date,minuteIncrement:1,plugins:[new confirmDatePlugin({})]});xxdialogTag={rangeStart:r,rangeEnd:l}}}function generateReportDialogValidate(){QV("d2timeRangeDiv",0==Q("d2timeRange").value),QV("d2timeBackDiv",4!=Q("d2reportType").value),QV("d2GroupByDiv",1==Q("d2reportType").value),QV("d2GroupByDiv2",3==Q("d2reportType").value),QV("d2DeviceGroupDiv",1==Q("d2reportType").value),QV("d2showTrafficDiv",1==Q("d2reportType").value)}function generateReportDialogEx(e,t){var n,o;0==Q("d2timeRange").value?(o=Math.floor(t.rangeEnd.selectedDates[0].getTime()/1e3),n=Math.floor(t.rangeStart.selectedDates[0].getTime()/1e3)):(o=Math.floor(new Date/1e3),n=new Date,n=Math.floor(n.setDate(n.getDate()-Q("d2timeRange").value)/1e3));var i=null;try{i=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}var a=decodeURIComponent(Q("d2groupId").value);0==a&&(a=null),putstore("_ReportSettings",JSON.stringify({type:parseInt(Q("d2reportType").value),groupBy:parseInt(Q("d2groupBy").value),groupBy2:parseInt(Q("d2groupBy2").value),timeRange:parseInt(Q("d2timeRange").value),devGroup:a,showTraffic:Q("d2showTraffic").checked}));var s=parseInt(Q("d2groupBy").value);3==Q("d2reportType").value&&(s=parseInt(Q("d2groupBy2").value)),meshserver.send({action:"report",type:parseInt(Q("d2reportType").value),groupBy:s,start:n,end:o,tz:i,tf:(new Date).getTimezoneOffset(),l:getLang(),devGroup:a,showTraffic:Q("d2showTraffic").checked})}function renderReport(e){var t={time:"Время",device:"Устройство",session:"Сессия",user:"Пользователь",devgroup:"Группа устройств",guest:"Гость",length:"Продолжительность",bytesin:"Входящих байт",bytesout:"Исходящих байт",os:"Операционная система",ip:"IP Адрес",browser:"Браузер",msg:"Сообщение",twofactor:"2-oй фактор"},n='<table class="table table-hover">',o=null,i=[];if(0==Object.keys(e.groups).length)reportCSV=null,QV("p60downloadReportDiv",!1),n+="<tr><td style=text-align:center;padding-top:32px>Отчет не вернул данных</tr></td>";else{for(var a in reportCSV='"Группа"',n+="<tr>",e.columns){var s;s=null!=t[e.columns[a].title]?t[e.columns[a].title]:EscapeHtml(e.columns[a].title);var r="";e.columns[a].align?r+=";text-align:"+EscapeHtml(e.columns[a].align):r+=";text-align:left",0!=a||"datetime"!=e.columns[a].format&&"time"!=e.columns[a].format||(r+=";width:1%"),n+="<th style="+r+">"+s+"</th>",reportCSV+=',"'+csvClean(s)+'"'}for(var a in n+="</tr>",reportCSV+="\r\n",e.groups)for(var l in n+="<tr style=height:8px></tr>",n+="<tr><td colspan="+e.columns.length+' style="border-bottom:1pt solid black"><b>',0!=a&&(n+=renderReportFormat(a,e.groupFormat)),n+="</b></td></tr>",e.groups[a].entries){var d=e.groups[a].entries[l];for(var c in n+="<tr>",reportCSV+=0!=a?'"'+csvClean(renderReportFormatCSV(a,e.groupFormat))+'"':'""',e.columns){r="";if(null!=e.columns[c].format&&(r="white-space:nowrap;"),e.columns[c].align&&(r="text-align:"+EscapeHtml(e.columns[c].align)),null!=d[e.columns[c].id]?(n+='<td style="'+r+'">'+renderReportFormat(d[e.columns[c].id],e.columns[c].format)+"</td>",reportCSV+=',"'+csvClean(renderReportFormatCSV(d[e.columns[c].id],e.columns[c].format))+'"'):(n+="<td></td>",reportCSV+=","),null!=e.columns[c].sumBy){var u=d[e.columns[c].sumBy];!0===e.columns[c].sumBy&&(u=!0);var p=d[e.columns[c].id];o=e.columns[c].sumBy,null!=p&&(-1==i.indexOf(u)&&i.push(u),null==e.columns[c].subtotals&&(e.columns[c].subtotals={},e.columns[c].totals={}),null==e.columns[c].subtotals[u]?e.columns[c].subtotals[u]=p:e.columns[c].subtotals[u]+=p,null==e.columns[c].totals[u]?e.columns[c].totals[u]=p:e.columns[c].totals[u]+=p)}}n+="</tr>",reportCSV+="\r\n"}if(null!=o){var m=-1;if(!0===o)m=99999;else for(var a in e.columns)e.columns[a].id==o&&(m=a);if(m>=0){i.sort();var g=!0;for(var l in n+="<tr style=height:8px></tr>",i){for(var a in n+="<tr>",e.columns)if(a==m){r="";e.columns[c].align&&(r+=";text-align:"+EscapeHtml(e.columns[c].align)),g&&(r+=";border-top:1pt solid #777"),n+='<td style="color:#777'+r+'">'+renderReportFormat(i[l],e.columns[a].format)}else if(null!=e.columns[a].totals){r="";e.columns[c].align&&(r+=";text-align:"+EscapeHtml(e.columns[c].align)),g&&(r+=";border-top:1pt solid #777"),n+='<td style="color:#777'+r+'">'+renderReportFormat(e.columns[a].totals[i[l]],e.columns[a].format)}else n+="<td></td>";n+="</tr>",g=!1}}}QV("p60downloadReportDiv",!0)}n+="</table>",QH("p60report",n)}function renderReportFormat(e,t){if(null==e)return"";if("datetime"==t)return printDateTime(new Date(e));if("time"==t)return printTime(new Date(e));if("protocol"==t)return 1==e?"Терминал":2==e?"Рабочий стол":5==e?"Файлы":6==e?"PowerShell от Админа":8==e?"Консоль от Пользователя":9==e?"PowerShell от Пользователя":100==e?"AMT-WSMAN":101==e?"AMT-Redir":200==e?"Мессенджер":201==e?"Web-RDP":202==e?"Web-SSH":203==e?"Web-SFTP":204==e?"Web-VNC":"Неизвестно ("+e+")";if("seconds"==t){var n=e%60,o=Math.floor(e/60)%60,i=Math.floor(e/3600);return zeroPad(i,2)+":"+zeroPad(o,2)+":"+zeroPad(n,2)}if("node"==t)return null!=(a=getNodeFromId(e))?"<div onclick='gotoDevice(\""+a._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px class="j'+a.icon+'"></div>'+EscapeHtml(a.name):"<i>Неизвестно</i>";if("mesh"==t)return null!=(c=meshes[e])?"<div onclick='gotoMesh(\""+c._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px;cursor:pointer class="m99"></div>'+EscapeHtml(c.name):"<i>Неизвестно</i>";if("nodemesh"==t){var a,s=null,r=null,l=e.split("/"),d="<table><tr>";if(l.length>=3&&(s=l[0]+"/"+l[1]+"/"+l[2]),l.length>=6&&(r=l[3]+"/"+l[4]+"/"+l[5]),null!=r){var c;if(null==(c=meshes[r]))return"<i>Неизвестно</i>";d+="<td><div onclick='gotoMesh(\""+c._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px;cursor:pointer class="m99"></div>'+EscapeHtml(c.name)+"&nbsp;&nbsp;&nbsp;</td>"}return null==(a=getNodeFromId(s))?"<i>Неизвестно</i>":(d+="<td><div onclick='gotoDevice(\""+a._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px class="j'+a.icon+'"></div>'+EscapeHtml(a.name)+"</td>",d+="</tr></table>")}if("user"==t){var u=null;if(e==userinfo._id?u=userinfo:null!=users&&(u=users[e]),null!=u){var p=u.name;return null!=u.realname&&(p+=", "+u.realname),"<div onclick='gotoUser(\""+u._id+'",10);haltEvent(event);\' style=float:left;margin-right:4px;cursor:pointer><i class="fa-solid fa-user-circle"></i></div>'+EscapeHtml(p)}return"<i>Неизвестный пользователь</i>"}if("msg"==t){if(107==e)return'<div style=float:left;margin-right:4px;cursor:pointer><i class="fa-solid fa-check-circle text-success"></i></div>Успешный вход';if(108==e)return'<div style=float:left;margin-right:4px;cursor:pointer class="NotifyIconTiny2"></div>Неверный 2-й фактор';if(109==e)return'<div style=float:left;margin-right:4px;cursor:pointer class="NotifyIconTiny4"></div>Заблокированная учетная запись';if(110==e)return'<div style=float:left;margin-right:4px;cursor:pointer><i class="fa-solid fa-exclamation-triangle text-warning"></i></div>Неудачная попытка входа'}if("2fa"==t){if(""==e)return"Пусто";if("backup"==e)return"Резервные коды";if("fido"==e)return"ключ FIDO";if("sms"==e)return"SMS-сообщение";if("hwotp"==e)return"Аппаратный OTP";if("messenger"==e)return"Messenging";if("push"==e)return"Push уведомление";if("otp"==e)return"Одноразовый пароль";if("cookie"==e)return"Запомнить устройство";if("tokenlogin"==e)return"Токен входа";if("ipaddr"==e)return"IP Адрес";if("sso"==e)return"Единая точка входа"}if("records"==t){var m={node:"Device record",mesh:"Device group record",user:"User records",sysinfo:"Device information records",iploc:"IP location information records",note:"Text notes records",ifinfo:"Network interface information records",cfile:"Configuration file records",lastconnect:"Last connection time records",power:"Device power transition records",events:"Event records",serverstats:"Server statistics records",ugrp:"User group records",deviceshare:"Device sharing records",logintoken:"Account login token records",smbios:"Device SMBIOS record",pmt:"Device Push Notification Record",meshcentral:"Device, users, groups and other records"};return null!=m[e]?m[e]:e}return EscapeHtml(e)}function renderReportFormatCSV(e,t){if("datetime"==t)return printDateTime(new Date(e));if("time"==t)return printTime(new Date(e));if("protocol"==t)return 1==e?"Терминал":2==e?"Рабочий стол":5==e?"Файлы":6==e?"PowerShell от Админа":8==e?"Консоль от Пользователя":9==e?"PowerShell от Пользователя":100==e?"AMT-WSMAN":101==e?"AMT-Redir":200==e?"Мессенджер":201==e?"Web-RDP":202==e?"Web-SSH":203==e?"Web-SFTP":204==e?"Web-VNC":"Неизвестно ("+e+")";if("node"==t){var n=getNodeFromId(e);if(null!=n)return n.name}if("mesh"==t){var o=meshes[e];if(null!=o)return o.name}if("user"==t){var i=null;if(e==userinfo._id?i=userinfo:null!=users&&(i=users[e]),null!=i){var a=i.name;return null!=i.realname&&(a+=" - "+i.realname),a}return"Неизвестный пользователь"}if("msg"==t){if(107==e)return"Успешный вход";if(108==e)return"Неверный 2-й фактор";if(109==e)return"Заблокированная учетная запись";if(110==e)return"Неудачная попытка входа"}return"records"==t?renderReportFormat(e,t):""+e}function p60downloadReport(){xxdialogMode||null==reportCSV||saveAs(stringToUtf8Blob(reportCSV),"Report.csv")}var notifications=[];function clickNotificationIcon(e){1==e?QV("notifiyBox",!0):0==e?QV("notifiyBox",!1):QV("notifiyBox","none"==QS("notifiyBox").display),drawNotifications()}function setNotificationCount(e){parseInt(Q("notificationCount").innerHTML)!=e&&(QH("notificationCount",e),QS("notificationCount")["background-color"]=0==e?"lightblue":"orange",QV("notificationCount",e>0))}function drawNotifications(){var e=getstore("notifications",0),t="";if(0==notifications.length)t="<div style=margin:5px>На данный момент уведомлений нет</div>";else for(var n in notifications){var o=notifications[n],i="",a=new Date(o.time),s=0;if(null!=o.title&&(i="<b>"+EscapeHtml(o.title)+"</b>: "),null!=o.nodeid){var r=getNodeFromId(o.nodeid);null!=r&&(s=r.icon,i=16&e?"<b>"+EscapeHtml(meshes[r.meshid].name)+" / "+EscapeHtml(r.name)+"</b>: ":"<b>"+EscapeHtml(r.name)+"</b>: ")}t+='<div title="'+format("Произошло в {0}",printDateTime(a))+'" id="notifyx'+o.id+'" class=notification style="cursor:pointer;border-top:1px solid '+(""==t?"transparent":"orange")+'">',s&&(t+="<div class=j"+s+' onclick="notificationSelected('+o.id+')" style=margin:5px;float:left></div>'),t+='<div onclick="notificationDelete('+o.id+')" class=unselectable title="Очистить это уведомление" style=margin:5px;float:right;color:orange><b>X</b></div><div onclick="notificationSelected('+o.id+')" style=margin:5px>'+i+EscapeHtml(o.text)+"</div><div style=margin-left:5px;margin-bottom:5px;color:gray;font-size:10px>"+printDateTime(a)+"</div></div>"}var l="";notifications.length>1&&(l='<div id="notifyRemoveAll" onclick="deleteAllNotifications()" style="cursor:pointer;border-top:1px solid orange;margin:5px;color:orange;text-align:right;padding-right:3px">Очистить все</div>'),QH("notifiyBox",'<div class=customScroll style="max-height:170px;overflow-y:auto;margin:5px">'+t+l+"</div>")}function notificationSelected(e,t){var n=-1;for(var o in notifications)notifications[o].id==e&&(n=o);-1!=n&&(notificationSelectedEx(notifications[n],e),t&&notifications[n]&&(notifications[n].notification&&(notifications[n].notification.close(),delete notifications[n].notification),notificationDelete(e)))}function notificationSelectedEx(e,t){null!=e.nodeid?"desktop"==e.tag?gotoDevice(e.nodeid,12):"terminal"==e.tag?gotoDevice(e.nodeid,11):"files"==e.tag?gotoDevice(e.nodeid,13):"intelamt"==e.tag?gotoDevice(e.nodeid,14):"console"==e.tag?gotoDevice(e.nodeid,15):gotoDevice(e.nodeid,10):"backupcodes"!=e.tag||xxdialogMode?null!=e.tag&&e.tag.startsWith("meshmessenger/")?(safeNewWindow("/messenger?id="+e.tag+"&title="+encodeURIComponentEx(e.username),e.tag.split("/")[2]),notificationDelete(t)):null!=e.url&&(safeNewWindow(e.url),notificationDelete(t)):(go(2),account_manageOtp(0),notificationDelete(t))}function notificationDelete(e){var t=-1,n=Q("notifyx"+e);if(null!=n){for(var o in notifications)notifications[o].id==e&&(t=o);if(-1!=t&&(meshserver.send({action:"intersession",subaction:"removeNotify",id:e}),notifications[t].notification&&(notifications[t].notification.close(),delete notifications[t].notification),notifications.splice(t,1),n.parentNode.removeChild(n),setNotificationCount(notifications.length),0==notifications.length&&QV("notifiyBox",!1),1==notifications.length&&QV("notifyRemoveAll",!1),notifications.length>0&&0==t)){var i=notifications[0];QS("notifyx"+i.id)["border-top"]="1px solid transparent"}}}function addNotification(e){if("number"==typeof e.titleid)try{e.title=[null,"Новый аккаунт","Лимит сервера","Предупреждение системы безопасности","Настройки аккаунта","Группа устройств","Пригласительные коды"][e.titleid]}catch(e){}if("number"==typeof e.msgid)try{e.text=[null,"В доступе отказано","Неверное имя пользователя","Неверный пароль","Неверный адрес электронной почты","Неверный домен","Недействительные разрешения сайта","Пользователь уже существует","Невозможно добавить пользователя в этом режиме","Исключение проверки","Достигнуто ограничение учетных записей.","Запрос чата, Нажмите здесь, чтобы принять.","С момента последнего входа в этот аккаунт было {0} неудачных попыток входа..","Не удалось изменить адрес электронной почты, другой аккаунт уже использует: {0}.","Письмо отправлено.","Пользователь {0} не найден.","Пользователи {0} не найдены.","Ошибка: невозможно изменить на ранее использованный пароль.","Ошибка: невозможно изменить на часто используемый пароль.","Ошибка, пароль не изменен.","Пароль изменен.","Текущий пароль неверен.",'Ошибка, пригласительный код "{0}" уже используется.',"SMS-шлюз не включен","Нет прав на управление пользователями","Неверное SMS-сообщение","У этого пользователя нет номера телефона","SMS succesfully sent.","Ошибка SMS","Ошибка SMS: {0}",'Домен почты "{0}" не разрешен. Разрешены только ({1})',"Invalid message","Message succesfully sent.","Message error","Message error: {0}"][e.msgid],Array.isArray(e.args)&&(e.text=format(e.text,e.args[0],e.args[1],e.args[2],e.args[3],e.args[4],e.args[5]))}catch(e){}null==e.time&&(e.time=Date.now()),null==e.id&&(e.id=Math.random()),notifications.unshift(e),setNotificationCount(notifications.length),clickNotificationIcon(!0);var t=getstore("notifications",0);1&t&&Q("chimes").play();var n=null;if(Notification&&"granted"==Notification.permission){var o=e.text.split("&reg;").join("").split("<b>").join("").split("</b>").join("").split("<br />").join("\r\n");if(e.nodeid){var i=getNodeFromId(e.nodeid);i&&(n=16&t?new Notification(decodeURIComponent("{{{extitle}}}")+" - "+meshes[i.meshid].name+" - "+i.name,{tag:e.tag,body:o,icon:"/images/notify/icons128-"+i.icon+".png"}):new Notification(decodeURIComponent("{{{extitle}}}")+" - "+i.name,{tag:e.tag,body:o,icon:"/images/notify/icons128-"+i.icon+".png"}))}else{null==e.icon&&(e.icon=0);var a=e.title;a=null==a?"":" - "+e.title,n=new Notification(decodeURIComponent("{{{extitle}}}")+a,{tag:e.tag,body:o,icon:"/images/notify/icons128-"+e.icon+".png"})}n.id=e.id,n.xtag=e.tag,n.url=e.url,n.nodeid=e.nodeid,n.username=e.username,n.onclick=function(e){notificationSelected(e.target.id,!0)},e.notification=n}if("number"==typeof e.maxtime&&e.maxtime>0){var s=function e(){notificationDelete(e.xid)};s.xid=e.id,setTimeout(s,1e3*e.maxtime)}}function deleteAllNotifications(){notifications=[],setNotificationCount(0),drawNotifications(),QV("notifiyBox",!1)}function setupGeneralServerStats(){window.serverStatCpu&&window.serverStatCpu.destroy(),window.serverStatMemory&&window.serverStatMemory.destroy(),window.serverStatCpu=new Chart(document.getElementById("serverCpuChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#AAAAAA","#00AA00"]}],labels:["Использовано","Свободно"]},options:{events:[],responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},width:"40px"}}),window.serverStatMemory=new Chart(document.getElementById("serverMemoryChart").getContext("2d"),{type:"doughnut",data:{datasets:[{data:[0,0],backgroundColor:["#AAAAAA","#00AA00"]}],labels:["Использовано","Свободно"]},options:{events:[],responsive:!0,plugins:{legend:{display:!1}},animation:{animateScale:!0,animateRotate:!0},width:"40px"}})}var lastServerStats=null;function updateGeneralServerStats(e){if(null!=e?lastServerStats=e:e=lastServerStats,null!=e){var t={ServerState:"Состояние сервера",AgentErrorCounters:"Счетчик ошибок агента",UnknownGroup:"Неизвестная группа",InvalidPKCSsignature:"Некорректная сигнатура PKCS",InvalidRSAsignature:"Некорректная сигнатура RSA",InvalidJSON:"Некорректный JSON",UnknownAction:"Неизвестное действие",BadWebCertificate:"Плохой веб-сертификат",BadSignature:"Плохой ключ",MaxSessionsReached:"Достигнуто максимальное число сессий",UnknownDeviceGroup:"Неизвестная группа устройств",InvalidDeviceGroupType:"Некорректный тип группы устройств",DuplicateAgent:"Повторяющийся агент",ConnectedIntelAMT:"Подключено Intel&reg; AMT",ConnectedIntelAMTCira:"Подключено Intel&reg; AMT CIRA",RelayErrors:"Ошибки ретранслятора",UserAccounts:"Учетные записи пользователей",DeviceGroups:"Группы устройств",AgentSessions:"Сессии агентов",ConnectedUsers:"Подключенные пользователи",UsersSessions:"Сессии пользователей",RelaySessions:"Сессии ретранслятора",RelayCount:"Число ретрансляций"};if(setupGeneralServerStats(),"object"==typeof e.cpuavg){var n=Math.min(e.cpuavg[0],1);window.serverStatCpu.config.data.datasets[0].data=[n,1-n],QH("serverCpuChartText",'<div style=margin-bottom:5px>Загрузка CPU</div><div><b title="Загрузка CPU за последнюю минуту">'+Math.round(100*e.cpuavg[0])/100+'</b>, <b title="Загрузка CPU за последние 5 минут">'+Math.round(100*e.cpuavg[1])/100+'</b>, <b title="Загрузка CPU за последние 15 минут">'+Math.round(100*e.cpuavg[2])/100+"</b></div>"),QS("serverCpuChartView").display="inline-block",window.serverStatCpu.update()}"number"==typeof e.totalmem&&"number"==typeof e.availablemem?(window.serverStatMemory.config.data.datasets[0].data=[e.totalmem-e.availablemem,e.availablemem],QH("serverMemoryChartText","<div style=margin-bottom:5px>Доступная память</div><div><b>"+getNiceSize3(e.availablemem)+"</b> свободно, <b>"+getNiceSize3(e.totalmem)+"</b> всего</div>"),QS("serverMemoryChartView").display="inline-block",window.serverStatMemory.update()):"number"==typeof e.totalmem&&"number"==typeof e.freemem&&(window.serverStatMemory.config.data.datasets[0].data=[e.totalmem-e.freemem,e.freemem],QH("serverMemoryChartText","<div style=margin-bottom:5px>ОЗУ</div><div><b>"+getNiceSize3(e.freemem)+"</b> свободно, <b>"+getNiceSize3(e.totalmem)+"</b> всего</div>"),QS("serverMemoryChartView").display="inline-block",window.serverStatMemory.update());var o="<div style=width:100% cellpadding=0 cellspacing=0>";if("object"==typeof e.values)for(var i in e.values)for(var a in o+="<div class=userTableHeader style=margin-bottom:4px;width:200px>"+(t[i]?t[i]:i)+"</div>",e.values[i])o+='<div style=display:inline-block class="me-2"><table class=serverStateTableCell><tr><td></td><td><span>'+(t[a]?t[a]:a)+"</span><span style=float:right>"+e.values[i][a]+"</span></td><td></td></tr></table></div>";o+="</div>",QH("serverStatsTable",o)}}var serverTimelineStats=null,serverTimelineConfig={type:"line",data:{labels:[],datasets:[{label:"",backgroundColor:"rgba(255, 99, 132, .5)",borderColor:"rgb(255, 99, 132)",data:[],fill:!0}]},options:{animation:!1,responsive:!0,maintainAspectRatio:!1,elements:{line:{cubicInterpolationMode:"monotone"}},scales:{x:{type:"time",time:{tooltipFormat:"ll HH:mm"},display:!0,title:{display:!1,text:""}},y:{type:"linear",display:!0,title:{display:!0,text:""},stacked:!0}}}};function refreshServerTimelineStats(e){null!=meshserver&&2==meshserver.State&&meshserver.send({action:"servertimelinestats",hours:720})}function pastDate(e){var t=new Date;return t.setTime(t.getTime()-36e5*e),t}function setServerTimelineStats(e){serverTimelineStats=e,updateServerTimelineStats()}function addServerTimelineStats(e){if(null!=serverTimelineStats){var t=null;if(null!=Q("p40server").value&&""==(t=decodeURIComponent(Q("p40server").value))&&(t=null),e.s==t){serverTimelineStats.push(e);var n=Q("p40type").value;0==n?(serverTimelineConfig.data.datasets[0].data.push({x:e.time,y:e.conn.ca}),serverTimelineConfig.data.datasets[1].data.push({x:e.time,y:e.conn.cu}),serverTimelineConfig.data.datasets[2].data.push({x:e.time,y:e.conn.us}),serverTimelineConfig.data.datasets[3].data.push({x:e.time,y:e.conn.rs}),serverTimelineConfig.data.datasets[4].data.push({x:e.time,y:e.conn.am}),null!=e.conn.amc&&serverTimelineConfig.data.datasets[5].data.push({x:e.time,y:e.conn.amc})):1==n?(serverTimelineConfig.data.datasets[0].data.push({x:e.time,y:e.mem.external/1048576}),serverTimelineConfig.data.datasets[1].data.push({x:e.time,y:e.mem.heapUsed/1048576}),serverTimelineConfig.data.datasets[2].data.push({x:e.time,y:e.mem.heapTotal/1048576}),serverTimelineConfig.data.datasets[3].data.push({x:e.time,y:e.mem.rss/1048576})):3==n||4==n?updateServerTimelineStats():5==n&&"object"==typeof e.cpu&&"number"==typeof e.cpu[0]&&serverTimelineConfig.data.datasets[0].data.push({x:e.time,y:e.cpu[0]}),updateServerTimelineHours()}}}function updateServerTimelineHours(){serverTimelineConfig.options.scales.y.type=Q("p40log").checked?"logarithmic":"linear",serverTimelineConfig.options.scales.x.min=pastDate(Q("p40time").value),window.serverMainStats.update()}function setupServerTimelineStats(){window.serverMainStats=new Chart(document.getElementById("serverMainStats").getContext("2d"),serverTimelineConfig)}const trafficSeriesNames=["Агент","CIRA","AMT-OS","HTTP","Ретранслятор","Терминал","Рабочий стол","Файлы","WebRDP","WebSSH","WebVNC","Мультиплексирование рабочего стола"],seriesColors=[[158,151,16],[16,84,158],[255,99,132],[39,158,16],[134,16,158],[0,148,255],[255,216,0],[255,127,237],[109,213,255],[89,94,255],[179,104,255],[179,104,255]];function seriesColor1(e){return"rgba("+(seriesColors[e][0]+(255-seriesColors[e][0])/1.5)+","+(seriesColors[e][1]+(255-seriesColors[e][1])/1.5)+","+(seriesColors[e][2]+(255-seriesColors[e][2])/1.5)+")"}function seriesColor2(e){return"rgba("+seriesColors[e][0]+","+seriesColors[e][1]+","+seriesColors[e][2]+")"}function updateServerTimelineStats(){if(null!=serverTimelineStats){var e,t=Q("p40type").value,n=pastDate(Q("p40time").value),o=[],i=null,a=!1,s=!0;if(null!=Q("p40server").value&&(""==(i=decodeURIComponent(Q("p40server").value))&&(i=null),s=!1),serverTimelineConfig.options.scales.x.min=n,serverTimelineConfig.options.scales.y.stacked=3==t||4==t,0==t){serverTimelineConfig.options.scales.y.title.text="Подключений ",e={labels:[pastDate(0),n],datasets:[{label:"Агенты",data:[],backgroundColor:"rgba(158, 151, 16, .1)",borderColor:"rgb(158, 151, 16)",fill:!0},{label:"Пользователи",data:[],backgroundColor:"rgba(16, 84, 158, .1)",borderColor:"rgb(16, 84, 158)",fill:!0},{label:"Сессии пользователя",data:[],backgroundColor:"rgba(255, 99, 132, .1)",borderColor:"rgb(255, 99, 132)",fill:!0},{label:"Сессии ретранслятора",data:[],backgroundColor:"rgba(39, 158, 16, .1)",borderColor:"rgb(39, 158, 16)",fill:!0},{label:"Intel AMT",data:[],backgroundColor:"rgba(134, 16, 158, .1)",borderColor:"rgb(134, 16, 158)",fill:!0},{label:"Intel AMT CIRA",data:[],backgroundColor:"rgba(255, 155, 0, .1)",borderColor:"rgb(255, 155, 0)",fill:!0}]};for(var r=0;r<serverTimelineStats.length;r++){new Date(serverTimelineStats[r].time);null!=serverTimelineStats[r].s&&-1==o.indexOf(serverTimelineStats[r].s)&&(o.push(serverTimelineStats[r].s),s&&(i=serverTimelineStats[r].s,s=!1)),null==serverTimelineStats[r].s&&(a=!0),serverTimelineStats[r].s==i&&(1==serverTimelineStats[r].first&&(e.datasets[0].data.push({x:serverTimelineStats[r].time-1,y:NaN}),e.datasets[1].data.push({x:serverTimelineStats[r].time-1,y:NaN}),e.datasets[2].data.push({x:serverTimelineStats[r].time-1,y:NaN}),e.datasets[3].data.push({x:serverTimelineStats[r].time-1,y:NaN}),e.datasets[4].data.push({x:serverTimelineStats[r].time-1,y:NaN}),e.datasets[5].data.push({x:serverTimelineStats[r].time-1,y:NaN})),serverTimelineStats[r].conn&&(e.datasets[0].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].conn.ca}),e.datasets[1].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].conn.cu}),e.datasets[2].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].conn.us}),e.datasets[3].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].conn.rs}),e.datasets[4].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].conn.am}),null!=serverTimelineStats[r].conn.amc&&e.datasets[5].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].conn.amc})))}}else if(1==t){serverTimelineConfig.options.scales.y.title.text="Мегабайт",e={labels:[pastDate(0),n],datasets:[{label:"Внешний",data:[],backgroundColor:"rgba(158, 151, 16, .1)",borderColor:"rgb(158, 151, 16)",fill:!0},{label:"Heap Used",data:[],backgroundColor:"rgba(16, 84, 158, .1)",borderColor:"rgb(16, 84, 158)",fill:!0},{label:"Heap Total",data:[],backgroundColor:"rgba(255, 99, 132, .1)",borderColor:"rgb(255, 99, 132)",fill:!0},{label:"RSS",data:[],backgroundColor:"rgba(39, 158, 16, .1)",borderColor:"rgb(39, 158, 16)",fill:!0}]};for(r=0;r<serverTimelineStats.length;r++)null!=serverTimelineStats[r].s&&-1==o.indexOf(serverTimelineStats[r].s)&&(o.push(serverTimelineStats[r].s),s&&(i=serverTimelineStats[r].s,s=!1)),null==serverTimelineStats[r].s&&(a=!0),serverTimelineStats[r].s==i&&(1==serverTimelineStats[r].first&&(e.datasets[0].data.push({x:serverTimelineStats[r].time-1,y:NaN}),e.datasets[1].data.push({x:serverTimelineStats[r].time-1,y:NaN}),e.datasets[2].data.push({x:serverTimelineStats[r].time-1,y:NaN}),e.datasets[3].data.push({x:serverTimelineStats[r].time-1,y:NaN})),e.datasets[0].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].mem.external/1048576}),e.datasets[1].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].mem.heapUsed/1048576}),e.datasets[2].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].mem.heapTotal/1048576}),e.datasets[3].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].mem.rss/1048576}))}else if(3==t||4==t){serverTimelineConfig.options.scales.y.title.text="Мегабайт",e={labels:[pastDate(0),n],datasets:[]};var l=0;for(r=0;r<serverTimelineStats.length;r++)null!=serverTimelineStats[r].traffic&&(null!=serverTimelineStats[r].s&&-1==o.indexOf(serverTimelineStats[r].s)&&(o.push(serverTimelineStats[r].s),s&&(i=serverTimelineStats[r].s,s=!1)),null==serverTimelineStats[r].s&&(a=!0),serverTimelineStats[r].s==i&&serverTimelineStats[r].traffic&&(serverTimelineStats[r].traffic.AgentCtrlIn>0&&(l|=1),serverTimelineStats[r].traffic.CIRAIn>0&&(l|=2),serverTimelineStats[r].traffic.LMSIn>0&&(l|=4),serverTimelineStats[r].traffic.httpIn>0&&(l|=8),serverTimelineStats[r].traffic.relayIn&&(serverTimelineStats[r].traffic.relayIn[0]>0&&(l|=16),serverTimelineStats[r].traffic.relayIn[1]>0&&(l|=32),serverTimelineStats[r].traffic.relayIn[2]>0&&(l|=64),serverTimelineStats[r].traffic.relayIn[5]>0&&(l|=128),serverTimelineStats[r].traffic.relayIn[10]>0&&(l|=256),serverTimelineStats[r].traffic.relayIn[11]>0&&(l|=512),serverTimelineStats[r].traffic.relayIn[12]>0&&(l|=1024)),serverTimelineStats[r].traffic.desktopMultiplex&&serverTimelineStats[r].traffic.desktopMultiplex.in>0&&(l|=2048)));for(r=0;r<13;r++)l&1<<r&&e.datasets.push({label:trafficSeriesNames[r],data:[],backgroundColor:seriesColor1(r),borderColor:seriesColor2(r),fill:!0,steppedLine:!0});for(r=0;r<serverTimelineStats.length;r++)if(null!=serverTimelineStats[r].traffic&&(null!=serverTimelineStats[r].s&&-1==o.indexOf(serverTimelineStats[r].s)&&(o.push(serverTimelineStats[r].s),s&&(i=serverTimelineStats[r].s,s=!1)),null==serverTimelineStats[r].s&&(a=!0),serverTimelineStats[r].s==i)){if(1==serverTimelineStats[r].first)for(var d=1;d<61440;d<<=1)l&d&&e.datasets[0].data.push({x:serverTimelineStats[r].time-1,y:NaN});var c=0;3==t?(1&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.AgentCtrlIn?serverTimelineStats[r].traffic.AgentCtrlIn/1048576:0}),2&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.CIRAIn?serverTimelineStats[r].traffic.CIRAIn/1048576:0}),4&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.LMSIn?serverTimelineStats[r].traffic.LMSIn/1048576:0}),8&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.httpIn?serverTimelineStats[r].traffic.httpIn/1048576:0}),16&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[0]?serverTimelineStats[r].traffic.relayIn[0]/1048576:0}),32&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[1]?serverTimelineStats[r].traffic.relayIn[1]/1048576:0}),64&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[2]?serverTimelineStats[r].traffic.relayIn[2]/1048576:0}),128&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[5]?serverTimelineStats[r].traffic.relayIn[5]/1048576:0}),256&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[10]?serverTimelineStats[r].traffic.relayIn[10]/1048576:0}),512&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[11]?serverTimelineStats[r].traffic.relayIn[11]/1048576:0}),1024&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayIn&&serverTimelineStats[r].traffic.relayIn[12]?serverTimelineStats[r].traffic.relayIn[12]/1048576:0}),2048&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.desktopMultiplex&&serverTimelineStats[r].traffic.desktopMultiplex.in?serverTimelineStats[r].traffic.desktopMultiplex.in/1048576:0})):4==t&&(1&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.AgentCtrlOut?serverTimelineStats[r].traffic.AgentCtrlOut/1048576:0}),2&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.CIRAOut?serverTimelineStats[r].traffic.CIRAOut/1048576:0}),4&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.LMSOut?serverTimelineStats[r].traffic.LMSOut/1048576:0}),8&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.httpOut?serverTimelineStats[r].traffic.httpOut/1048576:0}),16&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[0]?serverTimelineStats[r].traffic.relayOut[0]/1048576:0}),32&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[1]?serverTimelineStats[r].traffic.relayOut[1]/1048576:0}),64&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[2]?serverTimelineStats[r].traffic.relayOut[2]/1048576:0}),128&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[5]?serverTimelineStats[r].traffic.relayOut[5]/1048576:0}),256&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[10]?serverTimelineStats[r].traffic.relayOut[10]/1048576:0}),512&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[11]?serverTimelineStats[r].traffic.relayOut[11]/1048576:0}),1024&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.relayOut&&serverTimelineStats[r].traffic.relayOut[12]?serverTimelineStats[r].traffic.relayOut[12]/1048576:0}),2048&l&&e.datasets[c++].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].traffic.desktopMultiplex&&serverTimelineStats[r].traffic.desktopMultiplex.out?serverTimelineStats[r].traffic.desktopMultiplex.out/1048576:0}))}}else if(5==t){serverTimelineConfig.options.scales.y.title.text="Использование",e={labels:[pastDate(0),n],datasets:[{label:"CPU",data:[],backgroundColor:"rgba(158, 151, 16, .1)",borderColor:"rgb(158, 151, 16)",fill:!0}]};for(r=0;r<serverTimelineStats.length;r++)if("object"==typeof serverTimelineStats[r].cpu&&"number"==typeof serverTimelineStats[r].cpu[0]){if(null!=serverTimelineStats[r].s&&-1==o.indexOf(serverTimelineStats[r].s)&&(o.push(serverTimelineStats[r].s),s&&(i=serverTimelineStats[r].s,s=!1)),null==serverTimelineStats[r].s&&(a=!0),serverTimelineStats[r].s!=i)continue;1==serverTimelineStats[r].first&&e.datasets[0].data.push({x:serverTimelineStats[r].time-1,y:NaN}),e.datasets[0].data.push({x:serverTimelineStats[r].time,y:serverTimelineStats[r].cpu[0]})}}if(serverTimelineConfig.data=e,window.serverMainStats.update(),o.length>0){var u="";for(r=0;r<o.length;r++)u+='<option value="'+encodeURIComponentEx(o[r])+'"'+(i==o[r]?" selected":"")+">"+EscapeHtml(o[r])+"</option>";a&&(u+='<option value=""'+(null==i?" selected":"")+">Null</option>"),QH("p40server",u)}QV("p40server",o.length>0)}}function p40downloadEvents(){for(var e="time, conn.agent, conn.users, conn.usersessions, conn.relaysession, conn.intelamt, mem.external, mem.heapused, mem.heaptotal, mem.rss\r\n",t=0;t<serverTimelineStats.length;t++)serverTimelineStats[t].conn&&serverTimelineStats[t].mem&&(e+=new Date(serverTimelineStats[t].time)+", "+serverTimelineStats[t].conn.ca+", "+serverTimelineStats[t].conn.cu+", "+serverTimelineStats[t].conn.us+", "+serverTimelineStats[t].conn.rs+", "+(serverTimelineStats[t].conn.am?serverTimelineStats[t].conn.am:"")+", "+serverTimelineStats[t].mem.external+", "+serverTimelineStats[t].mem.heapUsed+", "+serverTimelineStats[t].mem.heapTotal+", "+serverTimelineStats[t].mem.rss+"\r\n");saveAs(stringToUtf8Blob(e),"ServerStats.csv")}var xxdialogMode,xxdialogFunc,xxdialogButtons,xxdialogTag,serverTrace=[],serverTraceSources=[];function displayServerTrace(){var e="",t=parseInt(Q("p41limitdropdown").value);for(var n in serverTrace.length>t&&serverTrace.splice(t),serverTrace){var o=[];for(var i in serverTrace[n].args)"object"==typeof serverTrace[n].args[i]?o.push(JSON.stringify(serverTrace[n].args[i])):o.push(serverTrace[n].args[i]);e+="<div class=traceEvent onclick=showTraceEvent("+n+")>"+EscapeHtml(new Date(serverTrace[n].time).toLocaleTimeString())+" - <b>"+EscapeHtml(serverTrace[n].source.toUpperCase())+"</b>: "+EscapeHtml(o.join(", "))+"</div>"}QH("p41events",e)}function showTraceEvent(e){var t=serverTrace[e],n="";if(!xxdialogMode&&null!=t){for(var e in t.args)"object"==typeof t.args[e]?n+=EscapeHtml(JSON.stringify(t.args[e]))+"<br /><br />":n+=EscapeHtml(t.args[e])+"<br /><br />";xxdialogButtons=1,setModalContent("xxAddAgent","Событие трассировки сервера","<div class=selecttext style=max-height:300px;overflow-y:auto>"+n+"</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",null)}}function clearServerTracing(){serverTrace=[],displayServerTrace()}function setServerTracing(){var e='<div style="max-height:200px;overflow-y:auto">';e+='<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:5px"><b>Основной сервер</b></div>',e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c1 '+(serverTraceSources.indexOf("cookie")>=0?"checked":"")+">Cookie-кодировщик</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c2 '+(serverTraceSources.indexOf("dispatch")>=0?"checked":"")+">Диспетчер сообщения</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c3 '+(serverTraceSources.indexOf("main")>=0?"checked":"")+">Сообщения главного сервера</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c4 '+(serverTraceSources.indexOf("peer")>=0?"checked":"")+">Соединения сервера MeshCentral</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c15 '+(serverTraceSources.indexOf("agent")>=0?"checked":"")+">Трафик MeshAgent</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c14 '+(serverTraceSources.indexOf("agentupdate")>=0?"checked":"")+">Обновление MeshAgent</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c16 '+(serverTraceSources.indexOf("cert")>=0?"checked":"")+">Сертификат сервера</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c17 '+(serverTraceSources.indexOf("db")>=0?"checked":"")+">База данных сервера</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c18 '+(serverTraceSources.indexOf("email")>=0?"checked":"")+">Email/SMS/Push трафик</label></div>",e+='<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:5px"><b>Веб-сервер</b></div>',e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c5 '+(serverTraceSources.indexOf("web")>=0?"checked":"")+">Веб-сервер</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c6 '+(serverTraceSources.indexOf("webrequest")>=0?"checked":"")+">Запросы веб-сервера</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c7 '+(serverTraceSources.indexOf("relay")>=0?"checked":"")+">Ретранслятор Web Socket</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c20 '+(serverTraceSources.indexOf("httpheaders")>=0?"checked":"")+">Заголовки HTTP веб-сервера</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c21 '+(serverTraceSources.indexOf("authlog")>=0?"checked":"")+">User Authentication Log</label></div>",e+='<div style="width:100%;border-bottom:1px solid gray;margin-bottom:5px;margin-top:5px"><b>Intel&reg; AMT</b></div>',e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c19 '+(serverTraceSources.indexOf("amt")>=0?"checked":"")+">Менеджер Intel AMT</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c9 '+(serverTraceSources.indexOf("webrelay")>=0?"checked":"")+">Ретранслятор подключений</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c10 '+(serverTraceSources.indexOf("mps")>=0?"checked":"")+">CIRA Сервер</label></div>",e+='<div><label><input type=checkbox class="form-check-input me-2" id=p41c11 '+(serverTraceSources.indexOf("mpscmd")>=0?"checked":"")+">CIRA Сервер команды</label></div>",setModalContent("xxAddAgent","Трассировка сервера",e+="</div>"),showModal("xxAddAgentModal","idx_dlgOkButton",setServerTracingEx)}function setServerTracingEx(){for(var e=[],t=["cookie","dispatch","main","peer","web","webrequest","relay","webrelaydata","webrelay","mps","mpscmd","swarm","swarmcmd","agentupdate","agent","cert","db","email","amt","httpheaders","authlog"],n=1;n<22;n++)try{Q("p41c"+n).checked&&e.push(t[n-1])}catch(e){}meshserver.send({action:"traceinfo",traceSources:e})}function p41downloadServerTrace(){var e="time, source, message\r\n";for(var t in serverTrace)e+='"'+new Date(serverTrace[t].time).toLocaleTimeString()+'","'+serverTrace[t].source+'","'+serverTrace[t].args.join(", ")+'"\r\n';return saveAs(stringToUtf8Blob(e),"servertrace.csv"),!1}function setupServiceWorker(){8&features2&&"string"==typeof serverinfo.vapidpublickey&&null!=Notification&&"granted"==Notification.permission&&"serviceWorker"in navigator&&navigator.serviceWorker.register("serviceworker.js").then(function(e){navigator.serviceWorker.ready.then(function(e){e.pushManager.subscribe({applicationServerKey:urlBase64ToUint8Array(serverinfo.vapidpublickey),userVisibleOnly:!0}).then(function(e){meshserver.send({action:"webpush",sub:e})}).catch(function(e){console.error("Worker: Unable to subscribe to push",e)})})}).catch(function(e){console.log("Worker: Registration failed",e)})}var xxcurrentView=-1;function setDialogMode(e,t,n,o,i,a){setSessionActivity(),QV("uiMenu",!1),xxdialogMode=e,xxdialogFunc=o,xxdialogButtons=n,xxdialogTag=a,QV("id_dialogclose",2&n||8&n),QV("idx_dlgDeleteButton",4&n),QV("idx_dlgButtonBar",7&n),QV("idx_dlgMoreButtons",16&n),t&&QH("xxAddAgentTitle",t);for(var s=1;s<24;s++)QV("dialog"+s,s==e);QV("dialog",e),i&&(2==e?QH("id_dialogOptions",i):QH("id_dialogMessage",i)),0==e&&xxModal&&xxModal.hide(),MoreToggle(!1)}function dialogclose(e){setSessionActivity();(8&xxdialogButtons||e)&&xxdialogFunc&&xxdialogFunc(e,xxdialogTag)}function center(){setSessionActivity(),11==xxcurrentView?deskAdjust():10==xxcurrentView?mainUpdate(256):1==xxcurrentView&&mainUpdate(4)}function messagebox(e,t){setSessionActivity(),QH("id_dialogMessage",t),setDialogMode(1,e,1)}function statusbox(e,t){setSessionActivity(),QH("id_dialogMessage",t),setDialogMode(1,e)}var backStack=[];function goBack(){setSessionActivity(),xxdialogMode||0==goBackStack.length||(fullscreen&&deskToggleFull(),go(goBackStack.pop()),goBackStack.pop())}function goForward(e){xxdialogMode||(backStack.push(e),goStack())}function goStack(){if(0!=backStack.length){var e=backStack[backStack.length-1],t=e.split("/")[0];if("node"==t&&(setupDeviceMenu(0),gotoDevice(e)),"mesh"==t&&gotoMesh(e),"devices"==t&&go(1),"account"==t&&go(2),"events"==t&&go(3),"users"==t&&go(4),"files"==t){if(262144&features&&!(1==userinfo.otpsecret||userinfo.otphkeys>0||userinfo.otpkeys>0||8388608&features&&1==userinfo.otpekey))return void setDialogMode(2,"Безопасность учетной записи",1,null,'Unable to access this feature until two-factor authentication is enabled. This is required for extra security. Go to the "My Account" and look at the "Account Security" section.');go(5)}"server"==t&&go(6)}else go(2)}function go(e,t){if((!t||3!=t.which&&2!=t.button)&&(262144&features&&0==count2factoraAuths()&&e>2&&(e=2,setModalContent("xxAddAgent","Безопасность учетной записи",'Unable to access this feature until two - factor authentication is enabled.This is required for extra security.Go to the "My Account" tab and look at the "Account Security" section.'),showModal("xxAddAgentModal","idx_dlgOkButton")),null!=pluginHandler&&pluginHandler.callHook("goPageStart",e,t),setSessionActivity(),!xxdialogMode))if(QV("uiMenu",!1),!t||1!=t.shiftKey&&2!=t.which&&1!=t.button||15==e||""!="{{{currentNode}}}".toLowerCase()){if(xxcurrentView!=e){xxcurrentView<0||e<10?goBackStack=[]:50!=xxcurrentView&&Math.floor(xxcurrentView/10)==Math.floor(e/10)||goBackStack.push(xxcurrentView),11==xxcurrentView&&null!=desktop&&null!=desktop.m.recordedData&&deskRecordSession(),(4==e&&null!=userinfo&&!(2&userinfo.siteadmin)||4&features)&&(e=52),17==xxcurrentView&&deviceDetailsStatsClear();for(var n=0;n<61;n++)QV("p"+n,n==e);if(xxcurrentView=e,fullscreen&&deskToggleFull(),!(268435456&features)&&xxcurrentView>0){var o="";for(var n in xxcurrentView>=10&&xxcurrentView<=19?null!=currentNode&&(o="?viewmode="+xxcurrentView+"&gotonode="+currentNode._id.split("/")[2]):xxcurrentView>=20&&xxcurrentView<=29?null!=currentMesh&&(o="?viewmode="+xxcurrentView+"&gotomesh="+currentMesh._id.split("/")[2]):xxcurrentView>=30&&xxcurrentView<=39?null!=currentUser&&(o="?viewmode="+xxcurrentView+"&gotouser="+(serverinfo.crossDomain?currentUser._id:currentUser._id.split("/")[2])):xxcurrentView>=51&&xxcurrentView<=51?null!=currentUserGroup&&null!=currentUserGroup._id&&(o="?viewmode="+xxcurrentView+"&gotougrp="+(serverinfo.crossDomain?currentUserGroup._id:currentUserGroup._id.split("/")[2])):xxcurrentView>1&&(o="?viewmode="+xxcurrentView),urlargs)o+=(""==o?"?":"&")+n+"="+urlargs[n];try{window.history.replaceState({},document.title,window.location.pathname+o)}catch(e){}}var i=["MainMenuMyDevices","MainMenuMyAccount","MainMenuMyEvents","MainMenuMyFiles","MainMenuMyUsers","MainMenuMyServer"];for(var n in i)QC(i[n]).remove("fullselect"),QC(i[n]).remove("semiselect");var a=["LeftMenuMyDevices","LeftMenuMyAccount","LeftMenuMyEvents","LeftMenuMyFiles","LeftMenuMyUsers","LeftMenuMyServer"];for(var n in a)QC(a[n]).remove("lbbuttonsel"),QC(a[n]).remove("lbbuttonsel2");var s=e<9?"fullselect":"semiselect",r=e<9||115==e||40==e||41==e||42==e?"lbbuttonsel2":"lbbuttonsel",l=0;goBackStack.length>0&&(l=goBackStack[goBackStack.length-1]),1==e||1==l||0==l&&e>=10&&e<20?(QC("MainMenuMyDevices").add(s),QC("LeftMenuMyDevices").add(r)):2==e||2==l||0==l&&e>=20&&e<30?(QC("MainMenuMyAccount").add(s),QC("LeftMenuMyAccount").add(r)):3==e||60==e?(QC("MainMenuMyEvents").add(s),QC("LeftMenuMyEvents").add(r)):4==e||e>=30&&e<40||50==e||51==e||52==e?(QC("MainMenuMyUsers").add(s),QC("LeftMenuMyUsers").add(r)):5==e?(QC("MainMenuMyFiles").add(s),QC("LeftMenuMyFiles").add(r)):(6==e||115==e||e>=40&&e<50)&&(QC("MainMenuMyServer").add(s),QC("LeftMenuMyServer").add(r)),QV("ServerPlugins",null!=pluginHandler),webPageStackMenu&&e>=10?QC("column_l").add("room4submenu"):QC("column_l").remove("room4submenu"),QV("topbar",0!=e),0==e&&webPageFullScreen&&QC("body").add("arg_hide"),QV("MainSubMenuSpan",e>=10&&e<20),QV("UserDummyMenuSpan",51==e||e<10&&6!=e&&webPageFullScreen),QV("MeshSubMenuSpan",e>=20&&e<30),QV("UserSubMenuSpan",e>=30&&e<40),QV("ServerSubMenuSpan",6==e||115==e||40==e||41==e||42==e||43==e),QV("UsersSubMenuSpan",4==e||50==e||52==e),QV("EventsSubMenuSpan",3==e||60==e);var d={3:"EventsLive",4:"UsersGeneral",10:"MainDev",11:"MainDevDesktop",12:"MainDevTerminal",13:"MainDevFiles",14:"MainDevAmt",15:"MainDevConsole",16:"MainDevEvents",17:"MainDevInfo",19:"MainDevPlugins",20:"MeshGeneral",21:"MeshSummary",30:"UserGeneral",31:"UserEvents",6:"ServerGeneral",40:"ServerStats",41:"ServerTrace",42:"ServerPlugins",50:"UsersGroups",52:"UsersRecordings",60:"EventsReport",115:"ServerConsole"};for(var n in d)QC(d[n]).remove("style3x"),QC(d[n]).remove("style3sel"),QC(d[n]).add(e==n?"style3sel":"style3x");11==e&&deskAdjust(),115==e&&QV("p15",!0),QV("p15uploadCore",115!=e),QV("p15BackButton",115!=e&&!(32&args.hide)&&""=="{{currentNode}}".toLowerCase()),15!=e&&115!=e||setupConsole(),1==e&&mainUpdate(4),2==e&&Notification&&QV("accountEnableNotificationsSpan","granted"!=Notification.permission),40==e&&null==serverTimelineStats&&refreshServerTimelineStats(),42==e&&refreshPluginLatest(),21==e&&p21updateMesh(),52==e&&(null==p52recordings&&refreshRecodings(),updateRecordings()),12==e&&null!=xtermfit&&(xtermfit.fit(),xterm.focus()),document.title=currentNode&&e>=10&&e<20?currentNode.name+(meshes[currentNode.meshid]?" - "+meshes[currentNode.meshid].name:"")+" - "+decodeURIComponent("{{{extitle}}}"):decodeURIComponent("{{{extitle}}}"),null!=pluginHandler&&pluginHandler.callHook("goPageEnd",e,t),QS("column_l").overflow=[11,12].indexOf(e)>=0?"hidden":null}}else e>=10&&e<=19?currentNode&&safeNewWindow(window.location.origin+"{{{domainurl}}}?gotonode="+currentNode._id.split("/")[2]+"&viewmode="+e+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+currentNode._id):e>=20&&e<=29?currentMesh&&safeNewWindow(window.location.origin+"{{{domainurl}}}?gotomesh="+currentMesh._id.split("/")[2]+"&viewmode="+e+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+currentMesh._id):e>=30&&e<=39?currentUser&&safeNewWindow(window.location.origin+"{{{domainurl}}}?gotouser="+(serverinfo.crossDomain?currentUser._id:currentUser._id.split("/")[2])+"&viewmode="+e+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+currentUser._id):e>=50&&e<=59?currentUserGroup&&safeNewWindow(window.location.origin+"{{{domainurl}}}?gotougrp="+(serverinfo.crossDomain?currentUserGroup._id:currentUserGroup._id.split("/")[2])+"&viewmode="+e+"&hide=16"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+currentUserGroup._id):safeNewWindow(window.location.origin+"{{{domainurl}}}?viewmode="+e+"&hide=0"+(urlargs.key?"&key="+urlargs.key:""),"meshcentral:"+e)}function updatePluginList(e){if(null!=pluginHandler){if(Array.isArray(e)&&e.forEach(function(e){updatePluginList(e)}),QV("pluginNoneNotice",0==installedPluginList.length),installedPluginList.length){if(null!=e&&(null==installedPluginList.version_info&&(installedPluginList.version_info=[]),installedPluginList.version_info[e.id]=e),(a=Q("p42tbl").querySelectorAll(".p42tblRow")).length)for(var t in Object.values(a))a[t].parentNode.removeChild(a[t]);var n={0:{text:"Disabled",color:"858483"},1:{text:"Installed",color:"00aa00"}},o={0:{install:"Install",delete:"Delete"},1:{disable:"Disable",upgrade:"Upgrade"}},i=Q("p42tbl");installedPluginList.forEach(function(e){var t=[];if(1==e.hasAdminPanel&&e.status?e.nameHtml="<a onclick=\"return goPlugin('"+e.shortName+"', '"+e.name.replace(/'/g,"\\'")+"');\">"+EscapeHtml(e.name)+"</a>":e.nameHtml=EscapeHtml(e.name),e.statusText=n[e.status].text,e.statusColor=n[e.status].color,null==e.versionHistoryUrl&&t.push("downgrade"),e.status||(e.version=" - "),e.upgradeAvail="Проверка...",null!=installedPluginList.version_info&&null!=installedPluginList.version_info[e._id]){var a=installedPluginList.version_info[e._id];a.hasUpdate?e.upgradeAvail='<a title="Просмотр журнала изменений" rel="noreferrer noopener" target="_blank" href="'+a.changelogUrl+'">'+a.version+"</a>":(t.push("upgrade"),e.status?e.upgradeAvail="Актуально":e.upgradeAvail='<a title="Просмотр журнала изменений" rel="noreferrer noopener" target="_blank" href="'+a.changelogUrl+'">'+a.version+"</a>"),a.meshCentralCompat||(e.upgradeAvail+=" [ <span onclick=\"return setModalContent('xxAddAgent', 'Compatibility Issue', 'This plugin version is not compatible with your MeshCentral installation, please upgrade MeshCentral first.');showModal('xxAddAgentModal', 'idx_dlgOkButton');\" title=\"Версия несовместима, пожалуйста, сначала обновите установку MeshCentral\" style=\"cursor: pointer; color:red;\"> ! </span> ]",t.push("install"),t.push("upgrade"))}e.actions="<select onchange=\"return pluginAction(this,'"+e._id+'\');"><option value=""> --</option>';var s=Object.entries(o[e.status]);for(var r in s)-1===t.indexOf(s[r][0])&&(e.actions+='<option value="'+s[r][0]+'">'+s[r][1]+"</option>");e.actions+="</select>";var l="<td><img style=margin-top:3px src=images/plugin24.png></td><td class=gradTable1>&nbsp;</td><td class=gradTable2>"+e.nameHtml+"</td><td class=gradTable2>"+EscapeHtml(e.description)+'</td><td class=gradTable2 style=text-align:center><a href="'+EscapeHtml(e.homepage)+'" rel="noreferrer noopener" target="_blank">Home</a></td><td class=gradTable2 style=text-align:center>'+EscapeHtml(e.version)+'</td><td style=text-align:center class="pluginUpgradeAvailable gradTable2">'+e.upgradeAvail+'</td><td class=gradTable2 style="text-align:center;color:#'+e.statusColor+'">'+e.statusText+'</td><td class="pluginAction gradTable2" style=text-align:center>'+e.actions+"</td><td class=gradTable3>&nbsp;</td>",d=i.insertRow(-1);d.innerHTML=l,d.classList.add("p42tblRow"),d.setAttribute("data-id",e._id),d.setAttribute("id","pluginRow-"+e._id)})}else{var a=Q("p42tbl").querySelectorAll(".p42tblRow");for(var t in Object.values(a))a[t].parentNode.removeChild(a[t])}null==e&&refreshPluginLatest()}}function refreshPluginLatest(){null!=pluginHandler&&meshserver.send({action:"pluginLatestCheck"})}function distributeCore(){null!=pluginHandler&&(meshserver.send({action:"distributeCore",nodes:nodes}),QV("pluginRestartNotice",!1))}function pluginActionEx(){if(null!=pluginHandler){var e=Q("lastPluginAct").value,t=Q("lastPluginId").value,n=Q("lastPluginVersion").value;switch(e){case"upgrade":case"install":meshserver.send({action:"installplugin",id:t,version_only:!1});break;case"downgrade":Q("lastPluginVersion").querySelectorAll("option").forEach(function(e){e.value==n&&(pVers=e.text)}),meshserver.send({action:"installplugin",id:t,version_only:{name:pVers,url:n}});break;case"delete":meshserver.send({action:"removeplugin",id:t});break;case"disable":meshserver.send({action:"disableplugin",id:t})}QV("pluginRestartNotice",!0)}}function pluginAction(e,t){if(null!=pluginHandler){if("downgrade"==e.value)meshserver.send({action:"getpluginversions",id:t});else{var n=null;for(var o in installedPluginList)installedPluginList[o]._id==t&&(n=installedPluginList[o]);setModalContent("xxAddAgent","Действие плагина",format("Вы уверенны, что {0} плагин: {1}",e.value,n.name)+'<input id="lastPluginAct" type="hidden" value="'+e.value+'" /><input id="lastPluginId" type="hidden" value="'+t+'" /><input id="lastPluginVersion" type="hidden" value="" />'),showModal("xxAddAgentModal","idx_dlgOkButton",()=>pluginActionEx())}e.value=""}}function goPlugin(e,t){null!=pluginHandler&&(null==e?Q("p43iframe").src="":(QH("p43title",t),Q("p43iframe").src="/pluginadmin.ashx?pin="+e,go(43)))}function removeUserRights(e,t){if(t!=userinfo._id||null==userinfo.removeRights)return e;var n=0,o=0;return 8&userinfo.removeRights&&(o+=8),65536&userinfo.removeRights&&(n+=65536),256&userinfo.removeRights&&(n+=256),512&userinfo.removeRights&&(n+=512),1024&userinfo.removeRights&&(n+=1024),16&userinfo.removeRights&&(o+=16),32768&userinfo.removeRights&&(o+=32768),131072&userinfo.removeRights&&(o+=131072),64&userinfo.removeRights&&(o+=64),262144&userinfo.removeRights&&(o+=262144),4294967295!=e?(e|=n,e&=4294967295-o):(e=2015471,e|=n,e&=4294967295-o),e}function GetMeshRights(e,t){if(null==e)return 0;if(null==t&&(t=userinfo._id),"string"==typeof e&&(e=meshes[e]),null==e||null==e.links)return 0;if(serverinfo.manageAllDeviceGroups&&t==userinfo._id)return removeUserRights(4294967295,t);var n=0,o=e.links[t];if(null!=o){if(4294967295==o.rights)return removeUserRights(4294967295,t);n=o.rights}var i=null;if(t==userinfo._id?i=userinfo:null!=users&&(i=users[t]),null!=i)for(var a in i.links)if(a.startsWith("ugrp/")&&null!=(o=e.links[a])){if(4294967295==o.rights)return removeUserRights(4294967295,t);n|=o.rights}return removeUserRights(n,t)}function IsMeshViewable(e,t){if(null==e)return!1;if(null==t&&(t=userinfo._id),"string"==typeof e&&(e=meshes[e]),null==e||null==e.links)return!1;if(null!=e.links[t])return!0;if(serverinfo.manageAllDeviceGroups&&t==userinfo._id)return!0;var n=null;if(t==userinfo._id?n=userinfo:null!=users&&(n=users[t]),null!=n)for(var o in n.links)if(o.startsWith("ugrp/")&&null!=e.links[o])return!0;return!1}function GetNodeRights(e,t){if(null==e)return 0;if(null==t&&(t=userinfo._id),"string"==typeof e&&null==(e=getNodeFromId(e)))return 0;var n=GetMeshRights(e.meshid,t);if(4294967295==n)return removeUserRights(n,t);if(null!=e.links&&null!=e.links[t]&&(n|=e.links[t].rights),null!=e.links&&null!=userinfo.links)for(var o in e.links)o.startsWith("ugrp/")&&null!=userinfo.links[o]&&null!=e.links[o].rights&&(n|=e.links[o].rights);return removeUserRights(n,t)}function IsNodeViewable(e,t){if(null==e)return!1;if(null==t&&(t=userinfo._id),"string"==typeof e&&null==(e=getNodeFromId(e)))return!1;if(IsMeshViewable(e.meshid,t))return!0;if(null!=e.links&&null!=e.links[t])return!0;if(null!=e.links&&null!=userinfo.links)for(var n in e.links)if(n.startsWith("ugrp/")&&null!=userinfo.links[n]&&null!=e.links[n].rights)return!0;return!1}if("undefined"==typeof TextEncoder){window.TextEncoder=function(){},TextEncoder.prototype.encode=function(e){for(var t=e.length,n=-1,o="undefined"==typeof Uint8Array?new Array(1.5*t):new Uint8Array(3*t),i=0,a=0,s=0;s!==t;){if(i=e.charCodeAt(s),s+=1,i>=55296&&i<=56319){if(s===t){o[n+=1]=239,o[n+=1]=191,o[n+=1]=189;break}if(!((a=e.charCodeAt(s))>=56320&&a<=57343)){o[n+=1]=239,o[n+=1]=191,o[n+=1]=189;continue}if(s+=1,(i=1024*(i-55296)+a-56320+65536)>65535){o[n+=1]=240|i>>>18,o[n+=1]=128|i>>>12&63,o[n+=1]=128|i>>>6&63,o[n+=1]=128|63&i;continue}}i<=127?o[n+=1]=0|i:i<=2047?(o[n+=1]=192|i>>>6,o[n+=1]=128|63&i):(o[n+=1]=224|i>>>12,o[n+=1]=128|i>>>6&63,o[n+=1]=128|63&i)}return"undefined"!=typeof Uint8Array?o.subarray(0,n+1):(o.length=n+1,o)},TextEncoder.prototype.toString=function(){return"[object TextEncoder]"};try{Object.defineProperty(TextEncoder.prototype,"encoding",{get:function(){if(TextEncoder.prototype.isPrototypeOf(this))return"utf-8";throw TypeError("Illegal invocation")}})}catch(e){TextEncoder.prototype.encoding="utf-8"}"undefined"!=typeof Symbol&&(TextEncoder.prototype[Symbol.toStringTag]="TextEncoder")}function urlBase64ToUint8Array(e){for(var t=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),n=atob(t),o=new Uint8Array(n.length),i=0;i<n.length;++i)o[i]=n.charCodeAt(i);return o}function joinPaths(){var e=[];for(var t in arguments){var n=arguments[t];if(null!=n&&""!=n){for(;n.endsWith("/")||n.endsWith("\\");)n=n.substring(0,n.length-1);for(;n.startsWith("/")||n.startsWith("\\");)n=n.substring(1);e.push(n)}}return e.join("/")}function putstore(e,t){try{if("undefined"==typeof localStorage||localStorage.getItem(e)==t)return;null==t?localStorage.removeItem(e):localStorage.setItem(e,t)}catch(e){}if("_"!=e[0]){var n={};try{for(var o=0,i=localStorage.length;o<i;++o){var a=localStorage.key(o);"_"!=a[0]&&(n[a]=localStorage.getItem(a),"desktopsettings"!=a&&"stars"!=a&&"deskKeyShortcuts"!=a&&"deskStrings"!=a&&"cmdopt"!=a&&"string"==typeof n[a]&&n[a].length>64&&delete n[a])}}catch(e){}meshserver.send({action:"userWebState",state:JSON.stringify(n)})}}function stringToUtf8Blob(e){const t=(new TextEncoder).encode(e);var n=new Uint8Array(3+t.length);n[0]=239,n[1]=187,n[2]=191;for(var o=0;o<t.length;o++)n[o+3]=t[o];return new Blob([n],{type:"application/octet-stream"})}function stringToUtf8BlobNoHeader(e){return new Blob([(new TextEncoder).encode(e)],{type:"application/octet-stream"})}function multiTranslate(e){var t=e.indexOf("]|");return e.substring(t+2)}function getLang(){return null!=navigator.languages?navigator.languages[0]:navigator.language}function getNodeAmtVersion(e){if(null==e||null==e.intelamt||"string"!=typeof e.intelamt.ver)return 0;var t=e.intelamt.ver.split(".");return t.length<2?0:parseInt(t[0])+parseInt(t[1])/100}function getstore(e,t){try{if("undefined"==typeof localStorage)return t;var n=localStorage.getItem(e);return null==n||null==n?t:n}catch(e){return t}}function addLink(e,t){return'<span tabindex=0 role="button" onclick=\''+t+"' onkeypress=\"if (event.key=='Enter') {"+t+'} ">'+e+' <i class="fa-solid fa-pencil fa-xs"></i></span>'}function addLinkConditional(e,t,n){return n?addLink(e,t):e}function addKeyLink(e,t){return"<span tabindex=0 role=button onclick="+t+" onkeypress=\"if (event.key=='Enter') { "+t+' } ">'+e+' <i class="fa-solid fa-key"></i></span>'}function addKeyLinkConditional(e,t,n){return n?"<span title='"+t+"'>"+e+' <i class="fa-solid fa-key"></i></span>':e}function haltEvent(e){return e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),!1}function addOption(e,t,n){var o=document.createElement("option");o.text=t,o.value=n,Q(e).add(o)}function passwordcheck(e){return e.length>7&&/\d/.test(e)&&/[a-z]/.test(e)&&/[A-Z]/.test(e)&&/\W/.test(e)}function methodcheck(e){return!(!e||null==e||!e.Body||"SUCCESS"==e.Body.ReturnValueStr)&&(messagebox("Ошибка вызова",e.Header.Method+": "+e.Body.ReturnValueStr.replace("_"," ")),!0)}function TableStart(){return"<table cellpadding=0 cellspacing=0 style=width:100%;border-radius:8px><tr><td width=200px><p><td>"}function TableStart2(){return"<table cellpadding=0 cellspacing=0 style=width:100%;border-radius:8px><tr><td><p><td>"}function TableEntry(e,t){return"<tr><td><p>"+e+"<td>"+t}function FullTable(e,t){var n=TableStart();for(i in e)i&&e[i]&&(n+=TableEntry(i,e[i]));return n+TableEnd(t)}function TableEnd(e){return"<tr><td colspan=2><p>"+(e||"")+"</table>"}function AddButton(e,t){return'<input type=button value="'+e+'" onclick="'+t+'" style=margin:4px>'}function AddButton2(e,t){return'<input type=button value="'+e+'" onclick="'+t+'">'}function AddRefreshButton(e){return'<input type=button name=refreshbtn value=Refresh onclick="refreshButtons(false);'+e+'" style=margin:4px '+(0==refreshButtonsState?"disabled":"")+">"}function MoreStart(){return"<div id=idx_dlgMoreButtons3 style=display:none><hr>"}function MoreEnd(){return"</div>"}function MoreToggle(e){QV("idx_dlgMoreButtons1",!e),QV("idx_dlgMoreButtons2",e),QV("idx_dlgMoreButtons3",e)}function getSelectedOptions(e){for(var t,n=[],o=0,i=e.options.length;o<i;o++)(t=e.options[o]).selected&&n.push(t.value);return n}function getInstance(e,t){for(var n in e)if(e[n].InstanceID==t)return e[n];return null}function getItem(e,t,n){for(var o in e)if(e[o][t]==n)return e[o];return null}function guidToStr(e){return e.substring(6,8)+e.substring(4,6)+e.substring(2,4)+e.substring(0,2)+"-"+e.substring(10,12)+e.substring(8,10)+"-"+e.substring(14,16)+e.substring(12,14)+"-"+e.substring(16,20)+"-"+e.substring(20)}function getUrlVars(){for(var e,t=[],n=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),o=0;o<n.length;o++)(e=n[o].indexOf("="))>0&&(t[n[o].substring(0,e)]=n[o].substring(e+1,n[o].length));return t}function addHtmlValue(e,t,n=[]){return`<div class="row mb-1"><div class="${n[0]||"col col-md-2 col-lg-2"}"><b>${e}</b></div><div class="${n[1]||"col col-md-10 col-lg-10"}">${t}</div></div>`}function addHtmlFormFloating(e,t,n=[]){return`<div class="row mb-1"><div class="form-floating mb-3 ${n[0]||"col-md-12"}">${t}<label class="${n[1]||"ms-2"}">${e}</label></div></div>`}function addHtmlValue2(e,t){return"<div><div style=display:inline-block;float:right>"+t+"</div><div style=display:inline-block>"+e+"</div></div>"}function addHtmlValue3(e,t){return"<div><b>"+e+"</b></div><div style=margin-left:16px>"+t+"</div>"}function addHtmlValue4(e,t){return"<table style=width:100%><td style=width:120px>"+e+"<td style=text-align:right><b>"+t+"</b></table>"}function addHtmlValue5(e,t){return"<div style=padding:4px><div style=display:inline-block;float:right><b>"+t+"</b></div><div style=display:inline-block>"+e+"</div></div>"}function focusTextBox(e){setTimeout(function(){Q(e).selectionStart=Q(e).selectionEnd=65535,Q(e).focus()},0)}function validateEmail(e){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)}function isPrivateIP(e){return e.startsWith("10.")||e.startsWith("172.16.")||e.startsWith("192.168.")}function u2fSupported(){return window.u2f&&(navigator.userAgent.indexOf("Chrome/")>0||navigator.userAgent.indexOf("Firefox/")>0||navigator.userAgent.indexOf("Opera/")>0||navigator.userAgent.indexOf("Safari/")>0)}function findOne(e,t){return null!=e&&null!=t&&t.some(function(t){return e.indexOf(t)>=0})}function copyTextToClip(e){var t=document.createElement("DIV");t.textContent=e,document.body.appendChild(t),function(e){if(document.selection)(t=document.body.createTextRange()).moveToElementText(e),t.select();else if(window.getSelection){var t;(t=document.createRange()).selectNode(e),window.getSelection().removeAllRanges(),window.getSelection().addRange(t)}}(t),document.execCommand("copy"),t.remove()}function copyTextToClip2(e){var t=document.createElement("DIV");t.textContent=decodeURIComponent(e),document.body.appendChild(t),function(e){if(document.selection)(t=document.body.createTextRange()).moveToElementText(e),t.select();else if(window.getSelection){var t;(t=document.createRange()).selectNode(e),window.getSelection().removeAllRanges(),window.getSelection().addRange(t)}}(t),document.execCommand("copy"),t.remove()}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function printDate(e){return e.toLocaleDateString(args.locale)}function printTime(e){return e.toLocaleTimeString(args.locale)}function printDateTime(e){return e.toLocaleString(args.locale)}function printFlexDateTime(e){return printDate(new Date)==printDate(e)?printTime(e):printDateTime(e)}function addDetailItem(e,t,n,o=[]){return`<div class="row mb-1"><div class="${o[0]||"col-md-8"}"> ${nobreak(e)} </div><div class="${o[1]||"col-md-4 text-end"}"> ${t} </div></div>`}function format(e){var t=Array.prototype.slice.call(arguments,1);return e.replace(/{(\d+)}/g,function(e,n){return void 0!==t[n]?t[n]:e})}function addTextLink(e,t,n){var o=t.toLowerCase().indexOf(e.toLowerCase());return-1==o?t:t.substring(0,o)+'<a href="'+n+'">'+e+"</a>"+t.substring(o+e.length)}function getOrderedList(e,t){var n=[];for(var o in e)n.push(e[o]);return n.sort(function(e,n){var o=e[t].toLowerCase(),i=n[t].toLowerCase();return o>i?1:o<i?-1:0}),n}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function nobreak(e){return e.split(" ").join("&nbsp;")}function pad2(e){var t="00"+e;return t.substr(t.length-2)}function encodeURIComponentEx(e){return encodeURIComponent(e).replace(/'/g,"%27")}function getUserName(e){var t=e.split("/"),n=t[0]+"/"+t[1]+"/"+t[2],o="";if(4==t.length&&t[3].startsWith("guest:")&&(o=" - "+decode_utf8(atob(t[3].substring(6)))),users&&null!=users[n])return null!=users[n].realname?users[n].realname+o:users[n].name+o;if(currentNode&&currentNode.links&&currentNode.links[e]&&null!=currentNode.links[e].name)return currentNode.links[e].name+o;if(e==userinfo._id)return userinfo.name+o;if(nodes)for(var i in nodes)if(nodes[i].links)for(var a in nodes[i].links)if(nodes[i].links[a].name&&a==e)return nodes[i].links[a].name+o;if(meshes)for(var i in meshes)if(meshes[i].links)for(var a in meshes[i].links)if(meshes[i].links[a].name&&a==e)return meshes[i].links[a].name+o;return t[2]+o}function round(e,t){var n=Math.pow(10,t||0);return Math.round(e*n)/n}function safeNewWindow(e,t){var n=window.open(e,t,"noopener,noreferrer");n&&(n.opener=null)}function isWindowsNode(e){return 2==e.mtype&&null!=e.agent&&null!=e.agent.id&&[1,2,3,4,21,22,34,42,43].indexOf(e.agent.id)>=0}function downloadFile(e,t,n){var o=document.createElement("a");o.setAttribute("href",e),o.setAttribute("rel","noreferrer noopener"),o.setAttribute("target","fileDownloadFrame"),o.setAttribute("download",decodeURIComponent(t||"")),document.body.appendChild(o),o.click(),document.body.removeChild(o),n&&setDialogMode(0)}function dialogBoxDrag(){var e=Q("xxAddAgentModal"),t=0,n=0,o=0,i=0;function a(a){(a=a||window.event).preventDefault(),t=o-a.clientX,n=i-a.clientY,o=a.clientX,i=a.clientY,e.style.top=e.offsetTop-n+"px",e.style.left=e.offsetLeft-t+"px"}function s(){document.onmouseup=null,document.onmousemove=null}Q("dialogHeader").onmousedown=function(e){(e=e||window.event).preventDefault(),o=e.clientX,i=e.clientY,document.onmouseup=s,document.onmousemove=a}}window.addEventListener("beforeunload",function(e){(null!=desktop&&11==xxcurrentView||null!=terminal&&12==xxcurrentView)&&(e.preventDefault(),e.returnValue="")})</script>